<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 5.4.2">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&family=Arvo:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&family=JetBrains+Mono:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"scatteredream.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":true,"version":"8.23.0","exturl":false,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="scatteredream&#39;s blog">
<meta property="og:url" content="http://scatteredream.github.io/default/page/7/index.html">
<meta property="og:site_name" content="scatteredream&#39;s blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="ç¢æ¢¦">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://scatteredream.github.io/default/page/7/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"default/page/7/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>scatteredream's blog</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">scatteredream's blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="æœç´¢" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="æœç´¢..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ç¢æ¢¦"
      src="https://avatars.githubusercontent.com/u/62317679?s=400&v=4">
  <p class="site-author-name" itemprop="name">ç¢æ¢¦</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">77</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">125</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://scatteredream.github.io/2020/04/30/designing-pattern/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/62317679?s=400&v=4">
      <meta itemprop="name" content="ç¢æ¢¦">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="scatteredream's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | scatteredream's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/04/30/designing-pattern/" class="post-title-link" itemprop="url">è®¾è®¡æ¨¡å¼ä¹Ÿå¯ä»¥è¿™ä¹ˆç®€å•(è½¬è‡ªJavaDoop)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2020-04-30 00:00:00" itemprop="dateCreated datePublished" datetime="2020-04-30T00:00:00+08:00">2020-04-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-04-27 23:22:01" itemprop="dateModified" datetime="2025-04-27T23:22:01+08:00">2025-04-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">è®¾è®¡æ¨¡å¼</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Designing-Pattern"><a href="#Designing-Pattern" class="headerlink" title="Designing Pattern"></a>Designing Pattern</h1><p>ä¸€ç›´æƒ³å†™ä¸€ç¯‡ä»‹ç»è®¾è®¡æ¨¡å¼çš„æ–‡ç« ï¼Œè®©è¯»è€…å¯ä»¥å¾ˆå¿«çœ‹å®Œï¼Œè€Œä¸”ä¸€çœ‹å°±æ‡‚ï¼Œçœ‹æ‡‚å°±ä¼šç”¨ï¼ŒåŒæ—¶ä¸ä¼šå°†å„ä¸ªæ¨¡å¼ææ··ã€‚è‡ªè®¤ä¸ºæœ¬æ–‡è¿˜æ˜¯å†™å¾—ä¸é”™çš„ğŸ˜‚ğŸ˜‚ğŸ˜‚ï¼ŒèŠ±äº†ä¸å°‘å¿ƒæ€æ¥å†™è¿™æ–‡ç« å’Œåšå›¾ï¼ŒåŠ›æ±‚è®©è¯»è€…çœŸçš„èƒ½çœ‹ç€ç®€å•åŒæ—¶æœ‰æ‰€æ”¶è·ã€‚</p>
<p>è®¾è®¡æ¨¡å¼æ˜¯å¯¹å¤§å®¶å®é™…å·¥ä½œä¸­å†™çš„å„ç§ä»£ç è¿›è¡Œé«˜å±‚æ¬¡æŠ½è±¡çš„æ€»ç»“ï¼Œå…¶ä¸­æœ€å‡ºåçš„å½“å± <em>Gang of Four</em> (<em>GoF</em>) çš„åˆ†ç±»äº†ï¼Œä»–ä»¬å°†è®¾è®¡æ¨¡å¼åˆ†ç±»ä¸º 23 ç§ç»å…¸çš„æ¨¡å¼ï¼Œæ ¹æ®ç”¨é€”æˆ‘ä»¬åˆå¯ä»¥åˆ†ä¸ºä¸‰å¤§ç±»ï¼Œåˆ†åˆ«ä¸ºåˆ›å»ºå‹æ¨¡å¼ã€ç»“æ„å‹æ¨¡å¼å’Œè¡Œä¸ºå‹æ¨¡å¼ã€‚</p>
<p>æœ‰ä¸€äº›é‡è¦çš„è®¾è®¡åŸåˆ™åœ¨å¼€ç¯‡å’Œå¤§å®¶åˆ†äº«ä¸‹ï¼Œè¿™äº›åŸåˆ™å°†è´¯é€šå…¨æ–‡ï¼š</p>
<ol>
<li>é¢å‘æ¥å£ç¼–ç¨‹ï¼Œè€Œä¸æ˜¯é¢å‘å®ç°ã€‚è¿™ä¸ªå¾ˆé‡è¦ï¼Œä¹Ÿæ˜¯ä¼˜é›…çš„ã€å¯æ‰©å±•çš„ä»£ç çš„ç¬¬ä¸€æ­¥ï¼Œè¿™å°±ä¸éœ€è¦å¤šè¯´äº†å§ã€‚</li>
<li>èŒè´£å•ä¸€åŸåˆ™ã€‚æ¯ä¸ªç±»éƒ½åº”è¯¥åªæœ‰ä¸€ä¸ªå•ä¸€çš„åŠŸèƒ½ï¼Œå¹¶ä¸”è¯¥åŠŸèƒ½åº”è¯¥ç”±è¿™ä¸ªç±»å®Œå…¨å°è£…èµ·æ¥ã€‚</li>
<li>å¯¹ä¿®æ”¹å…³é—­ï¼Œå¯¹æ‰©å±•å¼€æ”¾ã€‚å¯¹ä¿®æ”¹å…³é—­æ˜¯è¯´ï¼Œæˆ‘ä»¬è¾›è¾›è‹¦è‹¦åŠ ç­å†™å‡ºæ¥çš„ä»£ç ï¼Œè¯¥å®ç°çš„åŠŸèƒ½å’Œè¯¥ä¿®å¤çš„ bug éƒ½å®Œæˆäº†ï¼Œåˆ«äººå¯ä¸èƒ½è¯´æ”¹å°±æ”¹ï¼›å¯¹æ‰©å±•å¼€æ”¾å°±æ¯”è¾ƒå¥½ç†è§£äº†ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨æˆ‘ä»¬å†™å¥½çš„ä»£ç åŸºç¡€ä¸Šï¼Œå¾ˆå®¹æ˜“å®ç°æ‰©å±•ã€‚</li>
</ol>
<p><strong>åˆ›å»ºå‹æ¨¡å¼æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯ä¼šæ¯”è¾ƒæ²¡æœ‰æ„æ€ï¼Œç»“æ„å‹å’Œè¡Œä¸ºå‹æ¯”è¾ƒæœ‰æ„æ€ã€‚</strong></p>
<h2 id="åˆ›å»ºå‹æ¨¡å¼"><a href="#åˆ›å»ºå‹æ¨¡å¼" class="headerlink" title="åˆ›å»ºå‹æ¨¡å¼"></a>åˆ›å»ºå‹æ¨¡å¼</h2><p>åˆ›å»ºå‹æ¨¡å¼çš„ä½œç”¨å°±æ˜¯åˆ›å»ºå¯¹è±¡ï¼Œè¯´åˆ°åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œæœ€ç†Ÿæ‚‰çš„å°±æ˜¯ new ä¸€ä¸ªå¯¹è±¡ï¼Œç„¶å set ç›¸å…³å±æ€§ã€‚ä½†æ˜¯ï¼Œåœ¨å¾ˆå¤šåœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ç»™å®¢æˆ·ç«¯æä¾›æ›´åŠ å‹å¥½çš„åˆ›å»ºå¯¹è±¡çš„æ–¹å¼ï¼Œå°¤å…¶æ˜¯é‚£ç§æˆ‘ä»¬å®šä¹‰äº†ç±»ï¼Œä½†æ˜¯éœ€è¦æä¾›ç»™å…¶ä»–å¼€å‘è€…ç”¨çš„æ—¶å€™ã€‚</p>
<h3 id="ç®€å•å·¥å‚æ¨¡å¼"><a href="#ç®€å•å·¥å‚æ¨¡å¼" class="headerlink" title="ç®€å•å·¥å‚æ¨¡å¼"></a>ç®€å•å·¥å‚æ¨¡å¼</h3><p>å’Œåå­—ä¸€æ ·ç®€å•ï¼Œéå¸¸ç®€å•ï¼Œç›´æ¥ä¸Šä»£ç å§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FoodFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Food <span class="title function_">makeFood</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (name.equals(<span class="string">&quot;noodle&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">Food</span> <span class="variable">noodle</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LanZhouNoodle</span>();</span><br><span class="line">            noodle.addSpicy(<span class="string">&quot;more&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> noodle;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.equals(<span class="string">&quot;chicken&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">Food</span> <span class="variable">chicken</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HuangMenChicken</span>();</span><br><span class="line">            chicken.addCondiment(<span class="string">&quot;potato&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> chicken;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>å…¶ä¸­ï¼ŒLanZhouNoodle å’Œ HuangMenChicken éƒ½ç»§æ‰¿è‡ª Foodã€‚</em></p>
<p>ç®€å•åœ°è¯´ï¼Œç®€å•å·¥å‚æ¨¡å¼é€šå¸¸å°±æ˜¯è¿™æ ·ï¼Œä¸€ä¸ªå·¥å‚ç±» XxxFactoryï¼Œé‡Œé¢æœ‰ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œæ ¹æ®æˆ‘ä»¬ä¸åŒçš„å‚æ•°ï¼Œè¿”å›ä¸åŒçš„æ´¾ç”Ÿè‡ªåŒä¸€ä¸ªçˆ¶ç±»ï¼ˆæˆ–å®ç°åŒä¸€æ¥å£ï¼‰çš„å®ä¾‹å¯¹è±¡ã€‚</p>
<blockquote>
<p>æˆ‘ä»¬å¼ºè°ƒ<strong>èŒè´£å•ä¸€</strong>åŸåˆ™ï¼Œä¸€ä¸ªç±»åªæä¾›ä¸€ç§åŠŸèƒ½ï¼ŒFoodFactory çš„åŠŸèƒ½å°±æ˜¯åªè¦è´Ÿè´£ç”Ÿäº§å„ç§ Foodã€‚</p>
</blockquote>
<h3 id="å·¥å‚æ¨¡å¼"><a href="#å·¥å‚æ¨¡å¼" class="headerlink" title="å·¥å‚æ¨¡å¼"></a>å·¥å‚æ¨¡å¼</h3><p>ç®€å•å·¥å‚æ¨¡å¼å¾ˆç®€å•ï¼Œå¦‚æœå®ƒèƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€è¦ï¼Œæˆ‘è§‰å¾—å°±ä¸è¦æŠ˜è…¾äº†ã€‚ä¹‹æ‰€ä»¥éœ€è¦å¼•å…¥å·¥å‚æ¨¡å¼ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬å¾€å¾€éœ€è¦ä½¿ç”¨ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„å·¥å‚ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">FoodFactory</span> &#123;</span><br><span class="line">    Food <span class="title function_">makeFood</span><span class="params">(String name)</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChineseFoodFactory</span> <span class="keyword">implements</span> <span class="title class_">FoodFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Food <span class="title function_">makeFood</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (name.equals(<span class="string">&quot;A&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ChineseFoodA</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.equals(<span class="string">&quot;B&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ChineseFoodB</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AmericanFoodFactory</span> <span class="keyword">implements</span> <span class="title class_">FoodFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Food <span class="title function_">makeFood</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (name.equals(<span class="string">&quot;A&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AmericanFoodA</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.equals(<span class="string">&quot;B&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AmericanFoodB</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼ŒChineseFoodAã€ChineseFoodBã€AmericanFoodAã€AmericanFoodB éƒ½æ´¾ç”Ÿè‡ª Foodã€‚</p>
<p>å®¢æˆ·ç«¯è°ƒç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">APP</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// å…ˆé€‰æ‹©ä¸€ä¸ªå…·ä½“çš„å·¥å‚</span></span><br><span class="line">        <span class="type">FoodFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChineseFoodFactory</span>();</span><br><span class="line">        <span class="comment">// ç”±ç¬¬ä¸€æ­¥çš„å·¥å‚äº§ç”Ÿå…·ä½“çš„å¯¹è±¡ï¼Œä¸åŒçš„å·¥å‚é€ å‡ºä¸ä¸€æ ·çš„å¯¹è±¡</span></span><br><span class="line">        <span class="type">Food</span> <span class="variable">food</span> <span class="operator">=</span> factory.makeFood(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è™½ç„¶éƒ½æ˜¯è°ƒç”¨ makeFood(â€œAâ€)  åˆ¶ä½œ A ç±»é£Ÿç‰©ï¼Œä½†æ˜¯ï¼Œä¸åŒçš„å·¥å‚ç”Ÿäº§å‡ºæ¥çš„å®Œå…¨ä¸ä¸€æ ·ã€‚</p>
<p>ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬éœ€è¦é€‰å–åˆé€‚çš„å·¥å‚ï¼Œç„¶åç¬¬äºŒæ­¥åŸºæœ¬ä¸Šå’Œç®€å•å·¥å‚ä¸€æ ·ã€‚</p>
<p><strong>æ ¸å¿ƒåœ¨äºï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç¬¬ä¸€æ­¥é€‰å¥½æˆ‘ä»¬éœ€è¦çš„å·¥å‚</strong>ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬æœ‰ LogFactory æ¥å£ï¼Œå®ç°ç±»æœ‰ FileLogFactory å’Œ KafkaLogFactoryï¼Œåˆ†åˆ«å¯¹åº”å°†æ—¥å¿—å†™å…¥æ–‡ä»¶å’Œå†™å…¥ Kafka ä¸­ï¼Œæ˜¾ç„¶ï¼Œæˆ‘ä»¬å®¢æˆ·ç«¯ç¬¬ä¸€æ­¥å°±éœ€è¦å†³å®šåˆ°åº•è¦å®ä¾‹åŒ– FileLogFactory è¿˜æ˜¯ KafkaLogFactoryï¼Œè¿™å°†å†³å®šä¹‹åçš„æ‰€æœ‰çš„æ“ä½œã€‚</p>
<p>è™½ç„¶ç®€å•ï¼Œä¸è¿‡æˆ‘ä¹ŸæŠŠæ‰€æœ‰çš„æ„ä»¶éƒ½ç”»åˆ°ä¸€å¼ å›¾ä¸Šï¼Œè¿™æ ·è¯»è€…çœ‹ç€æ¯”è¾ƒæ¸…æ™°ï¼š</p>
<p><img src="https://assets.javadoop.com/blogimages/design-pattern/factory-1.png" alt="factory-1"></p>
<h3 id="æŠ½è±¡å·¥å‚æ¨¡å¼"><a href="#æŠ½è±¡å·¥å‚æ¨¡å¼" class="headerlink" title="æŠ½è±¡å·¥å‚æ¨¡å¼"></a>æŠ½è±¡å·¥å‚æ¨¡å¼</h3><p>å½“æ¶‰åŠåˆ°<strong>äº§å“æ—</strong>çš„æ—¶å€™ï¼Œå°±éœ€è¦å¼•å…¥æŠ½è±¡å·¥å‚æ¨¡å¼äº†ã€‚</p>
<p>ä¸€ä¸ªç»å…¸çš„ä¾‹å­æ˜¯é€ ä¸€å°ç”µè„‘ã€‚æˆ‘ä»¬å…ˆä¸å¼•å…¥æŠ½è±¡å·¥å‚æ¨¡å¼ï¼Œçœ‹çœ‹æ€ä¹ˆå®ç°ã€‚</p>
<p>å› ä¸ºç”µè„‘æ˜¯ç”±è®¸å¤šçš„æ„ä»¶ç»„æˆçš„ï¼Œæˆ‘ä»¬å°† CPU å’Œä¸»æ¿è¿›è¡ŒæŠ½è±¡ï¼Œç„¶å CPU ç”± CPUFactory ç”Ÿäº§ï¼Œä¸»æ¿ç”± MainBoardFactory ç”Ÿäº§ï¼Œç„¶åï¼Œæˆ‘ä»¬å†å°† CPU å’Œä¸»æ¿æ­é…èµ·æ¥ç»„åˆåœ¨ä¸€èµ·ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://assets.javadoop.com/blogimages/design-pattern/abstract-factory-1.png" alt="factory-1"></p>
<p>è¿™ä¸ªæ—¶å€™çš„å®¢æˆ·ç«¯è°ƒç”¨æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¾—åˆ° Intel çš„ CPU</span></span><br><span class="line"><span class="type">CPUFactory</span> <span class="variable">cpuFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntelCPUFactory</span>();</span><br><span class="line"><span class="type">CPU</span> <span class="variable">cpu</span> <span class="operator">=</span> intelCPUFactory.makeCPU();</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¾—åˆ° AMD çš„ä¸»æ¿</span></span><br><span class="line"><span class="type">MainBoardFactory</span> <span class="variable">mainBoardFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AmdMainBoardFactory</span>();</span><br><span class="line"><span class="type">MainBoard</span> <span class="variable">mainBoard</span> <span class="operator">=</span> mainBoardFactory.make();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»„è£… CPU å’Œä¸»æ¿</span></span><br><span class="line"><span class="type">Computer</span> <span class="variable">computer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Computer</span>(cpu, mainBoard);</span><br></pre></td></tr></table></figure>

<p>å•ç‹¬çœ‹ CPU å·¥å‚å’Œä¸»æ¿å·¥å‚ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯å‰é¢æˆ‘ä»¬è¯´çš„<strong>å·¥å‚æ¨¡å¼</strong>ã€‚è¿™ç§æ–¹å¼ä¹Ÿå®¹æ˜“æ‰©å±•ï¼Œå› ä¸ºè¦ç»™ç”µè„‘åŠ ç¡¬ç›˜çš„è¯ï¼Œåªéœ€è¦åŠ ä¸€ä¸ª HardDiskFactory å’Œç›¸åº”çš„å®ç°å³å¯ï¼Œä¸éœ€è¦ä¿®æ”¹ç°æœ‰çš„å·¥å‚ã€‚</p>
<p>ä½†æ˜¯ï¼Œè¿™ç§æ–¹å¼æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯å¦‚æœ <strong>Intel å®¶äº§çš„ CPU å’Œ AMD äº§çš„ä¸»æ¿ä¸èƒ½å…¼å®¹ä½¿ç”¨</strong>ï¼Œé‚£ä¹ˆè¿™ä»£ç å°±å®¹æ˜“å‡ºé”™ï¼Œå› ä¸ºå®¢æˆ·ç«¯å¹¶ä¸çŸ¥é“å®ƒä»¬ä¸å…¼å®¹ï¼Œä¹Ÿå°±ä¼šé”™è¯¯åœ°å‡ºç°éšæ„ç»„åˆã€‚</p>
<p>ä¸‹é¢å°±æ˜¯æˆ‘ä»¬è¦è¯´çš„<strong>äº§å“æ—</strong>çš„æ¦‚å¿µï¼Œå®ƒä»£è¡¨äº†ç»„æˆæŸä¸ªäº§å“çš„ä¸€ç³»åˆ—é™„ä»¶çš„é›†åˆï¼š</p>
<p><img src="https://assets.javadoop.com/blogimages/design-pattern/abstract-factory-2.png" alt="abstract-factory-2"></p>
<p>å½“æ¶‰åŠåˆ°è¿™ç§äº§å“æ—çš„é—®é¢˜çš„æ—¶å€™ï¼Œå°±éœ€è¦æŠ½è±¡å·¥å‚æ¨¡å¼æ¥æ”¯æŒäº†ã€‚æˆ‘ä»¬ä¸å†å®šä¹‰ CPU å·¥å‚ã€ä¸»æ¿å·¥å‚ã€ç¡¬ç›˜å·¥å‚ã€æ˜¾ç¤ºå±å·¥å‚ç­‰ç­‰ï¼Œæˆ‘ä»¬ç›´æ¥å®šä¹‰ç”µè„‘å·¥å‚ï¼Œæ¯ä¸ªç”µè„‘å·¥å‚è´Ÿè´£ç”Ÿäº§æ‰€æœ‰çš„è®¾å¤‡ï¼Œè¿™æ ·èƒ½ä¿è¯è‚¯å®šä¸å­˜åœ¨å…¼å®¹é—®é¢˜ã€‚</p>
<p><img src="https://assets.javadoop.com/blogimages/design-pattern/abstract-factory-3.png" alt="abstract-factory-3"></p>
<p>è¿™ä¸ªæ—¶å€™ï¼Œå¯¹äºå®¢æˆ·ç«¯æ¥è¯´ï¼Œä¸å†éœ€è¦å•ç‹¬æŒ‘é€‰ CPUå‚å•†ã€ä¸»æ¿å‚å•†ã€ç¡¬ç›˜å‚å•†ç­‰ï¼Œç›´æ¥é€‰æ‹©ä¸€å®¶å“ç‰Œå·¥å‚ï¼Œå“ç‰Œå·¥å‚ä¼šè´Ÿè´£ç”Ÿäº§æ‰€æœ‰çš„ä¸œè¥¿ï¼Œè€Œä¸”èƒ½ä¿è¯è‚¯å®šæ˜¯å…¼å®¹å¯ç”¨çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// ç¬¬ä¸€æ­¥å°±è¦é€‰å®šä¸€ä¸ªâ€œå¤§å‚â€</span></span><br><span class="line">    <span class="type">ComputerFactory</span> <span class="variable">cf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AmdFactory</span>();</span><br><span class="line">    <span class="comment">// ä»è¿™ä¸ªå¤§å‚é€  CPU</span></span><br><span class="line">    <span class="type">CPU</span> <span class="variable">cpu</span> <span class="operator">=</span> cf.makeCPU();</span><br><span class="line">    <span class="comment">// ä»è¿™ä¸ªå¤§å‚é€ ä¸»æ¿</span></span><br><span class="line">    <span class="type">MainBoard</span> <span class="variable">board</span> <span class="operator">=</span> cf.makeMainBoard();</span><br><span class="line">  	<span class="comment">// ä»è¿™ä¸ªå¤§å‚é€ ç¡¬ç›˜</span></span><br><span class="line">  	<span class="type">HardDisk</span> <span class="variable">hardDisk</span> <span class="operator">=</span> cf.makeHardDisk();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// å°†åŒä¸€ä¸ªå‚å­å‡ºæ¥çš„ CPUã€ä¸»æ¿ã€ç¡¬ç›˜ç»„è£…åœ¨ä¸€èµ·</span></span><br><span class="line">    <span class="type">Computer</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Computer</span>(cpu, board, hardDisk);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“ç„¶ï¼ŒæŠ½è±¡å·¥å‚çš„é—®é¢˜ä¹Ÿæ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬è¦åŠ ä¸ªæ˜¾ç¤ºå™¨ï¼Œå°±éœ€è¦ä¿®æ”¹æ‰€æœ‰çš„å·¥å‚ï¼Œç»™æ‰€æœ‰çš„å·¥å‚éƒ½åŠ ä¸Šåˆ¶é€ æ˜¾ç¤ºå™¨çš„æ–¹æ³•ã€‚è¿™æœ‰ç‚¹è¿åäº†<strong>å¯¹ä¿®æ”¹å…³é—­ï¼Œå¯¹æ‰©å±•å¼€æ”¾</strong>è¿™ä¸ªè®¾è®¡åŸåˆ™ã€‚</p>
<h3 id="å•ä¾‹æ¨¡å¼"><a href="#å•ä¾‹æ¨¡å¼" class="headerlink" title="å•ä¾‹æ¨¡å¼"></a>å•ä¾‹æ¨¡å¼</h3><p>å•ä¾‹æ¨¡å¼ç”¨å¾—æœ€å¤šï¼Œé”™å¾—æœ€å¤šã€‚</p>
<p>é¥¿æ±‰æ¨¡å¼æœ€ç®€å•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line">    <span class="comment">// é¦–å…ˆï¼Œå°† new Singleton() å µæ­»</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton</span><span class="params">()</span> &#123;&#125;;</span><br><span class="line">    <span class="comment">// åˆ›å»ºç§æœ‰é™æ€å®ä¾‹ï¼Œæ„å‘³ç€è¿™ä¸ªç±»ç¬¬ä¸€æ¬¡ä½¿ç”¨çš„æ—¶å€™å°±ä¼šè¿›è¡Œåˆ›å»º</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Singleton</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Singleton</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// çå†™ä¸€ä¸ªé™æ€æ–¹æ³•ã€‚è¿™é‡Œæƒ³è¯´çš„æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬åªæ˜¯è¦è°ƒç”¨ Singleton.getDate(...)ï¼Œ</span></span><br><span class="line">    <span class="comment">// æœ¬æ¥æ˜¯ä¸æƒ³è¦ç”Ÿæˆ Singleton å®ä¾‹çš„ï¼Œä¸è¿‡æ²¡åŠæ³•ï¼Œå·²ç»ç”Ÿæˆäº†</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Date <span class="title function_">getDate</span><span class="params">(String mode)</span> &#123;<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Date</span>();&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å¾ˆå¤šäººéƒ½èƒ½è¯´å‡ºé¥¿æ±‰æ¨¡å¼çš„ç¼ºç‚¹ï¼Œå¯æ˜¯æˆ‘è§‰å¾—ç”Ÿäº§è¿‡ç¨‹ä¸­ï¼Œå¾ˆå°‘ç¢°åˆ°è¿™ç§æƒ…å†µï¼šä½ å®šä¹‰äº†ä¸€ä¸ªå•ä¾‹çš„ç±»ï¼Œä¸éœ€è¦å…¶å®ä¾‹ï¼Œå¯æ˜¯ä½ å´æŠŠä¸€ä¸ªæˆ–å‡ ä¸ªä½ ä¼šç”¨åˆ°çš„é™æ€æ–¹æ³•å¡åˆ°è¿™ä¸ªç±»ä¸­ã€‚</p>
</blockquote>
<p>é¥±æ±‰æ¨¡å¼æœ€å®¹æ˜“å‡ºé”™ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line">    <span class="comment">// é¦–å…ˆï¼Œä¹Ÿæ˜¯å…ˆå µæ­» new Singleton() è¿™æ¡è·¯</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">    <span class="comment">// å’Œé¥¿æ±‰æ¨¡å¼ç›¸æ¯”ï¼Œè¿™è¾¹ä¸éœ€è¦å…ˆå®ä¾‹åŒ–å‡ºæ¥ï¼Œæ³¨æ„è¿™é‡Œçš„ volatileï¼Œå®ƒæ˜¯å¿…é¡»çš„</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">Singleton</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// åŠ é”</span></span><br><span class="line">            <span class="keyword">synchronized</span> (Singleton.class) &#123;</span><br><span class="line">                <span class="comment">// è¿™ä¸€æ¬¡åˆ¤æ–­ä¹Ÿæ˜¯å¿…é¡»çš„ï¼Œä¸ç„¶ä¼šæœ‰å¹¶å‘é—®é¢˜</span></span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> <span class="title class_">Singleton</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>åŒé‡æ£€æŸ¥ï¼ŒæŒ‡çš„æ˜¯ä¸¤æ¬¡æ£€æŸ¥ instance æ˜¯å¦ä¸º nullã€‚</p>
<p>volatile åœ¨è¿™é‡Œæ˜¯éœ€è¦çš„ï¼Œå¸Œæœ›èƒ½å¼•èµ·è¯»è€…çš„å…³æ³¨ã€‚</p>
<p>å¾ˆå¤šäººä¸çŸ¥é“æ€ä¹ˆå†™ï¼Œç›´æ¥å°±åœ¨ getInstance() æ–¹æ³•ç­¾åä¸ŠåŠ ä¸Š synchronizedï¼Œè¿™å°±ä¸å¤šè¯´äº†ï¼Œæ€§èƒ½å¤ªå·®ã€‚</p>
</blockquote>
<p>åµŒå¥—ç±»æœ€ç»å…¸ï¼Œä»¥åå¤§å®¶å°±ç”¨å®ƒå§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Singleton3</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton3</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">    <span class="comment">// ä¸»è¦æ˜¯ä½¿ç”¨äº† åµŒå¥—ç±»å¯ä»¥è®¿é—®å¤–éƒ¨ç±»çš„é™æ€å±æ€§å’Œé™æ€æ–¹æ³• çš„ç‰¹æ€§</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Holder</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Singleton3</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Singleton3</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton3 <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Holder.instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨æ„ï¼Œå¾ˆå¤šäººéƒ½ä¼šæŠŠè¿™ä¸ª<strong>åµŒå¥—ç±»</strong>è¯´æˆæ˜¯<strong>é™æ€å†…éƒ¨ç±»</strong>ï¼Œä¸¥æ ¼åœ°è¯´ï¼Œå†…éƒ¨ç±»å’ŒåµŒå¥—ç±»æ˜¯ä¸ä¸€æ ·çš„ï¼Œå®ƒä»¬èƒ½è®¿é—®çš„å¤–éƒ¨ç±»æƒé™ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ã€‚</p>
</blockquote>
<p>æœ€åï¼Œæˆ‘ä»¬è¯´ä¸€ä¸‹æšä¸¾ï¼Œæšä¸¾å¾ˆç‰¹æ®Šï¼Œå®ƒåœ¨ç±»åŠ è½½çš„æ—¶å€™ä¼šåˆå§‹åŒ–é‡Œé¢çš„æ‰€æœ‰çš„å®ä¾‹ï¼Œè€Œä¸” JVM ä¿è¯äº†å®ƒä»¬ä¸ä¼šå†è¢«å®ä¾‹åŒ–ï¼Œæ‰€ä»¥å®ƒå¤©ç”Ÿå°±æ˜¯å•ä¾‹çš„ã€‚</p>
<p>è™½ç„¶æˆ‘ä»¬å¹³æ—¶å¾ˆå°‘çœ‹åˆ°ç”¨æšä¸¾æ¥å®ç°å•ä¾‹ï¼Œä½†æ˜¯åœ¨ RxJava çš„æºç ä¸­ï¼Œæœ‰å¾ˆå¤šåœ°æ–¹éƒ½ç”¨äº†æšä¸¾æ¥å®ç°å•ä¾‹ã€‚</p>
<h3 id="å»ºé€ è€…æ¨¡å¼"><a href="#å»ºé€ è€…æ¨¡å¼" class="headerlink" title="å»ºé€ è€…æ¨¡å¼"></a>å»ºé€ è€…æ¨¡å¼</h3><p>ç»å¸¸ç¢°è§çš„ XxxBuilder çš„ç±»ï¼Œé€šå¸¸éƒ½æ˜¯å»ºé€ è€…æ¨¡å¼çš„äº§ç‰©ã€‚å»ºé€ è€…æ¨¡å¼å…¶å®æœ‰å¾ˆå¤šçš„å˜ç§ï¼Œä½†æ˜¯å¯¹äºå®¢æˆ·ç«¯æ¥è¯´ï¼Œæˆ‘ä»¬çš„ä½¿ç”¨é€šå¸¸éƒ½æ˜¯ä¸€ä¸ªæ¨¡å¼çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Food</span> <span class="variable">food</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FoodBuilder</span>().a().b().c().build();</span><br><span class="line"><span class="type">Food</span> <span class="variable">food</span> <span class="operator">=</span> Food.builder().a().b().c().build();</span><br></pre></td></tr></table></figure>

<p>å¥—è·¯å°±æ˜¯å…ˆ new ä¸€ä¸ª Builderï¼Œç„¶åå¯ä»¥é“¾å¼åœ°è°ƒç”¨ä¸€å †æ–¹æ³•ï¼Œæœ€åå†è°ƒç”¨ä¸€æ¬¡ build() æ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦çš„å¯¹è±¡å°±æœ‰äº†ã€‚</p>
<p>æ¥ä¸€ä¸ªä¸­è§„ä¸­çŸ©çš„å»ºé€ è€…æ¨¡å¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="comment">// ä¸‹é¢æ˜¯â€œä¸€å †â€çš„å±æ€§</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String nickName;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„é€ æ–¹æ³•ç§æœ‰åŒ–ï¼Œä¸ç„¶å®¢æˆ·ç«¯å°±ä¼šç›´æ¥è°ƒç”¨æ„é€ æ–¹æ³•äº†</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">User</span><span class="params">(String name, String password, String nickName, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.password = password;</span><br><span class="line">        <span class="built_in">this</span>.nickName = nickName;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// é™æ€æ–¹æ³•ï¼Œç”¨äºç”Ÿæˆä¸€ä¸ª Builderï¼Œè¿™ä¸ªä¸ä¸€å®šè¦æœ‰ï¼Œä¸è¿‡å†™è¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¹ æƒ¯ï¼Œ</span></span><br><span class="line">    <span class="comment">// æœ‰äº›ä»£ç è¦æ±‚åˆ«äººå†™ new User.UserBuilder().a()...build() çœ‹ä¸Šå»å°±æ²¡é‚£ä¹ˆå¥½</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> UserBuilder <span class="title function_">builder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UserBuilder</span>();</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">UserBuilder</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸‹é¢æ˜¯å’Œ User ä¸€æ¨¡ä¸€æ ·çš„ä¸€å †å±æ€§</span></span><br><span class="line">        <span class="keyword">private</span> String  name;</span><br><span class="line">        <span class="keyword">private</span> String password;</span><br><span class="line">        <span class="keyword">private</span> String nickName;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">UserBuilder</span><span class="params">()</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é“¾å¼è°ƒç”¨è®¾ç½®å„ä¸ªå±æ€§å€¼ï¼Œè¿”å› thisï¼Œå³ UserBuilder</span></span><br><span class="line">        <span class="keyword">public</span> UserBuilder <span class="title function_">name</span><span class="params">(String name)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.name = name;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> UserBuilder <span class="title function_">password</span><span class="params">(String password)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.password = password;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> UserBuilder <span class="title function_">nickName</span><span class="params">(String nickName)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.nickName = nickName;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> UserBuilder <span class="title function_">age</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.age = age;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// build() æ–¹æ³•è´Ÿè´£å°† UserBuilder ä¸­è®¾ç½®å¥½çš„å±æ€§â€œå¤åˆ¶â€åˆ° User ä¸­ã€‚</span></span><br><span class="line">        <span class="comment">// å½“ç„¶ï¼Œå¯ä»¥åœ¨ â€œå¤åˆ¶â€ ä¹‹å‰åšç‚¹æ£€éªŒ</span></span><br><span class="line">        <span class="keyword">public</span> User <span class="title function_">build</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (name == <span class="literal">null</span> || password == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;ç”¨æˆ·åå’Œå¯†ç å¿…å¡«&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (age &lt;= <span class="number">0</span> || age &gt;= <span class="number">150</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;å¹´é¾„ä¸åˆæ³•&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// è¿˜å¯ä»¥åšèµ‹äºˆâ€é»˜è®¤å€¼â€œçš„åŠŸèƒ½</span></span><br><span class="line">          	<span class="keyword">if</span> (nickName == <span class="literal">null</span>) &#123;</span><br><span class="line">                nickName = name;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(name, password, nickName, age);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¸å¿ƒæ˜¯ï¼šå…ˆæŠŠæ‰€æœ‰çš„å±æ€§éƒ½è®¾ç½®ç»™ Builderï¼Œç„¶å build() æ–¹æ³•çš„æ—¶å€™ï¼Œå°†è¿™äº›å±æ€§<strong>å¤åˆ¶</strong>ç»™å®é™…äº§ç”Ÿçš„å¯¹è±¡ã€‚</p>
<p>çœ‹çœ‹å®¢æˆ·ç«¯çš„è°ƒç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">APP</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">d</span> <span class="operator">=</span> User.builder()</span><br><span class="line">                .name(<span class="string">&quot;foo&quot;</span>)</span><br><span class="line">                .password(<span class="string">&quot;pAss12345&quot;</span>)</span><br><span class="line">                .age(<span class="number">25</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯´å®è¯ï¼Œå»ºé€ è€…æ¨¡å¼çš„<strong>é“¾å¼</strong>å†™æ³•å¾ˆå¸å¼•äººï¼Œä½†æ˜¯ï¼Œå¤šå†™äº†å¾ˆå¤šâ€œæ— ç”¨â€çš„ builder çš„ä»£ç ï¼Œæ„Ÿè§‰è¿™ä¸ªæ¨¡å¼æ²¡ä»€ä¹ˆç”¨ã€‚ä¸è¿‡ï¼Œå½“å±æ€§å¾ˆå¤šï¼Œè€Œä¸”æœ‰äº›å¿…å¡«ï¼Œæœ‰äº›é€‰å¡«çš„æ—¶å€™ï¼Œè¿™ä¸ªæ¨¡å¼ä¼šä½¿ä»£ç æ¸…æ™°å¾ˆå¤šã€‚æˆ‘ä»¬å¯ä»¥åœ¨ <strong>Builder çš„æ„é€ æ–¹æ³•</strong>ä¸­å¼ºåˆ¶è®©è°ƒç”¨è€…æä¾›å¿…å¡«å­—æ®µï¼Œè¿˜æœ‰ï¼Œåœ¨ build() æ–¹æ³•ä¸­æ ¡éªŒå„ä¸ªå‚æ•°æ¯”åœ¨ User çš„æ„é€ æ–¹æ³•ä¸­æ ¡éªŒï¼Œä»£ç è¦ä¼˜é›…ä¸€äº›ã€‚</p>
<blockquote>
<p>é¢˜å¤–è¯ï¼Œå¼ºçƒˆå»ºè®®è¯»è€…ä½¿ç”¨ lombokï¼Œç”¨äº† lombok ä»¥åï¼Œä¸Šé¢çš„ä¸€å¤§å †ä»£ç ä¼šå˜æˆå¦‚ä¸‹è¿™æ ·:</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String  name;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String nickName;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ€ä¹ˆæ ·ï¼Œçœä¸‹æ¥çš„æ—¶é—´æ˜¯ä¸æ˜¯åˆå¯ä»¥å¹²ç‚¹åˆ«çš„äº†ã€‚</p>
</blockquote>
<p>å½“ç„¶ï¼Œå¦‚æœä½ åªæ˜¯æƒ³è¦é“¾å¼å†™æ³•ï¼Œä¸æƒ³è¦å»ºé€ è€…æ¨¡å¼ï¼Œæœ‰ä¸ªå¾ˆç®€å•çš„åŠæ³•ï¼ŒUser çš„ getter æ–¹æ³•ä¸å˜ï¼Œæ‰€æœ‰çš„ setter æ–¹æ³•éƒ½è®©å…¶ <strong>return this</strong> å°±å¯ä»¥äº†ï¼Œç„¶åå°±å¯ä»¥åƒä¸‹é¢è¿™æ ·è°ƒç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>().setName(<span class="string">&quot;&quot;</span>).setPassword(<span class="string">&quot;&quot;</span>).setAge(<span class="number">20</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å¾ˆå¤šäººæ˜¯è¿™ä¹ˆç”¨çš„ï¼Œä½†æ˜¯ç¬”è€…è§‰å¾—å…¶å®è¿™ç§å†™æ³•éå¸¸åœ°ä¸ä¼˜é›…ï¼Œä¸æ˜¯å¾ˆæ¨èä½¿ç”¨ã€‚</p>
</blockquote>
<h3 id="åŸå‹æ¨¡å¼"><a href="#åŸå‹æ¨¡å¼" class="headerlink" title="åŸå‹æ¨¡å¼"></a>åŸå‹æ¨¡å¼</h3><p>è¿™æ˜¯æˆ‘è¦è¯´çš„åˆ›å»ºå‹æ¨¡å¼çš„æœ€åä¸€ä¸ªè®¾è®¡æ¨¡å¼äº†ã€‚</p>
<p>åŸå‹æ¨¡å¼å¾ˆç®€å•ï¼šæœ‰ä¸€ä¸ªåŸå‹<strong>å®ä¾‹</strong>ï¼ŒåŸºäºè¿™ä¸ªåŸå‹å®ä¾‹äº§ç”Ÿæ–°çš„å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯â€œå…‹éš†â€äº†ã€‚</p>
<p>Object ç±»ä¸­æœ‰ä¸€ä¸ª clone() æ–¹æ³•ï¼Œå®ƒç”¨äºç”Ÿæˆä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œå½“ç„¶ï¼Œå¦‚æœæˆ‘ä»¬è¦è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œjava è¦æ±‚æˆ‘ä»¬çš„ç±»å¿…é¡»å…ˆ<strong>å®ç° Cloneable æ¥å£</strong>ï¼Œæ­¤æ¥å£æ²¡æœ‰å®šä¹‰ä»»ä½•æ–¹æ³•ï¼Œä½†æ˜¯ä¸è¿™ä¹ˆåšçš„è¯ï¼Œåœ¨ clone() çš„æ—¶å€™ï¼Œä¼šæŠ›å‡º CloneNotSupportedException å¼‚å¸¸ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">native</span> Object <span class="title function_">clone</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>java çš„å…‹éš†æ˜¯æµ…å…‹éš†ï¼Œç¢°åˆ°å¯¹è±¡å¼•ç”¨çš„æ—¶å€™ï¼Œå…‹éš†å‡ºæ¥çš„å¯¹è±¡å’ŒåŸå¯¹è±¡ä¸­çš„å¼•ç”¨å°†æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ã€‚é€šå¸¸å®ç°æ·±å…‹éš†çš„æ–¹æ³•æ˜¯å°†å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–ï¼Œç„¶åå†è¿›è¡Œååºåˆ—åŒ–ã€‚</p>
</blockquote>
<p>åŸå‹æ¨¡å¼äº†è§£åˆ°è¿™é‡Œæˆ‘è§‰å¾—å°±å¤Ÿäº†ï¼Œå„ç§å˜ç€æ³•å­è¯´è¿™ç§ä»£ç æˆ–é‚£ç§ä»£ç æ˜¯åŸå‹æ¨¡å¼ï¼Œæ²¡ä»€ä¹ˆæ„ä¹‰ã€‚</p>
<h3 id="åˆ›å»ºå‹æ¨¡å¼æ€»ç»“"><a href="#åˆ›å»ºå‹æ¨¡å¼æ€»ç»“" class="headerlink" title="åˆ›å»ºå‹æ¨¡å¼æ€»ç»“"></a>åˆ›å»ºå‹æ¨¡å¼æ€»ç»“</h3><p>åˆ›å»ºå‹æ¨¡å¼æ€»ä½“ä¸Šæ¯”è¾ƒç®€å•ï¼Œå®ƒä»¬çš„ä½œç”¨å°±æ˜¯ä¸ºäº†äº§ç”Ÿå®ä¾‹å¯¹è±¡ï¼Œç®—æ˜¯å„ç§å·¥ä½œçš„ç¬¬ä¸€æ­¥äº†ï¼Œå› ä¸ºæˆ‘ä»¬å†™çš„æ˜¯<strong>é¢å‘å¯¹è±¡</strong>çš„ä»£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬ç¬¬ä¸€æ­¥å½“ç„¶æ˜¯éœ€è¦åˆ›å»ºä¸€ä¸ªå¯¹è±¡äº†ã€‚</p>
<p>ç®€å•å·¥å‚æ¨¡å¼æœ€ç®€å•ï¼›å·¥å‚æ¨¡å¼åœ¨ç®€å•å·¥å‚æ¨¡å¼çš„åŸºç¡€ä¸Šå¢åŠ äº†é€‰æ‹©å·¥å‚çš„ç»´åº¦ï¼Œéœ€è¦ç¬¬ä¸€æ­¥é€‰æ‹©åˆé€‚çš„å·¥å‚ï¼›æŠ½è±¡å·¥å‚æ¨¡å¼æœ‰äº§å“æ—çš„æ¦‚å¿µï¼Œå¦‚æœå„ä¸ªäº§å“æ˜¯å­˜åœ¨å…¼å®¹æ€§é—®é¢˜çš„ï¼Œå°±è¦ç”¨æŠ½è±¡å·¥å‚æ¨¡å¼ã€‚å•ä¾‹æ¨¡å¼å°±ä¸è¯´äº†ï¼Œä¸ºäº†ä¿è¯å…¨å±€ä½¿ç”¨çš„æ˜¯åŒä¸€å¯¹è±¡ï¼Œä¸€æ–¹é¢æ˜¯å®‰å…¨æ€§è€ƒè™‘ï¼Œä¸€æ–¹é¢æ˜¯ä¸ºäº†èŠ‚çœèµ„æºï¼›å»ºé€ è€…æ¨¡å¼ä¸“é—¨å¯¹ä»˜å±æ€§å¾ˆå¤šçš„é‚£ç§ç±»ï¼Œä¸ºäº†è®©ä»£ç æ›´ä¼˜ç¾ï¼›åŸå‹æ¨¡å¼ç”¨å¾—æœ€å°‘ï¼Œäº†è§£å’Œ Object ç±»ä¸­çš„ clone() æ–¹æ³•ç›¸å…³çš„çŸ¥è¯†å³å¯ã€‚</p>
<h2 id="ç»“æ„å‹æ¨¡å¼"><a href="#ç»“æ„å‹æ¨¡å¼" class="headerlink" title="ç»“æ„å‹æ¨¡å¼"></a>ç»“æ„å‹æ¨¡å¼</h2><p>å‰é¢åˆ›å»ºå‹æ¨¡å¼ä»‹ç»äº†åˆ›å»ºå¯¹è±¡çš„ä¸€äº›è®¾è®¡æ¨¡å¼ï¼Œè¿™èŠ‚ä»‹ç»çš„ç»“æ„å‹æ¨¡å¼æ—¨åœ¨é€šè¿‡æ”¹å˜ä»£ç ç»“æ„æ¥è¾¾åˆ°è§£è€¦çš„ç›®çš„ï¼Œä½¿å¾—æˆ‘ä»¬çš„ä»£ç å®¹æ˜“ç»´æŠ¤å’Œæ‰©å±•ã€‚</p>
<h3 id="ä»£ç†æ¨¡å¼"><a href="#ä»£ç†æ¨¡å¼" class="headerlink" title="ä»£ç†æ¨¡å¼"></a>ä»£ç†æ¨¡å¼</h3><p>ç¬¬ä¸€ä¸ªè¦ä»‹ç»çš„ä»£ç†æ¨¡å¼æ˜¯æœ€å¸¸ä½¿ç”¨çš„æ¨¡å¼ä¹‹ä¸€äº†ï¼Œç”¨ä¸€ä¸ªä»£ç†æ¥éšè—å…·ä½“å®ç°ç±»çš„å®ç°ç»†èŠ‚ï¼Œé€šå¸¸è¿˜ç”¨äºåœ¨çœŸå®çš„å®ç°çš„å‰åæ·»åŠ ä¸€éƒ¨åˆ†é€»è¾‘ã€‚</p>
<p>æ—¢ç„¶è¯´æ˜¯<strong>ä»£ç†</strong>ï¼Œé‚£å°±è¦å¯¹å®¢æˆ·ç«¯éšè—çœŸå®å®ç°ï¼Œç”±ä»£ç†æ¥è´Ÿè´£å®¢æˆ·ç«¯çš„æ‰€æœ‰è¯·æ±‚ã€‚å½“ç„¶ï¼Œä»£ç†åªæ˜¯ä¸ªä»£ç†ï¼Œå®ƒä¸ä¼šå®Œæˆå®é™…çš„ä¸šåŠ¡é€»è¾‘ï¼Œè€Œæ˜¯ä¸€å±‚çš®è€Œå·²ï¼Œä½†æ˜¯å¯¹äºå®¢æˆ·ç«¯æ¥è¯´ï¼Œå®ƒå¿…é¡»è¡¨ç°å¾—å°±æ˜¯å®¢æˆ·ç«¯éœ€è¦çš„çœŸå®å®ç°ã€‚</p>
<blockquote>
<p>ç†è§£<strong>ä»£ç†</strong>è¿™ä¸ªè¯ï¼Œè¿™ä¸ªæ¨¡å¼å…¶å®å°±ç®€å•äº†ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">FoodService</span> &#123;</span><br><span class="line">    Food <span class="title function_">makeChicken</span><span class="params">()</span>;</span><br><span class="line">    Food <span class="title function_">makeNoodle</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FoodServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">FoodService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Food <span class="title function_">makeChicken</span><span class="params">()</span> &#123;</span><br><span class="line">      	<span class="type">Food</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chicken</span>()</span><br><span class="line">        f.setChicken(<span class="string">&quot;1kg&quot;</span>);</span><br><span class="line">      	f.setSpicy(<span class="string">&quot;1g&quot;</span>);</span><br><span class="line">      	f.setSalt(<span class="string">&quot;3g&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> f;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Food <span class="title function_">makeNoodle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Food</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Noodle</span>();</span><br><span class="line">        f.setNoodle(<span class="string">&quot;500g&quot;</span>);</span><br><span class="line">        f.setSalt(<span class="string">&quot;5g&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> f;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»£ç†è¦è¡¨ç°å¾—â€œå°±åƒæ˜¯â€çœŸå®å®ç°ç±»ï¼Œæ‰€ä»¥éœ€è¦å®ç° FoodService</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FoodServiceProxy</span> <span class="keyword">implements</span> <span class="title class_">FoodService</span> &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// å†…éƒ¨ä¸€å®šè¦æœ‰ä¸€ä¸ªçœŸå®çš„å®ç°ç±»ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡æ„é€ æ–¹æ³•æ³¨å…¥</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">FoodService</span> <span class="variable">foodService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FoodServiceImpl</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Food <span class="title function_">makeChicken</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æˆ‘ä»¬é©¬ä¸Šè¦å¼€å§‹åˆ¶ä½œé¸¡è‚‰äº†&quot;</span>);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// å¦‚æœæˆ‘ä»¬å®šä¹‰è¿™å¥ä¸ºæ ¸å¿ƒä»£ç çš„è¯ï¼Œé‚£ä¹ˆï¼Œæ ¸å¿ƒä»£ç æ˜¯çœŸå®å®ç°ç±»åšçš„ï¼Œ</span></span><br><span class="line">        <span class="comment">// ä»£ç†åªæ˜¯åœ¨æ ¸å¿ƒä»£ç å‰ååšäº›â€œæ— è¶³è½»é‡â€çš„äº‹æƒ…</span></span><br><span class="line">        <span class="type">Food</span> <span class="variable">food</span> <span class="operator">=</span> foodService.makeChicken();</span><br><span class="line">      </span><br><span class="line">        System.out.println(<span class="string">&quot;é¸¡è‚‰åˆ¶ä½œå®Œæˆå•¦ï¼ŒåŠ ç‚¹èƒ¡æ¤’ç²‰&quot;</span>); <span class="comment">// å¢å¼º</span></span><br><span class="line">      	food.addCondiment(<span class="string">&quot;pepper&quot;</span>);</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">return</span> food;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Food <span class="title function_">makeNoodle</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å‡†å¤‡åˆ¶ä½œæ‹‰é¢~&quot;</span>);</span><br><span class="line">        <span class="type">Food</span> <span class="variable">food</span> <span class="operator">=</span> foodService.makeNoodle();</span><br><span class="line">        System.out.println(<span class="string">&quot;åˆ¶ä½œå®Œæˆå•¦&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> food;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®¢æˆ·ç«¯è°ƒç”¨ï¼Œæ³¨æ„ï¼Œæˆ‘ä»¬è¦ç”¨ä»£ç†æ¥å®ä¾‹åŒ–æ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™é‡Œç”¨ä»£ç†ç±»æ¥å®ä¾‹åŒ–</span></span><br><span class="line"><span class="type">FoodService</span> <span class="variable">foodService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FoodServiceProxy</span>();</span><br><span class="line">foodService.makeChicken();</span><br></pre></td></tr></table></figure>

<p><img src="https://assets.javadoop.com/blogimages/design-pattern/proxy-1.png" alt="proxy"></p>
<p>æˆ‘ä»¬å‘ç°æ²¡æœ‰ï¼Œä»£ç†æ¨¡å¼è¯´ç™½äº†å°±æ˜¯åš <strong>â€œæ–¹æ³•åŒ…è£…â€</strong> æˆ–åš <strong>â€œæ–¹æ³•å¢å¼ºâ€</strong>ã€‚åœ¨é¢å‘åˆ‡é¢ç¼–ç¨‹ä¸­ï¼Œå…¶å®å°±æ˜¯åŠ¨æ€ä»£ç†çš„è¿‡ç¨‹ã€‚æ¯”å¦‚ Spring ä¸­ï¼Œæˆ‘ä»¬è‡ªå·±ä¸å®šä¹‰ä»£ç†ç±»ï¼Œä½†æ˜¯ Spring ä¼šå¸®æˆ‘ä»¬åŠ¨æ€æ¥å®šä¹‰ä»£ç†ï¼Œç„¶åæŠŠæˆ‘ä»¬å®šä¹‰åœ¨ @Beforeã€@Afterã€@Around ä¸­çš„ä»£ç é€»è¾‘åŠ¨æ€æ·»åŠ åˆ°ä»£ç†ä¸­ã€‚</p>
<p>è¯´åˆ°åŠ¨æ€ä»£ç†ï¼Œåˆå¯ä»¥å±•å¼€è¯´ï¼ŒSpring ä¸­å®ç°åŠ¨æ€ä»£ç†æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯å¦‚æœæˆ‘ä»¬çš„ç±»å®šä¹‰äº†æ¥å£ï¼Œå¦‚ UserService æ¥å£å’Œ UserServiceImpl å®ç°ï¼Œé‚£ä¹ˆé‡‡ç”¨ JDK çš„åŠ¨æ€ä»£ç†ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥å»çœ‹çœ‹ java.lang.reflect.Proxy ç±»çš„æºç ï¼›å¦ä¸€ç§æ˜¯æˆ‘ä»¬è‡ªå·±æ²¡æœ‰å®šä¹‰æ¥å£çš„ï¼ŒSpring ä¼šé‡‡ç”¨ CGLIB è¿›è¡ŒåŠ¨æ€ä»£ç†ï¼Œå®ƒæ˜¯ä¸€ä¸ª jar åŒ…ï¼Œæ€§èƒ½è¿˜ä¸é”™ã€‚</p>
<h3 id="é€‚é…å™¨æ¨¡å¼"><a href="#é€‚é…å™¨æ¨¡å¼" class="headerlink" title="é€‚é…å™¨æ¨¡å¼"></a>é€‚é…å™¨æ¨¡å¼</h3><p>è¯´å®Œä»£ç†æ¨¡å¼ï¼Œè¯´é€‚é…å™¨æ¨¡å¼ï¼Œæ˜¯å› ä¸ºå®ƒä»¬å¾ˆç›¸ä¼¼ï¼Œè¿™é‡Œå¯ä»¥åšä¸ªæ¯”è¾ƒã€‚</p>
<p>é€‚é…å™¨æ¨¡å¼åšçš„å°±æ˜¯ï¼Œæœ‰ä¸€ä¸ªæ¥å£éœ€è¦å®ç°ï¼Œä½†æ˜¯æˆ‘ä»¬ç°æˆçš„å¯¹è±¡éƒ½ä¸æ»¡è¶³ï¼Œéœ€è¦åŠ ä¸€å±‚é€‚é…å™¨æ¥è¿›è¡Œé€‚é…ã€‚</p>
<p>é€‚é…å™¨æ¨¡å¼æ€»ä½“æ¥è¯´åˆ†ä¸‰ç§ï¼šé»˜è®¤é€‚é…å™¨æ¨¡å¼ã€å¯¹è±¡é€‚é…å™¨æ¨¡å¼ã€ç±»é€‚é…å™¨æ¨¡å¼ã€‚å…ˆä¸æ€¥ç€åˆ†æ¸…æ¥šè¿™å‡ ä¸ªï¼Œå…ˆçœ‹çœ‹ä¾‹å­å†è¯´ã€‚</p>
<h4 id="é»˜è®¤é€‚é…å™¨æ¨¡å¼"><a href="#é»˜è®¤é€‚é…å™¨æ¨¡å¼" class="headerlink" title="é»˜è®¤é€‚é…å™¨æ¨¡å¼"></a>é»˜è®¤é€‚é…å™¨æ¨¡å¼</h4><p>é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹æœ€ç®€å•çš„é€‚é…å™¨æ¨¡å¼**é»˜è®¤é€‚é…å™¨æ¨¡å¼(Default Adapter)**æ˜¯æ€ä¹ˆæ ·çš„ã€‚</p>
<p>æˆ‘ä»¬ç”¨ Appache commons-io åŒ…ä¸­çš„ FileAlterationListener åšä¾‹å­ï¼Œæ­¤æ¥å£å®šä¹‰äº†å¾ˆå¤šçš„æ–¹æ³•ï¼Œç”¨äºå¯¹æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹è¿›è¡Œç›‘æ§ï¼Œä¸€æ—¦å‘ç”Ÿäº†å¯¹åº”çš„æ“ä½œï¼Œå°±ä¼šè§¦å‘ç›¸åº”çš„æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">FileAlterationListener</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onStart</span><span class="params">(<span class="keyword">final</span> FileAlterationObserver observer)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onDirectoryCreate</span><span class="params">(<span class="keyword">final</span> File directory)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onDirectoryChange</span><span class="params">(<span class="keyword">final</span> File directory)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onDirectoryDelete</span><span class="params">(<span class="keyword">final</span> File directory)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onFileCreate</span><span class="params">(<span class="keyword">final</span> File file)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onFileChange</span><span class="params">(<span class="keyword">final</span> File file)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onFileDelete</span><span class="params">(<span class="keyword">final</span> File file)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onStop</span><span class="params">(<span class="keyword">final</span> FileAlterationObserver observer)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤æ¥å£çš„ä¸€å¤§é—®é¢˜æ˜¯æŠ½è±¡æ–¹æ³•å¤ªå¤šäº†ï¼Œå¦‚æœæˆ‘ä»¬è¦ç”¨è¿™ä¸ªæ¥å£ï¼Œæ„å‘³ç€æˆ‘ä»¬è¦å®ç°æ¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå¦‚æœæˆ‘ä»¬åªæ˜¯æƒ³è¦ç›‘æ§æ–‡ä»¶å¤¹ä¸­çš„<strong>æ–‡ä»¶åˆ›å»º</strong>å’Œ<strong>æ–‡ä»¶åˆ é™¤</strong>äº‹ä»¶ï¼Œå¯æ˜¯æˆ‘ä»¬è¿˜æ˜¯ä¸å¾—ä¸å®ç°æ‰€æœ‰çš„æ–¹æ³•ï¼Œå¾ˆæ˜æ˜¾ï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚</p>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦ä¸‹é¢çš„ä¸€ä¸ª<strong>é€‚é…å™¨</strong>ï¼Œå®ƒç”¨äºå®ç°ä¸Šé¢çš„æ¥å£ï¼Œä½†æ˜¯<strong>æ‰€æœ‰çš„æ–¹æ³•éƒ½æ˜¯ç©ºæ–¹æ³•</strong>ï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥è½¬è€Œå®šä¹‰è‡ªå·±çš„ç±»æ¥ç»§æ‰¿ä¸‹é¢è¿™ä¸ªç±»å³å¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileAlterationListenerAdaptor</span> <span class="keyword">implements</span> <span class="title class_">FileAlterationListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStart</span><span class="params">(<span class="keyword">final</span> FileAlterationObserver observer)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onDirectoryCreate</span><span class="params">(<span class="keyword">final</span> File directory)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onDirectoryChange</span><span class="params">(<span class="keyword">final</span> File directory)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onDirectoryDelete</span><span class="params">(<span class="keyword">final</span> File directory)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFileCreate</span><span class="params">(<span class="keyword">final</span> File file)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFileChange</span><span class="params">(<span class="keyword">final</span> File file)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFileDelete</span><span class="params">(<span class="keyword">final</span> File file)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStop</span><span class="params">(<span class="keyword">final</span> FileAlterationObserver observer)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¯”å¦‚æˆ‘ä»¬å¯ä»¥å®šä¹‰ä»¥ä¸‹ç±»ï¼Œæˆ‘ä»¬ä»…ä»…éœ€è¦å®ç°æˆ‘ä»¬æƒ³å®ç°çš„æ–¹æ³•å°±å¯ä»¥äº†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileMonitor</span> <span class="keyword">extends</span> <span class="title class_">FileAlterationListenerAdaptor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFileCreate</span><span class="params">(<span class="keyword">final</span> File file)</span> &#123;</span><br><span class="line">        <span class="comment">// æ–‡ä»¶åˆ›å»º</span></span><br><span class="line">        doSomething();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFileDelete</span><span class="params">(<span class="keyword">final</span> File file)</span> &#123;</span><br><span class="line">        <span class="comment">// æ–‡ä»¶åˆ é™¤</span></span><br><span class="line">        doSomething();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“ç„¶ï¼Œä¸Šé¢è¯´çš„åªæ˜¯é€‚é…å™¨æ¨¡å¼çš„å…¶ä¸­ä¸€ç§ï¼Œä¹Ÿæ˜¯æœ€ç®€å•çš„ä¸€ç§ï¼Œæ— éœ€å¤šè¨€ã€‚ä¸‹é¢ï¼Œå†ä»‹ç»<strong>â€œæ­£ç»Ÿçš„â€</strong>é€‚é…å™¨æ¨¡å¼ã€‚</p>
<h4 id="å¯¹è±¡é€‚é…å™¨æ¨¡å¼"><a href="#å¯¹è±¡é€‚é…å™¨æ¨¡å¼" class="headerlink" title="å¯¹è±¡é€‚é…å™¨æ¨¡å¼"></a>å¯¹è±¡é€‚é…å™¨æ¨¡å¼</h4><p>æ¥çœ‹ä¸€ä¸ªã€ŠHead First è®¾è®¡æ¨¡å¼ã€‹ä¸­çš„ä¸€ä¸ªä¾‹å­ï¼Œæˆ‘ç¨å¾®ä¿®æ”¹äº†ä¸€ä¸‹ï¼Œçœ‹çœ‹æ€ä¹ˆå°†é¸¡é€‚é…æˆé¸­ï¼Œè¿™æ ·é¸¡ä¹Ÿèƒ½å½“é¸­æ¥ç”¨ã€‚å› ä¸ºï¼Œç°åœ¨é¸­è¿™ä¸ªæ¥å£ï¼Œæˆ‘ä»¬æ²¡æœ‰åˆé€‚çš„å®ç°ç±»å¯ä»¥ç”¨ï¼Œæ‰€ä»¥éœ€è¦é€‚é…å™¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Duck</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">quack</span><span class="params">()</span>; <span class="comment">// é¸­çš„å‘±å‘±å«</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fly</span><span class="params">()</span>; <span class="comment">// é£</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Cock</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">gobble</span><span class="params">()</span>; <span class="comment">// é¸¡çš„å’•å’•å«</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fly</span><span class="params">()</span>; <span class="comment">// é£</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WildCock</span> <span class="keyword">implements</span> <span class="title class_">Cock</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">gobble</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å’•å’•å«&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fly</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;é¸¡ä¹Ÿä¼šé£å“¦&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¸­æ¥å£æœ‰ fly() å’Œ quare() ä¸¤ä¸ªæ–¹æ³•ï¼Œé¸¡ Cock å¦‚æœè¦å†’å……é¸­ï¼Œfly() æ–¹æ³•æ˜¯ç°æˆçš„ï¼Œä½†æ˜¯é¸¡ä¸ä¼šé¸­çš„å‘±å‘±å«ï¼Œæ²¡æœ‰ quack() æ–¹æ³•ã€‚è¿™ä¸ªæ—¶å€™å°±éœ€è¦é€‚é…äº†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¯«æ— ç–‘é—®ï¼Œé¦–å…ˆï¼Œè¿™ä¸ªé€‚é…å™¨è‚¯å®šéœ€è¦ implements Duckï¼Œè¿™æ ·æ‰èƒ½å½“åšé¸­æ¥ç”¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CockAdapter</span> <span class="keyword">implements</span> <span class="title class_">Duck</span> &#123;</span><br><span class="line">  </span><br><span class="line">    Cock cock;</span><br><span class="line">    <span class="comment">// æ„é€ æ–¹æ³•ä¸­éœ€è¦ä¸€ä¸ªé¸¡çš„å®ä¾‹ï¼Œæ­¤ç±»å°±æ˜¯å°†è¿™åªé¸¡é€‚é…æˆé¸­æ¥ç”¨</span></span><br><span class="line">  	<span class="keyword">public</span> <span class="title function_">CockAdapter</span><span class="params">(Cock cock)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cock = cock;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// å®ç°é¸­çš„å‘±å‘±å«æ–¹æ³•</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">  	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">quack</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// å†…éƒ¨å…¶å®æ˜¯ä¸€åªé¸¡çš„å’•å’•å«</span></span><br><span class="line">        cock.gobble();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  	<span class="meta">@Override</span></span><br><span class="line">  	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fly</span><span class="params">()</span> &#123;</span><br><span class="line">        cock.fly();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®¢æˆ·ç«¯è°ƒç”¨å¾ˆç®€å•äº†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// æœ‰ä¸€åªé‡é¸¡</span></span><br><span class="line">  	<span class="type">Cock</span> <span class="variable">wildCock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WildCock</span>();</span><br><span class="line">  	<span class="comment">// æˆåŠŸå°†é‡é¸¡é€‚é…æˆé¸­</span></span><br><span class="line">  	<span class="type">Duck</span> <span class="variable">duck</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CockAdapter</span>(wildCock);</span><br><span class="line">  	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ°è¿™é‡Œï¼Œå¤§å®¶ä¹Ÿå°±çŸ¥é“äº†é€‚é…å™¨æ¨¡å¼æ˜¯æ€ä¹ˆå›äº‹äº†ã€‚æ— éæ˜¯æˆ‘ä»¬éœ€è¦ä¸€åªé¸­ï¼Œä½†æ˜¯æˆ‘ä»¬åªæœ‰ä¸€åªé¸¡ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦å®šä¹‰ä¸€ä¸ªé€‚é…å™¨ï¼Œç”±è¿™ä¸ªé€‚é…å™¨æ¥å……å½“é¸­ï¼Œä½†æ˜¯é€‚é…å™¨é‡Œé¢çš„æ–¹æ³•è¿˜æ˜¯ç”±é¸¡æ¥å®ç°çš„ã€‚</p>
<p>æˆ‘ä»¬ç”¨ä¸€ä¸ªå›¾æ¥ç®€å•è¯´æ˜ä¸‹ï¼š</p>
<p><img src="https://assets.javadoop.com/blogimages/design-pattern/adapter-1.png" alt="adapter-1"></p>
<p>ä¸Šå›¾åº”è¯¥è¿˜æ˜¯å¾ˆå®¹æ˜“ç†è§£çš„ï¼Œæˆ‘å°±ä¸åšæ›´å¤šçš„è§£é‡Šäº†ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬çœ‹çœ‹ç±»é€‚é…æ¨¡å¼æ€ä¹ˆæ ·çš„ã€‚</p>
<h4 id="ç±»é€‚é…å™¨æ¨¡å¼"><a href="#ç±»é€‚é…å™¨æ¨¡å¼" class="headerlink" title="ç±»é€‚é…å™¨æ¨¡å¼"></a>ç±»é€‚é…å™¨æ¨¡å¼</h4><p>åºŸè¯å°‘è¯´ï¼Œç›´æ¥ä¸Šå›¾ï¼š</p>
<p><img src="https://assets.javadoop.com/blogimages/design-pattern/adapter-2.png" alt="adapter-1"></p>
<p>çœ‹åˆ°è¿™ä¸ªå›¾ï¼Œå¤§å®¶åº”è¯¥å¾ˆå®¹æ˜“ç†è§£çš„å§ï¼Œé€šè¿‡ç»§æ‰¿çš„æ–¹æ³•ï¼Œé€‚é…å™¨è‡ªåŠ¨è·å¾—äº†æ‰€éœ€è¦çš„å¤§éƒ¨åˆ†æ–¹æ³•ã€‚è¿™ä¸ªæ—¶å€™ï¼Œå®¢æˆ·ç«¯ä½¿ç”¨æ›´åŠ ç®€å•ï¼Œç›´æ¥ <code>Target t = new SomeAdapter();</code> å°±å¯ä»¥äº†ã€‚</p>
<h4 id="é€‚é…å™¨æ¨¡å¼æ€»ç»“"><a href="#é€‚é…å™¨æ¨¡å¼æ€»ç»“" class="headerlink" title="é€‚é…å™¨æ¨¡å¼æ€»ç»“"></a>é€‚é…å™¨æ¨¡å¼æ€»ç»“</h4><ol>
<li><p>ç±»é€‚é…å’Œå¯¹è±¡é€‚é…çš„å¼‚åŒ</p>
<blockquote>
<p>ä¸€ä¸ªé‡‡ç”¨ç»§æ‰¿ï¼Œä¸€ä¸ªé‡‡ç”¨ç»„åˆï¼›</p>
<p>ç±»é€‚é…å±äºé™æ€å®ç°ï¼Œå¯¹è±¡é€‚é…å±äºç»„åˆçš„åŠ¨æ€å®ç°ï¼Œå¯¹è±¡é€‚é…éœ€è¦å¤šå®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ã€‚</p>
<p>æ€»ä½“æ¥è¯´ï¼Œå¯¹è±¡é€‚é…ç”¨å¾—æ¯”è¾ƒå¤šã€‚</p>
</blockquote>
</li>
<li><p>é€‚é…å™¨æ¨¡å¼å’Œä»£ç†æ¨¡å¼çš„å¼‚åŒ</p>
<p>æ¯”è¾ƒè¿™ä¸¤ç§æ¨¡å¼ï¼Œå…¶å®æ˜¯æ¯”è¾ƒå¯¹è±¡é€‚é…å™¨æ¨¡å¼å’Œä»£ç†æ¨¡å¼ï¼Œåœ¨ä»£ç ç»“æ„ä¸Šï¼Œå®ƒä»¬å¾ˆç›¸ä¼¼ï¼Œéƒ½éœ€è¦ä¸€ä¸ªå…·ä½“çš„å®ç°ç±»çš„å®ä¾‹ã€‚ä½†æ˜¯å®ƒä»¬çš„ç›®çš„ä¸ä¸€æ ·ï¼Œä»£ç†æ¨¡å¼åšçš„æ˜¯å¢å¼ºåŸæ–¹æ³•çš„æ´»ï¼›é€‚é…å™¨åšçš„æ˜¯é€‚é…çš„æ´»ï¼Œä¸ºçš„æ˜¯æä¾›â€œæŠŠé¸¡åŒ…è£…æˆé¸­ï¼Œç„¶åå½“åšé¸­æ¥ä½¿ç”¨â€ï¼Œè€Œé¸¡å’Œé¸­å®ƒä»¬ä¹‹é—´åŸæœ¬æ²¡æœ‰ç»§æ‰¿å…³ç³»ã€‚</p>
<p><img src="https://assets.javadoop.com/blogimages/design-pattern/adapter-5.png" alt="adapter-5"></p>
</li>
</ol>
<h3 id="æ¡¥æ¢æ¨¡å¼"><a href="#æ¡¥æ¢æ¨¡å¼" class="headerlink" title="æ¡¥æ¢æ¨¡å¼"></a>æ¡¥æ¢æ¨¡å¼</h3><p>ç†è§£æ¡¥æ¢æ¨¡å¼ï¼Œå…¶å®å°±æ˜¯ç†è§£ä»£ç æŠ½è±¡å’Œè§£è€¦ã€‚</p>
<p>æˆ‘ä»¬é¦–å…ˆéœ€è¦ä¸€ä¸ªæ¡¥æ¢ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®šä¹‰æä¾›çš„æ¥å£æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DrawAPI</span> &#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">draw</span><span class="params">(<span class="type">int</span> radius, <span class="type">int</span> x, <span class="type">int</span> y)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åæ˜¯ä¸€ç³»åˆ—å®ç°ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedPen</span> <span class="keyword">implements</span> <span class="title class_">DrawAPI</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">draw</span><span class="params">(<span class="type">int</span> radius, <span class="type">int</span> x, <span class="type">int</span> y)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ç”¨çº¢è‰²ç¬”ç”»å›¾ï¼Œradius:&quot;</span> + radius + <span class="string">&quot;, x:&quot;</span> + x + <span class="string">&quot;, y:&quot;</span> + y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreenPen</span> <span class="keyword">implements</span> <span class="title class_">DrawAPI</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">draw</span><span class="params">(<span class="type">int</span> radius, <span class="type">int</span> x, <span class="type">int</span> y)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ç”¨ç»¿è‰²ç¬”ç”»å›¾ï¼Œradius:&quot;</span> + radius + <span class="string">&quot;, x:&quot;</span> + x + <span class="string">&quot;, y:&quot;</span> + y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BluePen</span> <span class="keyword">implements</span> <span class="title class_">DrawAPI</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">draw</span><span class="params">(<span class="type">int</span> radius, <span class="type">int</span> x, <span class="type">int</span> y)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ç”¨è“è‰²ç¬”ç”»å›¾ï¼Œradius:&quot;</span> + radius + <span class="string">&quot;, x:&quot;</span> + x + <span class="string">&quot;, y:&quot;</span> + y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®šä¹‰ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæ­¤ç±»çš„å®ç°ç±»éƒ½éœ€è¦ä½¿ç”¨ DrawAPIï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Shape</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> DrawAPI drawAPI;</span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">Shape</span><span class="params">(DrawAPI drawAPI)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.drawAPI = drawAPI;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">draw</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®šä¹‰æŠ½è±¡ç±»çš„å­ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœ†å½¢</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Circle</span> <span class="keyword">extends</span> <span class="title class_">Shape</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> radius;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Circle</span><span class="params">(<span class="type">int</span> radius, DrawAPI drawAPI)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(drawAPI);</span><br><span class="line">        <span class="built_in">this</span>.radius = radius;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">draw</span><span class="params">()</span> &#123;</span><br><span class="line">        drawAPI.draw(radius, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// é•¿æ–¹å½¢</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Rectangle</span> <span class="keyword">extends</span> <span class="title class_">Shape</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> x;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> y;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Rectangle</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, DrawAPI drawAPI)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(drawAPI);</span><br><span class="line">        <span class="built_in">this</span>.x = x;</span><br><span class="line">        <span class="built_in">this</span>.y = y;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">draw</span><span class="params">()</span> &#123;</span><br><span class="line">        drawAPI.draw(<span class="number">0</span>, x, y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åï¼Œæˆ‘ä»¬æ¥çœ‹å®¢æˆ·ç«¯æ¼”ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Shape</span> <span class="variable">greenCircle</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Circle</span>(<span class="number">10</span>, <span class="keyword">new</span> <span class="title class_">GreenPen</span>());</span><br><span class="line">    <span class="type">Shape</span> <span class="variable">redRectangle</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Rectangle</span>(<span class="number">4</span>, <span class="number">8</span>, <span class="keyword">new</span> <span class="title class_">RedPen</span>());</span><br><span class="line">    greenCircle.draw();</span><br><span class="line">    redRectangle.draw();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯èƒ½å¤§å®¶çœ‹ä¸Šé¢ä¸€æ­¥æ­¥è¿˜ä¸æ˜¯ç‰¹åˆ«æ¸…æ™°ï¼Œæˆ‘æŠŠæ‰€æœ‰çš„ä¸œè¥¿æ•´åˆåˆ°ä¸€å¼ å›¾ä¸Šï¼š</p>
<p><img src="https://assets.javadoop.com/blogimages/design-pattern/bridge-1.png" alt="bridge-1"></p>
<p>è¿™å›å¤§å®¶åº”è¯¥å°±çŸ¥é“æŠ½è±¡åœ¨å“ªé‡Œï¼Œæ€ä¹ˆè§£è€¦äº†å§ã€‚æ¡¥æ¢æ¨¡å¼çš„ä¼˜ç‚¹ä¹Ÿæ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œå°±æ˜¯éå¸¸å®¹æ˜“è¿›è¡Œæ‰©å±•ã€‚</p>
<blockquote>
<p>æœ¬èŠ‚å¼•ç”¨äº†<a target="_blank" rel="noopener" href="https://www.tutorialspoint.com/design_pattern/bridge_pattern.htm">è¿™é‡Œ</a>çš„ä¾‹å­ï¼Œå¹¶å¯¹å…¶è¿›è¡Œäº†ä¿®æ”¹ã€‚</p>
</blockquote>
<h3 id="è£…é¥°æ¨¡å¼"><a href="#è£…é¥°æ¨¡å¼" class="headerlink" title="è£…é¥°æ¨¡å¼"></a>è£…é¥°æ¨¡å¼</h3><p>è¦æŠŠè£…é¥°æ¨¡å¼è¯´æ¸…æ¥šæ˜ç™½ï¼Œä¸æ˜¯ä»¶å®¹æ˜“çš„äº‹æƒ…ã€‚ä¹Ÿè®¸è¯»è€…çŸ¥é“ <strong>Java IO</strong> ä¸­çš„å‡ ä¸ªç±»æ˜¯å…¸å‹çš„è£…é¥°æ¨¡å¼çš„åº”ç”¨ï¼Œä½†æ˜¯è¯»è€…ä¸ä¸€å®šæ¸…æ¥šå…¶ä¸­çš„å…³ç³»ï¼Œä¹Ÿè®¸çœ‹å®Œå°±å¿˜äº†ï¼Œå¸Œæœ›çœ‹å®Œè¿™èŠ‚åï¼Œè¯»è€…å¯ä»¥å¯¹å…¶æœ‰æ›´æ·±çš„æ„Ÿæ‚Ÿã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸ªç®€å•çš„å›¾ï¼Œçœ‹è¿™ä¸ªå›¾çš„æ—¶å€™ï¼Œäº†è§£ä¸‹å±‚æ¬¡ç»“æ„å°±å¯ä»¥äº†ï¼š</p>
<p><img src="https://assets.javadoop.com/blogimages/design-pattern/decorator-1.png" alt="decorator-1"></p>
<p>æˆ‘ä»¬æ¥è¯´è¯´è£…é¥°æ¨¡å¼çš„å‡ºå‘ç‚¹ï¼Œä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ¥å£ <code>Component</code> å…¶å®å·²ç»æœ‰äº† <code>ConcreteComponentA</code> å’Œ <code>ConcreteComponentB</code> ä¸¤ä¸ªå®ç°ç±»äº†ï¼Œä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬è¦<strong>å¢å¼º</strong>è¿™ä¸¤ä¸ªå®ç°ç±»çš„è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥é‡‡ç”¨è£…é¥°æ¨¡å¼ï¼Œç”¨å…·ä½“çš„è£…é¥°å™¨æ¥<strong>è£…é¥°</strong>å®ç°ç±»ï¼Œä»¥è¾¾åˆ°å¢å¼ºçš„ç›®çš„ã€‚</p>
<blockquote>
<p>ä»åå­—æ¥ç®€å•è§£é‡Šä¸‹è£…é¥°å™¨ã€‚æ—¢ç„¶è¯´æ˜¯è£…é¥°ï¼Œé‚£ä¹ˆå¾€å¾€å°±æ˜¯<strong>æ·»åŠ å°åŠŸèƒ½</strong>è¿™ç§ï¼Œè€Œä¸”ï¼Œæˆ‘ä»¬è¦æ»¡è¶³å¯ä»¥æ·»åŠ å¤šä¸ªå°åŠŸèƒ½ã€‚æœ€ç®€å•çš„ï¼Œä»£ç†æ¨¡å¼å°±å¯ä»¥å®ç°åŠŸèƒ½çš„å¢å¼ºï¼Œä½†æ˜¯ä»£ç†ä¸å®¹æ˜“å®ç°å¤šä¸ªåŠŸèƒ½çš„å¢å¼ºï¼Œå½“ç„¶ä½ å¯ä»¥è¯´ç”¨ä»£ç†åŒ…è£…ä»£ç†çš„å¤šå±‚åŒ…è£…æ–¹å¼ï¼Œä½†æ˜¯é‚£æ ·çš„è¯ä»£ç å°±å¤æ‚äº†ã€‚</p>
</blockquote>
<p>é¦–å…ˆæ˜ç™½ä¸€äº›ç®€å•çš„æ¦‚å¿µï¼Œä»å›¾ä¸­æˆ‘ä»¬çœ‹åˆ°ï¼Œæ‰€æœ‰çš„å…·ä½“è£…é¥°è€…ä»¬ <strong>ConcreteDecorator</strong>* éƒ½å¯ä»¥ä½œä¸º Component æ¥ä½¿ç”¨ï¼Œå› ä¸ºå®ƒä»¬éƒ½å®ç°äº† Component ä¸­çš„æ‰€æœ‰æ¥å£ã€‚å®ƒä»¬å’Œ Component å®ç°ç±» ConcreteComponent* çš„åŒºåˆ«æ˜¯ï¼Œå®ƒä»¬åªæ˜¯è£…é¥°è€…ï¼Œèµ·<strong>è£…é¥°</strong>ä½œç”¨ï¼Œä¹Ÿå°±æ˜¯å³ä½¿å®ƒä»¬çœ‹ä¸Šå»ç‰›é€¼è½°è½°ï¼Œä½†æ˜¯å®ƒä»¬éƒ½åªæ˜¯åœ¨å…·ä½“çš„å®ç°ä¸­<strong>åŠ äº†å±‚çš®æ¥è£…é¥°</strong>è€Œå·²ã€‚</p>
<blockquote>
<p>æ³¨æ„è¿™æ®µè¯ä¸­æ··æ‚åœ¨å„ä¸ªåè¯ä¸­çš„ Component å’Œ Decoratorï¼Œåˆ«ææ··äº†ã€‚</p>
</blockquote>
<p>ä¸‹é¢æ¥çœ‹çœ‹ä¸€ä¸ªä¾‹å­ï¼Œå…ˆæŠŠè£…é¥°æ¨¡å¼å¼„æ¸…æ¥šï¼Œç„¶åå†ä»‹ç»ä¸‹ java io ä¸­çš„è£…é¥°æ¨¡å¼çš„åº”ç”¨ã€‚</p>
<p>æœ€è¿‘å¤§è¡—ä¸Šæµè¡Œèµ·æ¥äº†â€œå¿«ä¹æŸ æª¬â€ï¼Œæˆ‘ä»¬æŠŠå¿«ä¹æŸ æª¬çš„é¥®æ–™åˆ†ä¸ºä¸‰ç±»ï¼šçº¢èŒ¶ã€ç»¿èŒ¶ã€å’–å•¡ï¼Œåœ¨è¿™ä¸‰å¤§ç±»çš„åŸºç¡€ä¸Šï¼Œåˆå¢åŠ äº†è®¸å¤šçš„å£å‘³ï¼Œä»€ä¹ˆé‡‘æ¡”æŸ æª¬çº¢èŒ¶ã€é‡‘æ¡”æŸ æª¬çç ç»¿èŒ¶ã€èŠ’æœçº¢èŒ¶ã€èŠ’æœç»¿èŒ¶ã€èŠ’æœçç çº¢èŒ¶ã€çƒ¤çç çº¢èŒ¶ã€çƒ¤çç èŠ’æœç»¿èŒ¶ã€æ¤°é¦™èƒšèŠ½å’–å•¡ã€ç„¦ç³–å¯å¯å’–å•¡ç­‰ç­‰ï¼Œæ¯å®¶åº—éƒ½æœ‰å¾ˆé•¿çš„èœå•ï¼Œä½†æ˜¯ä»”ç»†çœ‹ä¸‹ï¼Œå…¶å®åŸæ–™ä¹Ÿæ²¡å‡ æ ·ï¼Œä½†æ˜¯å¯ä»¥æ­é…å‡ºå¾ˆå¤šç»„åˆï¼Œå¦‚æœé¡¾å®¢éœ€è¦ï¼Œå¾ˆå¤šæ²¡å‡ºç°åœ¨èœå•ä¸­çš„é¥®æ–™ä»–ä»¬ä¹Ÿæ˜¯å¯ä»¥åšçš„ã€‚</p>
<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œçº¢èŒ¶ã€ç»¿èŒ¶ã€å’–å•¡æ˜¯æœ€åŸºç¡€çš„é¥®æ–™ï¼Œå…¶ä»–çš„åƒé‡‘æ¡”æŸ æª¬ã€èŠ’æœã€çç ã€æ¤°æœã€ç„¦ç³–ç­‰éƒ½å±äºè£…é¥°ç”¨çš„ã€‚å½“ç„¶ï¼Œåœ¨å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç¡®å®å¯ä»¥åƒé—¨åº—ä¸€æ ·ï¼Œå¼€å‘è¿™äº›ç±»ï¼šLemonBlackTeaã€LemonGreenTeaã€MangoBlackTeaã€MangoLemonGreenTeaâ€¦â€¦ä½†æ˜¯ï¼Œå¾ˆå¿«æˆ‘ä»¬å°±å‘ç°ï¼Œè¿™æ ·å­å¹²è‚¯å®šæ˜¯ä¸è¡Œçš„ï¼Œè¿™ä¼šå¯¼è‡´æˆ‘ä»¬éœ€è¦ç»„åˆå‡ºæ‰€æœ‰çš„å¯èƒ½ï¼Œè€Œä¸”å¦‚æœå®¢äººéœ€è¦åœ¨çº¢èŒ¶ä¸­åŠ åŒä»½æŸ æª¬æ€ä¹ˆåŠï¼Ÿä¸‰ä»½æŸ æª¬æ€ä¹ˆåŠï¼Ÿ</p>
<p>ä¸è¯´åºŸè¯äº†ï¼Œä¸Šä»£ç ã€‚</p>
<p>é¦–å…ˆï¼Œå®šä¹‰é¥®æ–™æŠ½è±¡åŸºç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Beverage</span> &#123;</span><br><span class="line">  	<span class="comment">// è¿”å›æè¿°</span></span><br><span class="line">  	<span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title function_">getDescription</span><span class="params">()</span>;</span><br><span class="line">  	<span class="comment">// è¿”å›ä»·æ ¼</span></span><br><span class="line">  	<span class="keyword">public</span> <span class="keyword">abstract</span> <span class="type">double</span> <span class="title function_">cost</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åæ˜¯ä¸‰ä¸ªåŸºç¡€é¥®æ–™å®ç°ç±»ï¼Œçº¢èŒ¶ã€ç»¿èŒ¶å’Œå’–å•¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlackTea</span> <span class="keyword">extends</span> <span class="title class_">Beverage</span> &#123;</span><br><span class="line">  	<span class="keyword">public</span> String <span class="title function_">getDescription</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;çº¢èŒ¶&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="keyword">public</span> <span class="type">double</span> <span class="title function_">cost</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreenTea</span> <span class="keyword">extends</span> <span class="title class_">Beverage</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDescription</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ç»¿èŒ¶&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="keyword">public</span> <span class="type">double</span> <span class="title function_">cost</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">11</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...<span class="comment">// å’–å•¡çœç•¥</span></span><br></pre></td></tr></table></figure>

<p>å®šä¹‰è°ƒæ–™ï¼Œä¹Ÿå°±æ˜¯è£…é¥°è€…çš„åŸºç±»ï¼Œæ­¤ç±»å¿…é¡»ç»§æ‰¿è‡ª Beverageï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è°ƒæ–™</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Condiment</span> <span class="keyword">extends</span> <span class="title class_">Beverage</span> &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åæˆ‘ä»¬æ¥å®šä¹‰æŸ æª¬ã€èŠ’æœç­‰å…·ä½“çš„è°ƒæ–™ï¼Œå®ƒä»¬å±äºè£…é¥°è€…ï¼Œæ¯«æ— ç–‘é—®ï¼Œè¿™äº›è°ƒæ–™è‚¯å®šéƒ½éœ€è¦ç»§æ‰¿è°ƒæ–™ Condiment ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Lemon</span> <span class="keyword">extends</span> <span class="title class_">Condiment</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Beverage bevarage;</span><br><span class="line">    <span class="comment">// è¿™é‡Œå¾ˆå…³é”®ï¼Œéœ€è¦ä¼ å…¥å…·ä½“çš„é¥®æ–™ï¼Œå¦‚éœ€è¦ä¼ å…¥æ²¡æœ‰è¢«è£…é¥°çš„çº¢èŒ¶æˆ–ç»¿èŒ¶ï¼Œ</span></span><br><span class="line">    <span class="comment">// å½“ç„¶ä¹Ÿå¯ä»¥ä¼ å…¥å·²ç»è£…é¥°å¥½çš„èŠ’æœç»¿èŒ¶ï¼Œè¿™æ ·å¯ä»¥åšèŠ’æœæŸ æª¬ç»¿èŒ¶</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Lemon</span><span class="params">(Beverage bevarage)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.bevarage = bevarage;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDescription</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// è£…é¥°</span></span><br><span class="line">        <span class="keyword">return</span> bevarage.getDescription() + <span class="string">&quot;, åŠ æŸ æª¬&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">cost</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// è£…é¥°</span></span><br><span class="line">        <span class="keyword">return</span> beverage.cost() + <span class="number">2</span>; <span class="comment">// åŠ æŸ æª¬éœ€è¦ 2 å…ƒ</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Mango</span> <span class="keyword">extends</span> <span class="title class_">Condiment</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Beverage bevarage;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Mango</span><span class="params">(Beverage bevarage)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.bevarage = bevarage;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDescription</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> bevarage.getDescription() + <span class="string">&quot;, åŠ èŠ’æœ&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">cost</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> beverage.cost() + <span class="number">3</span>; <span class="comment">// åŠ èŠ’æœéœ€è¦ 3 å…ƒ</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...<span class="comment">// ç»™æ¯ä¸€ç§è°ƒæ–™éƒ½åŠ ä¸€ä¸ªç±»</span></span><br></pre></td></tr></table></figure>

<p>çœ‹å®¢æˆ·ç«¯è°ƒç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªåŸºç¡€é¥®æ–™ï¼Œçº¢èŒ¶ã€ç»¿èŒ¶æˆ–å’–å•¡</span></span><br><span class="line">    <span class="type">Beverage</span> <span class="variable">beverage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GreenTea</span>();</span><br><span class="line">    <span class="comment">// å¼€å§‹è£…é¥°</span></span><br><span class="line">    beverage = <span class="keyword">new</span> <span class="title class_">Lemon</span>(beverage); <span class="comment">// å…ˆåŠ ä¸€ä»½æŸ æª¬</span></span><br><span class="line">    beverage = <span class="keyword">new</span> <span class="title class_">Mongo</span>(beverage); <span class="comment">// å†åŠ ä¸€ä»½èŠ’æœ</span></span><br><span class="line"></span><br><span class="line">    System.out.println(beverage.getDescription() + <span class="string">&quot; ä»·æ ¼ï¼šï¿¥&quot;</span> + beverage.cost());</span><br><span class="line">    <span class="comment">//&quot;ç»¿èŒ¶, åŠ æŸ æª¬, åŠ èŠ’æœ ä»·æ ¼ï¼šï¿¥16&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæˆ‘ä»¬éœ€è¦ <strong>èŠ’æœ-çç -åŒä»½æŸ æª¬-çº¢èŒ¶</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Beverage</span> <span class="variable">beverage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Mongo</span>(<span class="keyword">new</span> <span class="title class_">Pearl</span>(<span class="keyword">new</span> <span class="title class_">Lemon</span>(<span class="keyword">new</span> <span class="title class_">Lemon</span>(<span class="keyword">new</span> <span class="title class_">BlackTea</span>()))));</span><br></pre></td></tr></table></figure>

<p>æ˜¯ä¸æ˜¯å¾ˆå˜æ€ï¼Ÿ</p>
<p>çœ‹çœ‹ä¸‹å›¾å¯èƒ½ä¼šæ¸…æ™°ä¸€äº›ï¼š</p>
<p><img src="https://assets.javadoop.com/blogimages/design-pattern/decorator-2.png" alt="decorator-2"></p>
<p>åˆ°è¿™é‡Œï¼Œå¤§å®¶åº”è¯¥å·²ç»æ¸…æ¥šè£…é¥°æ¨¡å¼äº†å§ã€‚</p>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬å†æ¥è¯´è¯´ java IO ä¸­çš„è£…é¥°æ¨¡å¼ã€‚çœ‹ä¸‹å›¾ InputStream æ´¾ç”Ÿå‡ºæ¥çš„éƒ¨åˆ†ç±»ï¼š</p>
<p><img src="https://assets.javadoop.com/blogimages/design-pattern/decorator-3.png" alt="decorator-3"></p>
<p>æˆ‘ä»¬çŸ¥é“ InputStream ä»£è¡¨äº†è¾“å…¥æµï¼Œå…·ä½“çš„è¾“å…¥æ¥æºå¯ä»¥æ˜¯æ–‡ä»¶ï¼ˆFileInputStreamï¼‰ã€ç®¡é“ï¼ˆPipedInputStreamï¼‰ã€æ•°ç»„ï¼ˆByteArrayInputStreamï¼‰ç­‰ï¼Œè¿™äº›å°±åƒå‰é¢å¥¶èŒ¶çš„ä¾‹å­ä¸­çš„çº¢èŒ¶ã€ç»¿èŒ¶ï¼Œå±äºåŸºç¡€è¾“å…¥æµã€‚</p>
<p>FilterInputStream æ‰¿æ¥äº†è£…é¥°æ¨¡å¼çš„å…³é”®èŠ‚ç‚¹ï¼Œå®ƒçš„å®ç°ç±»æ˜¯ä¸€ç³»åˆ—è£…é¥°å™¨ï¼Œæ¯”å¦‚ BufferedInputStream ä»£è¡¨ç”¨ç¼“å†²æ¥è£…é¥°ï¼Œä¹Ÿå°±ä½¿å¾—è¾“å…¥æµå…·æœ‰äº†ç¼“å†²çš„åŠŸèƒ½ï¼ŒLineNumberInputStream ä»£è¡¨ç”¨è¡Œå·æ¥è£…é¥°ï¼Œåœ¨æ“ä½œçš„æ—¶å€™å°±å¯ä»¥å–å¾—è¡Œå·äº†ï¼ŒDataInputStream çš„è£…é¥°ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥ä»è¾“å…¥æµè½¬æ¢ä¸º java ä¸­çš„åŸºæœ¬ç±»å‹å€¼ã€‚</p>
<p>å½“ç„¶ï¼Œåœ¨ java IO ä¸­ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨è£…é¥°å™¨çš„è¯ï¼Œå°±ä¸å¤ªé€‚åˆé¢å‘æ¥å£ç¼–ç¨‹äº†ï¼Œå¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LineNumberInputStream</span>(<span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;&quot;</span>)));</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·çš„ç»“æœæ˜¯ï¼ŒInputStream è¿˜æ˜¯ä¸å…·æœ‰è¯»å–è¡Œå·çš„åŠŸèƒ½ï¼Œå› ä¸ºè¯»å–è¡Œå·çš„æ–¹æ³•å®šä¹‰åœ¨ LineNumberInputStream ç±»ä¸­ã€‚</p>
<p>æˆ‘ä»¬åº”è¯¥åƒä¸‹é¢è¿™æ ·ä½¿ç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DataInputStream</span> <span class="variable">is</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataInputStream</span>(</span><br><span class="line">  							<span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(</span><br><span class="line">                              	<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;&quot;</span>)));</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ‰€ä»¥è¯´å˜›ï¼Œè¦æ‰¾åˆ°çº¯çš„ä¸¥æ ¼ç¬¦åˆè®¾è®¡æ¨¡å¼çš„ä»£ç è¿˜æ˜¯æ¯”è¾ƒéš¾çš„ã€‚</p>
</blockquote>
<h3 id="é—¨é¢æ¨¡å¼"><a href="#é—¨é¢æ¨¡å¼" class="headerlink" title="é—¨é¢æ¨¡å¼"></a>é—¨é¢æ¨¡å¼</h3><p>é—¨é¢æ¨¡å¼ï¼ˆä¹Ÿå«å¤–è§‚æ¨¡å¼ï¼ŒFacade Patternï¼‰åœ¨è®¸å¤šæºç ä¸­æœ‰ä½¿ç”¨ï¼Œæ¯”å¦‚ slf4j å°±å¯ä»¥ç†è§£ä¸ºæ˜¯é—¨é¢æ¨¡å¼çš„åº”ç”¨ã€‚è¿™æ˜¯ä¸€ä¸ªç®€å•çš„è®¾è®¡æ¨¡å¼ï¼Œæˆ‘ä»¬ç›´æ¥ä¸Šä»£ç å†è¯´å§ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Shape</span> &#123;</span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">draw</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®šä¹‰å‡ ä¸ªå®ç°ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Circle</span> <span class="keyword">implements</span> <span class="title class_">Shape</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">draw</span><span class="params">()</span> &#123;</span><br><span class="line">       System.out.println(<span class="string">&quot;Circle::draw()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Rectangle</span> <span class="keyword">implements</span> <span class="title class_">Shape</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">draw</span><span class="params">()</span> &#123;</span><br><span class="line">       System.out.println(<span class="string">&quot;Rectangle::draw()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®¢æˆ·ç«¯è°ƒç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// ç”»ä¸€ä¸ªåœ†å½¢</span></span><br><span class="line">  	<span class="type">Shape</span> <span class="variable">circle</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Circle</span>();</span><br><span class="line">  	circle.draw();</span><br><span class="line">  </span><br><span class="line">  	<span class="comment">// ç”»ä¸€ä¸ªé•¿æ–¹å½¢</span></span><br><span class="line">  	<span class="type">Shape</span> <span class="variable">rectangle</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Rectangle</span>();</span><br><span class="line">  	rectangle.draw();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šæ˜¯æˆ‘ä»¬å¸¸å†™çš„ä»£ç ï¼Œæˆ‘ä»¬éœ€è¦ç”»åœ†å°±è¦å…ˆå®ä¾‹åŒ–åœ†ï¼Œç”»é•¿æ–¹å½¢å°±éœ€è¦å…ˆå®ä¾‹åŒ–ä¸€ä¸ªé•¿æ–¹å½¢ï¼Œç„¶åå†è°ƒç”¨ç›¸åº”çš„ draw() æ–¹æ³•ã€‚</p>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬çœ‹çœ‹æ€ä¹ˆç”¨é—¨é¢æ¨¡å¼æ¥è®©å®¢æˆ·ç«¯è°ƒç”¨æ›´åŠ å‹å¥½ä¸€äº›ã€‚</p>
<p>æˆ‘ä»¬å…ˆå®šä¹‰ä¸€ä¸ªé—¨é¢ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShapeMaker</span> &#123;</span><br><span class="line">   <span class="keyword">private</span> Shape circle;</span><br><span class="line">   <span class="keyword">private</span> Shape rectangle;</span><br><span class="line">   <span class="keyword">private</span> Shape square;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="title function_">ShapeMaker</span><span class="params">()</span> &#123;</span><br><span class="line">      circle = <span class="keyword">new</span> <span class="title class_">Circle</span>();</span><br><span class="line">      rectangle = <span class="keyword">new</span> <span class="title class_">Rectangle</span>();</span><br><span class="line">      square = <span class="keyword">new</span> <span class="title class_">Square</span>();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * ä¸‹é¢å®šä¹‰ä¸€å †æ–¹æ³•ï¼Œå…·ä½“åº”è¯¥è°ƒç”¨ä»€ä¹ˆæ–¹æ³•ï¼Œç”±è¿™ä¸ªé—¨é¢æ¥å†³å®š</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  </span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">drawCircle</span><span class="params">()</span>&#123;</span><br><span class="line">      circle.draw();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">drawRectangle</span><span class="params">()</span>&#123;</span><br><span class="line">      rectangle.draw();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">drawSquare</span><span class="params">()</span>&#123;</span><br><span class="line">      square.draw();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>çœ‹çœ‹ç°åœ¨å®¢æˆ·ç«¯æ€ä¹ˆè°ƒç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">  <span class="type">ShapeMaker</span> <span class="variable">shapeMaker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShapeMaker</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å®¢æˆ·ç«¯è°ƒç”¨ç°åœ¨æ›´åŠ æ¸…æ™°äº†</span></span><br><span class="line">  shapeMaker.drawCircle();</span><br><span class="line">  shapeMaker.drawRectangle();</span><br><span class="line">  shapeMaker.drawSquare();		</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é—¨é¢æ¨¡å¼çš„ä¼˜ç‚¹æ˜¾è€Œæ˜“è§ï¼Œå®¢æˆ·ç«¯ä¸å†éœ€è¦å…³æ³¨å®ä¾‹åŒ–æ—¶åº”è¯¥ä½¿ç”¨å“ªä¸ªå®ç°ç±»ï¼Œç›´æ¥è°ƒç”¨é—¨é¢æä¾›çš„æ–¹æ³•å°±å¯ä»¥äº†ï¼Œå› ä¸ºé—¨é¢ç±»æä¾›çš„æ–¹æ³•çš„æ–¹æ³•åå¯¹äºå®¢æˆ·ç«¯æ¥è¯´å·²ç»å¾ˆå‹å¥½äº†ã€‚</p>
<h3 id="ç»„åˆæ¨¡å¼"><a href="#ç»„åˆæ¨¡å¼" class="headerlink" title="ç»„åˆæ¨¡å¼"></a>ç»„åˆæ¨¡å¼</h3><p>ç»„åˆæ¨¡å¼ç”¨äºè¡¨ç¤ºå…·æœ‰å±‚æ¬¡ç»“æ„çš„æ•°æ®ï¼Œä½¿å¾—æˆ‘ä»¬å¯¹å•ä¸ªå¯¹è±¡å’Œç»„åˆå¯¹è±¡çš„è®¿é—®å…·æœ‰ä¸€è‡´æ€§ã€‚</p>
<p>ç›´æ¥çœ‹ä¸€ä¸ªä¾‹å­å§ï¼Œæ¯ä¸ªå‘˜å·¥éƒ½æœ‰å§“åã€éƒ¨é—¨ã€è–ªæ°´è¿™äº›å±æ€§ï¼ŒåŒæ—¶è¿˜æœ‰ä¸‹å±å‘˜å·¥é›†åˆï¼ˆè™½ç„¶å¯èƒ½é›†åˆä¸ºç©ºï¼‰ï¼Œè€Œä¸‹å±å‘˜å·¥å’Œè‡ªå·±çš„ç»“æ„æ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿæœ‰å§“åã€éƒ¨é—¨è¿™äº›å±æ€§ï¼ŒåŒæ—¶ä¹Ÿæœ‰ä»–ä»¬çš„ä¸‹å±å‘˜å·¥é›†åˆã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Employee</span> &#123;</span><br><span class="line">   <span class="keyword">private</span> String name;</span><br><span class="line">   <span class="keyword">private</span> String dept;</span><br><span class="line">   <span class="keyword">private</span> <span class="type">int</span> salary;</span><br><span class="line">   <span class="keyword">private</span> List&lt;Employee&gt; subordinates; <span class="comment">// ä¸‹å±</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="title function_">Employee</span><span class="params">(String name,String dept, <span class="type">int</span> sal)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.name = name;</span><br><span class="line">      <span class="built_in">this</span>.dept = dept;</span><br><span class="line">      <span class="built_in">this</span>.salary = sal;</span><br><span class="line">      subordinates = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Employee&gt;();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(Employee e)</span> &#123;</span><br><span class="line">      subordinates.add(e);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(Employee e)</span> &#123;</span><br><span class="line">      subordinates.remove(e);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> List&lt;Employee&gt; <span class="title function_">getSubordinates</span><span class="params">()</span>&#123;</span><br><span class="line">     <span class="keyword">return</span> subordinates;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> (<span class="string">&quot;Employee :[ Name : &quot;</span> + name + <span class="string">&quot;, dept : &quot;</span> + dept + <span class="string">&quot;, salary :&quot;</span> + salary+<span class="string">&quot; ]&quot;</span>);</span><br><span class="line">   &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šå¸¸ï¼Œè¿™ç§ç±»éœ€è¦å®šä¹‰ add(node)ã€remove(node)ã€getChildren() è¿™äº›æ–¹æ³•ã€‚</p>
<p>è¿™è¯´çš„å…¶å®å°±æ˜¯ç»„åˆæ¨¡å¼ï¼Œè¿™ç§ç®€å•çš„æ¨¡å¼æˆ‘å°±ä¸åšè¿‡å¤šä»‹ç»äº†ï¼Œç›¸ä¿¡å„ä½è¯»è€…ä¹Ÿä¸å–œæ¬¢çœ‹æˆ‘å†™åºŸè¯ã€‚</p>
<h3 id="äº«å…ƒæ¨¡å¼"><a href="#äº«å…ƒæ¨¡å¼" class="headerlink" title="äº«å…ƒæ¨¡å¼"></a>äº«å…ƒæ¨¡å¼</h3><p>è‹±æ–‡æ˜¯ Flyweight Patternï¼Œä¸çŸ¥é“æ˜¯è°æœ€å…ˆç¿»è¯‘çš„è¿™ä¸ªè¯ï¼Œæ„Ÿè§‰è¿™ç¿»è¯‘çœŸçš„ä¸å¥½ç†è§£ï¼Œæˆ‘ä»¬è¯•ç€å¼ºè¡Œå…³è”èµ·æ¥å§ã€‚Flyweight æ˜¯è½»é‡çº§çš„æ„æ€ï¼Œäº«å…ƒåˆ†å¼€æ¥è¯´å°±æ˜¯ å…±äº« å…ƒå™¨ä»¶ï¼Œä¹Ÿå°±æ˜¯å¤ç”¨å·²ç»ç”Ÿæˆçš„å¯¹è±¡ï¼Œè¿™ç§åšæ³•å½“ç„¶ä¹Ÿå°±æ˜¯è½»é‡çº§çš„äº†ã€‚</p>
<p>å¤ç”¨å¯¹è±¡æœ€ç®€å•çš„æ–¹å¼æ˜¯ï¼Œç”¨ä¸€ä¸ª HashMap æ¥å­˜æ”¾æ¯æ¬¡æ–°ç”Ÿæˆçš„å¯¹è±¡ã€‚æ¯æ¬¡éœ€è¦ä¸€ä¸ªå¯¹è±¡çš„æ—¶å€™ï¼Œå…ˆåˆ° HashMap ä¸­çœ‹çœ‹æœ‰æ²¡æœ‰ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå†ç”Ÿæˆæ–°çš„å¯¹è±¡ï¼Œç„¶åå°†è¿™ä¸ªå¯¹è±¡æ”¾å…¥ HashMap ä¸­ã€‚</p>
<p>è¿™ç§ç®€å•çš„ä»£ç æˆ‘å°±ä¸æ¼”ç¤ºäº†ã€‚</p>
<h3 id="ç»“æ„å‹æ¨¡å¼æ€»ç»“"><a href="#ç»“æ„å‹æ¨¡å¼æ€»ç»“" class="headerlink" title="ç»“æ„å‹æ¨¡å¼æ€»ç»“"></a>ç»“æ„å‹æ¨¡å¼æ€»ç»“</h3><p>å‰é¢ï¼Œæˆ‘ä»¬è¯´äº†ä»£ç†æ¨¡å¼ã€é€‚é…å™¨æ¨¡å¼ã€æ¡¥æ¢æ¨¡å¼ã€è£…é¥°æ¨¡å¼ã€é—¨é¢æ¨¡å¼ã€ç»„åˆæ¨¡å¼å’Œäº«å…ƒæ¨¡å¼ã€‚è¯»è€…æ˜¯å¦å¯ä»¥åˆ†åˆ«æŠŠè¿™å‡ ä¸ªæ¨¡å¼è¯´æ¸…æ¥šäº†å‘¢ï¼Ÿåœ¨è¯´åˆ°è¿™äº›æ¨¡å¼çš„æ—¶å€™ï¼Œå¿ƒä¸­æ˜¯å¦æœ‰ä¸€ä¸ªæ¸…æ™°çš„å›¾æˆ–å¤„ç†æµç¨‹åœ¨è„‘æµ·é‡Œå‘¢ï¼Ÿ</p>
<p>ä»£ç†æ¨¡å¼æ˜¯åšæ–¹æ³•å¢å¼ºçš„ï¼Œé€‚é…å™¨æ¨¡å¼æ˜¯æŠŠé¸¡åŒ…è£…æˆé¸­è¿™ç§ç”¨æ¥é€‚é…æ¥å£çš„ï¼Œæ¡¥æ¢æ¨¡å¼åšåˆ°äº†å¾ˆå¥½çš„è§£è€¦ï¼Œè£…é¥°æ¨¡å¼ä»åå­—ä¸Šå°±çœ‹å¾—å‡ºæ¥ï¼Œé€‚åˆäºè£…é¥°ç±»æˆ–è€…è¯´æ˜¯å¢å¼ºç±»çš„åœºæ™¯ï¼Œé—¨é¢æ¨¡å¼çš„ä¼˜ç‚¹æ˜¯å®¢æˆ·ç«¯ä¸éœ€è¦å…³å¿ƒå®ä¾‹åŒ–è¿‡ç¨‹ï¼Œåªè¦è°ƒç”¨éœ€è¦çš„æ–¹æ³•å³å¯ï¼Œç»„åˆæ¨¡å¼ç”¨äºæè¿°å…·æœ‰å±‚æ¬¡ç»“æ„çš„æ•°æ®ï¼Œäº«å…ƒæ¨¡å¼æ˜¯ä¸ºäº†åœ¨ç‰¹å®šçš„åœºæ™¯ä¸­ç¼“å­˜å·²ç»åˆ›å»ºçš„å¯¹è±¡ï¼Œç”¨äºæé«˜æ€§èƒ½ã€‚</p>
<h2 id="è¡Œä¸ºå‹æ¨¡å¼"><a href="#è¡Œä¸ºå‹æ¨¡å¼" class="headerlink" title="è¡Œä¸ºå‹æ¨¡å¼"></a>è¡Œä¸ºå‹æ¨¡å¼</h2><p>è¡Œä¸ºå‹æ¨¡å¼å…³æ³¨çš„æ˜¯å„ä¸ªç±»ä¹‹é—´çš„ç›¸äº’ä½œç”¨ï¼Œå°†èŒè´£åˆ’åˆ†æ¸…æ¥šï¼Œä½¿å¾—æˆ‘ä»¬çš„ä»£ç æ›´åŠ åœ°æ¸…æ™°ã€‚</p>
<h3 id="ç­–ç•¥æ¨¡å¼"><a href="#ç­–ç•¥æ¨¡å¼" class="headerlink" title="ç­–ç•¥æ¨¡å¼"></a>ç­–ç•¥æ¨¡å¼</h3><p>ç­–ç•¥æ¨¡å¼å¤ªå¸¸ç”¨äº†ï¼Œæ‰€ä»¥æŠŠå®ƒæ”¾åˆ°æœ€å‰é¢è¿›è¡Œä»‹ç»ã€‚å®ƒæ¯”è¾ƒç®€å•ï¼Œæˆ‘å°±ä¸åºŸè¯ï¼Œç›´æ¥ç”¨ä»£ç è¯´äº‹å§ã€‚</p>
<p>ä¸‹é¢è®¾è®¡çš„åœºæ™¯æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦ç”»ä¸€ä¸ªå›¾å½¢ï¼Œå¯é€‰çš„ç­–ç•¥å°±æ˜¯ç”¨çº¢è‰²ç¬”æ¥ç”»ï¼Œè¿˜æ˜¯ç»¿è‰²ç¬”æ¥ç”»ï¼Œæˆ–è€…è“è‰²ç¬”æ¥ç”»ã€‚</p>
<p>é¦–å…ˆï¼Œå…ˆå®šä¹‰ä¸€ä¸ªç­–ç•¥æ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Strategy</span> &#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">draw</span><span class="params">(<span class="type">int</span> radius, <span class="type">int</span> x, <span class="type">int</span> y)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åæˆ‘ä»¬å®šä¹‰å…·ä½“çš„å‡ ä¸ªç­–ç•¥ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedPen</span> <span class="keyword">implements</span> <span class="title class_">Strategy</span> &#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">draw</span><span class="params">(<span class="type">int</span> radius, <span class="type">int</span> x, <span class="type">int</span> y)</span> &#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;ç”¨çº¢è‰²ç¬”ç”»å›¾ï¼Œradius:&quot;</span> + radius + <span class="string">&quot;, x:&quot;</span> + x + <span class="string">&quot;, y:&quot;</span> + y);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreenPen</span> <span class="keyword">implements</span> <span class="title class_">Strategy</span> &#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">draw</span><span class="params">(<span class="type">int</span> radius, <span class="type">int</span> x, <span class="type">int</span> y)</span> &#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;ç”¨ç»¿è‰²ç¬”ç”»å›¾ï¼Œradius:&quot;</span> + radius + <span class="string">&quot;, x:&quot;</span> + x + <span class="string">&quot;, y:&quot;</span> + y);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BluePen</span> <span class="keyword">implements</span> <span class="title class_">Strategy</span> &#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">draw</span><span class="params">(<span class="type">int</span> radius, <span class="type">int</span> x, <span class="type">int</span> y)</span> &#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;ç”¨è“è‰²ç¬”ç”»å›¾ï¼Œradius:&quot;</span> + radius + <span class="string">&quot;, x:&quot;</span> + x + <span class="string">&quot;, y:&quot;</span> + y);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ç­–ç•¥çš„ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Context</span> &#123;</span><br><span class="line">   <span class="keyword">private</span> Strategy strategy;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="title function_">Context</span><span class="params">(Strategy strategy)</span>&#123;</span><br><span class="line">      <span class="built_in">this</span>.strategy = strategy;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">executeDraw</span><span class="params">(<span class="type">int</span> radius, <span class="type">int</span> x, <span class="type">int</span> y)</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> strategy.draw(radius, x, y);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®¢æˆ·ç«¯æ¼”ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Context</span>(<span class="keyword">new</span> <span class="title class_">BluePen</span>()); <span class="comment">// ä½¿ç”¨ç»¿è‰²ç¬”æ¥ç”»</span></span><br><span class="line">  	context.executeDraw(<span class="number">10</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ”¾åˆ°ä¸€å¼ å›¾ä¸Šï¼Œè®©å¤§å®¶çœ‹å¾—æ¸…æ™°äº›ï¼š</p>
<p><img src="https://assets.javadoop.com/blogimages/design-pattern/strategy-1.png" alt="strategy-1"></p>
<p>è¿™ä¸ªæ—¶å€™ï¼Œå¤§å®¶æœ‰æ²¡æœ‰è”æƒ³åˆ°ç»“æ„å‹æ¨¡å¼ä¸­çš„æ¡¥æ¢æ¨¡å¼ï¼Œå®ƒä»¬å…¶å®éå¸¸ç›¸ä¼¼ï¼Œæˆ‘æŠŠæ¡¥æ¢æ¨¡å¼çš„å›¾æ‹¿è¿‡æ¥å¤§å®¶å¯¹æ¯”ä¸‹ï¼š</p>
<p><img src="https://assets.javadoop.com/blogimages/design-pattern/bridge-1.png" alt="bridge-1"></p>
<p>è¦æˆ‘è¯´çš„è¯ï¼Œå®ƒä»¬éå¸¸ç›¸ä¼¼ï¼Œæ¡¥æ¢æ¨¡å¼åœ¨å·¦ä¾§åŠ äº†ä¸€å±‚æŠ½è±¡è€Œå·²ã€‚æ¡¥æ¢æ¨¡å¼çš„è€¦åˆæ›´ä½ï¼Œç»“æ„æ›´å¤æ‚ä¸€äº›ã€‚</p>
<h3 id="è§‚å¯Ÿè€…æ¨¡å¼"><a href="#è§‚å¯Ÿè€…æ¨¡å¼" class="headerlink" title="è§‚å¯Ÿè€…æ¨¡å¼"></a>è§‚å¯Ÿè€…æ¨¡å¼</h3><p>è§‚å¯Ÿè€…æ¨¡å¼å¯¹äºæˆ‘ä»¬æ¥è¯´ï¼ŒçœŸæ˜¯å†ç®€å•ä¸è¿‡äº†ã€‚æ— å¤–ä¹ä¸¤ä¸ªæ“ä½œï¼Œè§‚å¯Ÿè€…è®¢é˜…è‡ªå·±å…³å¿ƒçš„ä¸»é¢˜å’Œä¸»é¢˜æœ‰æ•°æ®å˜åŒ–åé€šçŸ¥è§‚å¯Ÿè€…ä»¬ã€‚</p>
<p>é¦–å…ˆï¼Œéœ€è¦å®šä¹‰ä¸»é¢˜ï¼Œæ¯ä¸ªä¸»é¢˜éœ€è¦æŒæœ‰è§‚å¯Ÿè€…åˆ—è¡¨çš„å¼•ç”¨ï¼Œç”¨äºåœ¨æ•°æ®å˜æ›´çš„æ—¶å€™é€šçŸ¥å„ä¸ªè§‚å¯Ÿè€…ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Subject</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Observer&gt; observers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Observer&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> state;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getState</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setState</span><span class="params">(<span class="type">int</span> state)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.state = state;</span><br><span class="line">        <span class="comment">// æ•°æ®å·²å˜æ›´ï¼Œé€šçŸ¥è§‚å¯Ÿè€…ä»¬</span></span><br><span class="line">        notifyAllObservers();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ³¨å†Œè§‚å¯Ÿè€…</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">attach</span><span class="params">(Observer observer)</span> &#123;</span><br><span class="line">        observers.add(observer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é€šçŸ¥è§‚å¯Ÿè€…ä»¬</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notifyAllObservers</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Observer observer : observers) &#123;</span><br><span class="line">            observer.update();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®šä¹‰è§‚å¯Ÿè€…æ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Observer</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> Subject subject;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶å®å¦‚æœåªæœ‰ä¸€ä¸ªè§‚å¯Ÿè€…ç±»çš„è¯ï¼Œæ¥å£éƒ½ä¸ç”¨å®šä¹‰äº†ï¼Œä¸è¿‡ï¼Œé€šå¸¸åœºæ™¯ä¸‹ï¼Œæ—¢ç„¶ç”¨åˆ°äº†è§‚å¯Ÿè€…æ¨¡å¼ï¼Œæˆ‘ä»¬å°±æ˜¯å¸Œæœ›ä¸€ä¸ªäº‹ä»¶å‡ºæ¥äº†ï¼Œä¼šæœ‰å¤šä¸ªä¸åŒçš„ç±»éœ€è¦å¤„ç†ç›¸åº”çš„ä¿¡æ¯ã€‚æ¯”å¦‚ï¼Œè®¢å•ä¿®æ”¹æˆåŠŸäº‹ä»¶ï¼Œæˆ‘ä»¬å¸Œæœ›å‘çŸ­ä¿¡çš„ç±»å¾—åˆ°é€šçŸ¥ã€å‘é‚®ä»¶çš„ç±»å¾—åˆ°é€šçŸ¥ã€å¤„ç†ç‰©æµä¿¡æ¯çš„ç±»å¾—åˆ°é€šçŸ¥ç­‰ã€‚</p>
<p>æˆ‘ä»¬æ¥å®šä¹‰å…·ä½“çš„å‡ ä¸ªè§‚å¯Ÿè€…ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BinaryObserver</span> <span class="keyword">extends</span> <span class="title class_">Observer</span> &#123;</span><br><span class="line">    <span class="comment">// åœ¨æ„é€ æ–¹æ³•ä¸­è¿›è¡Œè®¢é˜…ä¸»é¢˜</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BinaryObserver</span><span class="params">(Subject subject)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.subject = subject;</span><br><span class="line">        <span class="comment">// é€šå¸¸åœ¨æ„é€ æ–¹æ³•ä¸­å°† this å‘å¸ƒå‡ºå»çš„æ“ä½œä¸€å®šè¦å°å¿ƒ</span></span><br><span class="line">        <span class="built_in">this</span>.subject.attach(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¯¥æ–¹æ³•ç”±ä¸»é¢˜ç±»åœ¨æ•°æ®å˜æ›´çš„æ—¶å€™è¿›è¡Œè°ƒç”¨</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> Integer.toBinaryString(subject.getState());</span><br><span class="line">        System.out.println(<span class="string">&quot;è®¢é˜…çš„æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œæ–°çš„æ•°æ®å¤„ç†ä¸ºäºŒè¿›åˆ¶å€¼ä¸ºï¼š&quot;</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HexaObserver</span> <span class="keyword">extends</span> <span class="title class_">Observer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HexaObserver</span><span class="params">(Subject subject)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.subject = subject;</span><br><span class="line">        <span class="built_in">this</span>.subject.attach(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> Integer.toHexString(subject.getState()).toUpperCase();</span><br><span class="line">        System.out.println(<span class="string">&quot;è®¢é˜…çš„æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œæ–°çš„æ•°æ®å¤„ç†ä¸ºåå…­è¿›åˆ¶å€¼ä¸ºï¼š&quot;</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®¢æˆ·ç«¯ä½¿ç”¨ä¹Ÿéå¸¸ç®€å•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// å…ˆå®šä¹‰ä¸€ä¸ªä¸»é¢˜</span></span><br><span class="line">    <span class="type">Subject</span> <span class="variable">subject1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Subject</span>();</span><br><span class="line">    <span class="comment">// å®šä¹‰è§‚å¯Ÿè€…</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">BinaryObserver</span>(subject1);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">HexaObserver</span>(subject1);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// æ¨¡æ‹Ÿæ•°æ®å˜æ›´ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œè§‚å¯Ÿè€…ä»¬çš„ update æ–¹æ³•å°†ä¼šè¢«è°ƒç”¨</span></span><br><span class="line">    subject.setState(<span class="number">11</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>output:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è®¢é˜…çš„æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œæ–°çš„æ•°æ®å¤„ç†ä¸ºäºŒè¿›åˆ¶å€¼ä¸ºï¼š1011</span><br><span class="line">è®¢é˜…çš„æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œæ–°çš„æ•°æ®å¤„ç†ä¸ºåå…­è¿›åˆ¶å€¼ä¸ºï¼šB</span><br></pre></td></tr></table></figure>

<p>å½“ç„¶ï¼Œjdk ä¹Ÿæä¾›äº†ç›¸ä¼¼çš„æ”¯æŒï¼Œå…·ä½“çš„å¤§å®¶å¯ä»¥å‚è€ƒ java.util.Observable å’Œ java.util.Observer è¿™ä¸¤ä¸ªç±»ã€‚</p>
<p>å®é™…ç”Ÿäº§è¿‡ç¨‹ä¸­ï¼Œè§‚å¯Ÿè€…æ¨¡å¼å¾€å¾€ç”¨æ¶ˆæ¯ä¸­é—´ä»¶æ¥å®ç°ï¼Œå¦‚æœè¦å®ç°å•æœºè§‚å¯Ÿè€…æ¨¡å¼ï¼Œç¬”è€…å»ºè®®è¯»è€…ä½¿ç”¨ Guava ä¸­çš„ EventBusï¼Œå®ƒæœ‰åŒæ­¥å®ç°ä¹Ÿæœ‰å¼‚æ­¥å®ç°ï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç»è®¾è®¡æ¨¡å¼ï¼Œå°±ä¸å±•å¼€è¯´äº†ã€‚</p>
<p>è¿˜æœ‰ï¼Œå³ä½¿æ˜¯ä¸Šé¢çš„è¿™ä¸ªä»£ç ï¼Œä¹Ÿä¼šæœ‰å¾ˆå¤šå˜ç§ï¼Œå¤§å®¶åªè¦è®°ä½æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œé‚£å°±æ˜¯ä¸€å®šæœ‰ä¸€ä¸ªåœ°æ–¹å­˜æ”¾äº†æ‰€æœ‰çš„è§‚å¯Ÿè€…ï¼Œç„¶ååœ¨äº‹ä»¶å‘ç”Ÿçš„æ—¶å€™ï¼Œéå†è§‚å¯Ÿè€…ï¼Œè°ƒç”¨å®ƒä»¬çš„å›è°ƒå‡½æ•°ã€‚</p>
<h3 id="è´£ä»»é“¾æ¨¡å¼"><a href="#è´£ä»»é“¾æ¨¡å¼" class="headerlink" title="è´£ä»»é“¾æ¨¡å¼"></a>è´£ä»»é“¾æ¨¡å¼</h3><p>è´£ä»»é“¾é€šå¸¸éœ€è¦å…ˆå»ºç«‹ä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œç„¶åè°ƒç”¨æ–¹åªéœ€è¦è°ƒç”¨å¤´éƒ¨èŠ‚ç‚¹å°±å¯ä»¥äº†ï¼Œåé¢ä¼šè‡ªåŠ¨æµè½¬ä¸‹å»ã€‚æ¯”å¦‚æµç¨‹å®¡æ‰¹å°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ï¼Œåªè¦ç»ˆç«¯ç”¨æˆ·æäº¤ç”³è¯·ï¼Œæ ¹æ®ç”³è¯·çš„å†…å®¹ä¿¡æ¯ï¼Œè‡ªåŠ¨å»ºç«‹ä¸€æ¡è´£ä»»é“¾ï¼Œç„¶åå°±å¯ä»¥å¼€å§‹æµè½¬äº†ã€‚</p>
<p>æœ‰è¿™ä¹ˆä¸€ä¸ªåœºæ™¯ï¼Œç”¨æˆ·å‚åŠ ä¸€ä¸ªæ´»åŠ¨å¯ä»¥é¢†å–å¥–å“ï¼Œä½†æ˜¯æ´»åŠ¨éœ€è¦è¿›è¡Œå¾ˆå¤šçš„è§„åˆ™æ ¡éªŒç„¶åæ‰èƒ½æ”¾è¡Œï¼Œæ¯”å¦‚é¦–å…ˆéœ€è¦æ ¡éªŒç”¨æˆ·æ˜¯å¦æ˜¯æ–°ç”¨æˆ·ã€ä»Šæ—¥å‚ä¸äººæ•°æ˜¯å¦æœ‰é™é¢ã€å…¨åœºå‚ä¸äººæ•°æ˜¯å¦æœ‰é™é¢ç­‰ç­‰ã€‚è®¾å®šçš„è§„åˆ™éƒ½é€šè¿‡åï¼Œæ‰èƒ½è®©ç”¨æˆ·é¢†èµ°å¥–å“ã€‚</p>
<blockquote>
<p>å¦‚æœäº§å“ç»™ä½ è¿™ä¸ªéœ€æ±‚çš„è¯ï¼Œæˆ‘æƒ³å¤§éƒ¨åˆ†äººä¸€å¼€å§‹è‚¯å®šæƒ³çš„å°±æ˜¯ï¼Œç”¨ä¸€ä¸ª List æ¥å­˜æ”¾æ‰€æœ‰çš„è§„åˆ™ï¼Œç„¶å foreach æ‰§è¡Œä¸€ä¸‹æ¯ä¸ªè§„åˆ™å°±å¥½äº†ã€‚ä¸è¿‡ï¼Œè¯»è€…ä¹Ÿå…ˆåˆ«æ€¥ï¼Œçœ‹çœ‹è´£ä»»é“¾æ¨¡å¼å’Œæˆ‘ä»¬è¯´çš„è¿™ä¸ªæœ‰ä»€ä¹ˆä¸ä¸€æ ·ï¼Ÿ</p>
</blockquote>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦å®šä¹‰æµç¨‹ä¸ŠèŠ‚ç‚¹çš„åŸºç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">RuleHandler</span> &#123;</span><br><span class="line">    <span class="comment">// åç»§èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">protected</span> RuleHandler successor;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(Context context)</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSuccessor</span><span class="params">(RuleHandler successor)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.successor = successor;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> RuleHandler <span class="title function_">getSuccessor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> successor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰å…·ä½“çš„æ¯ä¸ªèŠ‚ç‚¹äº†ã€‚</p>
<p>æ ¡éªŒç”¨æˆ·æ˜¯å¦æ˜¯æ–°ç”¨æˆ·ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NewUserRuleHandler</span> <span class="keyword">extends</span> <span class="title class_">RuleHandler</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (context.isNewUser()) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœæœ‰åç»§èŠ‚ç‚¹çš„è¯ï¼Œä¼ é€’ä¸‹å»</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.getSuccessor() != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.getSuccessor().apply(context);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;è¯¥æ´»åŠ¨ä»…é™æ–°ç”¨æˆ·å‚ä¸&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¡éªŒç”¨æˆ·æ‰€åœ¨åœ°åŒºæ˜¯å¦å¯ä»¥å‚ä¸ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LocationRuleHandler</span> <span class="keyword">extends</span> <span class="title class_">RuleHandler</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">allowed</span> <span class="operator">=</span> activityService.isSupportedLocation(context.getLocation);</span><br><span class="line">        <span class="keyword">if</span> (allowed) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.getSuccessor() != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.getSuccessor().apply(context);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;éå¸¸æŠ±æ­‰ï¼Œæ‚¨æ‰€åœ¨çš„åœ°åŒºæ— æ³•å‚ä¸æœ¬æ¬¡æ´»åŠ¨&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¡éªŒå¥–å“æ˜¯å¦å·²é¢†å®Œï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LimitRuleHandler</span> <span class="keyword">extends</span> <span class="title class_">RuleHandler</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">remainedTimes</span> <span class="operator">=</span> activityService.queryRemainedTimes(context); <span class="comment">// æŸ¥è¯¢å‰©ä½™å¥–å“</span></span><br><span class="line">        <span class="keyword">if</span> (remainedTimes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.getSuccessor() != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.getSuccessor().apply(userInfo);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;æ‚¨æ¥å¾—å¤ªæ™šäº†ï¼Œå¥–å“è¢«é¢†å®Œäº†&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®¢æˆ·ç«¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">RuleHandler</span> <span class="variable">newUserHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NewUserRuleHandler</span>();</span><br><span class="line">    <span class="type">RuleHandler</span> <span class="variable">locationHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LocationRuleHandler</span>();</span><br><span class="line">    <span class="type">RuleHandler</span> <span class="variable">limitHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LimitRuleHandler</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// å‡è®¾æœ¬æ¬¡æ´»åŠ¨ä»…æ ¡éªŒåœ°åŒºå’Œå¥–å“æ•°é‡ï¼Œä¸æ ¡éªŒæ–°è€ç”¨æˆ·</span></span><br><span class="line">    locationHandler.setSuccessor(limitHandler);</span><br><span class="line">  </span><br><span class="line">    locationHandler.apply(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»£ç å…¶å®å¾ˆç®€å•ï¼Œå°±æ˜¯å…ˆå®šä¹‰å¥½ä¸€ä¸ªé“¾è¡¨ï¼Œç„¶ååœ¨é€šè¿‡ä»»æ„ä¸€èŠ‚ç‚¹åï¼Œå¦‚æœæ­¤èŠ‚ç‚¹æœ‰åç»§èŠ‚ç‚¹ï¼Œé‚£ä¹ˆä¼ é€’ä¸‹å»ã€‚</p>
<p>è‡³äºå®ƒå’Œæˆ‘ä»¬å‰é¢è¯´çš„ç”¨ä¸€ä¸ª List å­˜æ”¾éœ€è¦æ‰§è¡Œçš„è§„åˆ™çš„åšæ³•æœ‰ä»€ä¹ˆå¼‚åŒï¼Œç•™ç»™è¯»è€…è‡ªå·±ç¢ç£¨å§ã€‚</p>
<h3 id="æ¨¡æ¿æ–¹æ³•æ¨¡å¼"><a href="#æ¨¡æ¿æ–¹æ³•æ¨¡å¼" class="headerlink" title="æ¨¡æ¿æ–¹æ³•æ¨¡å¼"></a>æ¨¡æ¿æ–¹æ³•æ¨¡å¼</h3><p>åœ¨å«æœ‰ç»§æ‰¿ç»“æ„çš„ä»£ç ä¸­ï¼Œæ¨¡æ¿æ–¹æ³•æ¨¡å¼æ˜¯éå¸¸å¸¸ç”¨çš„ã€‚</p>
<p>é€šå¸¸ä¼šæœ‰ä¸€ä¸ªæŠ½è±¡ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractTemplate</span> &#123;</span><br><span class="line">    <span class="comment">// è¿™å°±æ˜¯æ¨¡æ¿æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">templateMethod</span><span class="params">()</span> &#123;</span><br><span class="line">        init();</span><br><span class="line">        apply(); <span class="comment">// è¿™ä¸ªæ˜¯é‡ç‚¹</span></span><br><span class="line">        end(); <span class="comment">// å¯ä»¥ä½œä¸ºé’©å­æ–¹æ³•</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;init æŠ½è±¡å±‚å·²ç»å®ç°ï¼Œå­ç±»ä¹Ÿå¯ä»¥é€‰æ‹©è¦†å†™&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç•™ç»™å­ç±»å®ç°</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">end</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¨¡æ¿æ–¹æ³•ä¸­è°ƒç”¨äº† 3 ä¸ªæ–¹æ³•ï¼Œå…¶ä¸­ apply() æ˜¯æŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å¿…é¡»å®ç°å®ƒï¼Œå…¶å®æ¨¡æ¿æ–¹æ³•ä¸­æœ‰å‡ ä¸ªæŠ½è±¡æ–¹æ³•å®Œå…¨æ˜¯è‡ªç”±çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°†ä¸‰ä¸ªæ–¹æ³•éƒ½è®¾ç½®ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œè®©å­ç±»æ¥å®ç°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¨¡æ¿æ–¹æ³•åªè´Ÿè´£å®šä¹‰ç¬¬ä¸€æ­¥åº”è¯¥è¦åšä»€ä¹ˆï¼Œç¬¬äºŒæ­¥åº”è¯¥åšä»€ä¹ˆï¼Œç¬¬ä¸‰æ­¥åº”è¯¥åšä»€ä¹ˆï¼Œè‡³äºæ€ä¹ˆåšï¼Œç”±å­ç±»æ¥å®ç°ã€‚</p>
<p>æˆ‘ä»¬å†™ä¸€ä¸ªå®ç°ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConcreteTemplate</span> <span class="keyword">extends</span> <span class="title class_">AbstractTemplate</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å­ç±»å®ç°æŠ½è±¡æ–¹æ³• apply&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">end</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æˆ‘ä»¬å¯ä»¥æŠŠ method3 å½“åšé’©å­æ–¹æ³•æ¥ä½¿ç”¨ï¼Œéœ€è¦çš„æ—¶å€™è¦†å†™å°±å¯ä»¥äº†&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®¢æˆ·ç«¯è°ƒç”¨æ¼”ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">AbstractTemplate</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConcreteTemplate</span>();</span><br><span class="line">    <span class="comment">// è°ƒç”¨æ¨¡æ¿æ–¹æ³•</span></span><br><span class="line">    t.templateMethod();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»£ç å…¶å®å¾ˆç®€å•ï¼ŒåŸºæœ¬ä¸Šçœ‹åˆ°å°±æ‡‚äº†ï¼Œå…³é”®æ˜¯è¦å­¦ä¼šç”¨åˆ°è‡ªå·±çš„ä»£ç ä¸­ã€‚</p>
<h3 id="çŠ¶æ€æ¨¡å¼"><a href="#çŠ¶æ€æ¨¡å¼" class="headerlink" title="çŠ¶æ€æ¨¡å¼"></a>çŠ¶æ€æ¨¡å¼</h3><p>update: 2017-10-19</p>
<p>åºŸè¯æˆ‘å°±ä¸è¯´äº†ï¼Œæˆ‘ä»¬è¯´ä¸€ä¸ªç®€å•çš„ä¾‹å­ã€‚å•†å“åº“å­˜ä¸­å¿ƒæœ‰ä¸ªæœ€åŸºæœ¬çš„éœ€æ±‚æ˜¯å‡åº“å­˜å’Œè¡¥åº“å­˜ï¼Œæˆ‘ä»¬çœ‹çœ‹æ€ä¹ˆç”¨çŠ¶æ€æ¨¡å¼æ¥å†™ã€‚</p>
<p>æ ¸å¿ƒåœ¨äºï¼Œæˆ‘ä»¬çš„å…³æ³¨ç‚¹ä¸å†æ˜¯ Context æ˜¯è¯¥è¿›è¡Œå“ªç§æ“ä½œï¼Œè€Œæ˜¯å…³æ³¨åœ¨è¿™ä¸ª Context ä¼šæœ‰å“ªäº›æ“ä½œã€‚</p>
<p>å®šä¹‰çŠ¶æ€æ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">State</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doAction</span><span class="params">(Context context)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®šä¹‰å‡åº“å­˜çš„çŠ¶æ€ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeductState</span> <span class="keyword">implements</span> <span class="title class_">State</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doAction</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å•†å“å–å‡ºï¼Œå‡†å¤‡å‡åº“å­˜&quot;</span>);</span><br><span class="line">        context.setState(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//... æ‰§è¡Œå‡åº“å­˜çš„å…·ä½“æ“ä½œ</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Deduct State&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>å®šä¹‰è¡¥åº“å­˜çŠ¶æ€ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RevertState</span> <span class="keyword">implements</span> <span class="title class_">State</span> &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doAction</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ç»™æ­¤å•†å“è¡¥åº“å­˜&quot;</span>);</span><br><span class="line">        context.setState(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//... æ‰§è¡ŒåŠ åº“å­˜çš„å…·ä½“æ“ä½œ</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Revert State&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‰é¢ç”¨åˆ°äº† context.setState(this)ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æ€ä¹ˆå®šä¹‰ Context ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Context</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> State state;</span><br><span class="line">  	<span class="keyword">private</span> String name;</span><br><span class="line">  	<span class="keyword">public</span> <span class="title function_">Context</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">  	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setState</span><span class="params">(State state)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.state = state;</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getState</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ¥çœ‹ä¸‹å®¢æˆ·ç«¯è°ƒç”¨ï¼Œå¤§å®¶å°±ä¸€æ¸…äºŒæ¥šäº†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// æˆ‘ä»¬éœ€è¦æ“ä½œçš„æ˜¯ iPhone X</span></span><br><span class="line">    <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Context</span>(<span class="string">&quot;iPhone X&quot;</span>);</span><br><span class="line">  	</span><br><span class="line">    <span class="comment">// çœ‹çœ‹æ€ä¹ˆè¿›è¡Œè¡¥åº“å­˜æ“ä½œ</span></span><br><span class="line">  	<span class="type">State</span> <span class="variable">revertState</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RevertState</span>();</span><br><span class="line">  	revertState.doAction(context);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// åŒæ ·çš„ï¼Œå‡åº“å­˜æ“ä½œä¹Ÿéå¸¸ç®€å•</span></span><br><span class="line">  	<span class="type">State</span> <span class="variable">deductState</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeductState</span>();</span><br><span class="line">  	deductState.doAction(context);</span><br><span class="line">  </span><br><span class="line">  	<span class="comment">// å¦‚æœéœ€è¦æˆ‘ä»¬å¯ä»¥è·å–å½“å‰çš„çŠ¶æ€</span></span><br><span class="line">    <span class="comment">// context.getState().toString();</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯»è€…å¯èƒ½ä¼šå‘ç°ï¼Œåœ¨ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¦‚æœæˆ‘ä»¬ä¸å…³å¿ƒå½“å‰ context å¤„äºä»€ä¹ˆçŠ¶æ€ï¼Œé‚£ä¹ˆ Context å°±å¯ä»¥ä¸ç”¨ç»´æŠ¤ state å±æ€§äº†ï¼Œé‚£æ ·ä»£ç ä¼šç®€å•å¾ˆå¤šã€‚</p>
<p>ä¸è¿‡ï¼Œå•†å“åº“å­˜è¿™ä¸ªä¾‹å­æ¯•ç«Ÿåªæ˜¯ä¸ªä¾‹ï¼Œæˆ‘ä»¬è¿˜æœ‰å¾ˆå¤šå®ä¾‹æ˜¯éœ€è¦çŸ¥é“å½“å‰ context å¤„äºä»€ä¹ˆçŠ¶æ€çš„ã€‚</p>
<h3 id="è¡Œä¸ºå‹æ¨¡å¼æ€»ç»“"><a href="#è¡Œä¸ºå‹æ¨¡å¼æ€»ç»“" class="headerlink" title="è¡Œä¸ºå‹æ¨¡å¼æ€»ç»“"></a>è¡Œä¸ºå‹æ¨¡å¼æ€»ç»“</h3><p>è¡Œä¸ºå‹æ¨¡å¼éƒ¨åˆ†ä»‹ç»äº†ç­–ç•¥æ¨¡å¼ã€è§‚å¯Ÿè€…æ¨¡å¼ã€è´£ä»»é“¾æ¨¡å¼ã€æ¨¡æ¿æ–¹æ³•æ¨¡å¼å’ŒçŠ¶æ€æ¨¡å¼ï¼Œå…¶å®ï¼Œç»å…¸çš„è¡Œä¸ºå‹æ¨¡å¼è¿˜åŒ…æ‹¬å¤‡å¿˜å½•æ¨¡å¼ã€å‘½ä»¤æ¨¡å¼ç­‰ï¼Œä½†æ˜¯å®ƒä»¬çš„ä½¿ç”¨åœºæ™¯æ¯”è¾ƒæœ‰é™ï¼Œè€Œä¸”æœ¬æ–‡ç¯‡å¹…ä¹ŸæŒºå¤§äº†ï¼Œæˆ‘å°±ä¸è¿›è¡Œä»‹ç»äº†ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p> å­¦ä¹ è®¾è®¡æ¨¡å¼çš„ç›®çš„æ˜¯ä¸ºäº†è®©æˆ‘ä»¬çš„ä»£ç æ›´åŠ çš„ä¼˜é›…ã€æ˜“ç»´æŠ¤ã€æ˜“æ‰©å±•ã€‚è¿™æ¬¡æ•´ç†è¿™ç¯‡æ–‡ç« ï¼Œè®©æˆ‘é‡æ–°å®¡è§†äº†ä¸€ä¸‹å„ä¸ªè®¾è®¡æ¨¡å¼ï¼Œå¯¹æˆ‘è‡ªå·±è€Œè¨€æ”¶è·è¿˜æ˜¯æŒºå¤§çš„ã€‚æˆ‘æƒ³ï¼Œæ–‡ç« çš„æœ€å¤§æ”¶ç›Šè€…ä¸€èˆ¬éƒ½æ˜¯ä½œè€…æœ¬äººï¼Œä¸ºäº†å†™ä¸€ç¯‡æ–‡ç« ï¼Œéœ€è¦å·©å›ºè‡ªå·±çš„çŸ¥è¯†ï¼Œéœ€è¦å¯»æ‰¾å„ç§èµ„æ–™ï¼Œè€Œä¸”ï¼Œè‡ªå·±å†™è¿‡çš„æ‰æœ€å®¹æ˜“è®°ä½ï¼Œä¹Ÿç®—æ˜¯æˆ‘ç»™è¯»è€…çš„å»ºè®®å§ã€‚</p>
<p>ï¼ˆå…¨æ–‡å®Œï¼‰</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://scatteredream.github.io/2020/01/09/jvm-string-constant-pool/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/62317679?s=400&v=4">
      <meta itemprop="name" content="ç¢æ¢¦">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="scatteredream's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | scatteredream's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/01/09/jvm-string-constant-pool/" class="post-title-link" itemprop="url">Java å­—ç¬¦ä¸²å¸¸é‡æ± ä»‹ç»</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2020-01-09 00:00:00" itemprop="dateCreated datePublished" datetime="2020-01-09T00:00:00+08:00">2020-01-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2024-12-29 13:38:15" itemprop="dateModified" datetime="2024-12-29T13:38:15+08:00">2024-12-29</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>æœ¬æ–‡å°†ä»‹ç» HotSpot ä¸­çš„ String Poolï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± ã€‚ç›¸å¯¹æ˜¯ä¸€ç¯‡æ¯”è¾ƒç®€å•çš„æ–‡ç« ï¼Œå¤§å®¶èŠ±å‡ åˆ†é’Ÿå°±çœ‹å®Œäº†ã€‚</p>
<p>åœ¨ Java ä¸–ç•Œä¸­ï¼Œæ„é€ ä¸€ä¸ª Java å¯¹è±¡æ˜¯ä¸€ä¸ªç›¸å¯¹æ¯”è¾ƒé‡çš„æ´»ï¼Œè€Œä¸”è¿˜éœ€è¦åƒåœ¾å›æ”¶ï¼Œè€Œç¼“å­˜æ± å°±æ˜¯ä¸ºäº†ç¼“è§£è¿™ä¸ªé—®é¢˜çš„ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸‹åŸºç¡€ç±»å‹çš„åŒ…è£…ç±»çš„ç¼“å­˜ï¼ŒInteger é»˜è®¤ç¼“å­˜ -128 ~ 127 åŒºé—´çš„å€¼ï¼ŒLong å’Œ Short ä¹Ÿæ˜¯ç¼“å­˜äº†è¿™ä¸ªåŒºé—´çš„å€¼ï¼ŒByte åªèƒ½è¡¨ç¤º -127 ~ 128 èŒƒå›´çš„å€¼ï¼Œå…¨éƒ¨ç¼“å­˜äº†ï¼ŒCharacter ç¼“å­˜äº† 0 ~ 127 çš„å€¼ã€‚Float å’Œ Double æ²¡æœ‰ç¼“å­˜çš„æ„ä¹‰ã€‚</p>
<blockquote>
<p>Integer å¯é€šè¿‡è®¾ç½® java.lang.Integer.IntegerCache.high æ‰©å¤§ç¼“å­˜åŒºé—´</p>
</blockquote>
<p>String ä¸æ˜¯åŸºç¡€ç±»å‹ï¼Œä½†æ˜¯å®ƒä¹Ÿæœ‰åŒæ ·çš„æœºåˆ¶ï¼Œé€šè¿‡ String Pool æ¥ç¼“å­˜ String å¯¹è±¡ã€‚å‡è®¾ â€œJavaâ€ è¿™ä¸ªå­—ç¬¦ä¸²æˆ‘ä»¬ä¼šåœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨å¤šæ¬¡ï¼Œæˆ‘ä»¬è‚¯å®šä¸å¸Œæœ›åœ¨æ¯æ¬¡ä½¿ç”¨åˆ°çš„æ—¶å€™ï¼Œéƒ½é‡æ–°åœ¨å †ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚</p>
<blockquote>
<p>å½“ç„¶ï¼Œä¹‹æ‰€ä»¥ Integerã€Longã€String è¿™äº›ç±»çš„å¯¹è±¡å¯ä»¥ç¼“å­˜ï¼Œæ˜¯å› ä¸ºå®ƒä»¬æ˜¯ä¸å¯å˜ç±»</p>
</blockquote>
<p>åŸºç¡€ç±»å‹åŒ…è£…ç±»çš„ç¼“å­˜æ± ä½¿ç”¨ä¸€ä¸ªæ•°ç»„è¿›è¡Œç¼“å­˜ï¼Œè€Œ String ç±»å‹ï¼ŒJVM å†…éƒ¨ä½¿ç”¨ HashTable è¿›è¡Œç¼“å­˜ï¼Œæˆ‘ä»¬çŸ¥é“ï¼ŒHashTable çš„ç»“æ„æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªé“¾è¡¨ã€‚å’Œæˆ‘ä»¬å¹³æ—¶ä½¿ç”¨çš„ HashTable ä¸åŒï¼ŒJVM å†…éƒ¨çš„è¿™ä¸ª HashTable æ˜¯ä¸å¯ä»¥åŠ¨æ€æ‰©å®¹çš„ã€‚</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/string/1.png" alt="1"></p>
<h2 id="åˆ›å»ºå’Œå›æ”¶"><a href="#åˆ›å»ºå’Œå›æ”¶" class="headerlink" title="åˆ›å»ºå’Œå›æ”¶"></a>åˆ›å»ºå’Œå›æ”¶</h2><p>å½“æˆ‘ä»¬åœ¨ç¨‹åºä¸­ä½¿ç”¨åŒå¼•å·æ¥è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ä¸²æ—¶ï¼Œè¿™ä¸ªå­—ç¬¦ä¸²å°±ä¼šè¿›å…¥åˆ° String Pool ä¸­ã€‚å½“ç„¶ï¼Œè¿™é‡Œè¯´çš„æ˜¯å·²è¢«åŠ è½½åˆ° JVM ä¸­çš„ç±»ã€‚</p>
<blockquote>
<p>è¿™æ˜¯ä¸€ä¸ªä¸å¤Ÿä¸¥è°¨çš„è¯´æ³•ï¼Œè¯·å‚è§è¯„è®ºåŒºçš„è®¨è®ºã€‚</p>
</blockquote>
<p>å¦å¤–ï¼Œå°±æ˜¯ <strong>String#intern()</strong> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨å°±æ˜¯ï¼š</p>
<ul>
<li>å¦‚æœå­—ç¬¦ä¸²æœªåœ¨ Pool ä¸­ï¼Œé‚£ä¹ˆå°±å¾€ Pool ä¸­å¢åŠ ä¸€æ¡è®°å½•ï¼Œç„¶åè¿”å› Pool ä¸­çš„å¼•ç”¨ã€‚</li>
<li>å¦‚æœå·²ç»åœ¨ Pool ä¸­ï¼Œç›´æ¥è¿”å› Pool ä¸­çš„å¼•ç”¨ã€‚</li>
</ul>
<p>åªè¦ String Pool ä¸­çš„ String å¯¹è±¡å¯¹äº GC Roots æ¥è¯´ä¸å¯è¾¾ï¼Œé‚£ä¹ˆå®ƒä»¬å°±æ˜¯å¯ä»¥è¢«å›æ”¶çš„ã€‚</p>
<p>å¦‚æœ Pool ä¸­å¯¹è±¡è¿‡å¤šï¼Œå¯èƒ½å¯¼è‡´ YGC å˜é•¿ï¼Œå› ä¸º YGC çš„æ—¶å€™ï¼Œéœ€è¦æ‰«æ String Poolï¼Œå¯ä»¥çœ‹çœ‹ç¬¨ç¥å¤§ä½¬çš„æ–‡ç« ã€Š<a target="_blank" rel="noopener" href="http://lovestblog.cn/blog/2016/11/06/string-intern/">JVMæºç åˆ†æä¹‹String.intern()å¯¼è‡´çš„YGCä¸æ–­å˜é•¿</a>ã€‹ã€‚</p>
<h2 id="è®¨è®º-String-Pool-çš„å®ç°"><a href="#è®¨è®º-String-Pool-çš„å®ç°" class="headerlink" title="è®¨è®º String Pool çš„å®ç°"></a>è®¨è®º String Pool çš„å®ç°</h2><p><strong>1ã€é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆè€ƒè™‘ String Pool çš„ç©ºé—´é—®é¢˜ã€‚</strong></p>
<p>åœ¨ Java 6 ä¸­ï¼ŒString Pool ç½®äº PermGen Space ä¸­ï¼ŒPermGen æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯å®ƒæ˜¯ä¸€ä¸ªå›ºå®šå¤§å°çš„åŒºåŸŸï¼Œè™½ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>-XX:MaxPermSize=N</code> æ¥è®¾ç½®æ°¸ä¹…ä»£çš„ç©ºé—´å¤§å°ï¼Œä½†æ˜¯ä¸ç®¡æˆ‘ä»¬è®¾ç½®æˆå¤šå°‘ï¼Œå®ƒç»ˆå½’æ˜¯å›ºå®šçš„ã€‚</p>
<p>æ‰€ä»¥ï¼Œåœ¨ Java 6 ä¸­ï¼Œæˆ‘ä»¬åº”è¯¥å°½é‡å°å¿ƒä½¿ç”¨ String.intern() æ–¹æ³•ï¼Œå¦åˆ™å®¹æ˜“å¯¼è‡´ OutOfMemoryErrorã€‚</p>
<p>åˆ°äº† Java 7ï¼Œå¤§ä½¬ä»¬å·²ç»ç€æ‰‹å»æ‰ PermGen Space äº†ï¼Œé¦–å…ˆï¼Œå°±æ˜¯å°† String Pool ç§»åˆ°äº†å †ä¸­ã€‚</p>
<p>æŠŠ String Pool æ”¾åˆ°å †ä¸­ï¼Œå³ä½¿å †çš„å¤§å°ä¹Ÿæ˜¯å›ºå®šçš„ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™ï¼Œå¯¹äºåº”ç”¨è°ƒä¼˜å·¥ä½œï¼Œåªéœ€è¦è°ƒæ•´å †å¤§å°å°±è¡Œäº†ã€‚</p>
<p><del>åˆ°äº† Java 8ï¼ŒPermGen å·²ç»è¢«å½»åº•åºŸå¼ƒï¼Œå‡ºç°äº†å †å¤–å†…å­˜åŒºåŸŸ MetaSpaceï¼ŒString Pool ç›¸åº”çš„ä»å †è½¬ç§»åˆ°äº† MetaSpace ä¸­ã€‚</del></p>
<blockquote>
<p>åœ¨ Java 8 ä¸­ï¼ŒString Pool ä¾ç„¶è¿˜æ˜¯åœ¨ Heap Space ä¸­ã€‚æ„Ÿè°¢è¯„è®ºåŒºçš„è¯»è€…æŒ‡å‡ºé”™è¯¯ã€‚å¤§å®¶å¯ä»¥çœ‹ä¸€ä¸‹æˆ‘åé¢å†™çš„å…³äº MetaSpace çš„æ–‡ç« ï¼Œé‚£ç¯‡æ–‡ç« æ·±å…¥åˆ†æäº† MetaSpace çš„æ„æˆã€‚</p>
</blockquote>
<p><strong>2ã€å…¶æ¬¡ï¼Œæˆ‘ä»¬å†è®¨è®º String Pool çš„å®ç°é—®é¢˜ã€‚</strong></p>
<p>å‰é¢æˆ‘ä»¬è¯´äº† String Pool ä½¿ç”¨ä¸€ä¸ª HashTable æ¥å®ç°ï¼Œè¿™ä¸ª HashTable <strong>ä¸å¯ä»¥æ‰©å®¹</strong>ï¼Œä¹Ÿå°±æ„å‘³ç€ææœ‰å¯èƒ½å‡ºç°å•ä¸ª bucket ä¸­çš„é“¾è¡¨å¾ˆé•¿ï¼Œå¯¼è‡´æ€§èƒ½é™ä½ã€‚</p>
<p>åœ¨ Java 6 ä¸­ï¼Œè¿™ä¸ª HashTable å›ºå®šçš„ bucket æ•°é‡æ˜¯ 1009ï¼Œåæ¥æ·»åŠ äº†é€‰é¡¹ï¼ˆ**-XX:StringTableSize=N**ï¼‰å¯ä»¥é…ç½®è¿™ä¸ªå€¼ã€‚åˆ° Java 7ï¼ˆ7u40ï¼‰ï¼Œå¤§ä½¬ä»¬æé«˜äº†è¿™ä¸ªé»˜è®¤å€¼åˆ° 60013ï¼ŒJava 8 ä¾ç„¶ä¹Ÿæ˜¯ä½¿ç”¨è¿™ä¸ªå€¼ï¼Œå¯¹äºç»å¤§éƒ¨åˆ†åº”ç”¨æ¥è¯´ï¼Œè¿™ä¸ªå€¼æ˜¯è¶³å¤Ÿç”¨çš„ã€‚å½“ç„¶ï¼Œå¦‚æœä½ ä¼šåœ¨ä»£ç ä¸­å¤§é‡ä½¿ç”¨ String#intern()ï¼Œé‚£ä¹ˆæœ‰å¿…è¦æ‰‹åŠ¨è®¾ç½®ä¸€ä¸‹è¿™ä¸ªå€¼ã€‚</p>
<blockquote>
<p>ä¸ºä»€ä¹ˆæ˜¯ 1009ï¼Œè€Œä¸æ˜¯ 1000 æˆ–è€… 1024ï¼Ÿå› ä¸º 1009 æ˜¯è´¨æ•°ï¼Œæœ‰åˆ©äºè¾¾åˆ°æ›´å¥½çš„æ•£åˆ—ã€‚60013 åŒç†ã€‚</p>
</blockquote>
<p> JVM å†…éƒ¨çš„ HashTable æ˜¯ä¸æ‰©å®¹çš„ï¼Œä½†æ˜¯ä¸ä»£è¡¨å®ƒä¸ rehashï¼Œå®ƒä¼šåœ¨å‘ç°æ•£åˆ—ä¸å‡åŒ€çš„æ—¶å€™è¿›è¡Œ rehashï¼Œè¿™é‡Œä¸å±•å¼€ä»‹ç»ã€‚</p>
<p><strong>3ã€è§‚å¯Ÿ String Pool çš„ä½¿ç”¨æƒ…å†µã€‚</strong></p>
<p>JVM æä¾›äº† <code>-XX:+PrintStringTableStatistics</code> å¯åŠ¨å‚æ•°æ¥å¸®åŠ©æˆ‘ä»¬è·å–ç»Ÿè®¡æ•°æ®ã€‚</p>
<p>é—æ†¾çš„æ˜¯ï¼Œåªæœ‰åœ¨ JVM é€€å‡ºçš„æ—¶å€™ï¼ŒJVM æ‰ä¼šå°†ç»Ÿè®¡æ•°æ®æ‰“å°å‡ºæ¥ï¼ŒJVM æ²¡æœ‰æä¾›æ¥å£ç»™æˆ‘ä»¬å®æ—¶è·å–ç»Ÿè®¡æ•°æ®ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">SymbolTable statistics:</span><br><span class="line">Number of buckets       :     20011 =    160088 bytes, avg   8.000</span><br><span class="line">Number of entries       :     10923 =    262152 bytes, avg  24.000</span><br><span class="line">Number of literals      :     10923 =    425192 bytes, avg  38.926</span><br><span class="line">Total footprint         :           =    847432 bytes</span><br><span class="line">Average bucket size     :     0.546</span><br><span class="line">Variance of bucket size :     0.545</span><br><span class="line">Std. dev. of bucket size:     0.738</span><br><span class="line">Maximum bucket size     :         6</span><br><span class="line">## çœ‹ä¸‹é¢è¿™éƒ¨åˆ†ï¼š</span><br><span class="line">StringTable statistics:</span><br><span class="line">Number of buckets       :     60003 =    480024 bytes, avg   8.000</span><br><span class="line">Number of entries       :   4000774 =  96018576 bytes, avg  24.000</span><br><span class="line">Number of literals      :   4000774 = 1055252184 bytes, avg 263.762</span><br><span class="line">Total footprint         :           = 1151750784 bytes</span><br><span class="line">Average bucket size     :    66.676</span><br><span class="line">Variance of bucket size :    19.843</span><br><span class="line">Std. dev. of bucket size:     4.455</span><br><span class="line">Maximum bucket size     :        84</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç»Ÿè®¡æ•°æ®ä¸­åŒ…å«äº† buckets çš„æ•°é‡ï¼Œæ€»çš„ String å¯¹è±¡çš„æ•°é‡ï¼Œå ç”¨çš„æ€»ç©ºé—´ï¼Œå•ä¸ª bucket çš„é“¾è¡¨å¹³å‡é•¿åº¦å’Œæœ€å¤§é•¿åº¦ç­‰ã€‚</p>
<p>ä¸Šé¢çš„æ•°æ®æ˜¯åœ¨ Java 8 çš„ç¯å¢ƒä¸­æ‰“å°å‡ºæ¥çš„ï¼ŒJava 7 çš„ä¿¡æ¯ç¨å¾®å°‘ä¸€äº›ï¼Œä¸»è¦æ˜¯æ²¡æœ‰ footprint çš„æ•°æ®ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">StringTable statistics:</span><br><span class="line">Number of buckets       :   60003</span><br><span class="line">Average bucket size     :      67</span><br><span class="line">Variance of bucket size :      20</span><br><span class="line">Std. dev. of bucket size:       4</span><br><span class="line">Maximum bucket size     :      84</span><br></pre></td></tr></table></figure>

<h2 id="æµ‹è¯•-String-Pool-çš„æ€§èƒ½"><a href="#æµ‹è¯•-String-Pool-çš„æ€§èƒ½" class="headerlink" title="æµ‹è¯• String Pool çš„æ€§èƒ½"></a>æµ‹è¯• String Pool çš„æ€§èƒ½</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥è·‘ä¸ªæµ‹è¯•ï¼Œæµ‹è¯•ä¸‹ String Pool çš„æ€§èƒ½é—®é¢˜ï¼Œå¹¶è®¨è®º -XX:StringTableSize=N å‚æ•°çš„ä½œç”¨ã€‚</p>
<p>æˆ‘ä»¬å°†ä½¿ç”¨ <code>String#intern()</code> å¾€å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æ·»åŠ  <strong>400ä¸‡</strong> ä¸ªä¸åŒçš„é•¿å­—ç¬¦ä¸²ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.javadoop;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.ref.WeakReference;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.WeakHashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StringTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        test(<span class="number">4000000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(<span class="type">int</span> cnt)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> List&lt;String&gt; lst = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;(<span class="number">1024</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; cnt; ++i) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;Very very very very very very very very very very very very very very &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;very long string: &quot;</span> + i;</span><br><span class="line">            lst.add(str.intern());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">200000</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                System.out.println(i + <span class="number">200000</span> + <span class="string">&quot;; time = &quot;</span> + (System.currentTimeMillis() - start) / <span class="number">1000.0</span> + <span class="string">&quot; sec&quot;</span>);</span><br><span class="line">                start = System.currentTimeMillis();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;Total length = &quot;</span> + lst.size());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ¯æ’å…¥ 20ä¸‡ æ¡æ•°æ®ï¼Œè¾“å‡ºä¸€æ¬¡è€—æ—¶ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç¼–è¯‘</span></span><br><span class="line">javac -d . StringTest.java</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä½¿ç”¨é»˜è®¤ table size (60013) è¿è¡Œä¸€æ¬¡</span></span><br><span class="line">java -Xms2g -Xmx2g com.javadoop.StringTest</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è®¾ç½® table size ä¸º 400031ï¼Œå†è¿è¡Œä¸€æ¬¡</span></span><br><span class="line">java -Xms2g -Xmx2g -XX:StringTableSize=400031 com.javadoop.StringTest</span><br></pre></td></tr></table></figure>

<p><img src="https://assets.javadoop.com/imgs/20510079/string/2.png" alt="2"></p>
<p>ä»å·¦å³ä¸¤éƒ¨åˆ†æ•°æ®å¯ä»¥å¾ˆç›´è§‚çœ‹å‡ºæ¥ï¼Œæ’å…¥çš„æ€§èƒ½ä¸»è¦å–å†³äºé“¾è¡¨çš„å¹³å‡é•¿åº¦ã€‚å½“é“¾è¡¨å¹³å‡é•¿åº¦ä¸º 10 çš„æ—¶å€™ï¼Œæˆ‘ä»¬çœ‹åˆ°æ€§èƒ½æ˜¯å‡ ä¹æ²¡æœ‰ä»»ä½•æŸå¤±çš„ã€‚</p>
<p>è¿˜æ˜¯é‚£å¥è¯ï¼Œæ ¹æ®è‡ªå·±çš„å®é™…æƒ…å†µï¼Œè€ƒè™‘æ˜¯å¦è¦è®¾ç½® -XX:StringTableSize=Nï¼Œè¿˜æ˜¯ä½¿ç”¨é»˜è®¤å€¼ã€‚</p>
<h2 id="è®¨è®ºè‡ªå»º-String-Pool"><a href="#è®¨è®ºè‡ªå»º-String-Pool" class="headerlink" title="è®¨è®ºè‡ªå»º String Pool"></a>è®¨è®ºè‡ªå»º String Pool</h2><p>è¿™ä¸€èŠ‚æˆ‘ä»¬æ¥çœ‹ä¸‹è‡ªå·±ä½¿ç”¨ HashMap æ¥å®ç° String Poolã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ WeakReferenceï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> WeakHashMap&lt;String, WeakReference&lt;String&gt;&gt; pool</span><br><span class="line">            = <span class="keyword">new</span> <span class="title class_">WeakHashMap</span>&lt;String, WeakReference&lt;String&gt;&gt;(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">manualIntern</span><span class="params">(<span class="keyword">final</span> String str)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> WeakReference&lt;String&gt; cached = pool.get(str);</span><br><span class="line">    <span class="keyword">if</span> (cached != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> cached.get();</span><br><span class="line">        <span class="keyword">if</span> (value != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    pool.put(str, <span class="keyword">new</span> <span class="title class_">WeakReference</span>&lt;String&gt;(str));</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ä½¿ç”¨ 1000 * 1000 * 1000 ä½œä¸ºå…¥å‚ cnt çš„å€¼è¿›è¡Œæµ‹è¯•ï¼Œåˆ†åˆ«æµ‹è¯• [1] å’Œ [2]ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(<span class="type">int</span> cnt)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> List&lt;String&gt; lst = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;(<span class="number">1024</span>);</span><br><span class="line">    <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; cnt; ++i) &#123;</span><br><span class="line">      	<span class="comment">// [1]</span></span><br><span class="line">        lst.add(String.valueOf(i).intern());</span><br><span class="line">        <span class="comment">// [2]</span></span><br><span class="line">        <span class="comment">// lst.add(manualIntern(String.valueOf(i)));</span></span><br><span class="line">      </span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">200000</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            System.out.println(i + <span class="number">200000</span> + <span class="string">&quot;; time = &quot;</span> + (System.currentTimeMillis() - start) / <span class="number">1000.0</span> + <span class="string">&quot; sec&quot;</span>);</span><br><span class="line">            start = System.currentTimeMillis();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;Total length = &quot;</span> + lst.size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ç»“æœï¼Œ2G çš„å †å¤§å°ï¼Œå¦‚æœä½¿ç”¨ <code>String#intern()</code>ï¼Œå¤§æ¦‚åœ¨æ’å…¥ 3000ä¸‡ æ•°æ®çš„æ—¶å€™ï¼Œå¼€å§‹è¿›å…¥å¤§é‡çš„ FullGCã€‚</p>
<p>è€Œä½¿ç”¨è‡ªå·±å†™çš„ <code>manualIntern()</code>ï¼Œå¤§æ¦‚åˆ° 1400ä¸‡ çš„æ—¶å€™ï¼Œå°±å·²ç»ä¸è¡Œäº†ã€‚</p>
<p>æ²¡ä»€ä¹ˆç»“è®ºï¼Œå¦‚æœè¦è¯´ç‚¹ä»€ä¹ˆçš„è¯ï¼Œé‚£å°±æ˜¯ä¸è¦è‡ªå»º String Poolï¼Œæ²¡å¿…è¦ã€‚</p>
<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>è®°ä½æœ‰ä¸¤ä¸ª JVM å‚æ•°å¯ä»¥è®¾ç½®ï¼š-XX:StringTableSize=Nã€-XX:+PrintStringTableStatistics</p>
<p>StringTableSizeï¼Œåœ¨ Java 6 ä¸­ï¼Œæ˜¯ 1009ï¼›åœ¨ Java 7 å’Œ Java 8 ä¸­ï¼Œé»˜è®¤éƒ½æ˜¯ 60013ï¼Œå¦‚æœæœ‰å¿…è¦è¯·è‡ªè¡Œæ‰©å¤§è¿™ä¸ªå€¼ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p>Java Performance Tuning Guide: <a target="_blank" rel="noopener" href="http://java-performance.info/string-intern-in-java-6-7-8/">String.intern in Java 6, 7 and 8 â€“ string pooling</a></p>
<p>ç¬¨ç¥æ˜¯çœŸæ­£çš„å¤§ä½¬ï¼š<a target="_blank" rel="noopener" href="http://lovestblog.cn/blog/2016/11/06/string-intern/">JVMæºç åˆ†æä¹‹String.intern()å¯¼è‡´çš„YGCä¸æ–­å˜é•¿</a></p>
<p>ï¼ˆå…¨æ–‡å®Œï¼‰</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://scatteredream.github.io/2019/12/24/jvm-metaspace/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/62317679?s=400&v=4">
      <meta itemprop="name" content="ç¢æ¢¦">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="scatteredream's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | scatteredream's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/12/24/jvm-metaspace/" class="post-title-link" itemprop="url">æ·±å…¥ç†è§£å †å¤–å†…å­˜ Metaspace</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2019-12-24 00:00:00" itemprop="dateCreated datePublished" datetime="2019-12-24T00:00:00+08:00">2019-12-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-05-08 13:32:41" itemprop="dateModified" datetime="2025-05-08T13:32:41+08:00">2025-05-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/jvm/" itemprop="url" rel="index"><span itemprop="name">jvm</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>åœ¨ä¹‹å‰ä»‹ç»çš„åˆ†ä»£åƒåœ¾å›æ”¶ç®—æ³•ä¸­ï¼Œæˆ‘ä»¬ä¸€ç›´æœ‰ä¸€ä¸ª<strong>æ°¸ä¹…ä»£</strong>å­˜åœ¨ï¼Œå« PermGenï¼Œå†…å­˜ä¸Šå®ƒæ˜¯æŒ¨ç€å †çš„ã€‚ä¸ºäº†åƒåœ¾å›æ”¶æ–¹ä¾¿ï¼ŒHotSpot åœ¨æ°¸ä¹…ä»£ä¸Šä¸€ç›´æ˜¯ä½¿ç”¨è€å¹´ä»£çš„åƒåœ¾å›æ”¶ç®—æ³•ã€‚</p>
<p>æ°¸ä¹…ä»£ä¸»è¦å­˜æ”¾ä»¥ä¸‹æ•°æ®ï¼š</p>
<ul>
<li>JVM internal representation of classes and their metadata</li>
<li>Class statics</li>
<li>Interned strings</li>
</ul>
<p>ä» JDK7 å¼€å§‹ï¼ŒJDK å¼€å‘è€…ä»¬å°±æœ‰æ¶ˆç­æ°¸ä¹…ä»£çš„æ‰“ç®—äº†ã€‚æœ‰éƒ¨åˆ†æ•°æ®ç§»åˆ°æ°¸ä¹…ä»£ä¹‹å¤–äº†ï¼š</p>
<ul>
<li>Symbols =&gt; native memory</li>
<li>Interned strings =&gt; Java Heap </li>
<li>Class statics =&gt; Java Heap</li>
</ul>
<p>åˆ°äº† JDK8ï¼Œè¿™ä¸ªå·¥ä½œç»ˆäºå®Œæˆäº†ï¼Œå½»åº•åºŸå¼ƒäº† PermGenï¼ŒMetaspace å–è€Œä»£ä¹‹ã€‚</p>
<p>æœ¬æ–‡çš„å†…å®¹ä¸»è¦æ˜¯ç¿»è¯‘ Thomas StÃ¼fe çš„ <a target="_blank" rel="noopener" href="https://stuefe.de/posts/metaspace/what-is-metaspace/">Metaspace ç³»åˆ—æ–‡ç« </a>ï¼Œä»–æ˜¯ OpenJDK Committer/Reviewer. JVM developer at SAPï¼Œä¸€çœ‹ Title å°±å¾ˆé è°±ï¼Œå› ä¸ºä»–æ˜¯ JVM å¼€å‘è€…ï¼Œå½“ç„¶ä¸»è¦æ˜¯å†…å®¹ä¹Ÿå†™å¾—éå¸¸æ£’ã€‚</p>
<p>å½“ç„¶äº†ï¼Œæˆ‘ä¸æ˜¯ä¸€å­—ä¸€å¥ç¿»è¯‘ï¼Œæ–‡ä¸­ä¼šåˆ æ‰éƒ¨åˆ†ç´¯èµ˜çš„å†…å®¹ï¼Œè®²æ¸…æ¥šå°±å¯ä»¥äº†ã€‚åŒæ—¶ï¼ŒåŸæ–‡ç¬¬äº”ç¯‡æ˜¯ä»‹ç»ä½¿ç”¨ jcmd å·¥å…·è§‚å¯Ÿ Metaspace çš„ç©ºé—´ä½¿ç”¨æƒ…å†µï¼Œè¿™ä¸€èŠ‚æˆ‘è§‰å¾—æ²¡æœ‰å¿…è¦ä»‹ç»ï¼Œæ‰€ä»¥æ²¡æœ‰åŠ è¿›æ¥ã€‚</p>
<h2 id="1ã€ä»€ä¹ˆæ˜¯-Metaspace"><a href="#1ã€ä»€ä¹ˆæ˜¯-Metaspace" class="headerlink" title="1ã€ä»€ä¹ˆæ˜¯ Metaspace"></a>1ã€ä»€ä¹ˆæ˜¯ Metaspace</h2><p>Metaspace åŒºåŸŸä½äºå †å¤–ï¼Œæ‰€ä»¥å®ƒçš„æœ€å¤§å†…å­˜å¤§å°å–å†³äºç³»ç»Ÿå†…å­˜ï¼Œè€Œä¸æ˜¯å †å¤§å°ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®š MaxMetaspaceSize å‚æ•°æ¥é™å®šå®ƒçš„æœ€å¤§å†…å­˜ã€‚</p>
<p>Metaspace æ˜¯ç”¨æ¥å­˜æ”¾ class metadata çš„ï¼Œclass metadata ç”¨äºè®°å½•ä¸€ä¸ª Java ç±»åœ¨ JVM ä¸­çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä½†ä¸é™äº <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html">JVM class file format</a> çš„è¿è¡Œæ—¶æ•°æ®ï¼š </p>
<p>1ã€Klass ç»“æ„ï¼Œè¿™ä¸ªéå¸¸é‡è¦ï¼ŒæŠŠå®ƒç†è§£ä¸ºä¸€ä¸ª Java ç±»åœ¨è™šæ‹Ÿæœºå†…éƒ¨çš„è¡¨ç¤ºå§ï¼›</p>
<p>2ã€method metadataï¼ŒåŒ…æ‹¬æ–¹æ³•çš„å­—èŠ‚ç ã€å±€éƒ¨å˜é‡è¡¨ã€å¼‚å¸¸è¡¨ã€å‚æ•°ä¿¡æ¯ç­‰ï¼›</p>
<p>3ã€å¸¸é‡æ± ï¼›</p>
<p>4ã€æ³¨è§£ï¼›</p>
<p>5ã€æ–¹æ³•è®¡æ•°å™¨ï¼Œè®°å½•æ–¹æ³•è¢«æ‰§è¡Œçš„æ¬¡æ•°ï¼Œç”¨æ¥è¾…åŠ© JIT å†³ç­–ï¼›</p>
<p>6ã€ å…¶ä»–</p>
<p>è™½ç„¶æ¯ä¸ª Java ç±»éƒ½å…³è”äº†ä¸€ä¸ª <code>java.lang.Class</code> çš„å®ä¾‹ï¼Œè€Œä¸”å®ƒæ˜¯ä¸€ä¸ªè´®å­˜åœ¨å †ä¸­çš„ Java å¯¹è±¡ã€‚ä½†æ˜¯ç±»çš„ class metadata ä¸æ˜¯ä¸€ä¸ª Java å¯¹è±¡ï¼Œå®ƒä¸åœ¨å †ä¸­ï¼Œè€Œæ˜¯åœ¨ Metaspace ä¸­ã€‚</p>
<h3 id="ä»€ä¹ˆæ—¶å€™åˆ†é…-Metaspace-ç©ºé—´"><a href="#ä»€ä¹ˆæ—¶å€™åˆ†é…-Metaspace-ç©ºé—´" class="headerlink" title="ä»€ä¹ˆæ—¶å€™åˆ†é… Metaspace ç©ºé—´"></a>ä»€ä¹ˆæ—¶å€™åˆ†é… Metaspace ç©ºé—´</h3><p>å½“ä¸€ä¸ªç±»è¢«åŠ è½½æ—¶ï¼Œå®ƒçš„ç±»åŠ è½½å™¨ä¼šè´Ÿè´£åœ¨ Metaspace ä¸­åˆ†é…ç©ºé—´ç”¨äºå­˜æ”¾è¿™ä¸ªç±»çš„å…ƒæ•°æ®ã€‚</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/metaspace/metaspace-lifecycle-allocation.png" alt="Metadata lifecycle - Allocation"></p>
<p>ä¸Šé¢è¿™ä¸ªç¤ºæ„å›¾éå¸¸ç®€å•ï¼Œå¯ä»¥çœ‹åˆ°åœ¨ <code>Id</code> è¿™ä¸ªç±»åŠ è½½å™¨ç¬¬ä¸€æ¬¡åŠ è½½ç±» <code>X</code> å’Œ <code>Y</code> çš„æ—¶å€™ï¼Œåœ¨ Metaspace ä¸­ä¸ºå®ƒä»¬å¼€è¾Ÿç©ºé—´å­˜æ”¾å…ƒä¿¡æ¯ã€‚</p>
<h3 id="ä»€ä¹ˆæ—¶å€™å›æ”¶-Metaspace-ç©ºé—´"><a href="#ä»€ä¹ˆæ—¶å€™å›æ”¶-Metaspace-ç©ºé—´" class="headerlink" title="ä»€ä¹ˆæ—¶å€™å›æ”¶ Metaspace ç©ºé—´"></a>ä»€ä¹ˆæ—¶å€™å›æ”¶ Metaspace ç©ºé—´</h3><p>åˆ†é…ç»™ä¸€ä¸ªç±»çš„ç©ºé—´ï¼Œæ˜¯å½’å±äºè¿™ä¸ªç±»çš„ç±»åŠ è½½å™¨çš„ï¼Œåªæœ‰å½“è¿™ä¸ªç±»åŠ è½½å™¨å¸è½½çš„æ—¶å€™ï¼Œè¿™ä¸ªç©ºé—´æ‰ä¼šè¢«é‡Šæ”¾ã€‚</p>
<p>æ‰€ä»¥ï¼Œåªæœ‰å½“è¿™ä¸ªç±»åŠ è½½å™¨åŠ è½½çš„æ‰€æœ‰ç±»éƒ½æ²¡æœ‰å­˜æ´»çš„å¯¹è±¡ï¼Œå¹¶ä¸”æ²¡æœ‰åˆ°è¾¾è¿™äº›ç±»å’Œç±»åŠ è½½å™¨çš„å¼•ç”¨æ—¶ï¼Œç›¸åº”çš„ Metaspace ç©ºé—´æ‰ä¼šè¢« GC é‡Šæ”¾ã€‚çœ‹ä¸‹å›¾ï¼š</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/metaspace/metaspace-lifecycle-deallocation.png" alt="Metadata lifecycle - Deallocation"></p>
<p>æ‰€ä»¥ï¼Œä¸€ä¸ª Java ç±»åœ¨ Metaspace ä¸­å ç”¨çš„ç©ºé—´ï¼Œå®ƒæ˜¯å¦é‡Šæ”¾ï¼Œå–å†³äºè¿™ä¸ªç±»çš„ç±»åŠ è½½å™¨æ˜¯å¦è¢«å¸è½½ã€‚</p>
<h3 id="å†…å­˜é€šå¸¸ä¼šè¢«ä¿ç•™"><a href="#å†…å­˜é€šå¸¸ä¼šè¢«ä¿ç•™" class="headerlink" title="å†…å­˜é€šå¸¸ä¼šè¢«ä¿ç•™"></a>å†…å­˜é€šå¸¸ä¼šè¢«ä¿ç•™</h3><p>é‡Šæ”¾ Metaspace çš„ç©ºé—´ï¼Œå¹¶ä¸æ„å‘³ç€å°†è¿™éƒ¨åˆ†ç©ºé—´è¿˜ç»™ç³»ç»Ÿå†…å­˜ï¼Œè¿™éƒ¨åˆ†ç©ºé—´é€šå¸¸ä¼šè¢« JVM ä¿ç•™ä¸‹æ¥ã€‚</p>
<p>è¿™éƒ¨åˆ†è¢«ä¿ç•™çš„ç©ºé—´æœ‰å¤šå¤§ï¼Œå–å†³äº Metaspace çš„ç¢ç‰‡åŒ–ç¨‹åº¦ã€‚å¦å¤–ï¼ŒMetaspace ä¸­æœ‰ä¸€éƒ¨åˆ†åŒºåŸŸ Compressed Class Space æ˜¯ä¸€å®šä¸ä¼šè¿˜ç»™æ“ä½œç³»ç»Ÿçš„ã€‚</p>
<blockquote>
<p>è¿™é‡Œå…ˆäº†è§£æ¦‚å¿µï¼Œåé¢éƒ½ä¼šå±•å¼€æ¥è¯´ã€‚</p>
</blockquote>
<h3 id="é…ç½®-Metaspace-ç©ºé—´"><a href="#é…ç½®-Metaspace-ç©ºé—´" class="headerlink" title="é…ç½® Metaspace ç©ºé—´"></a>é…ç½® Metaspace ç©ºé—´</h3><p>æˆ‘ä»¬åªéœ€è¦å…³å¿ƒä¸¤ä¸ªé…ç½®å‚æ•°ï¼š</p>
<ul>
<li><p><code>-XX:MaxMetaspaceSize</code>ï¼šMetaspace æ€»ç©ºé—´çš„æœ€å¤§å…è®¸ä½¿ç”¨å†…å­˜ï¼Œé»˜è®¤æ˜¯ä¸é™åˆ¶ã€‚</p>
</li>
<li><p><code>-XX:CompressedClassSpaceSize</code>ï¼šMetaspace ä¸­çš„ Compressed Class Space çš„æœ€å¤§å…è®¸å†…å­˜ï¼Œé»˜è®¤å€¼æ˜¯ 1Gï¼Œè¿™éƒ¨åˆ†ä¼šåœ¨ JVM å¯åŠ¨çš„æ—¶å€™å‘æ“ä½œç³»ç»Ÿç”³è¯· 1G çš„è™šæ‹Ÿåœ°å€æ˜ å°„ï¼Œä½†ä¸æ˜¯çœŸçš„å°±ç”¨äº†æ“ä½œç³»ç»Ÿçš„ 1G å†…å­˜ã€‚</p>
</li>
</ul>
<h3 id="Metaspace-å’Œ-GC"><a href="#Metaspace-å’Œ-GC" class="headerlink" title="Metaspace å’Œ GC"></a>Metaspace å’Œ GC</h3><p>Metaspace åªåœ¨ GC è¿è¡Œå¹¶ä¸”å¸è½½ç±»åŠ è½½å™¨çš„æ—¶å€™æ‰ä¼šé‡Šæ”¾ç©ºé—´ã€‚å½“ç„¶ï¼Œåœ¨æŸäº›æ—¶å€™ï¼Œéœ€è¦ä¸»åŠ¨è§¦å‘ GC æ¥å›æ”¶ä¸€äº›æ²¡ç”¨çš„ class metadataï¼Œå³ä½¿è¿™ä¸ªæ—¶å€™å¯¹äºå †ç©ºé—´æ¥è¯´ï¼Œè¿˜è¾¾ä¸åˆ° GC çš„æ¡ä»¶ã€‚</p>
<p>Metaspace å¯èƒ½åœ¨ä¸¤ç§æƒ…å†µä¸‹è§¦å‘ GCï¼š</p>
<p>1ã€åˆ†é…ç©ºé—´æ—¶ï¼šè™šæ‹Ÿæœºç»´æŠ¤äº†ä¸€ä¸ªé˜ˆå€¼ï¼Œå¦‚æœ Metaspace çš„ç©ºé—´å¤§å°è¶…è¿‡äº†è¿™ä¸ªé˜ˆå€¼ï¼Œé‚£ä¹ˆåœ¨æ–°çš„ç©ºé—´åˆ†é…ç”³è¯·æ—¶ï¼Œè™šæ‹Ÿæœºé¦–å…ˆä¼šé€šè¿‡æ”¶é›†å¯ä»¥å¸è½½çš„ç±»åŠ è½½å™¨æ¥è¾¾åˆ°å¤ç”¨ç©ºé—´çš„ç›®çš„ï¼Œè€Œä¸æ˜¯æ‰©å¤§ Metaspace çš„ç©ºé—´ï¼Œè¿™ä¸ªæ—¶å€™ä¼šè§¦å‘ GCã€‚è¿™ä¸ªé˜ˆå€¼ä¼šä¸Šä¸‹è°ƒæ•´ï¼Œå’Œ Metaspace å·²ç»å ç”¨çš„æ“ä½œç³»ç»Ÿå†…å­˜ä¿æŒä¸€ä¸ªè·ç¦»ã€‚</p>
<p>2ã€ç¢°åˆ° Metaspace OOMï¼šMetaspace çš„æ€»ä½¿ç”¨ç©ºé—´è¾¾åˆ°äº† MaxMetaspaceSize è®¾ç½®çš„é˜ˆå€¼ï¼Œæˆ–è€… Compressed Class Space è¢«ä½¿ç”¨å…‰äº†ï¼Œå¦‚æœè¿™æ¬¡ GC çœŸçš„é€šè¿‡å¸è½½ç±»åŠ è½½å™¨è…¾å‡ºäº†å¾ˆå¤šçš„ç©ºé—´ï¼Œè¿™å¾ˆå¥½ï¼Œå¦åˆ™çš„è¯ï¼Œæˆ‘ä»¬ä¼šè¿›å…¥ä¸€ä¸ªç³Ÿç³•çš„ GC å‘¨æœŸï¼Œå³ä½¿æˆ‘ä»¬æœ‰è¶³å¤Ÿçš„å †å†…å­˜ã€‚</p>
<blockquote>
<p>æ‰€ä»¥å¤§å®¶åƒä¸‡ä¸è¦æŠŠ MaxMetaspaceSize è®¾ç½®å¾—å¤ªå°ã€‚</p>
</blockquote>
<h2 id="2ã€Metaspace-çš„æ¶æ„"><a href="#2ã€Metaspace-çš„æ¶æ„" class="headerlink" title="2ã€Metaspace çš„æ¶æ„"></a>2ã€Metaspace çš„æ¶æ„</h2><p>è¿™ä¸€èŠ‚å°†æ·±å…¥åˆ° Metaspace çš„æ¶æ„å®ç°ï¼Œå°†æè¿°å®ƒçš„æ¯ä¸€å±‚å’Œæ¯ä¸€ä¸ªç»„ä»¶ï¼Œä»¥åŠå®ƒä»¬æ˜¯æ€ä¹ˆå·¥ä½œçš„ã€‚</p>
<p>å¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œè¿™ä¸€å®šæ˜¯éå¸¸æœ‰è¶£çš„ä¸€ä»¶äº‹æƒ…ï¼Œæˆ‘ä»¬å¤§éƒ¨åˆ†å¼€å‘è€…éƒ½ä¸å¯èƒ½å»å¼€å‘ JDKï¼Œä½†æ˜¯äº†è§£è¿™äº›æ€»æ˜¯å……æ»¡ç€ä¹è¶£ã€‚</p>
<p>Metaspace åœ¨å®ç°ä¸Šåˆ†ä¸ºå¤šå±‚ã€‚æœ€åº•å±‚ï¼Œè´Ÿè´£å‘æ“ä½œç³»ç»Ÿç”³è¯·å¤§å—çš„å†…å­˜ï¼›ä¸­é—´çš„ä¸€å±‚ï¼Œè´Ÿè´£åˆ†å‡ºä¸€å°å—ä¸€å°å—ç»™æ¯ä¸ªç±»åŠ è½½å™¨ï¼›æœ€é¡¶å±‚ï¼Œç±»åŠ è½½å™¨è´Ÿè´£æŠŠè¿™äº›ç”³è¯·åˆ°çš„å†…å­˜å—ç”¨æ¥å­˜æ”¾ class metadataã€‚</p>
<h3 id="æœ€åº•å±‚ï¼šthe-space-list"><a href="#æœ€åº•å±‚ï¼šthe-space-list" class="headerlink" title="æœ€åº•å±‚ï¼šthe space list"></a>æœ€åº•å±‚ï¼šthe space list</h3><p>åœ¨æœ€åº•å±‚ï¼ŒJVM é€šè¿‡ <code>mmap(3)</code> æ¥å£å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜æ˜ å°„ï¼Œåœ¨ 64 ä½å¹³å°ä¸Šï¼Œæ¯æ¬¡ç”³è¯· <strong>2MB</strong> ç©ºé—´ã€‚</p>
<blockquote>
<p>å½“ç„¶ï¼Œè¿™é‡Œçš„ 2MB ä¸æ˜¯çœŸçš„å°±æ¶ˆè€—äº†ä¸»å­˜çš„ 2MBï¼Œåªæœ‰ä¹‹ååœ¨ä½¿ç”¨çš„æ—¶å€™æ‰ä¼šçœŸçš„æ¶ˆè€—å†…å­˜ã€‚è¿™é‡Œæ˜¯è™šæ‹Ÿå†…å­˜æ˜ å°„ã€‚</p>
</blockquote>
<p>æ¯æ¬¡ç”³è¯·è¿‡æ¥çš„å†…å­˜åŒºåŸŸï¼Œæ”¾åˆ°ä¸€ä¸ªé“¾è¡¨ä¸­ <a target="_blank" rel="noopener" href="http://hg.openjdk.java.net/jdk/jdk11/file/1ddf9a99e4ad/src/hotspot/share/memory/metaspace/virtualSpaceList.hpp#l39"><em>VirtualSpaceList</em></a>ï¼Œä½œä¸ºå…¶ä¸­çš„ä¸€ä¸ª Nodeã€‚çœ‹ä¸‹å›¾ã€‚</p>
<p>ä¸€ä¸ª Node æ˜¯ 2MB çš„ç©ºé—´ï¼Œå‰é¢è¯´äº†åœ¨ä½¿ç”¨çš„æ—¶å€™å†å‘æ“ä½œç³»ç»Ÿç”³è¯·å®é™…çš„å†…å­˜ï¼Œä½†æ˜¯é¢‘ç¹çš„ç³»ç»Ÿè°ƒç”¨ä¼šé™ä½æ€§èƒ½ï¼Œæ‰€ä»¥ Node å†…éƒ¨éœ€è¦ç»´æŠ¤ä¸€ä¸ªæ°´ä½çº¿ï¼Œå½“ Node å†…å·²ä½¿ç”¨å†…å­˜å¿«è¾¾åˆ°æ°´ä½çº¿çš„æ—¶å€™ï¼Œå‘æ“ä½œç³»ç»Ÿè¦æ–°çš„å†…å­˜é¡µã€‚å¹¶ä¸”ç›¸åº”åœ°æé«˜æ°´ä½çº¿ã€‚</p>
<p>ç›´åˆ°ä¸€ä¸ª Node è¢«å®Œå…¨ç”¨å®Œï¼Œä¼šåˆ†é…ä¸€ä¸ªæ–°çš„ Nodeï¼Œå¹¶ä¸”å°†å…¶åŠ å…¥åˆ°é“¾è¡¨ä¸­ï¼Œè€çš„ Node å°± â€œé€€ä¼‘â€ äº†ã€‚ä¸‹å›¾ä¸­ï¼Œå‰é¢çš„ä¸‰ä¸ª Node å°±æ˜¯é€€ä¼‘çŠ¶æ€äº†ã€‚</p>
<p>ä»ä¸€ä¸ª Node ä¸­åˆ†é…å†…å­˜ï¼Œæ¯ä¸€å—ç§°ä¸º MetaChunkï¼Œchunk æœ‰ä¸‰ç§è§„æ ¼ï¼Œåœ¨ 64 ä½ç³»ç»Ÿä¸­åˆ†åˆ«ä¸º 1Kã€4Kã€64Kã€‚</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/metaspace/metaspace-vslist.png" alt="alt text"></p>
<p>é“¾è¡¨ VirtualSpaceList å’Œæ¯ä¸ªèŠ‚ç‚¹ Node æ˜¯å…¨å±€çš„ï¼Œè€Œ Node å†…éƒ¨çš„ä¸€ä¸ªä¸ª MetaChunk æ˜¯åˆ†é…ç»™æ¯ä¸ªç±»åŠ è½½å™¨çš„ã€‚æ‰€ä»¥ä¸€ä¸ª Node é€šå¸¸ç”±åˆ†é…ç»™å¤šä¸ªç±»åŠ è½½å™¨çš„ chunks ç»„æˆã€‚</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/metaspace/metaspace-vsnode-multiple-loaders.png" alt="alt text"></p>
<p>å½“ä¸€ä¸ªç±»åŠ è½½å™¨å’Œå®ƒåŠ è½½çš„æ‰€æœ‰çš„ç±»éƒ½å¸è½½çš„æ—¶å€™ï¼Œå®ƒå ç”¨çš„ chunks å°±ä¼šåŠ å…¥åˆ°ä¸€ä¸ªå…¨å±€çš„ç©ºé—²åˆ—è¡¨ä¸­ï¼š<a target="_blank" rel="noopener" href="http://hg.openjdk.java.net/jdk/jdk11/file/1ddf9a99e4ad/src/hotspot/share/memory/metaspace/chunkManager.hpp#l44"><em>ChunkManager</em></a>ï¼Œçœ‹ä¸‹å›¾ï¼š</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/metaspace/metaspace-vsnode-multiple-loaders-one-dies.png" alt="alt text"></p>
<p>è¿™äº› chunks ä¼šè¢«å¤ç”¨ï¼šå¦‚æœå…¶ä»–çš„ç±»åŠ è½½å™¨åŠ è½½æ–°çš„ç±»ï¼Œå®ƒå¯èƒ½å°±ä¼šå¾—åˆ°ä¸€ä¸ªç©ºé—²åˆ—è¡¨ä¸­çš„ chunkï¼Œè€Œä¸æ˜¯å» Node ä¸­ç”³è¯·ä¸€ä¸ªæ–°çš„ chunkã€‚</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/metaspace/metaspace-vsnode-multiple-loaders-chunk-reused.png" alt="alt text"></p>
<blockquote>
<p>åé¢ä¼šè¯´åˆ°ï¼Œå¦‚æœåˆšå¥½æŠŠæ•´ä¸ª Node éƒ½æ¸…ç©ºäº†ï¼Œé‚£ä¹ˆè¿™æ•´ä¸ª Node çš„å†…å­˜ä¼šç›´æ¥è¿˜ç»™æ“ä½œç³»ç»Ÿã€‚</p>
<p>å½“ç„¶ï¼Œç”±è¿™ä¸ª Node è¿›å…¥åˆ°ç©ºé—²åˆ—è¡¨çš„èŠ‚ç‚¹ä¹Ÿè¦åˆ é™¤ã€‚</p>
</blockquote>
<h3 id="ä¸­é—´å±‚ï¼šMetachunk"><a href="#ä¸­é—´å±‚ï¼šMetachunk" class="headerlink" title="ä¸­é—´å±‚ï¼šMetachunk"></a>ä¸­é—´å±‚ï¼šMetachunk</h3><p>é€šå¸¸ä¸€ä¸ªç±»åŠ è½½å™¨åœ¨ç”³è¯· Metaspace ç©ºé—´ç”¨æ¥å­˜æ”¾ metadata çš„æ—¶å€™ï¼Œä¹Ÿå°±éœ€è¦å‡ ååˆ°å‡ ç™¾ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯å®ƒä¼šå¾—åˆ°ä¸€ä¸ª Metachunkï¼Œä¸€ä¸ªæ¯”è¦æ±‚çš„å†…å­˜å¤§å¾—å¤šçš„å†…å­˜å—ã€‚</p>
<p>ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºå‰é¢è¯´äº†ï¼Œè¦ä»å…¨å±€çš„ <code>VirtualSpaceList</code> é“¾è¡¨çš„ Node ä¸­åˆ†é…å†…å­˜æ˜¯æ˜‚è´µçš„æ“ä½œï¼Œéœ€è¦åŠ é”ã€‚æˆ‘ä»¬ä¸å¸Œæœ›è¿™ä¸ªæ“ä½œå¤ªé¢‘ç¹ï¼Œæ‰€ä»¥ä¸€æ¬¡æ€§ç»™ä¸€ä¸ªå¤§çš„ MetaChunkï¼Œä»¥ä¾¿äºè¿™ä¸ªç±»åŠ è½½å™¨ä¹‹ååŠ è½½å…¶ä»–çš„ç±»ï¼Œè¿™æ ·å°±å¯ä»¥åšåˆ°å¤šä¸ªç±»åŠ è½½å™¨å¹¶å‘åˆ†é…äº†ã€‚åªæœ‰å½“è¿™ä¸ª chunk ç”¨å®Œäº†ï¼Œç±»åŠ è½½å™¨æ‰éœ€è¦åˆå» <code>VirtualSpaceList</code> ç”³è¯·æ–°çš„ chunkã€‚</p>
<p>å‰é¢è¯´äº†ï¼Œchunk æœ‰ä¸‰ç§è§„æ ¼ï¼Œé‚£ Metaspace çš„åˆ†é…å™¨æ€ä¹ˆçŸ¥é“ä¸€ä¸ªç±»åŠ è½½å™¨æ¯æ¬¡è¦å¤šå¤§çš„ chunk å‘¢ï¼Ÿè¿™å½“ç„¶æ˜¯åŸºäºçŒœæµ‹çš„ï¼š</p>
<ul>
<li>é€šå¸¸ï¼Œä¸€ä¸ªæ ‡å‡†çš„ç±»åŠ è½½å™¨åœ¨ç¬¬ä¸€æ¬¡ç”³è¯·ç©ºé—´æ—¶ï¼Œä¼šå¾—åˆ°ä¸€ä¸ª 4K çš„ chunkï¼Œç›´åˆ°å®ƒè¾¾åˆ°äº†ä¸€ä¸ªéšæ„è®¾ç½®çš„é˜ˆå€¼ï¼ˆ4ï¼‰ï¼Œæ­¤æ—¶åˆ†é…å™¨å¤±å»äº†è€å¿ƒï¼Œä¹‹åä¼šä¸€æ¬¡æ€§ç»™å®ƒä¸€ä¸ª 64K çš„å¤§ chunkã€‚</li>
<li>bootstrap classloader æ˜¯ä¸€ä¸ªå…¬è®¤çš„ä¼šåŠ è½½å¤§é‡çš„ç±»çš„åŠ è½½å™¨ï¼Œæ‰€ä»¥åˆ†é…å™¨ä¼šç»™å®ƒä¸€ä¸ªå·¨å¤§çš„ chunkï¼Œä¸€å¼€å§‹å°±ä¼šç»™å®ƒ 4Mã€‚å¯ä»¥é€šè¿‡ InitialBootClassLoaderMetaspaceSize è¿›è¡Œè°ƒä¼˜ã€‚</li>
<li>åå°„ç±»ç±»åŠ è½½å™¨ (<code>jdk.internal.reflect.DelegatingClassLoader</code>) å’ŒåŒ¿åç±»ç±»åŠ è½½å™¨åªä¼šåŠ è½½ä¸€ä¸ªç±»ï¼Œæ‰€ä»¥ä¸€å¼€å§‹åªä¼šç»™å®ƒä»¬ä¸€ä¸ªéå¸¸å°çš„ chunkï¼ˆ1Kï¼‰ï¼Œå› ä¸ºç»™å®ƒä»¬å¤ªå¤šå°±æ˜¯ä¸€ç§æµªè´¹ã€‚</li>
</ul>
<p>ç±»åŠ è½½å™¨ç”³è¯·ç©ºé—´çš„æ—¶å€™ï¼Œæ¯æ¬¡éƒ½ç»™ç±»åŠ è½½å™¨ä¸€ä¸ª chunkï¼Œè¿™ç§ä¼˜åŒ–ï¼Œæ˜¯å»ºç«‹åœ¨å‡è®¾å®ƒä»¬ç«‹é©¬å°±ä¼šéœ€è¦æ–°çš„ç©ºé—´çš„åŸºç¡€ä¸Šçš„ã€‚è¿™ç§å‡è®¾å¯èƒ½æ­£ç¡®ä¹Ÿå¯èƒ½é”™è¯¯ï¼Œå¯èƒ½åœ¨æ‹¿åˆ°ä¸€ä¸ªå¾ˆå¤§çš„ chunk åï¼Œè¿™ä¸ªç±»åŠ è½½å™¨æ°å·§å°±ä¸å†éœ€è¦åŠ è½½æ–°çš„ç±»äº†ã€‚</p>
<blockquote>
<p>å¯¹äºè¿™éƒ¨åˆ†å¯èƒ½çš„ç©ºé—´æµªè´¹ï¼Œå¯ä»¥åœ¨åé¢ä»‹ç»çš„ç³»ç»Ÿå·¥å…·ä¸­è§‚å¯Ÿåˆ°ã€‚</p>
</blockquote>
<h3 id="æœ€é¡¶å±‚ï¼šMetablock"><a href="#æœ€é¡¶å±‚ï¼šMetablock" class="headerlink" title="æœ€é¡¶å±‚ï¼šMetablock"></a>æœ€é¡¶å±‚ï¼šMetablock</h3><p>åœ¨ Metachunk ä¸Šï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªäºŒçº§åˆ†é…å™¨ï¼ˆclass-loader-local allocatorï¼‰ï¼Œå®ƒå°†ä¸€ä¸ª Metachunk åˆ†å‰²æˆä¸€ä¸ªä¸ªå°çš„å•å…ƒï¼Œè¿™äº›å°çš„å•å…ƒç§°ä¸º Metablockï¼Œå®ƒä»¬æ˜¯å®é™…åˆ†é…ç»™æ¯ä¸ªè°ƒç”¨è€…çš„ã€‚</p>
<p>è¿™ä¸ªäºŒçº§åˆ†é…å™¨éå¸¸åŸå§‹ï¼Œå®ƒçš„é€Ÿåº¦ä¹Ÿéå¸¸å¿«ï¼š</p>
<p>å‰é¢è¯´è¿‡ï¼Œclass metadata çš„ç”Ÿå‘½å‘¨æœŸæ˜¯å’Œç±»åŠ è½½å™¨ç»‘å®šçš„ï¼Œæ‰€ä»¥åœ¨ç±»åŠ è½½å™¨å¸è½½çš„æ—¶å€™ï¼ŒJVM å¯ä»¥å¤§å—å¤§å—åœ°é‡Šæ”¾è¿™äº›ç©ºé—´ã€‚</p>
<p>ä¸‹é¢å±•ç¤ºä¸€ä¸ª Metachunk çš„ç»“æ„ï¼š</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/metaspace/metaspace-metachunk.png" alt="alt text"></p>
<p>è¿™ä¸ª chunk è¯ç”Ÿçš„æ—¶å€™ï¼Œå®ƒåªæœ‰ä¸€ä¸ª headerï¼Œä¹‹åçš„åˆ†é…éƒ½åªè¦åœ¨é¡¶éƒ¨è¿›è¡Œåˆ†é…å°±è¡Œã€‚</p>
<p>ç”±äºè¿™ä¸ª chunk æ˜¯å½’å±äºä¸€ä¸ªç±»åŠ è½½å™¨çš„ï¼Œæ‰€ä»¥å¦‚æœå®ƒä¸å†åŠ è½½æ–°çš„ç±»ï¼Œé‚£ä¹ˆ unused ç©ºé—´å°±å°†çœŸçš„æµªè´¹æ‰ã€‚</p>
<h3 id="ClassloaderData-and-ClassLoaderMetaspace"><a href="#ClassloaderData-and-ClassLoaderMetaspace" class="headerlink" title="ClassloaderData and ClassLoaderMetaspace"></a>ClassloaderData and ClassLoaderMetaspace</h3><p>åœ¨ JVM å†…éƒ¨ï¼Œä¸€ä¸ªç±»åŠ è½½å™¨ä»¥ä¸€ä¸ª <a target="_blank" rel="noopener" href="http://hg.openjdk.java.net/jdk/jdk11/file/1ddf9a99e4ad/src/hotspot/share/classfile/classLoaderData.hpp#l176"><em>ClassLoaderData</em></a> ç»“æ„æ ‡è¯†ï¼Œè¿™ä¸ªç»“æ„å¼•ç”¨äº†ä¸€ä¸ª <a target="_blank" rel="noopener" href="http://hg.openjdk.java.net/jdk/jdk11/file/1ddf9a99e4ad/src/hotspot/share/memory/metaspace.hpp#l230"><em>ClassLoaderMetaspace</em></a> ç»“æ„ï¼Œå®ƒç»´æŠ¤äº†è¯¥åŠ è½½å™¨ä½¿ç”¨çš„æ‰€æœ‰çš„ Metachunkã€‚</p>
<p>å½“è¿™ä¸ªç±»åŠ è½½å™¨è¢«å¸è½½çš„æ—¶å€™ï¼Œè¿™ä¸ª <code>ClassLoaderData</code> å’Œ <code>ClassLoaderMetaspace</code> ä¼šè¢«åˆ é™¤ã€‚å¹¶ä¸”ä¼šå°†æ‰€æœ‰çš„è¿™ä¸ªåŠ è½½å™¨ç”¨åˆ°çš„ chunks å½’è¿˜åˆ°ç©ºé—²åˆ—è¡¨ä¸­ã€‚è¿™éƒ¨åˆ†å†…å­˜æ˜¯å¦å¯ä»¥ç›´æ¥å½’è¿˜ç»™æ“ä½œç³»ç»Ÿå–å†³äºæ˜¯å¦æ»¡è¶³å…¶ä»–æ¡ä»¶ï¼Œåé¢ä¼šä»‹ç»ã€‚</p>
<blockquote>
<p>å°±æ˜¯å‰é¢æè¿‡çš„ï¼Œå¦‚æœæ°å¥½æŠŠæ•´ä¸ª Node éƒ½æ¸…ç©ºäº†ï¼Œé‚£ä¹ˆè¿™ä¸ª Node çš„å†…å­˜ç›´æ¥è¿˜ç»™æ“ä½œç³»ç»Ÿ</p>
</blockquote>
<h3 id="åŒ¿åç±»"><a href="#åŒ¿åç±»" class="headerlink" title="åŒ¿åç±»"></a>åŒ¿åç±»</h3><p><code>ClassloaderData != ClassLoaderMetaspace</code></p>
<p>æ³¨æ„ï¼Œæˆ‘ä»¬å‰é¢è¯´ï¼Œâ€œMetaspace å†…å­˜æ˜¯å±äºç±»åŠ è½½å™¨çš„â€ï¼Œä½†æ˜¯ï¼Œè¿™é‡Œå…¶å®æ’’äº†ä¸€ä¸ªå°è°ï¼Œå¦‚æœå°†åŒ¿åç±»è€ƒè™‘è¿›å»ï¼Œé‚£å°±æ›´åŠ å¤æ‚äº†ï¼š</p>
<p>å½“ç±»åŠ è½½å™¨åŠ è½½ä¸€ä¸ªåŒ¿åç±»æ—¶ï¼Œè¿™ä¸ªç±»æœ‰è‡ªå·±ç‹¬ç«‹çš„ <code>ClassLoaderData</code>ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸæ˜¯è·Ÿéšç€è¿™ä¸ªåŒ¿åç±»çš„ï¼Œè€Œä¸æ˜¯è¿™ä¸ªç±»åŠ è½½å™¨ï¼ˆæ‰€ä»¥ï¼Œå’Œå®ƒç›¸å…³çš„ç©ºé—´å¯ä»¥åœ¨ç±»åŠ è½½å™¨å¸è½½å‰å¾—åˆ°é‡Šæ”¾ï¼‰ã€‚æ‰€ä»¥ï¼Œä¸€ä¸ªç±»åŠ è½½å™¨æœ‰ä¸€ä¸ªä¸»è¦çš„ ClassLoaderData ç»“æ„ç”¨æ¥æœåŠ¡æ‰€æœ‰çš„æ­£å¸¸çš„ç±»ï¼Œå¯¹äºæ¯ä¸€ä¸ªåŒ¿åç±»ï¼Œè¿˜æœ‰ä¸€ä¸ªäºŒçº§çš„ ClassLoaderData ç»“æ„æ¥ç»´æŠ¤ã€‚</p>
<p>è¿™æ ·åšçš„ç›®çš„ä¹‹ä¸€ï¼Œå…¶å®å°±æ˜¯æ²¡æœ‰å¿…è¦æ‰©å¤§å¤§é‡çš„ Lambdas å’Œ method  handlers åœ¨ Metaspace ä¸­çš„ç©ºé—´çš„ç”Ÿå‘½å‘¨æœŸã€‚</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/metaspace/metaspace-classloadermetaspace.png" alt="alt text"></p>
<h3 id="å†…å­˜ä»€ä¹ˆæ—¶å€™ä¼šè¿˜ç»™æ“ä½œç³»ç»Ÿ"><a href="#å†…å­˜ä»€ä¹ˆæ—¶å€™ä¼šè¿˜ç»™æ“ä½œç³»ç»Ÿ" class="headerlink" title="å†…å­˜ä»€ä¹ˆæ—¶å€™ä¼šè¿˜ç»™æ“ä½œç³»ç»Ÿ"></a>å†…å­˜ä»€ä¹ˆæ—¶å€™ä¼šè¿˜ç»™æ“ä½œç³»ç»Ÿ</h3><p>å½“ä¸€ä¸ª VirtualSpaceListNode ä¸­çš„æ‰€æœ‰ chunk éƒ½æ˜¯ç©ºé—²çš„æ—¶å€™ï¼Œè¿™ä¸ª Node å°±ä¼šä»é“¾è¡¨ VirtualSpaceList ä¸­ç§»é™¤ï¼Œå®ƒçš„ chunks ä¹Ÿä¼šä»ç©ºé—²åˆ—è¡¨ä¸­ç§»é™¤ï¼Œè¿™ä¸ª Node å°±æ²¡æœ‰è¢«ä½¿ç”¨äº†ï¼Œä¼šå°†å…¶å†…å­˜å½’è¿˜ç»™æ“ä½œç³»ç»Ÿã€‚</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/metaspace/metaspace-vsnode-purged.png" alt="alt text"></p>
<p>å¯¹äºä¸€ä¸ªç©ºé—²çš„ Node æ¥è¯´ï¼Œæ‹¥æœ‰å…¶ä¸Šé¢çš„ chunks çš„æ‰€æœ‰çš„ç±»åŠ è½½å™¨å¿…ç„¶éƒ½æ˜¯è¢«å¸è½½äº†çš„ã€‚</p>
<p>è‡³äºè¿™ä¸ªæƒ…å†µæ˜¯å¦å¯èƒ½å‘ç”Ÿï¼Œä¸»è¦å°±æ˜¯å–å†³äºç¢ç‰‡åŒ–ï¼š</p>
<p>ä¸€ä¸ª Node æ˜¯ 2Mï¼Œchunks çš„å¤§å°ä¸º 1K, 4K æˆ– 64Kï¼Œæ‰€ä»¥é€šå¸¸ä¸€ä¸ª Node ä¸Šæœ‰çº¦ 150-200 ä¸ª chunksï¼Œå¦‚æœè¿™äº› chunks å…¨éƒ¨ç”±åŒä¸€ä¸ªç±»åŠ è½½å™¨æ‹¥æœ‰ï¼Œå›æ”¶è¿™ä¸ªç±»åŠ è½½å™¨å°±å¯ä»¥ä¸€æ¬¡æ€§å›æ”¶è¿™ä¸ª Nodeï¼Œå¹¶ä¸”æŠŠå®ƒçš„ç©ºé—´è¿˜ç»™æ“ä½œç³»ç»Ÿã€‚</p>
<p>ä½†æ˜¯ï¼Œå¦‚æœè¿™äº› chunks åˆ†é…ç»™ä¸åŒçš„ç±»åŠ è½½å™¨ï¼Œæ¯ä¸ªç±»åŠ è½½å™¨éƒ½æœ‰ä¸åŒçš„ç”Ÿå‘½å‘¨æœŸï¼Œé‚£ä¹ˆä»€ä¹ˆéƒ½ä¸ä¼šè¢«é‡Šæ”¾ã€‚è¿™ä¹Ÿè®¸å°±æ˜¯åœ¨å‘Šè¯‰æˆ‘ä»¬ï¼Œè¦å°å¿ƒå¯¹å¾…å¤§é‡çš„å°çš„ç±»åŠ è½½å™¨ï¼Œå¦‚é‚£äº›è´Ÿè´£åŠ è½½åŒ¿åç±»æˆ–åå°„ç±»çš„åŠ è½½å™¨ã€‚</p>
<p>åŒæ—¶ä¹Ÿè¦æ¸…æ¥šï¼ŒMetaspace ä¸­çš„ <em>Compressed Class Space</em> æ˜¯æ°¸è¿œä¸ä¼šå°†å†…å­˜è¿˜ç»™æ“ä½œç³»ç»Ÿçš„ã€‚æˆ‘ä»¬é©¬ä¸Šå°±è¦ä»‹ç»è¿™éƒ¨åˆ†å†…å®¹äº†ã€‚</p>
<h3 id="æœ¬èŠ‚å°ç»“"><a href="#æœ¬èŠ‚å°ç»“" class="headerlink" title="æœ¬èŠ‚å°ç»“"></a>æœ¬èŠ‚å°ç»“</h3><ul>
<li>æ¯æ¬¡å‘æ“ä½œç³»ç»Ÿç”³è¯· 2M çš„è™šæ‹Ÿç©ºé—´æ˜ å°„ï¼Œæ”¾ç½®åˆ°å…¨å±€é“¾è¡¨ä¸­ï¼Œå¾…éœ€è¦ä½¿ç”¨çš„æ—¶å€™ç”³è¯·å†…å­˜ã€‚</li>
<li>ä¸€ä¸ª Node ä¼šåˆ†å‰²ä¸ºä¸€ä¸ªä¸ªçš„ chunksï¼Œåˆ†é…ç»™ç±»åŠ è½½å™¨ï¼Œä¸€ä¸ª chunk å±äºä¸€ä¸ªç±»åŠ è½½å™¨ã€‚</li>
<li>chunk å†ç»†åˆ†ä¸ºä¸€ä¸ªä¸ª Metablockï¼Œè¿™æ˜¯åˆ†é…ç»™è°ƒç”¨è€…çš„æœ€å°å•å…ƒã€‚</li>
<li>å½“ä¸€ä¸ªç±»åŠ è½½å™¨è¢«å¸è½½ï¼Œå®ƒå æœ‰çš„ chunks ä¼šè¿›å…¥åˆ°ç©ºé—²åˆ—è¡¨ï¼Œä»¥ä¾¿å¤ç”¨ï¼Œå¦‚æœè¿æ°”å¥½çš„è¯ï¼Œæœ‰å¯èƒ½ä¼šç›´æ¥æŠŠå†…å­˜å½’è¿˜ç»™æ“ä½œç³»ç»Ÿã€‚</li>
</ul>
<h2 id="3ã€ä»€ä¹ˆæ˜¯-Compressed-Class-Space"><a href="#3ã€ä»€ä¹ˆæ˜¯-Compressed-Class-Space" class="headerlink" title="3ã€ä»€ä¹ˆæ˜¯ Compressed Class Space"></a>3ã€ä»€ä¹ˆæ˜¯ Compressed Class Space</h2><p>åœ¨ 64 ä½å¹³å°ä¸Šï¼ŒHotSpot ä½¿ç”¨äº†ä¸¤ä¸ªå‹ç¼©ä¼˜åŒ–æŠ€æœ¯ï¼Œ<strong>Compressed Object Pointers</strong> (<em>â€œCompressedOopsâ€</em>) å’Œ <strong>Compressed Class Pointers</strong>ã€‚</p>
<p>å‹ç¼©æŒ‡é’ˆï¼ŒæŒ‡çš„æ˜¯åœ¨ 64 ä½çš„æœºå™¨ä¸Šï¼Œä½¿ç”¨ 32 ä½çš„æŒ‡é’ˆæ¥è®¿é—®æ•°æ®ï¼ˆå †ä¸­çš„å¯¹è±¡æˆ– Metaspace ä¸­çš„å…ƒæ•°æ®ï¼‰çš„ä¸€ç§æ–¹å¼ã€‚</p>
<p>è¿™æ ·æœ‰å¾ˆå¤šçš„å¥½å¤„ï¼Œæ¯”å¦‚ 32 ä½çš„æŒ‡é’ˆå ç”¨æ›´å°çš„å†…å­˜ï¼Œå¯ä»¥æ›´å¥½åœ°ä½¿ç”¨ç¼“å­˜ï¼Œåœ¨æœ‰äº›å¹³å°ï¼Œè¿˜å¯ä»¥ä½¿ç”¨åˆ°æ›´å¤šçš„å¯„å­˜å™¨ã€‚</p>
<p>å½“ç„¶ï¼Œåœ¨ 64 ä½çš„æœºå™¨ä¸­ï¼Œæœ€ç»ˆè¿˜æ˜¯éœ€è¦ä¸€ä¸ª 64 ä½çš„åœ°å€æ¥è®¿é—®æ•°æ®çš„ï¼Œæ‰€ä»¥è¿™ä¸ª 32 ä½çš„å€¼æ˜¯ç›¸å¯¹äºä¸€ä¸ªåŸºå‡†åœ°å€çš„å€¼ã€‚</p>
<blockquote>
<p>CompressedOops è¯´çš„æ˜¯å¯¹è±¡å¼•ç”¨çš„å‹ç¼©ï¼Œå®ƒä¸åœ¨æœ¬æ–‡çš„è®¨è®ºèŒƒå›´å†…ã€‚</p>
<p>åœ¨ 64 ä½å¹³å°ä¸Šï¼Œæœ¬è´¨ä¸Šè¿˜æ˜¯éœ€è¦ä½¿ç”¨ 64 ä½åœ°å€æ¥å¼•ç”¨æ¯ä¸€ä¸ªå¯¹è±¡çš„ï¼Œä½†æ˜¯è¿™é¡¹æŠ€æœ¯ä½¿å¾—å¯ä»¥åªä½¿ç”¨ 32 ä½åœ°å€æ¥å®ç°å¼•ç”¨ã€‚å¤§å®¶å¯ä»¥å‚è€ƒä¸€ä¸‹è¯„è®ºåŒºçš„è®¨è®ºï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚</p>
</blockquote>
<p>ç”±äºæœ¬æ–‡åœ¨æè¿°çš„æ˜¯ Metaspaceï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œä¸å…³å¿ƒ <strong>Compressed Object Pointers</strong>ï¼Œä¸‹é¢å°†æè¿° <strong>Compressed Class Pointers</strong>ï¼š</p>
<p>æ¯ä¸ª Java å¯¹è±¡ï¼Œåœ¨å®ƒçš„å¤´éƒ¨ï¼Œæœ‰ä¸€ä¸ªå¼•ç”¨æŒ‡å‘ Metaspace ä¸­çš„ Klass ç»“æ„ã€‚</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/metaspace/metaspace-uncompressed-class-ptr.png" alt="alt text"></p>
<p>å½“ä½¿ç”¨äº† compressed class pointersï¼Œè¿™ä¸ªå¼•ç”¨æ˜¯ 32 ä½çš„å€¼ï¼Œä¸ºäº†æ‰¾åˆ°çœŸæ­£çš„ 64 ä½åœ°å€ï¼Œéœ€è¦åŠ ä¸Šä¸€ä¸ª base å€¼ï¼š</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/metaspace/metaspace-compressed-class-ptr.png" alt="alt text"></p>
<p>ä¸Šé¢çš„å†…å®¹åº”è¯¥å¾ˆå¥½ç†è§£ï¼Œè¿™é¡¹æŠ€æœ¯å¯¹ Klass çš„åˆ†é…å¸¦æ¥çš„é—®é¢˜æ˜¯ï¼šç”±äº 32 ä½åœ°å€åªèƒ½è®¿é—®åˆ° 4G çš„ç©ºé—´ï¼Œæ‰€ä»¥<strong>æœ€å¤§åªå…è®¸ 4G</strong> çš„ Klass åœ°å€ã€‚è¿™é¡¹é™åˆ¶ä¹Ÿæ„å‘³ç€ï¼ŒJVM éœ€è¦å‘ Metaspace åˆ†é…ä¸€ä¸ª<strong>è¿ç»­çš„åœ°å€ç©ºé—´</strong>ã€‚</p>
<p>å½“ä»ç³»ç»Ÿç”³è¯·å†…å­˜æ—¶ï¼Œé€šè¿‡è°ƒç”¨ç³»ç»Ÿæ¥å£ malloc(3) æˆ– mmap(3)ï¼Œæ“ä½œç³»ç»Ÿå¯èƒ½è¿”å›ä»»æ„ä¸€ä¸ªåœ°å€å€¼ï¼Œæ‰€ä»¥åœ¨ 64ä½ç³»ç»Ÿä¸­ï¼Œå®ƒå¹¶ä¸èƒ½ä¿è¯åœ¨ 4G çš„èŒƒå›´å†…ã€‚</p>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬åªèƒ½ç”¨ä¸€ä¸ª mmap() æ¥ç”³è¯·ä¸€ä¸ªåŒºåŸŸå•ç‹¬ç”¨æ¥å­˜æ”¾ Klass å¯¹è±¡ã€‚æˆ‘ä»¬éœ€è¦æå‰çŸ¥é“è¿™ä¸ªåŒºåŸŸçš„å¤§å°ï¼Œè€Œä¸”ä¸èƒ½è¶…è¿‡ 4Gã€‚æ˜¾ç„¶ï¼Œè¿™ç§æ–¹å¼æ˜¯ä¸èƒ½æ‰©å±•çš„ï¼Œå› ä¸ºè¿™ä¸ªåœ°å€åé¢çš„å†…å­˜å¯èƒ½æ˜¯è¢«å ç”¨çš„ã€‚</p>
<p>åªæœ‰ Klass ç»“æ„æœ‰è¿™ä¸ªé™åˆ¶ï¼Œå¯¹äºå…¶ä»–çš„ class metadata æ²¡æœ‰è¿™ä¸ªå¿…è¦: å› ä¸ºåªæœ‰ Klass å®ä¾‹æ˜¯é€šè¿‡ Java å¯¹è±¡ header  ä¸­çš„å‹ç¼©æŒ‡é’ˆè®¿é—®çš„ã€‚å…¶ä»–çš„ metadata éƒ½æ˜¯é€šè¿‡ 64 ä½çš„åœ°å€è¿›è¡Œè®¿é—®çš„ï¼Œæ‰€ä»¥å®ƒä»¬å¯ä»¥è¢«æ”¾åˆ°ä»»æ„çš„åœ°å€ä¸Šã€‚</p>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬å†³å®šå°† Metaspace åˆ†ä¸ºä¸¤ä¸ªåŒºåŸŸï¼šnon-class part å’Œ class partã€‚</p>
<ul>
<li>class partï¼šå­˜æ”¾ Klass å¯¹è±¡ï¼Œéœ€è¦ä¸€ä¸ªè¿ç»­çš„ä¸è¶…è¿‡ 4G çš„å†…å­˜</li>
<li>non-class partï¼šåŒ…å«å…¶ä»–çš„æ‰€æœ‰ metadata</li>
</ul>
<blockquote>
<p>class part è¢«ç§°ä½œ <strong>Compressed Class Space</strong>ï¼Œè¿™ä¸ªåå­—ä¼šæœ‰ç‚¹æ€ªï¼Œå› ä¸º Klass æœ¬èº«å…¶å®æ²¡æœ‰ä½¿ç”¨å‹ç¼©æŠ€æœ¯ï¼Œè€Œæ˜¯å¼•ç”¨å®ƒä»¬çš„æŒ‡é’ˆè¢«å‹ç¼©äº†ã€‚</p>
</blockquote>
<p>compressed class space ç©ºé—´çš„å¤§å°ï¼Œæ˜¯é€šè¿‡ -XX:CompressedClassSpaceSize æŒ‡å®šçš„ã€‚</p>
<p>æˆ‘ä»¬éœ€è¦æå‰çŸ¥é“è‡ªå·±éœ€è¦å¤šå°‘å†…å­˜ï¼Œå®ƒçš„<strong>é»˜è®¤å€¼æ˜¯ 1G</strong>ã€‚å½“ç„¶è¿™ä¸ª 1G å¹¶ä¸æ˜¯çœŸçš„ä½¿ç”¨äº†æ“ä½œç³»ç»Ÿçš„ 1Gï¼Œè€Œæ˜¯è™šæ‹Ÿåœ°å€æ˜ å°„ã€‚</p>
<h3 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h3><p>ä¸ºäº†å¤ç”¨å·²æœ‰çš„ Metaspace ç©ºé—´ï¼Œä½¿ç”¨äº†ä¸€ä¸ªå°æŠ€å·§ï¼š</p>
<p>åœ¨ Class Space å’Œ Non-Class Space ä¸­ï¼Œåˆ†åˆ«éƒ½æœ‰ VirtualSpaceList å’Œ ChunkManager ä¸¤ä¸ªç»“æ„ã€‚</p>
<p>ä½†æ˜¯å¯¹äº Class Spaceï¼Œæ—¢ç„¶æˆ‘ä»¬éœ€è¦ä¸€ä¸ªè¿ç»­çš„ç©ºé—´æˆ‘ä»¬ä¸èƒ½ä½¿ç”¨ä¸€ä¸ªé“¾è¡¨æ¥å­˜æ”¾æ‰€æœ‰çš„ Nodeï¼Œæ‰€ä»¥è¿™ä¸ªé“¾è¡¨é€€åŒ–ä¸ºåªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ä¸”ä¸èƒ½æ‰©å±•ã€‚è¿™ä¸ª Node å°±æ˜¯ compressed class spaceï¼Œå’Œ Non-Class Space ä¸­çš„ Node ç›¸æ¯”ï¼Œå®ƒå¯æ˜¯å·¨å¤§æ— æ¯”ã€‚</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/metaspace/metaspace-classspace-duality.png" alt="alt text"></p>
<p>ClassLoaderMetaspaceï¼ˆè®°å½•å½“å‰ç±»åŠ è½½å™¨æŒæœ‰å“ªäº› chunksï¼‰éœ€è¦ä¸¤ä¸ªé“¾è¡¨ï¼Œä¸€ä¸ªç”¨äºè®°å½• Class Space ä¸­çš„ chunksï¼Œä¸€ä¸ªç”¨äºè®°å½• Non-Class Space ä¸­çš„ chunksã€‚</p>
<blockquote>
<p>åˆ°è¿™é‡Œåº”è¯¥ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯å¯¹äºä¸€ä¸ªç±»åŠ è½½å™¨æ¥è¯´ï¼Œå®ƒéœ€è¦çŸ¥é“è‡ªå·±ä½¿ç”¨äº† non-class part ä¸­çš„å“ªäº› chunks å’Œ class part ä¸­çš„å“ªäº› chunksã€‚</p>
</blockquote>
<h3 id="å¼€å…³-UseCompressedClassPointers-UseCompressedOops"><a href="#å¼€å…³-UseCompressedClassPointers-UseCompressedOops" class="headerlink" title="å¼€å…³: UseCompressedClassPointers, UseCompressedOops"></a>å¼€å…³: UseCompressedClassPointers, UseCompressedOops</h3><p><code>-XX:+UseCompressedOops</code> å…è®¸å¯¹è±¡æŒ‡é’ˆå‹ç¼©ã€‚</p>
<p><code>-XX:+UseCompressedClassPointers</code>  å…è®¸ç±»æŒ‡é’ˆå‹ç¼©ã€‚</p>
<p>å®ƒä»¬é»˜è®¤éƒ½æ˜¯å¼€å¯çš„ï¼Œå¯ä»¥æ‰‹åŠ¨å…³é—­å®ƒä»¬ã€‚</p>
<p>å¦‚æœä¸å…è®¸ç±»æŒ‡é’ˆå‹ç¼©ï¼Œé‚£ä¹ˆå°†æ²¡æœ‰ compressed class space è¿™ä¸ªç©ºé—´ï¼Œå¹¶ä¸”<code>-XX:CompressedClassSpaceSize</code> è¿™ä¸ªå‚æ•°æ— æ•ˆã€‚</p>
<p><code>-XX:-UseCompressedClassPointers</code> éœ€è¦æ­é… <code>-XX:+UseCompressedOops</code>ï¼Œä½†æ˜¯åè¿‡æ¥ä¸æ˜¯: æˆ‘ä»¬å¯ä»¥åªå‹ç¼©å¯¹è±¡æŒ‡é’ˆï¼Œä¸å‹ç¼©ç±»æŒ‡é’ˆã€‚</p>
<blockquote>
<p>è¿™é‡Œé¢ä¸ºä»€ä¹ˆè¿™ä¹ˆè§„å®šæˆ‘ä¹Ÿä¸æ‡‚ï¼Œä½†æ˜¯ä»ç›´è§‰ä¸Šæ¥è¯´ï¼Œå‹ç¼©å¯¹è±¡æŒ‡é’ˆæ˜¾ç„¶æ˜¯æ¯”è¾ƒé‡è¦çš„ï¼Œèƒ½è·å¾—è¾ƒå¤§çš„æ”¶ç›Šã€‚ä¹Ÿè®¸å°±æ˜¯åŸºäºè¿™ç§è€ƒé‡å§ï¼šä½ è¿å¯¹è±¡æŒ‡é’ˆéƒ½ä¸å‹ç¼©ï¼Œç±»æŒ‡é’ˆå‹ç¼©ä¸å‹ç¼©åˆæœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿ</p>
</blockquote>
<p>æ³¨æ„ï¼Œå¯¹è±¡æŒ‡é’ˆå‹ç¼©è¦æ±‚å †å°äº 32Gï¼Œæ‰€ä»¥å¦‚æœå †å¤§äºç­‰äº 32Gï¼Œé‚£ä¹ˆå¯¹è±¡æŒ‡é’ˆå‹ç¼©å’Œç±»æŒ‡é’ˆå‹ç¼©éƒ½ä¼šè¢«å…³é—­ã€‚</p>
<blockquote>
<p>32G å¯ä¸æ˜¯ä¸€ä¸ªææŒ‡ä¸€ç®—éšä¾¿æŒ‡å®šçš„æ•°å­—ï¼Œçœ‹ä¸‹è¯„è®ºåŒºå°±çŸ¥é“åŸå› äº†ã€‚</p>
</blockquote>
<h2 id="4ã€åº¦é‡-Metaspace"><a href="#4ã€åº¦é‡-Metaspace" class="headerlink" title="4ã€åº¦é‡ Metaspace"></a>4ã€åº¦é‡ Metaspace</h2><p>å‰é¢æˆ‘ä»¬ä»‹ç»è¿‡ï¼Œ<strong>MaxMetaspaceSize</strong> å’Œ <strong>CompressedClassSpaceSize</strong> æ˜¯æ§åˆ¶ Metaspace çš„ä¸¤ä¸ªé…ç½®ã€‚</p>
<p>å›é¡¾ä¸€ä¸‹ï¼š</p>
<ul>
<li><p><strong>MaxMetaspaceSize</strong></p>
<p>æœ€å¤§å…è®¸ Metaspace ä½¿ç”¨çš„å†…å­˜ï¼ŒåŒ…æ‹¬ Class Space å’Œ Non-Class Spaceï¼Œé»˜è®¤æ˜¯ä¸é™åˆ¶ã€‚</p>
</li>
<li><p><strong>CompressedClassSpaceSize</strong></p>
<p>åœ¨å¯åŠ¨çš„æ—¶å€™å°±é™åˆ¶ Class Space çš„å¤§å°ï¼Œé»˜è®¤å€¼æ˜¯ 1Gï¼Œå¯åŠ¨åä¸å¯ä»¥ä¿®æ”¹ã€‚å†è¯´ä¸€éï¼Œå®ƒæ˜¯ reserved ä¸æ˜¯ committed çš„å†…å­˜ã€‚</p>
</li>
</ul>
<p>ä¸‹å›¾å±•ç¤ºäº†å®ƒä»¬æ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼š</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/metaspace/metaspace-sizing-params.png" alt="MaxMetaspaceSize and CompressedClassSpaceSize"></p>
<p>çº¢è‰²éƒ¨åˆ†æ˜¯ Metaspace ä¸­å·²ä½¿ç”¨çš„ç³»ç»Ÿå†…å­˜ï¼ŒåŒ…æ‹¬ Non-Class Space é“¾è¡¨ä¸­çš„çº¢è‰²éƒ¨åˆ†å’Œ Class Space ä¸­å¤§ Node çš„çº¢è‰²éƒ¨åˆ†ã€‚è¿™ä¸ªæ€»å’Œå—åˆ° <code>-XX:MaxMetaspaceSize</code> çš„é™åˆ¶ï¼Œè¶…å‡ºå°†æŠ›å‡º **OutOfMemoryError(â€œMetaspaceâ€)**ã€‚</p>
<p><code>-XX:CompressedClassSpaceSize</code> é™åˆ¶äº†ä¸‹æ–¹çš„ Class Space ä¸­ï¼Œè¿™ä¸ªå¤§ Node çš„å¤§å°ï¼ŒåŒ…æ‹¬äº†çº¢è‰²å·²ä½¿ç”¨çš„å†…å­˜å’Œè“è‰²æœªä½¿ç”¨çš„å†…å­˜ã€‚å¦‚æœè¿™ä¸ª Node è¢«ç”¨å®Œäº†ï¼Œä¼šæŠ›å‡º **OutOfMemoryError(â€œCompressed Class Spaceâ€)**ã€‚</p>
<h3 id="æ‰€ä»¥è¿™æ„å‘³ç€ä»€ä¹ˆï¼Ÿ"><a href="#æ‰€ä»¥è¿™æ„å‘³ç€ä»€ä¹ˆï¼Ÿ" class="headerlink" title="æ‰€ä»¥è¿™æ„å‘³ç€ä»€ä¹ˆï¼Ÿ"></a>æ‰€ä»¥è¿™æ„å‘³ç€ä»€ä¹ˆï¼Ÿ</h3><p>å½“ä¸€ä¸ª Java ç±»è¢«åŠ è½½åï¼Œå®ƒéœ€è¦ Non-Class Space å’Œ Class Space çš„ç©ºé—´ï¼Œè€Œä¸”åè€…é€šå¸¸éƒ½æ˜¯è¢«é™åˆ¶çš„(é»˜è®¤ 1G)ï¼Œæ‰€ä»¥æˆ‘ä»¬æ€»æ˜¯æœ‰é‚£ä¹ˆä¸€ä¸ªä¸Šé™å­˜åœ¨ï¼Œå³ä½¿ -XX:MaxMetaspaceSize æ²¡æœ‰é…ç½®ã€‚</p>
<p>æ‰€ä»¥ï¼Œæ˜¯å¦ä¼šè§¦åŠåˆ°è¿™ä¸ªä¸Šé™ï¼Œå–å†³äº Non-Class Space å’Œ Class Space çš„ä½¿ç”¨æ¯”ä¾‹ã€‚</p>
<p>å¯¹äºæ¯ä¸ªç±»ï¼Œæˆ‘ä»¬å‡è®¾è¿™ä¸ªæ¯”ä¾‹æ˜¯ 1: 5 ï¼ˆclass:non-classï¼‰ ã€‚</p>
<p>è¿™æ„å‘³ç€ï¼Œå¯¹äº -XX:CompressedClassSpaceSize çš„ 1G çš„é»˜è®¤å€¼ï¼Œæˆ‘ä»¬çš„ä¸Šé™çº¦ 6Gï¼Œ1G çš„ Class Space å†åŠ çº¦ 5G çš„ Non-Class Spaceã€‚</p>
<h3 id="ä¸€ä¸ªç±»å¤§æ¦‚éœ€è¦å¤šå¤§çš„-Metaspace-ç©ºé—´"><a href="#ä¸€ä¸ªç±»å¤§æ¦‚éœ€è¦å¤šå¤§çš„-Metaspace-ç©ºé—´" class="headerlink" title="ä¸€ä¸ªç±»å¤§æ¦‚éœ€è¦å¤šå¤§çš„ Metaspace ç©ºé—´"></a>ä¸€ä¸ªç±»å¤§æ¦‚éœ€è¦å¤šå¤§çš„ Metaspace ç©ºé—´</h3><p>å¯¹äºä¸€ä¸ªè¢«åŠ è½½åˆ°è™šæ‹Ÿæœºä¸­çš„ç±»ï¼ŒMetaspace éœ€è¦åˆ†é… class å’Œ non-class ç©ºé—´ï¼Œé‚£ä¹ˆè¿™äº›ç©ºé—´èŠ±åœ¨å“ªé‡Œäº†å‘¢ï¼Ÿçœ‹ä¸‹å›¾ï¼š</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/metaspace/metaspace-class-metadata.png" alt="How much space does a Java class need?"></p>
<h4 id="æ·±å…¥-Class-Spaceï¼š"><a href="#æ·±å…¥-Class-Spaceï¼š" class="headerlink" title="æ·±å…¥ Class Spaceï¼š"></a>æ·±å…¥ Class Spaceï¼š</h4><p>æœ€å¤§çš„ä¸€éƒ¨åˆ†æ˜¯ Klass ç»“æ„ï¼Œå®ƒæ˜¯å›ºå®šå¤§å°çš„ã€‚</p>
<p>ç„¶åç´§è·Ÿç€ä¸¤ä¸ªå¯å˜å¤§å°çš„ vtable å’Œ itableï¼Œå‰è€…ç”±ç±»ä¸­æ–¹æ³•çš„æ•°é‡å†³å®šï¼Œåè€…ç”±è¿™ä¸ªç±»æ‰€å®ç°æ¥å£çš„æ–¹æ³•æ•°é‡å†³å®šã€‚</p>
<p>éšåæ˜¯ä¸€ä¸ª mapï¼Œè®°å½•äº†ç±»ä¸­å¼•ç”¨çš„ Java å¯¹è±¡çš„åœ°å€ï¼Œå°½ç®¡è¯¥ç»“æ„ä¸€èˆ¬éƒ½å¾ˆå°ï¼Œä¸è¿‡ä¹Ÿæ˜¯å¯å˜çš„ã€‚</p>
<p>vtable å’Œ itable é€šå¸¸ä¹Ÿå¾ˆå°ï¼Œä½†æ˜¯å¯¹äºä¸€äº›å·¨å¤§çš„ç±»ï¼Œå®ƒä»¬ä¹Ÿå¯ä»¥å¾ˆå¤§ï¼Œä¸€ä¸ªæœ‰ 30000 ä¸ªæ–¹æ³•çš„ç±»ï¼Œvtable çš„å¤§å°ä¼šè¾¾åˆ° 240kï¼Œå¦‚æœç±»æ´¾ç”Ÿè‡ªä¸€ä¸ªæ‹¥æœ‰ 30000 ä¸ªæ–¹æ³•çš„æ¥å£ï¼Œä¹Ÿæ˜¯åŒç†ã€‚ä½†æ˜¯è¿™äº›éƒ½æ˜¯æµ‹è¯•æ¡ˆä¾‹ï¼Œé™¤äº†è‡ªåŠ¨ç”Ÿæˆä»£ç ï¼Œä½ ä»æ¥ä¸ä¼šçœ‹åˆ°è¿™æ ·çš„ç±»ã€‚</p>
<h4 id="æ·±å…¥-Non-Class-Space"><a href="#æ·±å…¥-Non-Class-Space" class="headerlink" title="æ·±å…¥ Non-Class Space"></a>æ·±å…¥ Non-Class Space</h4><p>è¿™ä¸ªåŒºåŸŸæœ‰å¾ˆå¤šçš„ä¸œè¥¿ï¼Œä¸‹é¢è¿™äº›å ç”¨äº†æœ€å¤šçš„ç©ºé—´ï¼š</p>
<ul>
<li><p>å¸¸é‡æ± ï¼Œå¯å˜å¤§å°ï¼›</p>
</li>
<li><p>æ¯ä¸ªæˆå‘˜æ–¹æ³•çš„ metadataï¼šConstMethod ç»“æ„ï¼ŒåŒ…å«äº†å¥½å‡ ä¸ªå¯å˜å¤§å°çš„å†…éƒ¨ç»“æ„ï¼Œå¦‚æ–¹æ³•å­—èŠ‚ç ã€å±€éƒ¨å˜é‡è¡¨ã€å¼‚å¸¸è¡¨ã€å‚æ•°ä¿¡æ¯ã€æ–¹æ³•ç­¾åç­‰ï¼›</p>
</li>
<li><p>è¿è¡Œæ—¶æ•°æ®ï¼Œç”¨æ¥æ§åˆ¶ JIT çš„è¡Œä¸ºï¼›</p>
</li>
<li><p>æ³¨è§£</p>
</li>
</ul>
<blockquote>
<p>Metaspace ä¸­çš„ç»“æ„éƒ½ç»§æ‰¿è‡ª <a target="_blank" rel="noopener" href="http://hg.openjdk.java.net/jdk/jdk11/file/1ddf9a99e4ad/src/hotspot/share/memory/allocation.hpp#l239">MetaspaceObj</a>ï¼Œæ‰€ä»¥æŸ¥çœ‹å®ƒçš„ç±»ç»§æ‰¿ç»“æ„èƒ½äº†è§£æ›´è¯¦ç»†çš„ä¿¡æ¯ã€‚</p>
</blockquote>
<h4 id="Class-space-å’Œ-Non-Class-Space-æ¯”ä¾‹"><a href="#Class-space-å’Œ-Non-Class-Space-æ¯”ä¾‹" class="headerlink" title="Class space å’Œ Non-Class Space æ¯”ä¾‹"></a>Class space å’Œ Non-Class Space æ¯”ä¾‹</h4><p>ä¸‹é¢çœ‹ä¸€ä¸‹åœ¨ä¸€äº›å…¸å‹çš„åº”ç”¨ä¸­ï¼Œå®ƒä»¬ä¹‹é—´çš„å¤§å°æ¯”ä¾‹æ•°æ®ã€‚</p>
<p>ä¸‹é¢æ˜¯ WildFly åº”ç”¨æœåŠ¡å™¨ï¼Œ16.0.0ï¼Œè¿è¡Œåœ¨ SAPMachine 11 å¹³å°ä¸Šï¼Œæ²¡æœ‰åŠ è½½ä»»ä½•åº”ç”¨ã€‚æˆ‘ä»¬æ£€æŸ¥ä¸‹æ€»å…±éœ€è¦å¤šå°‘ Metaspace ç©ºé—´ï¼Œç„¶åè®¡ç®—å¹³å‡æ¯ä¸ªç±»æ‰€éœ€è¦çš„ç©ºé—´ã€‚æˆ‘ä»¬ä½¿ç”¨  <code>jcmd VM.metaspace</code> è¿›è¡Œåº¦é‡ã€‚</p>
<table>
<thead>
<tr>
<th>loader</th>
<th>#classes</th>
<th>non-class space <em>(avg per class)</em></th>
<th>class space <em>(/avg per class)</em></th>
<th>ratio non-class/class</th>
</tr>
</thead>
<tbody><tr>
<td>all</td>
<td>11503</td>
<td>60381k <em>(5.25k)</em></td>
<td>9957k <em>(0.86k)</em></td>
<td>6.0 : 1</td>
</tr>
<tr>
<td>bootstrap</td>
<td>2819</td>
<td>16720k <em>(5.93k)</em></td>
<td>1768k <em>(0.62k)</em></td>
<td>9.5 : 1</td>
</tr>
<tr>
<td>app</td>
<td>185</td>
<td>1320k <em>(7.13k)</em></td>
<td>136k <em>(0.74k)</em></td>
<td>9.7 : 1</td>
</tr>
<tr>
<td>anonymous</td>
<td>869</td>
<td>1013k <em>(1.16k)</em></td>
<td>475k <em>(0.55k)</em></td>
<td>2.1 : 1</td>
</tr>
</tbody></table>
<p>è¿™ä¸ªè¡¨å‘Šè¯‰æˆ‘ä»¬ï¼š</p>
<ul>
<li>å¯¹äºæ­£å¸¸çš„ç±»ï¼ˆæˆ‘ä»¬å‡è®¾é€šè¿‡ bootstrap å’Œ app åŠ è½½çš„ç±»æ˜¯æ­£å¸¸çš„ï¼‰ï¼Œæˆ‘å¯ä»¥å¾—åˆ°å¹³å‡æ¯ä¸ªç±»éœ€è¦çº¦ 5-7k çš„ Non-Class Space å’Œ 600-900 bytes çš„ Class Spaceã€‚</li>
<li>åŒ¿åç±»è¦å°å¾—å¤šï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸€ä¸ªæœ‰è¶£çš„äº‹æƒ…ï¼ŒClass å’Œ Non-Class Space ä¹‹é—´çš„æ¯”ä¾‹ï¼Œç›¸å¯¹çš„ï¼Œæˆ‘ä»¬éœ€è¦æ›´å¤šçš„ Class Spaceã€‚è¿™ä¹Ÿä¸å¥‡æ€ªï¼Œå› ä¸ºè¯¸å¦‚ Lambda ç±»éƒ½æ˜¯å¾ˆå°çš„ï¼Œä½†æ˜¯å®ƒçš„ Klass ç»“æ„ä¸å¯èƒ½å°äº sizeof(Klass)ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¾—åˆ° 1k Non-Class Space å’Œ 0.5k Class Spaceã€‚</li>
</ul>
<p>æ³¨æ„ï¼Œåœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼ŒåŒ¿åç±»çš„æ•°æ®å¯èƒ½æ²¡æœ‰ä»£è¡¨æ€§ï¼Œéœ€è¦æ”¶é›†æ›´å¤šçš„åŒ¿åç±»ï¼Œæ‰èƒ½å¾—åˆ°æ›´å‡†ç¡®çš„æ•°æ®ã€‚</p>
<h3 id="Metaspace-é»˜è®¤å¤§å°"><a href="#Metaspace-é»˜è®¤å¤§å°" class="headerlink" title="Metaspace é»˜è®¤å¤§å°"></a>Metaspace é»˜è®¤å¤§å°</h3><p>å¦‚æœæˆ‘ä»¬å®Œå…¨ä¸è®¾ç½®é™åˆ¶ Metaspace çš„å¤§å°ï¼Œé‚£ä¹ˆ Metaspace å¯ä»¥å®¹çº³å¤šå°‘ç±»å‘¢ï¼Ÿ</p>
<p>MaxMetaspaceSize é»˜è®¤æ˜¯æ²¡æœ‰é™åˆ¶çš„ï¼ŒCompressedClassSpaceSize é»˜è®¤æ˜¯ 1Gï¼Œæ‰€ä»¥æˆ‘ä»¬å”¯ä¸€ä¼šè§¦ç¢°åˆ°çš„æ˜¯ Class Space ç©ºé—´çš„ä¸Šé™ã€‚</p>
<p>ä½¿ç”¨ä¸Šé¢çš„æ•°æ®ï¼Œæ¯ä¸ªç±»çº¦ 5-7k çš„ Non-Class Space å’Œ 600-900 bytes çš„ Class Spaceï¼Œæˆ‘ä»¬å¯ä»¥ä¼°ç®—å‡ºå¤§çº¦ 1-1.5 ç™¾ä¸‡çš„ç±»ï¼ˆå‡è®¾æ²¡æœ‰ç¢ç‰‡ã€æ²¡æœ‰æµªè´¹ï¼‰ä»¥åä¼šè§¦ç¢°åˆ° Class Space çš„ OOMã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æ•°å€¼äº†ã€‚</p>
<h3 id="é™åˆ¶-Metaspace-ç©ºé—´å¤§å°"><a href="#é™åˆ¶-Metaspace-ç©ºé—´å¤§å°" class="headerlink" title="é™åˆ¶ Metaspace ç©ºé—´å¤§å°"></a>é™åˆ¶ Metaspace ç©ºé—´å¤§å°</h3><p><strong>å…è´£å£°æ˜ï¼šä¸è¦ç›²ç›®ä½¿ç”¨ä½ åœ¨ç½‘ç»œä¸Šæ‰¾åˆ°çš„è§„åˆ™ï¼Œå°¤å…¶æ˜¯è¿™äº›æ•°æ®å¹¶éæ¥è‡ªç”Ÿäº§æ•°æ®ã€‚</strong></p>
<p>å…¶å®æˆ‘ä»¬æ²¡æœ‰ä»€ä¹ˆé€‰æ‹©ï¼Œä½ ç¡®å®å¯ä»¥é™åˆ¶ Metaspace çš„ç©ºé—´å¢é•¿ï¼Œä½†æ˜¯å¦‚æœä½ çš„ç¨‹åºéœ€è¦æ›´å¤šçš„ç©ºé—´ç”¨æ¥å­˜æ”¾ class metadataï¼Œé‚£ä¹ˆä½ å°±ä¼šç¢°åˆ° OOMï¼Œé™¤äº†è®©ä½ çš„ä»£ç åŠ è½½æ›´å°‘çš„ç±»ï¼Œå¦åˆ™ï¼Œä½ å‡ ä¹æ˜¯æ— èƒ½ä¸ºåŠ›ã€‚</p>
<p>å’Œå †è¿›è¡Œæ¯”è¾ƒï¼šä½ å¯ä»¥å¢åŠ å’Œå‡å°‘å †çš„å¤§å°ï¼Œè€Œä¸å¿…å½±å“ä»£ç åŠŸèƒ½ï¼Œæ‰€ä»¥å †çš„é…ç½®æ˜¯æ¯”è¾ƒçµæ´»çš„ï¼Œè€Œ Metaspace ä¸å…·å¤‡è¿™ä¸ªç‰¹æ€§ã€‚</p>
<p>é‚£ä¹ˆä½ ä¸ºä»€ä¹ˆè¦é™åˆ¶ Metaspace çš„å¤§å°å‘¢ï¼Ÿ</p>
<ul>
<li>å‘Šè­¦ç³»ç»Ÿéœ€è¦çŸ¥é“ï¼Œä¸ºä»€ä¹ˆ Metaspace ç©ºé—´ä»¥ä¸€ä¸ªå¼‚å¸¸çš„é€Ÿåº¦åœ¨æ¶ˆè€—ï¼Œéœ€è¦æœ‰äººå»çœ‹ä¸€ä¸‹å‘ç”Ÿäº†ä»€ä¹ˆã€‚</li>
<li>æœ‰æ—¶å€™éœ€è¦é™åˆ¶è™šæ‹Ÿå†…å­˜åœ°å€çš„å¤§å°ã€‚é€šå¸¸æˆ‘ä»¬æ„Ÿå…´è¶£çš„æ˜¯å®é™…æ¶ˆè€—å†…å­˜ï¼Œä½†æ˜¯è™šæ‹Ÿå†…å­˜å¤§å°å¯èƒ½ä¼šå¯¼è‡´è™šæ‹Ÿæœºè¿›ç¨‹è¾¾åˆ°ç³»ç»Ÿé™åˆ¶ã€‚</li>
</ul>
<blockquote>
<p>æ³¨æ„ï¼šJDK ç‰ˆæœ¬ä¾èµ–ï¼šä¸ JDK 11æˆ–æ›´é«˜ç‰ˆæœ¬ç›¸æ¯”ï¼ŒJDK 8 ä¸­çš„å…ƒç©ºé—´å—åˆ°ç¢ç‰‡çš„å½±å“æ›´å¤§ã€‚æ‰€ä»¥åœ¨ JDK 8 ç¯å¢ƒä¸‹åˆ†é…çš„æ—¶å€™ï¼Œéœ€è¦è®¾ç½®æ›´å¤šçš„ç¼“å†²ã€‚</p>
</blockquote>
<p>å¦‚æœè¦é™åˆ¶ Metaspace å¤§å°ä½¿å¾—ç³»ç»Ÿæ›´å®¹æ˜“è¢«ç›‘æ§ï¼ŒåŒæ—¶ä¸ç”¨åœ¨ä¹è™šæ‹Ÿåœ°å€ç©ºé—´çš„å¤§å°ï¼Œé‚£ä¹ˆæœ€å¥½åªè®¾ç½® MaxMetaspaceSize è€Œä¸ç”¨è®¾ç½® CompressedClassSpaceSizeã€‚å¦‚æœè¦å•ç‹¬è®¾ç½®ï¼Œé‚£ä¹ˆæœ€å¥½è®¾ç½® CompressedClassSpaceSize ä¸º MaxMetaspaceSize çš„ 80% å·¦å³ã€‚</p>
<p>é™¤äº† MaxMetaspaceSize ä¹‹å¤–ï¼Œ<strong>å‡å° CompressedClassSpaceSize çš„å”¯ä¸€åŸå› æ˜¯å‡å°è™šæ‹Ÿæœºè¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜å¤§å°</strong>ã€‚ ä½†æ˜¯ï¼Œå¦‚æœå°† CompressedClassSpaceSize è®¾ç½®å¾—å¤ªä½ï¼Œåˆ™å¯èƒ½åœ¨ç”¨å®Œ MaxMetaspaceSize ä¹‹å‰å…ˆç”¨å®Œäº† Compressed Class Spaceã€‚ åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ¯”ç‡ä¸º1ï¼š2ï¼ˆCompressedClassSpaceSize = MaxMetaspaceSize / 2ï¼‰åº”è¯¥æ˜¯å®‰å…¨çš„ã€‚</p>
<p>é‚£ä¹ˆï¼Œä½ åº”è¯¥å°† MaxMetaspaceSize è®¾ç½®ä¸ºå¤šå¤§å‘¢ï¼Ÿ é¦–å…ˆåº”è¯¥æ˜¯è®¡ç®—é¢„æœŸçš„ Metaspace ä½¿ç”¨é‡ã€‚ä½ å¯ä»¥ä½¿ç”¨ä¸Šé¢ç»™å‡ºçš„æ•°å­—ï¼Œç„¶åç»™æ¯ä¸ªç±»çº¦ 1K çš„ Class Space å’Œ 3~8K çš„ Non-Class Space ä½œä¸ºç¼“å†²ã€‚</p>
<p>å› æ­¤ï¼Œå¦‚æœä½ çš„åº”ç”¨ç¨‹åºè®¡åˆ’åŠ è½½10000ä¸ªç±»ï¼Œé‚£ä¹ˆä»ç†è®ºä¸Šè®²ï¼Œä½ åªéœ€è¦ 10M çš„ Class Space å’Œ 80M Non-Class Spaceã€‚</p>
<p>ç„¶åï¼Œä½ éœ€è¦è€ƒè™‘å®‰å…¨ç³»æ•°ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå› å­ 2 æ˜¯æ¯”è¾ƒå®‰å…¨çš„ã€‚ä½ å½“ç„¶ä¹Ÿå¯ä»¥ç¢°è¿æ°”ï¼Œè®¾ç½®ä½ä¸€ç‚¹ï¼Œä½†æ˜¯è¦åšå¥½åœ¨ç¢°åˆ° OOM åè°ƒå¤§ Metaspace ç©ºé—´çš„å‡†å¤‡ã€‚</p>
<p>å¦‚æœè®¾ç½®å®‰å…¨å› å­ä¸º 2ï¼Œé‚£ä¹ˆéœ€è¦ 20M çš„ Class Space å’Œ 160M çš„ Non-Class Spaceï¼Œä¹Ÿå°±æ˜¯æ€»å¤§å°ä¸º 180Mã€‚å› æ­¤ï¼Œåœ¨è¿™é‡Œ <code>-XX:MaxMetaspaceSize=180M</code> æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚</p>
<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>è¿™æ˜¯ä¸€ç¯‡å¿«é€Ÿå†™å®Œçš„æ–‡ç« ï¼Œä¸è¿‡æˆ‘ä»”ç»†æ£€æŸ¥è¿‡äº†å‡ éï¼Œåº”è¯¥ä¸ä¼šæœ‰å¤ªå¤šçš„å‡ºå…¥ã€‚</p>
<p>å¦‚æœä½ å‘ç°æœ‰äº›åœ°æ–¹çœ‹å¾—ä¸æ˜¯å¾ˆæ‡‚ï¼Œå¸Œæœ›ä½ å¯ä»¥å…ˆå¯¹æ¯”ä¸€ä¸‹ <a target="_blank" rel="noopener" href="https://stuefe.de/posts/metaspace/what-is-metaspace/">åŸæ–‡</a>ï¼Œå¦‚æœæ˜¯æˆ‘çš„ç¿»è¯‘é—®é¢˜ï¼Œçƒ¦è¯·å‘ŠçŸ¥ã€‚</p>
<p>è™½ç„¶åªæ˜¯ä¸€ç¯‡ç¿»è¯‘çš„æ–‡ç« ï¼Œç”šè‡³å¯¹äºä½ æ¥è¯´å¯èƒ½è¿˜ä¸å¦‚çœ‹åŸæ–‡æ¥å¾—èˆ’é€‚ï¼Œä¸è¿‡ä¹ŸåŒæ ·æ¬¢è¿å¤§å®¶ç•™è¨€æ¢è®¨æˆ–åæ§½ã€‚</p>
<p>ï¼ˆå…¨æ–‡å®Œï¼‰</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://scatteredream.github.io/2018/11/03/netty-source-code-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/62317679?s=400&v=4">
      <meta itemprop="name" content="ç¢æ¢¦">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="scatteredream's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | scatteredream's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/11/03/netty-source-code-1/" class="post-title-link" itemprop="url">è®¤çœŸçš„ Netty æºç è§£æï¼ˆä¸€ï¼‰(è½¬è‡ªJavaDoop)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2018-11-03 00:00:00" itemprop="dateCreated datePublished" datetime="2018-11-03T00:00:00+08:00">2018-11-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-04-27 15:16:47" itemprop="dateModified" datetime="2025-04-27T15:16:47+08:00">2025-04-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/netty/" itemprop="url" rel="index"><span itemprop="name">netty</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>æœ¬æ–‡åˆæ˜¯ä¸€ç¯‡æºç åˆ†ææ–‡ç« ï¼Œå…¶å®é™¤äº† Doug Lea çš„å¹¶å‘åŒ…æºç ï¼Œæˆ‘æ˜¯çœŸä¸å¤ªçˆ±å†™æºç åˆ†æã€‚å› ä¸ºè¦èŠ±éå¸¸å¤šçš„æ—¶é—´ï¼Œè€Œä¸”å¾ˆå¤šåœ°æ–¹éœ€è¦åå¤ç»„ç»‡è¯­è¨€ã€‚</p>
<p>æœ¬æ–‡å°†ä»‹ç» Nettyï¼ŒJava å¹³å°ä¸Šä½¿ç”¨æœ€å¹¿æ³›çš„ NIO åŒ…ï¼Œå®ƒæ˜¯å¯¹ JDK ä¸­çš„ NIO å®ç°çš„ä¸€å±‚å°è£…ï¼Œè®©æˆ‘ä»¬èƒ½æ›´æ–¹ä¾¿åœ°å¼€å‘ NIO ç¨‹åºã€‚å…¶å®ï¼ŒNetty ä¸ä»…ä»…æ˜¯ NIO å§ï¼Œä½†æ˜¯ï¼ŒåŸºæœ¬ä¸Šå¤§å®¶éƒ½å†²ç€ NIO æ¥çš„ã€‚</p>
<p>ä¸ªäººæ„Ÿè§‰å›½å†…å¯¹äº Netty çš„å¹å˜˜æ˜¯æœ‰ç‚¹è¿‡äº†ï¼Œä¸»è¦æ˜¯å¾ˆå¤šäººé å®ƒåƒé¥­ï¼Œè¦ä¹ˆæ˜¯æåŸ¹è®­çš„ï¼Œè¦ä¹ˆæ˜¯å‡ºä¹¦çš„ï¼Œæ¨ä¸å¾—æŠŠ Netty å¹ä¸Šå¤©å»ï¼Œè¿™ç§ç°è±¡ä¹Ÿæ˜¯æŒºä¸å¥½çš„ï¼Œåè€Œä½¿å¾—åˆå­¦è€…è§‰å¾— Netty æ˜¯ä»€ä¹ˆé«˜æ·±çš„æŠ€æœ¯ä¸€æ ·ã€‚</p>
<p>Netty çš„æºç ä¸æ˜¯å¾ˆç®€å•ï¼Œå› ä¸ºå®ƒæ¯”è¾ƒå¤šï¼Œè€Œä¸”å„ä¸ªç±»ä¹‹é—´çš„å…³ç³»é”™ç»¼å¤æ‚ï¼Œå¾ˆå¤šäººè¯´å®ƒçš„æºç å¾ˆå¥½ï¼Œè¿™ç‚¹æˆ‘è§‰å¾—ä¸€èˆ¬ï¼ŒçœŸè¦è¯´å¥½ä»£ç ï¼Œè¿˜å¾— Doug Lea çš„å¹¶å‘æºç æ¯”è¾ƒæ¼‚äº®ï¼Œä¸€è¡Œè¡Œéƒ½æ˜¯ç²¾åï¼Œä¸è¿‡å®ƒä»¬æ˜¯ä¸åŒç±»å‹çš„ï¼Œä¹Ÿæ²¡ä»€ä¹ˆå¥½å¯¹æ¯”çš„ã€‚Netty æºç å¥½å°±å¥½åœ¨å®ƒçš„æ¥å£ä½¿ç”¨æ¯”è¾ƒçµæ´»ï¼Œå¾€å¾€æ¥å£å¥½ç”¨çš„æ¡†æ¶ï¼Œæºç éƒ½ä¸ä¼šå¤ªç®€å•ã€‚</p>
<p>æœ¬æ–‡å°†ç«‹è¶³äºæºç åˆ†æï¼Œæ‰€ä»¥è¯»è€…éœ€è¦å…ˆæŒæ¡ NIO çš„åŸºç¡€çŸ¥è¯†ï¼Œè‡³å°‘æˆ‘ä¹‹å‰å†™çš„ <a href="/post/java-nio">ã€ŠJava NIOï¼šBufferã€Channel å’Œ Selectorã€‹</a> ä¸­ä»‹ç»çš„åŸºç¡€çŸ¥è¯†è¦æ¸…æ¥šï¼Œå¦‚æœè¯»è€…å·²ç»å¯¹ Netty æœ‰äº›äº†è§£ï¼Œæˆ–è€…ä½¿ç”¨è¿‡ï¼Œé‚£å°±æ›´å¥½äº†ã€‚</p>
<ul>
<li>æœ¬æ–‡åªä»‹ç» TCP ç›¸å…³çš„å†…å®¹ï¼ŒNetty å¯¹äºå…¶ä»–åè®®çš„æ”¯æŒï¼Œä¸åœ¨æœ¬æ–‡çš„è®¨è®ºèŒƒå›´å†…ã€‚</li>
<li>å’Œå¹¶å‘åŒ…çš„æºç åˆ†æä¸ä¸€æ ·ï¼Œæˆ‘ä¸å¯èƒ½ä¸€è¡Œä¸€è¡Œæºç è¯´ï¼Œæ‰€ä»¥æœ‰äº›å¼‚å¸¸åˆ†æ”¯æ˜¯ä¼šç›´æ¥ç•¥è¿‡ï¼Œé™¤éæˆ‘è§‰å¾—éœ€è¦ä»‹ç»ã€‚</li>
<li>Netty æºç ä¸€ç›´åœ¨æ›´æ–°ï¼Œå„ç‰ˆæœ¬ä¹‹é—´æœ‰äº›å·®å¼‚ï¼Œæˆ‘æ˜¯æŒ‰ç…§ 2018-09-06 çš„æœ€æ–°ç‰ˆæœ¬ <strong>4.1.25.Final</strong> æ¥è¿›è¡Œä»‹ç»çš„ã€‚</li>
</ul>
<p>å»ºè®®åˆå­¦è€…åœ¨çœ‹å®Œæœ¬æ–‡ä»¥åï¼Œå¯ä»¥å»ç¿»ç¿»ã€ŠNetty In Actionã€‹ï¼Œç½‘ä¸Šä¹Ÿå¯ä»¥æ‰¾åˆ°ä¸­æ–‡æ–‡å­—ç‰ˆçš„ã€‚</p>
<!-- toc -->

<h2 id="å‡†å¤‡"><a href="#å‡†å¤‡" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h2><p>å­¦ä¹ æºç ï¼Œä¸€å¼€å§‹è‚¯å®šæ˜¯å‡†å¤‡ç¯å¢ƒã€‚</p>
<p>æˆ‘å–œæ¬¢ç”¨ mavenï¼Œä¹Ÿå–œæ¬¢ Spring Bootï¼Œæ‰€ä»¥æˆ‘ä¸€èˆ¬å…ˆåˆ° <a target="_blank" rel="noopener" href="https://start.spring.io/">https://start.spring.io/</a> å‡†å¤‡ä¸€ä¸ªæœ€ç®€å•çš„è„šæ‰‹æ¶ã€‚</p>
<p>10 ç§’æå®šè„šæ‰‹æ¶ï¼Œç„¶åå°±æ˜¯å¯¼å…¥åˆ° Intellij ä¸­ï¼Œå¦‚æœç”¨æ–°ç‰ˆæœ¬çš„ Spring Bootï¼Œå¯èƒ½è¿˜éœ€è¦ç­‰å¾…ä¸‹è½½ä¾èµ–ï¼ŒæœŸé—´æ‰“å¼€ <a target="_blank" rel="noopener" href="https://mvnrepository.com/">https://mvnrepository.com/</a> æœç´¢é©¬ä¸Šè¦ç”¨åˆ°çš„ maven ä¾èµ–ã€‚</p>
<p>Netty åˆ†ä¸ºå¥½äº›æ¨¡å—ï¼Œæœ‰ <a target="_blank" rel="noopener" href="https://mvnrepository.com/artifact/io.netty/netty-handler">netty-handler</a>ã€<a target="_blank" rel="noopener" href="https://mvnrepository.com/artifact/io.netty/netty-buffer">netty-buffer</a>ã€<a target="_blank" rel="noopener" href="https://mvnrepository.com/artifact/io.netty/netty-transport">netty-transport</a>ã€<a target="_blank" rel="noopener" href="https://mvnrepository.com/artifact/io.netty/netty-common">netty-common</a> ç­‰ç­‰ï¼Œä¹Ÿæœ‰ä¸€ä¸ª <a target="_blank" rel="noopener" href="https://mvnrepository.com/artifact/io.netty/netty-all">netty-all</a>ï¼Œå®ƒåŒ…å«äº†æ‰€æœ‰çš„æ¨¡å—ã€‚</p>
<p>æ—¢ç„¶æˆ‘ä»¬æ˜¯æºç åˆ†æï¼Œé‚£ä¹ˆè‡ªç„¶æ˜¯ç”¨ä¸€ä¸ªæœ€ç®€å•çš„ã€‚netty-all ä¸æ˜¯æœ€å¥½çš„é€‰æ‹©ï¼Œnetty-example æ‰æ˜¯ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-example<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.25.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>å®ƒä¸ä»…å¯ä»¥è§£å†³æˆ‘ä»¬çš„ä¾èµ–ï¼Œè€Œä¸” example é‡Œé¢çš„ç¤ºä¾‹éå¸¸é€‚åˆæˆ‘ä»¬å­¦ä¹ ä½¿ç”¨ã€‚</p>
<h2 id="Echo-ä¾‹å­"><a href="#Echo-ä¾‹å­" class="headerlink" title="Echo ä¾‹å­"></a>Echo ä¾‹å­</h2><p>Netty ä½œä¸º NIO çš„åº“ï¼Œè‡ªç„¶æ—¢å¯ä»¥ä½œä¸ºæœåŠ¡ç«¯æ¥å—è¯·æ±‚ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºå®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ã€‚ä½¿ç”¨ Netty å¼€å‘å®¢æˆ·ç«¯æˆ–æœåŠ¡ç«¯éƒ½æ˜¯éå¸¸ç®€å•çš„ï¼ŒNetty åšäº†å¾ˆå¥½çš„å°è£…ï¼Œæˆ‘ä»¬é€šå¸¸åªè¦å¼€å‘ä¸€ä¸ªæˆ–å¤šä¸ª <strong>handler</strong> ç”¨æ¥å¤„ç†æˆ‘ä»¬çš„è‡ªå®šä¹‰é€»è¾‘å°±å¯ä»¥äº†ã€‚</p>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç»å¸¸ä¼šè§åˆ°çš„ä¾‹å­ï¼Œå®ƒå« <strong>Echo</strong>ï¼Œä¹Ÿå°±æ˜¯<strong>å›å£°</strong>ï¼Œå®¢æˆ·ç«¯ä¼ è¿‡å»ä»€ä¹ˆå€¼ï¼ŒæœåŠ¡ç«¯åŸæ ·è¿”å›ä»€ä¹ˆå€¼ã€‚</p>
<blockquote>
<p>æ‰“å¼€ netty-example çš„æºç ï¼ŒæŠŠ <code>echo</code> åŒ…ä¸‹é¢çš„ä»£ç å¤åˆ¶å‡ºæ¥ç©ä¸€ç©ã€‚</p>
</blockquote>
<p><img src="https://assets.javadoop.com/imgs/20510079/netty-source/5.png" alt="5"></p>
<blockquote>
<p>å·¦è¾¹æ˜¯æœåŠ¡ç«¯ä»£ç ï¼Œå³è¾¹æ˜¯å®¢æˆ·ç«¯ä»£ç ã€‚</p>
</blockquote>
<p>ä¸Šé¢çš„ä»£ç åŸºæœ¬å°±æ˜¯æ¨¡æ¿ä»£ç ï¼Œæ¯æ¬¡ä½¿ç”¨éƒ½æ˜¯è¿™ä¸€ä¸ªå¥—è·¯ï¼Œå”¯ä¸€éœ€è¦æˆ‘ä»¬å¼€å‘çš„éƒ¨åˆ†æ˜¯ handler(â€¦) å’Œ childHandler(â€¦) æ–¹æ³•ä¸­æŒ‡å®šçš„å„ä¸ª handlerï¼Œå¦‚ <strong>EchoServerHandler</strong> å’Œ <strong>EchoClientHandler</strong>ï¼Œå½“ç„¶ Netty æºç ä¹Ÿç»™æˆ‘ä»¬æä¾›äº†å¾ˆå¤šçš„ handlerï¼Œæ¯”å¦‚ä¸Šé¢çš„ LoggingHandlerï¼Œå®ƒå°±æ˜¯ Netty æºç ä¸­ä¸ºæˆ‘ä»¬æä¾›çš„ï¼Œéœ€è¦çš„æ—¶å€™ç›´æ¥æ‹¿è¿‡æ¥ç”¨å°±å¥½äº†ã€‚</p>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ä¸Šè¿°ä»£ç ä¸­æ¶‰åŠåˆ°çš„ä¸€äº›å†…å®¹ï¼š</p>
<ul>
<li><p>ServerBootstrap ç±»ç”¨äºåˆ›å»ºæœåŠ¡ç«¯å®ä¾‹ï¼ŒBootstrap ç”¨äºåˆ›å»ºå®¢æˆ·ç«¯å®ä¾‹ã€‚</p>
</li>
<li><p>ä¸¤ä¸ª EventLoopGroupï¼šbossGroup å’Œ workerGroupï¼Œå®ƒä»¬æ¶‰åŠçš„æ˜¯ Netty çš„çº¿ç¨‹æ¨¡å‹ï¼Œå¯ä»¥çœ‹åˆ°æœåŠ¡ç«¯æœ‰ä¸¤ä¸ª groupï¼Œè€Œå®¢æˆ·ç«¯åªæœ‰ä¸€ä¸ªï¼Œå®ƒä»¬å°±æ˜¯ Netty ä¸­çš„çº¿ç¨‹æ± ã€‚</p>
</li>
<li><p>Netty ä¸­çš„ Channelï¼Œæ²¡æœ‰ç›´æ¥ä½¿ç”¨ Java åŸç”Ÿçš„ ServerSocketChannel å’Œ SocketChannelï¼Œè€Œæ˜¯åŒ…è£…äº† NioServerSocketChannel å’Œ NioSocketChannel ä¸ä¹‹å¯¹åº”ã€‚</p>
<blockquote>
<p>å½“ç„¶ï¼Œä¹Ÿæœ‰å¯¹å…¶ä»–åè®®çš„æ”¯æŒï¼Œå¦‚æ”¯æŒ UDP åè®®çš„ NioDatagramChannelï¼Œæœ¬æ–‡åªå…³å¿ƒ TCP ç›¸å…³çš„ã€‚</p>
</blockquote>
</li>
<li><p>å·¦è¾¹ handler(â€¦) æ–¹æ³•æŒ‡å®šäº†ä¸€ä¸ª handlerï¼ˆLoggingHandlerï¼‰ï¼Œè¿™ä¸ª handler æ˜¯ç»™æœåŠ¡ç«¯æ”¶åˆ°æ–°çš„è¯·æ±‚çš„æ—¶å€™å¤„ç†ç”¨çš„ã€‚å³è¾¹ handler(â€¦) æ–¹æ³•æŒ‡å®šäº†å®¢æˆ·ç«¯å¤„ç†è¯·æ±‚è¿‡ç¨‹ä¸­éœ€è¦ä½¿ç”¨çš„ handlersã€‚</p>
<blockquote>
<p>å¦‚æœä½ æƒ³åœ¨ EchoServer ä¸­ä¹ŸæŒ‡å®šå¤šä¸ª handlerï¼Œä¹Ÿå¯ä»¥åƒå³è¾¹çš„ EchoClient ä¸€æ ·ä½¿ç”¨ ChannelInitializer</p>
</blockquote>
</li>
<li><p>å·¦è¾¹ childHandler(â€¦) æŒ‡å®šäº† childHandlerï¼Œè¿™è¾¹çš„ handlers æ˜¯ç»™æ–°åˆ›å»ºçš„è¿æ¥ç”¨çš„ï¼Œæˆ‘ä»¬çŸ¥é“æœåŠ¡ç«¯ ServerSocketChannel åœ¨ accept ä¸€ä¸ªè¿æ¥ä»¥åï¼Œéœ€è¦åˆ›å»º SocketChannel çš„å®ä¾‹ï¼ŒchildHandler(â€¦) ä¸­è®¾ç½®çš„ handler å°±æ˜¯ç”¨äºå¤„ç†æ–°åˆ›å»ºçš„ SocketChannel çš„ï¼Œè€Œä¸æ˜¯ç”¨æ¥å¤„ç† ServerSocketChannel å®ä¾‹çš„ã€‚</p>
</li>
<li><p>pipelineï¼šhandler å¯ä»¥æŒ‡å®šå¤šä¸ªï¼ˆéœ€è¦ä¸Šé¢çš„ ChannelInitializer ç±»è¾…åŠ©ï¼‰ï¼Œå®ƒä»¬ä¼šç»„æˆäº†ä¸€ä¸ª pipelineï¼Œå®ƒä»¬å…¶å®å°±ç±»ä¼¼æ‹¦æˆªå™¨çš„æ¦‚å¿µï¼Œç°åœ¨åªè¦è®°ä½ä¸€ç‚¹ï¼Œæ¯ä¸ª NioSocketChannel æˆ– NioServerSocketChannel å®ä¾‹å†…éƒ¨éƒ½ä¼šæœ‰ä¸€ä¸ª pipeline å®ä¾‹ã€‚pipeline ä¸­è¿˜æ¶‰åŠåˆ° handler çš„æ‰§è¡Œé¡ºåºã€‚</p>
</li>
<li><p>ChannelFutureï¼šè¿™ä¸ªæ¶‰åŠåˆ° Netty ä¸­çš„å¼‚æ­¥ç¼–ç¨‹ï¼Œå’Œ JDK ä¸­çš„ Future æ¥å£ç±»ä¼¼ã€‚</p>
</li>
</ul>
<p>å¯¹äºä¸äº†è§£ Netty çš„è¯»è€…ï¼Œä¹Ÿä¸è¦æœ‰ä»€ä¹ˆå‹åŠ›ï¼Œæˆ‘ä¼šä¸€ä¸€ä»‹ç»å®ƒä»¬ï¼Œæœ¬æ–‡ä¸»è¦é¢å‘æ–°æ‰‹ï¼Œæˆ‘è§‰å¾—æ¯”è¾ƒéš¾ç†è§£æˆ–æ¯”è¾ƒé‡è¦çš„éƒ¨åˆ†ï¼Œä¼šèŠ±æ¯”è¾ƒå¤§çš„ç¯‡å¹…æ¥ä»‹ç»æ¸…æ¥šã€‚</p>
<p>ä¸Šé¢çš„æºç ä¸­æ²¡æœ‰å±•ç¤ºæ¶ˆæ¯å‘é€å’Œæ¶ˆæ¯æ¥æ”¶çš„å¤„ç†ï¼Œæ­¤éƒ¨åˆ†æˆ‘ä¼šåœ¨ä»‹ç»å®Œä¸Šé¢çš„è¿™äº›å†…å®¹ä»¥åå†è¿›è¡Œä»‹ç»ã€‚</p>
<p>ä¸‹é¢ï¼Œå°†åˆ†å—æ¥ä»‹ç»è¿™äº›å†…å®¹ã€‚é‰´äºè¯»è€…å¯¹ NIO æˆ– Netty çš„äº†è§£ç¨‹åº¦å¯èƒ½å‚å·®ä¸é½ï¼Œä¸ºäº†ç…§é¡¾åˆå­¦è€…ï¼Œå¾ˆå¤šåœ°æ–¹éœ€è¦å•°å—¦ä¸€äº›ï¼Œæ‰€ä»¥å¸Œæœ›è¯»è€…ä¸€èŠ‚ä¸€èŠ‚å¾€ä¸‹çœ‹ï¼Œå¯¹äºè‡ªå·±ç†Ÿæ‚‰çš„å†…å®¹å¯ä»¥é€‚å½“çœ‹å¿«ä¸€äº›ã€‚</p>
<h2 id="Netty-ä¸­çš„-Channel"><a href="#Netty-ä¸­çš„-Channel" class="headerlink" title="Netty ä¸­çš„ Channel"></a>Netty ä¸­çš„ Channel</h2><p>è¿™èŠ‚æˆ‘ä»¬æ¥çœ‹çœ‹ NioSocketChannel æ˜¯æ€ä¹ˆå’Œ JDK åº•å±‚çš„ SocketChannel è”ç³»åœ¨ä¸€èµ·çš„ï¼Œå®ƒä»¬æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ã€‚NioServerSocketChannel å’Œ ServerSocketChannel åŒç†ï¼Œä¹Ÿæ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ã€‚</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/netty-source/3.png" alt="3"></p>
<p>åœ¨ Bootstrapï¼ˆå®¢æˆ·ç«¯ï¼‰ å’Œ ServerBootstrapï¼ˆæœåŠ¡ç«¯ï¼‰ çš„å¯åŠ¨è¿‡ç¨‹ä¸­éƒ½ä¼šè°ƒç”¨ channel(â€¦) æ–¹æ³•ï¼š</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/netty-source/10.png" alt="10"></p>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥çœ‹ channel(â€¦) æ–¹æ³•çš„æºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractBootstrap</span></span><br><span class="line"><span class="keyword">public</span> B <span class="title function_">channel</span><span class="params">(Class&lt;? extends C&gt; channelClass)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (channelClass == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;channelClass&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> channelFactory(<span class="keyword">new</span> <span class="title class_">ReflectiveChannelFactory</span>&lt;C&gt;(channelClass));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæ–¹æ³•åªæ˜¯è®¾ç½®äº† channelFactory ä¸º ReflectiveChannelFactory çš„ä¸€ä¸ªå®ä¾‹ï¼Œç„¶åæˆ‘ä»¬çœ‹ä¸‹è¿™é‡Œçš„ ReflectiveChannelFactory åˆ°åº•æ˜¯ä»€ä¹ˆï¼š</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/netty-source/1.png" alt="1"></p>
<p><strong>newChannel()</strong> æ–¹æ³•æ˜¯ ChannelFactory æ¥å£ä¸­çš„å”¯ä¸€æ–¹æ³•ï¼Œ<strong>å·¥å‚æ¨¡å¼</strong>å¤§å®¶éƒ½å¾ˆç†Ÿæ‚‰ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<code>ReflectiveChannelFactory#newChannel()</code> æ–¹æ³•ä¸­ä½¿ç”¨äº†åå°„è°ƒç”¨ Channel çš„æ— å‚æ„é€ æ–¹æ³•æ¥åˆ›å»º Channelï¼Œæˆ‘ä»¬åªè¦çŸ¥é“ï¼ŒChannelFactory çš„ newChannel() æ–¹æ³•ä»€ä¹ˆæ—¶å€™ä¼šè¢«è°ƒç”¨å°±å¯ä»¥äº†ã€‚</p>
<ul>
<li>å¯¹äº NioSocketChannelï¼Œç”±äºå®ƒå……å½“å®¢æˆ·ç«¯çš„åŠŸèƒ½ï¼Œå®ƒçš„åˆ›å»ºæ—¶æœºåœ¨ <code>connect(â€¦)</code> çš„æ—¶å€™ï¼›</li>
<li>å¯¹äº NioServerSocketChannel æ¥è¯´ï¼Œå®ƒå……å½“æœåŠ¡ç«¯åŠŸèƒ½ï¼Œå®ƒçš„åˆ›å»ºæ—¶æœºåœ¨ç»‘å®šç«¯å£ <code>bind(â€¦)</code> çš„æ—¶å€™ã€‚</li>
</ul>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥ç®€å•è¿½è¸ªä¸‹å……å½“å®¢æˆ·ç«¯çš„ Bootstrap ä¸­ NioSocketChannel çš„åˆ›å»ºè¿‡ç¨‹ï¼Œçœ‹çœ‹ NioSocketChannel æ˜¯æ€ä¹ˆå’Œ JDK ä¸­çš„ SocketChannel å…³è”åœ¨ä¸€èµ·çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Bootstrap</span></span><br><span class="line"><span class="keyword">public</span> ChannelFuture <span class="title function_">connect</span><span class="params">(String inetHost, <span class="type">int</span> inetPort)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> connect(InetSocketAddress.createUnresolved(inetHost, inetPort));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åå†å¾€é‡Œçœ‹ï¼Œåˆ°è¿™ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ChannelFuture <span class="title function_">connect</span><span class="params">(SocketAddress remoteAddress)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (remoteAddress == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;remoteAddress&quot;</span>);</span><br><span class="line">    <span class="comment">// validate åªæ˜¯æ ¡éªŒä¸€ä¸‹å„ä¸ªå‚æ•°æ˜¯ä¸æ˜¯æ­£ç¡®è®¾ç½®äº†</span></span><br><span class="line">    validate();</span><br><span class="line">    <span class="keyword">return</span> doResolveAndConnect(remoteAddress, config.localAddress());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»§ç»­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å†å¾€é‡Œå°±åˆ°è¿™é‡Œäº†</span></span><br><span class="line"><span class="keyword">private</span> ChannelFuture <span class="title function_">doResolveAndConnect</span><span class="params">(<span class="keyword">final</span> SocketAddress remoteAddress, <span class="keyword">final</span> SocketAddress localAddress)</span> &#123;</span><br><span class="line">    <span class="comment">// æˆ‘ä»¬è¦è¯´çš„éƒ¨åˆ†åœ¨è¿™é‡Œ</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">ChannelFuture</span> <span class="variable">regFuture</span> <span class="operator">=</span> initAndRegister();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> regFuture.channel();</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åï¼Œæˆ‘ä»¬çœ‹ <code>initAndRegister()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ChannelFuture <span class="title function_">initAndRegister</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œè¿™é‡Œä¼šè¿›è¡Œ Channel çš„å®ä¾‹åŒ–</span></span><br><span class="line">        channel = channelFactory.newChannel();</span><br><span class="line">        init(channel);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> regFuture;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ‰¾åˆ°äº† <code>channel = channelFactory.newChannel()</code> è¿™è¡Œä»£ç ï¼Œæ ¹æ®å‰é¢è¯´çš„ï¼Œè¿™é‡Œä¼šè°ƒç”¨ç›¸åº” Channel çš„æ— å‚æ„é€ æ–¹æ³•ã€‚</p>
<p>ç„¶åæˆ‘ä»¬å°±å¯ä»¥å»çœ‹ NioSocketChannel çš„æ„é€ æ–¹æ³•äº†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">NioSocketChannel</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// SelectorProvider å®ä¾‹ç”¨äºåˆ›å»º JDK çš„ SocketChannel å®ä¾‹</span></span><br><span class="line">    <span class="built_in">this</span>(DEFAULT_SELECTOR_PROVIDER);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">NioSocketChannel</span><span class="params">(SelectorProvider provider)</span> &#123;</span><br><span class="line">    <span class="comment">// çœ‹è¿™é‡Œï¼ŒnewSocket(provider) æ–¹æ³•ä¼šåˆ›å»º JDK çš„ SocketChannel</span></span><br><span class="line">    <span class="built_in">this</span>(newSocket(provider));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è°ƒç”¨ newSocket(provider) çš„æ—¶å€™ï¼Œä¼šåˆ›å»º JDK NIO çš„ä¸€ä¸ª SocketChannel å®ä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> SocketChannel <span class="title function_">newSocket</span><span class="params">(SelectorProvider provider)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»º SocketChannel å®ä¾‹</span></span><br><span class="line">        <span class="keyword">return</span> provider.openSocketChannel();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ChannelException</span>(<span class="string">&quot;Failed to open a socket.&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NioServerSocketChannel åŒç†ï¼Œä¹Ÿéå¸¸ç®€å•ï¼Œä» <code>ServerBootstrap#bind(...)</code> æ–¹æ³•ä¸€è·¯ç‚¹è¿›å»å°±æ¸…æ¥šäº†ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬çŸ¥é“äº†ï¼ŒNioSocketChannel åœ¨å®ä¾‹åŒ–è¿‡ç¨‹ä¸­ï¼Œä¼šå…ˆå®ä¾‹åŒ– JDK åº•å±‚çš„ SocketChannelï¼ŒNioServerSocketChannel ä¹Ÿä¸€æ ·ï¼Œä¼šå…ˆå®ä¾‹åŒ– ServerSocketChannel å®ä¾‹ï¼š</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/netty-source/18.png" alt="18"></p>
<p>è¯´åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬é¡ºä¾¿å†ç»§ç»­å¾€é‡Œçœ‹ä¸€ä¸‹ NioSocketChannel çš„æ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">NioSocketChannel</span><span class="params">(SelectorProvider provider)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(newSocket(provider));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆšæ‰æˆ‘ä»¬çœ‹åˆ°è¿™é‡Œï¼ŒnewSocket(provider) åˆ›å»ºäº†åº•å±‚çš„ SocketChannel å®ä¾‹ï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹æ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">NioSocketChannel</span><span class="params">(Channel parent, SocketChannel socket)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(parent, socket);</span><br><span class="line">    config = <span class="keyword">new</span> <span class="title class_">NioSocketChannelConfig</span>(<span class="built_in">this</span>, socket.socket());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢æœ‰ä¸¤è¡Œä»£ç ï¼Œç¬¬äºŒè¡Œä»£ç å¾ˆç®€å•ï¼Œå®ä¾‹åŒ–äº†å†…éƒ¨çš„ NioSocketChannelConfig å®ä¾‹ï¼Œå®ƒç”¨äºä¿å­˜ channel çš„é…ç½®ä¿¡æ¯ï¼Œè¿™é‡Œæ²¡æœ‰æˆ‘ä»¬ç°åœ¨éœ€è¦å…³å¿ƒçš„å†…å®¹ï¼Œç›´æ¥è·³è¿‡ã€‚</p>
<p>ç¬¬ä¸€è¡Œè°ƒç”¨çˆ¶ç±»æ„é€ å™¨ï¼Œé™¤äº†è®¾ç½®å±æ€§å¤–ï¼Œè¿˜è®¾ç½®äº† SocketChannel çš„éé˜»å¡æ¨¡å¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">AbstractNioByteChannel</span><span class="params">(Channel parent, SelectableChannel ch)</span> &#123;</span><br><span class="line">    <span class="comment">// æ¯«æ— ç–‘é—®ï¼Œå®¢æˆ·ç«¯å…³å¿ƒçš„æ˜¯ OP_READ äº‹ä»¶ï¼Œç­‰å¾…è¯»å–æœåŠ¡ç«¯è¿”å›æ•°æ®</span></span><br><span class="line">    <span class="built_in">super</span>(parent, ch, SelectionKey.OP_READ);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç„¶åæ˜¯åˆ°è¿™é‡Œ</span></span><br><span class="line"><span class="keyword">protected</span> <span class="title function_">AbstractNioChannel</span><span class="params">(Channel parent, SelectableChannel ch, <span class="type">int</span> readInterestOp)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(parent);</span><br><span class="line">    <span class="built_in">this</span>.ch = ch;</span><br><span class="line">    <span class="comment">// æˆ‘ä»¬çœ‹åˆ°è¿™é‡Œåªæ˜¯ä¿å­˜äº† SelectionKey.OP_READ è¿™ä¸ªä¿¡æ¯ï¼Œåœ¨åé¢çš„æ—¶å€™ä¼šç”¨åˆ°</span></span><br><span class="line">    <span class="built_in">this</span>.readInterestOp = readInterestOp;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ******è®¾ç½® channel çš„éé˜»å¡æ¨¡å¼******</span></span><br><span class="line">        ch.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NioServerSocketChannel çš„æ„é€ æ–¹æ³•ç±»ä¼¼ï¼Œä¹Ÿè®¾ç½®äº†éé˜»å¡ï¼Œç„¶åè®¾ç½®æœåŠ¡ç«¯å…³å¿ƒçš„ SelectionKey.OP_ACCEPT äº‹ä»¶ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">NioServerSocketChannel</span><span class="params">(ServerSocketChannel channel)</span> &#123;</span><br><span class="line">    <span class="comment">// å¯¹äºæœåŠ¡ç«¯æ¥è¯´ï¼Œå…³å¿ƒçš„æ˜¯ SelectionKey.OP_ACCEPT äº‹ä»¶ï¼Œç­‰å¾…å®¢æˆ·ç«¯è¿æ¥</span></span><br><span class="line">    <span class="built_in">super</span>(<span class="literal">null</span>, channel, SelectionKey.OP_ACCEPT);</span><br><span class="line">    config = <span class="keyword">new</span> <span class="title class_">NioServerSocketChannelConfig</span>(<span class="built_in">this</span>, javaChannel().socket());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™èŠ‚å…³äº Channel çš„å†…å®¹æˆ‘ä»¬å…ˆä»‹ç»è¿™ä¹ˆå¤šï¼Œä¸»è¦å°±æ˜¯å®ä¾‹åŒ–äº† JDK å±‚çš„ SocketChannel æˆ– ServerSocketChannelï¼Œç„¶åè®¾ç½®äº†éé˜»å¡æ¨¡å¼ï¼Œæˆ‘ä»¬åé¢å†ç»§ç»­æ·±å…¥ä¸‹å»ã€‚</p>
<h2 id="Netty-ä¸­çš„-Futureã€Promise"><a href="#Netty-ä¸­çš„-Futureã€Promise" class="headerlink" title="Netty ä¸­çš„ Futureã€Promise"></a>Netty ä¸­çš„ Futureã€Promise</h2><p>Netty ä¸­éå¸¸å¤šçš„å¼‚æ­¥è°ƒç”¨ï¼Œæ‰€ä»¥åœ¨ä»‹ç»æ›´å¤š NIO ç›¸å…³çš„å†…å®¹ä¹‹å‰ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„å¼‚æ­¥æ¥å£æ˜¯æ€ä¹ˆä½¿ç”¨çš„ã€‚</p>
<p>å‰é¢æˆ‘ä»¬åœ¨ä»‹ç» Echo ä¾‹å­çš„æ—¶å€™ï¼Œå·²ç»ç”¨è¿‡äº† ChannelFuture è¿™ä¸ªæ¥å£äº†ï¼š</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/netty-source/6.png" alt="6"></p>
<p>äº‰å–åœ¨çœ‹å®Œæœ¬èŠ‚åï¼Œè¯»è€…èƒ½ææ¸…æ¥šä¸Šé¢çš„è¿™å‡ è¡Œåˆ’çº¿éƒ¨åˆ†æ˜¯æ€ä¹ˆèµ°çš„ã€‚</p>
<p>å…³äº Future æ¥å£ï¼Œæˆ‘æƒ³å¤§å®¶åº”è¯¥éƒ½å¾ˆç†Ÿæ‚‰ï¼Œç”¨å¾—æœ€å¤šçš„å°±æ˜¯åœ¨ä½¿ç”¨ Java çš„çº¿ç¨‹æ±  ThreadPoolExecutor çš„æ—¶å€™äº†ã€‚åœ¨ <strong>submit</strong> ä¸€ä¸ªä»»åŠ¡åˆ°çº¿ç¨‹æ± ä¸­çš„æ—¶å€™ï¼Œè¿”å›çš„å°±æ˜¯ä¸€ä¸ª <strong>Future</strong> å®ä¾‹ï¼Œé€šè¿‡å®ƒæ¥è·å–æäº¤çš„ä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€å’Œæœ€ç»ˆçš„æ‰§è¡Œç»“æœï¼Œæˆ‘ä»¬æœ€å¸¸ç”¨å®ƒçš„ <code>isDone()</code> å’Œ <code>get()</code> æ–¹æ³•ã€‚</p>
<p>ä¸‹é¢æ˜¯ JDK  ä¸­çš„ Future æ¥å£ java.util.concurrent.Futureï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Future</span>&lt;V&gt; &#123;</span><br><span class="line">	<span class="comment">// å–æ¶ˆè¯¥ä»»åŠ¡</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">cancel</span><span class="params">(<span class="type">boolean</span> mayInterruptIfRunning)</span>;</span><br><span class="line">    <span class="comment">// ä»»åŠ¡æ˜¯å¦å·²å–æ¶ˆ</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isCancelled</span><span class="params">()</span>;</span><br><span class="line">	<span class="comment">// ä»»åŠ¡æ˜¯å¦å·²å®Œæˆ</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isDone</span><span class="params">()</span>;</span><br><span class="line">    <span class="comment">// é˜»å¡è·å–ä»»åŠ¡æ‰§è¡Œç»“æœ</span></span><br><span class="line">    V <span class="title function_">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException;</span><br><span class="line">    <span class="comment">// å¸¦è¶…æ—¶å‚æ•°çš„è·å–ä»»åŠ¡æ‰§è¡Œç»“æœ</span></span><br><span class="line">    V <span class="title function_">get</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span></span><br><span class="line">        <span class="keyword">throws</span> InterruptedException, ExecutionException, TimeoutException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Netty ä¸­çš„ Future æ¥å£ï¼ˆåŒåï¼‰ç»§æ‰¿äº† JDK ä¸­çš„ Future æ¥å£ï¼Œç„¶åæ·»åŠ äº†ä¸€äº›æ–¹æ³•ï¼š</p>
<p>// io.netty.util.concurrent.Future</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Future</span>&lt;V&gt; <span class="keyword">extends</span> <span class="title class_">java</span>.util.concurrent.Future&lt;V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¯å¦æˆåŠŸ</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isSuccess</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// æ˜¯å¦å¯å–æ¶ˆ</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isCancellable</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œè¿™ä¸ªæ–¹æ³•è¿”å›å¼‚å¸¸ä¿¡æ¯</span></span><br><span class="line">    Throwable <span class="title function_">cause</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ·»åŠ  Listener æ¥è¿›è¡Œå›è°ƒ</span></span><br><span class="line">    Future&lt;V&gt; <span class="title function_">addListener</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="built_in">super</span> V&gt;&gt; listener)</span>;</span><br><span class="line">    Future&lt;V&gt; <span class="title function_">addListeners</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="built_in">super</span> V&gt;&gt;... listeners)</span>;</span><br><span class="line"></span><br><span class="line">    Future&lt;V&gt; <span class="title function_">removeListener</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="built_in">super</span> V&gt;&gt; listener)</span>;</span><br><span class="line">    Future&lt;V&gt; <span class="title function_">removeListeners</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="built_in">super</span> V&gt;&gt;... listeners)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é˜»å¡ç­‰å¾…ä»»åŠ¡ç»“æŸï¼Œå¦‚æœä»»åŠ¡å¤±è´¥ï¼Œå°†â€œå¯¼è‡´å¤±è´¥çš„å¼‚å¸¸â€é‡æ–°æŠ›å‡ºæ¥</span></span><br><span class="line">    Future&lt;V&gt; <span class="title function_">sync</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line">    <span class="comment">// ä¸å“åº”ä¸­æ–­çš„ sync()ï¼Œè¿™ä¸ªå¤§å®¶åº”è¯¥éƒ½å¾ˆç†Ÿäº†</span></span><br><span class="line">    Future&lt;V&gt; <span class="title function_">syncUninterruptibly</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é˜»å¡ç­‰å¾…ä»»åŠ¡ç»“æŸï¼Œå’Œ sync() åŠŸèƒ½æ˜¯ä¸€æ ·çš„ï¼Œä¸è¿‡å¦‚æœä»»åŠ¡å¤±è´¥ï¼Œå®ƒä¸ä¼šæŠ›å‡ºæ‰§è¡Œè¿‡ç¨‹ä¸­çš„å¼‚å¸¸</span></span><br><span class="line">    Future&lt;V&gt; <span class="title function_">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line">    Future&lt;V&gt; <span class="title function_">awaitUninterruptibly</span><span class="params">()</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">await</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">await</span><span class="params">(<span class="type">long</span> timeoutMillis)</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">awaitUninterruptibly</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">awaitUninterruptibly</span><span class="params">(<span class="type">long</span> timeoutMillis)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–æ‰§è¡Œç»“æœï¼Œä¸é˜»å¡ã€‚æˆ‘ä»¬éƒ½çŸ¥é“ java.util.concurrent.Future ä¸­çš„ get() æ˜¯é˜»å¡çš„</span></span><br><span class="line">    V <span class="title function_">getNow</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å–æ¶ˆä»»åŠ¡æ‰§è¡Œï¼Œå¦‚æœå–æ¶ˆæˆåŠŸï¼Œä»»åŠ¡ä¼šå› ä¸º CancellationException å¼‚å¸¸è€Œå¯¼è‡´å¤±è´¥</span></span><br><span class="line">    <span class="comment">//	  ä¹Ÿå°±æ˜¯ isSuccess()==falseï¼ŒåŒæ—¶ä¸Šé¢çš„ cause() æ–¹æ³•è¿”å› CancellationException çš„å®ä¾‹ã€‚</span></span><br><span class="line">    <span class="comment">// mayInterruptIfRunning è¯´çš„æ˜¯ï¼šæ˜¯å¦å¯¹æ­£åœ¨æ‰§è¡Œè¯¥ä»»åŠ¡çš„çº¿ç¨‹è¿›è¡Œä¸­æ–­(è¿™æ ·æ‰èƒ½åœæ­¢è¯¥ä»»åŠ¡çš„æ‰§è¡Œ)ï¼Œ</span></span><br><span class="line">    <span class="comment">// 	  ä¼¼ä¹ Netty ä¸­ Future æ¥å£çš„å„ä¸ªå®ç°ç±»ï¼Œéƒ½æ²¡æœ‰ä½¿ç”¨è¿™ä¸ªå‚æ•°</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">cancel</span><span class="params">(<span class="type">boolean</span> mayInterruptIfRunning)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>çœ‹å®Œä¸Šé¢çš„ Netty çš„ Future æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå®ƒåŠ äº† sync() å’Œ await() ç”¨äºé˜»å¡ç­‰å¾…ï¼Œè¿˜åŠ äº† Listenersï¼Œåªè¦ä»»åŠ¡ç»“æŸå»å›è°ƒ Listener ä»¬å°±å¯ä»¥äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä¸ä¸€å®šè¦ä¸»åŠ¨è°ƒç”¨ isDone() æ¥è·å–çŠ¶æ€ï¼Œæˆ–é€šè¿‡ get() é˜»å¡æ–¹æ³•æ¥è·å–å€¼ã€‚</p>
<blockquote>
<p>æ‰€ä»¥å®ƒå…¶å®æœ‰ä¸¤ç§ä½¿ç”¨èŒƒå¼</p>
</blockquote>
<p>é¡ºä¾¿è¯´ä¸‹ sync() å’Œ await() çš„åŒºåˆ«ï¼šsync() å†…éƒ¨ä¼šå…ˆè°ƒç”¨ await() æ–¹æ³•ï¼Œç­‰ await() æ–¹æ³•è¿”å›åï¼Œä¼šæ£€æŸ¥ä¸‹<strong>è¿™ä¸ªä»»åŠ¡æ˜¯å¦å¤±è´¥</strong>ï¼Œå¦‚æœå¤±è´¥ï¼Œé‡æ–°å°†å¯¼è‡´å¤±è´¥çš„å¼‚å¸¸æŠ›å‡ºæ¥ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä½¿ç”¨ await()ï¼Œä»»åŠ¡æŠ›å‡ºå¼‚å¸¸åï¼Œawait() æ–¹æ³•ä¼šè¿”å›ï¼Œä½†æ˜¯ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œ sync() æ–¹æ³•è¿”å›çš„åŒæ—¶ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p>
<blockquote>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼ŒFuture æ¥å£æ²¡æœ‰å’Œ IO æ“ä½œå…³è”åœ¨ä¸€èµ·ï¼Œè¿˜æ˜¯æ¯”è¾ƒ<em>çº¯å‡€</em>çš„æ¥å£ã€‚</p>
</blockquote>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ Future æ¥å£çš„å­æ¥å£ ChannelFutureï¼Œè¿™ä¸ªæ¥å£ç”¨å¾—æœ€å¤šï¼Œå®ƒå°†å’Œ IO æ“ä½œä¸­çš„ Channel å…³è”åœ¨ä¸€èµ·äº†ï¼Œç”¨äºå¼‚æ­¥å¤„ç† Channel ä¸­çš„äº‹ä»¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ChannelFuture</span> <span class="keyword">extends</span> <span class="title class_">Future</span>&lt;Void&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ChannelFuture å…³è”çš„ Channel</span></span><br><span class="line">    Channel <span class="title function_">channel</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¦†å†™ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•ï¼Œä½¿å¾—å®ƒä»¬è¿”å›å€¼ä¸º ChannelFuture ç±»å‹ </span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    ChannelFuture <span class="title function_">addListener</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="built_in">super</span> Void&gt;&gt; listener)</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    ChannelFuture <span class="title function_">addListeners</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="built_in">super</span> Void&gt;&gt;... listeners)</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    ChannelFuture <span class="title function_">removeListener</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="built_in">super</span> Void&gt;&gt; listener)</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    ChannelFuture <span class="title function_">removeListeners</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="built_in">super</span> Void&gt;&gt;... listeners)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    ChannelFuture <span class="title function_">sync</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    ChannelFuture <span class="title function_">syncUninterruptibly</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    ChannelFuture <span class="title function_">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    ChannelFuture <span class="title function_">awaitUninterruptibly</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”¨æ¥æ ‡è®°è¯¥ future æ˜¯ void çš„ï¼Œ</span></span><br><span class="line">    <span class="comment">// è¿™æ ·å°±ä¸å…è®¸ä½¿ç”¨ addListener(...), sync(), await() ä»¥åŠå®ƒä»¬çš„å‡ ä¸ªé‡è½½æ–¹æ³•</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isVoid</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬çœ‹åˆ°ï¼ŒChannelFuture æ¥å£ç›¸å¯¹äº Future æ¥å£ï¼Œé™¤äº†å°† channel å…³è”è¿›æ¥ï¼Œæ²¡æœ‰å¢åŠ ä»€ä¹ˆä¸œè¥¿ã€‚è¿˜æœ‰ä¸ª isVoid() æ–¹æ³•ç®—æ˜¯ä¸é‚£ä¹ˆé‡è¦çš„å­˜åœ¨å§ã€‚å…¶ä»–å‡ ä¸ªéƒ½æ˜¯æ–¹æ³•è¦†å†™ï¼Œä¸ºäº†è®©è¿”å›å€¼ç±»å‹å˜ä¸º ChannelFutureï¼Œè€Œä¸æ˜¯åŸæ¥çš„ Futureã€‚</p>
<p>è¿™é‡Œæœ‰ç‚¹è·³ï¼Œæˆ‘ä»¬æ¥ä»‹ç»ä¸‹ Promise æ¥å£ï¼Œå®ƒå’Œ ChannelFuture æ¥å£æ— å…³ï¼Œè€Œæ˜¯å’Œå‰é¢çš„ Future æ¥å£ç›¸å…³ï¼ŒPromise è¿™ä¸ªæ¥å£éå¸¸é‡è¦ã€‚</p>
<p>Promise æ¥å£å’Œ ChannelFuture ä¸€æ ·ï¼Œä¹Ÿç»§æ‰¿äº† Netty çš„ Future æ¥å£ï¼Œç„¶ååŠ äº†ä¸€äº› Promise çš„å†…å®¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Promise</span>&lt;V&gt; <span class="keyword">extends</span> <span class="title class_">Future</span>&lt;V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ‡è®°è¯¥ future æˆåŠŸåŠè®¾ç½®å…¶æ‰§è¡Œç»“æœï¼Œå¹¶ä¸”ä¼šé€šçŸ¥æ‰€æœ‰çš„ listenersã€‚</span></span><br><span class="line">    <span class="comment">// å¦‚æœè¯¥æ“ä½œå¤±è´¥ï¼Œå°†æŠ›å‡ºå¼‚å¸¸(å¤±è´¥æŒ‡çš„æ˜¯è¯¥ future å·²ç»æœ‰äº†ç»“æœäº†ï¼ŒæˆåŠŸçš„ç»“æœï¼Œæˆ–è€…å¤±è´¥çš„ç»“æœ)</span></span><br><span class="line">    Promise&lt;V&gt; <span class="title function_">setSuccess</span><span class="params">(V result)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å’Œ setSuccess æ–¹æ³•ä¸€æ ·ï¼Œåªä¸è¿‡å¦‚æœå¤±è´¥ï¼Œå®ƒä¸æŠ›å¼‚å¸¸ï¼Œè¿”å› false</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">trySuccess</span><span class="params">(V result)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ‡è®°è¯¥ future å¤±è´¥ï¼ŒåŠå…¶å¤±è´¥åŸå› ã€‚</span></span><br><span class="line">    <span class="comment">// å¦‚æœå¤±è´¥ï¼Œå°†æŠ›å‡ºå¼‚å¸¸(å¤±è´¥æŒ‡çš„æ˜¯å·²ç»æœ‰äº†ç»“æœäº†)</span></span><br><span class="line">    Promise&lt;V&gt; <span class="title function_">setFailure</span><span class="params">(Throwable cause)</span>;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// æ ‡è®°è¯¥ future å¤±è´¥ï¼ŒåŠå…¶å¤±è´¥åŸå› ã€‚</span></span><br><span class="line">    <span class="comment">// å¦‚æœå·²ç»æœ‰ç»“æœï¼Œè¿”å› falseï¼Œä¸æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">tryFailure</span><span class="params">(Throwable cause)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ‡è®°è¯¥ future ä¸å¯ä»¥è¢«å–æ¶ˆ</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">setUncancellable</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™é‡Œå’Œ ChannelFuture ä¸€æ ·ï¼Œå¯¹è¿™å‡ ä¸ªæ–¹æ³•è¿›è¡Œè¦†å†™ï¼Œç›®çš„æ˜¯ä¸ºäº†è¿”å› Promise ç±»å‹çš„å®ä¾‹</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    Promise&lt;V&gt; <span class="title function_">addListener</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="built_in">super</span> V&gt;&gt; listener)</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    Promise&lt;V&gt; <span class="title function_">addListeners</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="built_in">super</span> V&gt;&gt;... listeners)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    Promise&lt;V&gt; <span class="title function_">removeListener</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="built_in">super</span> V&gt;&gt; listener)</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    Promise&lt;V&gt; <span class="title function_">removeListeners</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="built_in">super</span> V&gt;&gt;... listeners)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    Promise&lt;V&gt; <span class="title function_">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    Promise&lt;V&gt; <span class="title function_">awaitUninterruptibly</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    Promise&lt;V&gt; <span class="title function_">sync</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    Promise&lt;V&gt; <span class="title function_">syncUninterruptibly</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯èƒ½æœ‰äº›è¯»è€…å¯¹ Promise çš„æ¦‚å¿µä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œè¿™é‡Œç®€å•è¯´ä¸¤å¥ã€‚</p>
<p>æˆ‘è§‰å¾—åªè¦æ˜ç™½ä¸€ç‚¹ï¼ŒPromise å®ä¾‹å†…éƒ¨æ˜¯ä¸€ä¸ªä»»åŠ¡ï¼Œä»»åŠ¡çš„æ‰§è¡Œå¾€å¾€æ˜¯å¼‚æ­¥çš„ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªçº¿ç¨‹æ± æ¥å¤„ç†ä»»åŠ¡ã€‚Promise æä¾›çš„ setSuccess(V result) æˆ– setFailure(Throwable t) å°†æ¥ä¼šè¢«æŸä¸ªæ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹åœ¨æ‰§è¡Œå®Œæˆä»¥åè°ƒç”¨ï¼ŒåŒæ—¶é‚£ä¸ªçº¿ç¨‹åœ¨è°ƒç”¨ setSuccess(result) æˆ– setFailure(t) åä¼šå›è°ƒ listeners çš„å›è°ƒå‡½æ•°ï¼ˆå½“ç„¶ï¼Œå›è°ƒçš„å…·ä½“å†…å®¹ä¸ä¸€å®šè¦ç”±æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹è‡ªå·±æ¥æ‰§è¡Œï¼Œå®ƒå¯ä»¥åˆ›å»ºæ–°çš„çº¿ç¨‹æ¥æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥å°†å›è°ƒä»»åŠ¡æäº¤åˆ°æŸä¸ªçº¿ç¨‹æ± æ¥æ‰§è¡Œï¼‰ã€‚è€Œä¸”ï¼Œä¸€æ—¦ setSuccess(â€¦) æˆ– setFailure(â€¦) åï¼Œé‚£äº› await() æˆ– sync() çš„çº¿ç¨‹å°±ä¼šä»ç­‰å¾…ä¸­è¿”å›ã€‚</p>
<p><strong>æ‰€ä»¥è¿™é‡Œå°±æœ‰ä¸¤ç§ç¼–ç¨‹æ–¹å¼ï¼Œä¸€ç§æ˜¯ç”¨ await()ï¼Œç­‰ await() æ–¹æ³•è¿”å›åï¼Œå¾—åˆ° promise çš„æ‰§è¡Œç»“æœï¼Œç„¶åå¤„ç†å®ƒï¼›å¦ä¸€ç§å°±æ˜¯æä¾› Listener å®ä¾‹ï¼Œæˆ‘ä»¬ä¸å¤ªå…³å¿ƒä»»åŠ¡ä»€ä¹ˆæ—¶å€™ä¼šæ‰§è¡Œå®Œï¼Œåªè¦å®ƒæ‰§è¡Œå®Œäº†ä»¥åä¼šå»æ‰§è¡Œ listener ä¸­çš„å¤„ç†æ–¹æ³•å°±è¡Œã€‚</strong></p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹ <strong>ChannelPromise</strong>ï¼Œå®ƒç»§æ‰¿äº†å‰é¢ä»‹ç»çš„ ChannelFuture å’Œ Promise æ¥å£ã€‚</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/netty-source/4.png" alt="4"></p>
<p>ChannelPromise æ¥å£åœ¨ Netty ä¸­ä½¿ç”¨å¾—æ¯”è¾ƒå¤šï¼Œå› ä¸ºå®ƒç»¼åˆäº† ChannelFuture å’Œ Promise ä¸¤ä¸ªæ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Special &#123;<span class="doctag">@link</span> ChannelFuture&#125; which is writable.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ChannelPromise</span> <span class="keyword">extends</span> <span class="title class_">ChannelFuture</span>, Promise&lt;Void&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¦†å†™ ChannelFuture ä¸­çš„ channel() æ–¹æ³•ï¼Œå…¶å®è¿™ä¸ªæ–¹æ³•ä¸€ç‚¹æ²¡å˜</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    Channel <span class="title function_">channel</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸‹é¢å‡ ä¸ªæ–¹æ³•æ˜¯è¦†å†™ Promise ä¸­çš„æ¥å£ï¼Œä¸ºäº†è¿”å›å€¼ç±»å‹æ˜¯ ChannelPromise</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    ChannelPromise <span class="title function_">setSuccess</span><span class="params">(Void result)</span>;</span><br><span class="line">    ChannelPromise <span class="title function_">setSuccess</span><span class="params">()</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">trySuccess</span><span class="params">()</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    ChannelPromise <span class="title function_">setFailure</span><span class="params">(Throwable cause)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ°è¿™é‡Œå¤§å®¶åº”è¯¥éƒ½ç†Ÿæ‚‰äº†ï¼Œä¸‹é¢å‡ ä¸ªæ–¹æ³•çš„è¦†å†™ä¹Ÿæ˜¯ä¸ºäº†å¾—åˆ° ChannelPromise ç±»å‹çš„å®ä¾‹</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    ChannelPromise <span class="title function_">addListener</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="built_in">super</span> Void&gt;&gt; listener)</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    ChannelPromise <span class="title function_">addListeners</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="built_in">super</span> Void&gt;&gt;... listeners)</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    ChannelPromise <span class="title function_">removeListener</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="built_in">super</span> Void&gt;&gt; listener)</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    ChannelPromise <span class="title function_">removeListeners</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="built_in">super</span> Void&gt;&gt;... listeners)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    ChannelPromise <span class="title function_">sync</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    ChannelPromise <span class="title function_">syncUninterruptibly</span><span class="params">()</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    ChannelPromise <span class="title function_">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    ChannelPromise <span class="title function_">awaitUninterruptibly</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns a new &#123;<span class="doctag">@link</span> ChannelPromise&#125; if &#123;<span class="doctag">@link</span> #isVoid()&#125; returns &#123;<span class="doctag">@code</span> true&#125; otherwise itself.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// æˆ‘ä»¬å¿½ç•¥è¿™ä¸ªæ–¹æ³•å§ã€‚</span></span><br><span class="line">    ChannelPromise <span class="title function_">unvoid</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå®ƒç»¼åˆäº† ChannelFuture å’Œ Promise ä¸­çš„æ–¹æ³•ï¼Œåªä¸è¿‡é€šè¿‡è¦†å†™å°†è¿”å›å€¼éƒ½å˜ä¸º ChannelPromise äº†è€Œå·²ï¼Œ<strong>æ²¡æœ‰å¢åŠ ä»€ä¹ˆæ–°çš„åŠŸèƒ½</strong>ã€‚</p>
<p>å°ç»“ä¸€ä¸‹ï¼Œæˆ‘ä»¬ä¸Šé¢ä»‹ç»äº†å‡ ä¸ªæ¥å£ï¼ŒFuture ä»¥åŠå®ƒçš„å­æ¥å£ ChannelFuture å’Œ Promiseï¼Œç„¶åæ˜¯ ChannelPromise æ¥å£åŒæ—¶ç»§æ‰¿äº† ChannelFuture å’Œ Promiseã€‚</p>
<p>æˆ‘æŠŠè¿™å‡ ä¸ªæ¥å£çš„ä¸»è¦æ–¹æ³•åˆ—åœ¨ä¸€èµ·ï¼Œè¿™æ ·å¤§å®¶çœ‹å¾—æ¸…æ™°äº›ï¼š</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/netty-source/7.png" alt="4"></p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦æ¥ä¸€ä¸ªå®ç°ç±»ï¼Œè¿™æ ·æ‰èƒ½æ¯”è¾ƒç›´è§‚åœ°çœ‹å‡ºå®ƒä»¬æ˜¯æ€ä¹ˆä½¿ç”¨çš„ï¼Œå› ä¸ºä¸Šé¢çš„è¿™äº›éƒ½æ˜¯æ¥å£å®šä¹‰ï¼Œå…·ä½“è¿˜å¾—çœ‹å®ç°ç±»æ˜¯æ€ä¹ˆå·¥ä½œçš„ã€‚</p>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥ä»‹ç»ä¸‹ <strong>DefaultPromise</strong> è¿™ä¸ªå®ç°ç±»ï¼Œè¿™ä¸ªç±»å¾ˆå¸¸ç”¨ï¼Œå®ƒçš„æºç ä¹Ÿä¸çŸ­ï¼Œæˆ‘ä»¬å…ˆä»‹ç»å‡ ä¸ªå…³é”®çš„å†…å®¹ï¼Œç„¶åä»‹ç»ä¸€ä¸ªç¤ºä¾‹ä½¿ç”¨ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬çœ‹ä¸‹å®ƒæœ‰å“ªäº›å±æ€§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultPromise</span>&lt;V&gt; <span class="keyword">extends</span> <span class="title class_">AbstractFuture</span>&lt;V&gt; <span class="keyword">implements</span> <span class="title class_">Promise</span>&lt;V&gt; &#123;</span><br><span class="line">	  <span class="comment">// ä¿å­˜æ‰§è¡Œç»“æœ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Object result;</span><br><span class="line">    <span class="comment">// æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ± ï¼Œpromise æŒæœ‰ executor çš„å¼•ç”¨ï¼Œè¿™ä¸ªå…¶å®æœ‰ç‚¹å¥‡æ€ªäº†</span></span><br><span class="line">    <span class="comment">// å› ä¸ºâ€œä»»åŠ¡â€å…¶å®æ²¡å¿…è¦çŸ¥é“è‡ªå·±åœ¨å“ªé‡Œè¢«æ‰§è¡Œçš„</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EventExecutor executor;</span><br><span class="line">	  <span class="comment">// ç›‘å¬è€…ï¼Œå›è°ƒå‡½æ•°ï¼Œä»»åŠ¡ç»“æŸåï¼ˆæ­£å¸¸æˆ–å¼‚å¸¸ç»“æŸï¼‰æ‰§è¡Œ</span></span><br><span class="line">    <span class="keyword">private</span> Object listeners;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…è¿™ä¸ª promise çš„çº¿ç¨‹æ•°(è°ƒç”¨sync()/await()è¿›è¡Œç­‰å¾…çš„çº¿ç¨‹æ•°é‡)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">short</span> waiters;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¯å¦æ­£åœ¨å”¤é†’ç­‰å¾…çº¿ç¨‹ï¼Œç”¨äºé˜²æ­¢é‡å¤æ‰§è¡Œå”¤é†’ï¼Œä¸ç„¶ä¼šé‡å¤æ‰§è¡Œ listeners çš„å›è°ƒæ–¹æ³•</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> notifyingListeners;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å¯ä»¥çœ‹å‡ºï¼Œæ­¤ç±»å®ç°äº† Promiseï¼Œä½†æ˜¯æ²¡æœ‰å®ç° ChannelFutureï¼Œæ‰€ä»¥å®ƒå’Œ Channel è”ç³»ä¸èµ·æ¥ã€‚</p>
<p>åˆ«æ€¥ï¼Œæˆ‘ä»¬åé¢ä¼šç¢°åˆ°å¦ä¸€ä¸ªç±» DefaultChannelPromise çš„ä½¿ç”¨ï¼Œè¿™ä¸ªç±»æ˜¯ç»¼åˆäº† ChannelFuture å’Œ Promise çš„ï¼Œä½†æ˜¯å®ƒçš„å®ç°å…¶å®å¤§éƒ¨åˆ†éƒ½æ˜¯ç»§æ‰¿è‡ªè¿™é‡Œçš„ DefaultPromise ç±»çš„ã€‚</p>
</blockquote>
<p>è¯´å®Œä¸Šé¢çš„å±æ€§ä»¥åï¼Œå¤§å®¶å¯ä»¥çœ‹ä¸‹ <code>setSuccess(V result)</code> ã€<code>trySuccess(V result)</code> å’Œ <code>setFailure(Throwable cause)</code> ã€ <code>tryFailure(Throwable cause)</code> è¿™å‡ ä¸ªæ–¹æ³•ï¼š</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/netty-source/8.png" alt="8"></p>
<blockquote>
<p>çœ‹å‡º setSuccess(result) å’Œ trySuccess(result) çš„åŒºåˆ«äº†å—ï¼Ÿ</p>
</blockquote>
<p>ä¸Šé¢å‡ ä¸ªæ–¹æ³•éƒ½éå¸¸ç®€å•ï¼Œå…ˆè®¾ç½®å¥½å€¼ï¼Œç„¶åæ‰§è¡Œç›‘å¬è€…ä»¬çš„å›è°ƒæ–¹æ³•ã€‚notifyListeners() æ–¹æ³•æ„Ÿå…´è¶£çš„è¯»è€…ä¹Ÿå¯ä»¥çœ‹ä¸€çœ‹ï¼Œä¸è¿‡å®ƒè¿˜æ¶‰åŠåˆ° Netty çº¿ç¨‹æ± çš„ä¸€äº›å†…å®¹ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰ä»‹ç»åˆ°çº¿ç¨‹æ± ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚ä¸Šé¢çš„ä»£ç ï¼Œåœ¨ setSuccess0 æˆ– setFailure0 æ–¹æ³•ä¸­éƒ½ä¼šå”¤é†’é˜»å¡åœ¨ sync() æˆ– await() çš„çº¿ç¨‹</p>
<p>å¦å¤–ï¼Œå°±æ˜¯å¯ä»¥çœ‹ä¸‹ sync() å’Œ await() çš„åŒºåˆ«ï¼Œå…¶ä»–çš„æˆ‘è§‰å¾—éšä¾¿çœ‹çœ‹å°±å¥½äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Promise&lt;V&gt; <span class="title function_">sync</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    await();</span><br><span class="line">    <span class="comment">// å¦‚æœä»»åŠ¡æ˜¯å¤±è´¥çš„ï¼Œé‡æ–°æŠ›å‡ºç›¸åº”çš„å¼‚å¸¸</span></span><br><span class="line">    rethrowIfFailed();</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥å†™ä¸ªå®ä¾‹ä»£ç å§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„é€ çº¿ç¨‹æ± </span></span><br><span class="line">    <span class="type">EventExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultEventExecutor</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»º DefaultPromise å®ä¾‹</span></span><br><span class="line">    <span class="type">Promise</span> <span class="variable">promise</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultPromise</span>(executor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸‹é¢ç»™è¿™ä¸ª promise æ·»åŠ ä¸¤ä¸ª listener</span></span><br><span class="line">    promise.addListener(<span class="keyword">new</span> <span class="title class_">GenericFutureListener</span>&lt;Future&lt;Integer&gt;&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">operationComplete</span><span class="params">(Future future)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="keyword">if</span> (future.isSuccess()) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;ä»»åŠ¡ç»“æŸï¼Œç»“æœï¼š&quot;</span> + future.get());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;ä»»åŠ¡å¤±è´¥ï¼Œå¼‚å¸¸ï¼š&quot;</span> + future.cause());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).addListener(<span class="keyword">new</span> <span class="title class_">GenericFutureListener</span>&lt;Future&lt;Integer&gt;&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">operationComplete</span><span class="params">(Future future)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ä»»åŠ¡ç»“æŸï¼Œbalabala...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± ï¼Œäº”ç§’åæ‰§è¡Œç»“æŸï¼Œè®¾ç½®æ‰§è¡Œ promise çš„ç»“æœ</span></span><br><span class="line">    executor.submit(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// è®¾ç½® promise çš„ç»“æœ</span></span><br><span class="line">            <span class="comment">// promise.setFailure(new RuntimeException());</span></span><br><span class="line">            promise.setSuccess(<span class="number">123456</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// main çº¿ç¨‹é˜»å¡ç­‰å¾…æ‰§è¡Œç»“æœ</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        promise.sync();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œä»£ç ï¼Œä¸¤ä¸ª listener å°†åœ¨ 5 ç§’åå°†è¾“å‡ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ä»»åŠ¡ç»“æŸï¼Œç»“æœï¼š123456</span><br><span class="line">ä»»åŠ¡ç»“æŸï¼Œbalabala...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¯»è€…è¿™é‡Œå¯ä»¥è¯•ä¸€ä¸‹ sync() å’Œ await() çš„åŒºåˆ«ï¼Œåœ¨ä»»åŠ¡ä¸­è°ƒç”¨ promise.setFailure(new RuntimeException()) è¯•è¯•çœ‹ã€‚</p>
</blockquote>
<p>ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå¤§å®¶å¯èƒ½ä¼šå¯¹çº¿ç¨‹æ±  executor å’Œ promise ä¹‹é—´çš„å…³ç³»æ„Ÿåˆ°æœ‰ç‚¹è¿·æƒ‘ã€‚è¯»è€…åº”è¯¥ä¹Ÿè¦æ¸…æ¥šï¼Œå…·ä½“çš„ä»»åŠ¡ä¸ä¸€å®šå°±è¦åœ¨è¿™ä¸ª executor ä¸­è¢«æ‰§è¡Œã€‚ä»»åŠ¡ç»“æŸä»¥åï¼Œéœ€è¦è°ƒç”¨ promise.setSuccess(result) ä½œä¸ºé€šçŸ¥ã€‚</p>
<p>é€šå¸¸æ¥è¯´ï¼Œpromise ä»£è¡¨çš„ future æ˜¯ä¸éœ€è¦å’Œçº¿ç¨‹æ± æ…åœ¨ä¸€èµ·çš„ï¼Œfuture åªå…³å¿ƒä»»åŠ¡æ˜¯å¦ç»“æŸä»¥åŠä»»åŠ¡çš„æ‰§è¡Œç»“æœï¼Œè‡³äºæ˜¯å“ªä¸ªçº¿ç¨‹æˆ–å“ªä¸ªçº¿ç¨‹æ± æ‰§è¡Œçš„ä»»åŠ¡ï¼Œfuture å…¶å®æ˜¯ä¸å…³å¿ƒçš„ã€‚</p>
<p>ä¸è¿‡ Netty æ¯•ç«Ÿä¸æ˜¯è¦åˆ›å»ºä¸€ä¸ªé€šç”¨çš„çº¿ç¨‹æ± å®ç°ï¼Œè€Œæ˜¯å’Œå®ƒè¦å¤„ç†çš„ IO æ¯æ¯ç›¸å…³çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åªä¸è¿‡è¦ç†è§£å®ƒå°±å¥½äº†ã€‚</p>
<p>è¿™èŠ‚å°±è¯´è¿™ä¹ˆå¤šå§ï¼Œæˆ‘ä»¬å›è¿‡å¤´æ¥å†çœ‹ä¸€ä¸‹è¿™å¼ å›¾ï¼Œçœ‹çœ‹å¤§å®¶æ˜¯ä¸æ˜¯çœ‹æ‡‚äº†è¿™èŠ‚å†…å®¹ï¼š</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/netty-source/6.png" alt="6"></p>
<p>æˆ‘ä»¬å°±è¯´è¯´ä¸Šå›¾å·¦è¾¹çš„éƒ¨åˆ†å§ï¼Œè™½ç„¶æˆ‘ä»¬è¿˜ä¸çŸ¥é“ bind() æ“ä½œä¸­å…·ä½“ä¼šåšä»€ä¹ˆå·¥ä½œï¼Œä½†æ˜¯æˆ‘ä»¬åº”è¯¥å¯ä»¥çŒœå‡ºä¸€äºŒã€‚</p>
<p>æ˜¾ç„¶ï¼Œmain çº¿ç¨‹è°ƒç”¨ b.bind(port) è¿™ä¸ªæ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª ChannelFutureï¼Œbind() æ˜¯ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•ï¼Œå½“æŸä¸ªæ‰§è¡Œçº¿ç¨‹æ‰§è¡Œäº†çœŸæ­£çš„ç»‘å®šæ“ä½œåï¼Œé‚£ä¸ªæ‰§è¡Œçº¿ç¨‹ä¸€å®šä¼šæ ‡è®°è¿™ä¸ª future ä¸ºæˆåŠŸï¼ˆæˆ‘ä»¬å‡å®š bind ä¼šæˆåŠŸï¼‰ï¼Œç„¶åè¿™é‡Œçš„ sync() æ–¹æ³•ï¼ˆmain çº¿ç¨‹ï¼‰å°±ä¼šè¿”å›äº†ã€‚</p>
<blockquote>
<p>å¦‚æœ bind(port) å¤±è´¥ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œsync() æ–¹æ³•ä¼šå°†å¼‚å¸¸æŠ›å‡ºæ¥ï¼Œç„¶åå°±ä¼šæ‰§è¡Œåˆ° finally å—äº†ã€‚ </p>
</blockquote>
<p>ä¸€æ—¦ç»‘å®šç«¯å£ bind æˆåŠŸï¼Œè¿›å…¥ä¸‹é¢ä¸€è¡Œï¼Œf.channel() æ–¹æ³•ä¼šè¿”å›è¯¥ future å…³è”çš„ channelã€‚</p>
<p>channel.closeFuture() ä¹Ÿä¼šè¿”å›ä¸€ä¸ª ChannelFutureï¼Œç„¶åè°ƒç”¨äº† sync() æ–¹æ³•ï¼Œè¿™ä¸ª sync() æ–¹æ³•è¿”å›çš„æ¡ä»¶æ˜¯ï¼š<strong>æœ‰å…¶ä»–çš„çº¿ç¨‹å…³é—­äº† NioServerSocketChannel</strong>ï¼Œå¾€å¾€æ˜¯å› ä¸ºéœ€è¦åœæ‰æœåŠ¡äº†ï¼Œç„¶åé‚£ä¸ªçº¿ç¨‹ä¼šè®¾ç½® future çš„çŠ¶æ€ï¼ˆ setSuccess(result) æˆ– setFailure(cause) ï¼‰ï¼Œè¿™ä¸ª sync() æ–¹æ³•æ‰ä¼šè¿”å›ã€‚</p>
<p>è¿™èŠ‚å°±åˆ°è¿™é‡Œï¼Œå¸Œæœ›å¤§å®¶å¯¹ Netty ä¸­çš„å¼‚æ­¥ç¼–ç¨‹æœ‰äº›äº†è§£ï¼Œåç»­ç¢°åˆ°æºç çš„æ—¶å€™èƒ½çŸ¥é“æ˜¯æ€ä¹ˆä½¿ç”¨çš„äº†ã€‚</p>
<h2 id="ChannelPipelineï¼Œå’Œ-Inboundã€Outbound"><a href="#ChannelPipelineï¼Œå’Œ-Inboundã€Outbound" class="headerlink" title="ChannelPipelineï¼Œå’Œ Inboundã€Outbound"></a>ChannelPipelineï¼Œå’Œ Inboundã€Outbound</h2><p>æˆ‘æƒ³å¾ˆå¤šè¯»è€…åº”è¯¥æˆ–å¤šæˆ–å°‘éƒ½æœ‰ Netty ä¸­ pipeline çš„æ¦‚å¿µã€‚å‰é¢æˆ‘ä»¬è¯´äº†ï¼Œä½¿ç”¨ Netty çš„æ—¶å€™ï¼Œæˆ‘ä»¬é€šå¸¸å°±åªè¦å†™ä¸€äº›è‡ªå®šä¹‰çš„ handler å°±å¯ä»¥äº†ï¼Œæˆ‘ä»¬å®šä¹‰çš„è¿™äº› handler ä¼šç»„æˆä¸€ä¸ª pipelineï¼Œç”¨äºå¤„ç† IO äº‹ä»¶ï¼Œè¿™ä¸ªå’Œæˆ‘ä»¬å¹³æ—¶æ¥è§¦çš„ Filter æˆ– Interceptor è¡¨è¾¾çš„å·®ä¸å¤šæ˜¯ä¸€ä¸ªæ„æ€ã€‚</p>
<p>æ¯ä¸ª Channel å†…éƒ¨éƒ½æœ‰ä¸€ä¸ª pipelineï¼Œpipeline ç”±å¤šä¸ª handler ç»„æˆï¼Œhandler ä¹‹é—´çš„é¡ºåºæ˜¯å¾ˆé‡è¦çš„ï¼Œå› ä¸º IO äº‹ä»¶å°†æŒ‰ç…§é¡ºåºé¡ºæ¬¡ç»è¿‡ pipeline ä¸Šçš„ handlerï¼Œè¿™æ ·æ¯ä¸ª handler å¯ä»¥ä¸“æ³¨äºåšä¸€ç‚¹ç‚¹å°äº‹ï¼Œç”±å¤šä¸ª handler ç»„åˆæ¥å®Œæˆä¸€äº›å¤æ‚çš„é€»è¾‘ã€‚</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/netty-source/11.png" alt="11"></p>
<p>ä»å›¾ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“è¿™æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬çœ‹ä¸¤ä¸ªé‡è¦çš„æ¦‚å¿µï¼š<strong>Inbound</strong> å’Œ <strong>Outbound</strong>ã€‚åœ¨ Netty ä¸­ï¼ŒIO äº‹ä»¶è¢«åˆ†ä¸º Inbound äº‹ä»¶å’Œ Outbound äº‹ä»¶ã€‚</p>
<p><strong>Outbound</strong> çš„ <strong>out</strong> æŒ‡çš„æ˜¯ <strong>å‡ºå»</strong>ï¼Œæœ‰å“ªäº› IO äº‹ä»¶å±äºæ­¤ç±»å‘¢ï¼Ÿæ¯”å¦‚ connectã€writeã€flush è¿™äº› IO æ“ä½œæ˜¯å¾€å¤–éƒ¨æ–¹å‘è¿›è¡Œçš„ï¼Œå®ƒä»¬å°±å±äº Outbound äº‹ä»¶ã€‚</p>
<p>å…¶ä»–çš„ï¼Œè¯¸å¦‚ acceptã€read è¿™ç§å°±å±äº Inbound äº‹ä»¶ã€‚</p>
<blockquote>
<p>æ¯”å¦‚å®¢æˆ·ç«¯åœ¨å‘èµ·è¯·æ±‚çš„æ—¶å€™ï¼Œéœ€è¦ 1ï¸âƒ£connect åˆ°æœåŠ¡å™¨ï¼Œç„¶å 2ï¸âƒ£write æ•°æ®ä¼ åˆ°æœåŠ¡å™¨ï¼Œå†ç„¶å 3ï¸âƒ£read æœåŠ¡å™¨è¿”å›çš„æ•°æ®ï¼Œå‰é¢çš„ connect å’Œ write å°±æ˜¯ <strong>out</strong> äº‹ä»¶ï¼Œåé¢çš„ read å°±æ˜¯ <strong>in</strong> äº‹ä»¶ã€‚</p>
</blockquote>
<p>æ¯”å¦‚å¾ˆå¤šåˆå­¦è€…çœ‹ä¸æ‡‚ä¸‹é¢çš„è¿™æ®µä»£ç ï¼Œè¿™æ®µä»£ç ç”¨äºæœåŠ¡ç«¯çš„ childHandler ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> pipeline.addLast(<span class="keyword">new</span> <span class="title class_">StringDecoder</span>());</span><br><span class="line"><span class="number">2.</span> pipeline.addLast(<span class="keyword">new</span> <span class="title class_">StringEncoder</span>());</span><br><span class="line"><span class="number">3.</span> pipeline.addLast(<span class="keyword">new</span> <span class="title class_">BizHandler</span>());</span><br></pre></td></tr></table></figure>

<p>åˆå­¦è€…è‚¯å®šéƒ½çº³é—·ï¼Œä»¥ä¸ºè¿™ä¸ªé¡ºåºå†™é”™äº†ï¼Œåº”è¯¥æ˜¯å…ˆ decode å®¢æˆ·ç«¯è¿‡æ¥çš„æ•°æ®ï¼Œç„¶åç”¨ BizHandler å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œæœ€åå† encode æ•°æ®ç„¶åè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œæ‰€ä»¥æ·»åŠ çš„é¡ºåºåº”è¯¥æ˜¯ <strong>1 -&gt; 3 -&gt; 2</strong> æ‰å¯¹ã€‚</p>
<p>å…¶å®è¿™é‡Œçš„ä¸‰ä¸ª handler æ˜¯åˆ†ç»„çš„ï¼Œåˆ†ä¸º Inboundï¼ˆ1 å’Œ 3ï¼‰ å’Œ Outboundï¼ˆ2ï¼‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> pipeline.addLast(<span class="keyword">new</span> <span class="title class_">StringDecoder</span>());</span><br><span class="line"><span class="number">2.</span> pipeline.addLast(<span class="keyword">new</span> <span class="title class_">StringEncoder</span>());</span><br><span class="line"><span class="number">3.</span> pipeline.addLast(<span class="keyword">new</span> <span class="title class_">BizHandler</span>());</span><br></pre></td></tr></table></figure>

<ul>
<li>å®¢æˆ·ç«¯è¿æ¥è¿›æ¥çš„æ—¶å€™ï¼Œè¯»å–ï¼ˆreadï¼‰å®¢æˆ·ç«¯è¯·æ±‚æ•°æ®çš„æ“ä½œæ˜¯ Inbound çš„ï¼Œæ‰€ä»¥ä¼šå…ˆä½¿ç”¨ 1ï¼Œç„¶åæ˜¯ 3 å¯¹å¤„ç†è¿›è¡Œå¤„ç†ï¼›</li>
<li>å¤„ç†å®Œæ•°æ®åï¼Œè¿”å›ç»™å®¢æˆ·ç«¯æ•°æ®çš„ write æ“ä½œæ˜¯ Outbound çš„ï¼Œæ­¤æ—¶ä½¿ç”¨çš„æ˜¯ 2ã€‚</li>
</ul>
<p>æ‰€ä»¥è™½ç„¶æ·»åŠ é¡ºåºæœ‰ç‚¹æ€ªï¼Œä½†æ˜¯æ‰§è¡Œé¡ºåºå…¶å®æ˜¯æŒ‰ç…§ 1 -&gt; 3 -&gt; 2 è¿›è¡Œçš„ã€‚</p>
<blockquote>
<p>å¦‚æœæˆ‘ä»¬åœ¨ä¸Šé¢çš„åŸºç¡€ä¸Šï¼ŒåŠ ä¸Šä¸‹é¢çš„ç¬¬å››è¡Œï¼Œè¿™æ˜¯ä¸€ä¸ª OutboundHandlerï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4.</span> pipeline.addLast(<span class="keyword">new</span> <span class="title class_">OutboundHandlerA</span>());</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆæ‰§è¡Œé¡ºåºæ˜¯ä¸æ˜¯å°±æ˜¯ 1 -&gt; 3 -&gt; 2 -&gt; 4 å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼šä¸æ˜¯çš„ã€‚</p>
<p>å¯¹äº Inbound æ“ä½œï¼ŒæŒ‰ç…§æ·»åŠ é¡ºåºæ‰§è¡Œæ¯ä¸ª Inbound ç±»å‹çš„ handlerï¼›è€Œå¯¹äº Outbound æ“ä½œï¼Œæ˜¯åç€æ¥çš„ï¼Œä»åå¾€å‰ï¼Œé¡ºæ¬¡æ‰§è¡Œ Outbound ç±»å‹çš„ handlerã€‚</p>
<p>æ‰€ä»¥ï¼Œä¸Šé¢çš„é¡ºåºåº”è¯¥æ˜¯å…ˆ 1 å 3ï¼Œå®ƒä»¬æ˜¯ Inbound çš„ï¼Œç„¶åæ˜¯ 4ï¼Œæœ€åæ‰æ˜¯ 2ï¼Œå®ƒä»¬ä¸¤ä¸ªæ˜¯ Outbound çš„ã€‚è¯´å®è¯ï¼Œæˆ‘çœŸä¸å–œæ¬¢è¿™ç§ç»„ç»‡æ–¹å¼ã€‚</p>
</blockquote>
<p>åˆ°è¿™é‡Œï¼Œæˆ‘æƒ³å¤§å®¶åº”è¯¥éƒ½çŸ¥é“ Inbound å’Œ Outbound äº†å§ï¼Ÿä¸‹é¢æˆ‘ä»¬æ¥ä»‹ç»å®ƒä»¬çš„æ¥å£ä½¿ç”¨ã€‚</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/netty-source/9.png" alt="9"></p>
<p>å®šä¹‰å¤„ç† Inbound äº‹ä»¶çš„ handler éœ€è¦å®ç° ChannelInboundHandlerï¼Œå®šä¹‰å¤„ç† Outbound äº‹ä»¶çš„ handler éœ€è¦å®ç° ChannelOutboundHandlerã€‚æœ€ä¸‹é¢çš„ä¸‰ä¸ªç±»ï¼Œæ˜¯ Netty æä¾›çš„é€‚é…å™¨ï¼Œç‰¹åˆ«çš„ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›å®šä¹‰ä¸€ä¸ª handler èƒ½åŒæ—¶å¤„ç† Inbound å’Œ Outbound äº‹ä»¶ï¼Œå¯ä»¥é€šè¿‡ç»§æ‰¿ä¸­é—´çš„ <strong>ChannelDuplexHandler</strong> çš„æ–¹å¼ï¼Œæ¯”å¦‚ <strong>LoggingHandler</strong> è¿™ç§æ—¢å¯ä»¥ç”¨æ¥å¤„ç† Inbound ä¹Ÿå¯ä»¥ç”¨æ¥å¤„ç† Outbound äº‹ä»¶çš„ handlerã€‚</p>
<p>æœ‰äº† Inbound å’Œ Outbound çš„æ¦‚å¿µä»¥åï¼Œæˆ‘ä»¬æ¥å¼€å§‹ä»‹ç» Pipeline çš„æºç ã€‚</p>
<p>æˆ‘ä»¬è¯´è¿‡ï¼Œä¸€ä¸ª Channel å…³è”ä¸€ä¸ª pipelineï¼ŒNioSocketChannel å’Œ NioServerSocketChannel åœ¨æ‰§è¡Œæ„é€ æ–¹æ³•çš„æ—¶å€™ï¼Œéƒ½ä¼šèµ°åˆ°å®ƒä»¬çš„çˆ¶ç±» AbstractChannel çš„æ„é€ æ–¹æ³•ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">AbstractChannel</span><span class="params">(Channel parent)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.parent = parent;</span><br><span class="line">    <span class="comment">// ç»™æ¯ä¸ª channel åˆ†é…ä¸€ä¸ªå”¯ä¸€ id</span></span><br><span class="line">    id = newId();</span><br><span class="line">    <span class="comment">// æ¯ä¸ª channel å†…éƒ¨éœ€è¦ä¸€ä¸ª Unsafe çš„å®ä¾‹</span></span><br><span class="line">    unsafe = newUnsafe();</span><br><span class="line">    <span class="comment">// æ¯ä¸ª channel å†…éƒ¨éƒ½ä¼šåˆ›å»ºä¸€ä¸ª pipeline</span></span><br><span class="line">    pipeline = newChannelPipeline();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ä¸‰è¡Œä»£ç ä¸­ï¼Œid æ¯”è¾ƒä¸é‡è¦ï¼ŒNetty ä¸­çš„ Unsafe å®ä¾‹å…¶å®æŒºé‡è¦çš„ï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹ã€‚</p>
<p>åœ¨ JDK çš„æºç ä¸­ï¼Œsun.misc.Unsafe ç±»æä¾›äº†ä¸€äº›åº•å±‚æ“ä½œçš„èƒ½åŠ›ï¼Œå®ƒè®¾è®¡å‡ºæ¥æ˜¯ç»™ JDK ä¸­çš„æºç ä½¿ç”¨çš„ï¼Œæ¯”å¦‚ AQSã€ConcurrentHashMap ç­‰ï¼Œæˆ‘ä»¬åœ¨ä¹‹å‰çš„å¹¶å‘åŒ…çš„æºç åˆ†æä¸­ä¹Ÿçœ‹åˆ°äº†å¾ˆå¤šå®ƒä»¬ä½¿ç”¨ Unsafe çš„åœºæ™¯ï¼Œè¿™ä¸ª Unsafe ç±»ä¸æ˜¯ç»™æˆ‘ä»¬çš„ä»£ç ä½¿ç”¨çš„ï¼Œæ˜¯ç»™ JDK æºç ä½¿ç”¨çš„ï¼ˆéœ€è¦çš„è¯ï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯å¯ä»¥è·å–å®ƒçš„å®ä¾‹çš„ï¼‰ã€‚</p>
<blockquote>
<p>Unsafe ç±»çš„æ„é€ æ–¹æ³•æ˜¯ private çš„ï¼Œä½†æ˜¯å®ƒæä¾›äº† getUnsafe() è¿™ä¸ªé™æ€æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> Unsafe.getUnsafe();</span><br></pre></td></tr></table></figure>
<p>å¤§å®¶å¯ä»¥è¯•ä¸€ä¸‹ï¼Œä¸Šé¢è¿™è¡Œä»£ç ç¼–è¯‘æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯æ‰§è¡Œçš„æ—¶å€™ä¼šæŠ› <code>java.lang.SecurityException</code> å¼‚å¸¸ï¼Œå› ä¸ºå®ƒå°±ä¸æ˜¯ç»™æˆ‘ä»¬çš„ä»£ç ç”¨çš„ã€‚</p>
<p>ä½†æ˜¯å¦‚æœä½ å°±æ˜¯æƒ³è·å– Unsafe çš„å®ä¾‹ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢è¿™ä¸ªä»£ç è·å–åˆ°:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">f.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> (Unsafe) f.get(<span class="literal">null</span>);</span><br></pre></td></tr></table></figure>
</blockquote>
<p>Netty ä¸­çš„ Unsafe ä¹Ÿæ˜¯åŒæ ·çš„æ„æ€ï¼Œå®ƒå°è£…äº† Netty ä¸­ä¼šä½¿ç”¨åˆ°çš„ JDK æä¾›çš„ NIO æ¥å£ï¼Œæ¯”å¦‚å°† channel æ³¨å†Œåˆ° selector ä¸Šï¼Œæ¯”å¦‚ bind æ“ä½œï¼Œæ¯”å¦‚ connect æ“ä½œç­‰ï¼Œ<strong>è¿™äº›æ“ä½œéƒ½æ˜¯ç¨å¾®ååº•å±‚ä¸€äº›</strong>ã€‚Netty åŒæ ·ä¹Ÿæ˜¯ä¸å¸Œæœ›æˆ‘ä»¬çš„ä¸šåŠ¡ä»£ç ä½¿ç”¨ Unsafe çš„å®ä¾‹ï¼Œå®ƒæ˜¯æä¾›ç»™ Netty ä¸­çš„æºç ä½¿ç”¨çš„ã€‚</p>
<blockquote>
<p>ä¸è¿‡ï¼Œå¯¹äºæˆ‘ä»¬æºç åˆ†ææ¥è¯´ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä¼šæœ‰å¾ˆå¤šæ—¶å€™éœ€è¦åˆ†æ Unsafe ä¸­çš„æºç çš„</p>
</blockquote>
<p>å…³äº Unsafeï¼Œæˆ‘ä»¬åé¢ç”¨åˆ°äº†å†è¯´ï¼Œè¿™é‡Œåªè¦çŸ¥é“ï¼Œå®ƒå°è£…äº†å¤§éƒ¨åˆ†éœ€è¦è®¿é—® JDK çš„ NIO æ¥å£çš„æ“ä½œå°±å¥½äº†ã€‚è¿™é‡Œæˆ‘ä»¬ç»§ç»­å°†ç„¦ç‚¹æ”¾åœ¨å®ä¾‹åŒ– pipeline ä¸Šï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> DefaultChannelPipeline <span class="title function_">newChannelPipeline</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultChannelPipeline</span>(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¼€å§‹è°ƒç”¨ DefaultChannelPipeline çš„æ„é€ æ–¹æ³•ï¼Œå¹¶æŠŠå½“å‰ channel çš„å¼•ç”¨ä¼ å…¥ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">DefaultChannelPipeline</span><span class="params">(Channel channel)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.channel = ObjectUtil.checkNotNull(channel, <span class="string">&quot;channel&quot;</span>);</span><br><span class="line">    succeededFuture = <span class="keyword">new</span> <span class="title class_">SucceededChannelFuture</span>(channel, <span class="literal">null</span>);</span><br><span class="line">    voidPromise =  <span class="keyword">new</span> <span class="title class_">VoidChannelPromise</span>(channel, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    tail = <span class="keyword">new</span> <span class="title class_">TailContext</span>(<span class="built_in">this</span>);</span><br><span class="line">    head = <span class="keyword">new</span> <span class="title class_">HeadContext</span>(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">    head.next = tail;</span><br><span class="line">    tail.prev = head;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå®ä¾‹åŒ–äº† tail å’Œ head è¿™ä¸¤ä¸ª handlerã€‚tail å®ç°äº† ChannelInboundHandler æ¥å£ï¼Œè€Œ head å®ç°äº† ChannelOutboundHandler å’Œ ChannelInboundHandler ä¸¤ä¸ªæ¥å£ï¼Œå¹¶ä¸”æœ€åä¸¤è¡Œä»£ç å°† tail å’Œ head è¿æ¥èµ·æ¥:</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/netty-source/12.png" alt="12"></p>
<blockquote>
<p>æ³¨æ„ï¼Œåœ¨ä¸åŒçš„ç‰ˆæœ¬ä¸­ï¼Œæºç ä¹Ÿç•¥æœ‰å·®å¼‚ï¼Œhead ä¸ä¸€å®šæ˜¯ in + outï¼Œå¤§å®¶çŸ¥é“è¿™ç‚¹å°±å¥½äº†ã€‚</p>
<p>è¿˜æœ‰ï¼Œä»ä¸Šé¢çš„ head å’Œ tail æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œå…¶å® pipeline ä¸­çš„æ¯ä¸ªå…ƒç´ æ˜¯ <strong>ChannelHandlerContext</strong> çš„å®ä¾‹ï¼Œè€Œä¸æ˜¯ ChannelHandler çš„å®ä¾‹ï¼Œcontext åŒ…è£…äº†ä¸€ä¸‹ handlerï¼Œä½†æ˜¯ï¼Œåé¢æˆ‘ä»¬éƒ½ä¼šç”¨ handler æ¥æè¿°ä¸€ä¸ª pipeline ä¸Šçš„èŠ‚ç‚¹ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ contextï¼Œå¸Œæœ›è¯»è€…çŸ¥é“è¿™ä¸€ç‚¹ã€‚</p>
</blockquote>
<p>è¿™é‡Œåªæ˜¯æ„é€ äº† pipelineï¼Œå¹¶ä¸”æ·»åŠ äº†ä¸¤ä¸ªå›ºå®šçš„ handler åˆ°å…¶ä¸­ï¼ˆhead + tailï¼‰ï¼Œè¿˜ä¸æ¶‰åŠåˆ°è‡ªå®šä¹‰çš„ handler ä»£ç æ‰§è¡Œã€‚æˆ‘ä»¬å›è¿‡å¤´æ¥çœ‹ä¸‹é¢è¿™æ®µä»£ç ï¼š</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/netty-source/13.png" alt="13"></p>
<blockquote>
<p>æˆ‘ä»¬è¯´è¿‡ childHandler ä¸­æŒ‡å®šçš„ handler ä¸æ˜¯ç»™ NioServerSocketChannel ä½¿ç”¨çš„ï¼Œæ˜¯ç»™ NioSocketChannel ä½¿ç”¨çš„ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä¸çœ‹å®ƒã€‚</p>
</blockquote>
<p>è¿™é‡Œè°ƒç”¨ handler(â€¦) æ–¹æ³•æŒ‡å®šäº†ä¸€ä¸ª LoggingHandler çš„å®ä¾‹ï¼Œç„¶åæˆ‘ä»¬å†è¿›å»ä¸‹é¢çš„ bind(â€¦) æ–¹æ³•ä¸­çœ‹çœ‹è¿™ä¸ª LoggingHandler å®ä¾‹æ˜¯æ€ä¹ˆè¿›å…¥åˆ°æˆ‘ä»¬ä¹‹å‰æ„é€ çš„ pipeline å†…çš„ã€‚</p>
<p>é¡ºç€ bind() ä¸€ç›´å¾€å‰èµ°ï¼Œbind() -&gt; doBind() -&gt; initAndRegister()ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ChannelFuture <span class="title function_">initAndRegister</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1. æ„é€  channel å®ä¾‹ï¼ŒåŒæ—¶ä¼šæ„é€  pipeline å®ä¾‹ï¼Œ</span></span><br><span class="line">        <span class="comment">// ç°åœ¨ pipeline ä¸­æœ‰ head å’Œ tail ä¸¤ä¸ª handler äº†</span></span><br><span class="line">        channel = channelFactory.newChannel();</span><br><span class="line">        <span class="comment">// 2. çœ‹è¿™é‡Œ</span></span><br><span class="line">        init(channel);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ä¸¤è¡Œä»£ç ï¼Œç¬¬ä¸€è¡Œå®ç°äº†æ„é€  channel å’Œ channel å†…éƒ¨çš„ pipelineï¼Œæˆ‘ä»¬æ¥çœ‹ç¬¬äºŒè¡Œ init ä»£ç ï¼š</p>
<p>// ServerBootstrapï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">init</span><span class="params">(Channel channel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">// æ‹¿åˆ°åˆšåˆšåˆ›å»ºçš„ channel å†…éƒ¨çš„ pipeline å®ä¾‹</span></span><br><span class="line">    <span class="type">ChannelPipeline</span> <span class="variable">p</span> <span class="operator">=</span> channel.pipeline();</span><br><span class="line">	...</span><br><span class="line">    <span class="comment">// å¼€å§‹å¾€ pipeline ä¸­æ·»åŠ ä¸€ä¸ª handlerï¼Œè¿™ä¸ª handler æ˜¯ ChannelInitializer çš„å®ä¾‹</span></span><br><span class="line">    p.addLast(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;Channel&gt;() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æˆ‘ä»¬ä»¥åä¼šçœ‹åˆ°ï¼Œä¸‹é¢è¿™ä¸ª initChannel æ–¹æ³•ä½•æ—¶ä¼šè¢«è°ƒç”¨</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(<span class="keyword">final</span> Channel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ChannelPipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> ch.pipeline();</span><br><span class="line">            <span class="comment">// è¿™ä¸ªæ–¹æ³•è¿”å›æˆ‘ä»¬æœ€å¼€å§‹æŒ‡å®šçš„ LoggingHandler å®ä¾‹</span></span><br><span class="line">            <span class="type">ChannelHandler</span> <span class="variable">handler</span> <span class="operator">=</span> config.handler();</span><br><span class="line">            <span class="keyword">if</span> (handler != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// æ·»åŠ  LoggingHandler</span></span><br><span class="line">                pipeline.addLast(handler);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å…ˆä¸ç”¨ç®¡è¿™é‡Œçš„ eventLoop</span></span><br><span class="line">            ch.eventLoop().execute(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="comment">// æ·»åŠ ä¸€ä¸ª handler åˆ° pipeline ä¸­ï¼šServerBootstrapAcceptor</span></span><br><span class="line">                    <span class="comment">// ä»åå­—å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ª handler çš„ç›®çš„æ˜¯ç”¨äºæ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚</span></span><br><span class="line">                    pipeline.addLast(<span class="keyword">new</span> <span class="title class_">ServerBootstrapAcceptor</span>(</span><br><span class="line">                            ch, currentChildGroup, currentChildHandler, currentChildOptions, currentChildAttrs));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæ¶‰åŠåˆ° pipeline ä¸­çš„è¾…åŠ©ç±» ChannelInitializerï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼Œå®ƒæœ¬èº«æ˜¯ä¸€ä¸ª handlerï¼ˆInbound ç±»å‹ï¼‰ï¼Œä½†æ˜¯å®ƒçš„ä½œç”¨å’Œæ™®é€š handler æœ‰ç‚¹ä¸ä¸€æ ·ï¼Œå®ƒçº¯ç¢æ˜¯ç”¨æ¥è¾…åŠ©å°†å…¶ä»–çš„ handler åŠ å…¥åˆ° pipeline ä¸­çš„ã€‚</p>
<p>å¤§å®¶å¯ä»¥ç¨å¾®çœ‹ä¸€ä¸‹ ChannelInitializer çš„ initChannel æ–¹æ³•ï¼Œæœ‰ä¸ªç®€å•çš„è®¤è¯†å°±å¥½ï¼Œæ­¤æ—¶çš„ pipeline åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/netty-source/14.png" alt="14"></p>
<p>ChannelInitializer çš„ initChannel(channel) æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œä¼šå¾€ pipeline ä¸­æ·»åŠ æˆ‘ä»¬æœ€å¼€å§‹æŒ‡å®šçš„ <strong>LoggingHandler</strong> å’Œæ·»åŠ ä¸€ä¸ª <strong>ServerBootstrapAcceptor</strong>ã€‚ä½†æ˜¯æˆ‘ä»¬ç°åœ¨è¿˜ä¸çŸ¥é“è¿™ä¸ª initChannel æ–¹æ³•ä½•æ—¶ä¼šè¢«è°ƒç”¨ã€‚</p>
<p>ä¸Šé¢æˆ‘ä»¬è¯´çš„æ˜¯ä½œä¸ºæœåŠ¡ç«¯çš„ NioServerSocketChannel çš„ pipelineï¼ŒNioSocketChannel ä¹Ÿæ˜¯å·®ä¸å¤šçš„ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹ Bootstrap ç±»çš„ init(channel) æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">init</span><span class="params">(Channel channel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">ChannelPipeline</span> <span class="variable">p</span> <span class="operator">=</span> channel.pipeline();</span><br><span class="line">    p.addLast(config.handler());</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://assets.javadoop.com/imgs/20510079/netty-source/23.png" alt="23"></p>
<p>å®ƒå’ŒæœåŠ¡ç«¯ ServerBootstrap è¦æ·»åŠ  ServerBootstrapAcceptor ä¸ä¸€æ ·ï¼Œå®ƒåªéœ€è¦å°† EchoClient ç±»ä¸­çš„ ChannelInitializer å®ä¾‹åŠ è¿›æ¥å°±å¯ä»¥äº†ï¼Œå®ƒçš„ ChannelInitializer ä¸­æ·»åŠ äº†ä¸¤ä¸ª handlerï¼ŒLoggingHandler å’Œ EchoClientHandlerï¼š</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/netty-source/16.png" alt="16"></p>
<p>å¾ˆæ˜¾ç„¶ï¼Œæˆ‘ä»¬éœ€è¦çš„æ˜¯åƒ LoggingHandler å’Œ EchoClientHandler è¿™æ ·çš„ handlerï¼Œä½†æ˜¯ï¼Œå®ƒä»¬ç°åœ¨è¿˜ä¸åœ¨ pipeline ä¸­ï¼Œé‚£ä¹ˆå®ƒä»¬ä»€ä¹ˆæ—¶å€™ä¼šçœŸæ­£è¿›å…¥åˆ° pipeline ä¸­å‘¢ï¼Ÿä»¥åæˆ‘ä»¬å†æ­æ™“ã€‚</p>
<p>è¿˜æœ‰ï¼Œä¸ºä»€ä¹ˆ Server ç«¯æˆ‘ä»¬æŒ‡å®šçš„æ˜¯ä¸€ä¸ª handler å®ä¾‹ï¼Œè€Œ Client æŒ‡å®šçš„æ˜¯ä¸€ä¸ª ChannelInitializer å®ä¾‹ï¼Ÿå…¶å®å®ƒä»¬æ˜¯å¯ä»¥éšæ„æ­é…ä½¿ç”¨çš„ï¼Œä½ ç”šè‡³å¯ä»¥åœ¨ ChannelInitializer å®ä¾‹ä¸­æ·»åŠ  ChannelInitializer çš„å®ä¾‹ã€‚</p>
<p>éå¸¸æŠ±æ­‰ï¼Œè¿™é‡Œåˆè¦æ–­äº†ï¼Œä¸‹é¢è¦å…ˆä»‹ç»çº¿ç¨‹æ± äº†ï¼Œå¤§å®¶è¦è®°ä½ pipeline ç°åœ¨çš„æ ·å­ï¼Œ<strong>head + channelInitializer + tail</strong>ã€‚</p>
<p>æœ¬èŠ‚æ²¡æœ‰ä»‹ç» handler çš„å‘åä¼ æ’­ï¼Œå°±æ˜¯ä¸€ä¸ª handler å¤„ç†å®Œäº†ä»¥åï¼Œæ€ä¹ˆä¼ é€’ç»™ä¸‹ä¸€ä¸ª handler æ¥å¤„ç†ï¼Ÿæ¯”å¦‚æˆ‘ä»¬ç†Ÿæ‚‰çš„ JavaEE ä¸­çš„ Filter æ˜¯é‡‡ç”¨åœ¨ä¸€ä¸ª Filter å®ä¾‹ä¸­è°ƒç”¨ chain.doFilter(request, response) æ¥ä¼ é€’ç»™ä¸‹ä¸€ä¸ª Filter è¿™ç§æ–¹å¼çš„ã€‚</p>
<p>æˆ‘ä»¬ç”¨ä¸‹é¢è¿™å¼ å›¾ç»“æŸæœ¬èŠ‚ã€‚ä¸‹å›¾å±•ç¤ºäº†ä¼ æ’­çš„æ–¹æ³•ï¼Œä½†æˆ‘å…¶å®æ˜¯æ›´æƒ³è®©å¤§å®¶çœ‹ä¸€ä¸‹ï¼Œå“ªäº›äº‹ä»¶æ˜¯ Inbound ç±»å‹çš„ï¼Œå“ªäº›æ˜¯ Outbound ç±»å‹çš„ï¼š</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/netty-source/19.png" alt="19"></p>
<p>Outbound ç±»å‹çš„å‡ ä¸ªäº‹ä»¶å¤§å®¶åº”è¯¥æ¯”è¾ƒå¥½è®¤ï¼Œæ³¨æ„ bind ä¹Ÿæ˜¯ Outbound ç±»å‹çš„ã€‚</p>
<h2 id="Netty-ä¸­çš„çº¿ç¨‹æ± -EventLoopGroup"><a href="#Netty-ä¸­çš„çº¿ç¨‹æ± -EventLoopGroup" class="headerlink" title="Netty ä¸­çš„çº¿ç¨‹æ±  EventLoopGroup"></a>Netty ä¸­çš„çº¿ç¨‹æ±  EventLoopGroup</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥åˆ†æ Netty ä¸­çš„çº¿ç¨‹æ± ã€‚Netty ä¸­çš„çº¿ç¨‹æ± æ¯”è¾ƒä¸å¥½ç†è§£ï¼Œå› ä¸ºå®ƒçš„ç±»æ¯”è¾ƒå¤šï¼Œè€Œä¸”å®ƒä»¬ä¹‹é—´çš„å…³ç³»é”™ç»¼å¤æ‚ã€‚çœ‹ä¸‹å›¾ï¼Œæ„Ÿå—ä¸‹ NioEventLoop ç±»å’Œ NioEventLoopGroup ç±»çš„ç»§æ‰¿ç»“æ„ï¼š</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/netty-source/2.png" alt="2"></p>
<p>è¿™å¼ å›¾æˆ‘æŒ‰ç…§ç»§æ‰¿å…³ç³»æ•´ç†è€Œæ¥ï¼Œå¤§å®¶ä»”ç»†çœ‹ä¸€ä¸‹å°±ä¼šå‘ç°ï¼Œæ¶‰åŠåˆ°çš„ç±»ç¡®å®æŒºå¤šçš„ã€‚æœ¬èŠ‚æ¥ç»™å¤§å®¶ç†ç†æ¸…æ¥šè¿™éƒ¨åˆ†å†…å®¹ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬è¯´çš„ Netty çš„çº¿ç¨‹æ± ï¼ŒæŒ‡çš„å°±æ˜¯ <strong>NioEventLoopGroup</strong> çš„å®ä¾‹ï¼›çº¿ç¨‹æ± ä¸­çš„å•ä¸ªçº¿ç¨‹ï¼ŒæŒ‡çš„æ˜¯å³è¾¹ <strong>NioEventLoop</strong> çš„å®ä¾‹ã€‚</p>
<p>æˆ‘ä»¬ç¬¬ä¸€èŠ‚ä»‹ç»çš„ Echo ä¾‹å­ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„å¯åŠ¨ä»£ç ä¸­ï¼Œæœ€å¼€å§‹æˆ‘ä»¬æ€»æ˜¯å…ˆå®ä¾‹åŒ– NioEventLoopGroupï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// EchoClient ä»£ç æœ€å¼€å§‹ï¼š</span></span><br><span class="line"><span class="type">EventLoopGroup</span> <span class="variable">group</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// EchoServer ä»£ç æœ€å¼€å§‹ï¼š</span></span><br><span class="line"><span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">1</span>);</span><br><span class="line"><span class="type">EventLoopGroup</span> <span class="variable">workerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢ï¼Œæˆ‘ä»¬å°±ä» NioEventLoopGroup çš„æºç å¼€å§‹è¿›è¡Œåˆ†æã€‚</p>
<p>æˆ‘ä»¬æ‰“å¼€ NioEventLoopGroup çš„æºç ï¼Œå¯ä»¥çœ‹åˆ°ï¼ŒNioEventLoopGroup æœ‰å¤šä¸ªæ„é€ æ–¹æ³•ç”¨äºå‚æ•°è®¾ç½®ï¼Œæœ€ç®€å•åœ°ï¼Œæˆ‘ä»¬é‡‡ç”¨æ— å‚æ„é€ å‡½æ•°ï¼Œæˆ–ä»…ä»…è®¾ç½®çº¿ç¨‹æ•°é‡å°±å¯ä»¥äº†ï¼Œå…¶ä»–çš„å‚æ•°é‡‡ç”¨é»˜è®¤å€¼ã€‚</p>
<blockquote>
<p>æ¯”å¦‚ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬åªåœ¨å®ä¾‹åŒ– bossGroup çš„æ—¶å€™æŒ‡å®šäº†å‚æ•°ï¼Œä»£è¡¨è¯¥çº¿ç¨‹æ± éœ€è¦ä¸€ä¸ªçº¿ç¨‹ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">NioEventLoopGroup</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="title function_">NioEventLoopGroup</span><span class="params">(<span class="type">int</span> nThreads)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(nThreads, (Executor) <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">  </span><br><span class="line"><span class="comment">// å‚æ•°æœ€å…¨çš„æ„é€ æ–¹æ³•</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">NioEventLoopGroup</span><span class="params">(<span class="type">int</span> nThreads, Executor executor, EventExecutorChooserFactory chooserFactory,</span></span><br><span class="line"><span class="params">                         <span class="keyword">final</span> SelectorProvider selectorProvider,</span></span><br><span class="line"><span class="params">                         <span class="keyword">final</span> SelectStrategyFactory selectStrategyFactory,</span></span><br><span class="line"><span class="params">                         <span class="keyword">final</span> RejectedExecutionHandler rejectedExecutionHandler)</span> &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨çˆ¶ç±»çš„æ„é€ æ–¹æ³•</span></span><br><span class="line">    <span class="built_in">super</span>(nThreads, executor, chooserFactory, selectorProvider, selectStrategyFactory, rejectedExecutionHandler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ¥ç¨å¾®çœ‹ä¸€ä¸‹æ„é€ æ–¹æ³•ä¸­çš„å„ä¸ªå‚æ•°ï¼š</p>
<ul>
<li>nThreadsï¼šè¿™ä¸ªæœ€ç®€å•ï¼Œå°±æ˜¯çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ï¼Œä¹Ÿå°±æ˜¯ NioEventLoop çš„å®ä¾‹æ•°é‡ã€‚</li>
<li>executorï¼šæˆ‘ä»¬çŸ¥é“ï¼Œæˆ‘ä»¬æœ¬èº«å°±æ˜¯è¦æ„é€ ä¸€ä¸ªçº¿ç¨‹æ± ï¼ˆExecutorï¼‰ï¼Œä¸ºä»€ä¹ˆè¿™é‡Œä¼ ä¸€ä¸ª executor å®ä¾‹å‘¢ï¼Ÿå®ƒå…¶å®ä¸æ˜¯ç»™çº¿ç¨‹æ± ç”¨çš„ï¼Œè€Œæ˜¯ç»™ NioEventLoop ç”¨çš„ï¼Œä»¥åå†è¯´ã€‚</li>
<li>chooserFactoryï¼šå½“æˆ‘ä»¬æäº¤ä¸€ä¸ªä»»åŠ¡åˆ°çº¿ç¨‹æ± çš„æ—¶å€™ï¼Œçº¿ç¨‹æ± éœ€è¦é€‰æ‹©ï¼ˆchooseï¼‰å…¶ä¸­çš„ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œè¿™ä¸ªä»»åŠ¡ï¼Œè¿™ä¸ªå°±æ˜¯ç”¨æ¥å®ç°é€‰æ‹©ç­–ç•¥çš„ã€‚</li>
<li>selectorProviderï¼šè¿™ä¸ªç®€å•ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡å®ƒæ¥å®ä¾‹åŒ– JDK çš„ Selectorï¼Œå¯ä»¥çœ‹åˆ°æ¯ä¸ªçº¿ç¨‹æ± éƒ½æŒæœ‰ä¸€ä¸ª selectorProvider å®ä¾‹ã€‚</li>
<li>selectStrategyFactoryï¼šè¿™ä¸ªæ¶‰åŠåˆ°çš„æ˜¯çº¿ç¨‹æ± ä¸­çº¿ç¨‹çš„å·¥ä½œæµç¨‹ï¼Œåœ¨ä»‹ç» NioEventLoop çš„æ—¶å€™ä¼šè¯´ã€‚</li>
<li>rejectedExecutionHandlerï¼šè¿™ä¸ªä¹Ÿæ˜¯çº¿ç¨‹æ± çš„å¥½æœ‹å‹äº†ï¼Œç”¨äºå¤„ç†çº¿ç¨‹æ± ä¸­æ²¡æœ‰å¯ç”¨çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡çš„æƒ…å†µã€‚åœ¨ Netty ä¸­ç¨å¾®æœ‰ä¸€ç‚¹ç‚¹ä¸ä¸€æ ·ï¼Œè¿™ä¸ªæ˜¯ç»™ NioEventLoop å®ä¾‹ç”¨çš„ï¼Œä»¥åæˆ‘ä»¬å†è¯¦ç»†ä»‹ç»ã€‚</li>
</ul>
<p>è¿™é‡Œä»‹ç»è¿™äº›å‚æ•°æ˜¯å¸Œæœ›å¤§å®¶æœ‰ä¸ªå°è±¡è€Œå·²ï¼Œå¤§å®¶å‘ç°æ²¡æœ‰ï¼Œåœ¨æ„é€  NioEventLoopGroup å®ä¾‹æ—¶çš„å¥½å‡ ä¸ªå‚æ•°ï¼Œéƒ½æ˜¯ç”¨æ¥æ„é€  NioEventLoop ç”¨çš„ã€‚</p>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬ä» NioEventLoopGroup çš„æ— å‚æ„é€ æ–¹æ³•å¼€å§‹ï¼Œè·Ÿç€æºç èµ°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">NioEventLoopGroup</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åä¸€æ­¥æ­¥èµ°ä¸‹å»ï¼Œåˆ°è¿™ä¸ªæ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">NioEventLoopGroup</span><span class="params">(<span class="type">int</span> nThreads, ThreadFactory threadFactory, <span class="keyword">final</span> SelectorProvider selectorProvider, <span class="keyword">final</span> SelectStrategyFactory selectStrategyFactory)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">super</span>(nThreads, threadFactory, selectorProvider, selectStrategyFactory, RejectedExecutionHandlers.reject());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¤§å®¶è‡ªå·±è¦å»è·Ÿä¸€ä¸‹æºç ï¼Œè¿™æ ·æ‰çŸ¥é“ä¸­é—´è®¾ç½®äº†å“ªäº›é»˜è®¤å€¼ï¼Œä¸‹é¢è¿™å‡ ä¸ªå‚æ•°éƒ½è¢«è®¾ç½®äº†é»˜è®¤å€¼ï¼š </p>
<ul>
<li><p>selectorProvider = SelectorProvider.provider()</p>
<blockquote>
<p>è¿™ä¸ªæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œè°ƒç”¨äº† JDK æä¾›çš„æ–¹æ³•</p>
</blockquote>
</li>
<li><p>selectStrategyFactory = DefaultSelectStrategyFactory.INSTANCE</p>
<blockquote>
<p>è¿™ä¸ªæ¶‰åŠåˆ°çš„æ˜¯çº¿ç¨‹åœ¨åš select æ“ä½œå’Œæ‰§è¡Œä»»åŠ¡è¿‡ç¨‹ä¸­çš„ç­–ç•¥é€‰æ‹©é—®é¢˜ï¼Œåœ¨ä»‹ç» NioEventLoop çš„æ—¶å€™ä¼šç”¨åˆ°ã€‚ </p>
</blockquote>
</li>
<li><p>rejectedExecutionHandler = RejectedExecutionHandlers.reject()</p>
<blockquote>
<p>å¤§å®¶è¿›å»çœ‹ä¸€ä¸‹ reject() æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒNetty é€‰æ‹©çš„é»˜è®¤æ‹’ç»ç­–ç•¥æ˜¯ï¼šæŠ›å‡ºå¼‚å¸¸</p>
</blockquote>
</li>
</ul>
<p>è·Ÿç€æºç èµ°ï¼Œæˆ‘ä»¬ä¼šæ¥åˆ°çˆ¶ç±» MultithreadEventLoopGroup çš„æ„é€ æ–¹æ³•ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">MultithreadEventLoopGroup</span><span class="params">(<span class="type">int</span> nThreads, ThreadFactory threadFactory, Object... args)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(nThreads == <span class="number">0</span> ? DEFAULT_EVENT_LOOP_THREADS : nThreads, threadFactory, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæˆ‘ä»¬å‘ç°ï¼Œå¦‚æœé‡‡ç”¨æ— å‚æ„é€ å‡½æ•°ï¼Œé‚£ä¹ˆåˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œé»˜è®¤åœ° nThreads ä¼šè¢«è®¾ç½®ä¸º **CPU æ ¸å¿ƒæ•° *2**ã€‚å¤§å®¶å¯ä»¥çœ‹ä¸‹ DEFAULT_EVENT_LOOP_THREADS çš„é»˜è®¤å€¼ï¼Œä»¥åŠ static ä»£ç å—çš„è®¾å€¼é€»è¾‘ã€‚</p>
<p>æˆ‘ä»¬ç»§ç»­å¾€ä¸‹èµ°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">MultithreadEventExecutorGroup</span><span class="params">(<span class="type">int</span> nThreads, ThreadFactory threadFactory, Object... args)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(nThreads, threadFactory == <span class="literal">null</span> ? <span class="literal">null</span> : <span class="keyword">new</span> <span class="title class_">ThreadPerTaskExecutor</span>(threadFactory), args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ°è¿™ä¸€æ­¥çš„æ—¶å€™ï¼Œ<code>new ThreadPerTaskExecutor(threadFactory)</code> ä¼šæ„é€ ä¸€ä¸ª executorã€‚</p>
<blockquote>
<p>æˆ‘ä»¬ç°åœ¨è¿˜ä¸çŸ¥é“è¿™ä¸ª executor æ€ä¹ˆç”¨ã€‚è¿™é‡Œæˆ‘ä»¬å…ˆçœ‹ä¸‹å®ƒçš„æºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ThreadPerTaskExecutor</span> <span class="keyword">implements</span> <span class="title class_">Executor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadFactory threadFactory;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ThreadPerTaskExecutor</span><span class="params">(ThreadFactory threadFactory)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (threadFactory == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;threadFactory&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.threadFactory = threadFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable command)</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸ºæ¯ä¸ªä»»åŠ¡æ–°å»ºä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line">        threadFactory.newThread(command).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Executor ä½œä¸ºçº¿ç¨‹æ± çš„æœ€é¡¶å±‚æ¥å£ï¼Œ æˆ‘ä»¬çŸ¥é“ï¼Œå®ƒåªæœ‰ä¸€ä¸ª execute(runnable) æ–¹æ³•ï¼Œä»ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå®ç°ç±» ThreadPerTaskExecutor çš„é€»è¾‘å°±æ˜¯<strong>æ¯æ¥ä¸€ä¸ªä»»åŠ¡ï¼Œæ–°å»ºä¸€ä¸ªçº¿ç¨‹</strong>ã€‚</p>
<p>æˆ‘ä»¬å…ˆè®°ä½è¿™ä¸ªï¼Œå‰é¢ä¹Ÿè¯´äº†ï¼Œå®ƒæ˜¯ç»™ NioEventLoop ç”¨çš„ï¼Œä¸æ˜¯ç»™ NioEventLoopGroup ç”¨çš„ã€‚</p>
</blockquote>
<p>ä¸Šä¸€æ­¥è®¾ç½®å®Œäº† executorï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">MultithreadEventExecutorGroup</span><span class="params">(<span class="type">int</span> nThreads, Executor executor, Object... args)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(nThreads, executor, DefaultEventExecutorChooserFactory.INSTANCE, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸€æ­¥è®¾ç½®äº† chooserFactoryï¼Œç”¨æ¥å®ç°ä»çº¿ç¨‹æ± ä¸­é€‰æ‹©ä¸€ä¸ªçº¿ç¨‹çš„é€‰æ‹©ç­–ç•¥ã€‚</p>
<blockquote>
<p>ChooserFactory çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬çœ‹ä¸‹ DefaultEventExecutorChooserFactory çš„å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> EventExecutorChooser <span class="title function_">newChooser</span><span class="params">(EventExecutor[] executors)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (isPowerOfTwo(executors.length)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PowerOfTwoEventExecutorChooser</span>(executors);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">GenericEventExecutorChooser</span>(executors);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œè®¾ç½®çš„ç­–ç•¥ä¹Ÿå¾ˆç®€å•ï¼š</p>
<p>1ã€å¦‚æœçº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡æ˜¯ 2^nï¼Œé‡‡ç”¨ä¸‹é¢çš„æ–¹å¼ä¼šé«˜æ•ˆä¸€äº›ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> EventExecutor <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> executors[idx.getAndIncrement() &amp; executors.length - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2ã€å¦‚æœä¸æ˜¯ï¼Œç”¨å–æ¨¡çš„æ–¹å¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> EventExecutor <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> executors[Math.abs(idx.getAndIncrement() % executors.length)];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>èµ°äº†è¿™ä¹ˆä¹…ï¼Œæˆ‘ä»¬ç»ˆäºåˆ°äº†ä¸€ä¸ª<strong>å¹²å®äº‹</strong>çš„æ„é€ æ–¹æ³•ä¸­äº†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">MultithreadEventExecutorGroup</span><span class="params">(<span class="type">int</span> nThreads, Executor executor,</span></span><br><span class="line"><span class="params">                                        EventExecutorChooserFactory chooserFactory, Object... args)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (nThreads &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(String.format(<span class="string">&quot;nThreads: %d (expected: &gt; 0)&quot;</span>, nThreads));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// executor å¦‚æœæ˜¯ nullï¼Œåšä¸€æ¬¡å’Œå‰é¢ä¸€æ ·çš„é»˜è®¤è®¾ç½®ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (executor == <span class="literal">null</span>) &#123;</span><br><span class="line">        executor = <span class="keyword">new</span> <span class="title class_">ThreadPerTaskExecutor</span>(newDefaultThreadFactory());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™é‡Œçš„ children æ•°ç»„éå¸¸é‡è¦ï¼Œå®ƒå°±æ˜¯çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ç»„ï¼Œè¿™ä¹ˆè¯´ä¸å¤ªä¸¥è°¨ï¼Œä½†æ˜¯å°±å¤§æ¦‚è¿™ä¸ªæ„æ€</span></span><br><span class="line">    children = <span class="keyword">new</span> <span class="title class_">EventExecutor</span>[nThreads];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸‹é¢è¿™ä¸ª for å¾ªç¯å°†å®ä¾‹åŒ– children æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; nThreads; i ++) &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// å®ä¾‹åŒ–ï¼ï¼ï¼ï¼ï¼ï¼</span></span><br><span class="line">            children[i] = newChild(executor, args);</span><br><span class="line">            success = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Think about if this is a good exception type</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;failed to create a child event loop&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœæœ‰ä¸€ä¸ª child å®ä¾‹åŒ–å¤±è´¥ï¼Œé‚£ä¹ˆ success å°±ä¼šä¸º falseï¼Œç„¶åè¿›å…¥ä¸‹é¢çš„å¤±è´¥å¤„ç†é€»è¾‘</span></span><br><span class="line">            <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">                <span class="comment">// æŠŠå·²ç»æˆåŠŸå®ä¾‹åŒ–çš„â€œçº¿ç¨‹â€ shutdownï¼Œshutdown æ˜¯å¼‚æ­¥æ“ä½œ</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; i; j ++) &#123;</span><br><span class="line">                    children[j].shutdownGracefully();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// ç­‰å¾…è¿™äº›çº¿ç¨‹æˆåŠŸ shutdown</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; i; j ++) &#123;</span><br><span class="line">                    <span class="type">EventExecutor</span> <span class="variable">e</span> <span class="operator">=</span> children[j];</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">while</span> (!e.isTerminated()) &#123;</span><br><span class="line">                            e.awaitTermination(Integer.MAX_VALUE, TimeUnit.SECONDS);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException interrupted) &#123;</span><br><span class="line">                        <span class="comment">// æŠŠä¸­æ–­çŠ¶æ€è®¾ç½®å›å»ï¼Œäº¤ç»™å…³å¿ƒçš„çº¿ç¨‹æ¥å¤„ç†.</span></span><br><span class="line">                        Thread.currentThread().interrupt();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ================================================</span></span><br><span class="line">    <span class="comment">// === åˆ°è¿™é‡Œï¼Œå°±æ˜¯ä»£è¡¨ä¸Šé¢çš„å®ä¾‹åŒ–æ‰€æœ‰çº¿ç¨‹å·²ç»æˆåŠŸç»“æŸ ===</span></span><br><span class="line">    <span class="comment">// ================================================</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€šè¿‡ä¹‹å‰è®¾ç½®çš„ chooserFactory æ¥å®ä¾‹åŒ– Chooserï¼ŒæŠŠçº¿ç¨‹æ± æ•°ç»„ä¼ è¿›å»ï¼Œ</span></span><br><span class="line">    <span class="comment">//     è¿™å°±ä¸å¿…å†è¯´äº†å§ï¼Œå®ç°çº¿ç¨‹é€‰æ‹©ç­–ç•¥</span></span><br><span class="line">    chooser = chooserFactory.newChooser(children);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¾ç½®ä¸€ä¸ª Listener ç”¨æ¥ç›‘å¬è¯¥çº¿ç¨‹æ± çš„ termination äº‹ä»¶</span></span><br><span class="line">    <span class="comment">// ä¸‹é¢çš„ä»£ç é€»è¾‘æ˜¯ï¼šç»™æ± ä¸­æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½è®¾ç½®è¿™ä¸ª listenerï¼Œå½“ç›‘å¬åˆ°æ‰€æœ‰çº¿ç¨‹éƒ½ terminate ä»¥åï¼Œè¿™ä¸ªçº¿ç¨‹æ± å°±ç®—çœŸæ­£çš„ terminate äº†ã€‚</span></span><br><span class="line">    <span class="keyword">final</span> FutureListener&lt;Object&gt; terminationListener = <span class="keyword">new</span> <span class="title class_">FutureListener</span>&lt;Object&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">operationComplete</span><span class="params">(Future&lt;Object&gt; future)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="keyword">if</span> (terminatedChildren.incrementAndGet() == children.length) &#123;</span><br><span class="line">                terminationFuture.setSuccess(<span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">for</span> (EventExecutor e: children) &#123;</span><br><span class="line">        e.terminationFuture().addListener(terminationListener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½® readonlyChildrenï¼Œå®ƒæ˜¯åªè¯»é›†åˆï¼Œä»¥åç”¨åˆ°å†è¯´</span></span><br><span class="line">    Set&lt;EventExecutor&gt; childrenSet = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;EventExecutor&gt;(children.length);</span><br><span class="line">    Collections.addAll(childrenSet, children);</span><br><span class="line">    readonlyChildren = Collections.unmodifiableSet(childrenSet);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ä»£ç éå¸¸ç®€å•å§ï¼Œæ²¡æœ‰ä»€ä¹ˆéœ€è¦ç‰¹åˆ«è¯´çš„ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ newChild() è¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•éå¸¸é‡è¦ï¼Œå®ƒå°†åˆ›å»ºçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ã€‚</p>
<blockquote>
<p>æˆ‘ä¸Šé¢å·²ç»ç”¨è¿‡å¾ˆå¤šæ¬¡â€çº¿ç¨‹â€è¿™ä¸ªè¯äº†ï¼Œå®ƒå¯ä¸æ˜¯ Thread çš„æ„æ€ï¼Œè€Œæ˜¯æŒ‡æ± ä¸­çš„ä¸ªä½“ï¼Œåé¢æˆ‘ä»¬ä¼šçœ‹åˆ°æ¯ä¸ªâ€çº¿ç¨‹â€åœ¨ä»€ä¹ˆæ—¶å€™ä¼šçœŸæ­£åˆ›å»º Thread å®ä¾‹ã€‚åæ­£æ¯ä¸ª NioEventLoop å®ä¾‹å†…éƒ¨éƒ½ä¼šæœ‰ä¸€ä¸ªè‡ªå·±çš„ Thread å®ä¾‹ï¼Œæ‰€ä»¥æŠŠè¿™ä¸¤ä¸ªæ¦‚å¿µæ··åœ¨ä¸€èµ·ä¹Ÿæ— æ‰€è°“å§ã€‚</p>
</blockquote>
<p><code>newChild(â€¦)</code> æ–¹æ³•åœ¨ NioEventLoopGroup ä¸­è¦†å†™äº†ï¼Œä¸Šé¢è¯´çš„â€çº¿ç¨‹â€å…¶å®å°±æ˜¯ NioEventLoopï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> EventLoop <span class="title function_">newChild</span><span class="params">(Executor executor, Object... args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">NioEventLoop</span>(<span class="built_in">this</span>, executor, (SelectorProvider) args[<span class="number">0</span>],</span><br><span class="line">        ((SelectStrategyFactory) args[<span class="number">1</span>]).newSelectStrategy(), (RejectedExecutionHandler) args[<span class="number">2</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®ƒè°ƒç”¨äº† NioEventLoop çš„æ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">NioEventLoop(NioEventLoopGroup parent, Executor executor, SelectorProvider selectorProvider,</span><br><span class="line">             SelectStrategy strategy, RejectedExecutionHandler rejectedExecutionHandler) &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨çˆ¶ç±»æ„é€ å™¨</span></span><br><span class="line">    <span class="built_in">super</span>(parent, executor, <span class="literal">false</span>, DEFAULT_MAX_PENDING_TASKS, rejectedExecutionHandler);</span><br><span class="line">    <span class="keyword">if</span> (selectorProvider == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;selectorProvider&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (strategy == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;selectStrategy&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    provider = selectorProvider;</span><br><span class="line">    <span class="comment">// å¼€å¯ NIO ä¸­æœ€é‡è¦çš„ç»„ä»¶ï¼šSelector</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">SelectorTuple</span> <span class="variable">selectorTuple</span> <span class="operator">=</span> openSelector();</span><br><span class="line">    selector = selectorTuple.selector;</span><br><span class="line">    unwrappedSelector = selectorTuple.unwrappedSelector;</span><br><span class="line">    selectStrategy = strategy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å…ˆç²—ç•¥è§‚å¯Ÿä¸€ä¸‹ï¼Œç„¶åå†å¾€ä¸‹çœ‹ï¼š</p>
<ul>
<li>åœ¨ Netty ä¸­ï¼ŒNioEventLoopGroup ä»£è¡¨çº¿ç¨‹æ± ï¼ŒNioEventLoop å°±æ˜¯å…¶ä¸­çš„çº¿ç¨‹ã€‚</li>
<li>çº¿ç¨‹æ±  NioEventLoopGroup æ˜¯æ± ä¸­çš„çº¿ç¨‹ NioEventLoop çš„ <strong>parent</strong>ï¼Œä»ä¸Šé¢çš„ä»£ç ä¸­çš„å–åå¯ä»¥çœ‹å‡ºã€‚</li>
<li>æ¯ä¸ª NioEventLoop éƒ½æœ‰è‡ªå·±çš„ Selectorï¼Œä¸Šé¢çš„ä»£ç ä¹Ÿååº”äº†è¿™ä¸€ç‚¹ï¼Œè¿™å’Œ Tomcat ä¸­çš„ NIO æ¨¡å‹æœ‰ç‚¹åŒºåˆ«ã€‚</li>
<li>executorã€selectStrategy å’Œ rejectedExecutionHandler ä» NioEventLoopGroup ä¸­ä¸€è·¯ä¼ åˆ°äº† NioEventLoop ä¸­ã€‚</li>
</ul>
<p>è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ NioEventLoop ç±»çš„å±æ€§éƒ½æœ‰å“ªäº›ï¼Œæˆ‘ä»¬å…ˆå¿½ç•¥å®ƒç»§æ‰¿è‡ªçˆ¶ç±»çš„å±æ€§ï¼Œå•å•çœ‹å®ƒè‡ªå·±çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Selector selector;</span><br><span class="line"><span class="keyword">private</span> Selector unwrappedSelector;</span><br><span class="line"><span class="keyword">private</span> SelectedSelectionKeySet selectedKeys;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SelectorProvider provider;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicBoolean</span> <span class="variable">wakenUp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicBoolean</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SelectStrategy selectStrategy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> <span class="variable">ioRatio</span> <span class="operator">=</span> <span class="number">50</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> cancelledKeys;</span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> needsToSelectAgain;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç»“åˆå®ƒçš„æ„é€ æ–¹æ³•æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹ï¼š</p>
<ul>
<li>providerï¼šå®ƒç”± NioEventLoopGroup ä¼ è¿›æ¥ï¼Œå‰é¢æˆ‘ä»¬è¯´äº†ä¸€ä¸ªçº¿ç¨‹æ± æœ‰ä¸€ä¸ª selectorProviderï¼Œç”¨äºåˆ›å»º Selector å®ä¾‹</li>
<li>selectorï¼šè™½ç„¶æˆ‘ä»¬è¿˜æ²¡çœ‹åˆ›å»º selector çš„ä»£ç ï¼Œä½†æˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œåœ¨ Netty ä¸­ Selector æ˜¯è·Ÿç€çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹èµ°çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¹¶éä¸€ä¸ªçº¿ç¨‹æ± ä¸€ä¸ª Selector å®ä¾‹ï¼Œè€Œæ˜¯çº¿ç¨‹æ± ä¸­æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ª Selector å®ä¾‹ã€‚</li>
<li>selectStrategyï¼šselect æ“ä½œçš„ç­–ç•¥ï¼Œè¿™ä¸ªä¸æ€¥ã€‚</li>
<li>ioRatioï¼šè¿™æ˜¯ IO ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´æ¯”ä¾‹ï¼Œå› ä¸ºæ¯ä¸ªçº¿ç¨‹æ—¢æœ‰ IO ä»»åŠ¡æ‰§è¡Œï¼Œä¹Ÿæœ‰é IO ä»»åŠ¡éœ€è¦æ‰§è¡Œï¼Œæ‰€ä»¥è¯¥å‚æ•°ä¸ºäº†ä¿è¯æœ‰è¶³å¤Ÿæ—¶é—´æ˜¯ç»™ IO çš„ã€‚è¿™é‡Œä¹Ÿä¸éœ€è¦æ€¥ç€å»ç†è§£ä»€ä¹ˆ IO ä»»åŠ¡ã€ä»€ä¹ˆé IO ä»»åŠ¡ã€‚</li>
</ul>
<p>ç„¶åæˆ‘ä»¬ç»§ç»­èµ°å®ƒçš„æ„é€ æ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸Šé¢çš„æ„é€ æ–¹æ³•è°ƒç”¨äº†çˆ¶ç±»çš„æ„é€ å™¨ï¼Œå®ƒçš„çˆ¶ç±»æ˜¯ SingleThreadEventLoopã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">SingleThreadEventLoop</span><span class="params">(EventLoopGroup parent, Executor executor,</span></span><br><span class="line"><span class="params">                                <span class="type">boolean</span> addTaskWakesUp, <span class="type">int</span> maxPendingTasks,</span></span><br><span class="line"><span class="params">                                RejectedExecutionHandler rejectedExecutionHandler)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(parent, executor, addTaskWakesUp, maxPendingTasks, rejectedExecutionHandler);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æˆ‘ä»¬å¯ä»¥ç›´æ¥å¿½ç•¥è¿™ä¸ªä¸œè¥¿ï¼Œä»¥åæˆ‘ä»¬ä¹Ÿä¸ä¼šå†ä»‹ç»å®ƒ</span></span><br><span class="line">    tailTasks = newTaskQueue(maxPendingTasks);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SingleThreadEventLoop è¿™ä¸ªåå­—å¾ˆè¯¡å¼‚æœ‰æ²¡æœ‰ï¼Ÿç„¶åå®ƒçš„æ„é€ æ–¹æ³•åˆè°ƒç”¨äº†çˆ¶ç±» SingleThreadEventExecutor çš„æ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">SingleThreadEventExecutor</span><span class="params">(EventExecutorGroup parent, Executor executor,</span></span><br><span class="line"><span class="params">                                    <span class="type">boolean</span> addTaskWakesUp, <span class="type">int</span> maxPendingTasks,</span></span><br><span class="line"><span class="params">                                    RejectedExecutionHandler rejectedHandler)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(parent);</span><br><span class="line">    <span class="built_in">this</span>.addTaskWakesUp = addTaskWakesUp;</span><br><span class="line">    <span class="built_in">this</span>.maxPendingTasks = Math.max(<span class="number">16</span>, maxPendingTasks);</span><br><span class="line">    <span class="built_in">this</span>.executor = ObjectUtil.checkNotNull(executor, <span class="string">&quot;executor&quot;</span>);</span><br><span class="line">    <span class="comment">// taskQueueï¼Œè¿™ä¸ªä¸œè¥¿å¾ˆé‡è¦ï¼Œæäº¤ç»™ NioEventLoop çš„ä»»åŠ¡éƒ½ä¼šè¿›å…¥åˆ°è¿™ä¸ª taskQueue ä¸­ç­‰å¾…è¢«æ‰§è¡Œ</span></span><br><span class="line">    <span class="comment">// è¿™ä¸ª queue çš„é»˜è®¤å®¹é‡æ˜¯ 16</span></span><br><span class="line">    taskQueue = newTaskQueue(<span class="built_in">this</span>.maxPendingTasks);</span><br><span class="line">    rejectedExecutionHandler = ObjectUtil.checkNotNull(rejectedHandler, <span class="string">&quot;rejectedHandler&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ°è¿™é‡Œå°±æ›´åŠ è¯¡å¼‚äº†ï¼ŒNioEventLoop çš„çˆ¶ç±»æ˜¯ SingleThreadEventLoopï¼Œè€Œ SingleThreadEventLoop çš„çˆ¶ç±»æ˜¯ <strong>SingleThreadEventExecutor</strong>ï¼Œå®ƒçš„åå­—å‘Šè¯‰æˆ‘ä»¬ï¼Œå®ƒæ˜¯ä¸€ä¸ª Executorï¼Œæ˜¯ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œè€Œä¸”æ˜¯ Single Thread å•çº¿ç¨‹çš„ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œçº¿ç¨‹æ±  NioEventLoopGroup ä¸­çš„æ¯ä¸€ä¸ªçº¿ç¨‹ NioEventLoop ä¹Ÿå¯ä»¥å½“åšä¸€ä¸ªçº¿ç¨‹æ± æ¥ç”¨ï¼Œåªä¸è¿‡å®ƒåªæœ‰ä¸€ä¸ªçº¿ç¨‹ã€‚è¿™ç§è®¾è®¡è™½ç„¶çœ‹ä¸Šå»å¾ˆå·§å¦™ï¼Œä¸è¿‡æœ‰ç‚¹åäººç±»çš„æ ·å­ã€‚</p>
<p>ä¸Šé¢è¿™ä¸ªæ„é€ å‡½æ•°æ¯”è¾ƒç®€å•ï¼š</p>
<ul>
<li><p>è®¾ç½®äº† parentï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰åˆ›å»ºçš„çº¿ç¨‹æ±  NioEventLoopGroup å®ä¾‹</p>
</li>
<li><p>executorï¼šå®ƒæ˜¯æˆ‘ä»¬ä¹‹å‰å®ä¾‹åŒ–çš„ ThreadPerTaskExecutorï¼Œæˆ‘ä»¬è¯´è¿‡ï¼Œè¿™ä¸ªä¸œè¥¿åœ¨çº¿ç¨‹æ± ä¸­æ²¡æœ‰ç”¨ï¼Œå®ƒæ˜¯ç»™ NioEventLoop ç”¨çš„ï¼Œé©¬ä¸Šæˆ‘ä»¬å°±è¦çœ‹åˆ°å®ƒäº†ã€‚æå‰é€éœ²ä¸€ä¸‹ï¼Œå®ƒç”¨æ¥å¼€å¯ NioEventLoop ä¸­çš„çº¿ç¨‹ï¼ˆThread å®ä¾‹ï¼‰ã€‚</p>
</li>
<li><p>taskQueueï¼šè¿™ç®—æ˜¯è¯¥æ„é€ æ–¹æ³•ä¸­æ–°çš„ä¸œè¥¿ï¼Œå®ƒæ˜¯ä»»åŠ¡é˜Ÿåˆ—ã€‚æˆ‘ä»¬å‰é¢è¯´è¿‡ï¼ŒNioEventLoop éœ€è¦è´Ÿè´£ IO äº‹ä»¶å’Œé IO äº‹ä»¶ï¼Œé€šå¸¸å®ƒéƒ½åœ¨æ‰§è¡Œ selector çš„ select æ–¹æ³•æˆ–è€…æ­£åœ¨å¤„ç† selectedKeysï¼Œå¦‚æœæˆ‘ä»¬è¦ submit ä¸€ä¸ªä»»åŠ¡ç»™å®ƒï¼Œä»»åŠ¡å°±ä¼šè¢«æ”¾åˆ° taskQueue ä¸­ï¼Œç­‰å®ƒæ¥è½®è¯¢ã€‚è¯¥é˜Ÿåˆ—æ˜¯çº¿ç¨‹å®‰å…¨çš„ LinkedBlockingQueueï¼Œé»˜è®¤å®¹é‡ä¸º 16ã€‚</p>
</li>
<li><p>rejectedExecutionHandlerï¼štaskQueue çš„é»˜è®¤å®¹é‡æ˜¯ 16ï¼Œæ‰€ä»¥ï¼Œå¦‚æœ submit çš„ä»»åŠ¡å †ç§¯äº†åˆ°äº† 16ï¼Œå†å¾€é‡Œé¢æäº¤ä»»åŠ¡ä¼šè§¦å‘ rejectedExecutionHandler çš„æ‰§è¡Œç­–ç•¥ã€‚</p>
<blockquote>
<p>è¿˜è®°å¾—é»˜è®¤ç­–ç•¥å—ï¼šæŠ›å‡ºRejectedExecutionException å¼‚å¸¸ã€‚</p>
<p>åœ¨ NioEventLoopGroup çš„é»˜è®¤æ„é€ ä¸­ï¼Œå®ƒçš„å®ç°æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">RejectedExecutionHandler</span> <span class="variable">REJECT</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RejectedExecutionHandler</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rejected</span><span class="params">(Runnable task, SingleThreadEventExecutor executor)</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RejectedExecutionException</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></blockquote>
</li>
</ul>
<p>ç„¶åï¼Œæˆ‘ä»¬å†å›åˆ° NioEventLoop çš„æ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">NioEventLoop(NioEventLoopGroup parent, Executor executor, SelectorProvider selectorProvider,</span><br><span class="line">             SelectStrategy strategy, RejectedExecutionHandler rejectedExecutionHandler) &#123;</span><br><span class="line">    <span class="comment">// æˆ‘ä»¬åˆšåˆšè¯´å®Œäº†è¿™ä¸ª</span></span><br><span class="line">    <span class="built_in">super</span>(parent, executor, <span class="literal">false</span>, DEFAULT_MAX_PENDING_TASKS, rejectedExecutionHandler);</span><br><span class="line">    <span class="keyword">if</span> (selectorProvider == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;selectorProvider&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (strategy == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;selectStrategy&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    provider = selectorProvider;</span><br><span class="line">    <span class="comment">// åˆ›å»º selector å®ä¾‹</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">SelectorTuple</span> <span class="variable">selectorTuple</span> <span class="operator">=</span> openSelector();</span><br><span class="line">    selector = selectorTuple.selector;</span><br><span class="line">    unwrappedSelector = selectorTuple.unwrappedSelector;</span><br><span class="line">    </span><br><span class="line">    selectStrategy = strategy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œæœ€é‡è¦çš„æ–¹æ³•å…¶å®å°±æ˜¯ openSelector() æ–¹æ³•ï¼Œå®ƒå°†åˆ›å»º NIO ä¸­æœ€é‡è¦çš„ä¸€ä¸ªç»„ä»¶ <strong>Selector</strong>ã€‚åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼ŒNetty ä¹Ÿåšäº†ä¸€äº›ä¼˜åŒ–ï¼Œè¿™éƒ¨åˆ†æˆ‘ä»¬å°±ä¸å»åˆ†æå®ƒäº†ã€‚</p>
<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çš„çº¿ç¨‹æ±  NioEventLoopGroup åˆ›å»ºå®Œæˆäº†ï¼Œå¹¶ä¸”å®ä¾‹åŒ–äº†æ± ä¸­çš„æ‰€æœ‰ NioEventLoop å®ä¾‹ã€‚</p>
<p>åŒæ—¶ï¼Œå¤§å®¶åº”è¯¥å·²ç»çœ‹åˆ°ï¼Œä¸Šé¢å¹¶æ²¡æœ‰çœŸæ­£åˆ›å»º NioEventLoop ä¸­çš„çº¿ç¨‹ï¼ˆæ²¡æœ‰åˆ›å»º Thread å®ä¾‹ï¼‰ã€‚</p>
<p>æå‰é€éœ²ä¸€ä¸‹ï¼Œåˆ›å»ºçº¿ç¨‹çš„æ—¶æœºåœ¨ç¬¬ä¸€ä¸ªä»»åŠ¡æäº¤è¿‡æ¥çš„æ—¶å€™ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªä»»åŠ¡æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ˜¯æˆ‘ä»¬é©¬ä¸Šè¦è¯´çš„ channel çš„ <strong>register</strong> æ“ä½œã€‚</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://scatteredream.github.io/2018/11/03/netty-source-code-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/62317679?s=400&v=4">
      <meta itemprop="name" content="ç¢æ¢¦">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="scatteredream's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | scatteredream's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/11/03/netty-source-code-2/" class="post-title-link" itemprop="url">è®¤çœŸçš„ Netty æºç è§£æï¼ˆäºŒï¼‰(è½¬è‡ªJavaDoop)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2018-11-03 00:00:00" itemprop="dateCreated datePublished" datetime="2018-11-03T00:00:00+08:00">2018-11-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-04-27 15:17:04" itemprop="dateModified" datetime="2025-04-27T15:17:04+08:00">2025-04-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/netty/" itemprop="url" rel="index"><span itemprop="name">netty</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Channel-çš„-register-æ“ä½œ"><a href="#Channel-çš„-register-æ“ä½œ" class="headerlink" title="Channel çš„ register æ“ä½œ"></a>Channel çš„ register æ“ä½œ</h2><p>ç»è¿‡å‰é¢çš„é“ºå«ï¼Œæˆ‘ä»¬å·²ç»å…·å¤‡ä¸€å®šçš„åŸºç¡€äº†ï¼Œæˆ‘ä»¬å¼€å§‹æ¥æŠŠå‰é¢å­¦åˆ°çš„å†…å®¹æ‰åœ¨ä¸€èµ·ã€‚è¿™èŠ‚ï¼Œæˆ‘ä»¬ä¼šä»‹ç» register æ“ä½œï¼Œè¿™ä¸€æ­¥å…¶å®æ˜¯éå¸¸å…³é”®çš„ï¼Œå¯¹äºæˆ‘ä»¬æºç åˆ†æéå¸¸é‡è¦ã€‚</p>
<h3 id="register"><a href="#register" class="headerlink" title="register"></a>register</h3><p>æˆ‘ä»¬ä» EchoClient ä¸­çš„ connect() æ–¹æ³•å‡ºå‘ï¼Œæˆ–è€… EchoServer çš„ bind(port) æ–¹æ³•å‡ºå‘ï¼Œéƒ½ä¼šèµ°åˆ° initAndRegister() è¿™ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ChannelFuture <span class="title function_">initAndRegister</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1</span></span><br><span class="line">        channel = channelFactory.newChannel();</span><br><span class="line">        <span class="comment">// 2 å¯¹äº Bootstrap å’Œ ServerBootstrapï¼Œè¿™é‡Œé¢æœ‰äº›ä¸ä¸€æ ·</span></span><br><span class="line">        init(channel);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 3 æˆ‘ä»¬è¿™é‡Œè¦è¯´çš„æ˜¯è¿™è¡Œ</span></span><br><span class="line">    <span class="type">ChannelFuture</span> <span class="variable">regFuture</span> <span class="operator">=</span> config().group().register(channel);</span><br><span class="line">    <span class="keyword">if</span> (regFuture.cause() != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (channel.isRegistered()) &#123;</span><br><span class="line">            channel.close();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            channel.unsafe().closeForcibly();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> regFuture;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>initAndRegister() è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬å·²ç»æ¥è§¦è¿‡ä¸¤æ¬¡äº†ï¼Œå‰é¢ä»‹ç»äº† 1ï¸âƒ£ Channel çš„å®ä¾‹åŒ–ï¼Œå®ä¾‹åŒ–è¿‡ç¨‹ä¸­ï¼Œä¼šæ‰§è¡Œ Channel å†…éƒ¨ Unsafe å’Œ Pipeline çš„å®ä¾‹åŒ–ï¼Œä»¥åŠåœ¨ä¸Šé¢ 2ï¸âƒ£ init(channel) æ–¹æ³•ä¸­ï¼Œä¼šå¾€ pipeline ä¸­æ·»åŠ  handlerï¼ˆpipeline æ­¤æ—¶æ˜¯ head+channelnitializer+tailï¼‰ã€‚</p>
<blockquote>
<p>æˆ‘ä»¬è¿™èŠ‚ç»ˆäºè¦æ­ç§˜ ChannelInitializer ä¸­çš„ initChannel æ–¹æ³•äº†~~~</p>
</blockquote>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹èµ°ï¼Œçœ‹çœ‹ 3ï¸âƒ£ <strong>register</strong> è¿™ä¸€æ­¥ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ChannelFuture</span> <span class="variable">regFuture</span> <span class="operator">=</span> config().group().register(channel);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æˆ‘ä»¬è¯´äº†ï¼Œregister è¿™ä¸€æ­¥æ˜¯éå¸¸å…³é”®çš„ï¼Œå®ƒå‘ç”Ÿåœ¨ channel å®ä¾‹åŒ–ä»¥åï¼Œå¤§å®¶å›å¿†ä¸€ä¸‹å½“å‰ channel ä¸­çš„ä¸€äº›æƒ…å†µï¼š</p>
<p>å®ä¾‹åŒ–äº† JDK åº•å±‚çš„ Channelï¼Œè®¾ç½®äº†éé˜»å¡ï¼Œå®ä¾‹åŒ–äº† Unsafeï¼Œå®ä¾‹åŒ–äº† Pipelineï¼ŒåŒæ—¶å¾€ pipeline ä¸­æ·»åŠ äº† headã€tail ä»¥åŠä¸€ä¸ª ChannelInitializer å®ä¾‹ã€‚</p>
</blockquote>
<p>ä¸Šé¢çš„ <code>config().group()</code> æ–¹æ³•ä¼šè¿”å›å‰é¢å®ä¾‹åŒ–çš„ NioEventLoopGroup çš„å®ä¾‹ï¼Œç„¶åè°ƒç”¨å…¶ register(channel) æ–¹æ³•ï¼š</p>
<p>// MultithreadEventLoopGroup</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ChannelFuture <span class="title function_">register</span><span class="params">(Channel channel)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> next().register(channel);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>next() æ–¹æ³•å¾ˆç®€å•ï¼Œå°±æ˜¯é€‰æ‹©çº¿ç¨‹æ± ä¸­çš„ä¸€ä¸ªçº¿ç¨‹ï¼ˆè¿˜è®°å¾— chooserFactory å—ï¼‰ï¼Œä¹Ÿå°±æ˜¯é€‰æ‹©ä¸€ä¸ª NioEventLoop å®ä¾‹ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±è¿›å…¥åˆ° NioEventLoop äº†ã€‚</p>
<p>NioEventLoop çš„ register(channel) æ–¹æ³•å®ç°åœ¨å®ƒçš„çˆ¶ç±» <strong>SingleThreadEventLoop</strong> ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ChannelFuture <span class="title function_">register</span><span class="params">(Channel channel)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> register(<span class="keyword">new</span> <span class="title class_">DefaultChannelPromise</span>(channel, <span class="built_in">this</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ä»£ç å®ä¾‹åŒ–äº†ä¸€ä¸ª Promiseï¼Œå°†å½“å‰ channel å¸¦äº†è¿›å»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ChannelFuture <span class="title function_">register</span><span class="params">(<span class="keyword">final</span> ChannelPromise promise)</span> &#123;</span><br><span class="line">    ObjectUtil.checkNotNull(promise, <span class="string">&quot;promise&quot;</span>);</span><br><span class="line">    <span class="comment">// promise å…³è”äº† channelï¼Œchannel æŒæœ‰ Unsafe å®ä¾‹ï¼Œregister æ“ä½œå°±å°è£…åœ¨ Unsafe ä¸­</span></span><br><span class="line">    promise.channel().unsafe().register(<span class="built_in">this</span>, promise);</span><br><span class="line">    <span class="keyword">return</span> promise;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‹¿åˆ° channel ä¸­å…³è”çš„ Unsafe å®ä¾‹ï¼Œç„¶åè°ƒç”¨å®ƒçš„ register æ–¹æ³•ï¼š</p>
<blockquote>
<p>æˆ‘ä»¬è¯´è¿‡ï¼ŒUnsafe ä¸“é—¨ç”¨æ¥å°è£…åº•å±‚å®ç°ï¼Œå½“ç„¶è¿™é‡Œä¹Ÿæ²¡é‚£ä¹ˆâ€œåº•å±‚â€</p>
</blockquote>
<p>// AbstractChannel#<strong>AbstractUnsafe</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(EventLoop eventLoop, <span class="keyword">final</span> ChannelPromise promise)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// å°†è¿™ä¸ª eventLoop å®ä¾‹è®¾ç½®ç»™è¿™ä¸ª channelï¼Œä»æ­¤è¿™ä¸ª channel å°±æ˜¯æœ‰ eventLoop çš„äº†</span></span><br><span class="line">    <span class="comment">// æˆ‘è§‰å¾—è¿™ä¸€æ­¥å…¶å®æŒºå…³é”®çš„ï¼Œå› ä¸ºåç»­è¯¥ channel ä¸­çš„æ‰€æœ‰å¼‚æ­¥æ“ä½œï¼Œéƒ½è¦æäº¤ç»™è¿™ä¸ª eventLoop æ¥æ‰§è¡Œ</span></span><br><span class="line">    AbstractChannel.<span class="built_in">this</span>.eventLoop = eventLoop;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœå‘èµ· register åŠ¨ä½œçš„çº¿ç¨‹å°±æ˜¯ eventLoop å®ä¾‹ä¸­çš„çº¿ç¨‹ï¼Œé‚£ä¹ˆç›´æ¥è°ƒç”¨ register0(promise)</span></span><br><span class="line">    <span class="comment">// å¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œå®ƒä¸ä¼šè¿›å…¥åˆ°è¿™ä¸ªåˆ†æ”¯ï¼Œ</span></span><br><span class="line">    <span class="comment">//     ä¹‹æ‰€ä»¥æœ‰è¿™ä¸ªåˆ†æ”¯ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬æ˜¯å¯ä»¥ unregisterï¼Œç„¶åå† register çš„ï¼Œåé¢å†ä»”ç»†çœ‹</span></span><br><span class="line">    <span class="keyword">if</span> (eventLoop.inEventLoop()) &#123;</span><br><span class="line">        register0(promise);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// å¦åˆ™ï¼Œæäº¤ä»»åŠ¡ç»™ eventLoopï¼ŒeventLoop ä¸­çš„çº¿ç¨‹ä¼šè´Ÿè´£è°ƒç”¨ register0(promise)</span></span><br><span class="line">            eventLoop.execute(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    register0(promise);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬è¦æ˜ç™½ï¼ŒNioEventLoop ä¸­æ˜¯è¿˜æ²¡æœ‰å®ä¾‹åŒ– Thread å®ä¾‹çš„ã€‚</p>
</blockquote>
<p>è¿™å‡ æ­¥æ¶‰åŠåˆ°äº†å¥½å‡ ä¸ªç±»ï¼šNioEventLoopã€Promiseã€Channelã€Unsafe ç­‰ï¼Œå¤§å®¶è¦ä»”ç»†ç†æ¸…æ¥šå®ƒä»¬çš„å…³ç³»ã€‚</p>
<p>å¯¹äºæˆ‘ä»¬å‰é¢è¿‡æ¥çš„ register æ“ä½œï¼Œå…¶å®æäº¤åˆ° eventLoop ä»¥åï¼Œå°±ç›´æ¥è¿”å› promise å®ä¾‹äº†ï¼Œå‰©ä¸‹çš„register0 æ˜¯å¼‚æ­¥æ“ä½œï¼Œå®ƒç”± NioEventLoop å®ä¾‹æ¥å®Œæˆã€‚</p>
<p>æˆ‘ä»¬è¿™è¾¹å…ˆä¸ç»§ç»­å¾€é‡Œåˆ†æ register0(promise) æ–¹æ³•ï¼Œå…ˆæŠŠå‰é¢æ¬ ä¸‹çš„ NioEventLoop ä¸­çš„çº¿ç¨‹ä»‹ç»æ¸…æ¥šï¼Œç„¶åå†å›æ¥ä»‹ç»è¿™ä¸ª register0 æ–¹æ³•ã€‚</p>
<blockquote>
<p>Channel å®ä¾‹ä¸€æ—¦ register åˆ°äº† NioEventLoopGroup å®ä¾‹ä¸­çš„æŸä¸ª NioEventLoop å®ä¾‹ï¼Œé‚£ä¹ˆåç»­è¯¥ Channel çš„æ‰€æœ‰æ“ä½œï¼Œéƒ½æ˜¯ç”±è¯¥ NioEventLoop å®ä¾‹æ¥å®Œæˆçš„ã€‚</p>
<p>è¿™ä¸ªä¹Ÿéå¸¸ç®€å•ï¼Œå› ä¸º Selector å®ä¾‹æ˜¯åœ¨ NioEventLoop å®ä¾‹ä¸­çš„ï¼ŒChannel å®ä¾‹ä¸€æ—¦æ³¨å†Œåˆ°æŸä¸ª Selector å®ä¾‹ä¸­ï¼Œå½“ç„¶ä¹Ÿåªèƒ½åœ¨è¿™ä¸ªå®ä¾‹ä¸­å¤„ç† NIO äº‹ä»¶ã€‚</p>
</blockquote>
<h3 id="NioEventLoop-å·¥ä½œæµç¨‹"><a href="#NioEventLoop-å·¥ä½œæµç¨‹" class="headerlink" title="NioEventLoop å·¥ä½œæµç¨‹"></a>NioEventLoop å·¥ä½œæµç¨‹</h3><p>å‰é¢ï¼Œæˆ‘ä»¬åœ¨åˆ†æçº¿ç¨‹æ± çš„å®ä¾‹åŒ–çš„æ—¶å€™è¯´è¿‡ï¼ŒNioEventLoop ä¸­å¹¶æ²¡æœ‰å¯åŠ¨ Java çº¿ç¨‹ã€‚è¿™é‡Œæˆ‘ä»¬æ¥ä»”ç»†åˆ†æä¸‹åœ¨ register è¿‡ç¨‹ä¸­è°ƒç”¨çš„ <strong>eventLoop.execute(runnable)</strong> è¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªä»£ç åœ¨çˆ¶ç±» SingleThreadEventExecutor ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable task)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (task == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;task&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// åˆ¤æ–­æ·»åŠ ä»»åŠ¡çš„çº¿ç¨‹æ˜¯å¦å°±æ˜¯å½“å‰ EventLoop ä¸­çš„çº¿ç¨‹</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">inEventLoop</span> <span class="operator">=</span> inEventLoop();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ·»åŠ ä»»åŠ¡åˆ°ä¹‹å‰ä»‹ç»çš„ taskQueue ä¸­ï¼Œ</span></span><br><span class="line">    <span class="comment">// 	å¦‚æœ taskQueue æ»¡äº†(é»˜è®¤å¤§å° 16)ï¼Œæ ¹æ®æˆ‘ä»¬ä¹‹å‰è¯´çš„ï¼Œé»˜è®¤çš„ç­–ç•¥æ˜¯æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    addTask(task);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!inEventLoop) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœä¸æ˜¯ NioEventLoop å†…éƒ¨çº¿ç¨‹æäº¤çš„ taskï¼Œé‚£ä¹ˆåˆ¤æ–­ä¸‹çº¿ç¨‹æ˜¯å¦å·²ç»å¯åŠ¨ï¼Œæ²¡æœ‰çš„è¯ï¼Œå°±å¯åŠ¨çº¿ç¨‹</span></span><br><span class="line">        startThread();</span><br><span class="line">        <span class="keyword">if</span> (isShutdown() &amp;&amp; removeTask(task)) &#123;</span><br><span class="line">            reject();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!addTaskWakesUp &amp;&amp; wakesUpForTask(task)) &#123;</span><br><span class="line">        wakeup(inEventLoop);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>åŸæ¥å¯åŠ¨ NioEventLoop ä¸­çš„çº¿ç¨‹çš„æ–¹æ³•åœ¨è¿™é‡Œã€‚</p>
<p>å¦å¤–ï¼Œä¸ŠèŠ‚æˆ‘ä»¬è¯´çš„ register æ“ä½œè¿›åˆ°äº† taskQueue ä¸­ï¼Œæ‰€ä»¥å®ƒå…¶å®æ˜¯è¢«å½’ç±»åˆ°äº†é IO æ“ä½œçš„èŒƒç•´ã€‚</p>
</blockquote>
<p>ä¸‹é¢æ˜¯ startThread çš„æºç ï¼Œåˆ¤æ–­çº¿ç¨‹æ˜¯å¦å·²ç»å¯åŠ¨æ¥å†³å®šæ˜¯å¦è¦è¿›è¡Œå¯åŠ¨æ“ä½œï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startThread</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (state == ST_NOT_STARTED) &#123;</span><br><span class="line">        <span class="keyword">if</span> (STATE_UPDATER.compareAndSet(<span class="built_in">this</span>, ST_NOT_STARTED, ST_STARTED)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                doStartThread();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable cause) &#123;</span><br><span class="line">                STATE_UPDATER.set(<span class="built_in">this</span>, ST_NOT_STARTED);</span><br><span class="line">                PlatformDependent.throwException(cause);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æŒ‰ç…§å‰é¢çš„æ€è·¯ï¼Œæ ¹æ®çº¿ç¨‹æ²¡æœ‰å¯åŠ¨çš„æƒ…å†µï¼Œæ¥çœ‹çœ‹ doStartThread() æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doStartThread</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">assert</span> thread == <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// è¿™é‡Œçš„ executor å¤§å®¶æ˜¯ä¸æ˜¯æœ‰ç‚¹ç†Ÿæ‚‰çš„æ„Ÿè§‰ï¼Œå®ƒå°±æ˜¯ä¸€å¼€å§‹æˆ‘ä»¬å®ä¾‹åŒ– NioEventLoop çš„æ—¶å€™ä¼ è¿›æ¥çš„ ThreadPerTaskExecutor çš„å®ä¾‹ã€‚å®ƒæ˜¯æ¯æ¬¡æ¥ä¸€ä¸ªä»»åŠ¡ï¼Œåˆ›å»ºä¸€ä¸ªçº¿ç¨‹çš„é‚£ç§ executorã€‚</span></span><br><span class="line">    <span class="comment">// ä¸€æ—¦æˆ‘ä»¬è°ƒç”¨å®ƒçš„ execute æ–¹æ³•ï¼Œå®ƒå°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œæ‰€ä»¥è¿™é‡Œç»ˆäºä¼šåˆ›å»º Thread å®ä¾‹</span></span><br><span class="line">    executor.execute(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">// çœ‹è¿™é‡Œï¼Œå°† â€œexecutorâ€ ä¸­åˆ›å»ºçš„è¿™ä¸ªçº¿ç¨‹è®¾ç½®ä¸º NioEventLoop çš„çº¿ç¨‹ï¼ï¼ï¼</span></span><br><span class="line">            thread = Thread.currentThread();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (interrupted) &#123;</span><br><span class="line">                thread.interrupt();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            updateLastExecutionTime();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// æ‰§è¡Œ SingleThreadEventExecutor çš„ run() æ–¹æ³•ï¼Œå®ƒåœ¨ NioEventLoop ä¸­å®ç°äº†</span></span><br><span class="line">                SingleThreadEventExecutor.<span class="built_in">this</span>.run();</span><br><span class="line">                success = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                logger.warn(<span class="string">&quot;Unexpected exception from an event executor: &quot;</span>, t);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// ... æˆ‘ä»¬ç›´æ¥å¿½ç•¥æ‰è¿™é‡Œçš„ä»£ç </span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çº¿ç¨‹å¯åŠ¨ä»¥åï¼Œä¼šæ‰§è¡Œ NioEventLoop ä¸­çš„ run() æ–¹æ³•ï¼Œè¿™æ˜¯ä¸€ä¸ª<strong>éå¸¸é‡è¦</strong>çš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•è‚¯å®šæ˜¯æ²¡é‚£ä¹ˆå®¹æ˜“ç»“æŸçš„ï¼Œå¿…ç„¶æ˜¯åƒ JDK çº¿ç¨‹æ± çš„ Worker é‚£æ ·ï¼Œä¸æ–­åœ°å¾ªç¯è·å–æ–°çš„ä»»åŠ¡çš„ã€‚å®ƒéœ€è¦ä¸æ–­åœ°åš select æ“ä½œå’Œè½®è¯¢ taskQueue è¿™ä¸ªé˜Ÿåˆ—ã€‚</p>
<p>æˆ‘ä»¬å…ˆæ¥ç®€å•åœ°çœ‹ä¸€ä¸‹å®ƒçš„æºç ï¼Œè¿™é‡Œå…ˆä¸åšæ·±å…¥åœ°ä»‹ç»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// ä»£ç åµŒå¥—åœ¨ for å¾ªç¯ä¸­</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// selectStrategy ç»ˆäºè¦æ´¾ä¸Šç”¨åœºäº†</span></span><br><span class="line">            <span class="comment">// å®ƒæœ‰ä¸¤ä¸ªå€¼ï¼Œä¸€ä¸ªæ˜¯ CONTINUE ä¸€ä¸ªæ˜¯ SELECT</span></span><br><span class="line">            <span class="comment">// é’ˆå¯¹è¿™å—ä»£ç ï¼Œæˆ‘ä»¬åˆ†æä¸€ä¸‹ã€‚</span></span><br><span class="line">            <span class="comment">// 1. å¦‚æœ taskQueue ä¸ä¸ºç©ºï¼Œä¹Ÿå°±æ˜¯ hasTasks() è¿”å› trueï¼Œ</span></span><br><span class="line">            <span class="comment">// 		é‚£ä¹ˆæ‰§è¡Œä¸€æ¬¡ selectNow()ï¼Œè¯¥æ–¹æ³•ä¸ä¼šé˜»å¡</span></span><br><span class="line">            <span class="comment">// 2. å¦‚æœ hasTasks() è¿”å› falseï¼Œé‚£ä¹ˆæ‰§è¡Œ SelectStrategy.SELECT åˆ†æ”¯ï¼Œ</span></span><br><span class="line">            <span class="comment">//    è¿›è¡Œ select(...)ï¼Œè¿™å—æ˜¯å¸¦é˜»å¡çš„</span></span><br><span class="line">            <span class="comment">// è¿™ä¸ªå¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯æŒ‰ç…§æ˜¯å¦æœ‰ä»»åŠ¡åœ¨æ’é˜Ÿæ¥å†³å®šæ˜¯å¦å¯ä»¥è¿›è¡Œé˜»å¡</span></span><br><span class="line">            <span class="keyword">switch</span> (selectStrategy.calculateStrategy(selectNowSupplier, hasTasks())) &#123;</span><br><span class="line">                <span class="keyword">case</span> SelectStrategy.CONTINUE:</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">case</span> SelectStrategy.SELECT:</span><br><span class="line">                    <span class="comment">// å¦‚æœ !hasTasks()ï¼Œé‚£ä¹ˆè¿›åˆ°è¿™ä¸ª select åˆ†æ”¯ï¼Œè¿™é‡Œ select å¸¦é˜»å¡çš„</span></span><br><span class="line">                    select(wakenUp.getAndSet(<span class="literal">false</span>));</span><br><span class="line">                    <span class="keyword">if</span> (wakenUp.get()) &#123;</span><br><span class="line">                        selector.wakeup();</span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">            cancelledKeys = <span class="number">0</span>;</span><br><span class="line">            needsToSelectAgain = <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">// é»˜è®¤åœ°ï¼ŒioRatio çš„å€¼æ˜¯ 50</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ioRatio</span> <span class="operator">=</span> <span class="built_in">this</span>.ioRatio;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (ioRatio == <span class="number">100</span>) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœ ioRatio è®¾ç½®ä¸º 100ï¼Œé‚£ä¹ˆå…ˆæ‰§è¡Œ IO æ“ä½œï¼Œç„¶ååœ¨ finally å—ä¸­æ‰§è¡Œ taskQueue ä¸­çš„ä»»åŠ¡</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 1. æ‰§è¡Œ IO æ“ä½œã€‚å› ä¸ºå‰é¢ select ä»¥åï¼Œå¯èƒ½æœ‰äº› channel æ˜¯éœ€è¦å¤„ç†çš„ã€‚</span></span><br><span class="line">                    processSelectedKeys();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// 2. æ‰§è¡Œé IO ä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯ taskQueue ä¸­çš„ä»»åŠ¡</span></span><br><span class="line">                    runAllTasks();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœ ioRatio ä¸æ˜¯ 100ï¼Œé‚£ä¹ˆæ ¹æ® IO æ“ä½œè€—æ—¶ï¼Œé™åˆ¶é IO æ“ä½œè€—æ—¶</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">long</span> <span class="variable">ioStartTime</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// æ‰§è¡Œ IO æ“ä½œ</span></span><br><span class="line">                    processSelectedKeys();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// æ ¹æ® IO æ“ä½œæ¶ˆè€—çš„æ—¶é—´ï¼Œè®¡ç®—æ‰§è¡Œé IO æ“ä½œï¼ˆrunAllTasksï¼‰å¯ä»¥ç”¨å¤šå°‘æ—¶é—´.</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">ioTime</span> <span class="operator">=</span> System.nanoTime() - ioStartTime;</span><br><span class="line">                    runAllTasks(ioTime * (<span class="number">100</span> - ioRatio) / ioRatio);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            handleLoopException(t);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Always handle shutdown even if the loop processing threw an exception.</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (isShuttingDown()) &#123;</span><br><span class="line">                closeAll();</span><br><span class="line">                <span class="keyword">if</span> (confirmShutdown()) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            handleLoopException(t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢è¿™æ®µä»£ç æ˜¯ NioEventLoop çš„æ ¸å¿ƒï¼Œè¿™é‡Œä»‹ç»ä¸¤ç‚¹ï¼š</p>
<ol>
<li>é¦–å…ˆï¼Œä¼šæ ¹æ® hasTasks() çš„ç»“æœæ¥å†³å®šæ˜¯æ‰§è¡Œ selectNow() è¿˜æ˜¯ select(oldWakenUp)ï¼Œè¿™ä¸ªåº”è¯¥å¥½ç†è§£ã€‚å¦‚æœæœ‰ä»»åŠ¡æ­£åœ¨ç­‰å¾…ï¼Œé‚£ä¹ˆåº”è¯¥ä½¿ç”¨æ— é˜»å¡çš„ selectNow()ï¼Œå¦‚æœæ²¡æœ‰ä»»åŠ¡åœ¨ç­‰å¾…ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨å¸¦é˜»å¡çš„ select æ“ä½œã€‚</li>
<li>ioRatio æ§åˆ¶ IO æ“ä½œæ‰€å çš„æ—¶é—´æ¯”é‡ï¼š<ul>
<li>å¦‚æœè®¾ç½®ä¸º 100%ï¼Œé‚£ä¹ˆå…ˆæ‰§è¡Œ IO æ“ä½œï¼Œç„¶åå†æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚</li>
<li>å¦‚æœä¸æ˜¯ 100%ï¼Œé‚£ä¹ˆå…ˆæ‰§è¡Œ IO æ“ä½œï¼Œç„¶åæ‰§è¡Œ taskQueue ä¸­çš„ä»»åŠ¡ï¼Œä½†æ˜¯éœ€è¦æ§åˆ¶æ‰§è¡Œä»»åŠ¡çš„æ€»æ—¶é—´ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé IO æ“ä½œå¯ä»¥å ç”¨çš„æ—¶é—´ï¼Œé€šè¿‡ ioRatio ä»¥åŠè¿™æ¬¡ IO æ“ä½œè€—æ—¶è®¡ç®—å¾—å‡ºã€‚</li>
</ul>
</li>
</ol>
<p>æˆ‘ä»¬è¿™é‡Œå…ˆä¸è¦å»å…³å¿ƒ select(oldWakenUp)ã€processSelectedKeys() æ–¹æ³•å’Œ runAllTasks(â€¦) æ–¹æ³•çš„ç»†èŠ‚ï¼Œåªè¦å…ˆç†è§£å®ƒä»¬åˆ†åˆ«åšä»€ä¹ˆäº‹æƒ…å°±å¯ä»¥äº†ã€‚</p>
<p>å›è¿‡ç¥æ¥ï¼Œæˆ‘ä»¬å‰é¢åœ¨ register çš„æ—¶å€™æäº¤äº† register ä»»åŠ¡ç»™ NioEventLoopï¼Œè¿™æ˜¯ NioEventLoop æ¥æ”¶åˆ°çš„ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œæ‰€ä»¥è¿™é‡Œä¼šå®ä¾‹åŒ– Thread å¹¶ä¸”å¯åŠ¨ï¼Œç„¶åè¿›å…¥åˆ° NioEventLoop ä¸­çš„ run æ–¹æ³•ã€‚</p>
<h3 id="ç»§ç»­-register"><a href="#ç»§ç»­-register" class="headerlink" title="ç»§ç»­ register"></a>ç»§ç»­ register</h3><p>æˆ‘ä»¬å›åˆ°å‰é¢çš„ register0(promise) æ–¹æ³•ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œè¿™ä¸ª register ä»»åŠ¡è¿›å…¥åˆ°äº† NioEventLoop çš„ taskQueue ä¸­ï¼Œç„¶åä¼šå¯åŠ¨ NioEventLoop ä¸­çš„çº¿ç¨‹ï¼Œè¯¥çº¿ç¨‹ä¼šè½®è¯¢è¿™ä¸ª taskQueueï¼Œç„¶åæ‰§è¡Œè¿™ä¸ª register ä»»åŠ¡ã€‚</p>
<p>æ³¨æ„ï¼Œæ­¤æ—¶æ‰§è¡Œè¯¥æ–¹æ³•çš„æ˜¯ eventLoop ä¸­çš„çº¿ç¨‹ï¼š</p>
<p>// AbstractChannel</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">register0</span><span class="params">(ChannelPromise promise)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">		...</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">firstRegistration</span> <span class="operator">=</span> neverRegistered;</span><br><span class="line">        <span class="comment">// *** è¿›è¡Œ JDK åº•å±‚çš„æ“ä½œï¼šChannel æ³¨å†Œåˆ° Selector ä¸Š ***</span></span><br><span class="line">        doRegister();</span><br><span class="line">        </span><br><span class="line">        neverRegistered = <span class="literal">false</span>;</span><br><span class="line">        registered = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// åˆ°è¿™é‡Œï¼Œå°±ç®—æ˜¯ registered äº†</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è¿™ä¸€æ­¥ä¹Ÿå¾ˆå…³é”®ï¼Œå› ä¸ºè¿™æ¶‰åŠåˆ°äº† ChannelInitializer çš„ init(channel)</span></span><br><span class="line">        <span class="comment">// æˆ‘ä»¬ä¹‹å‰è¯´è¿‡ï¼Œinit æ–¹æ³•ä¼šå°† ChannelInitializer å†…éƒ¨æ·»åŠ çš„ handlers æ·»åŠ åˆ° pipeline ä¸­</span></span><br><span class="line">        pipeline.invokeHandlerAddedIfNeeded();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¾ç½®å½“å‰ promise çš„çŠ¶æ€ä¸º success</span></span><br><span class="line">        <span class="comment">//   å› ä¸ºå½“å‰ register æ–¹æ³•æ˜¯åœ¨ eventLoop ä¸­çš„çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œéœ€è¦é€šçŸ¥æäº¤ register æ“ä½œçš„çº¿ç¨‹</span></span><br><span class="line">        safeSetSuccess(promise);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å½“å‰çš„ register æ“ä½œå·²ç»æˆåŠŸï¼Œè¯¥äº‹ä»¶åº”è¯¥è¢« pipeline ä¸Š</span></span><br><span class="line">        <span class="comment">//   æ‰€æœ‰å…³å¿ƒ register äº‹ä»¶çš„ handler æ„ŸçŸ¥åˆ°ï¼Œå¾€ pipeline ä¸­æ‰”ä¸€ä¸ªäº‹ä»¶</span></span><br><span class="line">        pipeline.fireChannelRegistered();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿™é‡Œ active æŒ‡çš„æ˜¯ channel å·²ç»æ‰“å¼€</span></span><br><span class="line">        <span class="keyword">if</span> (isActive()) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœè¯¥ channel æ˜¯ç¬¬ä¸€æ¬¡æ‰§è¡Œ registerï¼Œé‚£ä¹ˆ fire ChannelActive äº‹ä»¶</span></span><br><span class="line">            <span class="keyword">if</span> (firstRegistration) &#123;</span><br><span class="line">                pipeline.fireChannelActive();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (config().isAutoRead()) &#123;</span><br><span class="line">                <span class="comment">// è¯¥ channel ä¹‹å‰å·²ç» register è¿‡äº†ï¼Œ</span></span><br><span class="line">                <span class="comment">// è¿™é‡Œè®©è¯¥ channel ç«‹é©¬å»ç›‘å¬é€šé“ä¸­çš„ OP_READ äº‹ä»¶</span></span><br><span class="line">                beginRead();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å…ˆè¯´æ‰ä¸Šé¢çš„ doRegister() æ–¹æ³•ï¼Œç„¶åå†è¯´ pipelineã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doRegister</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">selected</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// é™„ JDK ä¸­ Channel çš„ register æ–¹æ³•ï¼š</span></span><br><span class="line">            <span class="comment">// public final SelectionKey register(Selector sel, int ops, Object att) &#123;...&#125;</span></span><br><span class="line">            selectionKey = javaChannel().register(eventLoop().unwrappedSelector(), <span class="number">0</span>, <span class="built_in">this</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (CancelledKeyException e) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œåšäº† JDK åº•å±‚çš„ register æ“ä½œï¼Œå°† SocketChannel(æˆ– ServerSocketChannel) æ³¨å†Œåˆ° Selector ä¸­ï¼Œå¹¶ä¸”å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œçš„ç›‘å¬é›†åˆè®¾ç½®ä¸ºäº† <strong>0</strong>ï¼Œä¹Ÿå°±æ˜¯ä»€ä¹ˆéƒ½ä¸ç›‘å¬ã€‚</p>
<blockquote>
<p>å½“ç„¶ï¼Œä¹Ÿå°±æ„å‘³ç€ï¼Œåç»­ä¸€å®šæœ‰æŸä¸ªåœ°æ–¹ä¼šéœ€è¦ä¿®æ”¹è¿™ä¸ª selectionKey çš„ç›‘å¬é›†åˆï¼Œä¸ç„¶å•¥éƒ½å¹²ä¸äº†</p>
</blockquote>
<p>æˆ‘ä»¬é‡ç‚¹æ¥è¯´è¯´ <strong>pipeline</strong> æ“ä½œï¼Œæˆ‘ä»¬ä¹‹å‰åœ¨ä»‹ç» NioSocketChannel çš„ pipeline çš„æ—¶å€™ä»‹ç»åˆ°ï¼Œæˆ‘ä»¬çš„ pipeline ç°åœ¨é•¿è¿™ä¸ªæ ·å­ï¼š</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/netty-source/20.png" alt="20"></p>
<blockquote>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°è¿™é‡Œä¼šæŠŠ LoggingHandler å’Œ EchoClientHandler æ·»åŠ åˆ° pipelineã€‚</p>
</blockquote>
<p>æˆ‘ä»¬ç»§ç»­çœ‹ä»£ç ï¼Œregister æˆåŠŸä»¥åï¼Œæ‰§è¡Œäº†ä»¥ä¸‹æ“ä½œï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pipeline.invokeHandlerAddedIfNeeded();</span><br></pre></td></tr></table></figure>

<p>å¤§å®¶å¯ä»¥è·Ÿè¸ªä¸€ä¸‹ï¼Œè¿™ä¸€æ­¥ä¼šæ‰§è¡Œåˆ° pipeline ä¸­ ChannelInitializer å®ä¾‹çš„ handlerAdded æ–¹æ³•ï¼Œåœ¨è¿™é‡Œä¼šæ‰§è¡Œå®ƒçš„ init(context) æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handlerAdded</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (ctx.channel().isRegistered()) &#123;</span><br><span class="line">        initChannel(ctx);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åæˆ‘ä»¬çœ‹ä¸‹ initChannel(ctx)ï¼Œè¿™é‡Œç»ˆäºæ¥äº†æˆ‘ä»¬ä¹‹å‰ä»‹ç»è¿‡çš„ init(channel) æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">initChannel</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (initMap.putIfAbsent(ctx, Boolean.TRUE) == <span class="literal">null</span>) &#123; <span class="comment">// Guard against re-entrance.</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. å°†æŠŠæˆ‘ä»¬è‡ªå®šä¹‰çš„ handlers æ·»åŠ åˆ° pipeline ä¸­</span></span><br><span class="line">            initChannel((C) ctx.channel());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable cause) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 2. å°† ChannelInitializer å®ä¾‹ä» pipeline ä¸­åˆ é™¤</span></span><br><span class="line">            remove(ctx);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å‰é¢ä¹Ÿè¯´è¿‡ï¼ŒChannelInitializer çš„ init(channel) è¢«æ‰§è¡Œä»¥åï¼Œé‚£ä¹ˆå…¶å†…éƒ¨æ·»åŠ çš„ handlers ä¼šè¿›å…¥åˆ° pipeline ä¸­ï¼Œç„¶åä¸Šé¢çš„ finally å—ä¸­å°† ChannelInitializer çš„å®ä¾‹ä» pipeline ä¸­åˆ é™¤ï¼Œé‚£ä¹ˆæ­¤æ—¶ pipeline å°±ç®—å»ºç«‹èµ·æ¥äº†ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/netty-source/21.png" alt="21"></p>
<blockquote>
<p>å…¶å®è¿™é‡Œè¿˜æœ‰ä¸ªé—®é¢˜ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ ChannelInitializer ä¸­æ·»åŠ çš„æ˜¯ä¸€ä¸ª ChannelInitializer å®ä¾‹å‘¢ï¼Ÿå¤§å®¶å¯ä»¥è€ƒè™‘ä¸‹è¿™ä¸ªæƒ…å†µã€‚</p>
</blockquote>
<p>pipeline å»ºç«‹äº†ä»¥åï¼Œç„¶åæˆ‘ä»¬ç»§ç»­å¾€ä¸‹èµ°ï¼Œä¼šæ‰§è¡Œåˆ°è¿™ä¸€å¥ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pipeline.fireChannelRegistered();</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬åªè¦æ‘¸æ¸…æ¥šäº† fireChannelRegistered() æ–¹æ³•ï¼Œä»¥åç¢°åˆ°å…¶ä»–åƒ fireChannelActive()ã€fireXxx() ç­‰å°±çŸ¥é“æ€ä¹ˆå›äº‹äº†ï¼Œå®ƒä»¬éƒ½æ˜¯ç±»ä¼¼çš„ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹è¿™å¥ä»£ç ä¼šå‘ç”Ÿä»€ä¹ˆï¼š</p>
<p>// DefaultChannelPipeline</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> ChannelPipeline <span class="title function_">fireChannelRegistered</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// æ³¨æ„è¿™é‡Œçš„ä¼ å‚æ˜¯ head</span></span><br><span class="line">    AbstractChannelHandlerContext.invokeChannelRegistered(head);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¾€ pipeline ä¸­æ‰”äº†ä¸€ä¸ª <strong>channelRegistered</strong> äº‹ä»¶ï¼Œè¿™é‡Œçš„ register å±äº Inbound äº‹ä»¶ï¼Œpipeline æ¥ä¸‹æ¥è¦åšçš„å°±æ˜¯æ‰§è¡Œ pipeline ä¸­çš„ Inbound ç±»å‹çš„ handlers ä¸­çš„ channelRegistered() æ–¹æ³•ã€‚</p>
<p>ä»ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå¾€ pipeline ä¸­æ‰”å‡º channelRegistered äº‹ä»¶ä»¥åï¼Œç¬¬ä¸€ä¸ªå¤„ç†çš„ handler æ˜¯ <strong>head</strong>ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿˜æ˜¯è·Ÿç€ä»£ç èµ°ï¼Œæ­¤æ—¶æˆ‘ä»¬æ¥åˆ°äº† pipeline çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ <strong>head</strong> çš„å¤„ç†ä¸­ï¼š</p>
<p>// AbstractChannelHandlerContext</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// next æ­¤æ—¶æ˜¯ head</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">invokeChannelRegistered</span><span class="params">(<span class="keyword">final</span> AbstractChannelHandlerContext next)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">EventExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> next.executor();</span><br><span class="line">    <span class="comment">// æ‰§è¡Œ head çš„ invokeChannelRegistered()</span></span><br><span class="line">    <span class="keyword">if</span> (executor.inEventLoop()) &#123;</span><br><span class="line">        next.invokeChannelRegistered();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        executor.execute(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                next.invokeChannelRegistered();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™é‡Œä¼šå…ˆæ‰§è¡Œ head.invokeChannelRegistered() æ–¹æ³•ï¼Œè€Œä¸”æ˜¯æ”¾åˆ° NioEventLoop ä¸­çš„ taskQueue ä¸­æ‰§è¡Œçš„ï¼š</p>
<p>// AbstractChannelHandlerContext</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">invokeChannelRegistered</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (invokeHandler()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// handler() æ–¹æ³•æ­¤æ—¶ä¼šè¿”å› head</span></span><br><span class="line">            ((ChannelInboundHandler) handler()).channelRegistered(<span class="built_in">this</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            notifyHandlerException(t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        fireChannelRegistered();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å»çœ‹ head çš„ channelRegistered æ–¹æ³•ï¼š</p>
<p>// HeadContext</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRegistered</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 1. è¿™ä¸€æ­¥æ˜¯ head å¯¹äº channelRegistered äº‹ä»¶çš„å¤„ç†ã€‚æ²¡æœ‰æˆ‘ä»¬è¦å…³å¿ƒçš„</span></span><br><span class="line">    invokeHandlerAddedIfNeeded();</span><br><span class="line">    <span class="comment">// 2. å‘åä¼ æ’­ Inbound äº‹ä»¶</span></span><br><span class="line">    ctx.fireChannelRegistered();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶å head ä¼šæ‰§è¡Œ fireChannelRegister() æ–¹æ³•ï¼š</p>
<p>// AbstractChannelHandlerContext</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ChannelHandlerContext <span class="title function_">fireChannelRegistered</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œå¾ˆå…³é”®</span></span><br><span class="line">    <span class="comment">// findContextInbound() æ–¹æ³•ä¼šæ²¿ç€ pipeline æ‰¾åˆ°ä¸‹ä¸€ä¸ª Inbound ç±»å‹çš„ handler</span></span><br><span class="line">    invokeChannelRegistered(findContextInbound());</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨æ„ï¼špipeline.fireChannelRegistered() æ˜¯å°† channelRegistered äº‹ä»¶æŠ›åˆ° pipeline ä¸­ï¼Œpipeline ä¸­çš„ handlers å‡†å¤‡å¤„ç†è¯¥äº‹ä»¶ã€‚è€Œ context.fireChannelRegistered() æ˜¯ä¸€ä¸ª handler å¤„ç†å®Œäº†ä»¥åï¼Œå‘åä¼ æ’­ç»™ä¸‹ä¸€ä¸ª handlerã€‚</p>
<p>å®ƒä»¬ä¸¤ä¸ªçš„æ–¹æ³•åå­—æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯æ¥è‡ªäºä¸åŒçš„ç±»ã€‚</p>
</blockquote>
<p>findContextInbound() å°†æ‰¾åˆ°ä¸‹ä¸€ä¸ª Inbound ç±»å‹çš„ handlerï¼Œç„¶ååˆæ˜¯é‡å¤ä¸Šé¢çš„å‡ ä¸ªæ–¹æ³•ã€‚</p>
<blockquote>
<p>æˆ‘è§‰å¾—ä¸Šé¢è¿™å—ä»£ç æ²¡å¿…è¦å¤ªçº ç»“ï¼Œæ€»ä¹‹å°±æ˜¯ä» head ä¸­å¼€å§‹ï¼Œä¾æ¬¡å¾€ä¸‹å¯»æ‰¾æ‰€æœ‰ Inbound handlerï¼Œæ‰§è¡Œå…¶ channelRegistered(ctx) æ“ä½œã€‚</p>
</blockquote>
<p>è¯´äº†è¿™ä¹ˆå¤šï¼Œæˆ‘ä»¬çš„ register æ“ä½œç®—æ˜¯çœŸæ­£å®Œæˆäº†ã€‚</p>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬å›åˆ° initAndRegister è¿™ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ChannelFuture <span class="title function_">initAndRegister</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        channel = channelFactory.newChannel();</span><br><span class="line">        init(channel);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æˆ‘ä»¬ä¸Šé¢è¯´å®Œäº†è¿™è¡Œ</span></span><br><span class="line">    <span class="type">ChannelFuture</span> <span class="variable">regFuture</span> <span class="operator">=</span> config().group().register(channel);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¦‚æœåœ¨ register çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç”Ÿäº†é”™è¯¯</span></span><br><span class="line">    <span class="keyword">if</span> (regFuture.cause() != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (channel.isRegistered()) &#123;</span><br><span class="line">            channel.close();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            channel.unsafe().closeForcibly();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æºç ä¸­è¯´å¾—å¾ˆæ¸…æ¥šï¼Œå¦‚æœåˆ°è¿™é‡Œï¼Œè¯´æ˜åç»­å¯ä»¥è¿›è¡Œ connect() æˆ– bind() äº†ï¼Œå› ä¸ºä¸¤ç§æƒ…å†µï¼š</span></span><br><span class="line">    <span class="comment">// 1. å¦‚æœ register åŠ¨ä½œæ˜¯åœ¨ eventLoop ä¸­å‘èµ·çš„ï¼Œé‚£ä¹ˆåˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œregister ä¸€å®šå·²ç»å®Œæˆ</span></span><br><span class="line">    <span class="comment">// 2. å¦‚æœ register ä»»åŠ¡å·²ç»æäº¤åˆ° eventLoop ä¸­ï¼Œä¹Ÿå°±æ˜¯è¿›åˆ°äº† eventLoop ä¸­çš„ taskQueue ä¸­ï¼Œ</span></span><br><span class="line">    <span class="comment">//    ç”±äºåç»­çš„ connect æˆ– bind ä¹Ÿä¼šè¿›å…¥åˆ°åŒä¸€ä¸ª eventLoop çš„ queue ä¸­ï¼Œæ‰€ä»¥ä¸€å®šæ˜¯ä¼šå…ˆ register æˆåŠŸï¼Œæ‰ä¼šæ‰§è¡Œ connect æˆ– bind</span></span><br><span class="line">    <span class="keyword">return</span> regFuture;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬è¦çŸ¥é“ï¼Œä¸ç®¡æ˜¯æœåŠ¡ç«¯çš„ NioServerSocketChannel è¿˜æ˜¯å®¢æˆ·ç«¯çš„ NioSocketChannelï¼Œåœ¨ bind æˆ– connect æ—¶ï¼Œéƒ½ä¼šå…ˆè¿›å…¥ initAndRegister è¿™ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸Šé¢è¯´çš„é‚£äº›ï¼Œå¯¹äºä¸¤è€…éƒ½æ˜¯é€šç”¨çš„ã€‚</p>
<p>å¤§å®¶è¦è®°ä½ï¼Œregister æ“ä½œæ˜¯éå¸¸é‡è¦çš„ï¼Œè¦çŸ¥é“è¿™ä¸€æ­¥å¤§æ¦‚åšäº†å“ªäº›äº‹æƒ…ï¼Œregister æ“ä½œä»¥åï¼Œå°†è¿›å…¥åˆ° bind æˆ– connect æ“ä½œä¸­ã€‚</p>
<h2 id="connect-è¿‡ç¨‹å’Œ-bind-è¿‡ç¨‹åˆ†æ"><a href="#connect-è¿‡ç¨‹å’Œ-bind-è¿‡ç¨‹åˆ†æ" class="headerlink" title="connect è¿‡ç¨‹å’Œ bind è¿‡ç¨‹åˆ†æ"></a>connect è¿‡ç¨‹å’Œ bind è¿‡ç¨‹åˆ†æ</h2><p>ä¸Šé¢æˆ‘ä»¬ä»‹ç»çš„ register æ“ä½œéå¸¸å…³é”®ï¼Œå®ƒå»ºç«‹èµ·æ¥äº†å¾ˆå¤šçš„ä¸œè¥¿ï¼Œå®ƒæ˜¯ Netty ä¸­ NioSocketChannel å’Œ NioServerSocketChannel å¼€å§‹å·¥ä½œçš„èµ·ç‚¹ã€‚</p>
<p>è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬æ¥è¯´è¯´ register ä¹‹åçš„ connect æ“ä½œå’Œ bind æ“ä½œã€‚è¿™èŠ‚éå¸¸ç®€å•ã€‚</p>
<h3 id="connect-è¿‡ç¨‹åˆ†æ"><a href="#connect-è¿‡ç¨‹åˆ†æ" class="headerlink" title="connect è¿‡ç¨‹åˆ†æ"></a>connect è¿‡ç¨‹åˆ†æ</h3><p>å¯¹äºå®¢æˆ·ç«¯ NioSocketChannel æ¥è¯´ï¼Œå‰é¢ register å®Œæˆä»¥åï¼Œå°±è¦å¼€å§‹ connect äº†ï¼Œè¿™ä¸€æ­¥å°†è¿æ¥åˆ°æœåŠ¡ç«¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ChannelFuture <span class="title function_">doResolveAndConnect</span><span class="params">(<span class="keyword">final</span> SocketAddress remoteAddress, <span class="keyword">final</span> SocketAddress localAddress)</span> &#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œå®Œæˆäº† register æ“ä½œ</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">ChannelFuture</span> <span class="variable">regFuture</span> <span class="operator">=</span> initAndRegister();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> regFuture.channel();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™é‡Œæˆ‘ä»¬ä¸å»çº ç»“ register æ“ä½œæ˜¯å¦ isDone()</span></span><br><span class="line">    <span class="keyword">if</span> (regFuture.isDone()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!regFuture.isSuccess()) &#123;</span><br><span class="line">            <span class="keyword">return</span> regFuture;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// çœ‹è¿™é‡Œ</span></span><br><span class="line">        <span class="keyword">return</span> doResolveAndConnect0(channel, remoteAddress, localAddress, channel.newPromise());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		....</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¤§å®¶è‡ªå·±ä¸€è·¯ç‚¹è¿›å»ï¼Œæˆ‘å°±ä¸æµªè´¹ç¯‡å¹…äº†ã€‚æœ€åï¼Œæˆ‘ä»¬ä¼šæ¥åˆ° AbstractChannel çš„ connect æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ChannelFuture <span class="title function_">connect</span><span class="params">(SocketAddress remoteAddress, ChannelPromise promise)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> pipeline.connect(remoteAddress, promise);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬çœ‹åˆ°ï¼Œconnect æ“ä½œæ˜¯äº¤ç»™ pipeline æ¥æ‰§è¡Œçš„ã€‚è¿›å…¥ pipeline ä¸­ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œconnect è¿™ç§ Outbound ç±»å‹çš„æ“ä½œï¼Œæ˜¯ä» pipeline çš„ tail å¼€å§‹çš„ï¼š</p>
<blockquote>
<p>å‰é¢æˆ‘ä»¬ä»‹ç»çš„ register æ“ä½œæ˜¯ Inbound çš„ï¼Œæ˜¯ä» head å¼€å§‹çš„</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> ChannelFuture <span class="title function_">connect</span><span class="params">(SocketAddress remoteAddress, ChannelPromise promise)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> tail.connect(remoteAddress, promise);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥å°±æ˜¯ pipeline çš„æ“ä½œäº†ï¼Œä» tail å¼€å§‹ï¼Œæ‰§è¡Œ pipeline ä¸Šçš„ Outbound ç±»å‹çš„ handlers çš„ connect(â€¦) æ–¹æ³•ï¼Œé‚£ä¹ˆçœŸæ­£çš„åº•å±‚çš„ connect çš„æ“ä½œå‘ç”Ÿåœ¨å“ªé‡Œå‘¢ï¼Ÿè¿˜è®°å¾—æˆ‘ä»¬çš„ pipeline çš„å›¾å—ï¼Ÿ</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/netty-source/22.png" alt="22"></p>
<p>ä» tail å¼€å§‹å¾€å‰æ‰¾ out ç±»å‹çš„ handlersï¼Œæ¯ç»è¿‡ä¸€ä¸ª handlerï¼Œéƒ½æ‰§è¡Œé‡Œé¢çš„ connect() æ–¹æ³•ï¼Œæœ€åä¼šåˆ° head ä¸­ï¼Œå› ä¸º head ä¹Ÿæ˜¯ Outbound ç±»å‹çš„ï¼Œæˆ‘ä»¬éœ€è¦çš„ connect æ“ä½œå°±åœ¨ head ä¸­ï¼Œå®ƒä¼šè´Ÿè´£è°ƒç”¨ unsafe ä¸­æä¾›çš„ connect æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HeadContext</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">connect</span><span class="params">(</span></span><br><span class="line"><span class="params">        ChannelHandlerContext ctx,</span></span><br><span class="line"><span class="params">        SocketAddress remoteAddress, SocketAddress localAddress,</span></span><br><span class="line"><span class="params">        ChannelPromise promise)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    unsafe.connect(remoteAddress, localAddress, promise);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€çœ‹ connect åœ¨ unsafe ç±»ä¸­æ‰€è°“çš„åº•å±‚æ“ä½œï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractNioChannel.AbstractNioUnsafe</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">connect</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> SocketAddress remoteAddress, <span class="keyword">final</span> SocketAddress localAddress, <span class="keyword">final</span> ChannelPromise promise)</span> &#123;</span><br><span class="line">		......</span><br><span class="line">            </span><br><span class="line">        <span class="type">boolean</span> <span class="variable">wasActive</span> <span class="operator">=</span> isActive();</span><br><span class="line">        <span class="comment">// å¤§å®¶è‡ªå·±ç‚¹è¿›å»çœ‹ doConnect æ–¹æ³•</span></span><br><span class="line">        <span class="comment">// è¿™ä¸€æ­¥ä¼šåš JDK åº•å±‚çš„ SocketChannel connectï¼Œç„¶åè®¾ç½® interestOps ä¸º SelectionKey.OP_CONNECT</span></span><br><span class="line">        <span class="comment">// è¿”å›å€¼ä»£è¡¨æ˜¯å¦å·²ç»è¿æ¥æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">if</span> (doConnect(remoteAddress, localAddress)) &#123;</span><br><span class="line">            <span class="comment">// å¤„ç†è¿æ¥æˆåŠŸçš„æƒ…å†µ</span></span><br><span class="line">            fulfillConnectPromise(promise, wasActive);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            connectPromise = promise;</span><br><span class="line">            requestedRemoteAddress = remoteAddress;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ä¸‹é¢è¿™å—ä»£ç ï¼Œåœ¨å¤„ç†è¿æ¥è¶…æ—¶çš„æƒ…å†µï¼Œä»£ç å¾ˆç®€å•</span></span><br><span class="line">            <span class="comment">// è¿™é‡Œç”¨åˆ°äº† NioEventLoop çš„å®šæ—¶ä»»åŠ¡çš„åŠŸèƒ½ï¼Œè¿™ä¸ªæˆ‘ä»¬ä¹‹å‰ä¸€ç›´éƒ½æ²¡æœ‰ä»‹ç»è¿‡ï¼Œå› ä¸ºæˆ‘è§‰å¾—ä¹Ÿä¸å¤ªé‡è¦</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">connectTimeoutMillis</span> <span class="operator">=</span> config().getConnectTimeoutMillis();</span><br><span class="line">            <span class="keyword">if</span> (connectTimeoutMillis &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                connectTimeoutFuture = eventLoop().schedule(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                        <span class="type">ChannelPromise</span> <span class="variable">connectPromise</span> <span class="operator">=</span> AbstractNioChannel.<span class="built_in">this</span>.connectPromise;</span><br><span class="line">                        <span class="type">ConnectTimeoutException</span> <span class="variable">cause</span> <span class="operator">=</span></span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">ConnectTimeoutException</span>(<span class="string">&quot;connection timed out: &quot;</span> + remoteAddress);</span><br><span class="line">                        <span class="keyword">if</span> (connectPromise != <span class="literal">null</span> &amp;&amp; connectPromise.tryFailure(cause)) &#123;</span><br><span class="line">                            close(voidPromise());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, connectTimeoutMillis, TimeUnit.MILLISECONDS);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            promise.addListener(<span class="keyword">new</span> <span class="title class_">ChannelFutureListener</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                    <span class="keyword">if</span> (future.isCancelled()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (connectTimeoutFuture != <span class="literal">null</span>) &#123;</span><br><span class="line">                            connectTimeoutFuture.cancel(<span class="literal">false</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        connectPromise = <span class="literal">null</span>;</span><br><span class="line">                        close(voidPromise());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        promise.tryFailure(annotateConnectException(t, remoteAddress));</span><br><span class="line">        closeIfClosed();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä¸Šé¢çš„ doConnect æ–¹æ³•è¿”å› falseï¼Œé‚£ä¹ˆåç»­æ˜¯æ€ä¹ˆå¤„ç†çš„å‘¢ï¼Ÿ</p>
<p>åœ¨ä¸Šä¸€èŠ‚ä»‹ç»çš„ register æ“ä½œä¸­ï¼Œchannel å·²ç» register åˆ°äº† selector ä¸Šï¼Œåªä¸è¿‡å°† interestOps è®¾ç½®ä¸ºäº† 0ï¼Œä¹Ÿå°±æ˜¯ä»€ä¹ˆéƒ½ä¸ç›‘å¬ã€‚</p>
<p>è€Œåœ¨ä¸Šé¢çš„ doConnect æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°å®ƒåœ¨è°ƒç”¨åº•å±‚çš„ connect æ–¹æ³•åï¼Œä¼šè®¾ç½® interestOps ä¸º <code>SelectionKey.OP_CONNECT</code>ã€‚</p>
<p>å‰©ä¸‹çš„å°±æ˜¯ NioEventLoop çš„äº‹æƒ…äº†ï¼Œè¿˜è®°å¾— NioEventLoop çš„ run() æ–¹æ³•å—ï¼Ÿä¹Ÿå°±æ˜¯è¯´è¿™é‡Œçš„ connect æˆåŠŸä»¥åï¼Œè¿™ä¸ª TCP è¿æ¥å°±å»ºç«‹èµ·æ¥äº†ï¼Œåç»­çš„æ“ä½œä¼šåœ¨ <code>NioEventLoop.run()</code> æ–¹æ³•ä¸­è¢« <code>processSelectedKeys()</code> æ–¹æ³•å¤„ç†æ‰ã€‚</p>
<h3 id="bind-è¿‡ç¨‹åˆ†æ"><a href="#bind-è¿‡ç¨‹åˆ†æ" class="headerlink" title="bind è¿‡ç¨‹åˆ†æ"></a>bind è¿‡ç¨‹åˆ†æ</h3><p>è¯´å®Œ connect è¿‡ç¨‹ï¼Œæˆ‘ä»¬å†æ¥ç®€å•çœ‹ä¸‹ bind è¿‡ç¨‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ChannelFuture <span class="title function_">doBind</span><span class="params">(<span class="keyword">final</span> SocketAddress localAddress)</span> &#123;</span><br><span class="line">    <span class="comment">// **å‰é¢è¯´çš„ initAndRegister**</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">ChannelFuture</span> <span class="variable">regFuture</span> <span class="operator">=</span> initAndRegister();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">final</span> <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> regFuture.channel();</span><br><span class="line">    <span class="keyword">if</span> (regFuture.cause() != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> regFuture;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (regFuture.isDone()) &#123;</span><br><span class="line">        <span class="comment">// register åŠ¨ä½œå·²ç»å®Œæˆï¼Œé‚£ä¹ˆæ‰§è¡Œ bind æ“ä½œ</span></span><br><span class="line">        <span class="type">ChannelPromise</span> <span class="variable">promise</span> <span class="operator">=</span> channel.newPromise();</span><br><span class="line">        doBind0(regFuture, channel, localAddress, promise);</span><br><span class="line">        <span class="keyword">return</span> promise;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åä¸€ç›´å¾€é‡Œçœ‹ï¼Œä¼šçœ‹åˆ°ï¼Œbind æ“ä½œä¹Ÿæ˜¯è¦ç”± pipeline æ¥å®Œæˆçš„ï¼š</p>
<p>// AbstractChannel</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ChannelFuture <span class="title function_">bind</span><span class="params">(SocketAddress localAddress, ChannelPromise promise)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> pipeline.bind(localAddress, promise);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>bind æ“ä½œå’Œ connect ä¸€æ ·ï¼Œéƒ½æ˜¯ Outbound ç±»å‹çš„ï¼Œæ‰€ä»¥éƒ½æ˜¯ tail å¼€å§‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> ChannelFuture <span class="title function_">bind</span><span class="params">(SocketAddress localAddress, ChannelPromise promise)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> tail.bind(localAddress, promise);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åçš„ bind æ“ä½œåˆåˆ°äº† head ä¸­ï¼Œç”± head æ¥è°ƒç”¨ unsafe æä¾›çš„ bind æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bind</span><span class="params">(</span></span><br><span class="line"><span class="params">        ChannelHandlerContext ctx, SocketAddress localAddress, ChannelPromise promise)</span></span><br><span class="line">        <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    unsafe.bind(localAddress, promise);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ„Ÿå…´è¶£çš„è¯»è€…è‡ªå·±å»çœ‹ä¸€ä¸‹ unsafe ä¸­çš„ bind æ–¹æ³•ï¼Œéå¸¸ç®€å•ï¼Œbind æ“ä½œä¹Ÿä¸æ˜¯ä»€ä¹ˆå¼‚æ­¥æ–¹æ³•ï¼Œæˆ‘ä»¬å°±ä»‹ç»åˆ°è¿™é‡Œäº†ã€‚</p>
<p>æœ¬èŠ‚éå¸¸ç®€å•ï¼Œå°±æ˜¯æƒ³å’Œå¤§å®¶ä»‹ç»ä¸‹ Netty ä¸­å„ç§æ“ä½œçš„å¥—è·¯ã€‚</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://scatteredream.github.io/2018/09/12/jvm-gc-g1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/62317679?s=400&v=4">
      <meta itemprop="name" content="ç¢æ¢¦">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="scatteredream's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | scatteredream's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/09/12/jvm-gc-g1/" class="post-title-link" itemprop="url">G1 åƒåœ¾æ”¶é›†å™¨ä»‹ç»(è½¬è‡ªJavadoop)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2018-09-12 00:00:00" itemprop="dateCreated datePublished" datetime="2018-09-12T00:00:00+08:00">2018-09-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-05-08 13:31:10" itemprop="dateModified" datetime="2025-05-08T13:31:10+08:00">2025-05-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/jvm/" itemprop="url" rel="index"><span itemprop="name">jvm</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="G1"><a href="#G1" class="headerlink" title="G1"></a>G1</h1><p>ä¹‹å‰æ ¹æ® Sun çš„å†…å­˜ç®¡ç†ç™½çš®ä¹¦ä»‹ç»äº†åœ¨ HotSpot JVM åˆ†ä»£ç®—æ³•ä¸­çš„å‡ ä¸ªåƒåœ¾æ”¶é›†å™¨ï¼Œæœ¬æ–‡å°†ä»‹ç» G1 åƒåœ¾æ”¶é›†å™¨ã€‚</p>
<p>G1 çš„ä¸»è¦å…³æ³¨ç‚¹åœ¨äºè¾¾åˆ°<strong>å¯æ§çš„åœé¡¿æ—¶é—´</strong>ï¼Œåœ¨è¿™ä¸ªåŸºç¡€ä¸Šå°½å¯èƒ½æé«˜ååé‡ï¼Œè¿™ä¸€ç‚¹éå¸¸é‡è¦ã€‚</p>
<p>G1 è¢«è®¾è®¡ç”¨æ¥é•¿æœŸå–ä»£ CMS æ”¶é›†å™¨ï¼Œå’Œ CMS ç›¸åŒçš„åœ°æ–¹åœ¨äºï¼Œå®ƒä»¬éƒ½å±äºå¹¶å‘æ”¶é›†å™¨ï¼Œåœ¨å¤§éƒ¨åˆ†çš„æ”¶é›†é˜¶æ®µéƒ½ä¸éœ€è¦æŒ‚èµ·åº”ç”¨ç¨‹åºã€‚åŒºåˆ«åœ¨äºï¼ŒG1 æ²¡æœ‰ CMS çš„ç¢ç‰‡åŒ–é—®é¢˜ï¼ˆæˆ–è€…è¯´ä¸é‚£ä¹ˆä¸¥é‡ï¼‰ï¼ŒåŒæ—¶æä¾›äº†æ›´åŠ å¯æ§çš„åœé¡¿æ—¶é—´ã€‚</p>
<p>å¦‚æœä½ çš„åº”ç”¨ä½¿ç”¨äº†è¾ƒå¤§çš„å †ï¼ˆå¦‚ 6GB åŠä»¥ä¸Šï¼‰è€Œä¸”è¿˜è¦æ±‚æœ‰è¾ƒä½çš„åƒåœ¾æ”¶é›†åœé¡¿æ—¶é—´ï¼ˆå¦‚ 0.5 ç§’ï¼‰ï¼Œé‚£ä¹ˆ G1 æ˜¯ä½ ç»ä½³çš„é€‰æ‹©ï¼Œæ˜¯æ—¶å€™æ”¾å¼ƒ CMS äº†ã€‚</p>
<p><strong>é˜…è¯»å»ºè®®</strong>ï¼šæœ¬æ–‡åŠ›æ±‚ç”¨ç®€å•çš„è¯ä»‹ç»æ¸…æ¥š G1 æ”¶é›†å™¨ï¼Œä½†æ˜¯å¹¶ä¸ä¼šé‡å¤ä»‹ç»æ¯ä¸€ä¸ªç»†èŠ‚ï¼Œæ‰€ä»¥å¸Œæœ›è¯»è€…äº†è§£å…¶ä»–å‡ ä¸ªæ”¶é›†å™¨çš„å·¥ä½œè¿‡ç¨‹ï¼Œå°¤å…¶æ˜¯ CMS æ”¶é›†å™¨ã€‚</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2018/09/12/jvm-gc-g1/#more" rel="contents">
                é˜…è¯»å…¨æ–‡ &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://scatteredream.github.io/2018/09/07/spring-ioc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/62317679?s=400&v=4">
      <meta itemprop="name" content="ç¢æ¢¦">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="scatteredream's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | scatteredream's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/09/07/spring-ioc/" class="post-title-link" itemprop="url">Spring IOC å®¹å™¨æºç åˆ†æ(è½¬è‡ªJavaDoop)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2018-09-07 00:00:00" itemprop="dateCreated datePublished" datetime="2018-09-07T00:00:00+08:00">2018-09-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-04-27 13:12:18" itemprop="dateModified" datetime="2025-04-27T13:12:18+08:00">2025-04-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/spring/" itemprop="url" rel="index"><span itemprop="name">spring</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Spring æœ€é‡è¦çš„æ¦‚å¿µæ˜¯ IOC å’Œ AOPï¼Œæœ¬ç¯‡æ–‡ç« å…¶å®å°±æ˜¯è¦å¸¦é¢†å¤§å®¶æ¥åˆ†æä¸‹ Spring çš„ IOC å®¹å™¨ã€‚æ—¢ç„¶å¤§å®¶å¹³æ—¶éƒ½è¦ç”¨åˆ° Springï¼Œæ€ä¹ˆå¯ä»¥ä¸å¥½å¥½äº†è§£ Spring å‘¢ï¼Ÿé˜…è¯»æœ¬æ–‡å¹¶ä¸èƒ½è®©ä½ æˆä¸º Spring ä¸“å®¶ï¼Œä¸è¿‡ä¸€å®šæœ‰åŠ©äºå¤§å®¶ç†è§£ Spring çš„å¾ˆå¤šæ¦‚å¿µï¼Œå¸®åŠ©å¤§å®¶æ’æŸ¥åº”ç”¨ä¸­å’Œ Spring ç›¸å…³çš„ä¸€äº›é—®é¢˜ã€‚</p>
<p>æœ¬æ–‡é‡‡ç”¨çš„æºç ç‰ˆæœ¬æ˜¯ 4.3.11.RELEASEï¼Œç®—æ˜¯ 5.0.x å‰æ¯”è¾ƒæ–°çš„ç‰ˆæœ¬äº†ã€‚ä¸ºäº†é™ä½éš¾åº¦ï¼Œæœ¬æ–‡æ‰€è¯´çš„æ‰€æœ‰çš„å†…å®¹éƒ½æ˜¯åŸºäº xml çš„é…ç½®çš„æ–¹å¼ï¼Œå®é™…ä½¿ç”¨å·²ç»å¾ˆå°‘äººè¿™ä¹ˆåšäº†ï¼Œè‡³å°‘ä¸æ˜¯çº¯ xml é…ç½®ï¼Œä¸è¿‡ä»ç†è§£æºç çš„è§’åº¦æ¥çœ‹ç”¨è¿™ç§æ–¹å¼æ¥è¯´æ— ç–‘æ˜¯æœ€åˆé€‚çš„ã€‚</p>
<p>é˜…è¯»å»ºè®®ï¼šè¯»è€…è‡³å°‘éœ€è¦çŸ¥é“æ€ä¹ˆé…ç½® Springï¼Œäº†è§£ Spring ä¸­çš„å„ç§æ¦‚å¿µï¼Œå°‘éƒ¨åˆ†å†…å®¹æˆ‘è¿˜å‡è®¾è¯»è€…ä½¿ç”¨è¿‡ SpringMVCã€‚æœ¬æ–‡è¦è¯´çš„ IOC æ€»ä½“æ¥è¯´æœ‰ä¸¤å¤„åœ°æ–¹æœ€é‡è¦ï¼Œä¸€ä¸ªæ˜¯åˆ›å»º Bean å®¹å™¨ï¼Œä¸€ä¸ªæ˜¯åˆå§‹åŒ– Beanï¼Œå¦‚æœè¯»è€…è§‰å¾—ä¸€æ¬¡æ€§çœ‹å®Œæœ¬æ–‡å‹åŠ›æœ‰ç‚¹å¤§ï¼Œé‚£ä¹ˆå¯ä»¥æŒ‰è¿™ä¸ªæ€è·¯åˆ†ä¸¤æ¬¡æ¶ˆåŒ–ã€‚è¯»è€…ä¸ä¸€å®šå¯¹ Spring å®¹å™¨çš„æºç æ„Ÿå…´è¶£ï¼Œä¹Ÿè®¸é™„å½•éƒ¨åˆ†ä»‹ç»çš„çŸ¥è¯†å¯¹è¯»è€…æœ‰äº›è®¸ä½œç”¨ã€‚</p>
<p>å¸Œæœ›é€šè¿‡æœ¬æ–‡å¯ä»¥è®©è¯»è€…ä¸æƒ§æ€•é˜…è¯» Spring æºç ï¼Œä¹Ÿå¸Œæœ›å¤§å®¶èƒ½åé¦ˆè¡¨è¿°é”™è¯¯æˆ–ä¸åˆç†çš„åœ°æ–¹ã€‚</p>
<h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p>å…ˆçœ‹ä¸‹æœ€åŸºæœ¬çš„å¯åŠ¨ Spring å®¹å™¨çš„ä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;classpath:applicationfile.xml&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šä»£ç å°±å¯ä»¥åˆ©ç”¨é…ç½®æ–‡ä»¶æ¥å¯åŠ¨ä¸€ä¸ª Spring å®¹å™¨äº†ï¼Œè¯·ä½¿ç”¨ maven çš„å°ä¼™ä¼´ç›´æ¥åœ¨ dependencies ä¸­åŠ ä¸Šä»¥ä¸‹ä¾èµ–å³å¯ï¼Œä¸ªäººæ¯”è¾ƒåå¯¹é‚£äº›ä¸çŸ¥é“è¦æ·»åŠ ä»€ä¹ˆä¾èµ–ï¼Œç„¶åæŠŠ Spring çš„æ‰€æœ‰ç›¸å…³çš„ä¸œè¥¿éƒ½åŠ è¿›æ¥çš„æ–¹å¼ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;spring-context&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;<span class="number">4.3</span><span class="number">.11</span>.RELEASE&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>spring-context ä¼šè‡ªåŠ¨å°† spring-coreã€spring-beansã€spring-aopã€spring-expression è¿™å‡ ä¸ªåŸºç¡€ jar åŒ…å¸¦è¿›æ¥ã€‚</p>
</blockquote>
<p>å¤šè¯´ä¸€å¥ï¼Œå¾ˆå¤šå¼€å‘è€…å…¥é—¨å°±ç›´æ¥æ¥è§¦çš„ SpringMVCï¼Œå¯¹ Spring å…¶å®ä¸æ˜¯å¾ˆäº†è§£ï¼ŒSpring æ˜¯æ¸è¿›å¼çš„å·¥å…·ï¼Œå¹¶ä¸å…·æœ‰å¾ˆå¼ºçš„ä¾µå…¥æ€§ï¼Œå®ƒçš„æ¨¡å—ä¹Ÿåˆ’åˆ†å¾—å¾ˆåˆç†ï¼Œå³ä½¿ä½ çš„åº”ç”¨ä¸æ˜¯ web åº”ç”¨ï¼Œæˆ–è€…ä¹‹å‰å®Œå…¨æ²¡æœ‰ä½¿ç”¨åˆ° Springï¼Œè€Œä½ å°±æƒ³ç”¨ Spring çš„ä¾èµ–æ³¨å…¥è¿™ä¸ªåŠŸèƒ½ï¼Œå…¶å®å®Œå…¨æ˜¯å¯ä»¥çš„ï¼Œå®ƒçš„å¼•å…¥ä¸ä¼šå¯¹å…¶ä»–çš„ç»„ä»¶äº§ç”Ÿå†²çªã€‚</p>
<p>åºŸè¯è¯´å®Œï¼Œæˆ‘ä»¬ç»§ç»­ã€‚<code>ApplicationContext context = new ClassPathXmlApplicationContext(...)</code> å…¶å®å¾ˆå¥½ç†è§£ï¼Œä»åå­—ä¸Šå°±å¯ä»¥çŒœå‡ºä¸€äºŒï¼Œå°±æ˜¯åœ¨ ClassPath ä¸­å¯»æ‰¾ xml é…ç½®æ–‡ä»¶ï¼Œæ ¹æ® xml æ–‡ä»¶å†…å®¹æ¥æ„å»º ApplicationContextã€‚å½“ç„¶ï¼Œé™¤äº† ClassPathXmlApplicationContext ä»¥å¤–ï¼Œæˆ‘ä»¬ä¹Ÿè¿˜æœ‰å…¶ä»–æ„å»º ApplicationContext çš„æ–¹æ¡ˆå¯ä¾›é€‰æ‹©ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å¤§ä½“çš„ç»§æ‰¿ç»“æ„æ˜¯æ€ä¹ˆæ ·çš„ï¼š</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/spring-context/1.png" alt="1"></p>
<blockquote>
<p>è¯»è€…å¯ä»¥å¤§è‡´çœ‹ä¸€ä¸‹ç±»åï¼Œæºç åˆ†æçš„æ—¶å€™ä¸è‡³äºæ‰¾ä¸ç€çœ‹å“ªä¸ªç±»ï¼Œå› ä¸º Spring ä¸ºäº†é€‚åº”å„ç§ä½¿ç”¨åœºæ™¯ï¼Œæä¾›çš„å„ä¸ªæ¥å£éƒ½å¯èƒ½æœ‰å¾ˆå¤šçš„å®ç°ç±»ã€‚å¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œå°±æ˜¯æªç€ä¸€ä¸ªå®Œæ•´çš„åˆ†æ”¯çœ‹å®Œã€‚</p>
<p>å½“ç„¶ï¼Œè¯»æœ¬æ–‡çš„æ—¶å€™è¯»è€…ä¹Ÿä¸å¿…å¤ªæ‹…å¿ƒï¼Œæ¯ä¸ªä»£ç å—åˆ†æçš„æ—¶å€™ï¼Œæˆ‘éƒ½ä¼šå‘Šè¯‰è¯»è€…æˆ‘ä»¬åœ¨è¯´å“ªä¸ªç±»ç¬¬å‡ è¡Œã€‚</p>
</blockquote>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒClassPathXmlApplicationContext å…œå…œè½¬è½¬äº†å¥½ä¹…æ‰åˆ° ApplicationContext æ¥å£ï¼ŒåŒæ ·çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ç»¿é¢œè‰²çš„ <strong>FileSystemXmlApplicationContext</strong> å’Œ <strong>AnnotationConfigApplicationContext</strong> è¿™ä¸¤ä¸ªç±»ã€‚</p>
<p><strong>1ã€FileSystemXmlApplicationContext</strong> çš„æ„é€ å‡½æ•°éœ€è¦ä¸€ä¸ª xml é…ç½®æ–‡ä»¶åœ¨ç³»ç»Ÿä¸­çš„è·¯å¾„ï¼Œå…¶ä»–å’Œ ClassPathXmlApplicationContext åŸºæœ¬ä¸Šä¸€æ ·ã€‚</p>
<p><strong>2ã€AnnotationConfigApplicationContext</strong> æ˜¯åŸºäºæ³¨è§£æ¥ä½¿ç”¨çš„ï¼Œå®ƒä¸éœ€è¦é…ç½®æ–‡ä»¶ï¼Œé‡‡ç”¨ java é…ç½®ç±»å’Œå„ç§æ³¨è§£æ¥é…ç½®ï¼Œæ˜¯æ¯”è¾ƒç®€å•çš„æ–¹å¼ï¼Œä¹Ÿæ˜¯å¤§åŠ¿æ‰€è¶‹å§ã€‚</p>
<p>ä¸è¿‡æœ¬æ–‡æ—¨åœ¨å¸®åŠ©å¤§å®¶ç†è§£æ•´ä¸ªæ„å»ºæµç¨‹ï¼Œæ‰€ä»¥å†³å®šä½¿ç”¨ ClassPathXmlApplicationContext è¿›è¡Œåˆ†æã€‚</p>
<p>æˆ‘ä»¬å…ˆæ¥ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥çœ‹çœ‹æ€ä¹ˆå®ä¾‹åŒ– ApplicationContextã€‚</p>
<p>é¦–å…ˆï¼Œå®šä¹‰ä¸€ä¸ªæ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MessageService</span> &#123;</span><br><span class="line">    String <span class="title function_">getMessage</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®šä¹‰æ¥å£å®ç°ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">MessageService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨ <strong>resources</strong> ç›®å½•æ–°å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œæ–‡ä»¶åéšæ„ï¼Œé€šå¸¸å« application.xml æˆ– application-xxx.xml å°±å¯ä»¥äº†ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span> <span class="attr">default-autowire</span>=<span class="string">&quot;byName&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;messageService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.javadoop.example.MessageServiceImpl&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·‘èµ·æ¥äº†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// ç”¨æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶æ¥å¯åŠ¨ä¸€ä¸ª ApplicationContext</span></span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;classpath:application.xml&quot;</span>);</span><br><span class="line">      </span><br><span class="line">        System.out.println(<span class="string">&quot;context å¯åŠ¨æˆåŠŸ&quot;</span>);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// ä» context ä¸­å–å‡ºæˆ‘ä»¬çš„ Beanï¼Œè€Œä¸æ˜¯ç”¨ new MessageServiceImpl() è¿™ç§æ–¹å¼</span></span><br><span class="line">        <span class="type">MessageService</span> <span class="variable">messageService</span> <span class="operator">=</span> context.getBean(MessageService.class);</span><br><span class="line">        <span class="comment">// è¿™å¥å°†è¾“å‡º: hello world</span></span><br><span class="line">        System.out.println(messageService.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šä¾‹å­å¾ˆç®€å•ï¼Œä¸è¿‡ä¹Ÿå¤Ÿå¼•å‡ºæœ¬æ–‡çš„ä¸»é¢˜äº†ï¼Œå°±æ˜¯æ€ä¹ˆæ ·é€šè¿‡é…ç½®æ–‡ä»¶æ¥å¯åŠ¨ Spring çš„ ApplicationContext ï¼Ÿä¹Ÿå°±æ˜¯æˆ‘ä»¬ä»Šå¤©è¦åˆ†æçš„ IOC çš„æ ¸å¿ƒäº†ã€‚ApplicationContext å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œä¼šè´Ÿè´£åˆ›å»ºå®ä¾‹ Beanï¼Œå¾€å„ä¸ª Bean ä¸­æ³¨å…¥ä¾èµ–ç­‰ã€‚</p>
<h2 id="BeanFactory-ç®€ä»‹"><a href="#BeanFactory-ç®€ä»‹" class="headerlink" title="BeanFactory ç®€ä»‹"></a>BeanFactory ç®€ä»‹</h2><p>BeanFactoryï¼Œä»åå­—ä¸Šä¹Ÿå¾ˆå¥½ç†è§£ï¼Œç”Ÿäº§ bean çš„å·¥å‚ï¼Œå®ƒè´Ÿè´£ç”Ÿäº§å’Œç®¡ç†å„ä¸ª bean å®ä¾‹ã€‚</p>
<p>åˆå­¦è€…å¯åˆ«ä»¥ä¸ºæˆ‘ä¹‹å‰è¯´é‚£ä¹ˆå¤šå’Œ BeanFactory æ— å…³ï¼Œå‰é¢è¯´çš„ ApplicationContext å…¶å®å°±æ˜¯ä¸€ä¸ª BeanFactoryã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹å’Œ BeanFactory æ¥å£ç›¸å…³çš„ä¸»è¦çš„ç»§æ‰¿ç»“æ„ï¼š</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/spring-context/2.png" alt="2"></p>
<p>æˆ‘æƒ³ï¼Œå¤§å®¶çœ‹å®Œè¿™ä¸ªå›¾ä»¥åï¼Œå¯èƒ½å°±ä¸æ˜¯å¾ˆå¼€å¿ƒäº†ã€‚ApplicationContext å¾€ä¸‹çš„ç»§æ‰¿ç»“æ„å‰é¢ä¸€å¼ å›¾è¯´è¿‡äº†ï¼Œè¿™é‡Œå°±ä¸é‡å¤äº†ã€‚è¿™å¼ å›¾å‘¢ï¼ŒèƒŒä¸‹æ¥è‚¯å®šæ˜¯ä¸éœ€è¦çš„ï¼Œæœ‰å‡ ä¸ªé‡ç‚¹å’Œå¤§å®¶è¯´æ˜ä¸‹å°±å¥½ã€‚</p>
<ol>
<li>ApplicationContext ç»§æ‰¿äº† ListableBeanFactoryï¼Œè¿™ä¸ª Listable çš„æ„æ€å°±æ˜¯ï¼Œé€šè¿‡è¿™ä¸ªæ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥è·å–å¤šä¸ª Beanï¼Œå¤§å®¶çœ‹æºç ä¼šå‘ç°ï¼Œæœ€é¡¶å±‚ BeanFactory æ¥å£çš„æ–¹æ³•éƒ½æ˜¯è·å–å•ä¸ª Bean çš„ã€‚</li>
<li>ApplicationContext ç»§æ‰¿äº† HierarchicalBeanFactoryï¼ŒHierarchical å•è¯æœ¬èº«å·²ç»èƒ½è¯´æ˜é—®é¢˜äº†ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥åœ¨åº”ç”¨ä¸­èµ·å¤šä¸ª BeanFactoryï¼Œç„¶åå¯ä»¥å°†å„ä¸ª BeanFactory è®¾ç½®ä¸ºçˆ¶å­å…³ç³»ã€‚</li>
<li>AutowireCapableBeanFactory è¿™ä¸ªåå­—ä¸­çš„ Autowire å¤§å®¶éƒ½éå¸¸ç†Ÿæ‚‰ï¼Œå®ƒå°±æ˜¯ç”¨æ¥è‡ªåŠ¨è£…é… Bean ç”¨çš„ï¼Œä½†æ˜¯ä»”ç»†çœ‹ä¸Šå›¾ï¼ŒApplicationContext å¹¶æ²¡æœ‰ç»§æ‰¿å®ƒï¼Œä¸è¿‡ä¸ç”¨æ‹…å¿ƒï¼Œä¸ä½¿ç”¨ç»§æ‰¿ï¼Œä¸ä»£è¡¨ä¸å¯ä»¥ä½¿ç”¨ç»„åˆï¼Œå¦‚æœä½ çœ‹åˆ° ApplicationContext æ¥å£å®šä¹‰ä¸­çš„æœ€åä¸€ä¸ªæ–¹æ³• getAutowireCapableBeanFactory() å°±çŸ¥é“äº†ã€‚</li>
<li>ConfigurableListableBeanFactory ä¹Ÿæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ¥å£ï¼Œçœ‹å›¾ï¼Œç‰¹æ®Šä¹‹å¤„åœ¨äºå®ƒç»§æ‰¿äº†ç¬¬äºŒå±‚æ‰€æœ‰çš„ä¸‰ä¸ªæ¥å£ï¼Œè€Œ ApplicationContext æ²¡æœ‰ã€‚è¿™ç‚¹ä¹‹åä¼šç”¨åˆ°ã€‚</li>
<li>è¯·å…ˆä¸ç”¨èŠ±æ—¶é—´åœ¨å…¶ä»–çš„æ¥å£å’Œç±»ä¸Šï¼Œå…ˆç†è§£æˆ‘è¯´çš„è¿™å‡ ç‚¹å°±å¯ä»¥äº†ã€‚</li>
</ol>
<p>ç„¶åï¼Œè¯·è¯»è€…æ‰“å¼€ç¼–è¾‘å™¨ï¼Œç¿»ä¸€ä¸‹ BeanFactoryã€ListableBeanFactoryã€HierarchicalBeanFactoryã€AutowireCapableBeanFactoryã€ApplicationContext è¿™å‡ ä¸ªæ¥å£çš„ä»£ç ï¼Œå¤§æ¦‚çœ‹ä¸€ä¸‹å„ä¸ªæ¥å£ä¸­çš„æ–¹æ³•ï¼Œå¤§å®¶å¿ƒé‡Œè¦æœ‰åº•ï¼Œé™äºç¯‡å¹…ï¼Œæˆ‘å°±ä¸è´´ä»£ç ä»‹ç»äº†ã€‚</p>
<h2 id="å¯åŠ¨è¿‡ç¨‹åˆ†æ"><a href="#å¯åŠ¨è¿‡ç¨‹åˆ†æ" class="headerlink" title="å¯åŠ¨è¿‡ç¨‹åˆ†æ"></a>å¯åŠ¨è¿‡ç¨‹åˆ†æ</h2><p>ä¸‹é¢å°†ä¼šæ˜¯å†—é•¿çš„ä»£ç åˆ†æï¼Œè®°ä½ï¼Œä¸€å®šè¦è‡ªå·±æ‰“å¼€æºç æ¥çœ‹ï¼Œä¸ç„¶çº¯çœ‹æ˜¯å¾ˆç´¯çš„ã€‚</p>
<p>ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬è‚¯å®šè¦ä» ClassPathXmlApplicationContext çš„æ„é€ æ–¹æ³•è¯´èµ·ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassPathXmlApplicationContext</span> <span class="keyword">extends</span> <span class="title class_">AbstractXmlApplicationContext</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> Resource[] configResources;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å¦‚æœå·²ç»æœ‰ ApplicationContext å¹¶éœ€è¦é…ç½®æˆçˆ¶å­å…³ç³»ï¼Œé‚£ä¹ˆè°ƒç”¨è¿™ä¸ªæ„é€ æ–¹æ³•</span></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">ClassPathXmlApplicationContext</span><span class="params">(ApplicationContext parent)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(parent);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">ClassPathXmlApplicationContext</span><span class="params">(String[] configLocations, <span class="type">boolean</span> refresh, ApplicationContext parent)</span></span><br><span class="line">      <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">super</span>(parent);</span><br><span class="line">    <span class="comment">// æ ¹æ®æä¾›çš„è·¯å¾„ï¼Œå¤„ç†æˆé…ç½®æ–‡ä»¶æ•°ç»„(ä»¥åˆ†å·ã€é€—å·ã€ç©ºæ ¼ã€tabã€æ¢è¡Œç¬¦åˆ†å‰²)</span></span><br><span class="line">    setConfigLocations(configLocations);</span><br><span class="line">    <span class="keyword">if</span> (refresh) &#123;</span><br><span class="line">      refresh(); <span class="comment">// æ ¸å¿ƒæ–¹æ³•</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ï¼Œå°±æ˜¯ <code>refresh()</code>ï¼Œè¿™é‡Œç®€å•è¯´ä¸‹ä¸ºä»€ä¹ˆæ˜¯ refresh()ï¼Œè€Œä¸æ˜¯ init() è¿™ç§åå­—çš„æ–¹æ³•ã€‚å› ä¸º ApplicationContext å»ºç«‹èµ·æ¥ä»¥åï¼Œå…¶å®æˆ‘ä»¬æ˜¯å¯ä»¥é€šè¿‡è°ƒç”¨ refresh() è¿™ä¸ªæ–¹æ³•é‡å»ºçš„ï¼Œrefresh() ä¼šå°†åŸæ¥çš„ ApplicationContext é”€æ¯ï¼Œç„¶åå†é‡æ–°æ‰§è¡Œä¸€æ¬¡åˆå§‹åŒ–æ“ä½œã€‚</p>
<p>å¾€ä¸‹çœ‹ï¼Œrefresh() æ–¹æ³•é‡Œé¢è°ƒç”¨äº†é‚£ä¹ˆå¤šæ–¹æ³•ï¼Œå°±çŸ¥é“è‚¯å®šä¸ç®€å•äº†ï¼Œè¯·è¯»è€…å…ˆçœ‹ä¸ªå¤§æ¦‚ï¼Œç»†èŠ‚ä¹‹åä¼šè¯¦ç»†è¯´ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException &#123;</span><br><span class="line">   <span class="comment">// æ¥ä¸ªé”ï¼Œä¸ç„¶ refresh() è¿˜æ²¡ç»“æŸï¼Œä½ åˆæ¥ä¸ªå¯åŠ¨æˆ–é”€æ¯å®¹å™¨çš„æ“ä½œï¼Œé‚£ä¸å°±ä¹±å¥—äº†å˜›</span></span><br><span class="line">   <span class="keyword">synchronized</span> (<span class="built_in">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å‡†å¤‡å·¥ä½œï¼Œè®°å½•ä¸‹å®¹å™¨çš„å¯åŠ¨æ—¶é—´ã€æ ‡è®°â€œå·²å¯åŠ¨â€çŠ¶æ€ã€å¤„ç†é…ç½®æ–‡ä»¶ä¸­çš„å ä½ç¬¦</span></span><br><span class="line">      prepareRefresh();</span><br><span class="line">     </span><br><span class="line">      <span class="comment">// è¿™æ­¥æ¯”è¾ƒå…³é”®ï¼Œè¿™æ­¥å®Œæˆåï¼Œé…ç½®æ–‡ä»¶å°±ä¼šè§£ææˆä¸€ä¸ªä¸ª Bean å®šä¹‰ï¼Œæ³¨å†Œåˆ° BeanFactory ä¸­ï¼Œ</span></span><br><span class="line">      <span class="comment">// å½“ç„¶ï¼Œè¿™é‡Œè¯´çš„ Bean è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œåªæ˜¯é…ç½®ä¿¡æ¯éƒ½æå–å‡ºæ¥äº†ï¼Œ</span></span><br><span class="line">      <span class="comment">// æ³¨å†Œä¹Ÿåªæ˜¯å°†è¿™äº›ä¿¡æ¯éƒ½ä¿å­˜åˆ°äº†æ³¨å†Œä¸­å¿ƒ(è¯´åˆ°åº•æ ¸å¿ƒæ˜¯ä¸€ä¸ª beanName-&gt; beanDefinition çš„ map)</span></span><br><span class="line">      <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// è®¾ç½® BeanFactory çš„ç±»åŠ è½½å™¨ï¼Œæ·»åŠ å‡ ä¸ª BeanPostProcessorï¼Œæ‰‹åŠ¨æ³¨å†Œå‡ ä¸ªç‰¹æ®Šçš„ bean</span></span><br><span class="line">      <span class="comment">// è¿™å—å¾…ä¼šä¼šå±•å¼€è¯´</span></span><br><span class="line">      prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">// ã€è¿™é‡Œéœ€è¦çŸ¥é“ BeanFactoryPostProcessor è¿™ä¸ªçŸ¥è¯†ç‚¹ï¼ŒBean å¦‚æœå®ç°äº†æ­¤æ¥å£ï¼Œ</span></span><br><span class="line">         <span class="comment">// é‚£ä¹ˆåœ¨å®¹å™¨åˆå§‹åŒ–ä»¥åï¼ŒSpring ä¼šè´Ÿè´£è°ƒç”¨é‡Œé¢çš„ postProcessBeanFactory æ–¹æ³•ã€‚ã€‘</span></span><br><span class="line">        </span><br><span class="line">         <span class="comment">// è¿™é‡Œæ˜¯æä¾›ç»™å­ç±»çš„æ‰©å±•ç‚¹ï¼Œåˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œæ‰€æœ‰çš„ Bean éƒ½åŠ è½½ã€æ³¨å†Œå®Œæˆäº†ï¼Œä½†æ˜¯éƒ½è¿˜æ²¡æœ‰åˆå§‹åŒ–</span></span><br><span class="line">         <span class="comment">// å…·ä½“çš„å­ç±»å¯ä»¥åœ¨è¿™æ­¥çš„æ—¶å€™æ·»åŠ ä¸€äº›ç‰¹æ®Šçš„ BeanFactoryPostProcessor çš„å®ç°ç±»æˆ–åšç‚¹ä»€ä¹ˆäº‹</span></span><br><span class="line">         postProcessBeanFactory(beanFactory);</span><br><span class="line">         <span class="comment">// è°ƒç”¨ BeanFactoryPostProcessor å„ä¸ªå®ç°ç±»çš„ postProcessBeanFactory(factory) æ–¹æ³•</span></span><br><span class="line">         invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// æ³¨å†Œ BeanPostProcessor çš„å®ç°ç±»ï¼Œæ³¨æ„çœ‹å’Œ BeanFactoryPostProcessor çš„åŒºåˆ«</span></span><br><span class="line">         <span class="comment">// æ­¤æ¥å£ä¸¤ä¸ªæ–¹æ³•: postProcessBeforeInitialization å’Œ postProcessAfterInitialization</span></span><br><span class="line">         <span class="comment">// ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«åœ¨ Bean åˆå§‹åŒ–ä¹‹å‰å’Œåˆå§‹åŒ–ä¹‹åå¾—åˆ°æ‰§è¡Œã€‚æ³¨æ„ï¼Œåˆ°è¿™é‡Œ Bean è¿˜æ²¡åˆå§‹åŒ–</span></span><br><span class="line">         registerBeanPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// åˆå§‹åŒ–å½“å‰ ApplicationContext çš„ MessageSourceï¼Œå›½é™…åŒ–è¿™é‡Œå°±ä¸å±•å¼€è¯´äº†ï¼Œä¸ç„¶æ²¡å®Œæ²¡äº†äº†</span></span><br><span class="line">         initMessageSource();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// åˆå§‹åŒ–å½“å‰ ApplicationContext çš„äº‹ä»¶å¹¿æ’­å™¨ï¼Œè¿™é‡Œä¹Ÿä¸å±•å¼€äº†</span></span><br><span class="line">         initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// ä»æ–¹æ³•åå°±å¯ä»¥çŸ¥é“ï¼Œå…¸å‹çš„æ¨¡æ¿æ–¹æ³•(é’©å­æ–¹æ³•)ï¼Œ</span></span><br><span class="line">         <span class="comment">// å…·ä½“çš„å­ç±»å¯ä»¥åœ¨è¿™é‡Œåˆå§‹åŒ–ä¸€äº›ç‰¹æ®Šçš„ Beanï¼ˆåœ¨åˆå§‹åŒ– singleton beans ä¹‹å‰ï¼‰</span></span><br><span class="line">         onRefresh();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ï¼Œç›‘å¬å™¨éœ€è¦å®ç° ApplicationListener æ¥å£ã€‚è¿™ä¹Ÿä¸æ˜¯æˆ‘ä»¬çš„é‡ç‚¹ï¼Œè¿‡</span></span><br><span class="line">         registerListeners();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// é‡ç‚¹ï¼Œé‡ç‚¹ï¼Œé‡ç‚¹</span></span><br><span class="line">         <span class="comment">// åˆå§‹åŒ–æ‰€æœ‰çš„ singleton beans</span></span><br><span class="line">         <span class="comment">//ï¼ˆlazy-init çš„é™¤å¤–ï¼‰</span></span><br><span class="line">         finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// æœ€åï¼Œå¹¿æ’­äº‹ä»¶ï¼ŒApplicationContext åˆå§‹åŒ–å®Œæˆ</span></span><br><span class="line">         finishRefresh();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">         <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;Exception encountered during context initialization - &quot;</span> +</span><br><span class="line">                  <span class="string">&quot;cancelling refresh attempt: &quot;</span> + ex);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Destroy already created singletons to avoid dangling resources.</span></span><br><span class="line">         <span class="comment">// é”€æ¯å·²ç»åˆå§‹åŒ–çš„ singleton çš„ Beansï¼Œä»¥å…æœ‰äº› bean ä¼šä¸€ç›´å ç”¨èµ„æº</span></span><br><span class="line">         destroyBeans();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Reset &#x27;active&#x27; flag.</span></span><br><span class="line">         cancelRefresh(ex);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// æŠŠå¼‚å¸¸å¾€å¤–æŠ›</span></span><br><span class="line">         <span class="keyword">throw</span> ex;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">finally</span> &#123;</span><br><span class="line">         <span class="comment">// Reset common introspection caches in Spring&#x27;s core, since we</span></span><br><span class="line">         <span class="comment">// might not ever need metadata for singleton beans anymore...</span></span><br><span class="line">         resetCommonCaches();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬å¼€å§‹ä¸€æ­¥æ­¥æ¥è‚¢è§£è¿™ä¸ª refresh() æ–¹æ³•ã€‚</p>
<h3 id="åˆ›å»º-Bean-å®¹å™¨å‰çš„å‡†å¤‡å·¥ä½œ"><a href="#åˆ›å»º-Bean-å®¹å™¨å‰çš„å‡†å¤‡å·¥ä½œ" class="headerlink" title="åˆ›å»º Bean å®¹å™¨å‰çš„å‡†å¤‡å·¥ä½œ"></a>åˆ›å»º Bean å®¹å™¨å‰çš„å‡†å¤‡å·¥ä½œ</h3><p>è¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œç›´æ¥çœ‹ä»£ç ä¸­çš„å‡ ä¸ªæ³¨é‡Šå³å¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">prepareRefresh</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="comment">// è®°å½•å¯åŠ¨æ—¶é—´ï¼Œ</span></span><br><span class="line">   <span class="comment">// å°† active å±æ€§è®¾ç½®ä¸º trueï¼Œclosed å±æ€§è®¾ç½®ä¸º falseï¼Œå®ƒä»¬éƒ½æ˜¯ AtomicBoolean ç±»å‹</span></span><br><span class="line">   <span class="built_in">this</span>.startupDate = System.currentTimeMillis();</span><br><span class="line">   <span class="built_in">this</span>.closed.set(<span class="literal">false</span>);</span><br><span class="line">   <span class="built_in">this</span>.active.set(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">      logger.info(<span class="string">&quot;Refreshing &quot;</span> + <span class="built_in">this</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Initialize any placeholder property sources in the context environment</span></span><br><span class="line">   initPropertySources();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// æ ¡éªŒ xml é…ç½®æ–‡ä»¶</span></span><br><span class="line">   getEnvironment().validateRequiredProperties();</span><br><span class="line"></span><br><span class="line">   <span class="built_in">this</span>.earlyApplicationEvents = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;ApplicationEvent&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="åˆ›å»º-Bean-å®¹å™¨ï¼ŒåŠ è½½å¹¶æ³¨å†Œ-Bean"><a href="#åˆ›å»º-Bean-å®¹å™¨ï¼ŒåŠ è½½å¹¶æ³¨å†Œ-Bean" class="headerlink" title="åˆ›å»º Bean å®¹å™¨ï¼ŒåŠ è½½å¹¶æ³¨å†Œ Bean"></a>åˆ›å»º Bean å®¹å™¨ï¼ŒåŠ è½½å¹¶æ³¨å†Œ Bean</h3><p>æˆ‘ä»¬å›åˆ° refresh() æ–¹æ³•ä¸­çš„ä¸‹ä¸€è¡Œ obtainFreshBeanFactory()ã€‚</p>
<p>æ³¨æ„ï¼Œ<strong>è¿™ä¸ªæ–¹æ³•æ˜¯å…¨æ–‡æœ€é‡è¦çš„éƒ¨åˆ†ä¹‹ä¸€</strong>ï¼Œè¿™é‡Œå°†ä¼šåˆå§‹åŒ– BeanFactoryã€åŠ è½½ Beanã€æ³¨å†Œ Bean ç­‰ç­‰ã€‚</p>
<p>å½“ç„¶ï¼Œè¿™æ­¥ç»“æŸåï¼ŒBean å¹¶æ²¡æœ‰å®Œæˆåˆå§‹åŒ–ã€‚è¿™é‡ŒæŒ‡çš„æ˜¯ Bean å®ä¾‹å¹¶æœªåœ¨è¿™ä¸€æ­¥ç”Ÿæˆã€‚</p>
<p>// AbstractApplicationContext.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> ConfigurableListableBeanFactory <span class="title function_">obtainFreshBeanFactory</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="comment">// å…³é—­æ—§çš„ BeanFactory (å¦‚æœæœ‰)ï¼Œåˆ›å»ºæ–°çš„ BeanFactoryï¼ŒåŠ è½½ Bean å®šä¹‰ã€æ³¨å†Œ Bean ç­‰ç­‰</span></span><br><span class="line">   refreshBeanFactory();</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// è¿”å›åˆšåˆšåˆ›å»ºçš„ BeanFactory</span></span><br><span class="line">   <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> getBeanFactory();</span><br><span class="line">   <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;Bean factory for &quot;</span> + getDisplayName() + <span class="string">&quot;: &quot;</span> + beanFactory);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> beanFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>// AbstractRefreshableApplicationContext.java 120</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">refreshBeanFactory</span><span class="params">()</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">   <span class="comment">// å¦‚æœ ApplicationContext ä¸­å·²ç»åŠ è½½è¿‡ BeanFactory äº†ï¼Œé”€æ¯æ‰€æœ‰ Beanï¼Œå…³é—­ BeanFactory</span></span><br><span class="line">   <span class="comment">// æ³¨æ„ï¼Œåº”ç”¨ä¸­ BeanFactory æœ¬æ¥å°±æ˜¯å¯ä»¥å¤šä¸ªçš„ï¼Œè¿™é‡Œå¯ä¸æ˜¯è¯´åº”ç”¨å…¨å±€æ˜¯å¦æœ‰ BeanFactoryï¼Œè€Œæ˜¯å½“å‰</span></span><br><span class="line">   <span class="comment">// ApplicationContext æ˜¯å¦æœ‰ BeanFactory</span></span><br><span class="line">   <span class="keyword">if</span> (hasBeanFactory()) &#123;</span><br><span class="line">      destroyBeans();</span><br><span class="line">      closeBeanFactory();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// åˆå§‹åŒ–ä¸€ä¸ª DefaultListableBeanFactoryï¼Œä¸ºä»€ä¹ˆç”¨è¿™ä¸ªï¼Œæˆ‘ä»¬é©¬ä¸Šè¯´ã€‚</span></span><br><span class="line">      <span class="type">DefaultListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> createBeanFactory();</span><br><span class="line">      <span class="comment">// ç”¨äº BeanFactory çš„åºåˆ—åŒ–ï¼Œæˆ‘æƒ³ä¸éƒ¨åˆ†äººåº”è¯¥éƒ½ç”¨ä¸åˆ°</span></span><br><span class="line">      beanFactory.setSerializationId(getId());</span><br><span class="line">     </span><br><span class="line">      <span class="comment">// ä¸‹é¢è¿™ä¸¤ä¸ªæ–¹æ³•å¾ˆé‡è¦ï¼Œåˆ«è·Ÿä¸¢äº†ï¼Œå…·ä½“ç»†èŠ‚ä¹‹åè¯´</span></span><br><span class="line">      <span class="comment">// è®¾ç½® BeanFactory çš„ä¸¤ä¸ªé…ç½®å±æ€§ï¼šæ˜¯å¦å…è®¸ Bean è¦†ç›–ã€æ˜¯å¦å…è®¸å¾ªç¯å¼•ç”¨</span></span><br><span class="line">      customizeBeanFactory(beanFactory);</span><br><span class="line">     </span><br><span class="line">      <span class="comment">// åŠ è½½ Bean åˆ° BeanFactory ä¸­</span></span><br><span class="line">      loadBeanDefinitions(beanFactory);</span><br><span class="line">      <span class="keyword">synchronized</span> (<span class="built_in">this</span>.beanFactoryMonitor) &#123;</span><br><span class="line">         <span class="built_in">this</span>.beanFactory = beanFactory;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ApplicationContextException</span>(<span class="string">&quot;I/O error parsing bean definition source for &quot;</span> + getDisplayName(), ex);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>çœ‹åˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œæˆ‘è§‰å¾—è¯»è€…å°±åº”è¯¥ç«™åœ¨é«˜å¤„çœ‹ ApplicationContext äº†ï¼ŒApplicationContext ç»§æ‰¿è‡ª BeanFactoryï¼Œä½†æ˜¯å®ƒä¸åº”è¯¥è¢«ç†è§£ä¸º BeanFactory çš„å®ç°ç±»ï¼Œè€Œæ˜¯è¯´å…¶å†…éƒ¨æŒæœ‰ä¸€ä¸ªå®ä¾‹åŒ–çš„ BeanFactoryï¼ˆDefaultListableBeanFactoryï¼‰ã€‚ä»¥åæ‰€æœ‰çš„ BeanFactory ç›¸å…³çš„æ“ä½œå…¶å®æ˜¯å§”æ‰˜ç»™è¿™ä¸ªå®ä¾‹æ¥å¤„ç†çš„ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬è¯´è¯´ä¸ºä»€ä¹ˆé€‰æ‹©å®ä¾‹åŒ– <strong>DefaultListableBeanFactory</strong> ï¼Ÿå‰é¢æˆ‘ä»¬è¯´äº†æœ‰ä¸ªå¾ˆé‡è¦çš„æ¥å£ ConfigurableListableBeanFactoryï¼Œå®ƒå®ç°äº† BeanFactory ä¸‹é¢ä¸€å±‚çš„æ‰€æœ‰ä¸‰ä¸ªæ¥å£ï¼Œæˆ‘æŠŠä¹‹å‰çš„ç»§æ‰¿å›¾å†æ‹¿è¿‡æ¥å¤§å®¶å†ä»”ç»†çœ‹ä¸€ä¸‹ï¼š</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/spring-context/3.png" alt="3"></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° ConfigurableListableBeanFactory åªæœ‰ä¸€ä¸ªå®ç°ç±» DefaultListableBeanFactoryï¼Œè€Œä¸”å®ç°ç±» DefaultListableBeanFactory è¿˜é€šè¿‡å®ç°å³è¾¹çš„ AbstractAutowireCapableBeanFactory é€šåƒäº†å³è·¯ã€‚æ‰€ä»¥ç»“è®ºå°±æ˜¯ï¼Œæœ€åº•ä¸‹è¿™ä¸ªå®¶ä¼™ DefaultListableBeanFactory åŸºæœ¬ä¸Šæ˜¯æœ€ç‰›çš„ BeanFactory äº†ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¿™è¾¹ä¼šä½¿ç”¨è¿™ä¸ªç±»æ¥å®ä¾‹åŒ–çš„åŸå› ã€‚</p>
<blockquote>
<p>å¦‚æœä½ æƒ³è¦åœ¨ç¨‹åºè¿è¡Œçš„æ—¶å€™åŠ¨æ€å¾€ Spring IOC å®¹å™¨æ³¨å†Œæ–°çš„ beanï¼Œå°±ä¼šä½¿ç”¨åˆ°è¿™ä¸ªç±»ã€‚é‚£æˆ‘ä»¬æ€ä¹ˆåœ¨è¿è¡Œæ—¶è·å¾—è¿™ä¸ªå®ä¾‹å‘¢ï¼Ÿ</p>
<p>ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ ApplicationContext æ¥å£èƒ½è·å–åˆ° AutowireCapableBeanFactoryï¼Œå°±æ˜¯æœ€å³ä¸Šè§’é‚£ä¸ªï¼Œç„¶åå®ƒå‘ä¸‹è½¬å‹å°±èƒ½å¾—åˆ° DefaultListableBeanFactory äº†ã€‚</p>
<p>é‚£æ€ä¹ˆæ‹¿åˆ° ApplicationContext å®ä¾‹å‘¢ï¼Ÿå¦‚æœä½ ä¸ä¼šï¼Œè¯´æ˜ä½ æ²¡ç”¨è¿‡ Springã€‚</p>
</blockquote>
<p>åœ¨ç»§ç»­å¾€ä¸‹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ BeanDefinitionã€‚<strong>æˆ‘ä»¬è¯´ BeanFactory æ˜¯ Bean å®¹å™¨ï¼Œé‚£ä¹ˆ Bean åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</strong></p>
<p>è¿™é‡Œçš„ BeanDefinition å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„ Spring çš„ Beanï¼Œæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„å„ä¸ª Bean å…¶å®ä¼šè½¬æ¢æˆä¸€ä¸ªä¸ª BeanDefinition å­˜åœ¨äº Spring çš„ BeanFactory ä¸­ã€‚</p>
<p>æ‰€ä»¥ï¼Œå¦‚æœæœ‰äººé—®ä½  Bean æ˜¯ä»€ä¹ˆçš„æ—¶å€™ï¼Œä½ è¦çŸ¥é“ Bean åœ¨ä»£ç å±‚é¢ä¸Šå¯ä»¥ç®€å•è®¤ä¸ºæ˜¯ BeanDefinition çš„å®ä¾‹ã€‚</p>
<blockquote>
<p>BeanDefinition ä¸­ä¿å­˜äº†æˆ‘ä»¬çš„ Bean ä¿¡æ¯ï¼Œæ¯”å¦‚è¿™ä¸ª Bean æŒ‡å‘çš„æ˜¯å“ªä¸ªç±»ã€æ˜¯å¦æ˜¯å•ä¾‹çš„ã€æ˜¯å¦æ‡’åŠ è½½ã€è¿™ä¸ª Bean ä¾èµ–äº†å“ªäº› Bean ç­‰ç­‰ã€‚</p>
</blockquote>
<h4 id="BeanDefinition-æ¥å£å®šä¹‰"><a href="#BeanDefinition-æ¥å£å®šä¹‰" class="headerlink" title="BeanDefinition æ¥å£å®šä¹‰"></a>BeanDefinition æ¥å£å®šä¹‰</h4><p>æˆ‘ä»¬æ¥çœ‹ä¸‹ BeanDefinition çš„æ¥å£å®šä¹‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BeanDefinition</span> <span class="keyword">extends</span> <span class="title class_">AttributeAccessor</span>, BeanMetadataElement &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé»˜è®¤åªæä¾› sington å’Œ prototype ä¸¤ç§ï¼Œ</span></span><br><span class="line">   <span class="comment">// å¾ˆå¤šè¯»è€…å¯èƒ½çŸ¥é“è¿˜æœ‰ request, session, globalSession, application, websocket è¿™å‡ ç§ï¼Œ</span></span><br><span class="line">   <span class="comment">// ä¸è¿‡ï¼Œå®ƒä»¬å±äºåŸºäº web çš„æ‰©å±•ã€‚</span></span><br><span class="line">   <span class="type">String</span> <span class="variable">SCOPE_SINGLETON</span> <span class="operator">=</span> ConfigurableBeanFactory.SCOPE_SINGLETON;</span><br><span class="line">   <span class="type">String</span> <span class="variable">SCOPE_PROTOTYPE</span> <span class="operator">=</span> ConfigurableBeanFactory.SCOPE_PROTOTYPE;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// æ¯”è¾ƒä¸é‡è¦ï¼Œç›´æ¥è·³è¿‡å§</span></span><br><span class="line">   <span class="type">int</span> <span class="variable">ROLE_APPLICATION</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">   <span class="type">int</span> <span class="variable">ROLE_SUPPORT</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">   <span class="type">int</span> <span class="variable">ROLE_INFRASTRUCTURE</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// è®¾ç½®çˆ¶ Beanï¼Œè¿™é‡Œæ¶‰åŠåˆ° bean ç»§æ‰¿ï¼Œä¸æ˜¯ java ç»§æ‰¿ã€‚è¯·å‚è§é™„å½•çš„è¯¦ç»†ä»‹ç»</span></span><br><span class="line">   <span class="comment">// ä¸€å¥è¯å°±æ˜¯ï¼šç»§æ‰¿çˆ¶ Bean çš„é…ç½®ä¿¡æ¯è€Œå·²</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">setParentName</span><span class="params">(String parentName)</span>;</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// è·å–çˆ¶ Bean</span></span><br><span class="line">   String <span class="title function_">getParentName</span><span class="params">()</span>;</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// è®¾ç½® Bean çš„ç±»åç§°ï¼Œå°†æ¥æ˜¯è¦é€šè¿‡åå°„æ¥ç”Ÿæˆå®ä¾‹çš„</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">setBeanClassName</span><span class="params">(String beanClassName)</span>;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// è·å– Bean çš„ç±»åç§°</span></span><br><span class="line">   String <span class="title function_">getBeanClassName</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">   <span class="comment">// è®¾ç½® bean çš„ scope</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">setScope</span><span class="params">(String scope)</span>;</span><br><span class="line"></span><br><span class="line">   String <span class="title function_">getScope</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// è®¾ç½®æ˜¯å¦æ‡’åŠ è½½</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">setLazyInit</span><span class="params">(<span class="type">boolean</span> lazyInit)</span>;</span><br><span class="line">   </span><br><span class="line">   <span class="type">boolean</span> <span class="title function_">isLazyInit</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// è®¾ç½®è¯¥ Bean ä¾èµ–çš„æ‰€æœ‰çš„ Beanï¼Œæ³¨æ„ï¼Œè¿™é‡Œçš„ä¾èµ–ä¸æ˜¯æŒ‡å±æ€§ä¾èµ–(å¦‚ @Autowire æ ‡è®°çš„)ï¼Œ</span></span><br><span class="line">   <span class="comment">// æ˜¯ depends-on=&quot;&quot; å±æ€§è®¾ç½®çš„å€¼ã€‚</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">setDependsOn</span><span class="params">(String... dependsOn)</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// è¿”å›è¯¥ Bean çš„æ‰€æœ‰ä¾èµ–</span></span><br><span class="line">   String[] getDependsOn();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// è®¾ç½®è¯¥ Bean æ˜¯å¦å¯ä»¥æ³¨å…¥åˆ°å…¶ä»– Bean ä¸­ï¼Œåªå¯¹æ ¹æ®ç±»å‹æ³¨å…¥æœ‰æ•ˆï¼Œ</span></span><br><span class="line">   <span class="comment">// å¦‚æœæ ¹æ®åç§°æ³¨å…¥ï¼Œå³ä½¿è¿™è¾¹è®¾ç½®äº† falseï¼Œä¹Ÿæ˜¯å¯ä»¥çš„</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">setAutowireCandidate</span><span class="params">(<span class="type">boolean</span> autowireCandidate)</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// è¯¥ Bean æ˜¯å¦å¯ä»¥æ³¨å…¥åˆ°å…¶ä»– Bean ä¸­</span></span><br><span class="line">   <span class="type">boolean</span> <span class="title function_">isAutowireCandidate</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// ä¸»è¦çš„ã€‚åŒä¸€æ¥å£çš„å¤šä¸ªå®ç°ï¼Œå¦‚æœä¸æŒ‡å®šåå­—çš„è¯ï¼ŒSpring ä¼šä¼˜å…ˆé€‰æ‹©è®¾ç½® primary ä¸º true çš„ bean</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">setPrimary</span><span class="params">(<span class="type">boolean</span> primary)</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// æ˜¯å¦æ˜¯ primary çš„</span></span><br><span class="line">   <span class="type">boolean</span> <span class="title function_">isPrimary</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// å¦‚æœè¯¥ Bean é‡‡ç”¨å·¥å‚æ–¹æ³•ç”Ÿæˆï¼ŒæŒ‡å®šå·¥å‚åç§°ã€‚å¯¹å·¥å‚ä¸ç†Ÿæ‚‰çš„è¯»è€…ï¼Œè¯·å‚åŠ é™„å½•</span></span><br><span class="line">   <span class="comment">// ä¸€å¥è¯å°±æ˜¯ï¼šæœ‰äº›å®ä¾‹ä¸æ˜¯ç”¨åå°„ç”Ÿæˆçš„ï¼Œè€Œæ˜¯ç”¨å·¥å‚æ¨¡å¼ç”Ÿæˆçš„</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">setFactoryBeanName</span><span class="params">(String factoryBeanName)</span>;</span><br><span class="line">   <span class="comment">// è·å–å·¥å‚åç§°</span></span><br><span class="line">   String <span class="title function_">getFactoryBeanName</span><span class="params">()</span>;</span><br><span class="line">   <span class="comment">// æŒ‡å®šå·¥å‚ç±»ä¸­çš„ å·¥å‚æ–¹æ³•åç§°</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">setFactoryMethodName</span><span class="params">(String factoryMethodName)</span>;</span><br><span class="line">   <span class="comment">// è·å–å·¥å‚ç±»ä¸­çš„ å·¥å‚æ–¹æ³•åç§°</span></span><br><span class="line">   String <span class="title function_">getFactoryMethodName</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// æ„é€ å™¨å‚æ•°</span></span><br><span class="line">   ConstructorArgumentValues <span class="title function_">getConstructorArgumentValues</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Bean ä¸­çš„å±æ€§å€¼ï¼Œåé¢ç»™ bean æ³¨å…¥å±æ€§å€¼çš„æ—¶å€™ä¼šè¯´åˆ°</span></span><br><span class="line">   MutablePropertyValues <span class="title function_">getPropertyValues</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// æ˜¯å¦ singleton</span></span><br><span class="line">   <span class="type">boolean</span> <span class="title function_">isSingleton</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// æ˜¯å¦ prototype</span></span><br><span class="line">   <span class="type">boolean</span> <span class="title function_">isPrototype</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// å¦‚æœè¿™ä¸ª Bean æ˜¯è¢«è®¾ç½®ä¸º abstractï¼Œé‚£ä¹ˆä¸èƒ½å®ä¾‹åŒ–ï¼Œ</span></span><br><span class="line">   <span class="comment">// å¸¸ç”¨äºä½œä¸º çˆ¶bean ç”¨äºç»§æ‰¿ï¼Œå…¶å®ä¹Ÿå¾ˆå°‘ç”¨......</span></span><br><span class="line">   <span class="type">boolean</span> <span class="title function_">isAbstract</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">   <span class="type">int</span> <span class="title function_">getRole</span><span class="params">()</span>;</span><br><span class="line">   String <span class="title function_">getDescription</span><span class="params">()</span>;</span><br><span class="line">   String <span class="title function_">getResourceDescription</span><span class="params">()</span>;</span><br><span class="line">   BeanDefinition <span class="title function_">getOriginatingBeanDefinition</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿™ä¸ª BeanDefinition å…¶å®å·²ç»åŒ…å«å¾ˆå¤šçš„ä¿¡æ¯äº†ï¼Œæš‚æ—¶ä¸æ¸…æ¥šæ‰€æœ‰çš„æ–¹æ³•å¯¹åº”ä»€ä¹ˆä¸œè¥¿æ²¡å…³ç³»ï¼Œå¸Œæœ›çœ‹å®Œæœ¬æ–‡åè¯»è€…å¯ä»¥å½»åº•ææ¸…æ¥šé‡Œé¢çš„æ‰€æœ‰ä¸œè¥¿ã€‚</p>
<p>è¿™é‡Œæ¥å£è™½ç„¶é‚£ä¹ˆå¤šï¼Œä½†æ˜¯æ²¡æœ‰ç±»ä¼¼ getInstance() è¿™ç§æ–¹æ³•æ¥è·å–æˆ‘ä»¬å®šä¹‰çš„ç±»çš„å®ä¾‹ï¼ŒçœŸæ­£çš„æˆ‘ä»¬å®šä¹‰çš„ç±»ç”Ÿæˆçš„å®ä¾‹åˆ°å“ªé‡Œå»äº†å‘¢ï¼Ÿåˆ«ç€æ€¥ï¼Œè¿™ä¸ªè¦å¾ˆåé¢æ‰èƒ½è®²åˆ°ã€‚</p>
</blockquote>
<p>æœ‰äº† BeanDefinition çš„æ¦‚å¿µä»¥åï¼Œæˆ‘ä»¬å†å¾€ä¸‹çœ‹ refreshBeanFactory() æ–¹æ³•ä¸­çš„å‰©ä½™éƒ¨åˆ†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">customizeBeanFactory(beanFactory);</span><br><span class="line">loadBeanDefinitions(beanFactory);</span><br></pre></td></tr></table></figure>

<p>è™½ç„¶åªæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œä½†è·¯è¿˜å¾ˆé•¿å•Šã€‚ã€‚ã€‚</p>
<h4 id="customizeBeanFactory"><a href="#customizeBeanFactory" class="headerlink" title="customizeBeanFactory"></a>customizeBeanFactory</h4><p>customizeBeanFactory(beanFactory) æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯é…ç½®æ˜¯å¦å…è®¸ BeanDefinition è¦†ç›–ã€æ˜¯å¦å…è®¸å¾ªç¯å¼•ç”¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">customizeBeanFactory</span><span class="params">(DefaultListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line">   <span class="keyword">if</span> (<span class="built_in">this</span>.allowBeanDefinitionOverriding != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// æ˜¯å¦å…è®¸ Bean å®šä¹‰è¦†ç›–</span></span><br><span class="line">      beanFactory.setAllowBeanDefinitionOverriding(<span class="built_in">this</span>.allowBeanDefinitionOverriding);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (<span class="built_in">this</span>.allowCircularReferences != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// æ˜¯å¦å…è®¸ Bean é—´çš„å¾ªç¯ä¾èµ–</span></span><br><span class="line">      beanFactory.setAllowCircularReferences(<span class="built_in">this</span>.allowCircularReferences);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BeanDefinition çš„è¦†ç›–é—®é¢˜å¯èƒ½ä¼šæœ‰å¼€å‘è€…ç¢°åˆ°è¿™ä¸ªå‘ï¼Œå°±æ˜¯åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰ bean æ—¶ä½¿ç”¨äº†ç›¸åŒçš„ id æˆ– nameï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒallowBeanDefinitionOverriding å±æ€§ä¸º nullï¼Œå¦‚æœåœ¨åŒä¸€é…ç½®æ–‡ä»¶ä¸­é‡å¤äº†ï¼Œä¼šæŠ›é”™ï¼Œä½†æ˜¯å¦‚æœä¸æ˜¯åŒä¸€é…ç½®æ–‡ä»¶ä¸­ï¼Œä¼šå‘ç”Ÿè¦†ç›–ã€‚</p>
<p>å¾ªç¯å¼•ç”¨ä¹Ÿå¾ˆå¥½ç†è§£ï¼šA ä¾èµ– Bï¼Œè€Œ B ä¾èµ– Aã€‚æˆ– A ä¾èµ– Bï¼ŒB ä¾èµ– Cï¼Œè€Œ C ä¾èµ– Aã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒSpring å…è®¸å¾ªç¯ä¾èµ–ï¼Œå½“ç„¶å¦‚æœä½ åœ¨ A çš„æ„é€ æ–¹æ³•ä¸­ä¾èµ– Bï¼Œåœ¨ B çš„æ„é€ æ–¹æ³•ä¸­ä¾èµ– A æ˜¯ä¸è¡Œçš„ã€‚</p>
<p>è‡³äºè¿™ä¸¤ä¸ªå±æ€§æ€ä¹ˆé…ç½®ï¼Ÿæˆ‘åœ¨é™„å½•ä¸­è¿›è¡Œäº†ä»‹ç»ï¼Œå°¤å…¶å¯¹äºè¦†ç›–é—®é¢˜ï¼Œå¾ˆå¤šäººéƒ½å¸Œæœ›ç¦æ­¢å‡ºç° Bean è¦†ç›–ï¼Œå¯æ˜¯ Spring é»˜è®¤æ˜¯ä¸åŒæ–‡ä»¶çš„æ—¶å€™å¯ä»¥è¦†ç›–çš„ã€‚</p>
<p>ä¹‹åçš„æºç ä¸­è¿˜ä¼šå‡ºç°è¿™ä¸¤ä¸ªå±æ€§ï¼Œè¯»è€…æœ‰ä¸ªå°è±¡å°±å¯ä»¥äº†ï¼Œå®ƒä»¬ä¸æ˜¯éå¸¸é‡è¦ã€‚</p>
<h4 id="åŠ è½½-Bean-loadBeanDefinitions"><a href="#åŠ è½½-Bean-loadBeanDefinitions" class="headerlink" title="åŠ è½½ Bean: loadBeanDefinitions"></a>åŠ è½½ Bean: loadBeanDefinitions</h4><p>æ¥ä¸‹æ¥æ˜¯æœ€é‡è¦çš„ loadBeanDefinitions(beanFactory) æ–¹æ³•äº†ï¼Œè¿™ä¸ªæ–¹æ³•å°†æ ¹æ®é…ç½®ï¼ŒåŠ è½½å„ä¸ª Beanï¼Œç„¶åæ”¾åˆ° BeanFactory ä¸­ã€‚</p>
<p>è¯»å–é…ç½®çš„æ“ä½œåœ¨ XmlBeanDefinitionReader ä¸­ï¼Œå…¶è´Ÿè´£åŠ è½½é…ç½®ã€è§£æã€‚</p>
<p>// AbstractXmlApplicationContext.java 80</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ­¤æ–¹æ³•å°†é€šè¿‡ä¸€ä¸ª XmlBeanDefinitionReader å®ä¾‹æ¥åŠ è½½å„ä¸ª Beanã€‚*/</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">loadBeanDefinitions</span><span class="params">(DefaultListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException, IOException &#123;</span><br><span class="line">   <span class="comment">// ç»™è¿™ä¸ª BeanFactory å®ä¾‹åŒ–ä¸€ä¸ª XmlBeanDefinitionReader</span></span><br><span class="line">   <span class="type">XmlBeanDefinitionReader</span> <span class="variable">beanDefinitionReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XmlBeanDefinitionReader</span>(beanFactory);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Configure the bean definition reader with this context&#x27;s</span></span><br><span class="line">   <span class="comment">// resource loading environment.</span></span><br><span class="line">   beanDefinitionReader.setEnvironment(<span class="built_in">this</span>.getEnvironment());</span><br><span class="line">   beanDefinitionReader.setResourceLoader(<span class="built_in">this</span>);</span><br><span class="line">   beanDefinitionReader.setEntityResolver(<span class="keyword">new</span> <span class="title class_">ResourceEntityResolver</span>(<span class="built_in">this</span>));</span><br><span class="line"></span><br><span class="line">   <span class="comment">// åˆå§‹åŒ– BeanDefinitionReaderï¼Œå…¶å®è¿™ä¸ªæ˜¯æä¾›ç»™å­ç±»è¦†å†™çš„ï¼Œ</span></span><br><span class="line">   <span class="comment">// æˆ‘çœ‹äº†ä¸€ä¸‹ï¼Œæ²¡æœ‰ç±»è¦†å†™è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å§‘ä¸”å½“åšä¸é‡è¦å§</span></span><br><span class="line">   initBeanDefinitionReader(beanDefinitionReader);</span><br><span class="line">   <span class="comment">// é‡ç‚¹æ¥äº†ï¼Œç»§ç»­å¾€ä¸‹</span></span><br><span class="line">   loadBeanDefinitions(beanDefinitionReader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨è¿˜åœ¨è¿™ä¸ªç±»ä¸­ï¼Œæ¥ä¸‹æ¥ç”¨åˆšåˆšåˆå§‹åŒ–çš„ Reader å¼€å§‹æ¥åŠ è½½ xml é…ç½®ï¼Œè¿™å—ä»£ç è¯»è€…å¯ä»¥é€‰æ‹©æ€§è·³è¿‡ï¼Œä¸æ˜¯å¾ˆé‡è¦ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸‹é¢è¿™ä¸ªä»£ç å—ï¼Œè¯»è€…å¯ä»¥å¾ˆè½»æ¾åœ°ç•¥è¿‡ã€‚</p>
<p>// AbstractXmlApplicationContext.java 120</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">loadBeanDefinitions</span><span class="params">(XmlBeanDefinitionReader reader)</span> <span class="keyword">throws</span> BeansException, IOException &#123;</span><br><span class="line">   Resource[] configResources = getConfigResources();</span><br><span class="line">   <span class="keyword">if</span> (configResources != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// å¾€ä¸‹çœ‹</span></span><br><span class="line">      reader.loadBeanDefinitions(configResources);</span><br><span class="line">   &#125;</span><br><span class="line">   String[] configLocations = getConfigLocations();</span><br><span class="line">   <span class="keyword">if</span> (configLocations != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 2</span></span><br><span class="line">      reader.loadBeanDefinitions(configLocations);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸Šé¢è™½ç„¶æœ‰ä¸¤ä¸ªåˆ†æ”¯ï¼Œä¸è¿‡ç¬¬äºŒä¸ªåˆ†æ”¯å¾ˆå¿«é€šè¿‡è§£æè·¯å¾„è½¬æ¢ä¸º Resource ä»¥åä¹Ÿä¼šè¿›åˆ°è¿™é‡Œ</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">loadBeanDefinitions</span><span class="params">(Resource... resources)</span> <span class="keyword">throws</span> BeanDefinitionStoreException &#123;</span><br><span class="line">   Assert.notNull(resources, <span class="string">&quot;Resource array must not be null&quot;</span>);</span><br><span class="line">   <span class="type">int</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">   <span class="comment">// æ³¨æ„è¿™é‡Œæ˜¯ä¸ª for å¾ªç¯ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªæ–‡ä»¶æ˜¯ä¸€ä¸ª resource</span></span><br><span class="line">   <span class="keyword">for</span> (Resource resource : resources) &#123;</span><br><span class="line">      <span class="comment">// ç»§ç»­å¾€ä¸‹çœ‹</span></span><br><span class="line">      counter += loadBeanDefinitions(resource);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// æœ€åè¿”å› counterï¼Œè¡¨ç¤ºæ€»å…±åŠ è½½äº†å¤šå°‘çš„ BeanDefinition</span></span><br><span class="line">   <span class="keyword">return</span> counter;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// XmlBeanDefinitionReader 303</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">loadBeanDefinitions</span><span class="params">(Resource resource)</span> <span class="keyword">throws</span> BeanDefinitionStoreException &#123;</span><br><span class="line">   <span class="keyword">return</span> loadBeanDefinitions(<span class="keyword">new</span> <span class="title class_">EncodedResource</span>(resource));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// XmlBeanDefinitionReader 314</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">loadBeanDefinitions</span><span class="params">(EncodedResource encodedResource)</span> <span class="keyword">throws</span> BeanDefinitionStoreException &#123;</span><br><span class="line">   Assert.notNull(encodedResource, <span class="string">&quot;EncodedResource must not be null&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">      logger.info(<span class="string">&quot;Loading XML bean definitions from &quot;</span> + encodedResource.getResource());</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// ç”¨ä¸€ä¸ª ThreadLocal æ¥å­˜æ”¾é…ç½®æ–‡ä»¶èµ„æº</span></span><br><span class="line">   Set&lt;EncodedResource&gt; currentResources = <span class="built_in">this</span>.resourcesCurrentlyBeingLoaded.get();</span><br><span class="line">   <span class="keyword">if</span> (currentResources == <span class="literal">null</span>) &#123;</span><br><span class="line">      currentResources = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;EncodedResource&gt;(<span class="number">4</span>);</span><br><span class="line">      <span class="built_in">this</span>.resourcesCurrentlyBeingLoaded.set(currentResources);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (!currentResources.add(encodedResource)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanDefinitionStoreException</span>(</span><br><span class="line">            <span class="string">&quot;Detected cyclic loading of &quot;</span> + encodedResource + <span class="string">&quot; - check your import definitions!&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> encodedResource.getResource().getInputStream();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="type">InputSource</span> <span class="variable">inputSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputSource</span>(inputStream);</span><br><span class="line">         <span class="keyword">if</span> (encodedResource.getEncoding() != <span class="literal">null</span>) &#123;</span><br><span class="line">            inputSource.setEncoding(encodedResource.getEncoding());</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// æ ¸å¿ƒéƒ¨åˆ†æ˜¯è¿™é‡Œï¼Œå¾€ä¸‹é¢çœ‹</span></span><br><span class="line">         <span class="keyword">return</span> doLoadBeanDefinitions(inputSource, encodedResource.getResource());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">finally</span> &#123;</span><br><span class="line">         inputStream.close();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanDefinitionStoreException</span>(</span><br><span class="line">            <span class="string">&quot;IOException parsing XML document from &quot;</span> + encodedResource.getResource(), ex);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">finally</span> &#123;</span><br><span class="line">      currentResources.remove(encodedResource);</span><br><span class="line">      <span class="keyword">if</span> (currentResources.isEmpty()) &#123;</span><br><span class="line">         <span class="built_in">this</span>.resourcesCurrentlyBeingLoaded.remove();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿˜åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œç¬¬ 388 è¡Œ</span></span><br><span class="line"><span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">doLoadBeanDefinitions</span><span class="params">(InputSource inputSource, Resource resource)</span></span><br><span class="line">      <span class="keyword">throws</span> BeanDefinitionStoreException &#123;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// è¿™é‡Œå°±ä¸çœ‹äº†ï¼Œå°† xml æ–‡ä»¶è½¬æ¢ä¸º Document å¯¹è±¡</span></span><br><span class="line">      <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> doLoadDocument(inputSource, resource);</span><br><span class="line">      <span class="comment">// ç»§ç»­</span></span><br><span class="line">      <span class="keyword">return</span> registerBeanDefinitions(doc, resource);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è¿˜åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œç¬¬ 505 è¡Œ</span></span><br><span class="line"><span class="comment">// è¿”å›å€¼ï¼šè¿”å›ä»å½“å‰é…ç½®æ–‡ä»¶åŠ è½½äº†å¤šå°‘æ•°é‡çš„ Bean</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">registerBeanDefinitions</span><span class="params">(Document doc, Resource resource)</span> <span class="keyword">throws</span> BeanDefinitionStoreException &#123;</span><br><span class="line">   <span class="type">BeanDefinitionDocumentReader</span> <span class="variable">documentReader</span> <span class="operator">=</span> createBeanDefinitionDocumentReader();</span><br><span class="line">   <span class="type">int</span> <span class="variable">countBefore</span> <span class="operator">=</span> getRegistry().getBeanDefinitionCount();</span><br><span class="line">   <span class="comment">// è¿™é‡Œ</span></span><br><span class="line">   documentReader.registerBeanDefinitions(doc, createReaderContext(resource));</span><br><span class="line">   <span class="keyword">return</span> getRegistry().getBeanDefinitionCount() - countBefore;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// DefaultBeanDefinitionDocumentReader 90</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinitions</span><span class="params">(Document doc, XmlReaderContext readerContext)</span> &#123;</span><br><span class="line">   <span class="built_in">this</span>.readerContext = readerContext;</span><br><span class="line">   logger.debug(<span class="string">&quot;Loading bean definitions&quot;</span>);</span><br><span class="line">   <span class="type">Element</span> <span class="variable">root</span> <span class="operator">=</span> doc.getDocumentElement();</span><br><span class="line">   <span class="comment">// ä» xml æ ¹èŠ‚ç‚¹å¼€å§‹è§£ææ–‡ä»¶</span></span><br><span class="line">   doRegisterBeanDefinitions(root);</span><br><span class="line">&#125;         </span><br></pre></td></tr></table></figure>

<p>ç»è¿‡æ¼«é•¿çš„é“¾è·¯ï¼Œä¸€ä¸ªé…ç½®æ–‡ä»¶ç»ˆäºè½¬æ¢ä¸ºä¸€é¢— DOM æ ‘äº†ï¼Œæ³¨æ„ï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯å…¶ä¸­ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œä¸æ˜¯æ‰€æœ‰çš„ï¼Œè¯»è€…å¯ä»¥çœ‹åˆ°ä¸Šé¢æœ‰ä¸ª for å¾ªç¯çš„ã€‚ä¸‹é¢å¼€å§‹ä»æ ¹èŠ‚ç‚¹å¼€å§‹è§£æï¼š</p>
<h5 id="doRegisterBeanDefinitionsï¼š"><a href="#doRegisterBeanDefinitionsï¼š" class="headerlink" title="doRegisterBeanDefinitionsï¼š"></a>doRegisterBeanDefinitionsï¼š</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DefaultBeanDefinitionDocumentReader 116</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doRegisterBeanDefinitions</span><span class="params">(Element root)</span> &#123;</span><br><span class="line">   <span class="comment">// æˆ‘ä»¬çœ‹åå­—å°±çŸ¥é“ï¼ŒBeanDefinitionParserDelegate å¿…å®šæ˜¯ä¸€ä¸ªé‡è¦çš„ç±»ï¼Œå®ƒè´Ÿè´£è§£æ Bean å®šä¹‰ï¼Œ</span></span><br><span class="line">   <span class="comment">// è¿™é‡Œä¸ºä»€ä¹ˆè¦å®šä¹‰ä¸€ä¸ª parent? çœ‹åˆ°åé¢å°±çŸ¥é“äº†ï¼Œæ˜¯é€’å½’é—®é¢˜ï¼Œ</span></span><br><span class="line">   <span class="comment">// å› ä¸º &lt;beans /&gt; å†…éƒ¨æ˜¯å¯ä»¥å®šä¹‰ &lt;beans /&gt; çš„ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•çš„ root å…¶å®ä¸ä¸€å®šå°±æ˜¯ xml çš„æ ¹èŠ‚ç‚¹ï¼Œä¹Ÿå¯ä»¥æ˜¯åµŒå¥—åœ¨é‡Œé¢çš„ &lt;beans /&gt; èŠ‚ç‚¹ï¼Œä»æºç åˆ†æçš„è§’åº¦ï¼Œæˆ‘ä»¬å½“åšæ ¹èŠ‚ç‚¹å°±å¥½äº†</span></span><br><span class="line">   <span class="type">BeanDefinitionParserDelegate</span> <span class="variable">parent</span> <span class="operator">=</span> <span class="built_in">this</span>.delegate;</span><br><span class="line">   <span class="built_in">this</span>.delegate = createDelegate(getReaderContext(), root, parent);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (<span class="built_in">this</span>.delegate.isDefaultNamespace(root)) &#123;</span><br><span class="line">      <span class="comment">// è¿™å—è¯´çš„æ˜¯æ ¹èŠ‚ç‚¹ &lt;beans ... profile=&quot;dev&quot; /&gt; ä¸­çš„ profile æ˜¯å¦æ˜¯å½“å‰ç¯å¢ƒéœ€è¦çš„ï¼Œ</span></span><br><span class="line">      <span class="comment">// å¦‚æœå½“å‰ç¯å¢ƒé…ç½®çš„ profile ä¸åŒ…å«æ­¤ profileï¼Œé‚£å°±ç›´æ¥ return äº†ï¼Œä¸å¯¹æ­¤ &lt;beans /&gt; è§£æ</span></span><br><span class="line">      <span class="comment">// ä¸ç†Ÿæ‚‰ profile ä¸ºä½•ç‰©ï¼Œä¸ç†Ÿæ‚‰æ€ä¹ˆé…ç½® profile è¯»è€…çš„è¯·ç§»æ­¥é™„å½•åŒº</span></span><br><span class="line">      <span class="type">String</span> <span class="variable">profileSpec</span> <span class="operator">=</span> root.getAttribute(PROFILE_ATTRIBUTE);</span><br><span class="line">      <span class="keyword">if</span> (StringUtils.hasText(profileSpec)) &#123;</span><br><span class="line">         String[] specifiedProfiles = StringUtils.tokenizeToStringArray(</span><br><span class="line">               profileSpec, BeanDefinitionParserDelegate.MULTI_VALUE_ATTRIBUTE_DELIMITERS);</span><br><span class="line">         <span class="keyword">if</span> (!getReaderContext().getEnvironment().acceptsProfiles(specifiedProfiles)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">               logger.info(<span class="string">&quot;Skipped XML bean definition file due to specified profiles [&quot;</span> + profileSpec +</span><br><span class="line">                     <span class="string">&quot;] not matching: &quot;</span> + getReaderContext().getResource());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   preProcessXml(root); <span class="comment">// é’©å­</span></span><br><span class="line">   <span class="comment">// å¾€ä¸‹çœ‹</span></span><br><span class="line">   parseBeanDefinitions(root, <span class="built_in">this</span>.delegate);</span><br><span class="line">   postProcessXml(root); <span class="comment">// é’©å­</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in">this</span>.delegate = parent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>preProcessXml(root) å’Œ postProcessXml(root) æ˜¯ç»™å­ç±»ç”¨çš„é’©å­æ–¹æ³•ï¼Œé‰´äºæ²¡æœ‰è¢«ä½¿ç”¨åˆ°ï¼Œä¹Ÿä¸æ˜¯æˆ‘ä»¬çš„é‡ç‚¹ï¼Œæˆ‘ä»¬ç›´æ¥è·³è¿‡ã€‚</p>
<p>è¿™é‡Œæ¶‰åŠåˆ°äº† profile çš„é—®é¢˜ï¼Œå¯¹äºä¸äº†è§£çš„è¯»è€…ï¼Œæˆ‘åœ¨é™„å½•ä¸­å¯¹ profile åšäº†ç®€å•çš„è§£é‡Šï¼Œè¯»è€…å¯ä»¥å‚è€ƒä¸€ä¸‹ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œçœ‹æ ¸å¿ƒè§£ææ–¹æ³• parseBeanDefinitions(root, this.delegate) :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// default namespace æ¶‰åŠåˆ°çš„å°±å››ä¸ªæ ‡ç­¾ &lt;import /&gt;ã€&lt;alias /&gt;ã€&lt;bean /&gt; å’Œ &lt;beans /&gt;ï¼Œ</span></span><br><span class="line"><span class="comment">// å…¶ä»–çš„å±äº custom çš„</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">parseBeanDefinitions</span><span class="params">(Element root, BeanDefinitionParserDelegate delegate)</span> &#123;</span><br><span class="line">   <span class="keyword">if</span> (delegate.isDefaultNamespace(root)) &#123;</span><br><span class="line">      <span class="type">NodeList</span> <span class="variable">nl</span> <span class="operator">=</span> root.getChildNodes();</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">         <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> nl.item(i);</span><br><span class="line">         <span class="keyword">if</span> (node <span class="keyword">instanceof</span> Element) &#123;</span><br><span class="line">            <span class="type">Element</span> <span class="variable">ele</span> <span class="operator">=</span> (Element) node;</span><br><span class="line">            <span class="keyword">if</span> (delegate.isDefaultNamespace(ele)) &#123;</span><br><span class="line">               <span class="comment">// è§£æ default namespace ä¸‹é¢çš„å‡ ä¸ªå…ƒç´ </span></span><br><span class="line">               parseDefaultElement(ele, delegate);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">// è§£æå…¶ä»– namespace çš„å…ƒç´ </span></span><br><span class="line">               delegate.parseCustomElement(ele);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      delegate.parseCustomElement(root);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºæ¯ä¸ªé…ç½®æ¥è¯´ï¼Œåˆ†åˆ«è¿›å…¥åˆ° parseDefaultElement(ele, delegate); å’Œ delegate.parseCustomElement(ele); è¿™ä¸¤ä¸ªåˆ†æ”¯äº†ã€‚</p>
<p>parseDefaultElement(ele, delegate) ä»£è¡¨è§£æçš„èŠ‚ç‚¹æ˜¯ <code>&lt;import /&gt;</code>ã€<code>&lt;alias /&gt;</code>ã€<code>&lt;bean /&gt;</code>ã€<code>&lt;beans /&gt;</code> è¿™å‡ ä¸ªã€‚</p>
<blockquote>
<p>è¿™é‡Œçš„å››ä¸ªæ ‡ç­¾ä¹‹æ‰€ä»¥æ˜¯ <strong>default</strong> çš„ï¼Œæ˜¯å› ä¸ºå®ƒä»¬æ˜¯å¤„äºè¿™ä¸ª namespace ä¸‹å®šä¹‰çš„ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.springframework.org/schema/beans</span><br></pre></td></tr></table></figure>

<p>åˆåˆ°åˆå­¦è€…ç§‘æ™®æ—¶é—´ï¼Œä¸ç†Ÿæ‚‰ namespace çš„è¯»è€…è¯·çœ‹ä¸‹é¢è´´å‡ºæ¥çš„ xmlï¼Œè¿™é‡Œçš„ç¬¬äºŒè¡Œ <strong>xmlns</strong> å°±æ˜¯å’¯ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">            http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">          http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">default-autowire</span>=<span class="string">&quot;byName&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>è€Œå¯¹äºå…¶ä»–çš„æ ‡ç­¾ï¼Œå°†è¿›å…¥åˆ° delegate.parseCustomElement(element) è¿™ä¸ªåˆ†æ”¯ã€‚å¦‚æˆ‘ä»¬ç»å¸¸ä¼šä½¿ç”¨åˆ°çš„ <code>&lt;mvc /&gt;</code>ã€<code>&lt;task /&gt;</code>ã€<code>&lt;context /&gt;</code>ã€<code>&lt;aop /&gt;</code>ç­‰ã€‚</p>
<p>è¿™äº›å±äºæ‰©å±•ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨ä¸Šé¢è¿™äº› â€é defaultâ€œ æ ‡ç­¾ï¼Œé‚£ä¹ˆä¸Šé¢çš„ xml å¤´éƒ¨çš„åœ°æ–¹ä¹Ÿè¦å¼•å…¥ç›¸åº”çš„ namespace å’Œ .xsd æ–‡ä»¶çš„è·¯å¾„ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚åŒæ—¶ä»£ç ä¸­éœ€è¦æä¾›ç›¸åº”çš„ parser æ¥è§£æï¼Œå¦‚ MvcNamespaceHandlerã€TaskNamespaceHandlerã€ContextNamespaceHandlerã€AopNamespaceHandler ç­‰ã€‚</p>
<p>å‡å¦‚è¯»è€…æƒ³åˆ†æ <code>&lt;context:property-placeholder location=&quot;classpath:xx.properties&quot; /&gt;</code> çš„å®ç°åŸç†ï¼Œå°±åº”è¯¥åˆ° ContextNamespaceHandler ä¸­æ‰¾ç­”æ¡ˆã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:mvc</span>=<span class="string">&quot;http://www.springframework.org/schema/mvc&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">           http://www.springframework.org/schema/beans </span></span></span><br><span class="line"><span class="string"><span class="tag">           http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">           http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">           http://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">           http://www.springframework.org/schema/mvc   </span></span></span><br><span class="line"><span class="string"><span class="tag">           http://www.springframework.org/schema/mvc/spring-mvc.xsd  </span></span></span><br><span class="line"><span class="string"><span class="tag">       &quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">default-autowire</span>=<span class="string">&quot;byName&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>åŒç†ï¼Œä»¥åä½ è¦æ˜¯ç¢°åˆ° <code>&lt;dubbo /&gt;</code> è¿™ç§æ ‡ç­¾ï¼Œé‚£ä¹ˆå°±åº”è¯¥æœä¸€æœæ˜¯ä¸æ˜¯æœ‰ DubboNamespaceHandler è¿™ä¸ªå¤„ç†ç±»ã€‚</p>
</blockquote>
<p>å›è¿‡ç¥æ¥ï¼Œçœ‹çœ‹å¤„ç† default æ ‡ç­¾çš„æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">parseDefaultElement</span><span class="params">(Element ele, BeanDefinitionParserDelegate delegate)</span> &#123;</span><br><span class="line">   <span class="keyword">if</span> (delegate.nodeNameEquals(ele, IMPORT_ELEMENT)) &#123;</span><br><span class="line">      <span class="comment">// å¤„ç† &lt;import /&gt; æ ‡ç­¾</span></span><br><span class="line">      importBeanDefinitionResource(ele);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, ALIAS_ELEMENT)) &#123;</span><br><span class="line">      <span class="comment">// å¤„ç† &lt;alias /&gt; æ ‡ç­¾å®šä¹‰</span></span><br><span class="line">      <span class="comment">// &lt;alias name=&quot;fromName&quot; alias=&quot;toName&quot;/&gt;</span></span><br><span class="line">      processAliasRegistration(ele);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, BEAN_ELEMENT)) &#123;</span><br><span class="line">      <span class="comment">// å¤„ç† &lt;bean /&gt; æ ‡ç­¾å®šä¹‰ï¼Œè¿™ä¹Ÿç®—æ˜¯æˆ‘ä»¬çš„é‡ç‚¹å§</span></span><br><span class="line">      processBeanDefinition(ele, delegate);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, NESTED_BEANS_ELEMENT)) &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœç¢°åˆ°çš„æ˜¯åµŒå¥—çš„ &lt;beans /&gt; æ ‡ç­¾ï¼Œéœ€è¦é€’å½’</span></span><br><span class="line">      doRegisterBeanDefinitions(ele);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ¯ä¸ªæ ‡ç­¾éƒ½è¯´ï¼Œé‚£æˆ‘ä¸åè¡€ï¼Œä½ ä»¬éƒ½è¦åè¡€äº†ã€‚æˆ‘ä»¬æŒ‘æˆ‘ä»¬çš„é‡ç‚¹ <code>&lt;bean /&gt;</code> æ ‡ç­¾å‡ºæ¥è¯´ã€‚</p>
<h5 id="processBeanDefinition-è§£æ-bean-æ ‡ç­¾"><a href="#processBeanDefinition-è§£æ-bean-æ ‡ç­¾" class="headerlink" title="processBeanDefinition è§£æ bean æ ‡ç­¾"></a>processBeanDefinition è§£æ bean æ ‡ç­¾</h5><p>ä¸‹é¢æ˜¯ processBeanDefinition è§£æ <code>&lt;bean /&gt;</code> æ ‡ç­¾ï¼š</p>
<p>// DefaultBeanDefinitionDocumentReader 298</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">processBeanDefinition</span><span class="params">(Element ele, BeanDefinitionParserDelegate delegate)</span> &#123;</span><br><span class="line">   <span class="comment">// å°† &lt;bean /&gt; èŠ‚ç‚¹ä¸­çš„ä¿¡æ¯æå–å‡ºæ¥ï¼Œç„¶åå°è£…åˆ°ä¸€ä¸ª BeanDefinitionHolder ä¸­ï¼Œç»†èŠ‚å¾€ä¸‹çœ‹</span></span><br><span class="line">   <span class="type">BeanDefinitionHolder</span> <span class="variable">bdHolder</span> <span class="operator">=</span> delegate.parseBeanDefinitionElement(ele);</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// ä¸‹é¢çš„å‡ è¡Œå…ˆä¸è¦çœ‹ï¼Œè·³è¿‡å…ˆï¼Œè·³è¿‡å…ˆï¼Œè·³è¿‡å…ˆï¼Œåé¢ä¼šç»§ç»­è¯´çš„</span></span><br><span class="line">  </span><br><span class="line">   <span class="keyword">if</span> (bdHolder != <span class="literal">null</span>) &#123;</span><br><span class="line">      bdHolder = delegate.decorateBeanDefinitionIfRequired(ele, bdHolder);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">// Register the final decorated instance.</span></span><br><span class="line">         BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">         getReaderContext().error(<span class="string">&quot;Failed to register bean definition with name &#x27;&quot;</span> +</span><br><span class="line">               bdHolder.getBeanName() + <span class="string">&quot;&#x27;&quot;</span>, ele, ex);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Send registration event.</span></span><br><span class="line">      getReaderContext().fireComponentRegistered(<span class="keyword">new</span> <span class="title class_">BeanComponentDefinition</span>(bdHolder));</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»§ç»­å¾€ä¸‹çœ‹æ€ä¹ˆè§£æä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹ <strong><code>&lt;bean /&gt;</code></strong> æ ‡ç­¾ä¸­å¯ä»¥å®šä¹‰å“ªäº›å±æ€§ï¼š</p>
<table>
<thead>
<tr>
<th>Property</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>class</td>
<td>ç±»çš„å…¨é™å®šå</td>
</tr>
<tr>
<td>name</td>
<td>å¯æŒ‡å®š idã€name(ç”¨é€—å·ã€åˆ†å·ã€ç©ºæ ¼åˆ†éš”)</td>
</tr>
<tr>
<td>scope</td>
<td>ä½œç”¨åŸŸ</td>
</tr>
<tr>
<td>constructor arguments</td>
<td>æŒ‡å®šæ„é€ å‚æ•°</td>
</tr>
<tr>
<td>properties</td>
<td>è®¾ç½®å±æ€§çš„å€¼</td>
</tr>
<tr>
<td>autowiring mode</td>
<td>no(é»˜è®¤å€¼)ã€byNameã€byTypeã€ constructor</td>
</tr>
<tr>
<td>lazy-initialization mode</td>
<td>æ˜¯å¦æ‡’åŠ è½½(å¦‚æœè¢«éæ‡’åŠ è½½çš„beanä¾èµ–äº†é‚£ä¹ˆå…¶å®ä¹Ÿå°±ä¸èƒ½æ‡’åŠ è½½äº†)</td>
</tr>
<tr>
<td>initialization method</td>
<td>bean å±æ€§è®¾ç½®å®Œæˆåï¼Œä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•</td>
</tr>
<tr>
<td>destruction method</td>
<td>bean é”€æ¯åçš„å›è°ƒæ–¹æ³•</td>
</tr>
</tbody></table>
<p>ä¸Šé¢è¡¨æ ¼ä¸­çš„å†…å®¹æˆ‘æƒ³å¤§å®¶éƒ½éå¸¸ç†Ÿæ‚‰å§ï¼Œå¦‚æœä¸ç†Ÿæ‚‰ï¼Œé‚£å°±æ˜¯ä½ ä¸å¤Ÿäº†è§£ Spring çš„é…ç½®äº†ã€‚</p>
<p>ç®€å•åœ°è¯´å°±æ˜¯åƒä¸‹é¢è¿™æ ·å­ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;exampleBean&quot;</span> <span class="attr">name</span>=<span class="string">&quot;name1, name2, name3&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.javadoop.ExampleBean&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">scope</span>=<span class="string">&quot;singleton&quot;</span> <span class="attr">lazy-init</span>=<span class="string">&quot;true&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;init&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;cleanup&quot;</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">&lt;!-- å¯ä»¥ç”¨ä¸‹é¢ä¸‰ç§å½¢å¼æŒ‡å®šæ„é€ å‚æ•° --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">type</span>=<span class="string">&quot;int&quot;</span> <span class="attr">value</span>=<span class="string">&quot;7500000&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;years&quot;</span> <span class="attr">value</span>=<span class="string">&quot;7500000&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span> <span class="attr">value</span>=<span class="string">&quot;7500000&quot;</span>/&gt;</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">&lt;!-- property çš„å‡ ç§æƒ…å†µ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;beanOne&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;anotherExampleBean&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;beanTwo&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;yetAnotherBean&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;integerProperty&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>å½“ç„¶ï¼Œé™¤äº†ä¸Šé¢ä¸¾ä¾‹å‡ºæ¥çš„è¿™äº›ï¼Œè¿˜æœ‰ factory-beanã€factory-methodã€<code>&lt;lockup-method /&gt;</code>ã€<code>&lt;replaced-method /&gt;</code>ã€<code>&lt;meta /&gt;</code>ã€<code>&lt;qualifier /&gt;</code> è¿™å‡ ä¸ªï¼Œå¤§å®¶æ˜¯ä¸æ˜¯ç†Ÿæ‚‰å‘¢ï¼Ÿè‡ªå·±æ£€éªŒä¸€ä¸‹è‡ªå·±å¯¹ Spring ä¸­ bean çš„äº†è§£ç¨‹åº¦ã€‚</p>
<p>æœ‰äº†ä»¥ä¸Šè¿™äº›çŸ¥è¯†ä»¥åï¼Œæˆ‘ä»¬å†ç»§ç»­å¾€é‡Œçœ‹æ€ä¹ˆè§£æ bean å…ƒç´ ï¼Œæ˜¯æ€ä¹ˆè½¬æ¢åˆ° BeanDefinitionHolder çš„ã€‚</p>
<p>// BeanDefinitionParserDelegate 428</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> BeanDefinitionHolder <span class="title function_">parseBeanDefinitionElement</span><span class="params">(Element ele)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> parseBeanDefinitionElement(ele, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> BeanDefinitionHolder <span class="title function_">parseBeanDefinitionElement</span><span class="params">(Element ele, BeanDefinition containingBean)</span> &#123;</span><br><span class="line">   <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> ele.getAttribute(ID_ATTRIBUTE);</span><br><span class="line">   <span class="type">String</span> <span class="variable">nameAttr</span> <span class="operator">=</span> ele.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line"></span><br><span class="line">   List&lt;String&gt; aliases = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">      </span><br><span class="line">   <span class="comment">// å°† name å±æ€§çš„å®šä¹‰æŒ‰ç…§ â€œé€—å·ã€åˆ†å·ã€ç©ºæ ¼â€ åˆ‡åˆ†ï¼Œå½¢æˆä¸€ä¸ª åˆ«ååˆ—è¡¨æ•°ç»„ï¼Œ</span></span><br><span class="line">   <span class="comment">// å½“ç„¶ï¼Œå¦‚æœä½ ä¸å®šä¹‰ name å±æ€§çš„è¯ï¼Œå°±æ˜¯ç©ºçš„äº†</span></span><br><span class="line">   <span class="comment">// æˆ‘åœ¨é™„å½•ä¸­ç®€å•ä»‹ç»äº†ä¸€ä¸‹ id å’Œ name çš„é…ç½®ï¼Œå¤§å®¶å¯ä»¥çœ‹ä¸€çœ¼ï¼Œæœ‰ä¸ª20ç§’å°±å¯ä»¥äº†</span></span><br><span class="line">   <span class="keyword">if</span> (StringUtils.hasLength(nameAttr)) &#123;</span><br><span class="line">      String[] nameArr = StringUtils.tokenizeToStringArray(nameAttr, MULTI_VALUE_ATTRIBUTE_DELIMITERS);</span><br><span class="line">      aliases.addAll(Arrays.asList(nameArr));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="type">String</span> <span class="variable">beanName</span> <span class="operator">=</span> id;</span><br><span class="line">   <span class="comment">// å¦‚æœæ²¡æœ‰æŒ‡å®šid, é‚£ä¹ˆç”¨åˆ«ååˆ—è¡¨çš„ç¬¬ä¸€ä¸ªåå­—ä½œä¸ºbeanName</span></span><br><span class="line">   <span class="keyword">if</span> (!StringUtils.hasText(beanName) &amp;&amp; !aliases.isEmpty()) &#123;</span><br><span class="line">      beanName = aliases.remove(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">         logger.debug(<span class="string">&quot;No XML &#x27;id&#x27; specified - using &#x27;&quot;</span> + beanName +</span><br><span class="line">               <span class="string">&quot;&#x27; as bean name and &quot;</span> + aliases + <span class="string">&quot; as aliases&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (containingBean == <span class="literal">null</span>) &#123;</span><br><span class="line">      checkNameUniqueness(beanName, aliases, ele);</span><br><span class="line">   &#125;</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// æ ¹æ® &lt;bean ...&gt;...&lt;/bean&gt; ä¸­çš„é…ç½®åˆ›å»º BeanDefinitionï¼Œç„¶åæŠŠé…ç½®ä¸­çš„ä¿¡æ¯éƒ½è®¾ç½®åˆ°å®ä¾‹ä¸­,</span></span><br><span class="line">   <span class="comment">// ç»†èŠ‚åé¢ç»†è¯´ï¼Œå…ˆçŸ¥é“ä¸‹é¢è¿™è¡Œç»“æŸåï¼Œä¸€ä¸ª BeanDefinition å®ä¾‹å°±å‡ºæ¥äº†ã€‚</span></span><br><span class="line">   <span class="type">AbstractBeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> parseBeanDefinitionElement(ele, beanName, containingBean);</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// åˆ°è¿™é‡Œï¼Œæ•´ä¸ª &lt;bean /&gt; æ ‡ç­¾å°±ç®—è§£æç»“æŸäº†ï¼Œä¸€ä¸ª BeanDefinition å°±å½¢æˆäº†ã€‚</span></span><br><span class="line">   <span class="keyword">if</span> (beanDefinition != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœéƒ½æ²¡æœ‰è®¾ç½® id å’Œ nameï¼Œé‚£ä¹ˆæ­¤æ—¶çš„ beanName å°±ä¼šä¸º nullï¼Œè¿›å…¥ä¸‹é¢è¿™å—ä»£ç äº§ç”Ÿ</span></span><br><span class="line">      <span class="comment">// å¦‚æœè¯»è€…ä¸æ„Ÿå…´è¶£çš„è¯ï¼Œæˆ‘è§‰å¾—ä¸éœ€è¦å…³å¿ƒè¿™å—ä»£ç ï¼Œå¯¹æœ¬æ–‡æºç åˆ†ææ¥è¯´ï¼Œè¿™äº›ä¸œè¥¿ä¸é‡è¦</span></span><br><span class="line">      <span class="keyword">if</span> (!StringUtils.hasText(beanName)) &#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (containingBean != <span class="literal">null</span>) &#123;<span class="comment">// æŒ‰ç…§æˆ‘ä»¬çš„æ€è·¯ï¼Œè¿™é‡Œ containingBean æ˜¯ null çš„</span></span><br><span class="line">               beanName = BeanDefinitionReaderUtils.generateBeanName(</span><br><span class="line">                     beanDefinition, <span class="built_in">this</span>.readerContext.getRegistry(), <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">// å¦‚æœæˆ‘ä»¬ä¸å®šä¹‰ id å’Œ nameï¼Œé‚£ä¹ˆæˆ‘ä»¬å¼•è¨€é‡Œçš„é‚£ä¸ªä¾‹å­ï¼š</span></span><br><span class="line">               <span class="comment">//   1. beanName ä¸ºï¼šcom.javadoop.example.MessageServiceImpl#0</span></span><br><span class="line">               <span class="comment">//   2. beanClassName ä¸ºï¼šcom.javadoop.example.MessageServiceImpl</span></span><br><span class="line">              </span><br><span class="line">               beanName = <span class="built_in">this</span>.readerContext.generateBeanName(beanDefinition);</span><br><span class="line">               </span><br><span class="line">               <span class="type">String</span> <span class="variable">beanClassName</span> <span class="operator">=</span> beanDefinition.getBeanClassName();</span><br><span class="line">               <span class="keyword">if</span> (beanClassName != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">                     beanName.startsWith(beanClassName) &amp;&amp; beanName.length() &gt; beanClassName.length() &amp;&amp;</span><br><span class="line">                     !<span class="built_in">this</span>.readerContext.getRegistry().isBeanNameInUse(beanClassName)) &#123;</span><br><span class="line">                  <span class="comment">// æŠŠ beanClassName è®¾ç½®ä¸º Bean çš„åˆ«å</span></span><br><span class="line">                  aliases.add(beanClassName);</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">               logger.debug(<span class="string">&quot;Neither XML &#x27;id&#x27; nor &#x27;name&#x27; specified - &quot;</span> +</span><br><span class="line">                     <span class="string">&quot;using generated bean name [&quot;</span> + beanName + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            error(ex.getMessage(), ele);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      String[] aliasesArray = StringUtils.toStringArray(aliases);</span><br><span class="line">      <span class="comment">// è¿”å› BeanDefinitionHolder</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BeanDefinitionHolder</span>(beanDefinition, beanName, aliasesArray);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åï¼Œæˆ‘ä»¬å†çœ‹çœ‹æ€ä¹ˆæ ¹æ®é…ç½®åˆ›å»º BeanDefinition å®ä¾‹çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> AbstractBeanDefinition <span class="title function_">parseBeanDefinitionElement</span><span class="params">(</span></span><br><span class="line"><span class="params">      Element ele, String beanName, BeanDefinition containingBean)</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="built_in">this</span>.parseState.push(<span class="keyword">new</span> <span class="title class_">BeanEntry</span>(beanName));</span><br><span class="line"></span><br><span class="line">   <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">   <span class="keyword">if</span> (ele.hasAttribute(CLASS_ATTRIBUTE)) &#123;</span><br><span class="line">      className = ele.getAttribute(CLASS_ATTRIBUTE).trim();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="type">String</span> <span class="variable">parent</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">if</span> (ele.hasAttribute(PARENT_ATTRIBUTE)) &#123;</span><br><span class="line">         parent = ele.getAttribute(PARENT_ATTRIBUTE);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// åˆ›å»º BeanDefinitionï¼Œç„¶åè®¾ç½®ç±»ä¿¡æ¯è€Œå·²ï¼Œå¾ˆç®€å•ï¼Œå°±ä¸è´´ä»£ç äº†</span></span><br><span class="line">      <span class="type">AbstractBeanDefinition</span> <span class="variable">bd</span> <span class="operator">=</span> createBeanDefinition(className, parent);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// è®¾ç½® BeanDefinition çš„ä¸€å †å±æ€§ï¼Œè¿™äº›å±æ€§å®šä¹‰åœ¨ AbstractBeanDefinition ä¸­</span></span><br><span class="line">      parseBeanDefinitionAttributes(ele, beanName, containingBean, bd);</span><br><span class="line">      bd.setDescription(DomUtils.getChildElementValueByTagName(ele, DESCRIPTION_ELEMENT));</span><br><span class="line">    </span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * ä¸‹é¢çš„ä¸€å †æ˜¯è§£æ &lt;bean&gt;......&lt;/bean&gt; å†…éƒ¨çš„å­å…ƒç´ ï¼Œ</span></span><br><span class="line"><span class="comment">       * è§£æå‡ºæ¥ä»¥åçš„ä¿¡æ¯éƒ½æ”¾åˆ° bd çš„å±æ€§ä¸­</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">     </span><br><span class="line">      <span class="comment">// è§£æ &lt;meta /&gt;</span></span><br><span class="line">      parseMetaElements(ele, bd);</span><br><span class="line">      <span class="comment">// è§£æ &lt;lookup-method /&gt;</span></span><br><span class="line">      parseLookupOverrideSubElements(ele, bd.getMethodOverrides());</span><br><span class="line">      <span class="comment">// è§£æ &lt;replaced-method /&gt;</span></span><br><span class="line">      parseReplacedMethodSubElements(ele, bd.getMethodOverrides());</span><br><span class="line">    <span class="comment">// è§£æ &lt;constructor-arg /&gt;</span></span><br><span class="line">      parseConstructorArgElements(ele, bd);</span><br><span class="line">      <span class="comment">// è§£æ &lt;property /&gt;</span></span><br><span class="line">      parsePropertyElements(ele, bd);</span><br><span class="line">      <span class="comment">// è§£æ &lt;qualifier /&gt;</span></span><br><span class="line">      parseQualifierElements(ele, bd);</span><br><span class="line"></span><br><span class="line">      bd.setResource(<span class="built_in">this</span>.readerContext.getResource());</span><br><span class="line">      bd.setSource(extractSource(ele));</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> bd;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">      error(<span class="string">&quot;Bean class [&quot;</span> + className + <span class="string">&quot;] not found&quot;</span>, ele, ex);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (NoClassDefFoundError err) &#123;</span><br><span class="line">      error(<span class="string">&quot;Class that bean class [&quot;</span> + className + <span class="string">&quot;] depends on not found&quot;</span>, ele, err);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">      error(<span class="string">&quot;Unexpected failure during bean definition parsing&quot;</span>, ele, ex);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.parseState.pop();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†æ ¹æ® <code>&lt;bean /&gt;</code> é…ç½®åˆ›å»ºäº†ä¸€ä¸ª BeanDefinitionHolder å®ä¾‹ã€‚æ³¨æ„ï¼Œæ˜¯ä¸€ä¸ªã€‚</p>
<p>æˆ‘ä»¬å›åˆ°è§£æ <code>&lt;bean /&gt;</code> çš„å…¥å£æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">processBeanDefinition</span><span class="params">(Element ele, BeanDefinitionParserDelegate delegate)</span> &#123;</span><br><span class="line">   <span class="comment">// å°† &lt;bean /&gt; èŠ‚ç‚¹è½¬æ¢ä¸º BeanDefinitionHolderï¼Œå°±æ˜¯ä¸Šé¢è¯´çš„ä¸€å †</span></span><br><span class="line">   <span class="type">BeanDefinitionHolder</span> <span class="variable">bdHolder</span> <span class="operator">=</span> delegate.parseBeanDefinitionElement(ele);</span><br><span class="line">   <span class="keyword">if</span> (bdHolder != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœæœ‰è‡ªå®šä¹‰å±æ€§çš„è¯ï¼Œè¿›è¡Œç›¸åº”çš„è§£æï¼Œå…ˆå¿½ç•¥</span></span><br><span class="line">      bdHolder = delegate.decorateBeanDefinitionIfRequired(ele, bdHolder);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">// æˆ‘ä»¬æŠŠè¿™æ­¥å«åš æ³¨å†ŒBean å§</span></span><br><span class="line">         BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">         getReaderContext().error(<span class="string">&quot;Failed to register bean definition with name &#x27;&quot;</span> +</span><br><span class="line">               bdHolder.getBeanName() + <span class="string">&quot;&#x27;&quot;</span>, ele, ex);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// æ³¨å†Œå®Œæˆåï¼Œå‘é€äº‹ä»¶ï¼Œæœ¬æ–‡ä¸å±•å¼€è¯´è¿™ä¸ª</span></span><br><span class="line">      getReaderContext().fireComponentRegistered(<span class="keyword">new</span> <span class="title class_">BeanComponentDefinition</span>(bdHolder));</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¤§å®¶å†ä»”ç»†çœ‹ä¸€ä¸‹è¿™å—å§ï¼Œæˆ‘ä»¬åé¢å°±ä¸å›æ¥è¯´è¿™ä¸ªäº†ã€‚è¿™é‡Œå·²ç»æ ¹æ®ä¸€ä¸ª <code>&lt;bean /&gt;</code> æ ‡ç­¾äº§ç”Ÿäº†ä¸€ä¸ª BeanDefinitionHolder çš„å®ä¾‹ï¼Œè¿™ä¸ªå®ä¾‹é‡Œé¢ä¹Ÿå°±æ˜¯ä¸€ä¸ª BeanDefinition çš„å®ä¾‹å’Œå®ƒçš„ beanNameã€aliases è¿™ä¸‰ä¸ªä¿¡æ¯ï¼Œæ³¨æ„ï¼Œæˆ‘ä»¬çš„å…³æ³¨ç‚¹å§‹ç»ˆåœ¨ BeanDefinition ä¸Šï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeanDefinitionHolder</span> <span class="keyword">implements</span> <span class="title class_">BeanMetadataElement</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> BeanDefinition beanDefinition;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String beanName;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String[] aliases;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>ç„¶åæˆ‘ä»¬å‡†å¤‡æ³¨å†Œè¿™ä¸ª BeanDefinitionï¼Œæœ€åï¼ŒæŠŠè¿™ä¸ªæ³¨å†Œäº‹ä»¶å‘é€å‡ºå»ã€‚</p>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬å¼€å§‹è¯´è¯´æ³¨å†Œ Bean å§ã€‚</p>
<h5 id="æ³¨å†Œ-Bean"><a href="#æ³¨å†Œ-Bean" class="headerlink" title="æ³¨å†Œ Bean"></a>æ³¨å†Œ Bean</h5><p>// BeanDefinitionReaderUtils 143</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinition</span><span class="params">(</span></span><br><span class="line"><span class="params">      BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry)</span></span><br><span class="line">      <span class="keyword">throws</span> BeanDefinitionStoreException &#123;</span><br><span class="line"></span><br><span class="line">   <span class="type">String</span> <span class="variable">beanName</span> <span class="operator">=</span> definitionHolder.getBeanName();</span><br><span class="line">   <span class="comment">// æ³¨å†Œè¿™ä¸ª Bean</span></span><br><span class="line">   registry.registerBeanDefinition(beanName, definitionHolder.getBeanDefinition());</span><br><span class="line"></span><br><span class="line">   <span class="comment">// å¦‚æœè¿˜æœ‰åˆ«åçš„è¯ï¼Œä¹Ÿè¦æ ¹æ®åˆ«åå…¨éƒ¨æ³¨å†Œä¸€éï¼Œä¸ç„¶æ ¹æ®åˆ«åå°±ä¼šæ‰¾ä¸åˆ° Bean äº†</span></span><br><span class="line">   String[] aliases = definitionHolder.getAliases();</span><br><span class="line">   <span class="keyword">if</span> (aliases != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (String alias : aliases) &#123;</span><br><span class="line">         <span class="comment">// alias -&gt; beanName ä¿å­˜å®ƒä»¬çš„åˆ«åä¿¡æ¯ï¼Œè¿™ä¸ªå¾ˆç®€å•ï¼Œç”¨ä¸€ä¸ª map ä¿å­˜ä¸€ä¸‹å°±å¯ä»¥äº†ï¼Œ</span></span><br><span class="line">         <span class="comment">// è·å–çš„æ—¶å€™ï¼Œä¼šå…ˆå°† alias è½¬æ¢ä¸º beanNameï¼Œç„¶åå†æŸ¥æ‰¾</span></span><br><span class="line">         registry.registerAlias(beanName, alias);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ«åæ³¨å†Œçš„æ”¾ä¸€è¾¹ï¼Œæ¯•ç«Ÿå®ƒå¾ˆç®€å•ï¼Œæˆ‘ä»¬çœ‹çœ‹æ€ä¹ˆæ³¨å†Œ Beanã€‚</p>
<p>// DefaultListableBeanFactory 793</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinition</span><span class="params">(String beanName, BeanDefinition beanDefinition)</span></span><br><span class="line">      <span class="keyword">throws</span> BeanDefinitionStoreException &#123;</span><br><span class="line"></span><br><span class="line">   Assert.hasText(beanName, <span class="string">&quot;Bean name must not be empty&quot;</span>);</span><br><span class="line">   Assert.notNull(beanDefinition, <span class="string">&quot;BeanDefinition must not be null&quot;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (beanDefinition <span class="keyword">instanceof</span> AbstractBeanDefinition) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         ((AbstractBeanDefinition) beanDefinition).validate();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanDefinitionStoreException</span>(...);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// old? è¿˜è®°å¾— â€œå…è®¸ bean è¦†ç›–â€ è¿™ä¸ªé…ç½®å—ï¼ŸallowBeanDefinitionOverriding</span></span><br><span class="line">   BeanDefinition oldBeanDefinition;</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// ä¹‹åä¼šçœ‹åˆ°ï¼Œæ‰€æœ‰çš„ Bean æ³¨å†Œåä¼šæ”¾å…¥è¿™ä¸ª beanDefinitionMap ä¸­</span></span><br><span class="line">   oldBeanDefinition = <span class="built_in">this</span>.beanDefinitionMap.get(beanName);</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// å¤„ç†é‡å¤åç§°çš„ Bean å®šä¹‰çš„æƒ…å†µ</span></span><br><span class="line">   <span class="keyword">if</span> (oldBeanDefinition != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!isAllowBeanDefinitionOverriding()) &#123;</span><br><span class="line">         <span class="comment">// å¦‚æœä¸å…è®¸è¦†ç›–çš„è¯ï¼ŒæŠ›å¼‚å¸¸</span></span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanDefinitionStoreException</span>(beanDefinition.getResourceDescription()...</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (oldBeanDefinition.getRole() &lt; beanDefinition.getRole()) &#123;</span><br><span class="line">         <span class="comment">// log...ç”¨æ¡†æ¶å®šä¹‰çš„ Bean è¦†ç›–ç”¨æˆ·è‡ªå®šä¹‰çš„ Bean </span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (!beanDefinition.equals(oldBeanDefinition)) &#123;</span><br><span class="line">         <span class="comment">// log...ç”¨æ–°çš„ Bean è¦†ç›–æ—§çš„ Bean</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="comment">// log...ç”¨åŒç­‰çš„ Bean è¦†ç›–æ—§çš„ Beanï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯ equals æ–¹æ³•è¿”å› true çš„ Bean</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// è¦†ç›–</span></span><br><span class="line">      <span class="built_in">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// åˆ¤æ–­æ˜¯å¦å·²ç»æœ‰å…¶ä»–çš„ Bean å¼€å§‹åˆå§‹åŒ–äº†.</span></span><br><span class="line">      <span class="comment">// æ³¨æ„ï¼Œ&quot;æ³¨å†ŒBean&quot; è¿™ä¸ªåŠ¨ä½œç»“æŸï¼ŒBean ä¾ç„¶è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œæˆ‘ä»¬åé¢ä¼šæœ‰å¤§ç¯‡å¹…è¯´åˆå§‹åŒ–è¿‡ç¨‹ï¼Œ</span></span><br><span class="line">      <span class="comment">// åœ¨ Spring å®¹å™¨å¯åŠ¨çš„æœ€åï¼Œä¼š é¢„åˆå§‹åŒ– æ‰€æœ‰çš„ singleton beans</span></span><br><span class="line">      <span class="keyword">if</span> (hasBeanCreationStarted()) &#123;</span><br><span class="line">         <span class="comment">// Cannot modify startup-time collection elements anymore (for stable iteration)</span></span><br><span class="line">         <span class="keyword">synchronized</span> (<span class="built_in">this</span>.beanDefinitionMap) &#123;</span><br><span class="line">            <span class="built_in">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</span><br><span class="line">            List&lt;String&gt; updatedDefinitions = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;(<span class="built_in">this</span>.beanDefinitionNames.size() + <span class="number">1</span>);</span><br><span class="line">            updatedDefinitions.addAll(<span class="built_in">this</span>.beanDefinitionNames);</span><br><span class="line">            updatedDefinitions.add(beanName);</span><br><span class="line">            <span class="built_in">this</span>.beanDefinitionNames = updatedDefinitions;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.manualSingletonNames.contains(beanName)) &#123;</span><br><span class="line">               Set&lt;String&gt; updatedSingletons = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;String&gt;(<span class="built_in">this</span>.manualSingletonNames);</span><br><span class="line">               updatedSingletons.remove(beanName);</span><br><span class="line">               <span class="built_in">this</span>.manualSingletonNames = updatedSingletons;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="comment">// æœ€æ­£å¸¸çš„åº”è¯¥æ˜¯è¿›åˆ°è¿™ä¸ªåˆ†æ”¯ã€‚</span></span><br><span class="line">        </span><br><span class="line">         <span class="comment">// å°† BeanDefinition æ”¾åˆ°è¿™ä¸ª map ä¸­ï¼Œè¿™ä¸ª map ä¿å­˜äº†æ‰€æœ‰çš„ BeanDefinition</span></span><br><span class="line">         <span class="built_in">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</span><br><span class="line">         <span class="comment">// è¿™æ˜¯ä¸ª ArrayListï¼Œæ‰€ä»¥ä¼šæŒ‰ç…§ bean é…ç½®çš„é¡ºåºä¿å­˜æ¯ä¸€ä¸ªæ³¨å†Œçš„ Bean çš„åå­—</span></span><br><span class="line">         <span class="built_in">this</span>.beanDefinitionNames.add(beanName);</span><br><span class="line">         <span class="comment">// è¿™æ˜¯ä¸ª LinkedHashSetï¼Œä»£è¡¨çš„æ˜¯æ‰‹åŠ¨æ³¨å†Œçš„ singleton beanï¼Œ</span></span><br><span class="line">         <span class="comment">// æ³¨æ„è¿™é‡Œæ˜¯ remove æ–¹æ³•ï¼Œåˆ°è¿™é‡Œçš„ Bean å½“ç„¶ä¸æ˜¯æ‰‹åŠ¨æ³¨å†Œçš„</span></span><br><span class="line">         <span class="comment">// æ‰‹åŠ¨æŒ‡çš„æ˜¯é€šè¿‡è°ƒç”¨ä»¥ä¸‹æ–¹æ³•æ³¨å†Œçš„ bean ï¼š</span></span><br><span class="line">         <span class="comment">//     registerSingleton(String beanName, Object singletonObject)</span></span><br><span class="line">         <span class="comment">// è¿™ä¸æ˜¯é‡ç‚¹ï¼Œè§£é‡Šåªæ˜¯ä¸ºäº†ä¸è®©å¤§å®¶ç–‘æƒ‘ã€‚Spring ä¼šåœ¨åé¢&quot;æ‰‹åŠ¨&quot;æ³¨å†Œä¸€äº› Beanï¼Œ</span></span><br><span class="line">         <span class="comment">// å¦‚ &quot;environment&quot;ã€&quot;systemProperties&quot; ç­‰ beanï¼Œæˆ‘ä»¬è‡ªå·±ä¹Ÿå¯ä»¥åœ¨è¿è¡Œæ—¶æ³¨å†Œ Bean åˆ°å®¹å™¨ä¸­çš„</span></span><br><span class="line">         <span class="built_in">this</span>.manualSingletonNames.remove(beanName);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// è¿™ä¸ªä¸é‡è¦ï¼Œåœ¨é¢„åˆå§‹åŒ–çš„æ—¶å€™ä¼šç”¨åˆ°ï¼Œä¸å¿…ç®¡å®ƒã€‚</span></span><br><span class="line">      <span class="built_in">this</span>.frozenBeanDefinitionNames = <span class="literal">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (oldBeanDefinition != <span class="literal">null</span> || containsSingleton(beanName)) &#123;</span><br><span class="line">      resetBeanDefinition(beanName);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ€»ç»“ä¸€ä¸‹ï¼Œåˆ°è¿™é‡Œå·²ç»åˆå§‹åŒ–äº† Bean å®¹å™¨ï¼Œ<code>&lt;bean /&gt;</code> é…ç½®ä¹Ÿç›¸åº”çš„è½¬æ¢ä¸ºäº†ä¸€ä¸ªä¸ª BeanDefinitionï¼Œç„¶åæ³¨å†Œäº†å„ä¸ª BeanDefinition åˆ°æ³¨å†Œä¸­å¿ƒï¼Œå¹¶ä¸”å‘é€äº†æ³¨å†Œäº‹ä»¶ã€‚</p>
<p>â€”â€”â€” åˆ†å‰²çº¿ â€”â€”â€”</p>
<p>åˆ°è¿™é‡Œæ˜¯ä¸€ä¸ªåˆ†æ°´å²­ï¼Œå‰é¢çš„å†…å®¹éƒ½è¿˜ç®—æ¯”è¾ƒç®€å•ï¼Œä¸è¿‡åº”è¯¥ä¹Ÿæ¯”è¾ƒç¹çï¼Œå¤§å®¶è¦æ¸…æ¥šåœ°çŸ¥é“å‰é¢éƒ½åšäº†å“ªäº›äº‹æƒ…ã€‚</p>
<h3 id="Bean-å®¹å™¨å®ä¾‹åŒ–å®Œæˆå"><a href="#Bean-å®¹å™¨å®ä¾‹åŒ–å®Œæˆå" class="headerlink" title="Bean å®¹å™¨å®ä¾‹åŒ–å®Œæˆå"></a>Bean å®¹å™¨å®ä¾‹åŒ–å®Œæˆå</h3><p>è¯´åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å›åˆ° refresh() æ–¹æ³•ï¼Œæˆ‘é‡æ–°è´´äº†ä¸€éä»£ç ï¼Œçœ‹çœ‹æˆ‘ä»¬è¯´åˆ°å“ªäº†ã€‚æ˜¯çš„ï¼Œæˆ‘ä»¬æ‰è¯´å®Œ obtainFreshBeanFactory() æ–¹æ³•ã€‚</p>
<p>è€ƒè™‘åˆ°ç¯‡å¹…ï¼Œè¿™é‡Œå¼€å§‹å¤§å¹…ç¼©å‡æ‰æ²¡å¿…è¦è¯¦ç»†ä»‹ç»çš„éƒ¨åˆ†ï¼Œå¤§å®¶ç›´æ¥çœ‹ä¸‹é¢çš„ä»£ç ä¸­çš„æ³¨é‡Šå°±å¥½äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException &#123;</span><br><span class="line">   <span class="comment">// æ¥ä¸ªé”ï¼Œä¸ç„¶ refresh() è¿˜æ²¡ç»“æŸï¼Œä½ åˆæ¥ä¸ªå¯åŠ¨æˆ–é”€æ¯å®¹å™¨çš„æ“ä½œï¼Œé‚£ä¸å°±ä¹±å¥—äº†å˜›</span></span><br><span class="line">   <span class="keyword">synchronized</span> (<span class="built_in">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å‡†å¤‡å·¥ä½œï¼Œè®°å½•ä¸‹å®¹å™¨çš„å¯åŠ¨æ—¶é—´ã€æ ‡è®°â€œå·²å¯åŠ¨â€çŠ¶æ€ã€å¤„ç†é…ç½®æ–‡ä»¶ä¸­çš„å ä½ç¬¦</span></span><br><span class="line">      prepareRefresh();</span><br><span class="line">     </span><br><span class="line">      <span class="comment">// è¿™æ­¥æ¯”è¾ƒå…³é”®ï¼Œè¿™æ­¥å®Œæˆåï¼Œé…ç½®æ–‡ä»¶å°±ä¼šè§£ææˆä¸€ä¸ªä¸ª Bean å®šä¹‰ï¼Œæ³¨å†Œåˆ° BeanFactory ä¸­ï¼Œ</span></span><br><span class="line">      <span class="comment">// å½“ç„¶ï¼Œè¿™é‡Œè¯´çš„ Bean è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œåªæ˜¯é…ç½®ä¿¡æ¯éƒ½æå–å‡ºæ¥äº†ï¼Œ</span></span><br><span class="line">      <span class="comment">// æ³¨å†Œä¹Ÿåªæ˜¯å°†è¿™äº›ä¿¡æ¯éƒ½ä¿å­˜åˆ°äº†æ³¨å†Œä¸­å¿ƒ(è¯´åˆ°åº•æ ¸å¿ƒæ˜¯ä¸€ä¸ª beanName-&gt; beanDefinition çš„ map)</span></span><br><span class="line">      <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// è®¾ç½® BeanFactory çš„ç±»åŠ è½½å™¨ï¼Œæ·»åŠ å‡ ä¸ª BeanPostProcessorï¼Œæ‰‹åŠ¨æ³¨å†Œå‡ ä¸ªç‰¹æ®Šçš„ bean</span></span><br><span class="line">      <span class="comment">// è¿™å—å¾…ä¼šä¼šå±•å¼€è¯´</span></span><br><span class="line">      prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">// ã€è¿™é‡Œéœ€è¦çŸ¥é“ BeanFactoryPostProcessor è¿™ä¸ªçŸ¥è¯†ç‚¹ï¼ŒBean å¦‚æœå®ç°äº†æ­¤æ¥å£ï¼Œ</span></span><br><span class="line">         <span class="comment">// é‚£ä¹ˆåœ¨å®¹å™¨åˆå§‹åŒ–ä»¥åï¼ŒSpring ä¼šè´Ÿè´£è°ƒç”¨é‡Œé¢çš„ postProcessBeanFactory æ–¹æ³•ã€‚ã€‘</span></span><br><span class="line">        </span><br><span class="line">         <span class="comment">// è¿™é‡Œæ˜¯æä¾›ç»™å­ç±»çš„æ‰©å±•ç‚¹ï¼Œåˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œæ‰€æœ‰çš„ Bean éƒ½åŠ è½½ã€æ³¨å†Œå®Œæˆäº†ï¼Œä½†æ˜¯éƒ½è¿˜æ²¡æœ‰åˆå§‹åŒ–</span></span><br><span class="line">         <span class="comment">// å…·ä½“çš„å­ç±»å¯ä»¥åœ¨è¿™æ­¥çš„æ—¶å€™æ·»åŠ ä¸€äº›ç‰¹æ®Šçš„ BeanFactoryPostProcessor çš„å®ç°ç±»æˆ–åšç‚¹ä»€ä¹ˆäº‹</span></span><br><span class="line">         postProcessBeanFactory(beanFactory);</span><br><span class="line">         <span class="comment">// è°ƒç”¨ BeanFactoryPostProcessor å„ä¸ªå®ç°ç±»çš„ postProcessBeanFactory(factory) å›è°ƒæ–¹æ³•</span></span><br><span class="line">         invokeBeanFactoryPostProcessors(beanFactory);          </span><br><span class="line">         </span><br><span class="line">          </span><br><span class="line"></span><br><span class="line">         <span class="comment">// æ³¨å†Œ BeanPostProcessor çš„å®ç°ç±»ï¼Œæ³¨æ„çœ‹å’Œ BeanFactoryPostProcessor çš„åŒºåˆ«</span></span><br><span class="line">         <span class="comment">// æ­¤æ¥å£ä¸¤ä¸ªæ–¹æ³•: postProcessBeforeInitialization å’Œ postProcessAfterInitialization</span></span><br><span class="line">         <span class="comment">// ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«åœ¨ Bean åˆå§‹åŒ–ä¹‹å‰å’Œåˆå§‹åŒ–ä¹‹åå¾—åˆ°æ‰§è¡Œã€‚è¿™é‡Œä»…ä»…æ˜¯æ³¨å†Œï¼Œä¹‹åä¼šçœ‹åˆ°å›è°ƒè¿™ä¸¤æ–¹æ³•çš„æ—¶æœº</span></span><br><span class="line">         registerBeanPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// åˆå§‹åŒ–å½“å‰ ApplicationContext çš„ MessageSourceï¼Œå›½é™…åŒ–è¿™é‡Œå°±ä¸å±•å¼€è¯´äº†ï¼Œä¸ç„¶æ²¡å®Œæ²¡äº†äº†</span></span><br><span class="line">         initMessageSource();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// åˆå§‹åŒ–å½“å‰ ApplicationContext çš„äº‹ä»¶å¹¿æ’­å™¨ï¼Œè¿™é‡Œä¹Ÿä¸å±•å¼€äº†</span></span><br><span class="line">         initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// ä»æ–¹æ³•åå°±å¯ä»¥çŸ¥é“ï¼Œå…¸å‹çš„æ¨¡æ¿æ–¹æ³•(é’©å­æ–¹æ³•)ï¼Œä¸å±•å¼€è¯´</span></span><br><span class="line">         <span class="comment">// å…·ä½“çš„å­ç±»å¯ä»¥åœ¨è¿™é‡Œåˆå§‹åŒ–ä¸€äº›ç‰¹æ®Šçš„ Beanï¼ˆåœ¨åˆå§‹åŒ– singleton beans ä¹‹å‰ï¼‰</span></span><br><span class="line">         onRefresh();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ï¼Œç›‘å¬å™¨éœ€è¦å®ç° ApplicationListener æ¥å£ã€‚è¿™ä¹Ÿä¸æ˜¯æˆ‘ä»¬çš„é‡ç‚¹ï¼Œè¿‡</span></span><br><span class="line">         registerListeners();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// é‡ç‚¹ï¼Œé‡ç‚¹ï¼Œé‡ç‚¹</span></span><br><span class="line">         <span class="comment">// åˆå§‹åŒ–æ‰€æœ‰çš„ singleton beans</span></span><br><span class="line">         <span class="comment">//ï¼ˆlazy-init çš„é™¤å¤–ï¼‰</span></span><br><span class="line">         finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// æœ€åï¼Œå¹¿æ’­äº‹ä»¶ï¼ŒApplicationContext åˆå§‹åŒ–å®Œæˆï¼Œä¸å±•å¼€</span></span><br><span class="line">         finishRefresh();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">         <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;Exception encountered during context initialization - &quot;</span> +</span><br><span class="line">                  <span class="string">&quot;cancelling refresh attempt: &quot;</span> + ex);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Destroy already created singletons to avoid dangling resources.</span></span><br><span class="line">         <span class="comment">// é”€æ¯å·²ç»åˆå§‹åŒ–çš„ singleton çš„ Beansï¼Œä»¥å…æœ‰äº› bean ä¼šä¸€ç›´å ç”¨èµ„æº</span></span><br><span class="line">         destroyBeans();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Reset &#x27;active&#x27; flag.</span></span><br><span class="line">         cancelRefresh(ex);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// æŠŠå¼‚å¸¸å¾€å¤–æŠ›</span></span><br><span class="line">         <span class="keyword">throw</span> ex;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">finally</span> &#123;</span><br><span class="line">         <span class="comment">// Reset common introspection caches in Spring&#x27;s core, since we</span></span><br><span class="line">         <span class="comment">// might not ever need metadata for singleton beans anymore...</span></span><br><span class="line">         resetCommonCaches();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å‡†å¤‡-Bean-å®¹å™¨-prepareBeanFactory"><a href="#å‡†å¤‡-Bean-å®¹å™¨-prepareBeanFactory" class="headerlink" title="å‡†å¤‡ Bean å®¹å™¨: prepareBeanFactory"></a>å‡†å¤‡ Bean å®¹å™¨: prepareBeanFactory</h3><p>ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼ŒSpring æŠŠæˆ‘ä»¬åœ¨ xml é…ç½®çš„ bean éƒ½æ³¨å†Œä»¥åï¼Œä¼šâ€æ‰‹åŠ¨â€æ³¨å†Œä¸€äº›ç‰¹æ®Šçš„ beanã€‚</p>
<p>è¿™é‡Œç®€å•ä»‹ç»ä¸‹ prepareBeanFactory(factory) æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Configure the factory&#x27;s standard context characteristics,</span></span><br><span class="line"><span class="comment"> * such as the context&#x27;s ClassLoader and post-processors.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> beanFactory the BeanFactory to configure</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">prepareBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line">   <span class="comment">// è®¾ç½® BeanFactory çš„ç±»åŠ è½½å™¨ï¼Œæˆ‘ä»¬çŸ¥é“ BeanFactory éœ€è¦åŠ è½½ç±»ï¼Œä¹Ÿå°±éœ€è¦ç±»åŠ è½½å™¨ï¼Œ</span></span><br><span class="line">   <span class="comment">// è¿™é‡Œè®¾ç½®ä¸ºåŠ è½½å½“å‰ ApplicationContext ç±»çš„ç±»åŠ è½½å™¨</span></span><br><span class="line">   beanFactory.setBeanClassLoader(getClassLoader());</span><br><span class="line">    </span><br><span class="line">   <span class="comment">// è®¾ç½® BeanExpressionResolver</span></span><br><span class="line">   beanFactory.setBeanExpressionResolver(<span class="keyword">new</span> <span class="title class_">StandardBeanExpressionResolver</span>(beanFactory.getBeanClassLoader()));</span><br><span class="line">   <span class="comment">// </span></span><br><span class="line">   beanFactory.addPropertyEditorRegistrar(<span class="keyword">new</span> <span class="title class_">ResourceEditorRegistrar</span>(<span class="built_in">this</span>, getEnvironment()));</span><br><span class="line"></span><br><span class="line">   <span class="comment">// æ·»åŠ ä¸€ä¸ª BeanPostProcessorï¼Œè¿™ä¸ª processor æ¯”è¾ƒç®€å•ï¼š</span></span><br><span class="line">   <span class="comment">// å®ç°äº† Aware æ¥å£çš„ beans åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œè¿™ä¸ª processor è´Ÿè´£å›è°ƒï¼Œ</span></span><br><span class="line">   <span class="comment">// è¿™ä¸ªæˆ‘ä»¬å¾ˆå¸¸ç”¨ï¼Œå¦‚æˆ‘ä»¬ä¼šä¸ºäº†è·å– ApplicationContext è€Œ implement ApplicationContextAware</span></span><br><span class="line">   <span class="comment">// æ³¨æ„ï¼šå®ƒä¸ä»…ä»…å›è°ƒ ApplicationContextAwareï¼Œ</span></span><br><span class="line">   <span class="comment">//   è¿˜ä¼šè´Ÿè´£å›è°ƒ EnvironmentAwareã€ResourceLoaderAware ç­‰ï¼Œçœ‹ä¸‹æºç å°±æ¸…æ¥šäº†</span></span><br><span class="line">   beanFactory.addBeanPostProcessor(<span class="keyword">new</span> <span class="title class_">ApplicationContextAwareProcessor</span>(<span class="built_in">this</span>));</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// ä¸‹é¢å‡ è¡Œçš„æ„æ€å°±æ˜¯ï¼Œå¦‚æœæŸä¸ª bean ä¾èµ–äºä»¥ä¸‹å‡ ä¸ªæ¥å£çš„å®ç°ç±»ï¼Œåœ¨è‡ªåŠ¨è£…é…çš„æ—¶å€™å¿½ç•¥å®ƒä»¬ï¼Œ</span></span><br><span class="line">   <span class="comment">// Spring ä¼šé€šè¿‡å…¶ä»–æ–¹å¼æ¥å¤„ç†è¿™äº›ä¾èµ–ã€‚</span></span><br><span class="line">   beanFactory.ignoreDependencyInterface(EnvironmentAware.class);</span><br><span class="line">   beanFactory.ignoreDependencyInterface(EmbeddedValueResolverAware.class);</span><br><span class="line">   beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class);</span><br><span class="line">   beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class);</span><br><span class="line">   beanFactory.ignoreDependencyInterface(MessageSourceAware.class);</span><br><span class="line">   beanFactory.ignoreDependencyInterface(ApplicationContextAware.class);</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * ä¸‹é¢å‡ è¡Œå°±æ˜¯ä¸ºç‰¹æ®Šçš„å‡ ä¸ª bean èµ‹å€¼ï¼Œå¦‚æœæœ‰ bean ä¾èµ–äº†ä»¥ä¸‹å‡ ä¸ªï¼Œä¼šæ³¨å…¥è¿™è¾¹ç›¸åº”çš„å€¼ï¼Œ</span></span><br><span class="line"><span class="comment">    * ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼Œ&quot;å½“å‰ ApplicationContext æŒæœ‰ä¸€ä¸ª BeanFactory&quot;ï¼Œè¿™é‡Œè§£é‡Šäº†ç¬¬ä¸€è¡Œã€‚</span></span><br><span class="line"><span class="comment">    * ApplicationContext è¿˜ç»§æ‰¿äº† ResourceLoaderã€ApplicationEventPublisherã€MessageSource</span></span><br><span class="line"><span class="comment">    * æ‰€ä»¥å¯¹äºè¿™å‡ ä¸ªä¾èµ–ï¼Œå¯ä»¥èµ‹å€¼ä¸º thisï¼Œæ³¨æ„ this æ˜¯ä¸€ä¸ª ApplicationContext</span></span><br><span class="line"><span class="comment">    * é‚£è¿™é‡Œæ€ä¹ˆæ²¡çœ‹åˆ°ä¸º MessageSource èµ‹å€¼å‘¢ï¼Ÿé‚£æ˜¯å› ä¸º MessageSource è¢«æ³¨å†Œæˆä¸ºäº†ä¸€ä¸ªæ™®é€šçš„ bean</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory);</span><br><span class="line">   beanFactory.registerResolvableDependency(ResourceLoader.class, <span class="built_in">this</span>);</span><br><span class="line">   beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, <span class="built_in">this</span>);</span><br><span class="line">   beanFactory.registerResolvableDependency(ApplicationContext.class, <span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// è¿™ä¸ª BeanPostProcessor ä¹Ÿå¾ˆç®€å•ï¼Œåœ¨ bean å®ä¾‹åŒ–åï¼Œå¦‚æœæ˜¯ ApplicationListener çš„å­ç±»ï¼Œ</span></span><br><span class="line">   <span class="comment">// é‚£ä¹ˆå°†å…¶æ·»åŠ åˆ° listener åˆ—è¡¨ä¸­ï¼Œå¯ä»¥ç†è§£æˆï¼šæ³¨å†Œ äº‹ä»¶ç›‘å¬å™¨</span></span><br><span class="line">   beanFactory.addBeanPostProcessor(<span class="keyword">new</span> <span class="title class_">ApplicationListenerDetector</span>(<span class="built_in">this</span>));</span><br><span class="line"></span><br><span class="line">   <span class="comment">// è¿™é‡Œæ¶‰åŠåˆ°ç‰¹æ®Šçš„ beanï¼Œåä¸ºï¼šloadTimeWeaverï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬çš„é‡ç‚¹ï¼Œå¿½ç•¥å®ƒ</span></span><br><span class="line">   <span class="comment">// tips: ltw æ˜¯ AspectJ çš„æ¦‚å¿µï¼ŒæŒ‡çš„æ˜¯åœ¨è¿è¡ŒæœŸè¿›è¡Œç»‡å…¥ï¼Œè¿™ä¸ªå’Œ Spring AOP ä¸ä¸€æ ·ï¼Œ</span></span><br><span class="line">   <span class="comment">//    æ„Ÿå…´è¶£çš„è¯»è€…è¯·å‚è€ƒæˆ‘å†™çš„å…³äº AspectJ çš„å¦ä¸€ç¯‡æ–‡ç«  https://www.javadoop.com/post/aspectj</span></span><br><span class="line">   <span class="keyword">if</span> (beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;</span><br><span class="line">      beanFactory.addBeanPostProcessor(<span class="keyword">new</span> <span class="title class_">LoadTimeWeaverAwareProcessor</span>(beanFactory));</span><br><span class="line">      <span class="comment">// Set a temporary ClassLoader for type matching.</span></span><br><span class="line">      beanFactory.setTempClassLoader(<span class="keyword">new</span> <span class="title class_">ContextTypeMatchClassLoader</span>(beanFactory.getBeanClassLoader()));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * ä»ä¸‹é¢å‡ è¡Œä»£ç æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒSpring å¾€å¾€å¾ˆ &quot;æ™ºèƒ½&quot; å°±æ˜¯å› ä¸ºå®ƒä¼šå¸®æˆ‘ä»¬é»˜è®¤æ³¨å†Œä¸€äº›æœ‰ç”¨çš„ beanï¼Œ</span></span><br><span class="line"><span class="comment">    * æˆ‘ä»¬ä¹Ÿå¯ä»¥é€‰æ‹©è¦†ç›–</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  </span><br><span class="line">   <span class="comment">// å¦‚æœæ²¡æœ‰å®šä¹‰ &quot;environment&quot; è¿™ä¸ª beanï¼Œé‚£ä¹ˆ Spring ä¼š &quot;æ‰‹åŠ¨&quot; æ³¨å†Œä¸€ä¸ª</span></span><br><span class="line">   <span class="keyword">if</span> (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">      beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment());</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// å¦‚æœæ²¡æœ‰å®šä¹‰ &quot;systemProperties&quot; è¿™ä¸ª beanï¼Œé‚£ä¹ˆ Spring ä¼š &quot;æ‰‹åŠ¨&quot; æ³¨å†Œä¸€ä¸ª</span></span><br><span class="line">   <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) &#123;</span><br><span class="line">      beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties());</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// å¦‚æœæ²¡æœ‰å®šä¹‰ &quot;systemEnvironment&quot; è¿™ä¸ª beanï¼Œé‚£ä¹ˆ Spring ä¼š &quot;æ‰‹åŠ¨&quot; æ³¨å†Œä¸€ä¸ª</span></span><br><span class="line">   <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">      beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment());</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸Šé¢è¿™å—ä»£ç ä¸­ï¼ŒSpring å¯¹ä¸€äº›ç‰¹æ®Šçš„ bean è¿›è¡Œäº†å¤„ç†ï¼Œè¯»è€…å¦‚æœæš‚æ—¶è¿˜ä¸èƒ½æ¶ˆåŒ–å®ƒä»¬ä¹Ÿæ²¡æœ‰å…³ç³»ï¼Œæ…¢æ…¢å¾€ä¸‹çœ‹ã€‚</p>
<h3 id="åˆå§‹åŒ–æ‰€æœ‰çš„-singleton-beans"><a href="#åˆå§‹åŒ–æ‰€æœ‰çš„-singleton-beans" class="headerlink" title="åˆå§‹åŒ–æ‰€æœ‰çš„ singleton beans"></a>åˆå§‹åŒ–æ‰€æœ‰çš„ singleton beans</h3><p>æˆ‘ä»¬çš„é‡ç‚¹å½“ç„¶æ˜¯ <code>finishBeanFactoryInitialization(beanFactory);</code> è¿™ä¸ªå·¨å¤´äº†ï¼Œè¿™é‡Œä¼šè´Ÿè´£åˆå§‹åŒ–æ‰€æœ‰çš„ singleton beansã€‚</p>
<p>æ³¨æ„ï¼Œåé¢çš„æè¿°ä¸­ï¼Œæˆ‘éƒ½ä¼šä½¿ç”¨<strong>åˆå§‹åŒ–</strong>æˆ–<strong>é¢„åˆå§‹åŒ–</strong>æ¥ä»£è¡¨è¿™ä¸ªé˜¶æ®µï¼ŒSpring ä¼šåœ¨è¿™ä¸ªé˜¶æ®µå®Œæˆæ‰€æœ‰çš„ singleton beans çš„å®ä¾‹åŒ–ã€‚</p>
<p>æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œåº”è¯¥è¯´ BeanFactory å·²ç»åˆ›å»ºå®Œæˆï¼Œå¹¶ä¸”æ‰€æœ‰çš„å®ç°äº† BeanFactoryPostProcessor æ¥å£çš„ Bean éƒ½å·²ç»åˆå§‹åŒ–å¹¶ä¸”å…¶ä¸­çš„ postProcessBeanFactory(factory) æ–¹æ³•å·²ç»å¾—åˆ°å›è°ƒæ‰§è¡Œäº†ã€‚è€Œä¸” Spring å·²ç»â€œæ‰‹åŠ¨â€æ³¨å†Œäº†ä¸€äº›ç‰¹æ®Šçš„ Beanï¼Œå¦‚ <code>environment</code>ã€<code>systemProperties</code> ç­‰ã€‚</p>
<p>å‰©ä¸‹çš„å°±æ˜¯åˆå§‹åŒ– singleton beans äº†ï¼Œæˆ‘ä»¬çŸ¥é“å®ƒä»¬æ˜¯å•ä¾‹çš„ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®æ‡’åŠ è½½ï¼Œé‚£ä¹ˆ Spring ä¼šåœ¨æ¥ä¸‹æ¥åˆå§‹åŒ–æ‰€æœ‰çš„ singleton beansã€‚</p>
<p>// AbstractApplicationContext.java 834</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆå§‹åŒ–å‰©ä½™çš„ singleton beans</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">finishBeanFactoryInitialization</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// é¦–å…ˆï¼Œåˆå§‹åŒ–åå­—ä¸º conversionService çš„ Beanã€‚æœ¬ç€é€ä½›é€åˆ°è¥¿çš„ç²¾ç¥ï¼Œæˆ‘åœ¨é™„å½•ä¸­ç®€å•ä»‹ç»äº†ä¸€ä¸‹ ConversionServiceï¼Œå› ä¸ºè¿™å®åœ¨å¤ªå®ç”¨äº†</span></span><br><span class="line">   <span class="comment">// ä»€ä¹ˆï¼Œçœ‹ä»£ç è¿™é‡Œæ²¡æœ‰åˆå§‹åŒ– Bean å•Šï¼</span></span><br><span class="line">   <span class="comment">// æ³¨æ„äº†ï¼Œåˆå§‹åŒ–çš„åŠ¨ä½œåŒ…è£…åœ¨ beanFactory.getBean(...) ä¸­ï¼Œè¿™é‡Œå…ˆä¸è¯´ç»†èŠ‚ï¼Œå…ˆå¾€ä¸‹çœ‹å§</span></span><br><span class="line">   <span class="keyword">if</span> (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp;</span><br><span class="line">         beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123;</span><br><span class="line">      beanFactory.setConversionService(</span><br><span class="line">            beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Register a default embedded value resolver if no bean post-processor</span></span><br><span class="line">   <span class="comment">// (such as a PropertyPlaceholderConfigurer bean) registered any before:</span></span><br><span class="line">   <span class="comment">// at this point, primarily for resolution in annotation attribute values.</span></span><br><span class="line">   <span class="keyword">if</span> (!beanFactory.hasEmbeddedValueResolver()) &#123;</span><br><span class="line">      beanFactory.addEmbeddedValueResolver(<span class="keyword">new</span> <span class="title class_">StringValueResolver</span>() &#123;</span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="keyword">public</span> String <span class="title function_">resolveStringValue</span><span class="params">(String strVal)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> getEnvironment().resolvePlaceholders(strVal);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// å…ˆåˆå§‹åŒ– LoadTimeWeaverAware ç±»å‹çš„ Bean</span></span><br><span class="line">   <span class="comment">// ä¹‹å‰ä¹Ÿè¯´è¿‡ï¼Œè¿™æ˜¯ AspectJ ç›¸å…³çš„å†…å®¹ï¼Œæ”¾å¿ƒè·³è¿‡å§</span></span><br><span class="line">   String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">   <span class="keyword">for</span> (String weaverAwareName : weaverAwareNames) &#123;</span><br><span class="line">      getBean(weaverAwareName);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Stop using the temporary ClassLoader for type matching.</span></span><br><span class="line">   beanFactory.setTempClassLoader(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// æ²¡ä»€ä¹ˆåˆ«çš„ç›®çš„ï¼Œå› ä¸ºåˆ°è¿™ä¸€æ­¥çš„æ—¶å€™ï¼ŒSpring å·²ç»å¼€å§‹é¢„åˆå§‹åŒ– singleton beans äº†ï¼Œ</span></span><br><span class="line">   <span class="comment">// è‚¯å®šä¸å¸Œæœ›è¿™ä¸ªæ—¶å€™è¿˜å‡ºç° bean å®šä¹‰è§£æã€åŠ è½½ã€æ³¨å†Œã€‚</span></span><br><span class="line">   beanFactory.freezeConfiguration();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// å¼€å§‹åˆå§‹åŒ–</span></span><br><span class="line">   beanFactory.preInstantiateSingletons();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šé¢æœ€åä¸€è¡Œå¾€é‡Œçœ‹ï¼Œæˆ‘ä»¬å°±åˆå›åˆ° DefaultListableBeanFactory è¿™ä¸ªç±»äº†ï¼Œè¿™ä¸ªç±»å¤§å®¶åº”è¯¥éƒ½ä¸é™Œç”Ÿäº†å§ã€‚</p>
<h4 id="preInstantiateSingletons"><a href="#preInstantiateSingletons" class="headerlink" title="preInstantiateSingletons"></a>preInstantiateSingletons</h4><p>// DefaultListableBeanFactory 728</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">preInstantiateSingletons</span><span class="params">()</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">   <span class="keyword">if</span> (<span class="built_in">this</span>.logger.isDebugEnabled()) &#123;</span><br><span class="line">      <span class="built_in">this</span>.logger.debug(<span class="string">&quot;Pre-instantiating singletons in &quot;</span> + <span class="built_in">this</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// this.beanDefinitionNames ä¿å­˜äº†æ‰€æœ‰çš„ beanNames</span></span><br><span class="line">   List&lt;String&gt; beanNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;(<span class="built_in">this</span>.beanDefinitionNames);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// ä¸‹é¢è¿™ä¸ªå¾ªç¯ï¼Œè§¦å‘æ‰€æœ‰çš„éæ‡’åŠ è½½çš„ singleton beans çš„åˆå§‹åŒ–æ“ä½œ</span></span><br><span class="line">   <span class="keyword">for</span> (String beanName : beanNames) &#123;</span><br><span class="line">     </span><br><span class="line">      <span class="comment">// åˆå¹¶çˆ¶ Bean ä¸­çš„é…ç½®ï¼Œæ³¨æ„ &lt;bean id=&quot;&quot; class=&quot;&quot; parent=&quot;&quot; /&gt; ä¸­çš„ parentï¼Œç”¨çš„ä¸å¤šå§ï¼Œ</span></span><br><span class="line">      <span class="comment">// è€ƒè™‘åˆ°è¿™å¯èƒ½ä¼šå½±å“å¤§å®¶çš„ç†è§£ï¼Œæˆ‘åœ¨é™„å½•ä¸­è§£é‡Šäº†ä¸€ä¸‹ &quot;Bean ç»§æ‰¿&quot;ï¼Œä¸äº†è§£çš„è¯·åˆ°é™„å½•ä¸­çœ‹ä¸€ä¸‹</span></span><br><span class="line">      <span class="type">RootBeanDefinition</span> <span class="variable">bd</span> <span class="operator">=</span> getMergedLocalBeanDefinition(beanName);</span><br><span class="line">     </span><br><span class="line">      <span class="comment">// éæŠ½è±¡ã€éæ‡’åŠ è½½çš„ singletonsã€‚å¦‚æœé…ç½®äº† &#x27;abstract = true&#x27;ï¼Œé‚£æ˜¯ä¸éœ€è¦åˆå§‹åŒ–çš„</span></span><br><span class="line">      <span class="keyword">if</span> (!bd.isAbstract() &amp;&amp; bd.isSingleton() &amp;&amp; !bd.isLazyInit()) &#123;</span><br><span class="line">         <span class="comment">// å¤„ç† FactoryBean(è¯»è€…å¦‚æœä¸ç†Ÿæ‚‰ FactoryBeanï¼Œè¯·ç§»æ­¥é™„å½•åŒºäº†è§£)</span></span><br><span class="line">         <span class="keyword">if</span> (isFactoryBean(beanName)) &#123;</span><br><span class="line">            <span class="comment">// FactoryBean çš„è¯ï¼Œåœ¨ beanName å‰é¢åŠ ä¸Š â€˜&amp;â€™ ç¬¦å·ã€‚å†è°ƒç”¨ getBeanï¼ŒgetBean æ–¹æ³•åˆ«æ€¥</span></span><br><span class="line">            <span class="keyword">final</span> FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) getBean(FACTORY_BEAN_PREFIX + beanName);</span><br><span class="line">            <span class="comment">// åˆ¤æ–­å½“å‰ FactoryBean æ˜¯å¦æ˜¯ SmartFactoryBean çš„å®ç°ï¼Œæ­¤å¤„å¿½ç•¥ï¼Œç›´æ¥è·³è¿‡</span></span><br><span class="line">            <span class="type">boolean</span> isEagerInit;</span><br><span class="line">            <span class="keyword">if</span> (System.getSecurityManager() != <span class="literal">null</span> &amp;&amp; factory <span class="keyword">instanceof</span> SmartFactoryBean) &#123;</span><br><span class="line">               isEagerInit = AccessController.doPrivileged(<span class="keyword">new</span> <span class="title class_">PrivilegedAction</span>&lt;Boolean&gt;() &#123;</span><br><span class="line">                  <span class="meta">@Override</span></span><br><span class="line">                  <span class="keyword">public</span> Boolean <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                     <span class="keyword">return</span> ((SmartFactoryBean&lt;?&gt;) factory).isEagerInit();</span><br><span class="line">                  &#125;</span><br><span class="line">               &#125;, getAccessControlContext());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">               isEagerInit = (factory <span class="keyword">instanceof</span> SmartFactoryBean &amp;&amp;</span><br><span class="line">                     ((SmartFactoryBean&lt;?&gt;) factory).isEagerInit());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (isEagerInit) &#123;</span><br><span class="line">               </span><br><span class="line">               getBean(beanName);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å¯¹äºæ™®é€šçš„ Beanï¼Œåªè¦è°ƒç”¨ getBean(beanName) è¿™ä¸ªæ–¹æ³•å°±å¯ä»¥è¿›è¡Œåˆå§‹åŒ–äº†</span></span><br><span class="line">            getBean(beanName);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// åˆ°è¿™é‡Œè¯´æ˜æ‰€æœ‰çš„éæ‡’åŠ è½½çš„ singleton beans å·²ç»å®Œæˆäº†åˆå§‹åŒ–</span></span><br><span class="line">   <span class="comment">// å¦‚æœæˆ‘ä»¬å®šä¹‰çš„ bean æ˜¯å®ç°äº† SmartInitializingSingleton æ¥å£çš„ï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œå¾—åˆ°å›è°ƒï¼Œå¿½ç•¥</span></span><br><span class="line">   <span class="keyword">for</span> (String beanName : beanNames) &#123;</span><br><span class="line">      <span class="type">Object</span> <span class="variable">singletonInstance</span> <span class="operator">=</span> getSingleton(beanName);</span><br><span class="line">      <span class="keyword">if</span> (singletonInstance <span class="keyword">instanceof</span> SmartInitializingSingleton) &#123;</span><br><span class="line">         <span class="keyword">final</span> <span class="type">SmartInitializingSingleton</span> <span class="variable">smartSingleton</span> <span class="operator">=</span> (SmartInitializingSingleton) singletonInstance;</span><br><span class="line">         <span class="keyword">if</span> (System.getSecurityManager() != <span class="literal">null</span>) &#123;</span><br><span class="line">            AccessController.doPrivileged(<span class="keyword">new</span> <span class="title class_">PrivilegedAction</span>&lt;Object&gt;() &#123;</span><br><span class="line">               <span class="meta">@Override</span></span><br><span class="line">               <span class="keyword">public</span> Object <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                  smartSingleton.afterSingletonsInstantiated();</span><br><span class="line">                  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;, getAccessControlContext());</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">else</span> &#123;</span><br><span class="line">            smartSingleton.afterSingletonsInstantiated();</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±è¿›å…¥åˆ° getBean(beanName) æ–¹æ³•äº†ï¼Œè¿™ä¸ªæ–¹æ³•æˆ‘ä»¬ç»å¸¸ç”¨æ¥ä» BeanFactory ä¸­è·å–ä¸€ä¸ª Beanï¼Œè€Œåˆå§‹åŒ–çš„è¿‡ç¨‹ä¹Ÿå°è£…åˆ°äº†è¿™ä¸ªæ–¹æ³•é‡Œã€‚</p>
<h4 id="getBean"><a href="#getBean" class="headerlink" title="getBean"></a>getBean</h4><p>åœ¨ç»§ç»­å‰è¿›ä¹‹å‰ï¼Œè¯»è€…åº”è¯¥å…·å¤‡ FactoryBean çš„çŸ¥è¯†ï¼Œå¦‚æœè¯»è€…è¿˜ä¸ç†Ÿæ‚‰ï¼Œè¯·ç§»æ­¥é™„å½•éƒ¨åˆ†äº†è§£ FactoryBeanã€‚</p>
<p>// AbstractBeanFactory 196</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">getBean</span><span class="params">(String name)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">   <span class="keyword">return</span> doGetBean(name, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æˆ‘ä»¬åœ¨å‰–æåˆå§‹åŒ– Bean çš„è¿‡ç¨‹ï¼Œä½†æ˜¯ getBean æ–¹æ³•æˆ‘ä»¬ç»å¸¸æ˜¯ç”¨æ¥ä»å®¹å™¨ä¸­è·å– Bean ç”¨çš„ï¼Œæ³¨æ„åˆ‡æ¢æ€è·¯ï¼Œ</span></span><br><span class="line"><span class="comment">// å·²ç»åˆå§‹åŒ–è¿‡äº†å°±ä»å®¹å™¨ä¸­ç›´æ¥è¿”å›ï¼Œå¦åˆ™å°±å…ˆåˆå§‹åŒ–å†è¿”å›</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; T <span class="title function_">doGetBean</span><span class="params">(</span></span><br><span class="line"><span class="params">      <span class="keyword">final</span> String name, <span class="keyword">final</span> Class&lt;T&gt; requiredType, <span class="keyword">final</span> Object[] args, <span class="type">boolean</span> typeCheckOnly)</span></span><br><span class="line">      <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">   <span class="comment">// è·å–ä¸€ä¸ª â€œæ­£ç»Ÿçš„â€ beanNameï¼Œå¤„ç†ä¸¤ç§æƒ…å†µï¼Œä¸€ä¸ªæ˜¯å‰é¢è¯´çš„ FactoryBean(å‰é¢å¸¦ â€˜&amp;â€™)ï¼Œ</span></span><br><span class="line">   <span class="comment">// ä¸€ä¸ªæ˜¯åˆ«åé—®é¢˜ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•æ˜¯ getBeanï¼Œè·å– Bean ç”¨çš„ï¼Œä½ è¦æ˜¯ä¼ ä¸€ä¸ªåˆ«åè¿›æ¥ï¼Œæ˜¯å®Œå…¨å¯ä»¥çš„</span></span><br><span class="line">   <span class="keyword">final</span> <span class="type">String</span> <span class="variable">beanName</span> <span class="operator">=</span> transformedBeanName(name);</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// æ³¨æ„è·Ÿç€è¿™ä¸ªï¼Œè¿™ä¸ªæ˜¯è¿”å›å€¼</span></span><br><span class="line">   Object bean; </span><br><span class="line"></span><br><span class="line">   <span class="comment">// æ£€æŸ¥ä¸‹æ˜¯ä¸æ˜¯å·²ç»åˆ›å»ºè¿‡äº†</span></span><br><span class="line">   <span class="type">Object</span> <span class="variable">sharedInstance</span> <span class="operator">=</span> getSingleton(beanName);</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// è¿™é‡Œè¯´ä¸‹ args å‘—ï¼Œè™½ç„¶çœ‹ä¸Šå»ä¸€ç‚¹ä¸é‡è¦ã€‚å‰é¢æˆ‘ä»¬ä¸€è·¯è¿›æ¥çš„æ—¶å€™éƒ½æ˜¯ getBean(beanName)ï¼Œ</span></span><br><span class="line">   <span class="comment">// æ‰€ä»¥ args ä¼ å‚å…¶å®æ˜¯ null çš„ï¼Œä½†æ˜¯å¦‚æœ args ä¸ä¸ºç©ºçš„æ—¶å€™ï¼Œé‚£ä¹ˆæ„å‘³ç€è°ƒç”¨æ–¹ä¸æ˜¯å¸Œæœ›è·å– Beanï¼Œè€Œæ˜¯åˆ›å»º Bean</span></span><br><span class="line">   <span class="keyword">if</span> (sharedInstance != <span class="literal">null</span> &amp;&amp; args == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">         <span class="keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">            logger.debug(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.debug(<span class="string">&quot;Returning cached instance of singleton bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ä¸‹é¢è¿™ä¸ªæ–¹æ³•ï¼šå¦‚æœæ˜¯æ™®é€š Bean çš„è¯ï¼Œç›´æ¥è¿”å› sharedInstanceï¼Œ</span></span><br><span class="line">      <span class="comment">// å¦‚æœæ˜¯ FactoryBean çš„è¯ï¼Œè¿”å›å®ƒåˆ›å»ºçš„é‚£ä¸ªå®ä¾‹å¯¹è±¡</span></span><br><span class="line">      <span class="comment">// (FactoryBean çŸ¥è¯†ï¼Œè¯»è€…è‹¥ä¸æ¸…æ¥šè¯·ç§»æ­¥é™„å½•)</span></span><br><span class="line">      bean = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="literal">null</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (isPrototypeCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">         <span class="comment">// åˆ›å»ºè¿‡äº†æ­¤ beanName çš„ prototype ç±»å‹çš„ beanï¼Œé‚£ä¹ˆæŠ›å¼‚å¸¸ï¼Œ</span></span><br><span class="line">         <span class="comment">// å¾€å¾€æ˜¯å› ä¸ºé™·å…¥äº†å¾ªç¯å¼•ç”¨</span></span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCurrentlyInCreationException</span>(beanName);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ£€æŸ¥ä¸€ä¸‹è¿™ä¸ª BeanDefinition åœ¨å®¹å™¨ä¸­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">      <span class="type">BeanFactory</span> <span class="variable">parentBeanFactory</span> <span class="operator">=</span> getParentBeanFactory();</span><br><span class="line">      <span class="keyword">if</span> (parentBeanFactory != <span class="literal">null</span> &amp;&amp; !containsBeanDefinition(beanName)) &#123;</span><br><span class="line">         <span class="comment">// å¦‚æœå½“å‰å®¹å™¨ä¸å­˜åœ¨è¿™ä¸ª BeanDefinitionï¼Œè¯•è¯•çˆ¶å®¹å™¨ä¸­æœ‰æ²¡æœ‰</span></span><br><span class="line">         <span class="type">String</span> <span class="variable">nameToLookup</span> <span class="operator">=</span> originalBeanName(name);</span><br><span class="line">         <span class="keyword">if</span> (args != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// è¿”å›çˆ¶å®¹å™¨çš„æŸ¥è¯¢ç»“æœ</span></span><br><span class="line">            <span class="keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup, args);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// No args -&gt; delegate to standard getBean method.</span></span><br><span class="line">            <span class="keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!typeCheckOnly) &#123;</span><br><span class="line">         <span class="comment">// typeCheckOnly ä¸º falseï¼Œå°†å½“å‰ beanName æ”¾å…¥ä¸€ä¸ª alreadyCreated çš„ Set é›†åˆä¸­ã€‚</span></span><br><span class="line">         markBeanAsCreated(beanName);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">       * ç¨ç¨æ€»ç»“ä¸€ä¸‹ï¼š</span></span><br><span class="line"><span class="comment">       * åˆ°è¿™é‡Œçš„è¯ï¼Œè¦å‡†å¤‡åˆ›å»º Bean äº†ï¼Œå¯¹äº singleton çš„ Bean æ¥è¯´ï¼Œå®¹å™¨ä¸­è¿˜æ²¡åˆ›å»ºè¿‡æ­¤ Beanï¼›</span></span><br><span class="line"><span class="comment">       * å¯¹äº prototype çš„ Bean æ¥è¯´ï¼Œæœ¬æ¥å°±æ˜¯è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ Beanã€‚</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="keyword">final</span> <span class="type">RootBeanDefinition</span> <span class="variable">mbd</span> <span class="operator">=</span> getMergedLocalBeanDefinition(beanName);</span><br><span class="line">         checkMergedBeanDefinition(mbd, beanName, args);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// å…ˆåˆå§‹åŒ–ä¾èµ–çš„æ‰€æœ‰ Beanï¼Œè¿™ä¸ªå¾ˆå¥½ç†è§£ã€‚</span></span><br><span class="line">         <span class="comment">// æ³¨æ„ï¼Œè¿™é‡Œçš„ä¾èµ–æŒ‡çš„æ˜¯ depends-on ä¸­å®šä¹‰çš„ä¾èµ–</span></span><br><span class="line">         String[] dependsOn = mbd.getDependsOn();</span><br><span class="line">         <span class="keyword">if</span> (dependsOn != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String dep : dependsOn) &#123;</span><br><span class="line">               <span class="comment">// æ£€æŸ¥æ˜¯ä¸æ˜¯æœ‰å¾ªç¯ä¾èµ–ï¼Œè¿™é‡Œçš„å¾ªç¯ä¾èµ–å’Œæˆ‘ä»¬å‰é¢è¯´çš„å¾ªç¯ä¾èµ–åˆä¸ä¸€æ ·ï¼Œè¿™é‡Œè‚¯å®šæ˜¯ä¸å…è®¸å‡ºç°çš„ï¼Œä¸ç„¶è¦ä¹±å¥—äº†ï¼Œè¯»è€…æƒ³ä¸€ä¸‹å°±çŸ¥é“äº†</span></span><br><span class="line">               <span class="keyword">if</span> (isDependent(beanName, dep)) &#123;</span><br><span class="line">                  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,</span><br><span class="line">                        <span class="string">&quot;Circular depends-on relationship between &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27; and &#x27;&quot;</span> + dep + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">// æ³¨å†Œä¸€ä¸‹ä¾èµ–å…³ç³»</span></span><br><span class="line">               registerDependentBean(dep, beanName);</span><br><span class="line">               <span class="comment">// å…ˆåˆå§‹åŒ–è¢«ä¾èµ–é¡¹</span></span><br><span class="line">               getBean(dep);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// å¦‚æœæ˜¯ singleton scope çš„ï¼Œåˆ›å»º singleton çš„å®ä¾‹</span></span><br><span class="line">         <span class="keyword">if</span> (mbd.isSingleton()) &#123;</span><br><span class="line">            sharedInstance = getSingleton(beanName, <span class="keyword">new</span> <span class="title class_">ObjectFactory</span>&lt;Object&gt;() &#123;</span><br><span class="line">               <span class="meta">@Override</span></span><br><span class="line">               <span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">                  <span class="keyword">try</span> &#123;</span><br><span class="line">                     <span class="comment">// æ‰§è¡Œåˆ›å»º Beanï¼Œè¯¦æƒ…åé¢å†è¯´</span></span><br><span class="line">                     <span class="keyword">return</span> createBean(beanName, mbd, args);</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">                     destroySingleton(beanName);</span><br><span class="line">                     <span class="keyword">throw</span> ex;</span><br><span class="line">                  &#125;</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// å¦‚æœæ˜¯ prototype scope çš„ï¼Œåˆ›å»º prototype çš„å®ä¾‹</span></span><br><span class="line">         <span class="keyword">else</span> <span class="keyword">if</span> (mbd.isPrototype()) &#123;</span><br><span class="line">            <span class="comment">// It&#x27;s a prototype -&gt; create a new instance.</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">prototypeInstance</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">               beforePrototypeCreation(beanName);</span><br><span class="line">               <span class="comment">// æ‰§è¡Œåˆ›å»º Bean</span></span><br><span class="line">               prototypeInstance = createBean(beanName, mbd, args);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span> &#123;</span><br><span class="line">               afterPrototypeCreation(beanName);</span><br><span class="line">            &#125;</span><br><span class="line">            bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// å¦‚æœä¸æ˜¯ singleton å’Œ prototype çš„è¯ï¼Œéœ€è¦å§”æ‰˜ç»™ç›¸åº”çš„å®ç°ç±»æ¥å¤„ç†</span></span><br><span class="line">         <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">scopeName</span> <span class="operator">=</span> mbd.getScope();</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Scope</span> <span class="variable">scope</span> <span class="operator">=</span> <span class="built_in">this</span>.scopes.get(scopeName);</span><br><span class="line">            <span class="keyword">if</span> (scope == <span class="literal">null</span>) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;No Scope registered for scope name &#x27;&quot;</span> + scopeName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="type">Object</span> <span class="variable">scopedInstance</span> <span class="operator">=</span> scope.get(beanName, <span class="keyword">new</span> <span class="title class_">ObjectFactory</span>&lt;Object&gt;() &#123;</span><br><span class="line">                  <span class="meta">@Override</span></span><br><span class="line">                  <span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">                     beforePrototypeCreation(beanName);</span><br><span class="line">                     <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// æ‰§è¡Œåˆ›å»º Bean</span></span><br><span class="line">                        <span class="keyword">return</span> createBean(beanName, mbd, args);</span><br><span class="line">                     &#125;</span><br><span class="line">                     <span class="keyword">finally</span> &#123;</span><br><span class="line">                        afterPrototypeCreation(beanName);</span><br><span class="line">                     &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">               &#125;);</span><br><span class="line">               bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (IllegalStateException ex) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(beanName,</span><br><span class="line">                     <span class="string">&quot;Scope &#x27;&quot;</span> + scopeName + <span class="string">&quot;&#x27; is not active for the current thread; consider &quot;</span> +</span><br><span class="line">                     <span class="string">&quot;defining a scoped proxy for this bean if you intend to refer to it from a singleton&quot;</span>,</span><br><span class="line">                     ex);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">         cleanupAfterBeanCreationFailure(beanName);</span><br><span class="line">         <span class="keyword">throw</span> ex;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// æœ€åï¼Œæ£€æŸ¥ä¸€ä¸‹ç±»å‹å¯¹ä¸å¯¹ï¼Œä¸å¯¹çš„è¯å°±æŠ›å¼‚å¸¸ï¼Œå¯¹çš„è¯å°±è¿”å›äº†</span></span><br><span class="line">   <span class="keyword">if</span> (requiredType != <span class="literal">null</span> &amp;&amp; bean != <span class="literal">null</span> &amp;&amp; !requiredType.isInstance(bean)) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> getTypeConverter().convertIfNecessary(bean, requiredType);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (TypeMismatchException ex) &#123;</span><br><span class="line">         <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(<span class="string">&quot;Failed to convert bean &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; to required type &#x27;&quot;</span> +</span><br><span class="line">                  ClassUtils.getQualifiedName(requiredType) + <span class="string">&quot;&#x27;&quot;</span>, ex);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanNotOfRequiredTypeException</span>(name, requiredType, bean.getClass());</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> (T) bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¤§å®¶åº”è¯¥ä¹ŸçŒœåˆ°äº†ï¼Œæ¥ä¸‹æ¥å½“ç„¶æ˜¯åˆ†æ createBean æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> Object <span class="title function_">createBean</span><span class="params">(String beanName, RootBeanDefinition mbd, Object[] args)</span> <span class="keyword">throws</span> BeanCreationException;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸‰ä¸ªå‚æ•° args æ•°ç»„ä»£è¡¨åˆ›å»ºå®ä¾‹éœ€è¦çš„å‚æ•°ï¼Œä¸å°±æ˜¯ç»™æ„é€ æ–¹æ³•ç”¨çš„å‚æ•°ï¼Œæˆ–è€…æ˜¯å·¥å‚ Bean çš„å‚æ•°å˜›ï¼Œä¸è¿‡è¦æ³¨æ„ï¼Œåœ¨æˆ‘ä»¬çš„åˆå§‹åŒ–é˜¶æ®µï¼Œargs æ˜¯ nullã€‚</p>
<p>è¿™å›æˆ‘ä»¬è¦åˆ°ä¸€ä¸ªæ–°çš„ç±»äº† AbstractAutowireCapableBeanFactoryï¼Œçœ‹ç±»åï¼ŒAutowireCapableï¼Ÿç±»åæ˜¯ä¸æ˜¯ä¹Ÿè¯´æ˜äº†ç‚¹é—®é¢˜äº†ã€‚</p>
<p>ä¸»è¦æ˜¯ä¸ºäº†ä»¥ä¸‹åœºæ™¯ï¼Œé‡‡ç”¨ @Autowired æ³¨è§£æ³¨å…¥å±æ€§å€¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">MessageService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userService.getMessage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;messageService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.javadoop.example.MessageServiceImpl&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šè¿™ç§å±äºæ··ç”¨äº† xml å’Œ æ³¨è§£ ä¸¤ç§æ–¹å¼çš„é…ç½®æ–¹å¼ï¼ŒSpring ä¼šå¤„ç†è¿™ç§æƒ…å†µã€‚</p>
<p>å¥½äº†ï¼Œè¯»è€…è¦çŸ¥é“è¿™ä¹ˆå›äº‹å°±å¯ä»¥äº†ï¼Œç»§ç»­å‘å‰ã€‚</p>
<p>// AbstractAutowireCapableBeanFactory 447</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Central method of this class: creates a bean instance,</span></span><br><span class="line"><span class="comment"> * populates the bean instance, applies post-processors, etc.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #doCreateBean</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">createBean</span><span class="params">(String beanName, RootBeanDefinition mbd, Object[] args)</span> <span class="keyword">throws</span> BeanCreationException &#123;</span><br><span class="line">   <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;Creating instance of bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="type">RootBeanDefinition</span> <span class="variable">mbdToUse</span> <span class="operator">=</span> mbd;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// ç¡®ä¿ BeanDefinition ä¸­çš„ Class è¢«åŠ è½½</span></span><br><span class="line">   Class&lt;?&gt; resolvedClass = resolveBeanClass(mbd, beanName);</span><br><span class="line">   <span class="keyword">if</span> (resolvedClass != <span class="literal">null</span> &amp;&amp; !mbd.hasBeanClass() &amp;&amp; mbd.getBeanClassName() != <span class="literal">null</span>) &#123;</span><br><span class="line">      mbdToUse = <span class="keyword">new</span> <span class="title class_">RootBeanDefinition</span>(mbd);</span><br><span class="line">      mbdToUse.setBeanClass(resolvedClass);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// å‡†å¤‡æ–¹æ³•è¦†å†™ï¼Œè¿™é‡Œåˆæ¶‰åŠåˆ°ä¸€ä¸ªæ¦‚å¿µï¼šMethodOverridesï¼Œå®ƒæ¥è‡ªäº bean å®šä¹‰ä¸­çš„ &lt;lookup-method /&gt; </span></span><br><span class="line">   <span class="comment">// å’Œ &lt;replaced-method /&gt;ï¼Œå¦‚æœè¯»è€…æ„Ÿå…´è¶£ï¼Œå›åˆ° bean è§£æçš„åœ°æ–¹çœ‹çœ‹å¯¹è¿™ä¸¤ä¸ªæ ‡ç­¾çš„è§£æã€‚</span></span><br><span class="line">   <span class="comment">// æˆ‘åœ¨é™„å½•ä¸­ä¹Ÿå¯¹è¿™ä¸¤ä¸ªæ ‡ç­¾çš„ç›¸å…³çŸ¥è¯†ç‚¹è¿›è¡Œäº†ä»‹ç»ï¼Œè¯»è€…å¯ä»¥ç§»æ­¥å»çœ‹çœ‹</span></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      mbdToUse.prepareMethodOverrides();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanDefinitionStoreException</span>(mbdToUse.getResourceDescription(),</span><br><span class="line">            beanName, <span class="string">&quot;Validation of method overrides failed&quot;</span>, ex);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// è®© InstantiationAwareBeanPostProcessor åœ¨è¿™ä¸€æ­¥æœ‰æœºä¼šè¿”å›ä»£ç†ï¼Œ</span></span><br><span class="line">      <span class="comment">// åœ¨ ã€ŠSpring AOP æºç åˆ†æã€‹é‚£ç¯‡æ–‡ç« ä¸­æœ‰è§£é‡Šï¼Œè¿™é‡Œå…ˆè·³è¿‡</span></span><br><span class="line">      <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> resolveBeforeInstantiation(beanName, mbdToUse);</span><br><span class="line">      <span class="keyword">if</span> (bean != <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span> bean; </span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(mbdToUse.getResourceDescription(), beanName,</span><br><span class="line">            <span class="string">&quot;BeanPostProcessor before instantiation of bean failed&quot;</span>, ex);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// é‡å¤´æˆï¼Œåˆ›å»º bean</span></span><br><span class="line">   <span class="type">Object</span> <span class="variable">beanInstance</span> <span class="operator">=</span> doCreateBean(beanName, mbdToUse, args);</span><br><span class="line">   <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;Finished creating instance of bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> beanInstance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="åˆ›å»º-Bean"><a href="#åˆ›å»º-Bean" class="headerlink" title="åˆ›å»º Bean"></a>åˆ›å»º Bean</h4><p>æˆ‘ä»¬ç»§ç»­å¾€é‡Œçœ‹ doCreateBean è¿™ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Actually create the specified bean. Pre-creation processing has already happened</span></span><br><span class="line"><span class="comment"> * at this point, e.g. checking &#123;<span class="doctag">@code</span> postProcessBeforeInstantiation&#125; callbacks.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Differentiates between default bean instantiation, use of a</span></span><br><span class="line"><span class="comment"> * factory method, and autowiring a constructor.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> beanName the name of the bean</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mbd the merged bean definition for the bean</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> args explicit arguments to use for constructor or factory method invocation</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> a new instance of the bean</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> BeanCreationException if the bean could not be created</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #instantiateBean</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #instantiateUsingFactoryMethod</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #autowireConstructor</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">doCreateBean</span><span class="params">(<span class="keyword">final</span> String beanName, <span class="keyword">final</span> RootBeanDefinition mbd, <span class="keyword">final</span> Object[] args)</span></span><br><span class="line">      <span class="keyword">throws</span> BeanCreationException &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Instantiate the bean.</span></span><br><span class="line">   <span class="type">BeanWrapper</span> <span class="variable">instanceWrapper</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">   <span class="keyword">if</span> (mbd.isSingleton()) &#123;</span><br><span class="line">      instanceWrapper = <span class="built_in">this</span>.factoryBeanInstanceCache.remove(beanName);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (instanceWrapper == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// è¯´æ˜ä¸æ˜¯ FactoryBeanï¼Œè¿™é‡Œå®ä¾‹åŒ– Beanï¼Œè¿™é‡Œéå¸¸å…³é”®ï¼Œç»†èŠ‚ä¹‹åå†è¯´</span></span><br><span class="line">      instanceWrapper = createBeanInstance(beanName, mbd, args);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// è¿™ä¸ªå°±æ˜¯ Bean é‡Œé¢çš„ æˆ‘ä»¬å®šä¹‰çš„ç±» çš„å®ä¾‹ï¼Œå¾ˆå¤šåœ°æ–¹æˆ‘ç›´æ¥æè¿°æˆ &quot;bean å®ä¾‹&quot;</span></span><br><span class="line">   <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> (instanceWrapper != <span class="literal">null</span> ? instanceWrapper.getWrappedInstance() : <span class="literal">null</span>);</span><br><span class="line">   <span class="comment">// ç±»å‹</span></span><br><span class="line">   Class&lt;?&gt; beanType = (instanceWrapper != <span class="literal">null</span> ? instanceWrapper.getWrappedClass() : <span class="literal">null</span>);</span><br><span class="line">   mbd.resolvedTargetType = beanType;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// å»ºè®®è·³è¿‡å§ï¼Œæ¶‰åŠæ¥å£ï¼šMergedBeanDefinitionPostProcessor</span></span><br><span class="line">   <span class="keyword">synchronized</span> (mbd.postProcessingLock) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!mbd.postProcessed) &#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// MergedBeanDefinitionPostProcessorï¼Œè¿™ä¸ªæˆ‘çœŸä¸å±•å¼€è¯´äº†ï¼Œç›´æ¥è·³è¿‡å§ï¼Œå¾ˆå°‘ç”¨çš„</span></span><br><span class="line">            applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,</span><br><span class="line">                  <span class="string">&quot;Post-processing of merged bean definition failed&quot;</span>, ex);</span><br><span class="line">         &#125;</span><br><span class="line">         mbd.postProcessed = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Eagerly cache singletons to be able to resolve circular references</span></span><br><span class="line">   <span class="comment">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span></span><br><span class="line">   <span class="comment">// ä¸‹é¢è¿™å—ä»£ç æ˜¯ä¸ºäº†è§£å†³å¾ªç¯ä¾èµ–çš„é—®é¢˜ï¼Œä»¥åæœ‰æ—¶é—´ï¼Œæˆ‘å†å¯¹å¾ªç¯ä¾èµ–è¿™ä¸ªé—®é¢˜è¿›è¡Œè§£æå§</span></span><br><span class="line">   <span class="type">boolean</span> <span class="variable">earlySingletonExposure</span> <span class="operator">=</span> (mbd.isSingleton() &amp;&amp; <span class="built_in">this</span>.allowCircularReferences &amp;&amp;</span><br><span class="line">         isSingletonCurrentlyInCreation(beanName));</span><br><span class="line">   <span class="keyword">if</span> (earlySingletonExposure) &#123;</span><br><span class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">         logger.debug(<span class="string">&quot;Eagerly caching bean &#x27;&quot;</span> + beanName +</span><br><span class="line">               <span class="string">&quot;&#x27; to allow for resolving potential circular references&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      addSingletonFactory(beanName, <span class="keyword">new</span> <span class="title class_">ObjectFactory</span>&lt;Object&gt;() &#123;</span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">            <span class="keyword">return</span> getEarlyBeanReference(beanName, mbd, bean);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Initialize the bean instance.</span></span><br><span class="line">   <span class="type">Object</span> <span class="variable">exposedObject</span> <span class="operator">=</span> bean;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// è¿™ä¸€æ­¥ä¹Ÿæ˜¯éå¸¸å…³é”®çš„ï¼Œè¿™ä¸€æ­¥è´Ÿè´£å±æ€§è£…é…ï¼Œå› ä¸ºå‰é¢çš„å®ä¾‹åªæ˜¯å®ä¾‹åŒ–äº†ï¼Œå¹¶æ²¡æœ‰è®¾å€¼ï¼Œè¿™é‡Œå°±æ˜¯è®¾å€¼</span></span><br><span class="line">      populateBean(beanName, mbd, instanceWrapper);</span><br><span class="line">      <span class="keyword">if</span> (exposedObject != <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="comment">// è¿˜è®°å¾— init-method å—ï¼Ÿè¿˜æœ‰ InitializingBean æ¥å£ï¼Ÿè¿˜æœ‰ BeanPostProcessor æ¥å£ï¼Ÿ</span></span><br><span class="line">         <span class="comment">// è¿™é‡Œå°±æ˜¯å¤„ç† bean åˆå§‹åŒ–å®Œæˆåçš„å„ç§å›è°ƒ</span></span><br><span class="line">         exposedObject = initializeBean(beanName, exposedObject, mbd);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">      <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123;</span><br><span class="line">         <span class="keyword">throw</span> (BeanCreationException) ex;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(</span><br><span class="line">               mbd.getResourceDescription(), beanName, <span class="string">&quot;Initialization of bean failed&quot;</span>, ex);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (earlySingletonExposure) &#123;</span><br><span class="line">      <span class="comment">// </span></span><br><span class="line">      <span class="type">Object</span> <span class="variable">earlySingletonReference</span> <span class="operator">=</span> getSingleton(beanName, <span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">if</span> (earlySingletonReference != <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="keyword">if</span> (exposedObject == bean) &#123;</span><br><span class="line">            exposedObject = earlySingletonReference;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">this</span>.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123;</span><br><span class="line">            String[] dependentBeans = getDependentBeans(beanName);</span><br><span class="line">            Set&lt;String&gt; actualDependentBeans = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;String&gt;(dependentBeans.length);</span><br><span class="line">            <span class="keyword">for</span> (String dependentBean : dependentBeans) &#123;</span><br><span class="line">               <span class="keyword">if</span> (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123;</span><br><span class="line">                  actualDependentBeans.add(dependentBean);</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!actualDependentBeans.isEmpty()) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCurrentlyInCreationException</span>(beanName,</span><br><span class="line">                     <span class="string">&quot;Bean with name &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27; has been injected into other beans [&quot;</span> +</span><br><span class="line">                     StringUtils.collectionToCommaDelimitedString(actualDependentBeans) +</span><br><span class="line">                     <span class="string">&quot;] in its raw version as part of a circular reference, but has eventually been &quot;</span> +</span><br><span class="line">                     <span class="string">&quot;wrapped. This means that said other beans do not use the final version of the &quot;</span> +</span><br><span class="line">                     <span class="string">&quot;bean. This is often the result of over-eager type matching - consider using &quot;</span> +</span><br><span class="line">                     <span class="string">&quot;&#x27;getBeanNamesOfType&#x27; with the &#x27;allowEagerInit&#x27; flag turned off, for example.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Register bean as disposable.</span></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      registerDisposableBeanIfNecessary(beanName, bean, mbd);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(</span><br><span class="line">            mbd.getResourceDescription(), beanName, <span class="string">&quot;Invalid destruction signature&quot;</span>, ex);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> exposedObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»åˆ†æå®Œäº† doCreateBean æ–¹æ³•ï¼Œæ€»çš„æ¥è¯´ï¼Œæˆ‘ä»¬å·²ç»è¯´å®Œäº†æ•´ä¸ªåˆå§‹åŒ–æµç¨‹ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æŒ‘ doCreateBean ä¸­çš„ä¸‰ä¸ªç»†èŠ‚å‡ºæ¥è¯´è¯´ã€‚ä¸€ä¸ªæ˜¯åˆ›å»º Bean å®ä¾‹çš„ createBeanInstance æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯ä¾èµ–æ³¨å…¥çš„ populateBean æ–¹æ³•ï¼Œè¿˜æœ‰å°±æ˜¯å›è°ƒæ–¹æ³• initializeBeanã€‚ </p>
<p>æ³¨æ„äº†ï¼Œæ¥ä¸‹æ¥çš„è¿™ä¸‰ä¸ªæ–¹æ³•è¦è®¤çœŸè¯´é‚£ä¹Ÿæ˜¯æå…¶å¤æ‚çš„ï¼Œå¾ˆå¤šåœ°æ–¹æˆ‘å°±ç‚¹åˆ°ä¸ºæ­¢äº†ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è‡ªå·±å¾€é‡Œçœ‹ï¼Œæœ€å¥½å°±æ˜¯ç¢°åˆ°ä¸æ‡‚çš„ï¼Œè‡ªå·±å†™ä»£ç å»è°ƒè¯•å®ƒã€‚</p>
<h5 id="åˆ›å»º-Bean-å®ä¾‹"><a href="#åˆ›å»º-Bean-å®ä¾‹" class="headerlink" title="åˆ›å»º Bean å®ä¾‹"></a>åˆ›å»º Bean å®ä¾‹</h5><p>æˆ‘ä»¬å…ˆçœ‹çœ‹ createBeanInstance æ–¹æ³•ã€‚éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•å¦‚æœæ¯ä¸ªåˆ†æ”¯éƒ½åˆ†æä¸‹å»ï¼Œå¿…ç„¶ä¹Ÿæ˜¯æå…¶å¤æ‚å†—é•¿çš„ï¼Œæˆ‘ä»¬æŒ‘é‡ç‚¹è¯´ã€‚æ­¤æ–¹æ³•çš„ç›®çš„å°±æ˜¯å®ä¾‹åŒ–æˆ‘ä»¬æŒ‡å®šçš„ç±»ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> BeanWrapper <span class="title function_">createBeanInstance</span><span class="params">(String beanName, RootBeanDefinition mbd, Object[] args)</span> &#123;</span><br><span class="line">   <span class="comment">// ç¡®ä¿å·²ç»åŠ è½½äº†æ­¤ class</span></span><br><span class="line">   Class&lt;?&gt; beanClass = resolveBeanClass(mbd, beanName);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// æ ¡éªŒä¸€ä¸‹è¿™ä¸ªç±»çš„è®¿é—®æƒé™</span></span><br><span class="line">   <span class="keyword">if</span> (beanClass != <span class="literal">null</span> &amp;&amp; !Modifier.isPublic(beanClass.getModifiers()) &amp;&amp; !mbd.isNonPublicAccessAllowed()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,</span><br><span class="line">            <span class="string">&quot;Bean class isn&#x27;t public, and non-public access not allowed: &quot;</span> + beanClass.getName());</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (mbd.getFactoryMethodName() != <span class="literal">null</span>)  &#123;</span><br><span class="line">      <span class="comment">// é‡‡ç”¨å·¥å‚æ–¹æ³•å®ä¾‹åŒ–ï¼Œä¸ç†Ÿæ‚‰è¿™ä¸ªæ¦‚å¿µçš„è¯»è€…è¯·çœ‹é™„å½•ï¼Œæ³¨æ„ï¼Œä¸æ˜¯ FactoryBean</span></span><br><span class="line">      <span class="keyword">return</span> instantiateUsingFactoryMethod(beanName, mbd, args);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºï¼Œæ¯”å¦‚ç¬¬äºŒæ¬¡åˆ›å»º prototype beanã€‚</span></span><br><span class="line">   <span class="comment">// è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä»ç¬¬ä¸€æ¬¡åˆ›å»ºçŸ¥é“ï¼Œé‡‡ç”¨æ— å‚æ„é€ å‡½æ•°ï¼Œè¿˜æ˜¯æ„é€ å‡½æ•°ä¾èµ–æ³¨å…¥ æ¥å®Œæˆå®ä¾‹åŒ–</span></span><br><span class="line">   <span class="type">boolean</span> <span class="variable">resolved</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">   <span class="type">boolean</span> <span class="variable">autowireNecessary</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">   <span class="keyword">if</span> (args == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (mbd.constructorArgumentLock) &#123;</span><br><span class="line">         <span class="keyword">if</span> (mbd.resolvedConstructorOrFactoryMethod != <span class="literal">null</span>) &#123;</span><br><span class="line">            resolved = <span class="literal">true</span>;</span><br><span class="line">            autowireNecessary = mbd.constructorArgumentsResolved;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (resolved) &#123;</span><br><span class="line">      <span class="keyword">if</span> (autowireNecessary) &#123;</span><br><span class="line">         <span class="comment">// æ„é€ å‡½æ•°ä¾èµ–æ³¨å…¥</span></span><br><span class="line">         <span class="keyword">return</span> autowireConstructor(beanName, mbd, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="comment">// æ— å‚æ„é€ å‡½æ•°</span></span><br><span class="line">         <span class="keyword">return</span> instantiateBean(beanName, mbd);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// åˆ¤æ–­æ˜¯å¦é‡‡ç”¨æœ‰å‚æ„é€ å‡½æ•°</span></span><br><span class="line">   Constructor&lt;?&gt;[] ctors = determineConstructorsFromBeanPostProcessors(beanClass, beanName);</span><br><span class="line">   <span class="keyword">if</span> (ctors != <span class="literal">null</span> ||</span><br><span class="line">         mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_CONSTRUCTOR ||</span><br><span class="line">         mbd.hasConstructorArgumentValues() || !ObjectUtils.isEmpty(args))  &#123;</span><br><span class="line">      <span class="comment">// æ„é€ å‡½æ•°ä¾èµ–æ³¨å…¥</span></span><br><span class="line">      <span class="keyword">return</span> autowireConstructor(beanName, mbd, ctors, args);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// è°ƒç”¨æ— å‚æ„é€ å‡½æ•°</span></span><br><span class="line">   <span class="keyword">return</span> instantiateBean(beanName, mbd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æŒ‘ä¸ªç®€å•çš„<strong>æ— å‚æ„é€ å‡½æ•°</strong>æ„é€ å®ä¾‹æ¥çœ‹çœ‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> BeanWrapper <span class="title function_">instantiateBean</span><span class="params">(<span class="keyword">final</span> String beanName, <span class="keyword">final</span> RootBeanDefinition mbd)</span> &#123;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      Object beanInstance;</span><br><span class="line">      <span class="keyword">final</span> <span class="type">BeanFactory</span> <span class="variable">parent</span> <span class="operator">=</span> <span class="built_in">this</span>;</span><br><span class="line">      <span class="keyword">if</span> (System.getSecurityManager() != <span class="literal">null</span>) &#123;</span><br><span class="line">         beanInstance = AccessController.doPrivileged(<span class="keyword">new</span> <span class="title class_">PrivilegedAction</span>&lt;Object&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Object <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">               </span><br><span class="line">               <span class="keyword">return</span> getInstantiationStrategy().instantiate(mbd, beanName, parent);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;, getAccessControlContext());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="comment">// å®ä¾‹åŒ–</span></span><br><span class="line">         beanInstance = getInstantiationStrategy().instantiate(mbd, beanName, parent);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// åŒ…è£…ä¸€ä¸‹ï¼Œè¿”å›</span></span><br><span class="line">      <span class="type">BeanWrapper</span> <span class="variable">bw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanWrapperImpl</span>(beanInstance);</span><br><span class="line">      initBeanWrapper(bw);</span><br><span class="line">      <span class="keyword">return</span> bw;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(</span><br><span class="line">            mbd.getResourceDescription(), beanName, <span class="string">&quot;Instantiation of bean failed&quot;</span>, ex);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå…³é”®çš„åœ°æ–¹åœ¨äºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">beanInstance = getInstantiationStrategy().instantiate(mbd, beanName, parent);</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¼šè¿›è¡Œå®é™…çš„å®ä¾‹åŒ–è¿‡ç¨‹ï¼Œæˆ‘ä»¬è¿›å»çœ‹çœ‹:</p>
<p>// SimpleInstantiationStrategy 59</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">instantiate</span><span class="params">(RootBeanDefinition bd, String beanName, BeanFactory owner)</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// å¦‚æœä¸å­˜åœ¨æ–¹æ³•è¦†å†™ï¼Œé‚£å°±ä½¿ç”¨ java åå°„è¿›è¡Œå®ä¾‹åŒ–ï¼Œå¦åˆ™ä½¿ç”¨ CGLIB,</span></span><br><span class="line">   <span class="comment">// æ–¹æ³•è¦†å†™ è¯·å‚è§é™„å½•&quot;æ–¹æ³•æ³¨å…¥&quot;ä¸­å¯¹ lookup-method å’Œ replaced-method çš„ä»‹ç»</span></span><br><span class="line">   <span class="keyword">if</span> (bd.getMethodOverrides().isEmpty()) &#123;</span><br><span class="line">      Constructor&lt;?&gt; constructorToUse;</span><br><span class="line">      <span class="keyword">synchronized</span> (bd.constructorArgumentLock) &#123;</span><br><span class="line">         constructorToUse = (Constructor&lt;?&gt;) bd.resolvedConstructorOrFactoryMethod;</span><br><span class="line">         <span class="keyword">if</span> (constructorToUse == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> Class&lt;?&gt; clazz = bd.getBeanClass();</span><br><span class="line">            <span class="keyword">if</span> (clazz.isInterface()) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanInstantiationException</span>(clazz, <span class="string">&quot;Specified class is an interface&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> (System.getSecurityManager() != <span class="literal">null</span>) &#123;</span><br><span class="line">                  constructorToUse = AccessController.doPrivileged(<span class="keyword">new</span> <span class="title class_">PrivilegedExceptionAction</span>&lt;Constructor&lt;?&gt;&gt;() &#123;</span><br><span class="line">                     <span class="meta">@Override</span></span><br><span class="line">                     <span class="keyword">public</span> Constructor&lt;?&gt; run() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        <span class="keyword">return</span> clazz.getDeclaredConstructor((Class[]) <span class="literal">null</span>);</span><br><span class="line">                     &#125;</span><br><span class="line">                  &#125;);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">else</span> &#123;</span><br><span class="line">                  constructorToUse = clazz.getDeclaredConstructor((Class[]) <span class="literal">null</span>);</span><br><span class="line">               &#125;</span><br><span class="line">               bd.resolvedConstructorOrFactoryMethod = constructorToUse;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanInstantiationException</span>(clazz, <span class="string">&quot;No default constructor found&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// åˆ©ç”¨æ„é€ æ–¹æ³•è¿›è¡Œå®ä¾‹åŒ–</span></span><br><span class="line">      <span class="keyword">return</span> BeanUtils.instantiateClass(constructorToUse);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// å­˜åœ¨æ–¹æ³•è¦†å†™ï¼Œåˆ©ç”¨ CGLIB æ¥å®Œæˆå®ä¾‹åŒ–ï¼Œéœ€è¦ä¾èµ–äº CGLIB ç”Ÿæˆå­ç±»ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚</span></span><br><span class="line">      <span class="comment">// tips: å› ä¸ºå¦‚æœä¸ä½¿ç”¨ CGLIB çš„è¯ï¼Œå­˜åœ¨ override çš„æƒ…å†µ JDK å¹¶æ²¡æœ‰æä¾›ç›¸åº”çš„å®ä¾‹åŒ–æ”¯æŒ</span></span><br><span class="line">      <span class="keyword">return</span> instantiateWithMethodInjection(bd, beanName, owner);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±ç®—å®ä¾‹åŒ–å®Œæˆäº†ã€‚æˆ‘ä»¬å¼€å§‹è¯´æ€ä¹ˆè¿›è¡Œå±æ€§æ³¨å…¥ã€‚</p>
<h5 id="bean-å±æ€§æ³¨å…¥"><a href="#bean-å±æ€§æ³¨å…¥" class="headerlink" title="bean å±æ€§æ³¨å…¥"></a>bean å±æ€§æ³¨å…¥</h5><p>çœ‹å®Œäº† createBeanInstance(â€¦) æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ populateBean(â€¦) æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è´Ÿè´£è¿›è¡Œå±æ€§è®¾å€¼ï¼Œå¤„ç†ä¾èµ–ã€‚</p>
<p>// AbstractAutowireCapableBeanFactory 1203</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">populateBean</span><span class="params">(String beanName, RootBeanDefinition mbd, BeanWrapper bw)</span> &#123;</span><br><span class="line">   <span class="comment">// bean å®ä¾‹çš„æ‰€æœ‰å±æ€§éƒ½åœ¨è¿™é‡Œäº†</span></span><br><span class="line">   <span class="type">PropertyValues</span> <span class="variable">pvs</span> <span class="operator">=</span> mbd.getPropertyValues();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (bw == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!pvs.isEmpty()) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(</span><br><span class="line">               mbd.getResourceDescription(), beanName, <span class="string">&quot;Cannot apply property values to null instance&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="comment">// Skip property population phase for null instance.</span></span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// åˆ°è¿™æ­¥çš„æ—¶å€™ï¼Œbean å®ä¾‹åŒ–å®Œæˆï¼ˆé€šè¿‡å·¥å‚æ–¹æ³•æˆ–æ„é€ æ–¹æ³•ï¼‰ï¼Œä½†æ˜¯è¿˜æ²¡å¼€å§‹å±æ€§è®¾å€¼ï¼Œ</span></span><br><span class="line">   <span class="comment">// InstantiationAwareBeanPostProcessor çš„å®ç°ç±»å¯ä»¥åœ¨è¿™é‡Œå¯¹ bean è¿›è¡ŒçŠ¶æ€ä¿®æ”¹ï¼Œ</span></span><br><span class="line">   <span class="comment">// æˆ‘ä¹Ÿæ²¡æ‰¾åˆ°æœ‰å®é™…çš„ä½¿ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬æš‚ä¸”å¿½ç•¥è¿™å—å§</span></span><br><span class="line">   <span class="type">boolean</span> <span class="variable">continueWithPropertyPopulation</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">   <span class="keyword">if</span> (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;</span><br><span class="line">      <span class="keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;</span><br><span class="line">         <span class="keyword">if</span> (bp <span class="keyword">instanceof</span> InstantiationAwareBeanPostProcessor) &#123;</span><br><span class="line">            <span class="type">InstantiationAwareBeanPostProcessor</span> <span class="variable">ibp</span> <span class="operator">=</span> (InstantiationAwareBeanPostProcessor) bp;</span><br><span class="line">            <span class="comment">// å¦‚æœè¿”å› falseï¼Œä»£è¡¨ä¸éœ€è¦è¿›è¡Œåç»­çš„å±æ€§è®¾å€¼ï¼Œä¹Ÿä¸éœ€è¦å†ç»è¿‡å…¶ä»–çš„ BeanPostProcessor çš„å¤„ç†</span></span><br><span class="line">            <span class="keyword">if</span> (!ibp.postProcessAfterInstantiation(bw.getWrappedInstance(), beanName)) &#123;</span><br><span class="line">               continueWithPropertyPopulation = <span class="literal">false</span>;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (!continueWithPropertyPopulation) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_NAME ||</span><br><span class="line">         mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_TYPE) &#123;</span><br><span class="line">      <span class="type">MutablePropertyValues</span> <span class="variable">newPvs</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MutablePropertyValues</span>(pvs);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// é€šè¿‡åå­—æ‰¾åˆ°æ‰€æœ‰å±æ€§å€¼ï¼Œå¦‚æœæ˜¯ bean ä¾èµ–ï¼Œå…ˆåˆå§‹åŒ–ä¾èµ–çš„ beanã€‚è®°å½•ä¾èµ–å…³ç³»</span></span><br><span class="line">      <span class="keyword">if</span> (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_NAME) &#123;</span><br><span class="line">         autowireByName(beanName, mbd, bw, newPvs);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// é€šè¿‡ç±»å‹è£…é…ã€‚å¤æ‚ä¸€äº›</span></span><br><span class="line">      <span class="keyword">if</span> (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_TYPE) &#123;</span><br><span class="line">         autowireByType(beanName, mbd, bw, newPvs);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      pvs = newPvs;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="type">boolean</span> <span class="variable">hasInstAwareBpps</span> <span class="operator">=</span> hasInstantiationAwareBeanPostProcessors();</span><br><span class="line">   <span class="type">boolean</span> <span class="variable">needsDepCheck</span> <span class="operator">=</span> (mbd.getDependencyCheck() != RootBeanDefinition.DEPENDENCY_CHECK_NONE);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (hasInstAwareBpps || needsDepCheck) &#123;</span><br><span class="line">      PropertyDescriptor[] filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching);</span><br><span class="line">      <span class="keyword">if</span> (hasInstAwareBpps) &#123;</span><br><span class="line">         <span class="keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (bp <span class="keyword">instanceof</span> InstantiationAwareBeanPostProcessor) &#123;</span><br><span class="line">               <span class="type">InstantiationAwareBeanPostProcessor</span> <span class="variable">ibp</span> <span class="operator">=</span> (InstantiationAwareBeanPostProcessor) bp;</span><br><span class="line">               <span class="comment">// è¿™é‡Œæœ‰ä¸ªéå¸¸æœ‰ç”¨çš„ BeanPostProcessor è¿›åˆ°è¿™é‡Œ: AutowiredAnnotationBeanPostProcessor</span></span><br><span class="line">               <span class="comment">// å¯¹é‡‡ç”¨ @Autowiredã€@Value æ³¨è§£çš„ä¾èµ–è¿›è¡Œè®¾å€¼ï¼Œè¿™é‡Œçš„å†…å®¹ä¹Ÿæ˜¯éå¸¸ä¸°å¯Œçš„ï¼Œä¸è¿‡æœ¬æ–‡ä¸ä¼šå±•å¼€è¯´äº†ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…è¯·è‡ªè¡Œç ”ç©¶</span></span><br><span class="line">               pvs = ibp.postProcessPropertyValues(pvs, filteredPds, bw.getWrappedInstance(), beanName);</span><br><span class="line">               <span class="keyword">if</span> (pvs == <span class="literal">null</span>) &#123;</span><br><span class="line">                  <span class="keyword">return</span>;</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (needsDepCheck) &#123;</span><br><span class="line">         checkDependencies(beanName, mbd, filteredPds, pvs);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// è®¾ç½® bean å®ä¾‹çš„å±æ€§å€¼</span></span><br><span class="line">   applyPropertyValues(beanName, mbd, bw, pvs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="initializeBean"><a href="#initializeBean" class="headerlink" title="initializeBean"></a>initializeBean</h5><p>å±æ€§æ³¨å…¥å®Œæˆåï¼Œè¿™ä¸€æ­¥å…¶å®å°±æ˜¯å¤„ç†å„ç§å›è°ƒäº†ï¼Œè¿™å—ä»£ç æ¯”è¾ƒç®€å•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">initializeBean</span><span class="params">(<span class="keyword">final</span> String beanName, <span class="keyword">final</span> Object bean, RootBeanDefinition mbd)</span> &#123;</span><br><span class="line">   <span class="keyword">if</span> (System.getSecurityManager() != <span class="literal">null</span>) &#123;</span><br><span class="line">      AccessController.doPrivileged(<span class="keyword">new</span> <span class="title class_">PrivilegedAction</span>&lt;Object&gt;() &#123;</span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="keyword">public</span> Object <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            invokeAwareMethods(beanName, bean);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;, getAccessControlContext());</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœ bean å®ç°äº† BeanNameAwareã€BeanClassLoaderAware æˆ– BeanFactoryAware æ¥å£ï¼Œå›è°ƒ</span></span><br><span class="line">      invokeAwareMethods(beanName, bean);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="type">Object</span> <span class="variable">wrappedBean</span> <span class="operator">=</span> bean;</span><br><span class="line">   <span class="keyword">if</span> (mbd == <span class="literal">null</span> || !mbd.isSynthetic()) &#123;</span><br><span class="line">      <span class="comment">// BeanPostProcessor çš„ postProcessBeforeInitialization å›è°ƒ</span></span><br><span class="line">      wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// å¤„ç† bean ä¸­å®šä¹‰çš„ init-methodï¼Œ</span></span><br><span class="line">      <span class="comment">// æˆ–è€…å¦‚æœ bean å®ç°äº† InitializingBean æ¥å£ï¼Œè°ƒç”¨ afterPropertiesSet() æ–¹æ³•</span></span><br><span class="line">      invokeInitMethods(beanName, wrappedBean, mbd);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(</span><br><span class="line">            (mbd != <span class="literal">null</span> ? mbd.getResourceDescription() : <span class="literal">null</span>),</span><br><span class="line">            beanName, <span class="string">&quot;Invocation of init method failed&quot;</span>, ex);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (mbd == <span class="literal">null</span> || !mbd.isSynthetic()) &#123;</span><br><span class="line">      <span class="comment">// BeanPostProcessor çš„ postProcessAfterInitialization å›è°ƒ</span></span><br><span class="line">      wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> wrappedBean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¤§å®¶å‘ç°æ²¡æœ‰ï¼ŒBeanPostProcessor çš„ä¸¤ä¸ªå›è°ƒéƒ½å‘ç”Ÿåœ¨è¿™è¾¹ï¼Œåªä¸è¿‡ä¸­é—´å¤„ç†äº† init-methodï¼Œæ˜¯ä¸æ˜¯å’Œè¯»è€…åŸæ¥çš„è®¤çŸ¥æœ‰ç‚¹ä¸ä¸€æ ·äº†ï¼Ÿ</p>
<h2 id="é™„å½•"><a href="#é™„å½•" class="headerlink" title="é™„å½•"></a>é™„å½•</h2><h3 id="id-å’Œ-name"><a href="#id-å’Œ-name" class="headerlink" title="id å’Œ name"></a>id å’Œ name</h3><p>æ¯ä¸ª Bean åœ¨ Spring å®¹å™¨ä¸­éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„åå­—ï¼ˆbeanNameï¼‰å’Œ 0 ä¸ªæˆ–å¤šä¸ªåˆ«åï¼ˆaliasesï¼‰ã€‚</p>
<p>æˆ‘ä»¬ä» Spring å®¹å™¨ä¸­è·å– Bean çš„æ—¶å€™ï¼Œå¯ä»¥æ ¹æ® beanNameï¼Œä¹Ÿå¯ä»¥é€šè¿‡åˆ«åã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">beanFactory.getBean(<span class="string">&quot;beanName or alias&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>åœ¨é…ç½® <code>&lt;bean /&gt;</code> çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é…ç½® id å’Œ nameï¼Œçœ‹å‡ ä¸ªä¾‹å­å°±çŸ¥é“æ˜¯æ€ä¹ˆå›äº‹äº†ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;messageService&quot;</span> <span class="attr">name</span>=<span class="string">&quot;m1, m2, m3&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.javadoop.example.MessageServiceImpl&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šé…ç½®çš„ç»“æœå°±æ˜¯ï¼šbeanName ä¸º messageServiceï¼Œåˆ«åæœ‰ 3 ä¸ªï¼Œåˆ†åˆ«ä¸º m1ã€m2ã€m3ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">&quot;m1, m2, m3&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.javadoop.example.MessageServiceImpl&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šé…ç½®çš„ç»“æœå°±æ˜¯ï¼šbeanName ä¸º m1ï¼Œåˆ«åæœ‰ 2 ä¸ªï¼Œåˆ†åˆ«ä¸º m2ã€m3ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;com.javadoop.example.MessageServiceImpl&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>beanName ä¸ºï¼šcom.javadoop.example.MessageServiceImpl#0ï¼Œ</p>
<p>åˆ«å 1 ä¸ªï¼Œä¸ºï¼š com.javadoop.example.MessageServiceImpl</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;messageService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.javadoop.example.MessageServiceImpl&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šé…ç½®çš„ç»“æœå°±æ˜¯ï¼šbeanName ä¸º messageServiceï¼Œæ²¡æœ‰åˆ«åã€‚</p>
<h3 id="é…ç½®æ˜¯å¦å…è®¸-Bean-è¦†ç›–ã€æ˜¯å¦å…è®¸å¾ªç¯ä¾èµ–"><a href="#é…ç½®æ˜¯å¦å…è®¸-Bean-è¦†ç›–ã€æ˜¯å¦å…è®¸å¾ªç¯ä¾èµ–" class="headerlink" title="é…ç½®æ˜¯å¦å…è®¸ Bean è¦†ç›–ã€æ˜¯å¦å…è®¸å¾ªç¯ä¾èµ–"></a>é…ç½®æ˜¯å¦å…è®¸ Bean è¦†ç›–ã€æ˜¯å¦å…è®¸å¾ªç¯ä¾èµ–</h3><p>æˆ‘ä»¬è¯´è¿‡ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒallowBeanDefinitionOverriding å±æ€§ä¸º nullã€‚å¦‚æœåœ¨åŒä¸€é…ç½®æ–‡ä»¶ä¸­ Bean id æˆ– name é‡å¤äº†ï¼Œä¼šæŠ›é”™ï¼Œä½†æ˜¯å¦‚æœä¸æ˜¯åŒä¸€é…ç½®æ–‡ä»¶ä¸­ï¼Œä¼šå‘ç”Ÿè¦†ç›–ã€‚</p>
<p>å¯æ˜¯æœ‰äº›æ—¶å€™æˆ‘ä»¬å¸Œæœ›åœ¨ç³»ç»Ÿå¯åŠ¨çš„è¿‡ç¨‹ä¸­å°±ä¸¥æ ¼æœç»å‘ç”Ÿ Bean è¦†ç›–ï¼Œå› ä¸ºä¸‡ä¸€å‡ºç°è¿™ç§æƒ…å†µï¼Œä¼šå¢åŠ æˆ‘ä»¬æ’æŸ¥é—®é¢˜çš„æˆæœ¬ã€‚</p>
<p>å¾ªç¯ä¾èµ–è¯´çš„æ˜¯ A ä¾èµ– Bï¼Œè€Œ B åˆä¾èµ– Aã€‚æˆ–è€…æ˜¯ A ä¾èµ– Bï¼ŒB ä¾èµ– Cï¼Œè€Œ C å´ä¾èµ– Aã€‚é»˜è®¤ allowCircularReferences ä¹Ÿæ˜¯ nullã€‚</p>
<p>å®ƒä»¬ä¸¤ä¸ªå±æ€§æ˜¯ä¸€èµ·å‡ºç°çš„ï¼Œå¿…ç„¶å¯ä»¥åœ¨åŒä¸€ä¸ªåœ°æ–¹ä¸€èµ·è¿›è¡Œé…ç½®ã€‚</p>
<p>æ·»åŠ è¿™ä¸¤ä¸ªå±æ€§çš„ä½œè€… Juergen Hoeller åœ¨è¿™ä¸ª <a target="_blank" rel="noopener" href="https://jira.spring.io/browse/SPR-4374">jira</a> çš„è®¨è®ºä¸­è¯´æ˜äº†æ€ä¹ˆé…ç½®è¿™ä¸¤ä¸ªå±æ€§ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NoBeanOverridingContextLoader</span> <span class="keyword">extends</span> <span class="title class_">ContextLoader</span> &#123;</span><br><span class="line"> </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">customizeContext</span><span class="params">(ServletContext servletContext, ConfigurableWebApplicationContext applicationContext)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.customizeContext(servletContext, applicationContext);</span><br><span class="line">    <span class="type">AbstractRefreshableApplicationContext</span> <span class="variable">arac</span> <span class="operator">=</span> (AbstractRefreshableApplicationContext) applicationContext;</span><br><span class="line">    arac.setAllowBeanDefinitionOverriding(<span class="literal">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyContextLoaderListener</span> <span class="keyword">extends</span> <span class="title class_">org</span>.springframework.web.context.ContextLoaderListener &#123;</span><br><span class="line"> </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> ContextLoader <span class="title function_">createContextLoader</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">NoBeanOverridingContextLoader</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>com.javadoop.MyContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœä»¥ä¸Šæ–¹å¼ä¸èƒ½æ»¡è¶³ä½ çš„éœ€æ±‚ï¼Œè¯·å‚è€ƒè¿™ä¸ªé“¾æ¥ï¼š<a target="_blank" rel="noopener" href="http://blog.csdn.net/zgmzyr/article/details/39380477">è§£å†³springä¸­ä¸åŒé…ç½®æ–‡ä»¶ä¸­å­˜åœ¨nameæˆ–è€…idç›¸åŒçš„beanå¯èƒ½å¼•èµ·çš„é—®é¢˜</a></p>
<h3 id="profile"><a href="#profile" class="headerlink" title="profile"></a>profile</h3><p>æˆ‘ä»¬å¯ä»¥æŠŠä¸åŒç¯å¢ƒçš„é…ç½®åˆ†åˆ«é…ç½®åˆ°å•ç‹¬çš„æ–‡ä»¶ä¸­ï¼Œä¸¾ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">profile</span>=<span class="string">&quot;development&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:jdbc</span>=<span class="string">&quot;http://www.springframework.org/schema/jdbc&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;...&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdbc:embedded-database</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">jdbc:script</span> <span class="attr">location</span>=<span class="string">&quot;classpath:com/bank/config/sql/schema.sql&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">jdbc:script</span> <span class="attr">location</span>=<span class="string">&quot;classpath:com/bank/config/sql/test-data.sql&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">jdbc:embedded-database</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">profile</span>=<span class="string">&quot;production&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:jee</span>=<span class="string">&quot;http://www.springframework.org/schema/jee&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;...&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">jee:jndi-lookup</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">jndi-name</span>=<span class="string">&quot;java:comp/env/jdbc/datasource&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>åº”è¯¥ä¸å¿…åšè¿‡å¤šè§£é‡Šäº†å§ï¼Œçœ‹æ¯ä¸ªæ–‡ä»¶ç¬¬ä¸€è¡Œçš„ profile=â€â€ã€‚</p>
<p>å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ä¸€ä¸ªé…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:jdbc</span>=<span class="string">&quot;http://www.springframework.org/schema/jdbc&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:jee</span>=<span class="string">&quot;http://www.springframework.org/schema/jee&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;...&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">beans</span> <span class="attr">profile</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">jdbc:embedded-database</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">jdbc:script</span> <span class="attr">location</span>=<span class="string">&quot;classpath:com/bank/config/sql/schema.sql&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">jdbc:script</span> <span class="attr">location</span>=<span class="string">&quot;classpath:com/bank/config/sql/test-data.sql&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">jdbc:embedded-database</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">beans</span> <span class="attr">profile</span>=<span class="string">&quot;production&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">jee:jndi-lookup</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">jndi-name</span>=<span class="string">&quot;java:comp/env/jdbc/datasource&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ç†è§£èµ·æ¥ä¹Ÿå¾ˆç®€å•å§ã€‚</p>
<p>æ¥ä¸‹æ¥çš„é—®é¢˜æ˜¯ï¼Œæ€ä¹ˆä½¿ç”¨ç‰¹å®šçš„ profile å‘¢ï¼ŸSpring åœ¨å¯åŠ¨çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå»å¯»æ‰¾ â€œspring.profiles.activeâ€ çš„å±æ€§å€¼ï¼Œæ ¹æ®è¿™ä¸ªå±æ€§å€¼æ¥çš„ã€‚é‚£æ€ä¹ˆé…ç½®è¿™ä¸ªå€¼å‘¢ï¼Ÿ</p>
<p>Spring ä¼šåœ¨è¿™å‡ ä¸ªåœ°æ–¹å¯»æ‰¾ spring.profiles.active çš„å±æ€§å€¼ï¼šæ“ä½œç³»ç»Ÿç¯å¢ƒå˜é‡ã€JVM ç³»ç»Ÿå˜é‡ã€web.xml ä¸­å®šä¹‰çš„å‚æ•°ã€JNDIã€‚</p>
<p>æœ€ç®€å•çš„æ–¹å¼è«è¿‡äºåœ¨ç¨‹åºå¯åŠ¨çš„æ—¶å€™æŒ‡å®šï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Dspring.profiles.active=&quot;profile1,profile2&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>profile å¯ä»¥æ¿€æ´»å¤šä¸ª</p>
</blockquote>
<p>å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ä»£ç çš„å½¢å¼ä» Environment ä¸­è®¾ç½® profileï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AnnotationConfigApplicationContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>();</span><br><span class="line">ctx.getEnvironment().setActiveProfiles(<span class="string">&quot;development&quot;</span>);</span><br><span class="line">ctx.register(SomeConfig.class, StandaloneDataConfig.class, JndiDataConfig.class);</span><br><span class="line">ctx.refresh(); <span class="comment">// é‡å¯</span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ˜¯ Spring Boot çš„è¯æ›´ç®€å•ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šåˆ›å»º application.propertiesã€application-dev.propertiesã€application-prod.properties ç­‰æ–‡ä»¶ï¼Œå…¶ä¸­ application.properties é…ç½®å„ä¸ªç¯å¢ƒé€šç”¨çš„é…ç½®ï¼Œapplication-{profile}.properties ä¸­é…ç½®ç‰¹å®šç¯å¢ƒçš„é…ç½®ï¼Œç„¶ååœ¨å¯åŠ¨çš„æ—¶å€™æŒ‡å®š profileï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Dspring.profiles.active=prod -jar JavaDoop.jar</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ˜¯å•å…ƒæµ‹è¯•ä¸­ä½¿ç”¨çš„è¯ï¼Œåœ¨æµ‹è¯•ç±»ä¸­ä½¿ç”¨ @ActiveProfiles æŒ‡å®šï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚</p>
<h3 id="å·¥å‚æ¨¡å¼ç”Ÿæˆ-Bean"><a href="#å·¥å‚æ¨¡å¼ç”Ÿæˆ-Bean" class="headerlink" title="å·¥å‚æ¨¡å¼ç”Ÿæˆ Bean"></a>å·¥å‚æ¨¡å¼ç”Ÿæˆ Bean</h3><p>è¯·è¯»è€…æ³¨æ„ factory-bean å’Œ FactoryBean çš„åŒºåˆ«ã€‚è¿™èŠ‚è¯´çš„æ˜¯å‰è€…ï¼Œæ˜¯è¯´é™æ€å·¥å‚æˆ–å®ä¾‹å·¥å‚ï¼Œè€Œåè€…æ˜¯ Spring ä¸­çš„ç‰¹æ®Šæ¥å£ï¼Œä»£è¡¨ä¸€ç±»ç‰¹æ®Šçš„ Beanï¼Œé™„å½•çš„ä¸‹é¢ä¸€èŠ‚ä¼šä»‹ç» FactoryBeanã€‚</p>
<p>è®¾è®¡æ¨¡å¼é‡Œï¼Œå·¥å‚æ–¹æ³•æ¨¡å¼åˆ†é™æ€å·¥å‚å’Œå®ä¾‹å·¥å‚ï¼Œæˆ‘ä»¬åˆ†åˆ«çœ‹çœ‹ Spring ä¸­æ€ä¹ˆé…ç½®è¿™ä¸¤ä¸ªï¼Œæ¥ä¸ªä»£ç ç¤ºä¾‹å°±ä»€ä¹ˆéƒ½æ¸…æ¥šäº†ã€‚</p>
<p>é™æ€å·¥å‚ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;clientService&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">class</span>=<span class="string">&quot;examples.ClientService&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">factory-method</span>=<span class="string">&quot;createInstance&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClientService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">ClientService</span> <span class="variable">clientService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClientService</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">ClientService</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é™æ€æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ClientService <span class="title function_">createInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> clientService;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®ä¾‹å·¥å‚ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;serviceLocator&quot;</span> <span class="attr">class</span>=<span class="string">&quot;examples.DefaultServiceLocator&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- inject any dependencies required by this locator bean --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;clientService&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">factory-bean</span>=<span class="string">&quot;serviceLocator&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">factory-method</span>=<span class="string">&quot;createClientServiceInstance&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;accountService&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">factory-bean</span>=<span class="string">&quot;serviceLocator&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">factory-method</span>=<span class="string">&quot;createAccountServiceInstance&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultServiceLocator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">ClientService</span> <span class="variable">clientService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClientServiceImpl</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">AccountService</span> <span class="variable">accountService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AccountServiceImpl</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ClientService <span class="title function_">createClientServiceInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> clientService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> AccountService <span class="title function_">createAccountServiceInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> accountService;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="FactoryBean"><a href="#FactoryBean" class="headerlink" title="FactoryBean"></a>FactoryBean</h3><p>FactoryBean é€‚ç”¨äº Bean çš„åˆ›å»ºè¿‡ç¨‹æ¯”è¾ƒå¤æ‚çš„åœºæ™¯ï¼Œæ¯”å¦‚æ•°æ®åº“è¿æ¥æ± çš„åˆ›å»ºã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">FactoryBean</span>&lt;T&gt; &#123;</span><br><span class="line">    T <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">    Class&lt;T&gt; <span class="title function_">getObjectType</span><span class="params">()</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isSingleton</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123; </span><br><span class="line">    <span class="keyword">private</span> Car car ;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setCar</span><span class="params">(Car car)</span>&#123; <span class="built_in">this</span>.car = car;  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å‡è®¾ç°åœ¨éœ€è¦åˆ›å»ºä¸€ä¸ª Person çš„ Beanï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦ä¸€ä¸ª Car çš„å®ä¾‹ï¼Œæˆ‘ä»¬è¿™é‡Œå‡è®¾ Car çš„å®ä¾‹åˆ›å»ºå¾ˆéº»çƒ¦ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æŠŠåˆ›å»º Car çš„å¤æ‚è¿‡ç¨‹åŒ…è£…èµ·æ¥ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyCarFactoryBean</span> <span class="keyword">implements</span> <span class="title class_">FactoryBean</span>&lt;Car&gt;&#123;</span><br><span class="line">    <span class="keyword">private</span> String make; </span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> year ;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMake</span><span class="params">(String m)</span>&#123; <span class="built_in">this</span>.make =m ; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setYear</span><span class="params">(<span class="type">int</span> y)</span>&#123; <span class="built_in">this</span>.year = y; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Car <span class="title function_">getObject</span><span class="params">()</span>&#123; </span><br><span class="line">      <span class="comment">// è¿™é‡Œæˆ‘ä»¬å‡è®¾ Car çš„å®ä¾‹åŒ–è¿‡ç¨‹éå¸¸å¤æ‚ï¼Œåæ­£å°±ä¸æ˜¯å‡ è¡Œä»£ç å¯ä»¥å†™å®Œçš„é‚£ç§</span></span><br><span class="line">      <span class="type">CarBuilder</span> <span class="variable">cb</span> <span class="operator">=</span> CarBuilder.car();</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span>(year!=<span class="number">0</span>) cb.setYear(<span class="built_in">this</span>.year);</span><br><span class="line">      <span class="keyword">if</span>(StringUtils.hasText(<span class="built_in">this</span>.make)) cb.setMake( <span class="built_in">this</span>.make ); </span><br><span class="line">      <span class="keyword">return</span> cb.factory(); </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Class&lt;Car&gt; <span class="title function_">getObjectType</span><span class="params">()</span> &#123; <span class="keyword">return</span> Car.class ; &#125; </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isSingleton</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬çœ‹çœ‹è£…é…çš„æ—¶å€™æ˜¯æ€ä¹ˆé…ç½®çš„ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span> = <span class="string">&quot;com.javadoop.MyCarFactoryBean&quot;</span> <span class="attr">id</span> = <span class="string">&quot;car&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span> = <span class="string">&quot;make&quot;</span> <span class="attr">value</span> =<span class="string">&quot;Honda&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span> = <span class="string">&quot;year&quot;</span> <span class="attr">value</span> =<span class="string">&quot;1984&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span> = <span class="string">&quot;com.javadoop.Person&quot;</span> <span class="attr">id</span> = <span class="string">&quot;josh&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span> = <span class="string">&quot;car&quot;</span> <span class="attr">ref</span> = <span class="string">&quot;car&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>çœ‹åˆ°ä¸ä¸€æ ·äº†å—ï¼Ÿid ä¸º â€œcarâ€ çš„ bean å…¶å®æŒ‡å®šçš„æ˜¯ä¸€ä¸ª FactoryBeanï¼Œä¸è¿‡é…ç½®çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç›´æ¥è®©é…ç½® Person çš„ Bean ç›´æ¥ä¾èµ–äºè¿™ä¸ª FactoryBean å°±å¯ä»¥äº†ã€‚ä¸­é—´çš„è¿‡ç¨‹ Spring å·²ç»å°è£…å¥½äº†ã€‚</p>
<p>è¯´åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å†æ¥ç‚¹å¹²è´§ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œç°åœ¨è¿˜ç”¨ xml é…ç½® Bean ä¾èµ–çš„è¶Šæ¥è¶Šå°‘äº†ï¼Œæ›´å¤šæ—¶å€™ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé‡‡ç”¨ java  config çš„æ–¹å¼æ¥é…ç½®ï¼Œè¿™é‡Œæœ‰ä»€ä¹ˆä¸ä¸€æ ·å‘¢ï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CarConfiguration</span> &#123; </span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span> </span><br><span class="line">    <span class="keyword">public</span> MyCarFactoryBean <span class="title function_">carFactoryBean</span><span class="params">()</span>&#123; </span><br><span class="line">      <span class="type">MyCarFactoryBean</span> <span class="variable">cfb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyCarFactoryBean</span>();</span><br><span class="line">      cfb.setMake(<span class="string">&quot;Honda&quot;</span>);</span><br><span class="line">      cfb.setYear(<span class="number">1984</span>);</span><br><span class="line">      <span class="keyword">return</span> cfb;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Person <span class="title function_">aPerson</span><span class="params">()</span>&#123; </span><br><span class="line">    <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">      <span class="comment">// æ³¨æ„è¿™é‡Œçš„ä¸åŒ</span></span><br><span class="line">    person.setCar(carFactoryBean().getObject());</span><br><span class="line">    <span class="keyword">return</span> person; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ—¶å€™ï¼Œå…¶å®æˆ‘ä»¬çš„æ€è·¯ä¹Ÿå¾ˆç®€å•ï¼ŒæŠŠ MyCarFactoryBean çœ‹æˆæ˜¯ä¸€ä¸ªç®€å•çš„ Bean å°±å¯ä»¥äº†ï¼Œä¸å¿…ç†ä¼šä»€ä¹ˆ FactoryBeanï¼Œå®ƒæ˜¯ä¸æ˜¯ FactoryBean å’Œæˆ‘ä»¬æ²¡å…³ç³»ã€‚</p>
<h3 id="åˆå§‹åŒ–-Bean-çš„å›è°ƒ"><a href="#åˆå§‹åŒ–-Bean-çš„å›è°ƒ" class="headerlink" title="åˆå§‹åŒ– Bean çš„å›è°ƒ"></a>åˆå§‹åŒ– Bean çš„å›è°ƒ</h3><p>æœ‰ä»¥ä¸‹å››ç§æ–¹æ¡ˆï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;exampleInitBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;examples.ExampleBean&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;init&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnotherExampleBean</span> <span class="keyword">implements</span> <span class="title class_">InitializingBean</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// do some initialization work</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean(initMethod = &quot;init&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Foo <span class="title function_">foo</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Foo</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="é”€æ¯-Bean-çš„å›è°ƒ"><a href="#é”€æ¯-Bean-çš„å›è°ƒ" class="headerlink" title="é”€æ¯ Bean çš„å›è°ƒ"></a>é”€æ¯ Bean çš„å›è°ƒ</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;exampleInitBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;examples.ExampleBean&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;cleanup&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnotherExampleBean</span> <span class="keyword">implements</span> <span class="title class_">DisposableBean</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// do some destruction work (like releasing pooled connections)</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean(destroyMethod = &quot;cleanup&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Bar <span class="title function_">bar</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Bar</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PreDestroy</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cleanup</span><span class="params">()</span> &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ConversionService"><a href="#ConversionService" class="headerlink" title="ConversionService"></a>ConversionService</h3><p>æ—¢ç„¶æ–‡ä¸­è¯´åˆ°äº†è¿™ä¸ªï¼Œé¡ºä¾¿æä¸€ä¸‹å¥½äº†ã€‚</p>
<p>æœ€æœ‰ç”¨çš„åœºæ™¯å°±æ˜¯ï¼Œå®ƒç”¨æ¥å°†å‰ç«¯ä¼ è¿‡æ¥çš„å‚æ•°å’Œåç«¯çš„ controller æ–¹æ³•ä¸Šçš„å‚æ•°è¿›è¡Œç»‘å®šçš„æ—¶å€™ç”¨ã€‚</p>
<p>åƒå‰ç«¯ä¼ è¿‡æ¥çš„å­—ç¬¦ä¸²ã€æ•´æ•°è¦è½¬æ¢ä¸ºåç«¯çš„ Stringã€Integer å¾ˆå®¹æ˜“ï¼Œä½†æ˜¯å¦‚æœ controller æ–¹æ³•éœ€è¦çš„æ˜¯ä¸€ä¸ªæšä¸¾å€¼ï¼Œæˆ–è€…æ˜¯ Date è¿™äº›éåŸºç¡€ç±»å‹ï¼ˆå«åŸºç¡€ç±»å‹åŒ…è£…ç±»ï¼‰å€¼çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥è€ƒè™‘é‡‡ç”¨ ConversionService æ¥è¿›è¡Œè½¬æ¢ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;conversionService&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">class</span>=<span class="string">&quot;org.springframework.context.support.ConversionServiceFactoryBean&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;converters&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;com.javadoop.learning.utils.StringToEnumConverterFactory&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ConversionService æ¥å£å¾ˆç®€å•ï¼Œæ‰€ä»¥è¦è‡ªå®šä¹‰ä¸€ä¸ª convert çš„è¯ä¹Ÿå¾ˆç®€å•ã€‚</p>
<p>ä¸‹é¢å†è¯´ä¸€ä¸ªå®ç°è¿™ç§è½¬æ¢å¾ˆç®€å•çš„æ–¹å¼ï¼Œé‚£å°±æ˜¯å®ç° Converter æ¥å£ã€‚</p>
<p>æ¥çœ‹ä¸€ä¸ªå¾ˆç®€å•çš„ä¾‹å­ï¼Œè¿™æ ·æ¯”ä»€ä¹ˆéƒ½ç®¡ç”¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StringToDateConverter</span> <span class="keyword">implements</span> <span class="title class_">Converter</span>&lt;String, Date&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">convert</span><span class="params">(String source)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> DateUtils.parseDate(source, <span class="string">&quot;yyyy-MM-dd&quot;</span>, <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>, <span class="string">&quot;yyyy-MM-dd HH:mm&quot;</span>, <span class="string">&quot;HH:mm:ss&quot;</span>, <span class="string">&quot;HH:mm&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åªè¦æ³¨å†Œè¿™ä¸ª Bean å°±å¯ä»¥äº†ã€‚è¿™æ ·ï¼Œå‰ç«¯å¾€åç«¯ä¼ çš„æ—¶é—´æè¿°å­—ç¬¦ä¸²å°±å¾ˆå®¹æ˜“ç»‘å®šæˆ Date ç±»å‹äº†ï¼Œä¸éœ€è¦å…¶ä»–ä»»ä½•æ“ä½œã€‚</p>
<h3 id="Bean-ç»§æ‰¿"><a href="#Bean-ç»§æ‰¿" class="headerlink" title="Bean ç»§æ‰¿"></a>Bean ç»§æ‰¿</h3><p>åœ¨åˆå§‹åŒ– Bean çš„åœ°æ–¹ï¼Œæˆ‘ä»¬è¯´è¿‡äº†è¿™ä¸ªï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RootBeanDefinition</span> <span class="variable">bd</span> <span class="operator">=</span> getMergedLocalBeanDefinition(beanName);</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæ¶‰åŠåˆ°çš„å°±æ˜¯ <code>&lt;bean parent=&quot;&quot; /&gt;</code> ä¸­çš„ parent å±æ€§ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ Spring ä¸­æ˜¯ç”¨è¿™ä¸ªæ¥å¹²ä»€ä¹ˆçš„ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦æ˜ç™½ï¼Œè¿™é‡Œçš„ç»§æ‰¿å’Œ java è¯­æ³•ä¸­çš„ç»§æ‰¿æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œä¸è¿‡æ€è·¯æ˜¯ç›¸é€šçš„ã€‚child bean ä¼šç»§æ‰¿ parent bean çš„æ‰€æœ‰é…ç½®ï¼Œä¹Ÿå¯ä»¥è¦†ç›–ä¸€äº›é…ç½®ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æ–°å¢é¢å¤–çš„é…ç½®ã€‚</p>
<p>Spring ä¸­æä¾›äº†ç»§æ‰¿è‡ª AbstractBeanDefinition çš„ <code>ChildBeanDefinition</code> æ¥è¡¨ç¤º child beanã€‚</p>
<p>çœ‹å¦‚ä¸‹ä¸€ä¸ªä¾‹å­:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=<span class="string">&quot;inheritedTestBean&quot;</span> <span class="keyword">abstract</span>=<span class="string">&quot;true&quot;</span> class=<span class="string">&quot;org.springframework.beans.TestBean&quot;</span>&gt;</span><br><span class="line">    &lt;property name=<span class="string">&quot;name&quot;</span> value=<span class="string">&quot;parent&quot;</span>/&gt;</span><br><span class="line">    &lt;property name=<span class="string">&quot;age&quot;</span> value=<span class="string">&quot;1&quot;</span>/&gt;</span><br><span class="line">&lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;bean id=<span class="string">&quot;inheritsWithDifferentClass&quot;</span> class=<span class="string">&quot;org.springframework.beans.DerivedTestBean&quot;</span></span><br><span class="line">        parent=<span class="string">&quot;inheritedTestBean&quot;</span> init-method=<span class="string">&quot;initialize&quot;</span>&gt;</span><br><span class="line">        </span><br><span class="line">    &lt;property name=<span class="string">&quot;name&quot;</span> value=<span class="string">&quot;override&quot;</span>/&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure>

<p>parent bean è®¾ç½®äº† <code>abstract=&quot;true&quot;</code> æ‰€ä»¥å®ƒä¸ä¼šè¢«å®ä¾‹åŒ–ï¼Œchild bean ç»§æ‰¿äº† parent bean çš„ä¸¤ä¸ªå±æ€§ï¼Œä½†æ˜¯å¯¹ name å±æ€§è¿›è¡Œäº†è¦†å†™ã€‚</p>
<p>child bean ä¼šç»§æ‰¿ scopeã€æ„é€ å™¨å‚æ•°å€¼ã€å±æ€§å€¼ã€init-methodã€destroy-method ç­‰ç­‰ã€‚</p>
<p>å½“ç„¶ï¼Œæˆ‘ä¸æ˜¯è¯´ parent bean ä¸­çš„ abstract = true åœ¨è¿™é‡Œæ˜¯å¿…é¡»çš„ï¼Œåªæ˜¯è¯´å¦‚æœåŠ ä¸Šäº†ä»¥å Spring åœ¨å®ä¾‹åŒ– singleton beans çš„æ—¶å€™ä¼šå¿½ç•¥è¿™ä¸ª beanã€‚</p>
<p>æ¯”å¦‚ä¸‹é¢è¿™ä¸ªæç«¯ parent beanï¼Œå®ƒæ²¡æœ‰æŒ‡å®š classï¼Œæ‰€ä»¥æ¯«æ— ç–‘é—®ï¼Œè¿™ä¸ª bean çš„ä½œç”¨å°±æ˜¯ç”¨æ¥å……å½“æ¨¡æ¿ç”¨çš„ parent beanï¼Œæ­¤å¤„å°±å¿…é¡»åŠ ä¸Š abstract = trueã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=<span class="string">&quot;inheritedTestBeanWithoutClass&quot;</span> <span class="keyword">abstract</span>=<span class="string">&quot;true&quot;</span>&gt;</span><br><span class="line">    &lt;property name=<span class="string">&quot;name&quot;</span> value=<span class="string">&quot;parent&quot;</span>/&gt;</span><br><span class="line">    &lt;property name=<span class="string">&quot;age&quot;</span> value=<span class="string">&quot;1&quot;</span>/&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure>
<h3 id="æ–¹æ³•æ³¨å…¥"><a href="#æ–¹æ³•æ³¨å…¥" class="headerlink" title="æ–¹æ³•æ³¨å…¥"></a>æ–¹æ³•æ³¨å…¥</h3><p>ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬çš„åº”ç”¨ä¸­å¤§å¤šæ•°çš„ Bean éƒ½æ˜¯ singleton çš„ã€‚singleton ä¾èµ– singletonï¼Œæˆ–è€… prototype ä¾èµ– prototype éƒ½å¾ˆå¥½è§£å†³ï¼Œç›´æ¥è®¾ç½®å±æ€§ä¾èµ–å°±å¯ä»¥äº†ã€‚</p>
<p>ä½†æ˜¯ï¼Œå¦‚æœæ˜¯ singleton ä¾èµ– prototype å‘¢ï¼Ÿè¿™ä¸ªæ—¶å€™ä¸èƒ½ç”¨å±æ€§ä¾èµ–ï¼Œå› ä¸ºå¦‚æœç”¨å±æ€§ä¾èµ–çš„è¯ï¼Œæˆ‘ä»¬æ¯æ¬¡å…¶å®æ‹¿åˆ°çš„è¿˜æ˜¯ç¬¬ä¸€æ¬¡åˆå§‹åŒ–æ—¶å€™çš„ beanã€‚</p>
<p>ä¸€ç§è§£å†³æ–¹æ¡ˆå°±æ˜¯ä¸è¦ç”¨å±æ€§ä¾èµ–ï¼Œæ¯æ¬¡è·å–ä¾èµ–çš„ bean çš„æ—¶å€™ä» BeanFactory ä¸­å–ã€‚è¿™ä¸ªä¹Ÿæ˜¯å¤§å®¶æœ€å¸¸ç”¨çš„æ–¹å¼äº†å§ã€‚æ€ä¹ˆå–ï¼Œæˆ‘å°±ä¸ä»‹ç»äº†ï¼Œå¤§éƒ¨åˆ† Spring é¡¹ç›®å¤§å®¶éƒ½ä¼šå®šä¹‰é‚£ä¹ˆä¸ªå·¥å…·ç±»çš„ã€‚</p>
<p>å¦ä¸€ç§è§£å†³æ–¹æ¡ˆå°±æ˜¯è¿™é‡Œè¦ä»‹ç»çš„é€šè¿‡ä½¿ç”¨ Lookup methodã€‚</p>
<h4 id="lookup-method"><a href="#lookup-method" class="headerlink" title="lookup-method"></a>lookup-method</h4><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ Spring Reference ä¸­æä¾›çš„ä¸€ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> fiona.apple;</span><br><span class="line"></span><br><span class="line"><span class="comment">// no more Spring imports!</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">CommandManager</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">process</span><span class="params">(Object commandState)</span> &#123;</span><br><span class="line">        <span class="comment">// grab a new instance of the appropriate Command interface</span></span><br><span class="line">        <span class="type">Command</span> <span class="variable">command</span> <span class="operator">=</span> createCommand();</span><br><span class="line">        <span class="comment">// set the state on the (hopefully brand new) Command instance</span></span><br><span class="line">        command.setState(commandState);</span><br><span class="line">        <span class="keyword">return</span> command.execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// okay... but where is the implementation of this method?</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> Command <span class="title function_">createCommand</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>xml é…ç½® <code>&lt;lookup-method /&gt;</code>ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- a stateful bean deployed as a prototype (non-singleton) --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;myCommand&quot;</span> <span class="attr">class</span>=<span class="string">&quot;fiona.apple.AsyncCommand&quot;</span> <span class="attr">scope</span>=<span class="string">&quot;prototype&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- inject dependencies here as required --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- commandProcessor uses statefulCommandHelper --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;commandManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;fiona.apple.CommandManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">lookup-method</span> <span class="attr">name</span>=<span class="string">&quot;createCommand&quot;</span> <span class="attr">bean</span>=<span class="string">&quot;myCommand&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Spring é‡‡ç”¨ <strong>CGLIB ç”Ÿæˆå­—èŠ‚ç </strong>çš„æ–¹å¼æ¥ç”Ÿæˆä¸€ä¸ªå­ç±»ã€‚æˆ‘ä»¬å®šä¹‰çš„ç±»ä¸èƒ½å®šä¹‰ä¸º final classï¼ŒæŠ½è±¡æ–¹æ³•ä¸Šä¹Ÿä¸èƒ½åŠ  finalã€‚</p>
<p>lookup-method ä¸Šçš„é…ç½®ä¹Ÿå¯ä»¥é‡‡ç”¨æ³¨è§£æ¥å®Œæˆï¼Œè¿™æ ·å°±å¯ä»¥ä¸ç”¨é…ç½® <code>&lt;lookup-method /&gt;</code> äº†ï¼Œå…¶ä»–ä¸å˜ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">CommandManager</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">process</span><span class="params">(Object commandState)</span> &#123;</span><br><span class="line">        <span class="type">MyCommand</span> <span class="variable">command</span> <span class="operator">=</span> createCommand();</span><br><span class="line">        command.setState(commandState);</span><br><span class="line">        <span class="keyword">return</span> command.execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Lookup(&quot;myCommand&quot;)</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> Command <span class="title function_">createCommand</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨æ„ï¼Œæ—¢ç„¶ç”¨äº†æ³¨è§£ï¼Œè¦é…ç½®æ³¨è§£æ‰«æï¼š<code>&lt;context:component-scan base-package=&quot;com.javadoop&quot; /&gt;</code></p>
</blockquote>
<p>ç”šè‡³ï¼Œæˆ‘ä»¬å¯ä»¥åƒä¸‹é¢è¿™æ ·ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">CommandManager</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">process</span><span class="params">(Object commandState)</span> &#123;</span><br><span class="line">        <span class="type">MyCommand</span> <span class="variable">command</span> <span class="operator">=</span> createCommand();</span><br><span class="line">        command.setState(commandState);</span><br><span class="line">        <span class="keyword">return</span> command.execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Lookup</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> MyCommand <span class="title function_">createCommand</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ä¸Šé¢çš„è¿”å›å€¼ç”¨äº† MyCommandï¼Œå½“ç„¶ï¼Œå¦‚æœ Command åªæœ‰ä¸€ä¸ªå®ç°ç±»ï¼Œé‚£è¿”å›å€¼ä¹Ÿå¯ä»¥å†™ Commandã€‚</p>
</blockquote>
<h4 id="replaced-method"><a href="#replaced-method" class="headerlink" title="replaced-method"></a>replaced-method</h4><p>è®°ä½å®ƒçš„åŠŸèƒ½ï¼Œå°±æ˜¯æ›¿æ¢æ‰ bean ä¸­çš„ä¸€äº›æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyValueCalculator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">computeValue</span><span class="params">(String input)</span> &#123;</span><br><span class="line">        <span class="comment">// some real code...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// some other methods...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ–¹æ³•è¦†å†™ï¼Œæ³¨æ„è¦å®ç° MethodReplacer æ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReplacementComputeValue</span> <span class="keyword">implements</span> <span class="title class_">org</span>.springframework.beans.factory.support.MethodReplacer &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">reimplement</span><span class="params">(Object o, Method m, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">// get the input value, work with it, and return a computed result</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">input</span> <span class="operator">=</span> (String) args[<span class="number">0</span>];</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> ...;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é…ç½®ä¹Ÿå¾ˆç®€å•ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;myValueCalculator&quot;</span> <span class="attr">class</span>=<span class="string">&quot;x.y.z.MyValueCalculator&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- å®šä¹‰ computeValue è¿™ä¸ªæ–¹æ³•è¦è¢«æ›¿æ¢æ‰ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">replaced-method</span> <span class="attr">name</span>=<span class="string">&quot;computeValue&quot;</span> <span class="attr">replacer</span>=<span class="string">&quot;replacementComputeValue&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">arg-type</span>&gt;</span>String<span class="tag">&lt;/<span class="name">arg-type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">replaced-method</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;replacementComputeValue&quot;</span> <span class="attr">class</span>=<span class="string">&quot;a.b.c.ReplacementComputeValue&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>arg-type æ˜æ˜¾ä¸æ˜¯å¿…é¡»çš„ï¼Œé™¤éå­˜åœ¨æ–¹æ³•é‡è½½ï¼Œè¿™æ ·å¿…é¡»é€šè¿‡å‚æ•°ç±»å‹åˆ—è¡¨æ¥åˆ¤æ–­è¿™é‡Œè¦è¦†ç›–å“ªä¸ªæ–¹æ³•ã€‚</p>
</blockquote>
<h3 id="BeanPostProcessor"><a href="#BeanPostProcessor" class="headerlink" title="BeanPostProcessor"></a>BeanPostProcessor</h3><p>åº”è¯¥è¯´ BeanPostProcessor æ¦‚å¿µåœ¨ Spring ä¸­ä¹Ÿæ˜¯æ¯”è¾ƒé‡è¦çš„ã€‚æˆ‘ä»¬çœ‹ä¸‹æ¥å£å®šä¹‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BeanPostProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">   Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException;</span><br><span class="line"></span><br><span class="line">   Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>çœ‹è¿™ä¸ªæ¥å£ä¸­çš„ä¸¤ä¸ªæ–¹æ³•åå­—æˆ‘ä»¬å¤§ä½“ä¸Šå¯ä»¥çŒœæµ‹ bean åœ¨åˆå§‹åŒ–ä¹‹å‰ä¼šæ‰§è¡Œ postProcessBeforeInitialization è¿™ä¸ªæ–¹æ³•ï¼Œåˆå§‹åŒ–å®Œæˆä¹‹åä¼šæ‰§è¡Œ postProcessAfterInitialization è¿™ä¸ªæ–¹æ³•ã€‚ä½†æ˜¯ï¼Œè¿™ä¹ˆç†è§£æ˜¯éå¸¸ç‰‡é¢çš„ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦æ˜ç™½ï¼Œé™¤äº†æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ BeanPostProcessor å®ç°å¤–ï¼ŒSpring å®¹å™¨åœ¨å¯åŠ¨æ—¶è‡ªåŠ¨ç»™æˆ‘ä»¬ä¹ŸåŠ äº†å‡ ä¸ªã€‚å¦‚åœ¨è·å– BeanFactory çš„ obtainFactory() æ–¹æ³•ç»“æŸåçš„ prepareBeanFactory(factory)ï¼Œå¤§å®¶ä»”ç»†çœ‹ä¼šå‘ç°ï¼ŒSpring å¾€å®¹å™¨ä¸­æ·»åŠ äº†è¿™ä¸¤ä¸ª BeanPostProcessorï¼šApplicationContextAwareProcessorã€ApplicationListenerDetectorã€‚</p>
<p>æˆ‘ä»¬å›åˆ°è¿™ä¸ªæ¥å£æœ¬èº«ï¼Œè¯»è€…è¯·çœ‹ç¬¬ä¸€ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ¥å—çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ bean å®ä¾‹ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ bean çš„åå­—ï¼Œé‡ç‚¹åœ¨è¿”å›å€¼å°†ä¼šä½œä¸ºæ–°çš„ bean å®ä¾‹ï¼Œæ‰€ä»¥ï¼Œæ²¡äº‹çš„è¯è¿™é‡Œä¸èƒ½éšä¾¿è¿”å›ä¸ª nullã€‚</p>
<p>é‚£æ„å‘³ç€ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³åˆ°çš„å°±æ˜¯ï¼Œæˆ‘ä»¬è¿™é‡Œå¯ä»¥å¯¹ä¸€äº›æˆ‘ä»¬æƒ³è¦ä¿®é¥°çš„ bean å®ä¾‹åšä¸€äº›äº‹æƒ…ã€‚ä½†æ˜¯å¯¹äº Spring æ¡†æ¶æ¥è¯´ï¼Œå®ƒä¼šå†³å®šæ˜¯ä¸æ˜¯è¦åœ¨è¿™ä¸ªæ–¹æ³•ä¸­è¿”å› bean å®ä¾‹çš„ä»£ç†ï¼Œè¿™æ ·å°±æœ‰æ›´å¤§çš„æƒ³è±¡ç©ºé—´äº†ã€‚</p>
<p>æœ€åï¼Œæˆ‘ä»¬è¯´è¯´å¦‚æœæˆ‘ä»¬è‡ªå·±å®šä¹‰ä¸€ä¸ª bean å®ç° BeanPostProcessor çš„è¯ï¼Œå®ƒçš„æ‰§è¡Œæ—¶æœºæ˜¯ä»€ä¹ˆæ—¶å€™ï¼Ÿ</p>
<p>å¦‚æœä»”ç»†çœ‹äº†ä»£ç åˆ†æçš„è¯ï¼Œå…¶å®å¾ˆå®¹æ˜“çŸ¥é“äº†ï¼Œåœ¨ bean å®ä¾‹åŒ–å®Œæˆã€å±æ€§æ³¨å…¥å®Œæˆä¹‹åï¼Œä¼šæ‰§è¡Œå›è°ƒæ–¹æ³•ï¼Œå…·ä½“è¯·å‚è§ç±» AbstractAutowireCapableBeanFactory#initBean æ–¹æ³•ã€‚</p>
<p>é¦–å…ˆä¼šå›è°ƒå‡ ä¸ªå®ç°äº† Aware æ¥å£çš„ beanï¼Œç„¶åå°±å¼€å§‹å›è°ƒ BeanPostProcessor çš„ postProcessBeforeInitialization æ–¹æ³•ï¼Œä¹‹åæ˜¯å›è°ƒ init-methodï¼Œç„¶åå†å›è°ƒ BeanPostProcessor çš„ postProcessAfterInitialization æ–¹æ³•ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æŒ‰ç†è¯´ï¼Œæ€»ç»“åº”è¯¥å†™åœ¨é™„å½•å‰é¢ï¼Œæˆ‘å°±ä¸è®²ç©¶äº†ã€‚</p>
<p>åœ¨èŠ±äº†é‚£ä¹ˆå¤šæ—¶é—´åï¼Œè¿™ç¯‡æ–‡ç« ç»ˆäºç®—æ˜¯åŸºæœ¬å†™å®Œäº†ï¼Œå¤§å®¶åœ¨æƒŠå¹ Spring ç»™æˆ‘ä»¬åšäº†é‚£ä¹ˆå¤šçš„äº‹çš„æ—¶å€™ï¼Œåº”è¯¥é€è¿‡ç°è±¡çœ‹æœ¬è´¨ï¼Œå»ç†è§£ Spring å†™å¾—å¥½çš„åœ°æ–¹ï¼Œå»ç†è§£å®ƒçš„è®¾è®¡æ€æƒ³ã€‚</p>
<p>æœ¬æ–‡çš„ç¼ºé™·åœ¨äºå¯¹ Spring é¢„åˆå§‹åŒ– singleton beans çš„è¿‡ç¨‹åˆ†æä¸å¤Ÿï¼Œä¸»è¦æ˜¯ä»£ç é‡çœŸçš„æ¯”è¾ƒå¤§ï¼Œåˆ†æ”¯æ—è·¯ä¼—å¤šã€‚åŒæ—¶ï¼Œè™½ç„¶é™„å½•æ¡ç›®ä¸å°‘ï¼Œä½†æ˜¯åºå¤§çš„ Spring çœŸçš„å¼•å‡ºäº†å¾ˆå¤šçš„æ¦‚å¿µï¼Œå¸Œæœ›æ—¥åæœ‰ç²¾åŠ›å¯ä»¥æ…¢æ…¢è¡¥å……ä¸€äº›ã€‚</p>
<p>ï¼ˆå…¨æ–‡å®Œï¼‰</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://scatteredream.github.io/2018/07/23/juc-source-code-BlockingQueue/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/62317679?s=400&v=4">
      <meta itemprop="name" content="ç¢æ¢¦">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="scatteredream's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | scatteredream's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/07/23/juc-source-code-BlockingQueue/" class="post-title-link" itemprop="url">è§£è¯» java å¹¶å‘é˜Ÿåˆ— BlockingQueue(è½¬è‡ªJavadoop)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2018-07-23 00:00:00" itemprop="dateCreated datePublished" datetime="2018-07-23T00:00:00+08:00">2018-07-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-04-27 23:20:47" itemprop="dateModified" datetime="2025-04-27T23:20:47+08:00">2025-04-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/juc/" itemprop="url" rel="index"><span itemprop="name">juc</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>æœ€è¿‘å¾—ç©ºï¼Œæƒ³å†™ç¯‡æ–‡ç« å¥½å¥½è¯´è¯´ java çº¿ç¨‹æ± é—®é¢˜ï¼Œæˆ‘ç›¸ä¿¡å¾ˆå¤šäººéƒ½ä¸€çŸ¥åŠè§£çš„ï¼ŒåŒ…æ‹¬æˆ‘è‡ªå·±åœ¨ä»”ä»”ç»†ç»†çœ‹æºç ä¹‹å‰ï¼Œä¹Ÿæœ‰è®¸å¤šçš„ä¸è§£ï¼Œç”šè‡³æœ‰äº›åœ°æ–¹æˆ‘ä¸€ç›´éƒ½æ²¡æœ‰ç†è§£åˆ°ä½ã€‚</p>
<p>è¯´åˆ°çº¿ç¨‹æ± å®ç°ï¼Œé‚£ä¹ˆå°±ä¸å¾—ä¸æ¶‰åŠåˆ°å„ç§ BlockingQueue çš„å®ç°ï¼Œé‚£ä¹ˆæˆ‘æƒ³å°± BlockingQueue çš„é—®é¢˜å’Œå¤§å®¶åˆ†äº«åˆ†äº«æˆ‘äº†è§£çš„ä¸€äº›çŸ¥è¯†ã€‚</p>
<p>æœ¬æ–‡æ²¡æœ‰åƒä¹‹å‰åˆ†æ AQS é‚£æ ·ä¸€è¡Œä¸€è¡Œæºç åˆ†æäº†ï¼Œä¸è¿‡è¿˜æ˜¯æŠŠå…¶ä¸­æœ€é‡è¦å’Œæœ€éš¾ç†è§£çš„ä»£ç è¯´äº†ä¸€éï¼Œæ‰€ä»¥ä¸å…ç¯‡å¹…ç•¥é•¿ã€‚æœ¬æ–‡æ¶‰åŠåˆ°æ¯”è¾ƒå¤šçš„ Doug Lea å¯¹ BlockingQueue çš„è®¾è®¡æ€æƒ³ï¼Œå¸Œæœ›æœ‰å¿ƒçš„è¯»è€…çœŸçš„å¯ä»¥æœ‰ä¸€äº›æ”¶è·ï¼Œæˆ‘è§‰å¾—è‡ªå·±è¿˜æ˜¯å†™äº†ä¸€äº›å¹²è´§çš„ã€‚</p>
<p>æœ¬æ–‡ç›´æ¥å‚è€ƒ Doug Lea å†™çš„ Java doc å’Œæ³¨é‡Šï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨å­¦ä¹  java å¹¶å‘åŒ…æ—¶æœ€å¥½çš„ææ–™äº†ã€‚å¸Œæœ›å¤§å®¶èƒ½æœ‰æ‰€æ€ã€æœ‰æ‰€æ‚Ÿï¼Œå­¦ä¹  Doug Lea çš„ä»£ç é£æ ¼ï¼Œå¹¶å°†å…¶ä¼˜é›…ã€ä¸¥è°¨çš„ä½œé£åº”ç”¨åˆ°æˆ‘ä»¬å†™çš„æ¯ä¸€è¡Œä»£ç ä¸­ã€‚</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2018/07/23/juc-source-code-BlockingQueue/#more" rel="contents">
                é˜…è¯»å…¨æ–‡ &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://scatteredream.github.io/2018/03/27/jvm-gc-serial-parellel-cms/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/62317679?s=400&v=4">
      <meta itemprop="name" content="ç¢æ¢¦">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="scatteredream's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | scatteredream's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/03/27/jvm-gc-serial-parellel-cms/" class="post-title-link" itemprop="url">HotSpot JVM å†…å­˜ç®¡ç†</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2018-03-27 00:00:00" itemprop="dateCreated datePublished" datetime="2018-03-27T00:00:00+08:00">2018-03-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-05-11 10:47:12" itemprop="dateModified" datetime="2025-05-11T10:47:12+08:00">2025-05-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/jvm/" itemprop="url" rel="index"><span itemprop="name">jvm</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="JVM-Memory-Management"><a href="#JVM-Memory-Management" class="headerlink" title="JVM Memory Management"></a>JVM Memory Management</h1><p>å…³äº JVM å†…å­˜ç®¡ç†æˆ–è€…è¯´åƒåœ¾æ”¶é›†ï¼Œå¤§å®¶å¯èƒ½çœ‹è¿‡å¾ˆå¤šçš„æ–‡ç« äº†ï¼Œç¬”è€…å‡†å¤‡ç»™å¤§å®¶æ€»ç»“ä¸‹ã€‚è¿™ç®—æ˜¯ç³»åˆ—çš„ç¬¬ä¸€ç¯‡ï¼Œæ¥ä¸‹æ¥ä¸€æ®µæ—¶é—´ä¼šæŒç»­æ›´æ–°ã€‚</p>
<p>æœ¬æ–‡ä¸»è¦æ˜¯ç¿»è¯‘ã€Š<a target="_blank" rel="noopener" href="http://www.oracle.com/technetwork/java/javase/memorymanagement-whitepaper-150215.pdf">Memory Management in the Java HotSpot Virtual Machine</a>ã€‹ç™½çš®ä¹¦çš„å‰å››ç« å†…å®¹ï¼Œè¿™æ˜¯ 2006 çš„è€æ–‡ç« äº†ï¼Œå½“å¹´å‘å¸ƒè¿™ç¯‡æ–‡ç« çš„è¿˜æ˜¯ <strong>Sun Microsystems</strong>ï¼Œä»¥ååº”è¯¥ä¼šè¶Šæ¥è¶Šå°‘äººè®°å¾—è¿™å®¶æ›¾ç»æ— æ¯”ä¼Ÿå¤§çš„å…¬å¸äº†ã€‚</p>
<p>è™½ç„¶è¿™ä¸ªç™½çš®ä¹¦æœ‰ç‚¹è€äº†ï¼Œä¸è¿‡é‚£ä¸ªæ—¶å€™ Sun åœ¨ <strong>J2SE 5.0</strong> ç‰ˆæœ¬çš„ HotSpot è™šæ‹Ÿæœºä¸Šå·²ç»æœ‰äº† Parallel å¹¶è¡Œåƒåœ¾æ”¶é›†å™¨å’Œ CMS è¿™ç§å¹¶å‘æ”¶é›†å™¨äº†ï¼Œæ‰€ä»¥å…¶å®å†…å®¹ä¹Ÿæ²¡é‚£ä¹ˆè¿‡æ—¶ã€‚</p>
<blockquote>
<p>å…¶å®æœ¬æ–‡åº”è¯¥æœ‰æŒºå¤šäººéƒ½ç¿»è¯‘è¿‡ï¼Œæˆ‘å¤§ä½“ä¸Šæ˜¯æ„è¯‘çš„ï¼Œå¢ã€åˆ äº†éƒ¨åˆ†å†…å®¹ã€‚</p>
</blockquote>
<p>å…¶ä»–çš„çŸ¥è¯†ï¼ŒåŒ…æ‹¬ Java5 ä¹‹åçš„åƒåœ¾æ”¶é›†å™¨ï¼Œå¦‚ Java8 çš„ MetaSpace å–ä»£äº†æ°¸ä¹…ä»£ã€G1 æ”¶é›†å™¨ç­‰ï¼Œå°†åœ¨æ—¥åçš„æ–‡ç« ä¸­è¿›è¡Œä»‹ç»ã€‚</p>
<p><strong>ç›®å½•</strong></p>
<!-- toc -->

<h2 id="åƒåœ¾æ”¶é›†æ¦‚å¿µ"><a href="#åƒåœ¾æ”¶é›†æ¦‚å¿µ" class="headerlink" title="åƒåœ¾æ”¶é›†æ¦‚å¿µ"></a>åƒåœ¾æ”¶é›†æ¦‚å¿µ</h2><p>GC éœ€è¦åš 3 ä»¶äº‹æƒ…ï¼š</p>
<ul>
<li>åˆ†é…å†…å­˜ï¼Œä¸ºæ¯ä¸ªæ–°å»ºçš„å¯¹è±¡åˆ†é…ç©ºé—´</li>
<li>ç¡®ä¿è¿˜åœ¨ä½¿ç”¨çš„å¯¹è±¡çš„å†…å­˜ä¸€ç›´è¿˜åœ¨ï¼Œä¸èƒ½æŠŠæœ‰ç”¨çš„ç©ºé—´å½“åƒåœ¾å›æ”¶äº†</li>
<li>é‡Šæ”¾ä¸å†ä½¿ç”¨çš„å¯¹è±¡æ‰€å ç”¨çš„ç©ºé—´</li>
</ul>
<p>æˆ‘ä»¬æŠŠè¿˜è¢« <strong>GC Roots</strong> å¼•ç”¨çš„å¯¹è±¡ç§°ä¸º<strong>æ´»çš„</strong>ï¼ŒæŠŠä¸å†è¢«å¼•ç”¨çš„å¯¹è±¡è®¤ä¸ºæ˜¯<strong>æ­»çš„</strong>ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¯´çš„åƒåœ¾ï¼ŒGC çš„å·¥ä½œå°±æ˜¯æ‰¾åˆ°æ­»çš„å¯¹è±¡ï¼Œå›æ”¶å®ƒä»¬å ç”¨çš„ç©ºé—´ã€‚</p>
<p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ GC Roots æœ‰å“ªäº›ï¼š</p>
<ul>
<li>å½“å‰å„çº¿ç¨‹æ‰§è¡Œæ–¹æ³•ä¸­çš„å±€éƒ¨å˜é‡ï¼ˆåŒ…æ‹¬å½¢å‚ï¼‰å¼•ç”¨çš„å¯¹è±¡</li>
<li>å·²è¢«åŠ è½½çš„ç±»çš„ static åŸŸå¼•ç”¨çš„å¯¹è±¡</li>
<li>æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡</li>
<li>JNI å¼•ç”¨</li>
</ul>
<blockquote>
<p>ä»¥ä¸Šä¸å®Œå…¨ï¼Œä¸è¿‡æˆ‘è§‰å¾—äº†è§£åˆ°è¿™äº›å°±å¤Ÿäº†ï¼Œ<a target="_blank" rel="noopener" href="https://www.zhihu.com/question/53613423/answer/135743258">äº†è§£æ›´å¤š</a></p>
</blockquote>
<p>æˆ‘ä»¬æŠŠ GC ç®¡ç†çš„å†…å­˜ç§°ä¸º <strong>å †ï¼ˆheapï¼‰</strong>ï¼Œåƒåœ¾æ”¶é›†å¯åŠ¨çš„æ—¶æœºå–å†³äºå„ä¸ªåƒåœ¾æ”¶é›†å™¨ï¼Œé€šå¸¸ï¼Œåƒåœ¾æ”¶é›†å‘ç”Ÿäºæ•´ä¸ªå †æˆ–å †çš„éƒ¨åˆ†å·²ç»è¢«ä½¿ç”¨å…‰äº†ï¼Œæˆ–è€…ä½¿ç”¨çš„ç©ºé—´è¾¾åˆ°äº†æŸä¸ªç™¾åˆ†æ¯”é˜ˆå€¼ã€‚è¿™äº›åé¢éƒ½ä¼šå…·ä½“è¯´ï¼Œè¿™é‡Œçš„æ¯ä¸€å¥è¯éƒ½æ˜¯å¯¹åº”äº†æŸäº›åœºæ™¯çš„ã€‚</p>
<p>å¯¹äºå†…å­˜åˆ†é…è¯·æ±‚ï¼Œå®ç°çš„éš¾ç‚¹åœ¨äºåœ¨å †ä¸­æ‰¾åˆ°ä¸€å—æ²¡æœ‰è¢«ä½¿ç”¨çš„ç¡®å®šå¤§å°çš„å†…å­˜ç©ºé—´ã€‚æ‰€ä»¥ï¼Œå¯¹äºå¤§éƒ¨åˆ†åƒåœ¾å›æ”¶ç®—æ³•æ¥è¯´<strong>é¿å…å†…å­˜ç¢ç‰‡åŒ–</strong>æ˜¯éå¸¸é‡è¦çš„ï¼Œå®ƒå°†ä½¿å¾—ç©ºé—´åˆ†é…æ›´åŠ é«˜æ•ˆã€‚</p>
<h3 id="åƒåœ¾æ”¶é›†å™¨çš„ç†æƒ³ç‰¹å¾"><a href="#åƒåœ¾æ”¶é›†å™¨çš„ç†æƒ³ç‰¹å¾" class="headerlink" title="åƒåœ¾æ”¶é›†å™¨çš„ç†æƒ³ç‰¹å¾"></a>åƒåœ¾æ”¶é›†å™¨çš„ç†æƒ³ç‰¹å¾</h3><ol>
<li>å®‰å…¨å’Œå…¨é¢ï¼šæ´»çš„å¯¹è±¡ä¸€å®šä¸èƒ½è¢«æ¸…ç†æ‰ï¼Œæ­»çš„å¯¹è±¡ä¸€å®šä¸èƒ½åœ¨å‡ ä¸ªå›æ”¶å‘¨æœŸç»“æŸåè¿˜åœ¨å†…å­˜ä¸­ã€‚</li>
<li>é«˜æ•ˆï¼šä¸èƒ½å°†æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæŒ‚èµ·å¤ªé•¿æ—¶é—´ã€‚æˆ‘ä»¬éœ€è¦åœ¨æ—¶é—´ã€ç©ºé—´ã€é¢‘æ¬¡ä¸Šä½œå‡ºæƒè¡¡ã€‚æ¯”å¦‚ï¼Œå¦‚æœå †å†…å­˜å¾ˆå°ï¼Œæ¯æ¬¡åƒåœ¾æ”¶é›†å°±ä¼šå¾ˆå¿«ï¼Œä½†æ˜¯é¢‘æ¬¡ä¼šå¢åŠ ã€‚å¦‚æœå †å†…å­˜å¾ˆå¤§ï¼Œå¾ˆä¹…æ‰ä¼šè¢«å¡«æ»¡ï¼Œä½†æ˜¯æ¯ä¸€æ¬¡å›æ”¶éœ€è¦çš„æ—¶é—´å¾ˆé•¿ã€‚</li>
<li>å°½é‡å°‘çš„å†…å­˜ç¢ç‰‡ï¼šæ¯æ¬¡å°†åƒåœ¾å¯¹è±¡é‡Šæ”¾ä»¥åï¼Œè¿™äº›ç©ºé—´å¯èƒ½åˆ†å¸ƒåœ¨å„ä¸ªåœ°æ–¹ï¼Œæœ€ç³Ÿç³•çš„æƒ…å†µå°±æ˜¯ï¼Œå†…å­˜ä¸­åˆ°å¤„éƒ½æ˜¯ç¢ç‰‡ï¼Œåœ¨ç»™ä¸€ä¸ªå¤§å¯¹è±¡åˆ†é…ç©ºé—´çš„æ—¶å€™æ²¡æœ‰å†…å­˜å¯ç”¨ï¼Œå®é™…ä¸Šå†…å­˜æ˜¯å¤Ÿçš„ã€‚æ¶ˆé™¤ç¢ç‰‡çš„æ–¹å¼å°±æ˜¯<strong>å‹ç¼©</strong>ã€‚</li>
<li>å¯æ‰©å±•æ€§ï¼šåœ¨å¤šæ ¸å¤šçº¿ç¨‹åº”ç”¨ä¸­ï¼Œå†…å­˜åˆ†é…å’Œåƒåœ¾å›æ”¶éƒ½ä¸åº”è¯¥æˆä¸ºå¯æ‰©å±•æ€§çš„ç“¶é¢ˆã€‚<strong>åŸæ–‡æåˆ°çš„è¿™ä¸€ç‚¹ï¼Œæˆ‘çš„ç†è§£æ˜¯ï¼šå•çº¿ç¨‹åƒåœ¾å›æ”¶åœ¨å¤šæ ¸ç³»ç»Ÿä¸­ä¼šæµªè´¹ CPU èµ„æºï¼Œå¦‚æœæˆ‘ç†è§£é”™è¯¯ï¼Œè¯·æŒ‡æ­£æˆ‘ã€‚</strong></li>
</ol>
<h3 id="è®¾è®¡ä¸Šçš„æƒè¡¡"><a href="#è®¾è®¡ä¸Šçš„æƒè¡¡" class="headerlink" title="è®¾è®¡ä¸Šçš„æƒè¡¡"></a>è®¾è®¡ä¸Šçš„æƒè¡¡</h3><p>å¾€ä¸‹çœ‹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆåˆ†æ¸…æ¥šè¿™é‡Œçš„ä¸¤ä¸ªæ¦‚å¿µï¼šå¹¶å‘å’Œå¹¶è¡Œ</p>
<ul>
<li><strong>å¹¶è¡Œ</strong>ï¼šå¤šä¸ªåƒåœ¾å›æ”¶çº¿ç¨‹åŒæ—¶å·¥ä½œï¼Œè€Œä¸æ˜¯åªæœ‰ä¸€ä¸ªåƒåœ¾å›æ”¶çº¿ç¨‹åœ¨å·¥ä½œ</li>
<li><strong>å¹¶å‘</strong>ï¼šåƒåœ¾å›æ”¶çº¿ç¨‹å’Œåº”ç”¨ç¨‹åºçº¿ç¨‹åŒæ—¶å·¥ä½œï¼Œåº”ç”¨ç¨‹åºä¸éœ€è¦æŒ‚èµ·</li>
</ul>
<p>åœ¨è®¾è®¡æˆ–é€‰æ‹©åƒåœ¾å›æ”¶ç®—æ³•çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ä½œå‡ºä»¥ä¸‹å‡ ä¸ªæƒè¡¡ï¼š</p>
<ul>
<li><p><strong>ä¸²è¡Œ vs å¹¶è¡Œ</strong></p>
<p>ä¸²è¡Œæ”¶é›†çš„æƒ…å†µï¼Œå³ä½¿æ˜¯å¤šæ ¸ CPUï¼Œä¹Ÿåªæœ‰ä¸€ä¸ªæ ¸å¿ƒå‚ä¸æ”¶é›†ã€‚ä½¿ç”¨å¹¶è¡Œæ”¶é›†å™¨çš„è¯ï¼Œåƒåœ¾æ”¶é›†çš„å·¥ä½œå°†åˆ†é…ç»™å¤šä¸ªçº¿ç¨‹åœ¨ä¸åŒçš„ CPU ä¸ŠåŒæ—¶è¿›è¡Œã€‚å¹¶è¡Œå¯ä»¥è®©æ”¶é›†å·¥ä½œæ›´å¿«ï¼Œç¼ºç‚¹æ˜¯å¸¦æ¥çš„å¤æ‚æ€§å’Œå†…å­˜ç¢ç‰‡é—®é¢˜ã€‚</p>
</li>
<li><p><strong>å¹¶å‘ vs Stop-the-world</strong></p>
<p>å½“ stop-the-world åƒåœ¾æ”¶é›†å™¨å·¥ä½œçš„æ—¶å€™ï¼Œåº”ç”¨å°†å®Œå…¨è¢«æŒ‚èµ·ã€‚ä¸ä¹‹ç›¸å¯¹çš„ï¼Œå¹¶å‘æ”¶é›†å™¨åœ¨å¤§éƒ¨åˆ†å·¥ä½œä¸­éƒ½æ˜¯å¹¶å‘è¿›è¡Œçš„ï¼Œä¹Ÿè®¸ä¼šæœ‰å°‘é‡çš„ stop-the-worldã€‚</p>
<p>stop-the-world åƒåœ¾æ”¶é›†å™¨æ¯”å¹¶å‘æ”¶é›†å™¨ç®€å•å¾ˆå¤šï¼Œå› ä¸ºåº”ç”¨æŒ‚èµ·å<strong>å †ç©ºé—´ä¸å†å‘ç”Ÿå˜åŒ–</strong>ï¼Œå®ƒçš„ç¼ºç‚¹æ˜¯åœ¨æŸäº›åœºæ™¯ä¸‹æŒ‚èµ·çš„æ—¶é—´æˆ‘ä»¬æ˜¯ä¸èƒ½æ¥å—çš„ï¼ˆå¦‚ web åº”ç”¨ï¼‰ã€‚</p>
<p>ç›¸åº”çš„ï¼Œå¹¶å‘æ”¶é›†å™¨èƒ½å¤Ÿé™ä½æŒ‚èµ·æ—¶é—´ï¼Œä½†æ˜¯ä¹Ÿæ›´åŠ å¤æ‚ï¼Œå› ä¸ºåœ¨æ”¶é›†çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿä¼šæœ‰æ–°çš„åƒåœ¾äº§ç”Ÿï¼ŒåŒæ—¶ï¼Œéœ€è¦æœ‰é¢å¤–çš„ç©ºé—´ç”¨äºåœ¨åƒåœ¾æ”¶é›†è¿‡ç¨‹ä¸­åº”ç”¨ç¨‹åºçš„ç»§ç»­ä½¿ç”¨ã€‚</p>
</li>
<li><p><strong>å‹ç¼© vs ä¸å‹ç¼© vs å¤åˆ¶</strong></p>
<p>å½“åƒåœ¾æ”¶é›†å™¨æ ‡è®°å‡ºå†…å­˜ä¸­å“ªäº›æ˜¯æ´»çš„ï¼Œå“ªäº›æ˜¯åƒåœ¾å¯¹è±¡åï¼Œæ”¶é›†å™¨å¯ä»¥è¿›è¡Œå‹ç¼©ï¼Œå°†æ‰€æœ‰æ´»çš„å¯¹è±¡ç§»åˆ°ä¸€èµ·ï¼Œè¿™æ ·æ–°çš„å†…å­˜åˆ†é…å°±å¯ä»¥åœ¨å‰©ä½™çš„ç©ºé—´ä¸­è¿›è¡Œäº†ã€‚ç»è¿‡å‹ç¼©åï¼Œåˆ†é…æ–°å¯¹è±¡çš„å†…å­˜ç©ºé—´æ˜¯éå¸¸ç®€å•å¿«é€Ÿçš„ã€‚</p>
<p>ç›¸å¯¹çš„ï¼Œä¸å‹ç¼©çš„æ”¶é›†å™¨åªä¼šå°±åœ°é‡Šæ”¾ç©ºé—´ï¼Œä¸ä¼šç§»åŠ¨å­˜æ´»å¯¹è±¡ã€‚ä¼˜ç‚¹å°±æ˜¯å¿«é€Ÿå®Œæˆåƒåœ¾æ”¶é›†ï¼Œç¼ºç‚¹å°±æ˜¯æ½œåœ¨çš„ç¢ç‰‡é—®é¢˜ã€‚é€šå¸¸ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œåˆ†é…å¯¹è±¡ç©ºé—´ä¼šæ¯”è¾ƒæ…¢æ¯”è¾ƒå¤æ‚ï¼Œæ¯”å¦‚ä¸ºæ–°çš„ä¸€ä¸ªå¤§å¯¹è±¡æ‰¾åˆ°åˆé€‚çš„ç©ºé—´ã€‚</p>
<p>è¿˜æœ‰ä¸€ä¸ªé€‰æ‹©å°±æ˜¯å¤åˆ¶æ”¶é›†å™¨ï¼Œå°†æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€å—ç©ºé—´ä¸­ï¼Œä¼˜ç‚¹å°±æ˜¯åŸç©ºé—´è¢«æ¸…ç©ºäº†ï¼Œè¿™æ ·åç»­åˆ†é…å¯¹è±¡ç©ºé—´éå¸¸è¿…é€Ÿï¼Œç¼ºç‚¹å°±æ˜¯éœ€è¦è¿›è¡Œå¤åˆ¶æ“ä½œå’Œå ç”¨é¢å¤–çš„ç©ºé—´ã€‚</p>
</li>
</ul>
<h3 id="æ€§èƒ½æŒ‡æ ‡"><a href="#æ€§èƒ½æŒ‡æ ‡" class="headerlink" title="æ€§èƒ½æŒ‡æ ‡"></a>æ€§èƒ½æŒ‡æ ‡</h3><p>ä»¥ä¸‹å‡ ä¸ªæ˜¯è¯„ä¼°åƒåœ¾æ”¶é›†å™¨æ€§èƒ½çš„ä¸€äº›æŒ‡æ ‡ï¼š</p>
<ul>
<li>ååé‡ï¼šåº”ç”¨ç¨‹åºçš„æ‰§è¡Œæ—¶é—´å æ€»æ—¶é—´çš„ç™¾åˆ†æ¯”ï¼Œå½“ç„¶æ˜¯è¶Šé«˜è¶Šå¥½</li>
<li>åƒåœ¾æ”¶é›†å¼€é”€ï¼šåƒåœ¾æ”¶é›†æ—¶é—´å æ€»æ—¶é—´çš„ç™¾åˆ†æ¯”ï¼ˆ1 - ååé‡ï¼‰</li>
<li>åœé¡¿æ—¶é—´ï¼šåƒåœ¾æ”¶é›†è¿‡ç¨‹ä¸­å¯¼è‡´çš„åº”ç”¨ç¨‹åºæŒ‚èµ·æ—¶é—´</li>
<li>é¢‘æ¬¡ï¼šç›¸å¯¹äºåº”ç”¨ç¨‹åºæ¥è¯´ï¼Œåƒåœ¾æ”¶é›†çš„é¢‘æ¬¡</li>
<li>ç©ºé—´ï¼šåƒåœ¾æ”¶é›†å ç”¨çš„å†…å­˜</li>
<li>åŠæ—¶æ€§ï¼šä¸€ä¸ªå¯¹è±¡ä»æˆä¸ºåƒåœ¾åˆ°è¯¥å¯¹è±¡ç©ºé—´å†æ¬¡å¯ç”¨çš„æ—¶é—´</li>
</ul>
<p>åœ¨äº¤äº’å¼ç¨‹åºä¸­ï¼Œé€šå¸¸å¸Œæœ›æ˜¯ä½å»¶æ—¶çš„ï¼Œè€Œå¯¹äºéäº¤äº’å¼ç¨‹åºï¼Œæ€»è¿è¡Œæ—¶é—´æ¯”è¾ƒé‡è¦ã€‚å®æ—¶åº”ç”¨ç¨‹åºæ—¢è¦æ±‚æ¯æ¬¡åœé¡¿æ—¶é—´è¶³å¤ŸçŸ­ï¼Œä¹Ÿè¦æ±‚æ€»çš„èŠ±è´¹åœ¨æ”¶é›†çš„æ—¶é—´è¶³å¤ŸçŸ­ã€‚åœ¨å°å‹ä¸ªäººè®¡ç®—æœºå’ŒåµŒå…¥å¼ç³»ç»Ÿä¸­ï¼Œåˆ™å¸Œæœ›å ç”¨æ›´å°çš„ç©ºé—´ã€‚</p>
<h3 id="åˆ†ä»£æ”¶é›†ä»‹ç»"><a href="#åˆ†ä»£æ”¶é›†ä»‹ç»" class="headerlink" title="åˆ†ä»£æ”¶é›†ä»‹ç»"></a>åˆ†ä»£æ”¶é›†ä»‹ç»</h3><p>å½“æˆ‘ä»¬ä½¿ç”¨åˆ†ä»£åƒåœ¾æ”¶é›†å™¨æ—¶ï¼Œå†…å­˜å°†è¢«åˆ†ä¸ºä¸åŒçš„<strong>ä»£(generation)<strong>ï¼Œæœ€å¸¸è§çš„å°±æ˜¯åˆ†ä¸º</strong>å¹´è½»ä»£</strong>å’Œ<strong>è€å¹´ä»£</strong>ã€‚</p>
<p>åœ¨ä¸åŒçš„åˆ†ä»£ä¸­ï¼Œå¯ä»¥æ ¹æ®ä¸åŒçš„ç‰¹ç‚¹ä½¿ç”¨ä¸åŒçš„ç®—æ³•ã€‚åˆ†ä»£åƒåœ¾æ”¶é›†åŸºäº <strong>weak generational hypothesis</strong> å‡è®¾ï¼ˆé€šå¸¸å›½äººä¼šç¿»è¯‘æˆ <strong>å¼±åˆ†ä»£</strong>å‡è®¾ï¼‰ï¼š</p>
<ul>
<li>å¤§éƒ¨åˆ†å¯¹è±¡éƒ½æ˜¯çŸ­å‘½çš„ï¼Œå®ƒä»¬åœ¨å¹´è½»çš„æ—¶å€™å°±ä¼šæ­»å»</li>
<li>æå°‘è€å¹´å¯¹è±¡å¯¹å¹´è½»å¯¹è±¡çš„å¼•ç”¨</li>
</ul>
<p>å¹´è½»ä»£ä¸­çš„æ”¶é›†æ˜¯éå¸¸é¢‘ç¹çš„ã€é«˜æ•ˆçš„ã€å¿«é€Ÿçš„ï¼Œå› ä¸ºå¹´è½»ä»£ç©ºé—´ä¸­ï¼Œé€šå¸¸éƒ½æ˜¯å°å¯¹è±¡ï¼ŒåŒæ—¶æœ‰éå¸¸å¤šçš„ä¸å†è¢«å¼•ç”¨çš„å¯¹è±¡ã€‚</p>
<p>é‚£äº›<strong>ç»å†è¿‡å¤šæ¬¡å¹´è½»ä»£åƒåœ¾æ”¶é›†è¿˜å­˜æ´»çš„å¯¹è±¡</strong>ä¼šæ™‹å‡åˆ°è€å¹´ä»£ä¸­ï¼Œè€å¹´ä»£çš„ç©ºé—´æ›´å¤§ï¼Œè€Œä¸”å ç”¨ç©ºé—´å¢é•¿æ¯”è¾ƒæ…¢ã€‚è¿™æ ·ï¼Œè€å¹´ä»£çš„åƒåœ¾æ”¶é›†æ˜¯ä¸é¢‘ç¹çš„ï¼Œä½†æ˜¯è¿›è¡Œä¸€æ¬¡åƒåœ¾æ”¶é›†éœ€è¦çš„æ—¶é—´æ›´é•¿ã€‚</p>
<p>å¯¹äºæ–°ç”Ÿä»£ï¼Œéœ€è¦é€‰æ‹©é€Ÿåº¦æ¯”è¾ƒå¿«çš„åƒåœ¾å›æ”¶ç®—æ³•ï¼Œå› ä¸ºæ–°ç”Ÿä»£çš„åƒåœ¾å›æ”¶æ˜¯é¢‘ç¹çš„ã€‚</p>
<p>å¯¹äºè€å¹´ä»£ï¼Œéœ€è¦è€ƒè™‘çš„æ˜¯ç©ºé—´ï¼Œå› ä¸ºè€å¹´ä»£å ç”¨äº†å¤§éƒ¨åˆ†å †å†…å­˜ï¼Œè€Œä¸”é’ˆå¯¹è¯¥éƒ¨åˆ†çš„åƒåœ¾å›æ”¶ç®—æ³•ï¼Œéœ€è¦è€ƒè™‘åˆ°è¿™ä¸ªåŒºåŸŸçš„<strong>åƒåœ¾å¯†åº¦æ¯”è¾ƒä½</strong>ã€‚</p>
<h2 id="J2SE-5-0-HotSpot-JVM-ä¸­çš„åƒåœ¾æ”¶é›†å™¨"><a href="#J2SE-5-0-HotSpot-JVM-ä¸­çš„åƒåœ¾æ”¶é›†å™¨" class="headerlink" title="J2SE 5.0 HotSpot JVM ä¸­çš„åƒåœ¾æ”¶é›†å™¨"></a>J2SE 5.0 HotSpot JVM ä¸­çš„åƒåœ¾æ”¶é›†å™¨</h2><p>J2SE 5.0 HotSpot è™šæ‹ŸæœºåŒ…å«å››ç§åƒåœ¾æ”¶é›†å™¨ï¼Œéƒ½æ˜¯é‡‡ç”¨åˆ†ä»£ç®—æ³•ã€‚åŒ…æ‹¬<strong>ä¸²è¡Œæ”¶é›†å™¨</strong>ã€<strong>å¹¶è¡Œæ”¶é›†å™¨</strong>ã€<strong>å¹¶è¡Œå‹ç¼©æ”¶é›†å™¨</strong> å’Œ <strong>CMS åƒåœ¾æ”¶é›†å™¨</strong>ã€‚</p>
<h3 id="HotSpot-åˆ†ä»£"><a href="#HotSpot-åˆ†ä»£" class="headerlink" title="HotSpot åˆ†ä»£"></a>HotSpot åˆ†ä»£</h3><p>åœ¨ HotSpot è™šæ‹Ÿæœºä¸­ï¼Œå†…å­˜è¢«ç»„ç»‡æˆä¸‰ä¸ªåˆ†ä»£ï¼šå¹´è½»ä»£ã€è€å¹´ä»£ã€æ°¸ä¹…ä»£ã€‚</p>
<p>ä¸€èˆ¬å°† Java å †åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ ¹æ®å„ä¸ªå¹´ä»£çš„ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„åƒåœ¾æ”¶é›†ç®—æ³•ã€‚</p>
<p>æ¯”å¦‚åœ¨æ–°ç”Ÿä»£ä¸­ï¼Œæ¯æ¬¡æ”¶é›†éƒ½ä¼šæœ‰å¤§é‡å¯¹è±¡æ­»å»ï¼Œæ‰€ä»¥å¯ä»¥é€‰æ‹©â€œå¤åˆ¶â€ç®—æ³•ï¼Œåªéœ€è¦ä»˜å‡ºå°‘é‡å¯¹è±¡çš„å¤åˆ¶æˆæœ¬å°±å¯ä»¥å®Œæˆæ¯æ¬¡åƒåœ¾æ”¶é›†ã€‚è€Œè€å¹´ä»£çš„å¯¹è±¡å­˜æ´»å‡ ç‡æ˜¯æ¯”è¾ƒé«˜çš„ï¼Œè€Œä¸”æ²¡æœ‰é¢å¤–çš„ç©ºé—´å¯¹å®ƒè¿›è¡Œåˆ†é…æ‹…ä¿ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»é€‰æ‹©â€œæ ‡è®°-æ¸…é™¤â€æˆ–â€œæ ‡è®°-æ•´ç†â€ç®—æ³•è¿›è¡Œåƒåœ¾æ”¶é›†ã€‚</p>
<p>å¤§éƒ¨åˆ†å¯¹è±¡åˆå§‹åŒ–çš„æ—¶å€™éƒ½æ˜¯åœ¨å¹´è½»ä»£ä¸­çš„ã€‚</p>
<p>è€å¹´ä»£å­˜æ”¾ç»è¿‡äº†å‡ æ¬¡å¹´è½»ä»£åƒåœ¾æ”¶é›†ä¾ç„¶è¿˜æ´»ç€çš„å¯¹è±¡ï¼Œè¿˜æœ‰éƒ¨åˆ†å¤§å¯¹è±¡å› ä¸ºæ¯”è¾ƒå¤§æ‰€ä»¥åˆ†é…çš„æ—¶å€™ç›´æ¥åœ¨è€å¹´ä»£åˆ†é…ã€‚</p>
<blockquote>
<p>å¦‚ -XX:PretenureSizeThreshold=1024ï¼Œè¿™æ ·å¤§äº 1k çš„å¯¹è±¡å°±ä¼šç›´æ¥åˆ†é…åœ¨è€å¹´ä»£</p>
</blockquote>
<p>æ°¸ä¹…ä»£ï¼Œé€šå¸¸ä¹Ÿå« <strong>æ–¹æ³•åŒº</strong>ï¼Œç”¨äºå­˜å‚¨å·²åŠ è½½ç±»çš„å…ƒæ•°æ®ï¼Œä»¥åŠå­˜å‚¨è¿è¡Œæ—¶å¸¸é‡æ± ç­‰ã€‚</p>
<h3 id="åƒåœ¾å›æ”¶ç±»å‹-Young-MinorGC-Full-MajorGC"><a href="#åƒåœ¾å›æ”¶ç±»å‹-Young-MinorGC-Full-MajorGC" class="headerlink" title="åƒåœ¾å›æ”¶ç±»å‹(Young/MinorGC, Full/MajorGC)"></a>åƒåœ¾å›æ”¶ç±»å‹(Young/MinorGC, Full/MajorGC)</h3><p>å½“å¹´è½»ä»£è¢«å¡«æ»¡åï¼Œä¼šè¿›è¡Œä¸€æ¬¡å¹´è½»ä»£åƒåœ¾æ”¶é›†ï¼ˆä¹Ÿå«åš <strong>minor GC</strong>ï¼‰ã€‚</p>
<blockquote>
<p>ä¸‹é¢è¿™ä¸¤æ®µæˆ‘ä¹Ÿæ²¡æœ‰å®Œå…¨å¼„æ˜ç™½ï¼Œå¼„æ˜ç™½ä¼šæ›´æ–°ã€‚è‡³å°‘è¯»è€…è¦æ˜ç™½ä¸€ç‚¹ï¼Œâ€minor gc æ”¶é›†å¹´è½»ä»£ï¼Œfull gc æ”¶é›†è€å¹´ä»£â€ è¿™å¥è¯æ˜¯é”™çš„ã€‚</p>
</blockquote>
<p>å½“è€å¹´ä»£æˆ–æ°¸ä¹…ä»£è¢«å¡«æ»¡äº†ï¼Œä¼šè§¦å‘ <strong>full GC</strong>ï¼ˆä¹Ÿå«åš <strong>major GC</strong>ï¼‰ï¼Œfull GC ä¼šæ”¶é›†æ‰€æœ‰åŒºåŸŸï¼Œå…ˆè¿›è¡Œå¹´è½»ä»£çš„æ”¶é›†ï¼Œä½¿ç”¨å¹´è½»ä»£ä¸“ç”¨çš„åƒåœ¾å›æ”¶ç®—æ³•ï¼Œç„¶åä½¿ç”¨è€å¹´ä»£çš„åƒåœ¾å›æ”¶ç®—æ³•<strong>å›æ”¶è€å¹´ä»£å’Œæ°¸ä¹…ä»£</strong>ã€‚å¦‚æœç®—æ³•å¸¦æœ‰å‹ç¼©ï¼Œæ¯ä¸ªä»£åˆ†åˆ«ç‹¬ç«‹åœ°è¿›è¡Œå‹ç¼©ã€‚</p>
<p>å¦‚æœå…ˆè¿›è¡Œå¹´è½»ä»£åƒåœ¾æ”¶é›†ï¼Œä½¿å¾—è€å¹´ä»£ä¸èƒ½å®¹çº³è¦æ™‹å‡ä¸Šæ¥çš„å¯¹è±¡ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸ä¼šå…ˆè¿›è¡Œ young gcï¼Œæ‰€æœ‰çš„æ”¶é›†å™¨éƒ½ä¼šï¼ˆé™¤äº† CMSï¼‰<strong>ç›´æ¥é‡‡ç”¨è€å¹´ä»£æ”¶é›†ç®—æ³•å¯¹æ•´ä¸ªå †è¿›è¡Œæ”¶é›†</strong>ï¼ˆCMS æ”¶é›†å™¨æ¯”è¾ƒç‰¹æ®Šï¼Œå› ä¸ºå®ƒä¸èƒ½æ”¶é›†å¹´è½»ä»£çš„åƒåœ¾ï¼‰ã€‚</p>
<blockquote>
<p>åŸºäºç»Ÿè®¡ï¼Œè®¡ç®—å‡ºæ¯æ¬¡å¹´è½»ä»£æ™‹å‡åˆ°è€å¹´ä»£çš„å¹³å‡å¤§å°ï¼Œif (è€å¹´ä»£å‰©ä½™ç©ºé—´ &lt; å¹³å‡å¤§å°) è§¦å‘ full gcã€‚</p>
</blockquote>
<h3 id="å¿«é€Ÿåˆ†é…-bump-the-pointer"><a href="#å¿«é€Ÿåˆ†é…-bump-the-pointer" class="headerlink" title="å¿«é€Ÿåˆ†é…(bump the pointer)"></a>å¿«é€Ÿåˆ†é…(bump the pointer)</h3><p>å¦‚æœåƒåœ¾æ”¶é›†å®Œæˆåï¼Œå­˜åœ¨å¤§ç‰‡è¿ç»­çš„å†…å­˜å¯ç”¨äºåˆ†é…ç»™æ–°å¯¹è±¡ï¼Œè¿™ç§æƒ…å†µä¸‹åˆ†é…ç©ºé—´æ˜¯éå¸¸ç®€å•å¿«é€Ÿçš„ï¼Œåªè¦ä¸€ä¸ªç®€å•çš„æŒ‡é’ˆç¢°æ’å°±å¯ä»¥äº†ï¼ˆ<strong>bump-the-pointer</strong>ï¼‰ï¼Œæ¯æ¬¡åˆ†é…å¯¹è±¡ç©ºé—´åªè¦æ£€æµ‹ä¸€ä¸‹æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œå¦‚æœæœ‰ï¼ŒæŒ‡é’ˆå¾€å‰ç§»åŠ¨ N ä½å°±åˆ†é…å¥½ç©ºé—´äº†ï¼Œç„¶åå°±å¯ä»¥åˆå§‹åŒ–è¿™ä¸ªå¯¹è±¡äº†ã€‚</p>
<p>å¯¹äºå¤šçº¿ç¨‹åº”ç”¨ï¼Œå¯¹è±¡åˆ†é…å¿…é¡»è¦ä¿è¯çº¿ç¨‹å®‰å…¨æ€§ï¼Œå¦‚æœä½¿ç”¨å…¨å±€é”ï¼Œé‚£ä¹ˆåˆ†é…ç©ºé—´å°†æˆä¸ºç“¶é¢ˆå¹¶é™ä½ç¨‹åºæ€§èƒ½ã€‚HotSpot ä½¿ç”¨äº†ç§°ä¹‹ä¸º <strong>Thread-Local Allocation Buffers (TLABs)</strong> çš„æŠ€æœ¯ï¼Œè¯¥æŠ€æœ¯èƒ½æ”¹å–„å¤šçº¿ç¨‹ç©ºé—´åˆ†é…çš„ååé‡ã€‚é¦–å…ˆï¼Œç»™äºˆæ¯ä¸ªçº¿ç¨‹ä¸€éƒ¨åˆ†å†…å­˜ä½œä¸ºç¼“å­˜åŒºï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½åœ¨è‡ªå·±çš„ç¼“å­˜åŒºä¸­è¿›è¡ŒæŒ‡é’ˆç¢°æ’ï¼Œè¿™æ ·å°±ä¸ç”¨è·å–å…¨å±€é”äº†ã€‚åªæœ‰å½“ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨å®Œäº†å®ƒçš„ TLABï¼Œå®ƒæ‰éœ€è¦ä½¿ç”¨åŒæ­¥æ¥è·å–ä¸€ä¸ªæ–°çš„ç¼“å†²åŒºã€‚HotSpot ä½¿ç”¨äº†å¤šé¡¹æŠ€æœ¯æ¥é™ä½ TLAB å¯¹äºå†…å­˜çš„æµªè´¹ã€‚æ¯”å¦‚ï¼ŒTLAB çš„å¹³å‡å¤§å°è¢«é™åˆ¶åœ¨ Eden åŒºå¤§å°çš„ 1% ä¹‹å†…ã€‚TLABs å’Œä½¿ç”¨æŒ‡é’ˆç¢°æ’çš„çº¿æ€§åˆ†é…ç»“åˆï¼Œä½¿å¾—å†…å­˜åˆ†é…éå¸¸ç®€å•é«˜æ•ˆï¼Œåªéœ€è¦å¤§æ¦‚ 10 æ¡æœºå™¨æŒ‡ä»¤å°±å¯ä»¥å®Œæˆã€‚</p>
<h3 id="ä¸²è¡Œæ”¶é›†å™¨-Serial-Collector"><a href="#ä¸²è¡Œæ”¶é›†å™¨-Serial-Collector" class="headerlink" title="ä¸²è¡Œæ”¶é›†å™¨(==Serial== Collector)"></a>ä¸²è¡Œæ”¶é›†å™¨(==Serial== Collector)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -XX:+UseSerialGC -jar Application.java</span><br></pre></td></tr></table></figure>

<p><img src="https://pub-9e727eae11e040a4aa2b1feedc2608d2.r2.dev/PicGo/serial-garbage-collector.png" alt="Serial æ”¶é›†å™¨"></p>
<p>ä½¿ç”¨ä¸²è¡Œæ”¶é›†å™¨ï¼Œå¹´è½»ä»£å’Œè€å¹´ä»£éƒ½ä½¿ç”¨å•çº¿ç¨‹è¿›è¡Œæ”¶é›†ï¼ˆä½¿ç”¨ä¸€ä¸ª CPUï¼‰ï¼Œæ”¶é›†è¿‡ç¨‹ä¸­ä¼š stop-the-worldã€‚æ‰€ä»¥å½“åœ¨åƒåœ¾æ”¶é›†çš„æ—¶å€™ï¼Œåº”ç”¨ç¨‹åºæ˜¯å®Œå…¨åœæ­¢çš„ã€‚</p>
<h4 id="å¹´è½»ä»£â€”â€”å¤åˆ¶ç®—æ³•"><a href="#å¹´è½»ä»£â€”â€”å¤åˆ¶ç®—æ³•" class="headerlink" title="å¹´è½»ä»£â€”â€”å¤åˆ¶ç®—æ³•"></a><strong>å¹´è½»ä»£</strong>â€”â€”<strong>å¤åˆ¶ç®—æ³•</strong></h4><p>å¤åˆ¶ç®—æ³•æ¯”è¾ƒé€‚åˆå¹´è½»ä»£è¿™ç§å¯¹è±¡æ•°é‡å°‘ï¼Œä½“ç§¯ä¹Ÿå°çš„åŒºåŸŸ</p>
<p>ä¸‹å›¾å±•ç¤ºäº†å¹´è½»ä»£ä¸­ä½¿ç”¨ä¸²è¡Œæ”¶é›†å™¨çš„æµç¨‹ã€‚</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/jvm-memory-management/3.png" alt="3"></p>
<p>å¹´è½»ä»£åˆ†ä¸º<strong>ä¸€ä¸ª Eden åŒºå’Œä¸¤ä¸ª Survivor åŒºï¼ˆFrom åŒºå’Œ To åŒºï¼‰</strong>ã€‚å¹´è½»ä»£åƒåœ¾æ”¶é›†æ—¶ï¼Œå°† Eden ä¸­æ´»ç€çš„å¯¹è±¡å¤åˆ¶åˆ°ç©ºçš„ Survivor-To åŒºï¼ŒSurvivor-From åŒºçš„å¯¹è±¡åˆ†ä¸¤ç±»ï¼Œä¸€ç±»æ˜¯å¹´è½»çš„ï¼Œä¹Ÿæ˜¯å¤åˆ¶åˆ° Survivor-To åŒºï¼Œè¿˜æœ‰ä¸€ç±»æ˜¯è€å®¶ä¼™ï¼Œæ™‹å‡åˆ°è€å¹´ä»£ä¸­ã€‚</p>
<blockquote>
<p>Survivor-From å’Œ Survivor-To æ˜¯æˆ‘çå–çš„åå­—ã€‚ã€‚ã€‚</p>
</blockquote>
<p>å¦‚æœå¤åˆ¶çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç° Survivor-To ç©ºé—´æ»¡äº†ï¼Œå°†å‰©ä¸‹è¿˜æ²¡å¤åˆ¶åˆ° Survivor-To çš„æ¥è‡ªäº Eden å’Œ Survivor-From åŒºçš„å¯¹è±¡ç›´æ¥æ™‹å‡åˆ°è€å¹´ä»£ã€‚</p>
<p>å¹´è½»ä»£åƒåœ¾æ”¶é›†å®Œæˆåï¼ŒEden åŒºå’Œ Survivor-From å°±å¹²å‡€äº†ï¼Œæ­¤æ—¶ï¼Œå°† Survivor-From å’Œ Survivor-To äº¤æ¢ä¸€ä¸‹è§’è‰²ã€‚å¾—åˆ°ä¸‹é¢è¿™ä¸ªæ ·å­ï¼š</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/jvm-memory-management/4.png" alt="4"></p>
<h4 id="è€å¹´ä»£â€”â€”æ ‡è®°-å‹ç¼©ç®—æ³•"><a href="#è€å¹´ä»£â€”â€”æ ‡è®°-å‹ç¼©ç®—æ³•" class="headerlink" title="è€å¹´ä»£â€”â€”æ ‡è®°-å‹ç¼©ç®—æ³•"></a><strong>è€å¹´ä»£â€”â€”æ ‡è®°-å‹ç¼©ç®—æ³•</strong></h4><p>æ ‡è®°å‹ç¼©ä¸æ˜¯ç›´æ¥å›æ”¶ä¸å¯è¾¾å¯¹è±¡ï¼ˆåƒåœ¾ï¼‰ï¼Œè€Œæ˜¯è®©æ‰€æœ‰å­˜æ´»å¯¹è±¡å‘åŒä¸€ä¾§ç´§ç¼©ã€‚</p>
<p>å¦‚æœä½¿ç”¨ä¸²è¡Œæ”¶é›†å™¨ï¼Œåœ¨è€å¹´ä»£å’Œæ°¸ä¹…ä»£å°†é€šè¿‡ä½¿ç”¨ <strong>æ ‡è®° -&gt; æ¸…é™¤ -&gt; å‹ç¼©</strong> ç®—æ³•ã€‚æ ‡è®°é˜¶æ®µï¼Œæ”¶é›†å™¨è¯†åˆ«å‡ºå“ªäº›å¯¹è±¡æ˜¯æ´»çš„ï¼›æ¸…é™¤é˜¶æ®µå°†éå†ä¸€ä¸‹è€å¹´ä»£å’Œæ°¸ä¹…ä»£ï¼Œè¯†åˆ«å‡ºå“ªäº›æ˜¯åƒåœ¾ï¼›ç„¶åæ‰§è¡Œå‹ç¼©ï¼Œå°†æ´»çš„å¯¹è±¡å·¦ç§»åˆ°è€å¹´ä»£çš„èµ·å§‹ç«¯ï¼ˆæ°¸ä¹…ä»£ç±»ä¼¼ï¼‰ï¼Œè¿™æ ·å°±ç•™ä¸‹äº†å³è¾¹ä¸€ç‰‡è¿ç»­å¯ç”¨çš„ç©ºé—´ï¼Œåç»­å°±å¯ä»¥é€šè¿‡æŒ‡é’ˆç¢°æ’çš„æ–¹å¼å¿«é€Ÿåˆ†é…å¯¹è±¡ç©ºé—´ã€‚</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/jvm-memory-management/5.png" alt="5"></p>
<h4 id="ä½•æ—¶åº”è¯¥ä½¿ç”¨ä¸²è¡Œæ”¶é›†å™¨"><a href="#ä½•æ—¶åº”è¯¥ä½¿ç”¨ä¸²è¡Œæ”¶é›†å™¨" class="headerlink" title="ä½•æ—¶åº”è¯¥ä½¿ç”¨ä¸²è¡Œæ”¶é›†å™¨"></a><strong>ä½•æ—¶åº”è¯¥ä½¿ç”¨ä¸²è¡Œæ”¶é›†å™¨</strong></h4><p>ä¸²è¡Œæ”¶é›†å™¨é€‚ç”¨äºè¿è¡Œåœ¨ client æ¨¡å¼ä¸‹çš„å¤§éƒ¨åˆ†ç¨‹åºï¼Œå®ƒä»¬ä¸è¦æ±‚ä½å»¶æ—¶ã€‚åœ¨ç°ä»£ç¡¬ä»¶æ¡ä»¶ä¸‹ï¼Œä¸²è¡Œæ”¶é›†å™¨å¯ä»¥é«˜æ•ˆç®¡ç† 64M å †å†…å­˜ï¼Œå¹¶ä¸”èƒ½å°† full GC æ§åˆ¶åœ¨åŠç§’å†…å®Œæˆã€‚åªä½¿ç”¨ <strong>å•çº¿ç¨‹</strong> æ‰§è¡Œå›æ”¶ï¼Œè™½ç„¶å®ç°ç®€å•ï¼Œä½†å›æ”¶æ•ˆç‡è¾ƒä½ï¼ŒSTW æ—¶é—´å¯èƒ½è¾ƒé•¿ã€‚</p>
<p>ä¸²è¡Œ GC åœ¨å¹´è½»ä»£å’Œè€å¹´ä»£çš„å›æ”¶è¿‡ç¨‹ä¸­éƒ½éœ€è¦æš‚åœæ‰€æœ‰åº”ç”¨çº¿ç¨‹ã€‚</p>
<h5 id="ä½¿ç”¨ä¸²è¡Œæ”¶é›†å™¨"><a href="#ä½¿ç”¨ä¸²è¡Œæ”¶é›†å™¨" class="headerlink" title="ä½¿ç”¨ä¸²è¡Œæ”¶é›†å™¨"></a><strong>ä½¿ç”¨ä¸²è¡Œæ”¶é›†å™¨</strong></h5><p>å®ƒæ˜¯ J2SE 5.0 ç‰ˆæœ¬ HotSpot è™šæ‹Ÿæœºåœ¨éæœåŠ¡å™¨çº§åˆ«ç¡¬ä»¶çš„é»˜è®¤é€‰æ‹©ã€‚ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>-XX:+UseSerialGC</code> æ¥å¼ºåˆ¶ä½¿ç”¨ä¸²è¡Œæ”¶é›†å™¨ã€‚</p>
<h3 id="å¹¶è¡Œæ”¶é›†å™¨-Parallel-Collector"><a href="#å¹¶è¡Œæ”¶é›†å™¨-Parallel-Collector" class="headerlink" title="å¹¶è¡Œæ”¶é›†å™¨(Parallel Collector)"></a>å¹¶è¡Œæ”¶é›†å™¨(Parallel Collector)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -XX:+UseParallelGC -jar Application.java</span><br></pre></td></tr></table></figure>

<p><img src="https://pub-9e727eae11e040a4aa2b1feedc2608d2.r2.dev/PicGo/parnew-garbage-collector.png" alt="ParNew æ”¶é›†å™¨ "></p>
<p>ç°åœ¨å¤§å¤šæ•° Java åº”ç”¨éƒ½è¿è¡Œåœ¨å¤§å†…å­˜ã€å¤šæ ¸ç¯å¢ƒä¸­ï¼Œ<strong>å¹¶è¡Œæ”¶é›†å™¨</strong>ï¼Œä¹Ÿå°±æ˜¯å¤§å®¶ç†ŸçŸ¥çš„<strong>ååé‡æ”¶é›†å™¨</strong>ï¼Œåˆ©ç”¨å¤šæ ¸çš„ä¼˜åŠ¿æ¥è¿›è¡Œåƒåœ¾æ”¶é›†ï¼Œè€Œä¸æ˜¯åƒä¸²è¡Œæ”¶é›†å™¨ä¸€æ ·å°†ç¨‹åºæŒ‚èµ·ååªä½¿ç”¨å•çº¿ç¨‹æ¥æ”¶é›†åƒåœ¾ã€‚å¹¶è¡Œ GC é€‚åˆå¤§å†…å­˜å’Œå¤šæ ¸ç¯å¢ƒï¼Œé€šè¿‡å¤šçº¿ç¨‹é™ä½ STW æ—¶é—´ï¼Œä½†ä»ç„¶éœ€è¦STWæš‚åœåº”ç”¨ç¨‹åºã€‚</p>
<h4 id="å¹´è½»ä»£â€”å¤åˆ¶ç®—æ³•ï¼ˆå¤šçº¿ç¨‹ï¼‰"><a href="#å¹´è½»ä»£â€”å¤åˆ¶ç®—æ³•ï¼ˆå¤šçº¿ç¨‹ï¼‰" class="headerlink" title="å¹´è½»ä»£â€”å¤åˆ¶ç®—æ³•ï¼ˆå¤šçº¿ç¨‹ï¼‰"></a><strong>å¹´è½»ä»£â€”å¤åˆ¶ç®—æ³•ï¼ˆå¤šçº¿ç¨‹ï¼‰</strong></h4><p>å¹¶è¡Œæ”¶é›†å™¨åœ¨å¹´è½»ä»£ä¸­å…¶å®å°±æ˜¯ä¸²è¡Œæ”¶é›†å™¨æ”¶é›†ç®—æ³•çš„å¹¶è¡Œç‰ˆæœ¬ã€‚å®ƒä»ç„¶ä½¿ç”¨ stop-the-world å’Œå¤åˆ¶ç®—æ³•ï¼Œåªä¸è¿‡ä½¿ç”¨äº†å¤šæ ¸çš„ä¼˜åŠ¿å¹¶è¡Œæ‰§è¡Œï¼Œé™ä½åƒåœ¾æ”¶é›†çš„æ—¶é—´ï¼Œä»è€Œæé«˜ååé‡ã€‚ä¸‹å›¾ç¤ºæ„äº†åœ¨å¹´è½»ä»£ä¸­ï¼Œä¸²è¡Œæ”¶é›†å™¨å’Œå¹¶è¡Œæ”¶é›†å™¨çš„åŒºåˆ«ï¼š</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/jvm-memory-management/6.png" alt="6"></p>
<h4 id="è€å¹´ä»£â€”æ ‡è®°-å‹ç¼©ç®—æ³•ï¼ˆå•çº¿ç¨‹ï¼‰"><a href="#è€å¹´ä»£â€”æ ‡è®°-å‹ç¼©ç®—æ³•ï¼ˆå•çº¿ç¨‹ï¼‰" class="headerlink" title="è€å¹´ä»£â€”æ ‡è®°-å‹ç¼©ç®—æ³•ï¼ˆå•çº¿ç¨‹ï¼‰"></a><strong>è€å¹´ä»£â€”æ ‡è®°-å‹ç¼©ç®—æ³•ï¼ˆå•çº¿ç¨‹ï¼‰</strong></h4><p>åœ¨è€å¹´ä»£ä¸­ï¼Œå¹¶è¡Œæ”¶é›†å™¨ä½¿ç”¨çš„æ˜¯å’Œä¸²è¡Œæ”¶é›†å™¨ä¸€æ ·çš„ç®—æ³•ï¼š<strong>å•çº¿ç¨‹ï¼Œæ ‡è®° -&gt; æ¸…é™¤ -&gt; å‹ç¼©</strong>ã€‚</p>
<blockquote>
<p>æ˜¯çš„ï¼Œå¹¶è¡Œæ”¶é›†å™¨åªèƒ½åœ¨å¹´è½»ä»£ä¸­å¹¶è¡Œ</p>
</blockquote>
<h4 id="ä½•æ—¶ä½¿ç”¨å¹¶è¡Œæ”¶é›†å™¨"><a href="#ä½•æ—¶ä½¿ç”¨å¹¶è¡Œæ”¶é›†å™¨" class="headerlink" title="ä½•æ—¶ä½¿ç”¨å¹¶è¡Œæ”¶é›†å™¨"></a><strong>ä½•æ—¶ä½¿ç”¨å¹¶è¡Œæ”¶é›†å™¨</strong></h4><p>å…¶é€‚ç”¨äºå¤šæ ¸ã€ä¸è¦æ±‚ä½åœé¡¿çš„åº”ç”¨ï¼Œå› ä¸ºè€å¹´ä»£çš„æ”¶é›†è™½ç„¶ä¸é¢‘ç¹ï¼Œä½†æ˜¯æ¯æ¬¡è€å¹´ä»£çš„<strong>å•çº¿ç¨‹åƒåœ¾æ”¶é›†</strong>ä¾ç„¶å¯èƒ½ä¼šéœ€è¦å¾ˆé•¿æ—¶é—´ã€‚æ¯”å¦‚è¯´ï¼Œå®ƒå¯ä»¥åº”ç”¨åœ¨æ‰¹å¤„ç†ã€è´¦å•è®¡ç®—ã€ç§‘å­¦è®¡ç®—ç­‰ã€‚</p>
<p>ä½ åº”è¯¥ä¸ä¼šæƒ³è¦è¿™ä¸ªæ”¶é›†å™¨ï¼Œè€Œæ˜¯è¦ä¸€ä¸ªå¯ä»¥å¯¹æ¯ä¸ªä»£éƒ½é‡‡ç”¨å¹¶è¡Œæ”¶é›†çš„<strong>å¹¶è¡Œå‹ç¼©æ”¶é›†å™¨</strong>ï¼Œä¸‹ä¸€èŠ‚å°†ä»‹ç»è¿™ä¸ªã€‚</p>
<h5 id="ä½¿ç”¨å¹¶è¡Œæ”¶é›†å™¨"><a href="#ä½¿ç”¨å¹¶è¡Œæ”¶é›†å™¨" class="headerlink" title="ä½¿ç”¨å¹¶è¡Œæ”¶é›†å™¨"></a><strong>ä½¿ç”¨å¹¶è¡Œæ”¶é›†å™¨</strong></h5><p>å‰é¢æˆ‘ä»¬è¯´äº†ï¼ŒJ2SE 5.0 ä¸­ client æ¨¡å¼è‡ªåŠ¨é€‰æ‹©ä½¿ç”¨ä¸²è¡Œæ”¶é›†å™¨ï¼Œå¦‚æœæ˜¯ server æ¨¡å¼ï¼Œé‚£ä¹ˆå°†è‡ªåŠ¨ä½¿ç”¨å¹¶è¡Œæ”¶é›†å™¨ã€‚åœ¨å…¶ä»–ç‰ˆæœ¬ä¸­ï¼Œæ˜¾ç¤ºä½¿ç”¨ -XX:+UseParallelGC å¯ä»¥æŒ‡å®šå¹¶è¡Œæ”¶é›†å™¨ã€‚</p>
<h3 id="å¹¶è¡Œå‹ç¼©æ”¶é›†å™¨-Parallel-Compacting-Collector"><a href="#å¹¶è¡Œå‹ç¼©æ”¶é›†å™¨-Parallel-Compacting-Collector" class="headerlink" title="å¹¶è¡Œå‹ç¼©æ”¶é›†å™¨(==Parallel== Compacting Collector)"></a>å¹¶è¡Œå‹ç¼©æ”¶é›†å™¨(==Parallel== Compacting Collector)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UseParallelOldGC</span><br></pre></td></tr></table></figure>

<p><img src="https://pub-9e727eae11e040a4aa2b1feedc2608d2.r2.dev/PicGo/parallel-scavenge-garbage-collector-1736075580594-3.png" alt="Parallel Oldæ”¶é›†å™¨è¿è¡Œç¤ºæ„å›¾"></p>
<p>å¹¶è¡Œå‹ç¼©æ”¶é›†å™¨äº J2SE 5.0 update 6 å¼•å…¥ï¼Œå’Œå¹¶è¡Œæ”¶é›†å™¨çš„åŒºåˆ«åœ¨äºå®ƒåœ¨è€å¹´ä»£ä¹Ÿä½¿ç”¨å¹¶è¡Œæ”¶é›†ç®—æ³•ã€‚æ³¨æ„ï¼šå¹¶è¡Œå‹ç¼©æ”¶é›†å™¨ç»ˆå°†ä¼šå–ä»£å¹¶è¡Œæ”¶é›†å™¨ã€‚</p>
<h4 id="å¹´è½»ä»£â€”å¤åˆ¶ç®—æ³•ï¼ˆå¤šçº¿ç¨‹ï¼‰-1"><a href="#å¹´è½»ä»£â€”å¤åˆ¶ç®—æ³•ï¼ˆå¤šçº¿ç¨‹ï¼‰-1" class="headerlink" title="å¹´è½»ä»£â€”å¤åˆ¶ç®—æ³•ï¼ˆå¤šçº¿ç¨‹ï¼‰"></a><strong>å¹´è½»ä»£â€”å¤åˆ¶ç®—æ³•ï¼ˆå¤šçº¿ç¨‹ï¼‰</strong></h4><p>å¹¶è¡Œå‹ç¼©æ”¶é›†å™¨åœ¨å¹´è½»ä»£ä¸­ä½¿ç”¨äº†å’Œå¹¶è¡Œæ”¶é›†å™¨ä¸€æ ·çš„ç®—æ³•ã€‚å³ä½¿ç”¨ <strong>å¹¶è¡Œã€stop-the-worldã€å¤åˆ¶</strong> ç®—æ³•ã€‚</p>
<h4 id="è€å¹´ä»£â€”æ ‡è®°-æ»‘åŠ¨å‹ç¼©ç®—æ³•ï¼ˆå¤šçº¿ç¨‹ï¼‰"><a href="#è€å¹´ä»£â€”æ ‡è®°-æ»‘åŠ¨å‹ç¼©ç®—æ³•ï¼ˆå¤šçº¿ç¨‹ï¼‰" class="headerlink" title="è€å¹´ä»£â€”æ ‡è®°-æ»‘åŠ¨å‹ç¼©ç®—æ³•ï¼ˆå¤šçº¿ç¨‹ï¼‰"></a><strong>è€å¹´ä»£â€”æ ‡è®°-æ»‘åŠ¨å‹ç¼©ç®—æ³•ï¼ˆå¤šçº¿ç¨‹ï¼‰</strong></h4><p>åœ¨è€å¹´ä»£å’Œæ°¸ä¹…ä»£ä¸­ï¼Œå…¶ä½¿ç”¨ <strong>å¹¶è¡Œã€stop-the-worldã€æ»‘åŠ¨å‹ç¼©</strong> ç®—æ³•ã€‚</p>
<p>ä¸€æ¬¡æ”¶é›†åˆ†ä¸‰ä¸ªé˜¶æ®µï¼Œé¦–å…ˆï¼Œå°†è€å¹´ä»£æˆ–æ°¸ä¹…ä»£é€»è¾‘ä¸Šåˆ†ä¸ºå›ºå®šå¤§å°çš„åŒºå—ã€‚</p>
<ol>
<li><p><strong>æ ‡è®°é˜¶æ®µ</strong>ï¼Œå°† GC Roots åˆ†ç»™å¤šä¸ªåƒåœ¾æ”¶é›†çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹==å¹¶è¡Œåœ°==å»æ ‡è®°å­˜æ´»çš„å¯¹è±¡ï¼Œä¸€æ—¦æ ‡è®°ä¸€ä¸ªå­˜æ´»å¯¹è±¡ï¼Œåœ¨<strong>è¯¥å¯¹è±¡æ‰€åœ¨çš„åŒºå—</strong>è®°å½•è¿™ä¸ªå¯¹è±¡çš„å¤§å°å’Œå¯¹è±¡æ‰€åœ¨çš„ä½ç½®ã€‚(ForkJoin)</p>
</li>
<li><p><strong>æ±‡æ€»é˜¶æ®µ</strong>ï¼Œæ­¤é˜¶æ®µé’ˆå¯¹åŒºå—è¿›è¡Œã€‚ç”±äºä¹‹å‰çš„åƒåœ¾å›æ”¶å½±å“ï¼Œè€å¹´ä»£å’Œæ°¸ä¹…ä»£çš„å·¦ä¾§æ˜¯ <strong>å­˜æ´»å¯¹è±¡å¯†é›†åŒº</strong>ï¼Œå¯¹è¿™éƒ¨åˆ†åŒºåŸŸç›´æ¥è¿›è¡Œå‹ç¼©çš„ä»£ä»·æ˜¯ä¸å€¼å¾—çš„ï¼Œèƒ½æ¸…ç†å‡ºæ¥çš„ç©ºé—´æœ‰é™ã€‚æ‰€ä»¥ç¬¬ä¸€ä»¶äº‹å°±æ˜¯ï¼Œæ£€æŸ¥æ¯ä¸ªåŒºå—çš„å¯†åº¦ï¼Œä»å·¦è¾¹ç¬¬ä¸€ä¸ªå¼€å§‹ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªåŒºå—ï¼Œè¿™ä¸ªåŒºå—æ»¡è¶³å¦‚ä¸‹æ¡ä»¶ï¼š<strong>å¯¹å³ä¾§çš„æ‰€æœ‰åŒºå—è¿›è¡Œå‹ç¼©è·å¾—çš„ç©ºé—´æŠµå¾—ä¸Šå‹ç¼©å®ƒä»¬çš„æˆæœ¬</strong>ã€‚è¿™ä¸ªåŒºå—å·¦è¾¹çš„åŒºåŸŸè¿‡äºå¯†é›†ï¼Œä¸ä¼šæœ‰å¯¹è±¡ç§»åŠ¨åˆ°è¿™ä¸ªåŒºåŸŸä¸­ã€‚ç„¶åï¼Œè®¡ç®—å¹¶ä¿å­˜å³ä¾§åŒºåŸŸä¸­æ¯ä¸ªåŒºå—è¢«å‹ç¼©åçš„æ–°ä½ç½®é¦–å­—èŠ‚åœ°å€ã€‚</p>
<p>å³ä¾§çš„åŒºåŸŸå°†è¢«å‹ç¼©ï¼Œå¯¹äºå³ä¾§çš„æ¯ä¸ªåŒºå—ï¼Œç”±äºæ¯ä¸ªåŒºå—ä¸­ä¿å­˜äº†è¯¥åŒºå—çš„å­˜æ´»å¯¹è±¡ä¿¡æ¯ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“è®¡ç®—æ¯ä¸ªåŒºå—çš„æ–°ä½ç½®ã€‚æ³¨æ„ï¼š<strong>æ±‡æ€»é˜¶æ®µ==ç›®å‰è¢«å®ç°ä¸ºä¸²è¡Œ==è¿›è¡Œ</strong>ï¼Œè¿™ä¸ªé˜¶æ®µä¿®æ”¹ä¸ºå¹¶è¡Œä¹Ÿæ˜¯å¯è¡Œçš„ï¼Œä¸è¿‡æ²¡æœ‰åœ¨æ ‡è®°é˜¶æ®µå’Œä¸‹é¢çš„å‹ç¼©é˜¶æ®µå¹¶è¡Œé‚£ä¹ˆé‡è¦ã€‚</p>
</li>
<li><p><strong>å‹ç¼©é˜¶æ®µ</strong>ï¼Œåœ¨æ±‡æ€»é˜¶æ®µå·²ç»å®Œæˆäº†æ¯ä¸ªåŒºå—æ–°ä½ç½®çš„è®¡ç®—ï¼Œæ‰€ä»¥å‹ç¼©é˜¶æ®µæ¯ä¸ªå›æ”¶çº¿ç¨‹**==å¹¶è¡Œ==**å°†æ¯ä¸ªåŒºå—å¤åˆ¶åˆ°æ–°ä½ç½®å³å¯ã€‚å‹ç¼©ç»“æŸåï¼Œå°±æ¸…å‡ºæ¥äº†å³ä¾§ä¸€å¤§ç‰‡è¿ç»­å¯ç”¨çš„ç©ºé—´ã€‚</p>
</li>
</ol>
<h4 id="ä½•æ—¶ä½¿ç”¨å¹¶è¡Œå‹ç¼©æ”¶é›†å™¨"><a href="#ä½•æ—¶ä½¿ç”¨å¹¶è¡Œå‹ç¼©æ”¶é›†å™¨" class="headerlink" title="ä½•æ—¶ä½¿ç”¨å¹¶è¡Œå‹ç¼©æ”¶é›†å™¨"></a><strong>ä½•æ—¶ä½¿ç”¨å¹¶è¡Œå‹ç¼©æ”¶é›†å™¨</strong></h4><p>é¦–å…ˆæ˜¯å¤šæ ¸ä¸Šçš„å¹¶è¡Œä¼˜åŠ¿ï¼Œè¿™ä¸ªå°±ä¸é‡å¤äº†ã€‚å…¶æ¬¡ï¼Œå‰é¢çš„å¹¶è¡Œæ”¶é›†å™¨å¯¹äºè€å¹´ä»£å’Œæ°¸ä¹…ä»£ä½¿ç”¨ä¸²è¡Œï¼Œè€Œå¹¶è¡Œå‹ç¼©æ”¶é›†å™¨åœ¨è¿™äº›åŒºåŸŸä½¿ç”¨å¹¶è¡Œï¼Œèƒ½é™ä½åœé¡¿æ—¶é—´ã€‚</p>
<p>å¹¶è¡Œå‹ç¼©æ”¶é›†å™¨ä¸é€‚åˆè¿è¡Œåœ¨å¤§å‹å…±äº«ä¸»æœºä¸Šï¼ˆå¦‚ SunRaysï¼‰ï¼Œå› ä¸ºå®ƒåœ¨æ”¶é›†çš„æ—¶å€™ä¼šç‹¬å å‡ ä¸ª CPUï¼Œåœ¨è¿™ç§æœºå™¨ä¸Šï¼Œå¯ä»¥è€ƒè™‘å‡å°‘åƒåœ¾æ”¶é›†çš„çº¿ç¨‹æ•°ï¼ˆé€šè¿‡ â€“XX:ParallelGCThreads=nï¼‰ï¼Œæˆ–è€…å°±é€‰æ‹©å…¶ä»–æ”¶é›†å™¨ã€‚</p>
<h5 id="ä½¿ç”¨å¹¶è¡Œå‹ç¼©æ”¶é›†å™¨"><a href="#ä½¿ç”¨å¹¶è¡Œå‹ç¼©æ”¶é›†å™¨" class="headerlink" title="ä½¿ç”¨å¹¶è¡Œå‹ç¼©æ”¶é›†å™¨"></a><strong>ä½¿ç”¨å¹¶è¡Œå‹ç¼©æ”¶é›†å™¨</strong></h5><p>æ˜¾ç¤ºæŒ‡å®šï¼š<code>-XX:+UseParallelOldGC</code></p>
<h3 id="Concurrent-Mark-Sweepï¼ˆCMSï¼‰"><a href="#Concurrent-Mark-Sweepï¼ˆCMSï¼‰" class="headerlink" title="==Concurrent== Mark-Sweepï¼ˆCMSï¼‰"></a>==Concurrent== Mark-Sweepï¼ˆCMSï¼‰</h3><p><img src="https://pub-9e727eae11e040a4aa2b1feedc2608d2.r2.dev/PicGo/cms-garbage-collector.png" alt="CMS æ”¶é›†å™¨"></p>
<blockquote>
<p>é‡å¤´æˆ CMS ç™»åœºäº†ï¼Œè‡³å°‘å¯¹äºæˆ‘è¿™ä¸ª web å¼€å‘è€…æ¥è¯´ï¼Œ<strong>ç›®å‰</strong> CMS æœ€å¸¸ç”¨ï¼ˆä½¿ç”¨ JDK8 çš„åº”ç”¨ä¸€èˆ¬éƒ½åˆ‡æ¢åˆ° G1 æ”¶é›†å™¨äº†ï¼‰ã€‚å‰é¢ä»‹ç»çš„éƒ½æ˜¯å¹¶è¡Œæ”¶é›†ï¼Œè¿™é‡Œè¦ä»‹ç»å¹¶å‘æ”¶é›†äº†ï¼Œä¹Ÿå°±æ˜¯åƒåœ¾å›æ”¶çº¿ç¨‹å’Œåº”ç”¨ç¨‹åºçº¿ç¨‹åŒæ—¶è¿è¡Œã€‚</p>
</blockquote>
<p>å¯¹äºè®¸å¤šç¨‹åºæ¥è¯´ï¼Œååé‡ä¸å¦‚å“åº”æ—¶é—´æ¥å¾—é‡è¦ã€‚é€šå¸¸å¹´è½»ä»£çš„åƒåœ¾æ”¶é›†ä¸ä¼šåœé¡¿å¤šé•¿æ—¶é—´ï¼Œä½†æ˜¯ï¼Œè€å¹´ä»£åƒåœ¾å›æ”¶ï¼Œè™½ç„¶ä¸é¢‘ç¹ï¼Œä½†æ˜¯å¯èƒ½å¯¼è‡´é•¿æ—¶é—´çš„åœé¡¿ï¼Œå°¤å…¶å½“å †å†…å­˜æ¯”è¾ƒå¤§çš„æ—¶å€™ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒHotSpot è™šæ‹Ÿæœºæä¾›äº† CMS æ”¶é›†å™¨ï¼Œä¹Ÿå«åš <strong>ä½å»¶æ—¶æ”¶é›†å™¨</strong>ã€‚</p>
<h4 id="å¹´è½»ä»£â€”å¤åˆ¶ç®—æ³•ï¼ˆå¤šçº¿ç¨‹ï¼‰-2"><a href="#å¹´è½»ä»£â€”å¤åˆ¶ç®—æ³•ï¼ˆå¤šçº¿ç¨‹ï¼‰-2" class="headerlink" title="å¹´è½»ä»£â€”å¤åˆ¶ç®—æ³•ï¼ˆå¤šçº¿ç¨‹ï¼‰"></a><strong>å¹´è½»ä»£â€”å¤åˆ¶ç®—æ³•ï¼ˆå¤šçº¿ç¨‹ï¼‰</strong></h4><p>åœ¨å¹´è½»ä»£ä¸­ï¼ŒCMS å’Œ <strong>å¹¶è¡Œæ”¶é›†å™¨</strong> ä¸€æ ·ï¼Œå³ï¼š<strong>å¹¶è¡Œã€stop-the-worldã€å¤åˆ¶</strong>ã€‚</p>
<h4 id="è€å¹´ä»£â€”-å¹¶å‘-æ ‡è®°-æ¸…é™¤"><a href="#è€å¹´ä»£â€”-å¹¶å‘-æ ‡è®°-æ¸…é™¤" class="headerlink" title="è€å¹´ä»£â€”==å¹¶å‘==æ ‡è®°-æ¸…é™¤"></a><strong>è€å¹´ä»£â€”==å¹¶å‘==æ ‡è®°-æ¸…é™¤</strong></h4><p>åœ¨è€å¹´ä»£çš„åƒåœ¾æ”¶é›†è¿‡ç¨‹ä¸­ï¼Œå¤§éƒ¨åˆ†æ”¶é›†ä»»åŠ¡æ˜¯å’Œåº”ç”¨ç¨‹åº<strong>å¹¶å‘</strong>æ‰§è¡Œçš„ã€‚</p>
<p>CMS æ”¶é›†è¿‡ç¨‹é¦–å…ˆæ˜¯ä¸€æ®µå°åœé¡¿ stop-the-worldï¼Œå«åš <strong>åˆå§‹æ ‡è®°é˜¶æ®µï¼ˆinitial markï¼‰</strong>ï¼Œç”¨äºç¡®å®š GC Rootsã€‚ç„¶åæ˜¯ <strong>==å¹¶å‘æ ‡è®°é˜¶æ®µ==ï¼ˆconcurrent markï¼‰</strong>ï¼Œæ ‡è®° GC Roots å¯è¾¾çš„æ‰€æœ‰å­˜æ´»å¯¹è±¡ï¼Œç”±äºè¿™ä¸ªé˜¶æ®µåº”ç”¨ç¨‹åºåŒæ—¶ä¹Ÿåœ¨è¿è¡Œï¼Œæ‰€ä»¥å¹¶å‘æ ‡è®°é˜¶æ®µç»“æŸåï¼Œå¹¶ä¸èƒ½æ ‡è®°å‡ºæ‰€æœ‰çš„å­˜æ´»å¯¹è±¡ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦å†æ¬¡åœé¡¿åº”ç”¨ç¨‹åºï¼Œç§°ä¸º <strong>å†æ¬¡æ ‡è®°é˜¶æ®µï¼ˆremarkï¼‰</strong>ï¼Œéå†åœ¨å¹¶å‘æ ‡è®°é˜¶æ®µåº”ç”¨ç¨‹åºä¿®æ”¹çš„å¯¹è±¡ï¼ˆæ ‡è®°å‡ºåº”ç”¨ç¨‹åºåœ¨è¿™ä¸ªæœŸé—´çš„æ´»å¯¹è±¡ï¼‰ï¼Œç”±äºè¿™æ¬¡åœé¡¿æ¯”åˆå§‹æ ‡è®°è¦é•¿å¾—å¤šï¼Œ<strong>æ‰€ä»¥ä¼šä½¿ç”¨å¤šçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œæ¥å¢åŠ æ•ˆç‡</strong>ã€‚</p>
<p>å†æ¬¡æ ‡è®°é˜¶æ®µç»“æŸåï¼Œèƒ½ä¿è¯æ‰€æœ‰å­˜æ´»å¯¹è±¡éƒ½è¢«æ ‡è®°å®Œæˆï¼Œæ‰€ä»¥æ¥ä¸‹æ¥çš„ <strong>==å¹¶å‘==æ¸…ç†é˜¶æ®µï¼ˆconcurrent sweepï¼‰</strong> å°†==å°±åœ°å›æ”¶==åƒåœ¾å¯¹è±¡æ‰€å ç©ºé—´ã€‚ä¸‹å›¾ç¤ºæ„äº†è€å¹´ä»£ä¸­ <strong>ä¸²è¡Œã€æ ‡è®° -&gt; æ¸…ç† -&gt; å‹ç¼©æ”¶é›†å™¨</strong>å’Œ CMS æ”¶é›†å™¨çš„åŒºåˆ«ï¼š</p>
<p><img src="https://assets.javadoop.com/imgs/20510079/jvm-memory-management/7.png" alt="7"></p>
<p>ç”±äºéƒ¨åˆ†ä»»åŠ¡å¢åŠ äº†æ”¶é›†å™¨çš„å·¥ä½œï¼Œå¦‚éå†å¹¶å‘é˜¶æ®µåº”ç”¨ç¨‹åºä¿®æ”¹çš„å¯¹è±¡ï¼Œæ‰€ä»¥å¢åŠ äº† CMS æ”¶é›†å™¨çš„è´Ÿè½½ã€‚å¯¹äºå¤§éƒ¨åˆ†è¯•å›¾é™ä½åœé¡¿æ—¶é—´çš„æ”¶é›†å™¨æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ç§æƒè¡¡æ–¹æ¡ˆã€‚</p>
<h4 id="CMS-çš„åŠ£åŠ¿"><a href="#CMS-çš„åŠ£åŠ¿" class="headerlink" title="CMS çš„åŠ£åŠ¿"></a>CMS çš„åŠ£åŠ¿</h4><h5 id="ç©ºé—²åˆ—è¡¨å¸¦æ¥çš„ç¢ç‰‡åŒ–"><a href="#ç©ºé—²åˆ—è¡¨å¸¦æ¥çš„ç¢ç‰‡åŒ–" class="headerlink" title="ç©ºé—²åˆ—è¡¨å¸¦æ¥çš„ç¢ç‰‡åŒ–"></a>ç©ºé—²åˆ—è¡¨å¸¦æ¥çš„ç¢ç‰‡åŒ–</h5><p>CMS æ”¶é›†å™¨æ˜¯**==å”¯ä¸€==ä¸è¿›è¡Œå‹ç¼©çš„æ”¶é›†å™¨**ï¼Œåœ¨å®ƒé‡Šæ”¾äº†åƒåœ¾å¯¹è±¡å ç”¨çš„ç©ºé—´åï¼Œå®ƒä¸ä¼šç§»åŠ¨å­˜æ´»å¯¹è±¡åˆ°ä¸€è¾¹å»ã€‚</p>
<p><img src="https://pub-9e727eae11e040a4aa2b1feedc2608d2.r2.dev/PicGo/image-20250105193733063.png" alt="image-20250105193733063"></p>
<p>è¿™å°†èŠ‚çœåƒåœ¾å›æ”¶çš„æ—¶é—´ï¼Œä½†æ˜¯ç”±äºä¹‹åç©ºé—²ç©ºé—´ä¸æ˜¯è¿ç»­çš„ï¼Œæ‰€ä»¥ä¹Ÿå°±ä¸èƒ½ä½¿ç”¨ç®€å•çš„ <strong>æŒ‡é’ˆç¢°æ’ï¼ˆbump-the-pointerï¼‰</strong> è¿›è¡Œå¯¹è±¡ç©ºé—´åˆ†é…äº†ã€‚å®ƒéœ€è¦ç»´æŠ¤ä¸€ä¸ª <strong>ç©ºé—²åˆ—è¡¨</strong>ï¼Œå°†æ‰€æœ‰çš„ç©ºé—²åŒºåŸŸè¿æ¥èµ·æ¥ï¼Œå½“åˆ†é…ç©ºé—´æ—¶ï¼Œéœ€è¦å¯»æ‰¾åˆ°ä¸€ä¸ªå¯ä»¥å®¹çº³è¯¥å¯¹è±¡çš„åŒºåŸŸã€‚æ˜¾ç„¶ï¼Œå®ƒæ¯”ä½¿ç”¨ç®€å•çš„æŒ‡é’ˆç¢°æ’æˆæœ¬è¦é«˜ã€‚åŒæ—¶å®ƒä¹Ÿä¼šåŠ å¤§å¹´è½»ä»£åƒåœ¾æ”¶é›†çš„è´Ÿè½½ï¼Œå› ä¸ºå¹´è½»ä»£ä¸­çš„å¯¹è±¡å¦‚æœè¦æ™‹å‡åˆ°è€å¹´ä»£ä¸­ï¼Œéœ€è¦è€å¹´ä»£è¿›è¡Œç©ºé—´åˆ†é…ã€‚æœ€åï¼Œç”±äºç¼ºå°‘å‹ç¼©ç¯èŠ‚ï¼Œå †å°†ä¼šå‡ºç°ç¢ç‰‡åŒ–é—®é¢˜ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒCMS æ”¶é›†å™¨éœ€è¦è¿½è¸ªç»Ÿè®¡æœ€å¸¸ç”¨çš„å¯¹è±¡å¤§å°ï¼Œè¯„ä¼°å°†æ¥çš„åˆ†é…éœ€æ±‚ï¼Œå¯èƒ½è¿˜éœ€è¦åˆ†å‰²æˆ–åˆå¹¶ç©ºé—²åŒºåŸŸã€‚</p>
<h5 id="more-Heap"><a href="#more-Heap" class="headerlink" title="more Heap"></a>more Heap</h5><p>å¦å¤–ä¸€ä¸ªç¼ºç‚¹å°±æ˜¯ï¼ŒCMS æ”¶é›†å™¨ç›¸æ¯”å…¶ä»–æ”¶é›†å™¨éœ€è¦ä½¿ç”¨æ›´å¤§çš„å †å†…å­˜ã€‚å› ä¸ºåœ¨å¹¶å‘æ ‡è®°é˜¶æ®µï¼Œç¨‹åºè¿˜éœ€è¦æ‰§è¡Œï¼Œæ‰€ä»¥éœ€è¦ç•™è¶³å¤Ÿçš„ç©ºé—´ç»™åº”ç”¨ç¨‹åºã€‚å¦å¤–ï¼Œè™½ç„¶æ”¶é›†å™¨èƒ½ä¿è¯åœ¨æ ‡è®°é˜¶æ®µè¯†åˆ«å‡ºæ‰€æœ‰çš„å­˜æ´»å¯¹è±¡ï¼Œä½†æ˜¯ç”±äºåº”ç”¨ç¨‹åºå¹¶å‘è¿è¡Œï¼Œæ‰€ä»¥åˆšåˆšæ ‡è®°çš„å­˜æ´»å¯¹è±¡å¾ˆå¯èƒ½ç«‹é©¬æˆä¸ºåƒåœ¾ï¼Œè€Œä¸”è¿™éƒ¨åˆ†ç”±äºå·²ç»è¢«æ ‡è®°ä¸º<strong>å­˜æ´»å¯¹è±¡</strong>ï¼Œæ‰€ä»¥åªèƒ½åˆ°ä¸‹æ¬¡è€å¹´ä»£æ”¶é›†æ‰ä¼šè¢«æ¸…ç†ï¼Œè¿™éƒ¨åˆ†åƒåœ¾ç§°ä¸º <strong>æµ®åŠ¨åƒåœ¾</strong>ã€‚</p>
<p>ä¸åƒå…¶ä»–åƒåœ¾æ”¶é›†å™¨ï¼ŒCMS æ”¶é›†å™¨ä¸èƒ½ç­‰åˆ°è€å¹´ä»£æ»¡äº†æ‰å¼€å§‹æ”¶é›†ã€‚å¦åˆ™çš„è¯ï¼ŒCMS æ”¶é›†å™¨å°†é€€åŒ–åˆ°ä½¿ç”¨æ›´åŠ è€—æ—¶çš„ <strong>stop-the-worldã€æ ‡è®°-æ¸…é™¤-å‹ç¼©</strong> ç®—æ³•ã€‚ä¸ºäº†é¿å…è¿™ä¸ªï¼ŒCMS æ”¶é›†å™¨éœ€è¦ç»Ÿè®¡ä¹‹å‰æ¯æ¬¡åƒåœ¾æ”¶é›†çš„æ—¶é—´å’Œè€å¹´ä»£ç©ºé—´è¢«æ¶ˆè€—çš„é€Ÿåº¦ã€‚å¦å¤–ï¼Œå¦‚æœè€å¹´ä»£ç©ºé—´è¢«æ¶ˆè€—äº† <strong>é¢„è®¾å ç”¨ç‡ï¼ˆinitiating occupancyï¼‰</strong>ï¼Œä¹Ÿå°†ä¼šè§¦å‘ä¸€æ¬¡åƒåœ¾æ”¶é›†ï¼Œè¿™ä¸ªå ç”¨ç‡é€šè¿‡ <strong>â€“XX:CMSInitiatingOccupancyFraction=n</strong> è¿›è¡Œè®¾ç½®ï¼Œn ä¸ºè€å¹´ä»£ç©ºé—´çš„å ç”¨ç™¾åˆ†æ¯”ï¼Œé»˜è®¤å€¼æ˜¯ <strong>68</strong>ã€‚</p>
<blockquote>
<p>è¿™ä¸ªæ•°å­—åˆ° Java8 çš„æ—¶å€™å·²ç»å˜ä¸ºé»˜è®¤ 92 äº†ã€‚å¦‚æœè€å¹´ä»£ç©ºé—´ä¸è¶³ä»¥å®¹çº³ä»æ–°ç”Ÿä»£åƒåœ¾å›æ”¶æ™‹å‡ä¸Šæ¥çš„å¯¹è±¡ï¼Œé‚£ä¹ˆå°±ä¼šå‘ç”Ÿ concurrent mode failureï¼Œæ­¤æ—¶ä¼šé€€åŒ–åˆ°å‘ç”Ÿ Full GCï¼Œæ¸…é™¤è€å¹´ä»£ä¸­çš„æ‰€æœ‰æ— æ•ˆå¯¹è±¡ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯å•çº¿ç¨‹çš„ï¼Œæ¯”è¾ƒè€—æ—¶</p>
<p>å¦å¤–ï¼Œå³ä½¿åœ¨æ™‹å‡çš„æ—¶å€™åˆ¤æ–­å‡ºè€å¹´ä»£æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œä½†æ˜¯ç”±äºè€å¹´ä»£çš„ç¢ç‰‡åŒ–é—®é¢˜ï¼Œå…¶å®æœ€ç»ˆæ²¡æ³•å®¹çº³æ™‹å‡ä¸Šæ¥çš„å¯¹è±¡ï¼Œé‚£ä¹ˆæ­¤æ—¶ä¹Ÿä¼šå‘ç”Ÿ Full GCï¼Œè¿™æ¬¡çš„è€—æ—¶å°†æ›´åŠ ä¸¥é‡ï¼Œå› ä¸ºéœ€è¦å¯¹æ•´ä¸ªå †è¿›è¡Œå‹ç¼©ï¼Œå‹ç¼©åå¹´è½»ä»£å½»åº•å°±ç©ºäº†ã€‚</p>
</blockquote>
<p>æ€»ç»“ä¸‹æ¥ï¼Œå’Œå¹¶è¡Œæ”¶é›†å™¨ç›¸æ¯”ï¼ŒCMS æ”¶é›†å™¨<strong>é™ä½äº†è€å¹´ä»£æ”¶é›†æ—¶çš„åœé¡¿æ—¶é—´</strong>ï¼ˆæœ‰æ—¶æ˜¯æ˜¾è‘—é™ä½ï¼‰ï¼Œ<strong>ç¨å¾®å¢åŠ äº†ä¸€äº›å¹´è½»ä»£æ”¶é›†çš„æ—¶é—´</strong>ã€<strong>é™ä½äº†ååé‡</strong> ä»¥åŠ <strong>éœ€è¦æ›´å¤šçš„å †å†…å­˜</strong>ã€‚</p>
<p><strong>å¢é‡æ¨¡å¼</strong></p>
<p>CMS æ”¶é›†å™¨å¯ä»¥ä½¿ç”¨å¢é‡æ¨¡å¼ï¼Œåœ¨å¹¶å‘æ ‡è®°é˜¶æ®µï¼Œå‘¨æœŸæ€§åœ°å°†è‡ªå·±çš„ CPU æ—¶é’Ÿå‘¨æœŸè®©å‡ºæ¥ç»™åº”ç”¨ç¨‹åºã€‚è¿™ä¸ªåŠŸèƒ½é€‚ç”¨äºéœ€è¦ CMS çš„ä½å»¶æ—¶ï¼Œä½†æ˜¯ CPU æ ¸å¿ƒåªæœ‰ 1 ä¸ªæˆ– 2 ä¸ªçš„æƒ…å†µã€‚</p>
<blockquote>
<p>å¢é‡æ¨¡å¼åœ¨ Java8 å·²ç»ä¸æ¨èä½¿ç”¨ã€‚</p>
<p>ç›®å‰æˆ‘äº†è§£åˆ°çš„æ˜¯ï¼Œåœ¨æ‰€æœ‰çš„å¹¶å‘æˆ–å¹¶è¡Œæ”¶é›†å™¨ä¸­ï¼Œéƒ½æä¾›äº†æ§åˆ¶åƒåœ¾æ”¶é›†çº¿ç¨‹æ•°é‡çš„å‚æ•°è®¾ç½®ã€‚</p>
</blockquote>
<p><strong>ä½•æ—¶ä½¿ç”¨ CMS æ”¶é›†å™¨</strong></p>
<p>é€‚ç”¨äºåº”ç”¨ç¨‹åºè¦æ±‚ä½åœé¡¿ï¼ŒåŒæ—¶èƒ½æ¥å—åœ¨åƒåœ¾æ”¶é›†é˜¶æ®µå’Œåƒåœ¾æ”¶é›†çº¿ç¨‹ä¸€èµ·å…±äº« CPU èµ„æºçš„åœºæ™¯ï¼Œå…¸å‹çš„å°±æ˜¯ web åº”ç”¨äº†ã€‚</p>
<blockquote>
<p>åœ¨ web åº”ç”¨ä¸­ï¼Œä½å»¶æ—¶éå¸¸é‡è¦ï¼Œæ‰€ä»¥ CMS å‡ ä¹å°±æ˜¯å”¯ä¸€é€‰æ‹©ï¼Œç›´åˆ°åæ¥ G1 çš„å‡ºç°ã€‚</p>
</blockquote>
<p><strong>ä½¿ç”¨ CMS æ”¶é›†å™¨</strong></p>
<p>æ˜¾ç¤ºæŒ‡å®šï¼š-XX:+UseConcMarkSweepGC</p>
<p>å¦‚æœéœ€è¦å¢é‡æ¨¡å¼ï¼šâ€“XX:+CMSIncrementalModeoption</p>
<blockquote>
<p>å½“ç„¶ï¼ŒCMS è¿˜æœ‰å¥½äº›å‚æ•°å¯ä»¥è®¾ç½®ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ï¼Œæƒ³è¦äº†è§£æ›´å¤š CMS ç»†èŠ‚ï¼Œå»ºè®®è¯»è€…å¯ä»¥å‚è€ƒã€ŠJava æ€§èƒ½æƒå¨æŒ‡å—ã€‹ï¼Œéå¸¸ä¸é”™çš„ä¸€æœ¬ä¹¦ã€‚</p>
</blockquote>
<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>è™½ç„¶æ˜¯ç¿»è¯‘çš„æ–‡ç« ï¼Œä¹Ÿå°ç»“ä¸€ä¸‹å§ã€‚</p>
<p>ä¸²è¡Œæ”¶é›†å™¨ï¼šåœ¨å¹´è½»ä»£å’Œè€å¹´ä»£éƒ½é‡‡ç”¨å•çº¿ç¨‹ï¼Œå¹´è½»ä»£ä¸­ä½¿ç”¨ <strong>stop-the-worldã€å¤åˆ¶</strong> ç®—æ³•ï¼›è€å¹´ä»£ä½¿ç”¨ <strong>stop-the-worldã€æ ‡è®° -&gt; æ¸…ç† -&gt; å‹ç¼©</strong> ç®—æ³•ã€‚</p>
<p>å¹¶è¡Œæ”¶é›†å™¨ï¼šåœ¨å¹´è½»ä»£ä¸­ä½¿ç”¨ <strong>å¹¶è¡Œã€stop-the-worldã€å¤åˆ¶</strong> ç®—æ³•ï¼›è€å¹´ä»£ä½¿ç”¨ä¸²è¡Œæ”¶é›†å™¨çš„ <strong>ä¸²è¡Œã€stop-the-worldã€æ ‡è®° -&gt; æ¸…ç† -&gt; å‹ç¼©</strong> ç®—æ³•ã€‚</p>
<p>å¹¶è¡Œå‹ç¼©æ”¶é›†å™¨ï¼šåœ¨å¹´è½»ä»£ä¸­ä½¿ç”¨å¹¶è¡Œæ”¶é›†å™¨çš„ <strong>å¹¶è¡Œã€stop-the-worldã€å¤åˆ¶</strong> ç®—æ³•ï¼›è€å¹´ä»£ä½¿ç”¨ <strong>å¹¶è¡Œã€stop-the-worldã€æ ‡è®° -&gt; æ¸…ç† -&gt; å‹ç¼©</strong> ç®—æ³•ã€‚å’Œå¹¶è¡Œæ”¶é›†å™¨çš„åŒºåˆ«æ˜¯è€å¹´ä»£ä½¿ç”¨äº†å¹¶è¡Œã€‚</p>
<p>CMS æ”¶é›†å™¨ï¼šåœ¨å¹´è½»ä½¿ç”¨å¹¶è¡Œæ”¶é›†å™¨çš„ <strong>å¹¶è¡Œã€stop-the-worldã€å¤åˆ¶</strong> ç®—æ³•ï¼›è€å¹´ä»£ä½¿ç”¨ <strong>å¹¶å‘ã€æ ‡è®° -&gt; æ¸…ç†</strong> ç®—æ³•ï¼Œä¸å‹ç¼©ã€‚æœ¬æ–‡ä»‹ç»çš„å”¯ä¸€ä¸€ä¸ªå¹¶å‘æ”¶é›†å™¨ï¼Œä¹Ÿæ˜¯å”¯ä¸€ä¸€ä¸ªä¸å¯¹è€å¹´ä»£è¿›è¡Œå‹ç¼©çš„æ”¶é›†å™¨ã€‚</p>
<p>å¦å¤–ï¼Œåœ¨ HotSpot ä¸­ï¼Œæ°¸ä¹…ä»£ä½¿ç”¨çš„æ˜¯å’Œè€å¹´ä»£ä¸€æ ·çš„ç®—æ³•ã€‚åˆ°äº† J2SE 8.0 çš„ HotSpot JVM ä¸­ï¼Œæ°¸ä¹…ä»£è¢« MetaSpace å–ä»£äº†ï¼Œè¿™ä¸ªä»¥åå†ä»‹ç»ã€‚</p>
<p>ï¼ˆå…¨æ–‡å®Œï¼‰</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://scatteredream.github.io/2018/02/27/java-net-bio-nio-aio/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/62317679?s=400&v=4">
      <meta itemprop="name" content="ç¢æ¢¦">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="scatteredream's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | scatteredream's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/02/27/java-net-bio-nio-aio/" class="post-title-link" itemprop="url">Java éé˜»å¡ IO å’Œå¼‚æ­¥ IO(è½¬è‡ªJavadoop)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2018-02-27 00:00:00" itemprop="dateCreated datePublished" datetime="2018-02-27T00:00:00+08:00">2018-02-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-05-05 11:26:58" itemprop="dateModified" datetime="2025-05-05T11:26:58+08:00">2025-05-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/jdk/" itemprop="url" rel="index"><span itemprop="name">jdk</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>ä¸Šä¸€ç¯‡æ–‡ç« ä»‹ç»äº† Java NIO ä¸­ Bufferã€Channel å’Œ Selector çš„åŸºæœ¬æ“ä½œï¼Œä¸»è¦æ˜¯ä¸€äº›æ¥å£æ“ä½œï¼Œæ¯”è¾ƒç®€å•ã€‚</p>
<p>æœ¬æ–‡å°†ä»‹ç»<strong>éé˜»å¡ IO</strong> å’Œ<strong>å¼‚æ­¥ IO</strong>ï¼Œä¹Ÿå°±æ˜¯å¤§å®¶è€³ç†Ÿèƒ½è¯¦çš„ NIO å’Œ AIOã€‚å¾ˆå¤šåˆå­¦è€…å¯èƒ½åˆ†ä¸æ¸…æ¥šå¼‚æ­¥å’Œéé˜»å¡çš„åŒºåˆ«ï¼Œåªæ˜¯åœ¨å„ç§åœºåˆèƒ½å¬åˆ°<strong>å¼‚æ­¥éé˜»å¡</strong>è¿™ä¸ªè¯ã€‚</p>
<p>æœ¬æ–‡ä¼šå…ˆä»‹ç»å¹¶æ¼”ç¤ºé˜»å¡æ¨¡å¼ï¼Œç„¶åå¼•å…¥éé˜»å¡æ¨¡å¼æ¥å¯¹é˜»å¡æ¨¡å¼è¿›è¡Œä¼˜åŒ–ï¼Œæœ€åå†ä»‹ç» JDK7 å¼•å…¥çš„å¼‚æ­¥ IOï¼Œç”±äºç½‘ä¸Šå…³äºå¼‚æ­¥ IO çš„ä»‹ç»ç›¸å¯¹è¾ƒå°‘ï¼Œæ‰€ä»¥è¿™éƒ¨åˆ†å†…å®¹æˆ‘ä¼šä»‹ç»å¾—å…·ä½“ä¸€äº›ã€‚</p>
<p>å¸Œæœ›çœ‹å®Œæœ¬æ–‡ï¼Œè¯»è€…å¯ä»¥å¯¹éé˜»å¡ IO å’Œå¼‚æ­¥ IO çš„è¿·é›¾çœ‹å¾—æ›´æ¸…æ™°äº›ï¼Œæˆ–è€…ä¸ºåˆå­¦è€…è§£å¼€ä¸€ä¸ä¸ç–‘æƒ‘ä¹Ÿæ˜¯å¥½çš„ã€‚</p>
<!-- toc -->

<h2 id="é˜»å¡æ¨¡å¼-IO"><a href="#é˜»å¡æ¨¡å¼-IO" class="headerlink" title="é˜»å¡æ¨¡å¼ IO"></a>é˜»å¡æ¨¡å¼ IO</h2><p>æˆ‘ä»¬å·²ç»ä»‹ç»è¿‡ä½¿ç”¨ Java NIO åŒ…ç»„æˆä¸€ä¸ªç®€å•çš„<strong>å®¢æˆ·ç«¯-æœåŠ¡ç«¯</strong>ç½‘ç»œé€šè®¯æ‰€éœ€è¦çš„ ServerSocketChannelã€SocketChannel å’Œ Bufferï¼Œæˆ‘ä»¬è¿™é‡Œæ•´åˆä¸€ä¸‹å®ƒä»¬ï¼Œç»™å‡ºä¸€ä¸ªå®Œæ•´çš„å¯è¿è¡Œçš„ä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Server</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">ServerSocketChannel</span> <span class="variable">serverSocketChannel</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç›‘å¬ 8080 ç«¯å£è¿›æ¥çš„ TCP é“¾æ¥</span></span><br><span class="line">        serverSocketChannel.socket().bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">8080</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è¿™é‡Œä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰ä¸€ä¸ªè¯·æ±‚çš„è¿æ¥è¿›æ¥</span></span><br><span class="line">            <span class="type">SocketChannel</span> <span class="variable">socketChannel</span> <span class="operator">=</span> serverSocketChannel.accept();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¼€å¯ä¸€ä¸ªæ–°çš„çº¿ç¨‹æ¥å¤„ç†è¿™ä¸ªè¯·æ±‚ï¼Œç„¶ååœ¨ while å¾ªç¯ä¸­ç»§ç»­ç›‘å¬ 8080 ç«¯å£</span></span><br><span class="line">            <span class="type">SocketHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SocketHandler</span>(socketChannel);</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(handler).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçœ‹ä¸€ä¸‹æ–°çš„çº¿ç¨‹éœ€è¦åšä»€ä¹ˆï¼ŒSocketHandlerï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SocketHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SocketChannel socketChannel;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SocketHandler</span><span class="params">(SocketChannel socketChannel)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.socketChannel = socketChannel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// å°†è¯·æ±‚æ•°æ®è¯»å…¥ Buffer ä¸­</span></span><br><span class="line">            <span class="type">int</span> num;</span><br><span class="line">            <span class="keyword">while</span> ((num = socketChannel.read(buffer)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// è¯»å– Buffer å†…å®¹ä¹‹å‰å…ˆ flip ä¸€ä¸‹</span></span><br><span class="line">                buffer.flip();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// æå– Buffer ä¸­çš„æ•°æ®</span></span><br><span class="line">                <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[num];</span><br><span class="line">                buffer.get(bytes);</span><br><span class="line"></span><br><span class="line">                <span class="type">String</span> <span class="variable">re</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(bytes, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;æ”¶åˆ°è¯·æ±‚ï¼š&quot;</span> + re);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// å›åº”å®¢æˆ·ç«¯</span></span><br><span class="line">                <span class="type">ByteBuffer</span> <span class="variable">writeBuffer</span> <span class="operator">=</span> ByteBuffer.wrap((<span class="string">&quot;æˆ‘å·²ç»æ”¶åˆ°ä½ çš„è¯·æ±‚ï¼Œä½ çš„è¯·æ±‚å†…å®¹æ˜¯ï¼š&quot;</span> + re).getBytes());</span><br><span class="line">                socketChannel.write(writeBuffer);</span><br><span class="line"></span><br><span class="line">                buffer.clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            IOUtils.closeQuietly(socketChannel);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åï¼Œè´´ä¸€ä¸‹å®¢æˆ·ç«¯ SocketChannel çš„ä½¿ç”¨ï¼Œå®¢æˆ·ç«¯æ¯”è¾ƒç®€å•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SocketChannelTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">socketChannel</span> <span class="operator">=</span> SocketChannel.open();</span><br><span class="line">        socketChannel.connect(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">8080</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‘é€è¯·æ±‚</span></span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.wrap(<span class="string">&quot;1234567890&quot;</span>.getBytes());</span><br><span class="line">        socketChannel.write(buffer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¯»å–å“åº”</span></span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">readBuffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">        <span class="type">int</span> num;</span><br><span class="line">        <span class="keyword">if</span> ((num = socketChannel.read(readBuffer)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            readBuffer.flip();</span><br><span class="line"></span><br><span class="line">            <span class="type">byte</span>[] re = <span class="keyword">new</span> <span class="title class_">byte</span>[num];</span><br><span class="line">            readBuffer.get(re);</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(re, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;è¿”å›å€¼: &quot;</span> + result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢ä»‹ç»çš„é˜»å¡æ¨¡å¼çš„ä»£ç åº”è¯¥å¾ˆå¥½ç†è§£ï¼šæ¥ä¸€ä¸ªæ–°çš„è¿æ¥ï¼Œæˆ‘ä»¬å°±æ–°å¼€ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†è¿™ä¸ªè¿æ¥ï¼Œä¹‹åçš„æ“ä½œå…¨éƒ¨ç”±é‚£ä¸ªçº¿ç¨‹æ¥å®Œæˆã€‚</p>
<p>é‚£ä¹ˆï¼Œè¿™ä¸ªæ¨¡å¼ä¸‹çš„æ€§èƒ½ç“¶é¢ˆåœ¨å“ªé‡Œå‘¢ï¼Ÿ</p>
<ol>
<li>é¦–å…ˆï¼Œæ¯æ¬¡æ¥ä¸€ä¸ªè¿æ¥éƒ½å¼€ä¸€ä¸ªæ–°çš„çº¿ç¨‹è¿™è‚¯å®šæ˜¯ä¸åˆé€‚çš„ã€‚å½“æ´»è·ƒè¿æ¥æ•°åœ¨å‡ åå‡ ç™¾çš„æ—¶å€™å½“ç„¶æ˜¯å¯ä»¥è¿™æ ·åšçš„ï¼Œä½†å¦‚æœæ´»è·ƒè¿æ¥æ•°æ˜¯å‡ ä¸‡å‡ åä¸‡çš„æ—¶å€™ï¼Œè¿™ä¹ˆå¤šçº¿ç¨‹æ˜æ˜¾å°±ä¸è¡Œäº†ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½éœ€è¦ä¸€éƒ¨åˆ†å†…å­˜ï¼Œå†…å­˜ä¼šè¢«è¿…é€Ÿæ¶ˆè€—ï¼ŒåŒæ—¶ï¼Œçº¿ç¨‹åˆ‡æ¢çš„å¼€é”€éå¸¸å¤§ã€‚</li>
<li>å…¶æ¬¡ï¼Œé˜»å¡æ“ä½œåœ¨è¿™é‡Œä¹Ÿæ˜¯ä¸€ä¸ªé—®é¢˜ã€‚é¦–å…ˆï¼Œaccept() æ˜¯ä¸€ä¸ªé˜»å¡æ“ä½œï¼Œå½“ accept() è¿”å›çš„æ—¶å€™ï¼Œä»£è¡¨æœ‰ä¸€ä¸ªè¿æ¥å¯ä»¥ä½¿ç”¨äº†ï¼Œæˆ‘ä»¬è¿™é‡Œæ˜¯é©¬ä¸Šå°±æ–°å»ºçº¿ç¨‹æ¥å¤„ç†è¿™ä¸ª SocketChannel äº†ï¼Œä½†æ˜¯ï¼Œä½†æ˜¯è¿™é‡Œä¸ä»£è¡¨å¯¹æ–¹å°±å°†æ•°æ®ä¼ è¾“è¿‡æ¥äº†ã€‚æ‰€ä»¥ï¼ŒSocketChannel#read æ–¹æ³•å°†é˜»å¡ï¼Œç­‰å¾…æ•°æ®ï¼Œæ˜æ˜¾è¿™ä¸ªç­‰å¾…æ˜¯ä¸å€¼å¾—çš„ã€‚åŒç†ï¼Œwrite æ–¹æ³•ä¹Ÿéœ€è¦ç­‰å¾…é€šé“å¯å†™æ‰èƒ½æ‰§è¡Œå†™å…¥æ“ä½œï¼Œè¿™è¾¹çš„é˜»å¡ç­‰å¾…ä¹Ÿæ˜¯ä¸å€¼å¾—çš„ã€‚</li>
</ol>
<h2 id="éé˜»å¡-IO"><a href="#éé˜»å¡-IO" class="headerlink" title="éé˜»å¡ IO"></a>éé˜»å¡ IO</h2><p>è¯´å®Œäº†é˜»å¡æ¨¡å¼çš„ä½¿ç”¨åŠå…¶ç¼ºç‚¹ä»¥åï¼Œæˆ‘ä»¬è¿™é‡Œå°±å¯ä»¥ä»‹ç»éé˜»å¡ IO äº†ã€‚</p>
<p>éé˜»å¡ IO çš„æ ¸å¿ƒåœ¨äºä½¿ç”¨ä¸€ä¸ª Selector æ¥ç®¡ç†å¤šä¸ªé€šé“ï¼Œå¯ä»¥æ˜¯ SocketChannelï¼Œä¹Ÿå¯ä»¥æ˜¯ ServerSocketChannelï¼Œå°†å„ä¸ªé€šé“æ³¨å†Œåˆ° Selector ä¸Šï¼ŒæŒ‡å®šç›‘å¬çš„äº‹ä»¶ã€‚</p>
<p>ä¹‹åå¯ä»¥åªç”¨ä¸€ä¸ªçº¿ç¨‹æ¥è½®è¯¢è¿™ä¸ª Selectorï¼Œçœ‹çœ‹ä¸Šé¢æ˜¯å¦æœ‰é€šé“æ˜¯å‡†å¤‡å¥½çš„ï¼Œå½“é€šé“å‡†å¤‡å¥½å¯è¯»æˆ–å¯å†™ï¼Œç„¶åæ‰å»å¼€å§‹çœŸæ­£çš„è¯»å†™ï¼Œè¿™æ ·é€Ÿåº¦å°±å¾ˆå¿«äº†ã€‚æˆ‘ä»¬å°±å®Œå…¨æ²¡æœ‰å¿…è¦ç»™æ¯ä¸ªé€šé“éƒ½èµ·ä¸€ä¸ªçº¿ç¨‹ã€‚</p>
<p>NIO ä¸­ Selector æ˜¯å¯¹åº•å±‚æ“ä½œç³»ç»Ÿå®ç°çš„ä¸€ä¸ªæŠ½è±¡ï¼Œç®¡ç†é€šé“çŠ¶æ€å…¶å®éƒ½æ˜¯åº•å±‚ç³»ç»Ÿå®ç°çš„ï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸‹åœ¨ä¸åŒç³»ç»Ÿä¸‹çš„å®ç°ã€‚</p>
<p><strong>select</strong>ï¼šä¸Šä¸–çºª 80 å¹´ä»£å°±å®ç°äº†ï¼Œå®ƒæ”¯æŒæ³¨å†Œ FD_SETSIZE(1024) ä¸ª socketï¼Œåœ¨é‚£ä¸ªå¹´ä»£è‚¯å®šæ˜¯å¤Ÿç”¨çš„ï¼Œä¸è¿‡ç°åœ¨å˜›ï¼Œè‚¯å®šæ˜¯ä¸è¡Œäº†ã€‚</p>
<p><strong>poll</strong>ï¼š1997 å¹´ï¼Œå‡ºç°äº† poll ä½œä¸º select çš„æ›¿ä»£è€…ï¼Œæœ€å¤§çš„åŒºåˆ«å°±æ˜¯ï¼Œpoll ä¸å†é™åˆ¶ socket æ•°é‡ã€‚</p>
<p>select å’Œ poll éƒ½æœ‰ä¸€ä¸ªå…±åŒçš„é—®é¢˜ï¼Œé‚£å°±æ˜¯<strong>å®ƒä»¬éƒ½åªä¼šå‘Šè¯‰ä½ æœ‰å‡ ä¸ªé€šé“å‡†å¤‡å¥½äº†ï¼Œä½†æ˜¯ä¸ä¼šå‘Šè¯‰ä½ å…·ä½“æ˜¯å“ªå‡ ä¸ªé€šé“</strong>ã€‚æ‰€ä»¥ï¼Œä¸€æ—¦çŸ¥é“æœ‰é€šé“å‡†å¤‡å¥½ä»¥åï¼Œè‡ªå·±è¿˜æ˜¯éœ€è¦è¿›è¡Œä¸€æ¬¡æ‰«æï¼Œæ˜¾ç„¶è¿™ä¸ªä¸å¤ªå¥½ï¼Œé€šé“å°‘çš„æ—¶å€™è¿˜è¡Œï¼Œä¸€æ—¦é€šé“çš„æ•°é‡æ˜¯å‡ åä¸‡ä¸ªä»¥ä¸Šçš„æ—¶å€™ï¼Œæ‰«æä¸€æ¬¡çš„æ—¶é—´éƒ½å¾ˆå¯è§‚äº†ï¼Œæ—¶é—´å¤æ‚åº¦ O(n)ã€‚æ‰€ä»¥ï¼Œåæ¥æ‰å‚¬ç”Ÿäº†ä»¥ä¸‹å®ç°ã€‚</p>
<p><strong>epoll</strong>ï¼š2002 å¹´éš Linux å†…æ ¸ 2.5.44 å‘å¸ƒï¼Œepoll èƒ½ç›´æ¥è¿”å›å…·ä½“çš„å‡†å¤‡å¥½çš„é€šé“ï¼Œæ—¶é—´å¤æ‚åº¦ O(1)ã€‚</p>
<p>é™¤äº† Linux ä¸­çš„ epollï¼Œ2000 å¹´ FreeBSD å‡ºç°äº† <strong>Kqueue</strong>ï¼Œè¿˜æœ‰å°±æ˜¯ï¼ŒSolaris ä¸­æœ‰ <strong>/dev/poll</strong>ã€‚</p>
<blockquote>
<p>å‰é¢è¯´äº†é‚£ä¹ˆå¤šå®ç°ï¼Œä½†æ˜¯æ²¡æœ‰å‡ºç° Windowsï¼ŒWindows å¹³å°çš„éé˜»å¡ IO ä½¿ç”¨ selectï¼Œæˆ‘ä»¬ä¹Ÿä¸å¿…è§‰å¾— Windows å¾ˆè½åï¼Œåœ¨ Windows ä¸­ IOCP æä¾›çš„å¼‚æ­¥ IO æ˜¯æ¯”è¾ƒå¼ºå¤§çš„ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬å›åˆ° Selectorï¼Œæ¯•ç«Ÿ JVM å°±æ˜¯è¿™ä¹ˆä¸€ä¸ªå±è”½åº•å±‚å®ç°çš„å¹³å°ï¼Œ<strong>æˆ‘ä»¬é¢å‘ Selector ç¼–ç¨‹å°±å¯ä»¥äº†</strong>ã€‚</p>
<p>ä¹‹å‰åœ¨ä»‹ç» Selector çš„æ—¶å€™å·²ç»äº†è§£è¿‡äº†å®ƒçš„åŸºæœ¬ç”¨æ³•ï¼Œè¿™è¾¹æ¥ä¸€ä¸ªå¯è¿è¡Œçš„å®ä¾‹ä»£ç ï¼Œå¤§å®¶ä¸å¦¨çœ‹çœ‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SelectorServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();</span><br><span class="line"></span><br><span class="line">        <span class="type">ServerSocketChannel</span> <span class="variable">server</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">        server.socket().bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">8080</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°†å…¶æ³¨å†Œåˆ° Selector ä¸­ï¼Œç›‘å¬ OP_ACCEPT äº‹ä»¶</span></span><br><span class="line">        server.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        server.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">readyChannels</span> <span class="operator">=</span> selector.select();</span><br><span class="line">            <span class="keyword">if</span> (readyChannels == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Set&lt;SelectionKey&gt; readyKeys = selector.selectedKeys();</span><br><span class="line">            <span class="comment">// éå†</span></span><br><span class="line">            Iterator&lt;SelectionKey&gt; iterator = readyKeys.iterator();</span><br><span class="line">            <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">                iterator.remove();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line">                    <span class="comment">// æœ‰å·²ç»æ¥å—çš„æ–°çš„åˆ°æœåŠ¡ç«¯çš„è¿æ¥</span></span><br><span class="line">                    <span class="type">SocketChannel</span> <span class="variable">socketChannel</span> <span class="operator">=</span> server.accept();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// æœ‰æ–°çš„è¿æ¥å¹¶ä¸ä»£è¡¨è¿™ä¸ªé€šé“å°±æœ‰æ•°æ®ï¼Œ</span></span><br><span class="line">                    <span class="comment">// è¿™é‡Œå°†è¿™ä¸ªæ–°çš„ SocketChannel æ³¨å†Œåˆ° Selectorï¼Œç›‘å¬ OP_READ äº‹ä»¶ï¼Œç­‰å¾…æ•°æ®</span></span><br><span class="line">                    socketChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">                    socketChannel.register(selector, SelectionKey.OP_READ);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">                    <span class="comment">// æœ‰æ•°æ®å¯è¯»</span></span><br><span class="line">                    <span class="comment">// ä¸Šé¢ä¸€ä¸ª if åˆ†æ”¯ä¸­æ³¨å†Œäº†ç›‘å¬ OP_READ äº‹ä»¶çš„ SocketChannel</span></span><br><span class="line">                    <span class="type">SocketChannel</span> <span class="variable">socketChannel</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">                    <span class="type">ByteBuffer</span> <span class="variable">readBuffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">                    <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> socketChannel.read(readBuffer);</span><br><span class="line">                    <span class="keyword">if</span> (num &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// å¤„ç†è¿›æ¥çš„æ•°æ®...</span></span><br><span class="line">                        System.out.println(<span class="string">&quot;æ”¶åˆ°æ•°æ®ï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(readBuffer.array()).trim());</span><br><span class="line">                        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.wrap(<span class="string">&quot;è¿”å›ç»™å®¢æˆ·ç«¯çš„æ•°æ®...&quot;</span>.getBytes());</span><br><span class="line">                        socketChannel.write(buffer);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (num == -<span class="number">1</span>) &#123;</span><br><span class="line">                        <span class="comment">// -1 ä»£è¡¨è¿æ¥å·²ç»å…³é—­</span></span><br><span class="line">                        socketChannel.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è‡³äºå®¢æˆ·ç«¯ï¼Œå¤§å®¶å¯ä»¥ç»§ç»­ä½¿ç”¨ä¸Šä¸€èŠ‚ä»‹ç»é˜»å¡æ¨¡å¼æ—¶çš„å®¢æˆ·ç«¯è¿›è¡Œæµ‹è¯•ã€‚</p>
<h2 id="NIO-2-å¼‚æ­¥-IO"><a href="#NIO-2-å¼‚æ­¥-IO" class="headerlink" title="NIO.2 å¼‚æ­¥ IO"></a>NIO.2 å¼‚æ­¥ IO</h2><p>More New IOï¼Œæˆ–ç§° NIO.2ï¼Œéš JDK 1.7 å‘å¸ƒï¼ŒåŒ…æ‹¬äº†å¼•å…¥å¼‚æ­¥ IO æ¥å£å’Œ Paths ç­‰æ–‡ä»¶è®¿é—®æ¥å£ã€‚</p>
<p>å¼‚æ­¥è¿™ä¸ªè¯ï¼Œæˆ‘æƒ³å¯¹äºç»å¤§å¤šæ•°å¼€å‘è€…æ¥è¯´éƒ½å¾ˆç†Ÿæ‚‰ï¼Œå¾ˆå¤šåœºæ™¯ä¸‹æˆ‘ä»¬éƒ½ä¼šä½¿ç”¨å¼‚æ­¥ã€‚</p>
<p>é€šå¸¸ï¼Œæˆ‘ä»¬ä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹æ± ç”¨äºæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ï¼Œæäº¤ä»»åŠ¡çš„çº¿ç¨‹å°†ä»»åŠ¡æäº¤åˆ°çº¿ç¨‹æ± å°±å¯ä»¥ç«‹é©¬è¿”å›ï¼Œä¸å¿…ç­‰åˆ°ä»»åŠ¡çœŸæ­£å®Œæˆã€‚å¦‚æœæƒ³è¦çŸ¥é“ä»»åŠ¡çš„æ‰§è¡Œç»“æœï¼Œé€šå¸¸æ˜¯é€šè¿‡ä¼ é€’ä¸€ä¸ªå›è°ƒå‡½æ•°çš„æ–¹å¼ï¼Œä»»åŠ¡ç»“æŸåå»è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚</p>
<p>åŒæ ·çš„åŸç†ï¼ŒJava ä¸­çš„å¼‚æ­¥ IO ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯ç”±ä¸€ä¸ªçº¿ç¨‹æ± æ¥è´Ÿè´£æ‰§è¡Œä»»åŠ¡ï¼Œç„¶åä½¿ç”¨å›è°ƒæˆ–è‡ªå·±å»æŸ¥è¯¢ç»“æœã€‚</p>
<p>å¤§éƒ¨åˆ†å¼€å‘è€…éƒ½çŸ¥é“ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆè®¾è®¡äº†ï¼Œè¿™é‡Œå†å•°å—¦ä¸€ä¸‹ã€‚å¼‚æ­¥ IO ä¸»è¦æ˜¯ä¸ºäº†æ§åˆ¶çº¿ç¨‹æ•°é‡ï¼Œå‡å°‘è¿‡å¤šçš„çº¿ç¨‹å¸¦æ¥çš„å†…å­˜æ¶ˆè€—å’Œ CPU åœ¨çº¿ç¨‹è°ƒåº¦ä¸Šçš„å¼€é”€ã€‚</p>
<p><strong>åœ¨ Unix/Linux ç­‰ç³»ç»Ÿä¸­ï¼ŒJDK ä½¿ç”¨äº†å¹¶å‘åŒ…ä¸­çš„çº¿ç¨‹æ± æ¥ç®¡ç†ä»»åŠ¡</strong>ï¼Œå…·ä½“å¯ä»¥æŸ¥çœ‹ AsynchronousChannelGroup çš„æºç ã€‚</p>
<p>åœ¨ Windows æ“ä½œç³»ç»Ÿä¸­ï¼Œæä¾›äº†ä¸€ä¸ªå«åš <a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa365198.aspx">I/O Completion Ports</a> çš„æ–¹æ¡ˆï¼Œé€šå¸¸ç®€ç§°ä¸º <strong>IOCP</strong>ï¼Œæ“ä½œç³»ç»Ÿè´Ÿè´£ç®¡ç†çº¿ç¨‹æ± ï¼Œå…¶æ€§èƒ½éå¸¸ä¼˜å¼‚ï¼Œæ‰€ä»¥<strong>åœ¨ Windows ä¸­ JDK ç›´æ¥é‡‡ç”¨äº† IOCP çš„æ”¯æŒ</strong>ï¼Œä½¿ç”¨ç³»ç»Ÿæ”¯æŒï¼ŒæŠŠæ›´å¤šçš„æ“ä½œä¿¡æ¯æš´éœ²ç»™æ“ä½œç³»ç»Ÿï¼Œä¹Ÿä½¿å¾—æ“ä½œç³»ç»Ÿèƒ½å¤Ÿå¯¹æˆ‘ä»¬çš„ IO è¿›è¡Œä¸€å®šç¨‹åº¦çš„ä¼˜åŒ–ã€‚</p>
<blockquote>
<p>åœ¨ Linux ä¸­å…¶å®ä¹Ÿæ˜¯æœ‰å¼‚æ­¥ IO ç³»ç»Ÿå®ç°çš„ï¼Œä½†æ˜¯é™åˆ¶æ¯”è¾ƒå¤šï¼Œæ€§èƒ½ä¹Ÿä¸€èˆ¬ï¼Œæ‰€ä»¥ JDK é‡‡ç”¨äº†è‡ªå»ºçº¿ç¨‹æ± çš„æ–¹å¼ã€‚</p>
</blockquote>
<p>æœ¬æ–‡è¿˜æ˜¯ä»¥å®ç”¨ä¸ºä¸»ï¼Œæƒ³è¦äº†è§£æ›´å¤šä¿¡æ¯è¯·è‡ªè¡ŒæŸ¥æ‰¾å…¶ä»–èµ„æ–™ï¼Œä¸‹é¢å¯¹ Java å¼‚æ­¥ IO è¿›è¡Œå®è·µæ€§çš„ä»‹ç»ã€‚</p>
<p>æ€»å…±æœ‰ä¸‰ä¸ªç±»éœ€è¦æˆ‘ä»¬å…³æ³¨ï¼Œåˆ†åˆ«æ˜¯ <strong>AsynchronousSocketChannel</strong>ï¼Œ<strong>AsynchronousServerSocketChannel</strong> å’Œ <strong>AsynchronousFileChannel</strong>ï¼Œåªä¸è¿‡æ˜¯åœ¨ä¹‹å‰ä»‹ç»çš„ FileChannelã€SocketChannel å’Œ ServerSocketChannel çš„ç±»åä¸ŠåŠ äº†ä¸ªå‰ç¼€ <strong>Asynchronous</strong>ã€‚</p>
<p>Java å¼‚æ­¥ IO æä¾›äº†ä¸¤ç§ä½¿ç”¨æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯è¿”å› Future å®ä¾‹å’Œä½¿ç”¨å›è°ƒå‡½æ•°ã€‚</p>
<h3 id="1ã€è¿”å›-Future-å®ä¾‹"><a href="#1ã€è¿”å›-Future-å®ä¾‹" class="headerlink" title="1ã€è¿”å› Future å®ä¾‹"></a>1ã€è¿”å› Future å®ä¾‹</h3><p>è¿”å› java.util.concurrent.Future å®ä¾‹çš„æ–¹å¼æˆ‘ä»¬åº”è¯¥å¾ˆç†Ÿæ‚‰ï¼ŒJDK çº¿ç¨‹æ± å°±æ˜¯è¿™ä¹ˆä½¿ç”¨çš„ã€‚Future æ¥å£çš„å‡ ä¸ªæ–¹æ³•è¯­ä¹‰åœ¨è¿™é‡Œä¹Ÿæ˜¯é€šç”¨çš„ï¼Œè¿™é‡Œå…ˆåšç®€å•ä»‹ç»ã€‚</p>
<ul>
<li><p>future.isDone();</p>
<p>åˆ¤æ–­æ“ä½œæ˜¯å¦å·²ç»å®Œæˆï¼ŒåŒ…æ‹¬äº†<strong>æ­£å¸¸å®Œæˆã€å¼‚å¸¸æŠ›å‡ºã€å–æ¶ˆ</strong></p>
</li>
<li><p>future.cancel(true);</p>
<p>å–æ¶ˆæ“ä½œï¼Œæ–¹å¼æ˜¯ä¸­æ–­ã€‚å‚æ•° true è¯´çš„æ˜¯ï¼Œå³ä½¿è¿™ä¸ªä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œä¹Ÿä¼šè¿›è¡Œä¸­æ–­ã€‚</p>
</li>
<li><p>future.isCancelled();</p>
<p>æ˜¯å¦è¢«å–æ¶ˆï¼Œåªæœ‰åœ¨ä»»åŠ¡æ­£å¸¸ç»“æŸä¹‹å‰è¢«å–æ¶ˆï¼Œè¿™ä¸ªæ–¹æ³•æ‰ä¼šè¿”å› true</p>
</li>
<li><p>future.get(); </p>
<p>è¿™æ˜¯æˆ‘ä»¬çš„è€æœ‹å‹ï¼Œè·å–æ‰§è¡Œç»“æœï¼Œé˜»å¡ã€‚</p>
</li>
<li><p>future.get(10, TimeUnit.SECONDS);</p>
<p>å¦‚æœä¸Šé¢çš„ get() æ–¹æ³•çš„é˜»å¡ä½ ä¸æ»¡æ„ï¼Œé‚£å°±è®¾ç½®ä¸ªè¶…æ—¶æ—¶é—´ã€‚</p>
</li>
</ul>
<h3 id="2ã€æä¾›-CompletionHandler-å›è°ƒå‡½æ•°"><a href="#2ã€æä¾›-CompletionHandler-å›è°ƒå‡½æ•°" class="headerlink" title="2ã€æä¾› CompletionHandler å›è°ƒå‡½æ•°"></a>2ã€æä¾› CompletionHandler å›è°ƒå‡½æ•°</h3><p>java.nio.channels.CompletionHandler æ¥å£å®šä¹‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CompletionHandler</span>&lt;V,A&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">completed</span><span class="params">(V result, A attachment)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">failed</span><span class="params">(Throwable exc, A attachment)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ³¨æ„ï¼Œå‚æ•°ä¸Šæœ‰ä¸ª attachmentï¼Œè™½ç„¶ä¸å¸¸ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å„ä¸ªæ”¯æŒçš„æ–¹æ³•ä¸­ä¼ é€’è¿™ä¸ªå‚æ•°å€¼</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AsynchronousServerSocketChannel</span> <span class="variable">listener</span> <span class="operator">=</span> AsynchronousServerSocketChannel.open().bind(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// accept æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°å¯ä»¥ä¼ é€’ attachment</span></span><br><span class="line">listener.accept(attachment, <span class="keyword">new</span> <span class="title class_">CompletionHandler</span>&lt;AsynchronousSocketChannel, Object&gt;() &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">completed</span><span class="params">(</span></span><br><span class="line"><span class="params">    Â Â AsynchronousSocketChannel client, Object attachment)</span> &#123;</span><br><span class="line">    Â Â Â Â Â Â <span class="comment">// </span></span><br><span class="line">    Â Â &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">failed</span><span class="params">(Throwable exc, Object attachment)</span> &#123;</span><br><span class="line">    Â Â Â Â Â Â <span class="comment">// </span></span><br><span class="line">    Â Â &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="AsynchronousFileChannel"><a href="#AsynchronousFileChannel" class="headerlink" title="AsynchronousFileChannel"></a>AsynchronousFileChannel</h3><p>ç½‘ä¸Šå…³äº Non-Blocking IO çš„ä»‹ç»æ–‡ç« å¾ˆå¤šï¼Œä½†æ˜¯ Asynchronous IO çš„æ–‡ç« ç›¸å¯¹å°±å°‘å¾—å¤šäº†ï¼Œæ‰€ä»¥æˆ‘è¿™è¾¹ä¼šå¤šä»‹ç»ä¸€äº›ç›¸å…³å†…å®¹ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å°±æ¥å…³æ³¨å¼‚æ­¥çš„æ–‡ä»¶ IOï¼Œå‰é¢æˆ‘ä»¬è¯´äº†ï¼Œæ–‡ä»¶ IO åœ¨æ‰€æœ‰çš„æ“ä½œç³»ç»Ÿä¸­éƒ½ä¸æ”¯æŒéé˜»å¡æ¨¡å¼ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥å¯¹æ–‡ä»¶ IO é‡‡ç”¨å¼‚æ­¥çš„æ–¹å¼æ¥æé«˜æ€§èƒ½ã€‚</p>
<p>ä¸‹é¢ï¼Œæˆ‘ä¼šä»‹ç» AsynchronousFileChannel é‡Œé¢çš„ä¸€äº›é‡è¦çš„æ¥å£ï¼Œéƒ½å¾ˆç®€å•ï¼Œè¯»è€…è¦æ˜¯è§‰å¾—æ— è¶£ï¼Œç›´æ¥æ»‘åˆ°ä¸‹ä¸€ä¸ªæ ‡é¢˜å°±å¯ä»¥äº†ã€‚</p>
<p>å®ä¾‹åŒ–ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AsynchronousFileChannel</span> <span class="variable">channel</span> <span class="operator">=</span> AsynchronousFileChannel.open(Paths.get(<span class="string">&quot;/Users/hongjie/test.txt&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>ä¸€æ—¦å®ä¾‹åŒ–å®Œæˆï¼Œæˆ‘ä»¬å°±å¯ä»¥ç€æ‰‹å‡†å¤‡å°†æ•°æ®è¯»å…¥åˆ° Buffer ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">Future&lt;Integer&gt; result = channel.read(buffer, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å¼‚æ­¥æ–‡ä»¶é€šé“çš„è¯»æ“ä½œå’Œå†™æ“ä½œéƒ½éœ€è¦æä¾›ä¸€ä¸ªæ–‡ä»¶çš„å¼€å§‹ä½ç½®ï¼Œæ–‡ä»¶å¼€å§‹ä½ç½®ä¸º 0</p>
</blockquote>
<p>é™¤äº†ä½¿ç”¨è¿”å› Future å®ä¾‹çš„æ–¹å¼ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨å›è°ƒå‡½æ•°è¿›è¡Œæ“ä½œï¼Œæ¥å£å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> &lt;A&gt; <span class="keyword">void</span> <span class="title function_">read</span><span class="params">(ByteBuffer dst,</span></span><br><span class="line"><span class="params">                              <span class="type">long</span> position,</span></span><br><span class="line"><span class="params">                              A attachment,</span></span><br><span class="line"><span class="params">                              CompletionHandler&lt;Integer,? <span class="built_in">super</span> A&gt; handler)</span>;</span><br></pre></td></tr></table></figure>

<p>é¡ºä¾¿ä¹Ÿè´´ä¸€ä¸‹å†™æ“ä½œçš„ä¸¤ä¸ªç‰ˆæœ¬çš„æ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> Future&lt;Integer&gt; <span class="title function_">write</span><span class="params">(ByteBuffer src, <span class="type">long</span> position)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> &lt;A&gt; <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(ByteBuffer src,</span></span><br><span class="line"><span class="params">                               <span class="type">long</span> position,</span></span><br><span class="line"><span class="params">                               A attachment,</span></span><br><span class="line"><span class="params">                               CompletionHandler&lt;Integer,? <span class="built_in">super</span> A&gt; handler)</span>;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒAIO çš„è¯»å†™ä¸»è¦ä¹Ÿè¿˜æ˜¯ä¸ Buffer æ‰“äº¤é“ï¼Œè¿™ä¸ªä¸ NIO æ˜¯ä¸€è„‰ç›¸æ‰¿çš„ã€‚</p>
<p>å¦å¤–ï¼Œè¿˜æä¾›äº†ç”¨äºå°†å†…å­˜ä¸­çš„æ•°æ®åˆ·å…¥åˆ°ç£ç›˜çš„æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">force</span><span class="params">(<span class="type">boolean</span> metaData)</span> <span class="keyword">throws</span> IOException;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å› ä¸ºæˆ‘ä»¬å¯¹æ–‡ä»¶çš„å†™æ“ä½œï¼Œæ“ä½œç³»ç»Ÿå¹¶ä¸ä¼šç›´æ¥é’ˆå¯¹æ–‡ä»¶æ“ä½œï¼Œç³»ç»Ÿä¼šç¼“å­˜ï¼Œç„¶åå‘¨æœŸæ€§åœ°åˆ·å…¥åˆ°ç£ç›˜ã€‚å¦‚æœå¸Œæœ›å°†æ•°æ®åŠæ—¶å†™å…¥åˆ°ç£ç›˜ä¸­ï¼Œä»¥å…æ–­ç”µå¼•å‘éƒ¨åˆ†æ•°æ®ä¸¢å¤±ï¼Œå¯ä»¥è°ƒç”¨æ­¤æ–¹æ³•ã€‚å‚æ•°å¦‚æœè®¾ç½®ä¸º trueï¼Œæ„å‘³ç€åŒæ—¶ä¹Ÿå°†æ–‡ä»¶å±æ€§ä¿¡æ¯æ›´æ–°åˆ°ç£ç›˜ã€‚</p>
</blockquote>
<p>è¿˜æœ‰ï¼Œè¿˜æä¾›äº†å¯¹æ–‡ä»¶çš„é”å®šåŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥é”å®šæ–‡ä»¶çš„éƒ¨åˆ†æ•°æ®ï¼Œè¿™æ ·å¯ä»¥è¿›è¡Œæ’ä»–æ€§çš„æ“ä½œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> Future&lt;FileLock&gt; <span class="title function_">lock</span><span class="params">(<span class="type">long</span> position, <span class="type">long</span> size, <span class="type">boolean</span> shared)</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>position æ˜¯è¦é”å®šå†…å®¹çš„å¼€å§‹ä½ç½®ï¼Œsize æŒ‡ç¤ºäº†è¦é”å®šçš„åŒºåŸŸå¤§å°ï¼Œshared æŒ‡ç¤ºéœ€è¦çš„æ˜¯å…±äº«é”è¿˜æ˜¯æ’ä»–é”</p>
</blockquote>
<p>å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å›è°ƒå‡½æ•°çš„ç‰ˆæœ¬ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> &lt;A&gt; <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">(<span class="type">long</span> position,</span></span><br><span class="line"><span class="params">                              <span class="type">long</span> size,</span></span><br><span class="line"><span class="params">                              <span class="type">boolean</span> shared,</span></span><br><span class="line"><span class="params">                              A attachment,</span></span><br><span class="line"><span class="params">                              CompletionHandler&lt;FileLock,? <span class="built_in">super</span> A&gt; handler)</span>;</span><br></pre></td></tr></table></figure>

<p>æ–‡ä»¶é”å®šåŠŸèƒ½ä¸Šè¿˜æä¾›äº† tryLock æ–¹æ³•ï¼Œæ­¤æ–¹æ³•ä¼šå¿«é€Ÿè¿”å›ç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> FileLock <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> position, <span class="type">long</span> size, <span class="type">boolean</span> shared)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿™ä¸ªæ–¹æ³•å¾ˆç®€å•ï¼Œå°±æ˜¯å°è¯•å»è·å–é”ï¼Œå¦‚æœè¯¥åŒºåŸŸå·²è¢«å…¶ä»–çº¿ç¨‹æˆ–å…¶ä»–åº”ç”¨é”ä½ï¼Œé‚£ä¹ˆç«‹åˆ»è¿”å› nullï¼Œå¦åˆ™è¿”å›  FileLock å¯¹è±¡ã€‚</p>
</blockquote>
<p>AsynchronousFileChannel æ“ä½œå¤§ä½“ä¸Šä¹Ÿå°±ä»¥ä¸Šä»‹ç»çš„è¿™äº›æ¥å£ï¼Œè¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œè¿™é‡Œå°±å°‘ä¸€äº›åºŸè¯æ—©ç‚¹ç»“æŸå¥½äº†ã€‚</p>
<h3 id="AsynchronousServerSocketChannel"><a href="#AsynchronousServerSocketChannel" class="headerlink" title="AsynchronousServerSocketChannel"></a>AsynchronousServerSocketChannel</h3><p>è¿™ä¸ªç±»å¯¹åº”çš„æ˜¯éé˜»å¡ IO çš„ ServerSocketChannelï¼Œå¤§å®¶å¯ä»¥ç±»æ¯”ä¸‹ä½¿ç”¨æ–¹å¼ã€‚</p>
<p>æˆ‘ä»¬å°±åºŸè¯å°‘è¯´ï¼Œç”¨ä»£ç è¯´äº‹å§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.javadoop.aio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.SocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.AsynchronousServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.AsynchronousSocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.CompletionHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Server</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">      	<span class="comment">// å®ä¾‹åŒ–ï¼Œå¹¶ç›‘å¬ç«¯å£</span></span><br><span class="line">        <span class="type">AsynchronousServerSocketChannel</span> <span class="variable">server</span> <span class="operator">=</span></span><br><span class="line">                AsynchronousServerSocketChannel.open().bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">8080</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è‡ªå·±å®šä¹‰ä¸€ä¸ª Attachment ç±»ï¼Œç”¨äºä¼ é€’ä¸€äº›ä¿¡æ¯</span></span><br><span class="line">        <span class="type">Attachment</span> <span class="variable">att</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Attachment</span>();</span><br><span class="line">        att.setServer(server);</span><br><span class="line"></span><br><span class="line">        server.accept(att, <span class="keyword">new</span> <span class="title class_">CompletionHandler</span>&lt;AsynchronousSocketChannel, Attachment&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">completed</span><span class="params">(AsynchronousSocketChannel client, Attachment att)</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">SocketAddress</span> <span class="variable">clientAddr</span> <span class="operator">=</span> client.getRemoteAddress();</span><br><span class="line">                    System.out.println(<span class="string">&quot;æ”¶åˆ°æ–°çš„è¿æ¥ï¼š&quot;</span> + clientAddr);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// æ”¶åˆ°æ–°çš„è¿æ¥åï¼Œserver åº”è¯¥é‡æ–°è°ƒç”¨ accept æ–¹æ³•ç­‰å¾…æ–°çš„è¿æ¥è¿›æ¥</span></span><br><span class="line">                    att.getServer().accept(att, <span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="type">Attachment</span> <span class="variable">newAtt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Attachment</span>();</span><br><span class="line">                    newAtt.setServer(server);</span><br><span class="line">                    newAtt.setClient(client);</span><br><span class="line">                    newAtt.setReadMode(<span class="literal">true</span>);</span><br><span class="line">                    newAtt.setBuffer(ByteBuffer.allocate(<span class="number">2048</span>));</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// è¿™é‡Œä¹Ÿå¯ä»¥ç»§ç»­ä½¿ç”¨åŒ¿åå®ç°ç±»ï¼Œä¸è¿‡ä»£ç ä¸å¥½çœ‹ï¼Œæ‰€ä»¥è¿™é‡Œä¸“é—¨å®šä¹‰ä¸€ä¸ªç±»</span></span><br><span class="line">                    client.read(newAtt.getBuffer(), newAtt, <span class="keyword">new</span> <span class="title class_">ChannelHandler</span>());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">failed</span><span class="params">(Throwable t, Attachment att)</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;accept failed&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// ä¸ºäº†é˜²æ­¢ main çº¿ç¨‹é€€å‡º</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.currentThread().join();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>çœ‹ä¸€ä¸‹ ChannelHandler ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.javadoop.aio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.CompletionHandler;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChannelHandler</span> <span class="keyword">implements</span> <span class="title class_">CompletionHandler</span>&lt;Integer, Attachment&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">completed</span><span class="params">(Integer result, Attachment att)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (att.isReadMode()) &#123;</span><br><span class="line">            <span class="comment">// è¯»å–æ¥è‡ªå®¢æˆ·ç«¯çš„æ•°æ®</span></span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> att.getBuffer();</span><br><span class="line">            buffer.flip();</span><br><span class="line">            <span class="type">byte</span> bytes[] = <span class="keyword">new</span> <span class="title class_">byte</span>[buffer.limit()];</span><br><span class="line">            buffer.get(bytes);</span><br><span class="line">            <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(buffer.array()).toString().trim();</span><br><span class="line">            System.out.println(<span class="string">&quot;æ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„æ•°æ®: &quot;</span> + msg);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å“åº”å®¢æˆ·ç«¯è¯·æ±‚ï¼Œè¿”å›æ•°æ®</span></span><br><span class="line">            buffer.clear();</span><br><span class="line">            buffer.put(<span class="string">&quot;Response from server!&quot;</span>.getBytes(Charset.forName(<span class="string">&quot;UTF-8&quot;</span>)));</span><br><span class="line">            att.setReadMode(<span class="literal">false</span>);</span><br><span class="line">            buffer.flip();</span><br><span class="line">            <span class="comment">// å†™æ•°æ®åˆ°å®¢æˆ·ç«¯ä¹Ÿæ˜¯å¼‚æ­¥</span></span><br><span class="line">            att.getClient().write(buffer, att, <span class="built_in">this</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// åˆ°è¿™é‡Œï¼Œè¯´æ˜å¾€å®¢æˆ·ç«¯å†™æ•°æ®ä¹Ÿç»“æŸäº†ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§é€‰æ‹©:</span></span><br><span class="line">            <span class="comment">// 1. ç»§ç»­ç­‰å¾…å®¢æˆ·ç«¯å‘é€æ–°çš„æ•°æ®è¿‡æ¥</span></span><br><span class="line"><span class="comment">//            att.setReadMode(true);</span></span><br><span class="line"><span class="comment">//            att.getBuffer().clear();</span></span><br><span class="line"><span class="comment">//            att.getClient().read(att.getBuffer(), att, this);</span></span><br><span class="line">            <span class="comment">// 2. æ—¢ç„¶æœåŠ¡ç«¯å·²ç»è¿”å›æ•°æ®ç»™å®¢æˆ·ç«¯ï¼Œæ–­å¼€è¿™æ¬¡çš„è¿æ¥</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                att.getClient().close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">failed</span><span class="params">(Throwable t, Attachment att)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è¿æ¥æ–­å¼€&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¡ºä¾¿å†è´´ä¸€ä¸‹è‡ªå®šä¹‰çš„ Attachment ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Attachment</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> AsynchronousServerSocketChannel server;</span><br><span class="line">    <span class="keyword">private</span> AsynchronousSocketChannel client;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> isReadMode;</span><br><span class="line">    <span class="keyword">private</span> ByteBuffer buffer;</span><br><span class="line">    <span class="comment">// getter &amp; setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·ï¼Œä¸€ä¸ªç®€å•çš„æœåŠ¡ç«¯å°±å†™å¥½äº†ï¼Œæ¥ä¸‹æ¥å¯ä»¥æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚äº†ã€‚ä¸Šé¢æˆ‘ä»¬ç”¨çš„éƒ½æ˜¯å›è°ƒå‡½æ•°çš„æ–¹å¼ï¼Œè¯»è€…è¦æ˜¯æ„Ÿå…´è¶£ï¼Œå¯ä»¥è¯•è¯•å†™ä¸ªä½¿ç”¨ Future çš„ã€‚</p>
<h3 id="AsynchronousSocketChannel"><a href="#AsynchronousSocketChannel" class="headerlink" title="AsynchronousSocketChannel"></a>AsynchronousSocketChannel</h3><p>å…¶å®ï¼Œè¯´å®Œä¸Šé¢çš„ AsynchronousServerSocketChannelï¼ŒåŸºæœ¬ä¸Šè¯»è€…ä¹Ÿå°±çŸ¥é“æ€ä¹ˆä½¿ç”¨ AsynchronousSocketChannel äº†ï¼Œå’Œéé˜»å¡ IO åŸºæœ¬ç±»ä¼¼ã€‚</p>
<p>è¿™è¾¹åšä¸ªç®€å•æ¼”ç¤ºï¼Œè¿™æ ·è¯»è€…å°±å¯ä»¥é…åˆä¹‹å‰ä»‹ç»çš„ Server è¿›è¡Œæµ‹è¯•ä½¿ç”¨äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.javadoop.aio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.AsynchronousSocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutionException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Future;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">AsynchronousSocketChannel</span> <span class="variable">client</span> <span class="operator">=</span> AsynchronousSocketChannel.open();</span><br><span class="line">      	<span class="comment">// æ¥ä¸ª Future å½¢å¼çš„</span></span><br><span class="line">        Future&lt;?&gt; future = client.connect(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">8080</span>));</span><br><span class="line">        <span class="comment">// é˜»å¡ä¸€ä¸‹ï¼Œç­‰å¾…è¿æ¥æˆåŠŸ</span></span><br><span class="line">        future.get();</span><br><span class="line"></span><br><span class="line">        <span class="type">Attachment</span> <span class="variable">att</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Attachment</span>();</span><br><span class="line">        att.setClient(client);</span><br><span class="line">        att.setReadMode(<span class="literal">false</span>);</span><br><span class="line">        att.setBuffer(ByteBuffer.allocate(<span class="number">2048</span>));</span><br><span class="line">        <span class="type">byte</span>[] data = <span class="string">&quot;I am obot!&quot;</span>.getBytes();</span><br><span class="line">        att.getBuffer().put(data);</span><br><span class="line">        att.getBuffer().flip();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¼‚æ­¥å‘é€æ•°æ®åˆ°æœåŠ¡ç«¯</span></span><br><span class="line">        client.write(att.getBuffer(), att, <span class="keyword">new</span> <span class="title class_">ClientChannelHandler</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿™é‡Œä¼‘æ¯ä¸€ä¸‹å†é€€å‡ºï¼Œç»™å‡ºè¶³å¤Ÿçš„æ—¶é—´å¤„ç†æ•°æ®</span></span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¾€é‡Œé¢çœ‹ä¸‹ ClientChannelHandler ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.javadoop.aio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.CompletionHandler;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClientChannelHandler</span> <span class="keyword">implements</span> <span class="title class_">CompletionHandler</span>&lt;Integer, Attachment&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">completed</span><span class="params">(Integer result, Attachment att)</span> &#123;</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> att.getBuffer();</span><br><span class="line">        <span class="keyword">if</span> (att.isReadMode()) &#123;</span><br><span class="line">            <span class="comment">// è¯»å–æ¥è‡ªæœåŠ¡ç«¯çš„æ•°æ®</span></span><br><span class="line">            buffer.flip();</span><br><span class="line">            <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[buffer.limit()];</span><br><span class="line">            buffer.get(bytes);</span><br><span class="line">            <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(bytes, Charset.forName(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;æ”¶åˆ°æ¥è‡ªæœåŠ¡ç«¯çš„å“åº”æ•°æ®: &quot;</span> + msg);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ¥ä¸‹æ¥ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§é€‰æ‹©:</span></span><br><span class="line">            <span class="comment">// 1. å‘æœåŠ¡ç«¯å‘é€æ–°çš„æ•°æ®</span></span><br><span class="line"><span class="comment">//            att.setReadMode(false);</span></span><br><span class="line"><span class="comment">//            buffer.clear();</span></span><br><span class="line"><span class="comment">//            String newMsg = &quot;new message from client&quot;;</span></span><br><span class="line"><span class="comment">//            byte[] data = newMsg.getBytes(Charset.forName(&quot;UTF-8&quot;));</span></span><br><span class="line"><span class="comment">//            buffer.put(data);</span></span><br><span class="line"><span class="comment">//            buffer.flip();</span></span><br><span class="line"><span class="comment">//            att.getClient().write(buffer, att, this);</span></span><br><span class="line">            <span class="comment">// 2. å…³é—­è¿æ¥</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                att.getClient().close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å†™æ“ä½œå®Œæˆåï¼Œä¼šè¿›åˆ°è¿™é‡Œ</span></span><br><span class="line">            att.setReadMode(<span class="literal">true</span>);</span><br><span class="line">            buffer.clear();</span><br><span class="line">            att.getClient().read(buffer, att, <span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">failed</span><span class="params">(Throwable t, Attachment att)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æœåŠ¡å™¨æ— å“åº”&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šä»£ç éƒ½æ˜¯å¯ä»¥è¿è¡Œè°ƒè¯•çš„ï¼Œå¦‚æœè¯»è€…ç¢°åˆ°é—®é¢˜ï¼Œè¯·åœ¨è¯„è®ºåŒºç•™è¨€ã€‚</p>
<h3 id="Asynchronous-Channel-Groups"><a href="#Asynchronous-Channel-Groups" class="headerlink" title="Asynchronous Channel Groups"></a>Asynchronous Channel Groups</h3><p>ä¸ºäº†çŸ¥è¯†çš„å®Œæ•´æ€§ï¼Œæœ‰å¿…è¦å¯¹ group è¿›è¡Œä»‹ç»ï¼Œå…¶å®ä¹Ÿå°±æ˜¯ä»‹ç» AsynchronousChannelGroup è¿™ä¸ªç±»ã€‚ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼Œå¼‚æ­¥ IO ä¸€å®šå­˜åœ¨ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œè¿™ä¸ªçº¿ç¨‹æ± è´Ÿè´£æ¥æ”¶ä»»åŠ¡ã€å¤„ç† IO äº‹ä»¶ã€å›è°ƒç­‰ã€‚è¿™ä¸ªçº¿ç¨‹æ± å°±åœ¨ group å†…éƒ¨ï¼Œgroup ä¸€æ—¦å…³é—­ï¼Œé‚£ä¹ˆç›¸åº”çš„çº¿ç¨‹æ± å°±ä¼šå…³é—­ã€‚</p>
<p>AsynchronousServerSocketChannels å’Œ     AsynchronousSocketChannels æ˜¯å±äº group çš„ï¼Œå½“æˆ‘ä»¬è°ƒç”¨ AsynchronousServerSocketChannel æˆ– AsynchronousSocketChannel çš„ open() æ–¹æ³•çš„æ—¶å€™ï¼Œç›¸åº”çš„ channel å°±å±äºé»˜è®¤çš„ groupï¼Œè¿™ä¸ª group ç”± JVM è‡ªåŠ¨æ„é€ å¹¶ç®¡ç†ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬æƒ³è¦é…ç½®è¿™ä¸ªé»˜è®¤çš„ groupï¼Œå¯ä»¥åœ¨ JVM å¯åŠ¨å‚æ•°ä¸­æŒ‡å®šä»¥ä¸‹ç³»ç»Ÿå˜é‡ï¼š</p>
<ul>
<li><p>java.nio.channels.DefaultThreadPool.threadFactory</p>
<p>æ­¤ç³»ç»Ÿå˜é‡ç”¨äºè®¾ç½® ThreadFactoryï¼Œå®ƒåº”è¯¥æ˜¯ java.util.concurrent.ThreadFactory å®ç°ç±»çš„å…¨é™å®šç±»åã€‚ä¸€æ—¦æˆ‘ä»¬æŒ‡å®šäº†è¿™ä¸ª ThreadFactory ä»¥åï¼Œgroup ä¸­çš„çº¿ç¨‹å°±ä¼šä½¿ç”¨è¯¥ç±»äº§ç”Ÿã€‚</p>
</li>
<li><p>java.nio.channels.DefaultThreadPool.initialSize</p>
<p>æ­¤ç³»ç»Ÿå˜é‡ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œç”¨äºè®¾ç½®çº¿ç¨‹æ± çš„åˆå§‹å¤§å°ã€‚</p>
</li>
</ul>
<p>å¯èƒ½ä½ ä¼šæƒ³è¦ä½¿ç”¨è‡ªå·±å®šä¹‰çš„ groupï¼Œè¿™æ ·å¯ä»¥å¯¹å…¶ä¸­çš„çº¿ç¨‹è¿›è¡Œæ›´å¤šçš„æ§åˆ¶ï¼Œä½¿ç”¨ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•å³å¯ï¼š</p>
<ul>
<li>AsynchronousChannelGroup.withCachedThreadPool(ExecutorService executor, int initialSize)</li>
<li>AsynchronousChannelGroup.withFixedThreadPool(int nThreads, ThreadFactory threadFactory)</li>
<li>AsynchronousChannelGroup.withThreadPool(ExecutorService executor)</li>
</ul>
<p>ç†Ÿæ‚‰çº¿ç¨‹æ± çš„è¯»è€…å¯¹è¿™äº›æ–¹æ³•åº”è¯¥å¾ˆå¥½ç†è§£ï¼Œå®ƒä»¬éƒ½æ˜¯ AsynchronousChannelGroup ä¸­çš„é™æ€æ–¹æ³•ã€‚</p>
<p>è‡³äº group çš„ä½¿ç”¨å°±å¾ˆç®€å•äº†ï¼Œä»£ç ä¸€çœ‹å°±æ‡‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AsynchronousChannelGroup</span> <span class="variable">group</span> <span class="operator">=</span> AsynchronousChannelGroup</span><br><span class="line">        .withFixedThreadPool(<span class="number">10</span>, Executors.defaultThreadFactory());</span><br><span class="line"><span class="type">AsynchronousServerSocketChannel</span> <span class="variable">server</span> <span class="operator">=</span> AsynchronousServerSocketChannel.open(group);</span><br><span class="line"><span class="type">AsynchronousSocketChannel</span> <span class="variable">client</span> <span class="operator">=</span> AsynchronousSocketChannel.open(group);</span><br></pre></td></tr></table></figure>

<p><strong>AsynchronousFileChannels ä¸å±äº group</strong>ã€‚ä½†æ˜¯å®ƒä»¬ä¹Ÿæ˜¯å…³è”åˆ°ä¸€ä¸ªçº¿ç¨‹æ± çš„ï¼Œå¦‚æœä¸æŒ‡å®šï¼Œä¼šä½¿ç”¨ç³»ç»Ÿé»˜è®¤çš„çº¿ç¨‹æ± ï¼Œå¦‚æœæƒ³è¦ä½¿ç”¨æŒ‡å®šçš„çº¿ç¨‹æ± ï¼Œå¯ä»¥åœ¨å®ä¾‹åŒ–çš„æ—¶å€™ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> AsynchronousFileChannel <span class="title function_">open</span><span class="params">(Path file,</span></span><br><span class="line"><span class="params">                                           Set&lt;? extends OpenOption&gt; options,</span></span><br><span class="line"><span class="params">                                           ExecutorService executor,</span></span><br><span class="line"><span class="params">                                           FileAttribute&lt;?&gt;... attrs)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ°è¿™é‡Œï¼Œå¼‚æ­¥ IO å°±ç®—ä»‹ç»å®Œæˆäº†ã€‚</p>
<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æˆ‘æƒ³ï¼Œæœ¬æ–‡åº”è¯¥æ˜¯è¯´æ¸…æ¥šäº†éé˜»å¡ IO å’Œå¼‚æ­¥ IO äº†ï¼Œå¯¹äºå¼‚æ­¥ IOï¼Œç”±äºç½‘ä¸Šçš„èµ„æ–™æ¯”è¾ƒå°‘ï¼Œæ‰€ä»¥ä¸å…ç¯‡å¹…å¤šäº†äº›ã€‚</p>
<p>æˆ‘ä»¬ä¹Ÿè¦çŸ¥é“ï¼Œçœ‹æ‡‚äº†è¿™äº›ï¼Œç¡®å®å¯ä»¥å­¦åˆ°ä¸€äº›ä¸œè¥¿ï¼Œå¤šäº†è§£ä¸€äº›çŸ¥è¯†ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯å¾ˆå°‘åœ¨å·¥ä½œä¸­å°†è¿™äº›çŸ¥è¯†å˜æˆå·¥ç¨‹ä»£ç ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç½‘ç»œåº”ç”¨ä¸­ä½¿ç”¨ NIO æˆ– AIO æ¥æå‡æ€§èƒ½ï¼Œä½†æ˜¯ï¼Œåœ¨å·¥ç¨‹ä¸Šï¼Œç»ä¸æ˜¯äº†è§£äº†ä¸€äº›æ¦‚å¿µï¼ŒçŸ¥é“äº†ä¸€äº›æ¥å£å°±å¯ä»¥çš„ï¼Œéœ€è¦å¤„ç†çš„ç»†èŠ‚è¿˜éå¸¸å¤šã€‚</p>
<p>è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ Netty/Mina å¦‚æ­¤ç››è¡Œçš„åŸå› ï¼Œå› ä¸ºå®ƒä»¬å¸®åŠ©å°è£…å¥½äº†å¾ˆå¤šç»†èŠ‚ï¼Œæä¾›ç»™æˆ‘ä»¬ç”¨æˆ·å‹å¥½çš„æ¥å£ï¼Œåé¢æœ‰æ—¶é—´æˆ‘ä¹Ÿä¼šå¯¹ Netty è¿›è¡Œä»‹ç»ã€‚</p>
<p>ï¼ˆå…¨æ–‡å®Œï¼‰</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="ä¸Šä¸€é¡µ" aria-label="ä¸Šä¸€é¡µ" href="/default/page/6/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/default/">1</a><span class="space">&hellip;</span><a class="page-number" href="/default/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/default/page/8/">8</a><a class="extend next" rel="next" title="ä¸‹ä¸€é¡µ" aria-label="ä¸‹ä¸€é¡µ" href="/default/page/8/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2023 â€“ 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">ç¢æ¢¦</span>
  </div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> å¼ºåŠ›é©±åŠ¨
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/scatteredream" class="github-corner" title="åœ¨ GitHub ä¸Šå…³æ³¨æˆ‘" aria-label="åœ¨ GitHub ä¸Šå…³æ³¨æˆ‘" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
